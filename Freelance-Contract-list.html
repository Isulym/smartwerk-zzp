<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📋 SmartWerk — Saved Contracts</title>

  <!-- CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:'Inter',sans-serif; padding:20px; }
    h1 { color:#fff; text-align:center; }
    header,footer { text-align:center; margin-bottom:20px; }
    .btn { background:#475569; color:#fff; padding:8px 14px; border:none; border-radius:8px; cursor:pointer; transition:.2s; }
    .btn:hover { opacity:.85; }
    .btn-primary { background:#3b82f6; }
    .btn-danger { background:#ef4444; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; margin-bottom:15px; }
    input,select { background:#1e293b; border:none; color:#e5e7eb; padding:6px 8px; border-radius:6px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; background:#1e293b; border-radius:8px; overflow:hidden; }
    th,td { padding:10px; text-align:left; }
    th { background:#334155; color:#93c5fd; text-transform:uppercase; font-size:12px; letter-spacing:.5px; }
    tr:nth-child(even){ background:#273447; }
    tr:hover { background:#3b4a63; }
    .status { padding:3px 7px; border-radius:6px; font-size:13px; font-weight:600; }
    .status.Draft { background:#78350f; color:#fcd34d; }
    .status.Sent { background:#1d4ed8; color:#bfdbfe; }
    .status.Signed { background:#065f46; color:#a7f3d0; }
    .status.Completed { background:#166534; color:#bbf7d0; }
    .actions button { margin-right:4px; }
    footer { color:#94a3b8; font-size:13px; margin-top:30px; }
    #msg { text-align:center; color:#10b981; margin-top:10px; display:none; }
  </style>
</head>
<body>
  <h1>📋 SmartWerk — Saved Contracts</h1>

  <div class="controls">
    <div>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="Freelance-Contract.html" class="btn btn-primary">＋ New Contract</a>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <input type="text" id="searchInput" placeholder="🔍 Search..." />
      <select id="statusFilter">
        <option value="">All Statuses</option>
        <option>Draft</option>
        <option>Sent</option>
        <option>Signed</option>
        <option>Completed</option>
      </select>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Contract ID</th>
        <th>Client</th>
        <th>Project</th>
        <th>Status</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="contractsBody">
      <tr><td colspan="6" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
    </tbody>
  </table>

  <div id="msg">✅ Synced with Cloud</div>

  <footer>© 2025 SmartWerk</footer>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const $ = id => document.getElementById(id);

    let contracts = [];

    function showMsg(txt){const m=$("msg");m.textContent=txt;m.style.display="block";setTimeout(()=>m.style.display="none",2500);}

    async function loadContracts(uid){
      $("contractsBody").innerHTML=`<tr><td colspan="6" style="text-align:center;color:#94a3b8;">Loading...</td></tr>`;
      const snap=await getDocs(collection(db,"users",uid,"contracts"));
      contracts=[];
      snap.forEach(d=>contracts.push({id:d.id,...d.data()}));
      renderContracts();
      showMsg("✅ Contracts synced");
    }

    function renderContracts(){
      const body=$("contractsBody");
      const q=$("searchInput").value.toLowerCase();
      const f=$("statusFilter").value;
      const filtered=contracts.filter(c=>{
        const match=(c.contractId||"").toLowerCase().includes(q)||(c.clientName||"").toLowerCase().includes(q)||(c.projectTitle||"").toLowerCase().includes(q);
        const ok=!f||c.status===f;
        return match&&ok;
      });
      if(!filtered.length){body.innerHTML=`<tr><td colspan="6" style="text-align:center;color:#94a3b8;">No contracts found</td></tr>`;return;}
      body.innerHTML="";
      filtered.forEach(c=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${c.contractId||"-"}</td>
          <td>${c.clientName||"-"}</td>
          <td>${c.projectTitle||"-"}</td>
          <td><span class="status ${c.status||"Draft"}">${c.status||"Draft"}</span></td>
          <td>${c.date||"-"}</td>
          <td class="actions">
            <button class="btn" onclick="editContract('${c.id}')">📝 Edit</button>
            <button class="btn btn-danger" onclick="deleteContract('${c.id}')">🗑</button>
            <button class="btn" onclick="exportContractPDF('${c.id}',true)">📄 PDF</button>
            <button class="btn btn-primary" onclick="exportContractPDF('${c.id}',false)">💎 PRO</button>
          </td>`;
        body.appendChild(tr);
      });
    }

    window.editContract=(id)=>{
      localStorage.setItem("editContractId",id);
      location.href="Freelance-Contract.html";
    };

    window.deleteContract=async(id)=>{
      if(!confirm("Delete this contract?"))return;
      const user=auth.currentUser;
      await deleteDoc(doc(db,"users",user.uid,"contracts",id));
      showMsg("🗑 Contract deleted");
      loadContracts(user.uid);
    };

    window.exportContractPDF=(id,withBranding=true)=>{
      const { jsPDF }=window.jspdf;
      const c=contracts.find(x=>x.id===id);
      if(!c)return alert("Contract not found");
      const doc=new jsPDF("p","mm","a4");
      const blue=[59,130,246];
      if(withBranding){
        doc.setFillColor(...blue); doc.rect(0,0,210,25,"F");
        doc.setTextColor(255,255,255); doc.setFontSize(18).text("SmartWerk — Freelance Contract",14,17);
      } else {
        doc.setFontSize(18).setTextColor(0,0,0).text("Freelance Contract",14,17);
      }
      const rows=[
        ["Contract ID",c.contractId||""],
        ["Client",c.clientName||""],
        ["Project",c.projectTitle||""],
        ["Status",c.status||""],
        ["Date",c.date||""],
        ["Business",c.businessName||""],
        ["Scope",c.projectScope||""],
        ["Timeline",c.timeline||""],
        ["Payment Terms",c.paymentTerms||""],
        ["Legal",c.legalTerms||""]
      ];
      doc.autoTable({startY:35,head:[["Field","Details"]],body:rows,theme:"grid",
        headStyles:{fillColor:withBranding?blue:[180,180,180],textColor:255},
        styles:{fontSize:10,cellPadding:4,overflow:'linebreak'}
      });
      if(withBranding)
        doc.setFontSize(9).setTextColor(100).text("Generated by SmartWerk © 2025",14,290);
      const filename=withBranding?`SmartWerk_Contract_${c.contractId||"info"}.pdf`:`Contract_${c.contractId||"info"}_PRO.pdf`;
      doc.save(filename);
    };

    onAuthStateChanged(auth,(user)=>{
      if(!user){location.href="login.html";return;}
      loadContracts(user.uid);
      $("searchInput").oninput=renderContracts;
      $("statusFilter").onchange=renderContracts;
    });
  </script>
</body>
</html>
