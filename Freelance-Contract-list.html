<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìÑ Freelance Contract List</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0f172a; color: #e5e7eb; font-family: 'Inter', sans-serif; padding: 20px; }
    h1 { color: #fff; margin-bottom: 10px; }
    .btn { background: #334155; color: #fff; padding: 6px 12px; border-radius: 6px; text-decoration: none; margin-right: 8px; }
    .btn-primary { background: #3b82f6; }
    .btn-danger { background: #dc2626; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; text-align: left; }
    th { background: #1e293b; text-transform: uppercase; font-size: 12px; color: #93c5fd; }
    tr:nth-child(even) { background: #1e293b; }
    tr:hover { background: #334155; }
    .status { font-weight: bold; padding: 4px 8px; border-radius: 4px; font-size: 13px; display: inline-block; }
    .status.Draft { background: #475569; color: #fff; }
    .status.Sent { background: #78350f; color: #facc15; }
    .status.Signed { background: #15803d; color: #bbf7d0; }
    .status.Completed { background: #14532d; color: #86efac; }
    input, select { background: #1e293b; border: none; color: #e5e7eb; padding: 6px 8px; border-radius: 6px; }
    .filters { margin-top: 10px; display: flex; gap: 10px; }
    footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 13px; }
  </style>
</head>
<body>
<h1>üìÑ Freelance Contracts</h1>
<a href="dashboard.html" class="btn">‚Üê Dashboard</a>
<a href="Freelance-Contract.html" class="btn btn-primary">Ôºã New Contract</a>
<button id="refreshBtn" class="btn">üîÑ Refresh</button>

<div class="filters">
  <input type="text" id="searchInput" placeholder="Search contracts...">
  <select id="statusFilter">
    <option value="">All Statuses</option>
    <option>Draft</option>
    <option>Sent</option>
    <option>Signed</option>
    <option>Completed</option>
  </select>
</div>

<table>
  <thead>
    <tr>
      <th>Contract ID</th>
      <th>Client</th>
      <th>Project</th>
      <th>Status</th>
      <th>Date</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="contractsBody">
    <tr><td colspan="6" style="text-align:center;color:#94a3b8;">Loading...</td></tr>
  </tbody>
</table>

<canvas id="chart" height="100"></canvas>

<footer>¬© 2025 SmartWerk</footer>

<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  getDoc,
  addDoc,
  setDoc,
  runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1"
};

const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const $ = id => document.getElementById(id);

let loadedClients = {};
let savedContractData = null;

function setupSignature(canvasId, dateId) {
  const c = $(canvasId);
  if (!c) return;
  const ctx = c.getContext("2d");
  let drawing = false;
  const start = () => { drawing = true; ctx.beginPath(); };
  const end = () => {
    if (!drawing) return;
    drawing = false;
    const now = new Date().toLocaleDateString("nl-NL");
    $(dateId).innerText = now;
  };
  const move = e => {
    if (!drawing) return;
    const r = c.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  };
  c.addEventListener("mousedown", start);
  c.addEventListener("mouseup", end);
  c.addEventListener("mouseleave", () => (drawing = false));
  c.addEventListener("mousemove", move);
  c.addEventListener("touchstart", e => { e.preventDefault(); start(); });
  c.addEventListener("touchend", e => { e.preventDefault(); end(); });
  c.addEventListener("touchmove", e => { e.preventDefault(); move(e); });
}

function populateContractForm(d) {
  $("contractId").value = d.contractId || "";
  $("status").value = d.status || "Draft";
  $("date").value = d.date || new Date().toISOString().split("T")[0];
  $("projectTitle").value = d.projectTitle || "";
  $("businessName").value = d.businessName || "";
  $("kvk").value = d.kvk || "";
  $("vat").value = d.vat || "";
  $("iban").value = d.iban || "";
  $("businessAddress").value = d.businessAddress || "";
  $("clientName").value = d.clientName || "";
  $("clientEmail").value = d.clientEmail || "";
  $("clientPhone").value = d.clientPhone || "";
  $("clientAddress").value = d.clientAddress || "";
  $("projectScope").value = d.projectScope || "";
  $("timeline").value = d.timeline || "";
  $("paymentTerms").value = d.paymentTerms || "";
  $("legalTerms").value = d.legalTerms || "";
  $("signatureFreelancerDate").textContent = d.freelancerDate || "";
  $("signatureClientDate").textContent = d.clientDate || "";
  if (d.freelancerSignature) {
    const img = new Image();
    img.onload = () => $("signatureFreelancer").getContext("2d").drawImage(img, 0, 0);
    img.src = d.freelancerSignature;
  }
  if (d.clientSignature) {
    const img = new Image();
    img.onload = () => $("signatureClient").getContext("2d").drawImage(img, 0, 0);
    img.src = d.clientSignature;
  }
}

async function loadBusinessInfo(uid) {
  const snap = await getDoc(doc(db, "users", uid));
  if (snap.exists()) {
    const d = snap.data();
    $("businessName").value = d.businessName || "";
    $("kvk").value = d.kvk || "";
    $("vat").value = d.btw || "";
    $("iban").value = d.iban || "";
    $("businessAddress").value = d.businessAddress || "";
  }
}

async function loadClients(uid) {
  const snap = await getDocs(collection(db, "users", uid, "clients"));
  const select = $("clientSelect");
  select.innerHTML = '<option value="">Select a client...</option>';
  snap.forEach(docSnap => {
    const c = docSnap.data();
    const opt = document.createElement("option");
    opt.value = docSnap.id;
    opt.textContent = `${c.clientName || "Unnamed"} (${c.country || ""})`;
    select.appendChild(opt);
    loadedClients[docSnap.id] = c;
  });

  // –ü—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–±—Ä–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞ –∑–∞ email –∞–±–æ name
  if (savedContractData) {
    for (const [id, c] of Object.entries(loadedClients)) {
      if (
        c.clientEmail === savedContractData.clientEmail ||
        c.clientName === savedContractData.clientName
      ) {
        select.value = id;
        break;
      }
    }
  }
}

async function generateContractId(uid) {
  const ref = doc(db, "users", uid);
  const year = new Date().getFullYear();
  let out = "";
  await runTransaction(db, async tx => {
    const snap = await tx.get(ref);
    const last = snap.exists() ? (snap.data().lastContractNumber || 0) : 0;
    const next = last + 1;
    tx.set(ref, { lastContractNumber: next }, { merge: true });
    out = `CT-${year}-${String(next).padStart(3, "0")}`;
  });
  return out;
}

async function saveContract(uid, editingId = null) {
  const data = {
    contractId: $("contractId").value,
    status: $("status").value,
    date: $("date").value,
    projectTitle: $("projectTitle").value,
    businessName: $("businessName").value,
    kvk: $("kvk").value,
    vat: $("vat").value,
    iban: $("iban").value,
    businessAddress: $("businessAddress").value,
    clientName: $("clientName").value,
    clientEmail: $("clientEmail").value,
    clientPhone: $("clientPhone").value,
    clientAddress: $("clientAddress").value,
    projectScope: $("projectScope").value,
    timeline: $("timeline").value,
    paymentTerms: $("paymentTerms").value,
    legalTerms: $("legalTerms").value,
    freelancerSignature: $("signatureFreelancer").toDataURL(),
    clientSignature: $("signatureClient").toDataURL(),
    freelancerDate: $("signatureFreelancerDate").textContent,
    clientDate: $("signatureClientDate").textContent,
    updatedAt: new Date().toISOString()
  };

  if (editingId) {
    await setDoc(doc(db, "users", uid, "contracts", editingId), data, { merge: true });
    localStorage.removeItem("editContractId");
  } else {
    data.createdAt = new Date().toISOString();
    await addDoc(collection(db, "users", uid, "contracts"), data);
  }

  alert("‚úÖ Contract saved successfully!");
  location.href = "Freelance-Contract-list.html";
}

onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  const uid = user.uid;
  const editId = localStorage.getItem("editContractId");
  if (editId) {
    const snap = await getDoc(doc(db, "users", uid, "contracts", editId));
    if (snap.exists()) {
      savedContractData = snap.data();
    }
  }

  setupSignature("signatureFreelancer", "signatureFreelancerDate");
  setupSignature("signatureClient", "signatureClientDate");
  await loadBusinessInfo(uid);
  await loadClients(uid);

  if (savedContractData) {
    populateContractForm(savedContractData);
  } else {
    $("date").value = new Date().toISOString().split("T")[0];
    $("contractId").value = await generateContractId(uid);
  }

  $("saveBtn").onclick = () => saveContract(uid, editId);
});
</script>
</body>
</html>

