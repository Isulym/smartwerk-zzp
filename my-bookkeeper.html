<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📊 SmartWerk Bookkeeper</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="bookkeeper.css" />
</head>
<body>
  <h1>📒 My Bookkeeper</h1>
  <a href="dashboard.html" class="btn">← Back to Dashboard</a>
  <button class="btn" onclick="exportCSV()">📁 Export CSV</button>
  <button class="btn btn-primary" onclick="exportPDF()">📄 Export PDF</button>

  <div class="filters">
    <label>Client:
      <select id="clientFilter">
        <option value="">All Clients</option>
      </select>
    </label>
    <label>Period:
      <select id="filterBy">
        <option value="all">All time</option>
        <option value="thisYear">This Year</option>
        <option value="thisMonth">This Month</option>
        <option value="lastMonth">Last Month</option>
      </select>
    </label>
    <label>From: <input type="date" id="customFrom"></label>
    <label>To: <input type="date" id="customTo"></label>
  </div>

  <div class="stats">
    <div class="card"><h2>Total Income</h2><p id="totalIncome">€0</p></div>
    <div class="card"><h2>Total Expenses</h2><p id="totalExpenses">€0</p></div>
    <div class="card"><h2>Net Profit</h2><p id="netProfit">€0</p></div>
    <div class="card"><h2>Total VAT</h2><p id="totalVat">€0</p></div>
    <div class="card">
      <h2>Annual Target</h2>
      <p>€<span id="targetValue">50,000</span></p>
      <div class="progress-container">
        <div class="progress-bar" id="targetProgress" style="width: 0%">0%</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>📊 Income vs Expenses</h2>
    <canvas id="summaryChart" height="100"></canvas>
  </div>

  <div class="section upcoming">
    <div class="card">
      <h2>📅 Upcoming Invoice Due Dates</h2>
      <ul id="upcomingInvoices"></ul>
    </div>
    <div class="card">
      <h2>💸 Upcoming Expenses</h2>
      <ul id="upcomingExpenses"></ul>
    </div>
  </div>

  <div class="section alerts">
    <h2>🧠 Smart Suggestions</h2>
    <ul id="smartSuggestions">
      <li>📌 You have <strong>3 unpaid invoices</strong> older than 30 days</li>
      <li>💡 Consider registering for KOR if your VAT is under €1,800 this year</li>
      <li>📈 Income dropped -15% compared to last month</li>
      <li>📆 Average payment time: <strong>18 days</strong></li>
    </ul>
  </div>

  <div class="section">
    <h2>📥 Import CSV (Clients / Expenses)</h2>
    <input type="file" id="csvUpload" accept=".csv" />
    <button class="btn" onclick="importCSV()">📂 Import</button>
  </div>

  <footer>© 2025 SmartWerk</footer>

  <script type="module">

import {
  initializeApp,
  getApps,
  getApp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1"
};

const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const $ = id => document.getElementById(id);

let summaryChart = null;

function formatCurrency(eur) {
  return "€" + (eur || 0).toLocaleString("nl-NL", {
    minimumFractionDigits: 2
  });
}

function filterByPeriod(date, filter, from, to) {
  const d = new Date(date);
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const lastMonth = new Date(now);
  lastMonth.setMonth(thisMonth - 1);
  const fromDate = from ? new Date(from) : null;
  const toDate = to ? new Date(to) : null;

  if (fromDate && toDate) return d >= fromDate && d <= toDate;

  switch (filter) {
    case "thisMonth":
      return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
    case "lastMonth":
      return d.getMonth() === lastMonth.getMonth() && d.getFullYear() === lastMonth.getFullYear();
    case "thisYear":
      return d.getFullYear() === thisYear;
    default:
      return true;
  }
}

async function loadBookkeeperData(uid) {
  const [invoiceSnap, expenseSnap, clientSnap] = await Promise.all([
    getDocs(collection(db, "users", uid, "invoices")),
    getDocs(collection(db, "users", uid, "expenses")),
    getDocs(collection(db, "users", uid, "clients"))
  ]);

  const filter = $("filterBy").value;
  const from = $("customFrom").value;
  const to = $("customTo").value;

  let invoices = invoiceSnap.docs
    .map(doc => doc.data())
    .filter(i => filterByPeriod(i.invoiceDate || i.date, filter, from, to));
  const expenses = expenseSnap.docs
    .map(doc => doc.data())
    .filter(e => filterByPeriod(e.date, filter, from, to));

  const incomeByClient = {};
  invoices.forEach(inv => {
    if (!inv.clientName) return;
    incomeByClient[inv.clientName] = (incomeByClient[inv.clientName] || 0) + (inv.grandTotal || 0);
  });

  const selectedClient = $("clientFilter").value;
  if (selectedClient) {
    invoices = invoices.filter(i => i.clientName === selectedClient);
  }

  const totalIncome = invoices.reduce((sum, i) => sum + (i.grandTotal || 0), 0);
  const totalVat = invoices.reduce((sum, i) => sum + (i.totalVat || 0), 0);
  const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
  const netProfit = totalIncome - totalExpenses;

  $("totalIncome").innerText = formatCurrency(totalIncome);
  $("totalVat").innerText = formatCurrency(totalVat);
  $("totalExpenses").innerText = formatCurrency(totalExpenses);
  $("netProfit").innerText = formatCurrency(netProfit);

  const target = 50000;
  const percent = Math.min(100, Math.round((totalIncome / target) * 100));
  $("targetProgress").style.width = percent + "%";
  $("targetProgress").innerText = percent + "%";

  drawChart(invoices, expenses);
  loadUpcomingInvoices(invoices);
  loadUpcomingExpenses(expenses);
  populateClientDropdown(clientSnap.docs.map(d => d.data()));
}

function drawChart(invoices, expenses) {
  const incomeMap = {}, expenseMap = {};

  invoices.forEach(i => {
    const m = (i.invoiceDate || i.date || "").slice(0, 7);
    incomeMap[m] = (incomeMap[m] || 0) + (i.grandTotal || 0);
  });

  expenses.forEach(e => {
    const m = (e.date || "").slice(0, 7);
    expenseMap[m] = (expenseMap[m] || 0) + (e.amount || 0);
  });

  const labels = Array.from(new Set([...Object.keys(incomeMap), ...Object.keys(expenseMap)])).sort();
  const incomeData = labels.map(m => incomeMap[m] || 0);
  const expenseData = labels.map(m => expenseMap[m] || 0);

  const ctx = $("summaryChart").getContext("2d");
  if (summaryChart) summaryChart.destroy();

  summaryChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "Income", data: incomeData, backgroundColor: "#22c55e" },
        { label: "Expenses", data: expenseData, backgroundColor: "#ef4444" }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: "top" } }
    }
  });
}

function loadUpcomingInvoices(invoices) {
  const list = $("upcomingInvoices");
  list.innerHTML = "";
  invoices.filter(i => i.dueDate && new Date(i.dueDate) > new Date())
    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
    .slice(0, 5)
    .forEach(i => {
      const li = document.createElement("li");
      li.textContent = `${i.clientName || "Unnamed"} – due ${i.dueDate}`;
      list.appendChild(li);
    });
}

function loadUpcomingExpenses(expenses) {
  const list = $("upcomingExpenses");
  list.innerHTML = "";
  expenses.filter(e => e.date && new Date(e.date) > new Date())
    .sort((a, b) => new Date(a.date) - new Date(b.date))
    .slice(0, 5)
    .forEach(e => {
      const li = document.createElement("li");
      li.textContent = `${e.category || "Expense"} – due ${e.date}`;
      list.appendChild(li);
    });
}

function populateClientDropdown(clients) {
  const select = $("clientFilter");
  select.innerHTML = `<option value="">All Clients</option>`;
  clients.forEach(c => {
    if (!c.clientName) return;
    const opt = document.createElement("option");
    opt.value = c.clientName;
    opt.textContent = c.clientName;
    select.appendChild(opt);
  });
}

window.exportCSV = () => {
  const rows = [
    ["Metric", "Value"],
    ["Total Income", $("totalIncome").innerText],
    ["Total Expenses", $("totalExpenses").innerText],
    ["Net Profit", $("netProfit").innerText],
    ["Total VAT", $("totalVat").innerText]
  ];
  let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "bookkeeper-summary.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

window.exportPDF = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(18);
  doc.text("SmartWerk Bookkeeper Report", 105, 15, { align: "center" });
  doc.setFontSize(12);
  doc.text("Overview:", 14, 30);
  doc.autoTable({
    startY: 35,
    head: [["Metric", "Value"]],
    body: [
      ["Total Income", $("totalIncome").innerText],
      ["Total Expenses", $("totalExpenses").innerText],
      ["Net Profit", $("netProfit").innerText],
      ["Total VAT", $("totalVat").innerText]
    ]
  });

  doc.setFontSize(10);
  doc.text("Generated with SmartWerk", 105, 285, { align: "center" });
  doc.save("bookkeeper-summary.pdf");
};

onAuthStateChanged(auth, user => {
  if (!user) return location.href = "login.html";
  loadBookkeeperData(user.uid);

  ["clientFilter", "filterBy", "customFrom", "customTo"].forEach(id => {
    $(id).onchange = () => loadBookkeeperData(user.uid);
  });
});

    
  </script>
</body>
</html>

