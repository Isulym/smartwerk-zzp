<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Bookkeeper | SmartWerk</title>
  <link rel="stylesheet" href="style-bookkeeper.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>👨‍💼 My Bookkeeper</h1>
    <div class="header-actions">
      <button onclick="refreshBookkeeper()">🔄 Refresh</button>
      <button onclick="exportAllData()">📤 Export All</button>
      <a href="dashboard.html" class="btn-link">🏠 Back to Dashboard</a>
    </div>
  </header>

  <section class="kpi-cards">
    <div class="card income">💰 Total Income<br><span id="totalIncome">€0</span></div>
    <div class="card expenses">📉 Total Expenses<br><span id="totalExpenses">€0</span></div>
    <div class="card profit">📈 Net Profit<br><span id="netProfit">€0</span></div>
    <div class="card vat">🧾 VAT Payable<br><span id="vatPayable">€0</span></div>
  </section>

  <section class="chart-filters">
  <h3>📊 Invoices Chart Filters</h3>
  <label>
    Month:
    <select id="monthSelect" onchange="updateFilters()">
      <option value="all">All</option>
      <!-- Динамічно додається -->
    </select>
  </label>

  <label>
    Status:
    <select id="statusSelect" onchange="updateFilters()">
      <option value="all">All</option>
      <option value="Paid">Paid</option>
      <option value="Draft">Draft</option>
      <option value="Sent">Sent</option>
    </select>
  </label>

  <label>
    Chart Type:
    <select id="chartType" onchange="updateFilters()">
      <option value="bar">Bar</option>
      <option value="line">Line</option>
    </select>
  </label>
</section>

  <section class="filters">
    <h3>📅 Filter by Period</h3>
    <button onclick="filterBy('thisMonth')">This Month</button>
    <button onclick="filterBy('lastMonth')">Last Month</button>
    <button onclick="filterBy('thisYear')">This Year</button>
    <input type="month" id="customMonth" onchange="filterByMonth(this.value)" />
  </section>

  <section class="charts">
  <h3>📊 Financial Overview</h3>
  <canvas id="bookkeeperChart" height="120"></canvas>

  <h3>📈 Invoices Chart</h3>
  <canvas id="invoicesChart" height="120"></canvas>
</section>

  <section class="section invoices">
    <h3>📄 Invoices Summary</h3>
    <ul id="invoicesList">
      <!-- Fetched via JS -->
    </ul>
  </section>

  <section class="section expenses">
    <h3>💼 Expenses Summary</h3>
    <ul id="expensesList">
      <!-- Fetched via JS -->
    </ul>
  </section>

  <section class="section reminders">
    <h3>📬 Reminders Sent</h3>
    <ul id="remindersList">
      <!-- Fetched via JS -->
    </ul>
  </section>

  <footer>
    <p>© 2025–2030 SmartWerk. All rights reserved.</p>
  </footer>

  <script type="module">
    // 📁 bookkeeper.js — Firebase інтеграція для My Bookkeeper

// bookkeeper.js
import {
  initializeApp,
  getApps,
  getApp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
  getFirestore,
  collection,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import Chart from "https://cdn.jsdelivr.net/npm/chart.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1",
};

const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = sel => document.querySelector(sel);

let currentChart = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) return (window.location.href = "login.html");
  const uid = user.uid;
  const month = $("#monthSelect").value;
  const status = $("#statusSelect").value;
  const type = $("#chartType")?.value || "bar";
  //const type = $("#chartType").value;

  const invoicesSnap = await getDocs(
    query(collection(db, "invoices"), where("userId", "==", uid))
  );

  const invoices = [];
  invoicesSnap.forEach(doc => invoices.push(doc.data()));

  const filtered = invoices.filter(i => {
    const iMonth = (i.date || "").substring(0, 7);
    const statusMatch = status === "All" || i.status === status;
    const monthMatch = !month || iMonth === month;
    return statusMatch && monthMatch;
  });

  updateChart(filtered, type);
});

window.updateFilters = async function () {
  const user = auth.currentUser;
  if (!user) return;

  const uid = user.uid;
  const month = $("#monthSelect").value;
  const status = $("#statusSelect").value;
  const type = $("#chartType")?.value || "bar";
  //const type = $("#chartType").value;

  const invoicesSnap = await getDocs(
    query(collection(db, "invoices"), where("userId", "==", uid))
  );

  const invoices = [];
  invoicesSnap.forEach(doc => invoices.push(doc.data()));

  const filtered = invoices.filter(i => {
    const iMonth = (i.date || "").substring(0, 7);
    const statusMatch = status === "All" || i.status === status;
    const monthMatch = !month || iMonth === month;
    return statusMatch && monthMatch;
  });

  updateChart(filtered, type);
}

function updateChart(data, type) {
  const monthly = {};
  data.forEach(i => {
    const date = (i.date || "").substring(0, 7);
    if (!monthly[date]) monthly[date] = 0;
    monthly[date] += parseFloat(i.total || 0);
  });

  const labels = Object.keys(monthly).sort();
  const values = labels.map(l => monthly[l]);

  if (currentChart) currentChart.destroy();

  const ctx = document.getElementById("invoicesChart").getContext("2d");
  currentChart = new Chart(ctx, {
    type: type,
    data: {
      labels: labels,
      datasets: [{
        label: `Invoices (${type})`,
        data: values,
        borderWidth: 1,
        fill: type === "line"
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
   window.addEventListener("DOMContentLoaded", () => {
  const monthSelect = document.getElementById("monthSelect");
  if (!monthSelect) return;

  // Очистити існуючі варіанти
  monthSelect.innerHTML = "";

  // Додати "All"
  const optAll = document.createElement("option");
  optAll.value = "all";
  optAll.textContent = "All";
  monthSelect.appendChild(optAll);

  // Додати останні 12 місяців
  const now = new Date();
  for (let i = 0; i < 12; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const monthValue = d.toISOString().slice(0, 7); // YYYY-MM
    const monthLabel = d.toLocaleString("default", { month: "long", year: "numeric" }); // September 2025
    const opt = document.createElement("option");
    opt.value = monthValue;
    opt.textContent = monthLabel;
    monthSelect.appendChild(opt);
  }
});

    // ⏱ Refresh page
window.refreshBookkeeper = () => {
  location.reload();
};

// 📤 Export All (dummy version — покращимо пізніше)
window.exportAllData = () => {
  alert("Exporting all data (function in progress)...");
};

// 📅 Filters by period — базові заглушки
window.filterBy = (period) => {
  alert(`Filtering by: ${period} (feature in progress)`);
};

window.filterByMonth = (month) => {
  alert(`Filtering by custom month: ${month} (feature in progress)`);
};
    
  </script>
</body>
</html>
