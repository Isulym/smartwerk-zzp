<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Bookkeeper | SmartWerk</title>
  <link rel="stylesheet" href="style-bookkeeper.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>👨‍💼 My Bookkeeper</h1>
    <div class="header-actions">
      <button onclick="refreshBookkeeper()">🔄 Refresh</button>
      <button onclick="exportAllData()">📤 Export All</button>
      <a href="dashboard.html" class="btn-link">🏠 Back to Dashboard</a>
    </div>
  </header>

  <section class="kpi-cards">
    <div class="card income">💰 Total Income<br><span id="totalIncome">€0</span></div>
    <div class="card expenses">📉 Total Expenses<br><span id="totalExpenses">€0</span></div>
    <div class="card profit">📈 Net Profit<br><span id="netProfit">€0</span></div>
    <div class="card vat">🧾 VAT Payable<br><span id="vatPayable">€0</span></div>
  </section>

  <section class="chart-filters">
    <h3>📊 Invoices Chart Filters</h3>
    <label>
      Month:
      <select id="monthSelect" onchange="updateFilters()">
        <option value="all">All</option>
      </select>
    </label>
    <label>
      Status:
      <select id="statusSelect" onchange="updateFilters()">
        <option value="all">All</option>
        <option value="Paid">Paid</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
      </select>
    </label>
    <label>
      Chart Type:
      <select id="chartType" onchange="updateFilters()">
        <option value="bar">Bar</option>
        <option value="line">Line</option>
      </select>
    </label>
  </section>

  <section class="filters">
    <h3>📅 Filter by Period</h3>
    <button onclick="filterBy('thisMonth')">This Month</button>
    <button onclick="filterBy('lastMonth')">Last Month</button>
    <button onclick="filterBy('thisYear')">This Year</button>
    <input type="month" id="customMonth" onchange="filterByMonth(this.value)" />
  </section>

  <section class="charts">
    <h3>📊 Financial Overview</h3>
    <canvas id="bookkeeperChart" height="120"></canvas>

    <h3>📈 Invoices Chart</h3>
    <canvas id="invoicesChart" height="120"></canvas>
  </section>

  <section class="section invoices">
    <h3>📄 Invoices Summary</h3>
    <ul id="invoicesList"></ul>
  </section>

  <section class="section expenses">
    <h3>💼 Expenses Summary</h3>
    <ul id="expensesList"></ul>
  </section>

  <section class="section reminders">
    <h3>📬 Reminders Sent</h3>
    <ul id="remindersList"></ul>
  </section>

  <footer>
    <p>© 2025–2030 SmartWerk. All rights reserved.</p>
  </footer>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    // Init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const $ = sel => document.querySelector(sel);
    let invoicesChartInstance = null;

    function refreshBookkeeper() {
      location.reload();
    }

    function exportAllData() {
      alert("Export in progress...");
    }

    function filterBy(period) {
      alert("Filtering by: " + period);
    }

    function filterByMonth(month) {
      alert("Custom filter by month: " + month);
    }

    function updateChart(data, type) {
      const monthly = {};
      data.forEach(i => {
        const date = (i.date || "").substring(0, 7);
        if (!monthly[date]) monthly[date] = 0;
        monthly[date] += parseFloat(i.total || 0);
      });

      const labels = Object.keys(monthly).sort();
      const values = labels.map(l => monthly[l]);

      if (invoicesChartInstance) invoicesChartInstance.destroy();
      const ctx = document.getElementById("invoicesChart").getContext("2d");
      invoicesChartInstance = new Chart(ctx, {
        type: type,
        data: {
          labels: labels,
          datasets: [{
            label: `Invoices (${type})`,
            data: values,
            borderWidth: 1,
            fill: type === "line"
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function updateFilters() {
      const user = auth.currentUser;
      if (!user) return;

      const uid = user.uid;
      const month = $("#monthSelect").value;
      const status = $("#statusSelect").value;
      const type = $("#chartType").value;

      db.collection("invoices").where("userId", "==", uid).get().then(snap => {
        const invoices = snap.docs.map(doc => doc.data());

        const filtered = invoices.filter(i => {
          const iMonth = (i.date || "").substring(0, 7);
          const statusMatch = status === "all" || i.status === status;
          const monthMatch = month === "all" || iMonth === month;
          return statusMatch && monthMatch;
        });

        updateChart(filtered, type);
      });
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) return (window.location.href = "login.html");
      const uid = user.uid;

      // Populate months
      const monthSelect = $("#monthSelect");
      if (monthSelect) {
        monthSelect.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "all";
        optAll.textContent = "All";
        monthSelect.appendChild(optAll);
        const now = new Date();
        for (let i = 0; i < 12; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const val = d.toISOString().slice(0, 7);
          const label = d.toLocaleString("default", { month: "long", year: "numeric" });
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = label;
          monthSelect.appendChild(opt);
        }
      }

      const [invoicesSnap, expensesSnap, remindersSnap] = await Promise.all([
        db.collection("invoices").where("userId", "==", uid).get(),
        db.collection("expenses").where("userId", "==", uid).get(),
        db.collection("reminders").where("userId", "==", uid).get()
      ]);

      const invoices = invoicesSnap.docs.map(doc => doc.data());
      const expenses = expensesSnap.docs.map(doc => doc.data());
      const reminders = remindersSnap.docs.map(doc => doc.data());

      const income = invoices.reduce((sum, i) => sum + parseFloat(i.total || 0), 0);
      const expense = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
      const vat = invoices.reduce((sum, i) => sum + parseFloat(i.vat || 0), 0);
      const profit = income - expense;

      $("#totalIncome").textContent = `€${income.toFixed(2)}`;
      $("#totalExpenses").textContent = `€${expense.toFixed(2)}`;
      $("#vatPayable").textContent = `€${vat.toFixed(2)}`;
      $("#netProfit").textContent = `€${profit.toFixed(2)}`;

      $("#invoicesList").innerHTML = invoices.map(i => `<li>${i.invoiceNumber || "INV"} — €${i.total || 0} — ${i.status}</li>`).join("");
      $("#expensesList").innerHTML = expenses.map(e => `<li>${e.category || "Expense"} — €${e.amount || 0}</li>`).join("");
      $("#remindersList").innerHTML = reminders.map(r => `<li>${r.reminderId || "REM"} — ${r.clientName || "Unknown"}</li>`).join("");

      updateChart(invoices, $("#chartType").value);
    });
  </script>
</body>
</html>

