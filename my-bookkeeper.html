<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Bookkeeper | SmartWerk</title>
  <link rel="stylesheet" href="style-bookkeeper.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>ğŸ‘¨â€ğŸ’¼ My Bookkeeper</h1>
    <div class="header-actions">
      <button onclick="refreshBookkeeper()">ğŸ”„ Refresh</button>
      <button onclick="exportAllData()">ğŸ“¤ Export All</button>
      <a href="dashboard.html" class="btn-link">ğŸ  Back to Dashboard</a>
    </div>
  </header>

  <section class="kpi-cards">
    <div class="card income">ğŸ’° Total Income<br><span id="totalIncome">â‚¬0</span></div>
    <div class="card expenses">ğŸ“‰ Total Expenses<br><span id="totalExpenses">â‚¬0</span></div>
    <div class="card profit">ğŸ“ˆ Net Profit<br><span id="netProfit">â‚¬0</span></div>
    <div class="card vat">ğŸ§¾ VAT Payable<br><span id="vatPayable">â‚¬0</span></div>
  </section>

  <section class="filters">
    <h3>ğŸ“… Filter by Period</h3>
    <button onclick="filterBy('thisMonth')">This Month</button>
    <button onclick="filterBy('lastMonth')">Last Month</button>
    <button onclick="filterBy('thisYear')">This Year</button>
    <input type="month" id="customMonth" onchange="filterByMonth(this.value)" />
  </section>

  <section class="charts">
    <h3>ğŸ“Š Financial Overview</h3>
    <canvas id="bookkeeperChart" height="120"></canvas>
  </section>

  <section class="section invoices">
    <h3>ğŸ“„ Invoices Summary</h3>
    <ul id="invoicesList">
      <!-- Fetched via JS -->
    </ul>
  </section>

  <section class="section expenses">
    <h3>ğŸ’¼ Expenses Summary</h3>
    <ul id="expensesList">
      <!-- Fetched via JS -->
    </ul>
  </section>

  <section class="section reminders">
    <h3>ğŸ“¬ Reminders Sent</h3>
    <ul id="remindersList">
      <!-- Fetched via JS -->
    </ul>
  </section>

  <footer>
    <p>Â© 2025â€“2030 SmartWerk. All rights reserved.</p>
  </footer>

  <script type="module" src="bookkeeper.js">
    // ğŸ“ bookkeeper.js â€” Firebase Ñ–Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ñ–Ñ Ğ´Ğ»Ñ My Bookkeeper

import {
  initializeApp,
  getApps,
  getApp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
  getFirestore,
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1",
};

const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const $ = (id) => document.getElementById(id);

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "login.html";
  const uid = user.uid;

  const invoices = await getData("invoices", uid);
  const expenses = await getData("expenses", uid);
  const reminders = await getData("reminders", uid);

  renderKPI(invoices, expenses);
  renderChart(invoices, expenses);
  renderTables(invoices, expenses, reminders);
});

async function getData(collectionName, uid) {
  const q = query(collection(db, collectionName), where("userId", "==", uid));
  const snap = await getDocs(q);
  const data = [];
  snap.forEach(doc => data.push(doc.data()));
  return data;
}

function renderKPI(invoices, expenses) {
  const income = invoices.reduce((sum, i) => sum + parseFloat(i.total || 0), 0);
  const cost = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
  const vat = invoices.reduce((sum, i) => sum + parseFloat(i.vat || 0), 0);
  const profit = income - cost;

  $("kpiIncome").textContent = "â‚¬" + income.toFixed(2);
  $("kpiExpenses").textContent = "â‚¬" + cost.toFixed(2);
  $("kpiProfit").textContent = "â‚¬" + profit.toFixed(2);
  $("kpiVAT").textContent = "â‚¬" + vat.toFixed(2);
  $("kpiInvoices").textContent = invoices.length;
}

function renderChart(invoices, expenses) {
  const byMonth = {};

  invoices.forEach(i => {
    const month = (i.date || '').substring(0, 7);
    if (!byMonth[month]) byMonth[month] = { income: 0, expenses: 0 };
    byMonth[month].income += parseFloat(i.total || 0);
  });

  expenses.forEach(e => {
    const month = (e.date || '').substring(0, 7);
    if (!byMonth[month]) byMonth[month] = { income: 0, expenses: 0 };
    byMonth[month].expenses += parseFloat(e.amount || 0);
  });

  const labels = Object.keys(byMonth).sort();
  const incomeData = labels.map(m => byMonth[m].income);
  const expenseData = labels.map(m => byMonth[m].expenses);

  const ctx = document.getElementById("bkChart").getContext("2d");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Income', data: incomeData },
        { label: 'Expenses', data: expenseData }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function renderTables(invoices, expenses, reminders) {
  const invList = $("tableInvoices");
  const expList = $("tableExpenses");
  const remList = $("tableReminders");

  invList.innerHTML = "";
  invoices.forEach(i => {
    invList.innerHTML += `<tr><td>${i.number}</td><td>${i.clientName}</td><td>${i.date}</td><td>â‚¬${i.total}</td><td>${i.status}</td></tr>`;
  });

  expList.innerHTML = "";
  expenses.forEach(e => {
    expList.innerHTML += `<tr><td>${e.category}</td><td>${e.date}</td><td>â‚¬${e.amount}</td><td>${e.notes || ''}</td></tr>`;
  });

  remList.innerHTML = "";
  reminders.forEach(r => {
    remList.innerHTML += `<tr><td>${r.reminderId}</td><td>${r.clientName}</td><td>${r.dueDate}</td><td>${r.status}</td></tr>`;
  });
}

window.refreshBookkeeper = () => window.location.reload();
  </script>
</body>
</html>
