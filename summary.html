<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📊 SmartWerk Summary</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { background: #0f172a; color: #e5e7eb; font-family: 'Inter', sans-serif; padding: 20px; }
    h1 { margin-bottom: 10px; }
    .btn { background: #334155; color: #fff; padding: 6px 12px; border-radius: 6px; text-decoration: none; margin-right: 8px; }
    .btn-primary { background: #3b82f6; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-top: 20px; }
    .card { background: #1e293b; padding: 16px; border-radius: 8px; box-shadow: 0 0 0 1px #334155; }
    .card h2 { font-size: 16px; color: #93c5fd; margin-bottom: 4px; }
    .card p { font-size: 20px; font-weight: bold; }
    .filters { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    select, input[type="date"] { background: #1e293b; border: none; color: #e5e7eb; padding: 6px 8px; border-radius: 6px; }
    canvas { background: #1e293b; border-radius: 8px; padding: 10px; margin-top: 30px; }
    .section { margin-top: 40px; }
    footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 13px; }
    .alerts ul { list-style-type: disc; padding-left: 20px; }
  </style>
</head>
<body>
 <h1>📊 Business Summary</h1>
  <a href="dashboard.html" class="btn">← Back to Dashboard</a>
  <button onclick="exportCSV()" class="btn">📁 Export CSV</button>
  <button onclick="exportPDF()" class="btn btn-primary">📄 Export PDF</button>

  <div class="filters">
    <label>
      Period:
      <select id="filterBy">
        <option value="all">All time</option>
        <option value="thisYear">This Year</option>
        <option value="thisMonth">This Month</option>
        <option value="lastMonth">Last Month</option>
      </select>
    </label>
    <label>
      From: <input type="date" id="customFrom">
    </label>
    <label>
      To: <input type="date" id="customTo">
    </label>
  </div>

  <div class="stats">
    <div class="card"><h2>Total Income</h2><p id="totalIncome">€0</p></div>
    <div class="card"><h2>Total Expenses</h2><p id="totalExpenses">€0</p></div>
    <div class="card"><h2>Profit</h2><p id="netProfit">€0</p></div>
    <div class="card"><h2>Total VAT</h2><p id="totalVat">€0</p></div>
  </div>

  <div class="section">
    <h2>📊 Income vs Expenses</h2>
    <canvas id="summaryChart" height="100"></canvas>
  </div>

  <div class="section alerts">
    <h2>🧠 Smart Suggestions</h2>
    <ul>
      <li>📌 You have <strong>3 unpaid invoices</strong> older than 30 days</li>
      <li>💡 Consider registering for KOR if your VAT is under €1,800 this year</li>
      <li>📈 Income dropped -15% compared to last month</li>
      <li>📆 Average payment time: <strong>18 days</strong></li>
    </ul>
  </div>

  <footer>© 2025 SmartWerk </footer>

 <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = id => document.getElementById(id);
    let summaryChart = null;

    function formatCurrency(eur) {
      return "€" + (eur || 0).toLocaleString("nl-NL", { minimumFractionDigits: 2 });
    }

    function listenToSummary(uid) {
      const invoicesRef = collection(db, "users", uid, "invoices");
      const expensesRef = collection(db, "users", uid, "expenses");

      let invoices = [];
      let expenses = [];

      onSnapshot(invoicesRef, snap => {
        invoices = snap.docs.map(d => d.data());
        updateSummary(invoices, expenses);
      });

      onSnapshot(expensesRef, snap => {
        expenses = snap.docs.map(d => d.data());
        updateSummary(invoices, expenses);
      });
    }

    function updateSummary(invoices, expenses) {
      let totalIncome = 0;
      let totalVat = 0;
      let totalExpenses = 0;
      let incomeByMonth = {};
      let expenseByMonth = {};

      invoices.forEach(i => {
        const date = i.invoiceDate || i.date;
        const m = (date || "").slice(0, 7);
        incomeByMonth[m] = (incomeByMonth[m] || 0) + (i.grandTotal || 0);
        totalIncome += i.grandTotal || 0;
        totalVat += i.totalVat || 0;
      });

      expenses.forEach(e => {
        const date = e.date;
        const m = (date || "").slice(0, 7);
        expenseByMonth[m] = (expenseByMonth[m] || 0) + (e.amount || 0);
        totalExpenses += e.amount || 0;
      });

      const netProfit = totalIncome - totalExpenses;
      $("totalIncome").innerText = formatCurrency(totalIncome);
      $("totalVat").innerText = formatCurrency(totalVat);
      $("totalExpenses").innerText = formatCurrency(totalExpenses);
      $("netProfit").innerText = formatCurrency(netProfit);
      $("lastUpdated").textContent = new Date().toLocaleString();

      drawChart(incomeByMonth, expenseByMonth);
    }

    function drawChart(incomeMap, expenseMap) {
      const ctx = document.getElementById("summaryChart").getContext("2d");
      if (summaryChart) summaryChart.destroy();
      const labels = Array.from(new Set([...Object.keys(incomeMap), ...Object.keys(expenseMap)])).sort();
      const incomeData = labels.map(m => incomeMap[m] || 0);
      const expenseData = labels.map(m => expenseMap[m] || 0);

      summaryChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Income", data: incomeData, backgroundColor: "#22c55e" },
            { label: "Expenses", data: expenseData, backgroundColor: "#ef4444" }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } }
        }
      });
    }

    window.exportCSV = () => {
      const rows = [
        ["Metric", "Value"],
        ["Total Income", $("totalIncome").innerText],
        ["Total Expenses", $("totalExpenses").innerText],
        ["Net Profit", $("netProfit").innerText],
        ["Total VAT", $("totalVat").innerText]
      ];
      let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "summary.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    window.exportPDF = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text("SmartWerk Summary", 105, 15, { align: "center" });
      doc.setFontSize(12);
      doc.text("Report Overview:", 14, 30);
      doc.autoTable({
        startY: 35,
        head: [["Metric", "Value"]],
        body: [
          ["Total Income", $("totalIncome").innerText],
          ["Total Expenses", $("totalExpenses").innerText],
          ["Net Profit", $("netProfit").innerText],
          ["Total VAT", $("totalVat").innerText]
        ]
      });
      doc.setFontSize(10);
      doc.text("Generated with SmartWerk", 105, 285, { align: "center" });
      doc.save("summary.pdf");
    };

    onAuthStateChanged(auth, user => {
      if (!user) return location.href = "login.html";
      listenToSummary(user.uid);
    });
  </script>
</body>
</html>
