<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartWerk ‚Äî Profile Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e1014; --card:#151823; --muted:#9aa3b2; --ok:#27c693; --warn:#ffb020; --err:#ff5470; --line:#232a42;
      --panel:#151b28; --panel2:#141827; --accent:#3b79ff; --input:#0f1422;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:#e9edf5;background:radial-gradient(1200px 600px at 10% -10%,#1d2233 0%,#0e1014 40%),linear-gradient(#0e1014,#0e1014)}
    .wrap{max-width:880px;margin:0 auto;padding:22px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{font-weight:700;font-size:18px}
    .btn{background:#2b3350;border:1px solid #3b4567;color:#e9edf5;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:#3b79ff;border-color:#4d86ff}
    .btn.ghost{background:transparent;border:1px solid #3b4567;color:#9aa3b2}
    .card{background:linear-gradient(180deg,#161b28,#141827);border:1px solid #232a42;border-radius:16px;padding:18px}
    h2{margin:0 0 12px 0}
    label{display:block;margin-top:14px;color:#cdd5e3}
    input, textarea, select{
      width:100%;margin-top:6px;padding:12px 12px;border-radius:10px;border:1px solid #2a3557;background:var(--input);color:#e9edf5;
      outline:none
    }
    input[disabled]{opacity:.7;background:#0c1220}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:10px;margin-top:18px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .msg{margin-top:12px;padding:10px 12px;border-radius:10px;display:none}
    .msg.err{display:block;background:#3a1b24;border:1px solid #6a2c40;color:#ffd9df}
    .msg.ok{display:block;background:#17352a;border:1px solid #1f5e46;color:#d6ffef}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">üë§ SmartWerk ‚Äî Profile Control</div>
      <div class="right">
        <a href="dashboard.html" class="btn ghost">‚Üê Dashboard</a>
        <a href="index.html" class="btn">Main Page</a>
      </div>
    </div>

    <div class="card">
      <h2>User Profile</h2>
      <div class="muted" id="userEmailTop">‚Äî</div>

      <form id="profileForm">
        <label>Email
          <input type="email" id="emailDisplay" class="ro" disabled />
        </label>

        <div class="row">
          <label>Full Name
            <input type="text" id="fullName" placeholder="John Doe" />
          </label>
          <label>Phone Number
            <input type="text" id="phone" placeholder="+31 6 12 34 56 78" />
          </label>
        </div>

        <label>Address
          <input type="text" id="address" placeholder="Street, City, Postcode" />
        </label>

        <div class="row">
          <label>KvK Number
            <input type="text" id="kvk" placeholder="8 digits (e.g. 12345678)" />
          </label>
          <label>IBAN
            <input type="text" id="iban" placeholder="NL00 BANK 0123 4567 89" />
          </label>
        </div>

        <div class="actions">
          <button type="submit" id="btnSave" class="btn primary">Save Profile</button>
          <a href="login.html" class="btn ghost">Login</a>
        </div>

        <div id="msg" class="msg"></div>
      </form>
    </div>
  </div>

  <!-- Firebase (modules) -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const msg = $("msg");

    let ORIGINAL_KVK = ""; // –∑–±–µ—Ä–µ–∂–µ–º–æ KvK, —è–∫–∏–π –±—É–≤ —É –ø—Ä–æ—Ñ—ñ–ª—ñ –¥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è

    function showMsg(text, type="err"){
      msg.textContent = text;
      msg.className = "msg " + (type === "ok" ? "ok" : "err");
    }
    function clearMsg(){ msg.textContent = ""; msg.className = "msg"; msg.style.display="none"; }
    const show = (t, type="err") => { msg.style.display="block"; showMsg(t, type); };

    // –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è KvK: –ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∏/–±—É–∫–≤–∏, –≤–µ–ª–∏–∫–∏–π —Ä–µ–≥—ñ—Å—Ç—Ä
    function normalizeKvK(v){
      return (v || "").toString().replace(/[^0-9A-Za-z]/g,"").toUpperCase();
    }
    // –ë–∞–∑–æ–≤–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è: 8 —Ü–∏—Ñ—Ä (–∫–ª–∞—Å–∏—á–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç KvK)
    function isValidKvK(v){
      const n = (v||"").replace(/\D/g,"");
      return n.length === 8;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }

      $("userEmailTop").textContent = user.email || "‚Äî";
      $("emailDisplay").value = user.email || "";

      const userRef = doc(db, "users", user.uid);
      let snap = await getDoc(userRef);

      if (!snap.exists()) {
        await setDoc(userRef, {
          email: user.email || "",
          pro: false,
          fullName: "",
          address: "",
          kvk: "",
          iban: "",
          phone: "",
          invoiceCount: 0
        });
        snap = await getDoc(userRef);
      }

      const data = snap.data() || {};
      ORIGINAL_KVK = data.kvk || "";

      $("fullName").value = data.fullName || "";
      $("address").value  = data.address  || "";
      $("kvk").value      = data.kvk      || "";
      $("iban").value     = data.iban     || "";
      $("phone").value    = data.phone    || "";
    });

    $("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMsg();

      const btn = $("btnSave");
      btn.disabled = true;

      try {
        const user = auth.currentUser;
        if (!user) return;

        const fullName = $("fullName").value.trim();
        const address  = $("address").value.trim();
        const kvkRaw   = $("kvk").value.trim();
        const iban     = $("iban").value.trim();
        const phone    = $("phone").value.trim();

        const newKvK   = kvkRaw;
        const oldKvK   = ORIGINAL_KVK;

        const userRef  = doc(db, "users", user.uid);

        // –Ø–∫—â–æ KvK –Ω–µ –∑–º—ñ–Ω—é–≤–∞–≤—Å—è ‚Äî –ø—Ä–æ—Å—Ç–∞ updateDoc
        if ((newKvK || "") === (oldKvK || "")) {
          await updateDoc(userRef, { fullName, address, iban, phone });
          show("‚úÖ Profile saved.", "ok");
          return;
        }

        // –Ø–∫—â–æ –∑–º—ñ–Ω—é—î—Ç—å—Å—è KvK:
        // 1) –í–∞–ª—ñ–¥–∞—Ü—ñ—è (–¥–æ–∑–≤–æ–ª–∏–º–æ —Ç–∞–∫–æ–∂ –æ—á–∏—Å—Ç–∏—Ç–∏ KvK ‚Äî —Ç–æ–¥—ñ –ø—Ä–æ—Å—Ç–æ –∑–≤—ñ–ª—å–Ω–∏–º–æ —ñ–Ω–¥–µ–∫—Å)
        const newKvKId = normalizeKvK(newKvK);
        const oldKvKId = normalizeKvK(oldKvK);

        if (newKvK && !isValidKvK(newKvK)) {
          show("‚ùå KvK must be exactly 8 digits (e.g. 12345678).");
          return;
        }

        // 2) –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è: –∑–≤—ñ–ª—å–Ω—è—î–º–æ —Å—Ç–∞—Ä–∏–π —ñ–Ω–¥–µ–∫—Å (—è–∫—â–æ –Ω–∞–ª–µ–∂–∏—Ç—å —Ü—å–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É),
        //    —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π —ñ–Ω–¥–µ–∫—Å (—è–∫—â–æ –≤—ñ–ª—å–Ω–∏–π), –æ–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å
        await runTransaction(db, async (tx) => {
          // –ü—Ä–æ—á–∏—Ç–∞—î–º–æ —é–∑–µ—Ä-–¥–æ–∫ (–¥–ª—è –±–µ–∑–ø–µ–∫–∏, –∞–ª–µ –Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ)
          await tx.get(userRef);

          // –Ø–∫—â–æ –±—É–≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π KvK ‚Üí –≤–∏–¥–∞–ª—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —ñ–Ω–¥–µ–∫—Å, —è–∫—â–æ —Ä–µ—Å—É—Ä—Å –Ω–∞–ª–µ–∂–∏—Ç—å –Ω–∞–º
          if (oldKvKId) {
            const oldIdxRef = doc(db, "kvkIndex", oldKvKId);
            const oldSnap = await tx.get(oldIdxRef);
            if (oldSnap.exists()) {
              const owner = oldSnap.data()?.uid;
              if (owner === user.uid) {
                tx.delete(oldIdxRef);
              } // —è–∫—â–æ –∑ —è–∫–æ—ó—Å—å –ø—Ä–∏—á–∏–Ω–∏ –Ω–µ –º–∏ –≤–ª–∞—Å–Ω–∏–∫–∏ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
            }
          }

          // –Ø–∫—â–æ –Ω–æ–≤–∏–π KvK –Ω–µ–ø–æ—Ä–æ–∂–Ω—ñ–π ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ —ñ–Ω–¥–µ–∫—Å –í–Ü–õ–¨–ù–ò–ô
          if (newKvKId) {
            const newIdxRef = doc(db, "kvkIndex", newKvKId);
            const newSnap = await tx.get(newIdxRef);
            if (newSnap.exists()) {
              // –∑–∞–π–Ω—è—Ç–æ ‚Äî –∫–∏–¥–∞—î–º–æ –ø–æ–º–∏–ª–∫—É (—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –≤—ñ–¥–∫–æ—Ç–∏—Ç—å—Å—è)
              throw new Error("KVK_TAKEN");
            }
            // —Ä–µ–∑–µ—Ä–≤—É—î–º–æ
            tx.set(newIdxRef, {
              uid: user.uid,
              email: user.email || "",
              createdAt: serverTimestamp()
            });
          }

          // –û–Ω–æ–≤–ª—é—î–º–æ —Å–∞–º –ø—Ä–æ—Ñ—ñ–ª—å (–≤–∫–ª—é—á–Ω–æ –∑ –Ω–æ–≤–∏–º KvK)
          tx.update(userRef, { fullName, address, iban, phone, kvk: newKvK });
        });

        // –£—Å–ø—ñ—Ö
        ORIGINAL_KVK = newKvK;
        show("‚úÖ Profile saved. KvK updated.", "ok");

      } catch (err) {
        if (String(err && err.message).includes("KVK_TAKEN")) {
          show("‚ùå This KvK number is already used by another account. Please enter a different KvK.");
        } else {
          console.error(err);
          show("‚ùå Failed to save profile. Please try again.");
        }
      } finally {
        $("btnSave").disabled = false;
      }
    });
  </script>
</body>
</html>
