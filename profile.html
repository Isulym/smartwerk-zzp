<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>SmartWerk ‚Äî –ü—Ä–æ—Ñ—ñ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- –°—É—á–∞—Å–Ω–∏–π —Ç–µ–º–Ω–∏–π —Å—Ç–∏–ª—å —É –¥—É—Å—ñ –≤–∞—à–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞ -->
  <style>
    :root { --bg:#0e1014; --card:#151823; --muted:#9aa3b2; --ok:#27c693; --warn:#ffb020; --err:#ff5470; --line:#22283a; --pri:#3b79ff;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:#e9edf5;background:radial-gradient(1200px 600px at 10% -10%,#1d2233 0%,#0e1014 40%),linear-gradient(#0e1014,#0e1014)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{font-weight:700;font-size:18px;letter-spacing:.2px}
    .right{display:flex;gap:10px;align-items:center}
    .btn{background:#2b3350;border:1px solid #3b4567;color:#e9edf5;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none}
    .btn:hover{filter:brightness(1.08)}
    .btn.ghost{background:transparent;border-color:#3b4567}
    .btn.danger{background:#4a2330;border-color:#6a2c40}
    .badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .badge.pro{background:linear-gradient(90deg,#ffdf6b,#ffb020);color:#1c1200}
    .badge.free{background:#2a3147;color:#c9d2e3;border:1px solid #3a425e}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:linear-gradient(180deg,#161b28,#141827);border:1px solid #232a42;border-radius:16px;padding:18px}
    .card h2{margin:0 0 12px 0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .form label{font-size:12px;color:var(--muted)}
    .field{display:flex;flex-direction:column;gap:6px}
    input,select{background:#0f1320;border:1px solid #2a3147;color:#e9edf5;border-radius:10px;padding:10px 12px;outline:none}
    input:disabled{opacity:.7}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .sep{height:1px;background:var(--line);margin:14px 0}
    .note{font-size:13px}
    .note.ok{color:var(--ok)} .note.warn{color:var(--warn)} .note.err{color:var(--err)}
    .banner{background:#1a2033;border:1px dashed #2e3a62;padding:10px 12px;border-radius:10px;margin-bottom:12px;font-size:13px}
    @media (max-width:820px){.form{grid-template-columns:1fr}}
  </style>

  <!-- Firebase CDN (ESM) -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // UI refs
    const $ = (id)=>document.getElementById(id);
    const planBadge = $("planBadge");
    const statusText = $("statusText");
    const verifyBanner = $("verifyBanner");

    // KvK –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è: 8 —Ü–∏—Ñ—Ä
    const normKvK = v => (v || "").toString().replace(/\D/g, "").padStart(8,"0").slice(-8);

    // –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è: –ø—Ä–∏–≤‚Äô—è–∑–∫–∞ KvK ‚Üí uid (—Ç–∞ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ–≥–æ)
    async function linkKvKToUser(rawKvK) {
      const user = auth.currentUser;
      if (!user) throw new Error("–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —É–≤—ñ–π—Ç–∏.");
      const newKvK = normKvK(rawKvK);
      if (!/^\d{8}$/.test(newKvK)) throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π KvK (8 —Ü–∏—Ñ—Ä).");

      await runTransaction(db, async (tx) => {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await tx.get(userRef);
        const oldKvK = userSnap.exists() ? normKvK(userSnap.data().kvk || "") : "";

        const newIdxRef = doc(db, "kvkIndex", newKvK);
        const newIdxSnap = await tx.get(newIdxRef);
        if (newIdxSnap.exists() && newIdxSnap.data().uid !== user.uid) {
          throw new Error("‚ùó –¶–µ–π KvK —É–∂–µ –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–∏–π –¥–æ —ñ–Ω—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç–∞.");
        }

        // –ó–≤—ñ–ª—å–Ω—è—î–º–æ —Å—Ç–∞—Ä–∏–π —ñ–Ω–¥–µ–∫—Å, —è–∫—â–æ —é–∑–µ—Ä –º—ñ–Ω—è—î KvK
        if (oldKvK && oldKvK !== newKvK) {
          const oldIdxRef = doc(db, "kvkIndex", oldKvK);
          const oldIdxSnap = await tx.get(oldIdxRef);
          if (oldIdxSnap.exists() && oldIdxSnap.data().uid === user.uid) {
            tx.delete(oldIdxRef);
          }
        }

        // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω–¥–µ–∫—Å —ñ –ø—Ä–æ—Ñ—ñ–ª—å
        tx.set(newIdxRef, {
          uid: user.uid,
          email: user.email || "",
          updatedAt: serverTimestamp()
        }, { merge: true });

        tx.set(userRef, {
          email: user.email || "",
          kvk: newKvK,
          updatedAt: serverTimestamp()
        }, { merge: true });
      });
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }

      $("email").value = user.email || "";

      try {
        const userRef = doc(db, "users", user.uid);
        let snap = await getDoc(userRef);

        if (!snap.exists()) {
          await setDoc(userRef, {
            email: user.email || "",
            pro: false,
            fullName: "",
            address: "",
            kvk: "",
            iban: "",
            phone: "",
            invoiceCount: 0,
            createdAt: serverTimestamp()
          });
          snap = await getDoc(userRef);
        }

        const data = snap.data() || {};
        renderPlan(!!data.pro);

        $("fullName").value = data.fullName || "";
        $("address").value  = data.address  || "";
        $("kvk").value      = data.kvk      || "";
        $("iban").value     = data.iban     || "";
        $("phone").value    = data.phone    || "";

        // –±–∞–Ω–µ—Ä –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –µ–º–µ–π–ª–∞
        if (!user.emailVerified) {
          verifyBanner.style.display = "block";
        } else {
          verifyBanner.style.display = "none";
        }
      } catch (e) {
        statusText.textContent = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é.";
        statusText.className = "note err";
        console.error(e);
      }
    });

    function renderPlan(isPro){
      planBadge.textContent = isPro ? "PRO" : "FREE";
      planBadge.className = "badge " + (isPro ? "pro" : "free");
    }

    // –ö–Ω–æ–ø–∫–∏
    $("btnLogout").onclick = () => signOut(auth).then(()=>location.href="login.html");
    $("btnVerify").onclick = async () => {
      const u = auth.currentUser;
      if (!u) return;
      await sendEmailVerification(u);
      alert("–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –Ω–∞ –≤–∞—à email.");
    };

    // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ –∑ –ø—Ä–∏–≤‚Äô—è–∑–∫–æ—é KvK
    $("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      statusText.textContent = "";
      statusText.className = "note";

      const kvkRaw = $("kvk").value;

      try {
        // 1) –ü—Ä–∏–≤‚Äô—è–∑—É—î–º–æ KvK –∞—Ç–æ–º–∞—Ä–Ω–æ —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é
        await linkKvKToUser(kvkRaw);

        // 2) –û–Ω–æ–≤–ª—é—î–º–æ —Ä–µ—à—Ç—É –ø–æ–ª—ñ–≤ –ø—Ä–æ—Ñ—ñ–ª—é
        const user = auth.currentUser;
        const userRef = doc(db, "users", user.uid);
        await updateDoc(userRef, {
          fullName: $("fullName").value.trim(),
          address:  $("address").value.trim(),
          iban:     $("iban").value.trim(),
          phone:    $("phone").value.trim(),
          updatedAt: serverTimestamp()
        });

        statusText.textContent = "‚úÖ –ü—Ä–æ—Ñ—ñ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ. KvK –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–æ.";
        statusText.className = "note ok";
        setTimeout(()=>location.href="dashboard.html", 800);
      } catch (err) {
        console.error(err);
        statusText.textContent = err.message || "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å.";
        statusText.className = "note err";
      }
    });
  </script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">üíº SmartWerk ‚Äî –ü—Ä–æ—Ñ—ñ–ª—å</div>
      <div class="right">
        <a href="index.html" class="btn ghost">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
        <a href="dashboard.html" class="btn">Dashboard</a>
        <span id="planBadge" class="badge free">FREE</span>
        <button id="btnLogout" class="btn danger">Logout</button>
      </div>
    </div>

    <div id="verifyBanner" class="banner" style="display:none">
      –í–∞—à email –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ. –î–µ—è–∫—ñ –¥—ñ—ó –º–æ–∂—É—Ç—å –±—É—Ç–∏ –æ–±–º–µ–∂–µ–Ω—ñ.
      <button id="btnVerify" class="btn ghost" style="margin-left:8px;">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</button>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üë§ –î–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
        <form id="profileForm" class="form">
          <div class="field">
            <label>Email</label>
            <input id="email" type="email" disabled />
          </div>

          <div class="field">
            <label>KvK (8 —Ü–∏—Ñ—Ä) ‚Äî —É–Ω—ñ–∫–∞–ª—å–Ω–æ –¥–ª—è –∞–∫–∞—É–Ω—Ç–∞</label>
            <input id="kvk" type="text" inputmode="numeric" placeholder="12345678" maxlength="12"/>
          </div>

          <div class="field">
            <label>–ü–æ–≤–Ω–µ —ñ–º‚Äô—è</label>
            <input id="fullName" type="text" placeholder="John Doe" />
          </div>

          <div class="field">
            <label>–ê–¥—Ä–µ—Å–∞</label>
            <input id="address" type="text" placeholder="Street, City, Postcode" />
          </div>

          <div class="field">
            <label>IBAN</label>
            <input id="iban" type="text" placeholder="NL.." />
          </div>

          <div class="field">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input id="phone" type="text" placeholder="+31..." />
          </div>

          <div class="field" style="grid-column:1/-1;">
            <button type="submit" class="btn" style="width:220px;background:var(--pri);border-color:#4d86ff">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
          </div>
        </form>

        <div class="sep"></div>
        <div id="statusText" class="note"></div>
        <div class="muted" style="margin-top:8px">
          –ü—Ä–∏–º—ñ—Ç–∫–∞: —è–∫—â–æ –∑–º—ñ–Ω—é—î—Ç–µ KvK, –ø–æ–ø–µ—Ä–µ–¥–Ω—è –ø—Ä–∏–≤‚Äô—è–∑–∫–∞ –±—É–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≤—ñ–ª—å–Ω–µ–Ω–∞.
        </div>
      </div>
    </div>
  </div>
</body>
</html>
