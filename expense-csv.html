<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>💰 SmartWerk — Expense Tracker</title>
  <link rel="stylesheet" href="style-expense-csv.css"/>
</head>
<body>
  <header>
    <h1>💰 SmartWerk — Expense Tracker</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="expense-csv-list.html" class="btn">📂 Saved Expenses</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>🏢 Business Info</h2>
      <input id="businessName" placeholder="Business Name / Full Name" />
      <input id="email" placeholder="Business Email" />
      <input id="businessPhone" placeholder="Business Phone" />
    </section>

    <section>
      <h2>📅 Expense Details</h2>
      <input id="expenseId" placeholder="Expense ID (auto)" readonly />
      <input id="expenseDate" type="date" />
      <input id="description" placeholder="Description (e.g. Software Subscription)" />
      <input id="amount" placeholder="Amount (excl. VAT)" />
      <input id="vat" placeholder="VAT %" />
      <input id="country" placeholder="Country" />
      <select id="type">
        <option value="One-time">One-time</option>
        <option value="Monthly">Monthly</option>
      </select>
    </section>

    <section>
      <h2>📂 Category</h2>
      <input id="category" placeholder="Auto / Tools / Marketing / Travel..." />
      <button id="btnSmartSuggest" class="btn small">🤖 Smart Suggest</button>
    </section>

    <section>
      <h2>🧮 Live Calculator</h2>
      <p>Subtotal: <span id="subtotal">—</span></p>
      <p>VAT Total: <span id="vatTotal">—</span></p>
      <p><strong>Total (incl. VAT):</strong> <span id="total">—</span></p>
    </section>

    <section>
      <h2>💡 Deduction Breakdown</h2>
      <ul id="deductionsList">
        <li>💼 ZZP Deduction — applied automatically</li>
        <li>🏢 MKB Deduction — if eligible</li>
        <li>🚀 Startersaftrek — if new entrepreneur</li>
        <li>⚖️ KOR Scheme — if below threshold</li>
      </ul>
    </section>

    <section class="actions">
      <button id="aiFill" class="btn">🤖 AI Fill Example</button>
      <button id="saveBtn" class="btn-primary">💾 Save Expense</button>
    </section>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

  <!-- 🔥 FIREBASE -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, runTransaction, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = id => document.getElementById(id);
    const val = id => (document.getElementById(id)?.value || "").trim();
    const setVal = (id,v="") => { const el=$(id); if(el) el.value=v; };

    async function generateExpenseId(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap=await tx.get(ref);
        const last=snap.exists()? (snap.data().lastExpenseNumber||0):0;
        const next=last+1;
        tx.set(ref,{lastExpenseNumber:next},{merge:true});
        out=`EXP-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    async function logActivity(uid,type,message){
      try{
        await addDoc(collection(db,"users",uid,"events"),{
          type,message,createdAt:serverTimestamp()
        });
      }catch(e){console.warn("Log failed:",e);}
    }

    async function autofillProfile(uid){
      const ref = doc(db,"users",uid,"settings","profile");
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const p=snap.data();
      setVal("businessName",p.businessName||"");
      setVal("email",p.email||"");
      setVal("businessPhone",p.businessPhone||"");
    }

    async function saveExpense(){
      const user=auth.currentUser;
      if(!user){alert("Please log in"); return;}
      const uid=user.uid;

      let expenseId=val("expenseId");
      if(!expenseId){
        expenseId=await generateExpenseId(uid);
        setVal("expenseId",expenseId);
      }

      const amount=parseFloat(val("amount")||"0");
      const vat=parseFloat(val("vat")||"0");
      const vatTotal=(amount*vat)/100;
      const total=amount+vatTotal;

      const data={
        expenseId,
        expenseDate: val("expenseDate"),
        description: val("description"),
        type: val("type"),
        amount,
        vat,
        vatTotal,
        total,
        category: val("category"),
        country: val("country"),
        businessName: val("businessName"),
        email: val("email"),
        businessPhone: val("businessPhone"),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        userId: uid,
      };

      await setDoc(doc(db,"users",uid,"expenses",expenseId),data,{merge:true});
      await logActivity(uid,"Expense Saved",`${expenseId} created`);
      alert(`✅ Expense saved as ${expenseId}`);
      location.href="expense-csv-list.html";
    }

    onAuthStateChanged(auth,async(user)=>{
      if(!user){location.href="login.html";return;}
      await autofillProfile(user.uid);
      $("saveBtn").addEventListener("click",(e)=>{e.preventDefault();saveExpense();});
    });
  </script>

  <!-- 🤖 AI + SMART CALCULATOR -->
  <script>
  const $ = id => document.getElementById(id);

  document.getElementById("aiFill")?.addEventListener("click",()=>{
    $("description").value="Adobe Creative Cloud Subscription";
    $("amount").value="60";
    $("vat").value="21";
    $("country").value="Netherlands";
    $("type").value="Monthly";
    $("category").value="Software / Tools";
    updateCalc();
  });

  document.getElementById("btnSmartSuggest")?.addEventListener("click",()=>{
    const desc = ($("description")?.value||"").toLowerCase();
    let suggestion="General";
    if(desc.includes("fuel")||desc.includes("transport")) suggestion="Travel";
    else if(desc.includes("software")||desc.includes("app")||desc.includes("cloud")) suggestion="Software";
    else if(desc.includes("marketing")||desc.includes("ads")||desc.includes("facebook")) suggestion="Marketing";
    else if(desc.includes("office")||desc.includes("rent")) suggestion="Office";
    $("category").value=suggestion;
    alert(`💡 Suggested Category: ${suggestion}`);
  });

  function updateCalc(){
    const amount=parseFloat($("amount")?.value||"0");
    const vat=parseFloat($("vat")?.value||"0");
    const vatTotal=(amount*vat)/100;
    const total=amount+vatTotal;
    $("subtotal").innerText=amount.toFixed(2)+" €";
    $("vatTotal").innerText=vatTotal.toFixed(2)+" €";
    $("total").innerText=total.toFixed(2)+" €";
  }

  ["amount","vat"].forEach(id=>{
    $(id)?.addEventListener("input",updateCalc);
  });
  </script>
</body>
</html>
