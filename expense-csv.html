<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Expense Tracker</title>
  <link rel="stylesheet" href="style-expense-csv.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>💼 SmartWerk Expense Tracker</h1>

    <form id="expenseForm" class="expense-form">
      <h2>💸 New Expense Entry</h2>
      <div class="form-group">
        <label for="expenseId">Expense ID</label>
        <input type="text" id="expenseId" readonly placeholder="EXP-2025-001">
      </div>
      <div class="form-group">
        <label for="expenseType">Expense Type</label>
        <select id="expenseType">
          <option>One-time</option>
          <option>Recurring Monthly</option>
          <option>Subscription</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label for="invoiceAttached">Invoice Attached?</label>
        <select id="invoiceAttached">
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>
      <div class="form-group">
        <label for="description">Product / Service Description</label>
        <input type="text" id="description" placeholder="e.g., Adobe Creative Cloud Subscription">
      </div>
      <div class="form-group">
        <label for="paymentDate">Payment Date</label>
        <input type="date" id="paymentDate">
      </div>
      <div class="form-group">
        <label for="category">Smart Category (AI)</label>
        <input type="text" id="category" placeholder="e.g., Software, Marketing, Travel">
        <button type="button" id="suggestCategory">🧠 AI Suggest</button>
      </div>
      <div class="form-group">
        <label for="paymentStatus">Payment Status</label>
        <select id="paymentStatus">
          <option>Paid</option>
          <option>Unpaid</option>
          <option>Scheduled</option>
          <option>Failed</option>
        </select>
      </div>
      <div class="form-group">
        <label for="dueDate">Reminder / Due Date</label>
        <input type="date" id="dueDate">
      </div>
      <div class="form-group">
        <label for="amount">Amount (€)</label>
        <input type="number" id="amount" step="0.01">
      </div>
      <div class="form-group">
        <label for="vatRate">VAT Rate</label>
        <select id="vatRate">
          <option value="0">0%</option>
          <option value="9">9%</option>
          <option value="21">21%</option>
        </select>
      </div>
      <div class="form-group">
        <label for="vatAmount">VAT Amount (€)</label>
        <input type="number" id="vatAmount" readonly>
      </div>
      <div class="form-group">
        <label for="totalAmount">Total Amount (€)</label>
        <input type="number" id="totalAmount" readonly>
      </div>
      <div class="form-group">
        <label for="country">Country / Location</label>
        <input type="text" id="country" placeholder="e.g., Netherlands">
      </div>
      <div class="form-group">
        <label for="notes">Internal Notes (Optional)</label>
        <textarea id="notes" rows="2" placeholder="Only visible to you"></textarea>
      </div>
      <div class="form-actions">
        <button type="button" id="saveExpense">💾 Save Expense</button>
        <button type="button" id="exportCSV">📄 Export CSV</button>
        <button type="button" id="printExpense">🖨️ Print</button>
      </div>
    </form>

    <section id="expenseTableSection" style="margin-top:40px;">
      <h3>📊 Saved Expenses</h3>
      <div id="expenseTable"></div>
    </section>

   <div class="filters">
  <label>Status:
    <select id="filterStatus">
      <option value="">All Statuses</option>
      <option value="Paid">Paid</option>
      <option value="Unpaid">Unpaid</option>
      <option value="Scheduled">Scheduled</option>
      <option value="Failed">Failed</option>
    </select>
  </label>

  <label>Search:
    <input type="text" id="searchDescription" placeholder="🔍 Search by description..." />
  </label>

  <label>From:
    <input type="date" id="filterFromDate" />
  </label>

  <label>To:
    <input type="date" id="filterToDate" />
  </label>

  <label>Sort:
    <select id="sortBy">
      <option value="date">Sort by Date</option>
      <option value="amount">Sort by Amount</option>
    </select>
  </label>

  <button type="button" id="applyFilters">Apply Filters</button>
  <button type="button" id="resetFilters">Reset</button>
</div>

<script>
  
let editIndex = null;
  
  document.addEventListener("DOMContentLoaded", function () {
  const amountInput = document.getElementById("amount");
  const vatRateSelect = document.getElementById("vatRate");
  const vatAmountInput = document.getElementById("vatAmount");
  const totalAmountInput = document.getElementById("totalAmount");
  const saveBtn = document.getElementById("saveExpense");
  const exportCSVBtn = document.getElementById("exportCSV");
  const printBtn = document.getElementById("printExpense");
  const tableContainer = document.getElementById("expenseTable");
  const expenseIdField = document.getElementById("expenseId");

  let editingIndex = -1;

  function calculateVAT() {
    const amount = parseFloat(amountInput.value) || 0;
    const vatRate = parseFloat(vatRateSelect.value) || 0;
    const vatAmount = (amount * vatRate) / 100;
    const total = amount + vatAmount;
    vatAmountInput.value = vatAmount.toFixed(2);
    totalAmountInput.value = total.toFixed(2);
  }

  amountInput.addEventListener("input", calculateVAT);
  vatRateSelect.addEventListener("change", calculateVAT);

  function generateExpenseID() {
    const count = JSON.parse(localStorage.getItem("expenses") || "[]").length + 1;
    return `EXP-2025-${String(count).padStart(3, "0")}`;
  }

  function getFormData() {
    return {
      id: expenseIdField.value,
      type: document.getElementById("expenseType").value,
      attached: document.getElementById("invoiceAttached").value,
      description: document.getElementById("description").value,
      paymentDate: document.getElementById("paymentDate").value,
      category: document.getElementById("category").value,
      status: document.getElementById("paymentStatus").value,
      dueDate: document.getElementById("dueDate").value,
      amount: amountInput.value,
      vatRate: vatRateSelect.value,
      vatAmount: vatAmountInput.value,
      total: totalAmountInput.value,
      country: document.getElementById("country").value,
      notes: document.getElementById("notes").value
    };
  }

  function fillForm(data) {
    expenseIdField.value = data.id;
    document.getElementById("expenseType").value = data.type;
    document.getElementById("invoiceAttached").value = data.attached;
    document.getElementById("description").value = data.description;
    document.getElementById("paymentDate").value = data.paymentDate;
    document.getElementById("category").value = data.category;
    document.getElementById("paymentStatus").value = data.status;
    document.getElementById("dueDate").value = data.dueDate;
    amountInput.value = data.amount;
    vatRateSelect.value = data.vatRate;
    vatAmountInput.value = data.vatAmount;
    totalAmountInput.value = data.total;
    document.getElementById("country").value = data.country;
    document.getElementById("notes").value = data.notes;
  }

  function resetForm() {
    editingIndex = -1;
    document.getElementById("expenseForm").reset();
    expenseIdField.value = generateExpenseID();
    calculateVAT();
  }

  function saveExpense() {
  function saveExpense() {
  const data = getFormData();
  let expenses = JSON.parse(localStorage.getItem("expenses") || "[]");

  if (editIndex !== null) {
    expenses[editIndex] = data;
    editIndex = null;
  } else {
    expenses.push(data);
  }

  localStorage.setItem("expenses", JSON.stringify(expenses));
  alert("✅ Expense saved!");
  renderExpenses();
}

    

  function setupFiltersAndSorting() {
  const filterStatus = document.getElementById("filterStatus");
  const searchDescription = document.getElementById("searchDescription");
  const sortBy = document.getElementById("sortBy");

  [filterStatus, searchDescription, sortBy].forEach((el) => {
    el.addEventListener("input", renderExpenses);
  });
}
    function deleteExpense(index) {
  let expenses = JSON.parse(localStorage.getItem("expenses") || "[]");
  if (confirm(`Are you sure you want to delete expense ${expenses[index].id}?`)) {
    expenses.splice(index, 1);
    localStorage.setItem("expenses", JSON.stringify(expenses));
    renderExpenses();
  }
}

// ОНОВИТИ renderExpenses() так:
function renderExpenses() {
  let expenses = JSON.parse(localStorage.getItem("expenses") || "[]");

  const status = document.getElementById("filterStatus").value;
  const search = document.getElementById("searchDescription").value.toLowerCase();
  const from = document.getElementById("filterFromDate").value;
  const to = document.getElementById("filterToDate").value;
  const sortBy = document.getElementById("sortBy").value;

  expenses = expenses.filter((e) => {
    if (status && e.status !== status) return false;
    if (search && !e.description.toLowerCase().includes(search)) return false;
    if (from && e.paymentDate < from) return false;
    if (to && e.paymentDate > to) return false;
    return true;
  });

  // Сортування
  expenses.sort((a, b) => {
    if (sortBy === "amount") return parseFloat(b.total) - parseFloat(a.total);
    else return new Date(b.paymentDate) - new Date(a.paymentDate);
  });

  if (expenses.length === 0) {
    tableContainer.innerHTML = "<p>No matching expenses.</p>";
    return;
  }

  // ...залиш решту твоєї логіки рендеру таблиці 👇

  let html = `
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Type</th><th>Amount</th><th>Status</th><th>Due</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  expenses.forEach((e, index) => {
    let badge = "";
    if (e.status === "Paid") badge = '<span style="color:green;">Paid</span>';
    else if (e.status === "Unpaid") badge = '<span style="color:red;">Unpaid</span>';
    else badge = `<span>${e.status}</span>`;

    html += `
      <tr>
        <td>${e.id}</td>
        <td>${e.type}</td>
        <td>€${e.total}</td>
        <td>${badge}</td>
        <td>${e.dueDate}</td>
        <td>
          <button class="editBtn" data-index="${index}">✏️ Edit</button>
          <button class="deleteBtn" data-index="${index}">🗑️ Delete</button>
        </td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  tableContainer.innerHTML = html;

  // Підключення до кнопки редагування
  document.querySelectorAll(".editBtn").forEach((btn) => {
    btn.addEventListener("click", function () {
      editIndex = this.getAttribute("data-index");
      const expense = expenses[editIndex];
      expenseIdField.value = expense.id;
      document.getElementById("expenseType").value = expense.type;
      document.getElementById("invoiceAttached").value = expense.attached;
      document.getElementById("description").value = expense.description;
      document.getElementById("paymentDate").value = expense.paymentDate;
      document.getElementById("category").value = expense.category;
      document.getElementById("paymentStatus").value = expense.status;
      document.getElementById("dueDate").value = expense.dueDate;
      document.getElementById("amount").value = expense.amount;
      document.getElementById("vatRate").value = expense.vatRate;
      document.getElementById("vatAmount").value = expense.vatAmount;
      document.getElementById("totalAmount").value = expense.total;
      document.getElementById("country").value = expense.country;
      document.getElementById("notes").value = expense.notes;

      calculateVAT();
    });
  });

  // Кнопка видалення (залишилась)
  document.querySelectorAll(".deleteBtn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const index = this.getAttribute("data-index");
      if (confirm("Are you sure you want to delete this expense?")) {
        expenses.splice(index, 1);
        localStorage.setItem("expenses", JSON.stringify(expenses));
        renderExpenses();
      }
    });
  });
}

    document.getElementById("applyFilters").addEventListener("click", renderExpenses);
document.getElementById("resetFilters").addEventListener("click", () => {
  document.getElementById("filterStatus").value = "";
  document.getElementById("searchDescription").value = "";
  document.getElementById("filterFromDate").value = "";
  document.getElementById("filterToDate").value = "";
  document.getElementById("sortBy").value = "date";
  renderExpenses();
});

window.deleteExpense = function(index) {
  let expenses = JSON.parse(localStorage.getItem("expenses") || "[]");
  if (confirm(`Are you sure you want to delete expense ${expenses[index].id}?`)) {
    expenses.splice(index, 1);
    localStorage.setItem("expenses", JSON.stringify(expenses));
    renderExpenses();
  }
}

// ДОДАТИ В КІНЕЦЬ DOMContentLoaded або main init:
setupFiltersAndSorting();
  function exportToCSV() {
    const expenses = JSON.parse(localStorage.getItem("expenses") || "[]");
    if (expenses.length === 0) return alert("Nothing to export!");

    const csv = [
      ["ID", "Type", "Attached", "Description", "PaymentDate", "Category", "Status", "DueDate", "Amount", "VATRate", "VATAmount", "Total", "Country", "Notes"]
    ];
    expenses.forEach(e => {
      csv.push([
        e.id, e.type, e.attached, e.description, e.paymentDate, e.category,
        e.status, e.dueDate, e.amount, e.vatRate, e.vatAmount, e.total, e.country, e.notes
      ]);
    });

    const blob = new Blob([csv.map(r => r.join(",")).join("\n")], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "smartwerk-expenses.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function printExpenses() {
    window.print();
  }

  document.getElementById("suggestCategory").addEventListener("click", () => {
    const desc = document.getElementById("description").value.toLowerCase();
    let suggestion = "Other";
    if (desc.includes("flight") || desc.includes("hotel")) suggestion = "Travel";
    else if (desc.includes("ads") || desc.includes("facebook") || desc.includes("google")) suggestion = "Marketing";
    else if (desc.includes("software") || desc.includes("subscription")) suggestion = "Software";
    document.getElementById("category").value = suggestion;
  });

  saveBtn.addEventListener("click", saveExpense);
  exportCSVBtn.addEventListener("click", exportToCSV);
  printBtn.addEventListener("click", printExpenses);

  // Init
  renderExpenses();
  expenseIdField.value = generateExpenseID();
  calculateVAT();

</script>
  
</body>
</html>
