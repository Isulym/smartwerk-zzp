<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ’° SmartWerk â€” Expense Tracker (PRO)</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:'Inter',sans-serif; }
    h1,h2{color:#fff;}
    section{background:#1e293b;padding:15px;border-radius:12px;margin-bottom:15px;}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:none;margin-top:4px;background:#334155;color:#fff;}
    label{font-size:14px;color:#94a3b8;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .btn-primary{background:#3b82f6;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;}
    .btn{background:#475569;color:#fff;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;}
    #smartSuggestModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);
      display:none;align-items:center;justify-content:center;z-index:1000;pointer-events:none;}
    #smartSuggestModal.active{display:flex;pointer-events:all;}
    .modal-content{background:#1e293b;padding:20px;border-radius:12px;width:90%;max-width:400px;text-align:center;}
    .suggest-btn{display:block;width:100%;padding:10px;margin:8px 0;border:none;border-radius:8px;
      background:#3b82f6;color:#fff;font-size:15px;cursor:pointer;}
    .hint{background:#10b981;color:#fff;padding:8px;border-radius:6px;text-align:center;margin-top:10px;display:none;}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ’° SmartWerk â€” Expense Tracker</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="expense-csv-list.html" class="btn">ğŸ“‚ Saved Expenses</a>
    </nav>
  </header>

  <main>
    <!-- BUSINESS INFO -->
    <section>
      <h2>ğŸ¢ Business Info</h2>
      <div class="grid-2">
        <div>
          <label>Business Name</label>
          <input id="businessName" placeholder="Your business or full name"/>
        </div>
        <div>
          <label>Email</label>
          <input id="email" placeholder="your@email.com"/>
        </div>
      </div>
      <label>Address</label>
      <input id="businessAddress" placeholder="Street, City"/>
    </section>

    <!-- EXPENSE DETAILS -->
    <section>
      <h2>ğŸ’¸ Expense Details</h2>
      <div class="grid-2">
        <div>
          <label>Expense ID</label>
          <input id="expenseId" readonly placeholder="EXP-2025-001"/>
        </div>
        <div>
          <label>Date</label>
          <input type="date" id="date"/>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Expense Name / Description</label>
          <input id="description" placeholder="e.g. Adobe subscription"/>
        </div>
        <div>
          <label>Expense Type</label>
          <select id="type">
            <option>One-time</option>
            <option>Monthly</option>
            <option>Annual</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Category</label>
          <input id="category" placeholder="Select or use Smart Suggest"/>
        </div>
        <div>
          <label>Country / Location</label>
          <select id="country">
            <option>Netherlands</option>
            <option>Belgium</option>
            <option>Germany</option>
            <option>France</option>
            <option>Spain</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Amount (excl. VAT)</label>
          <input id="amount" type="number" placeholder="0.00"/>
        </div>
        <div>
          <label>VAT %</label>
          <select id="vat">
            <option value="0">0%</option>
            <option value="9">9%</option>
            <option value="21" selected>21%</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Invoice Attached</label>
          <select id="invoiceAttached"><option>No</option><option>Yes</option></select>
        </div>
        <div>
          <label>Payment Method</label>
          <select id="paymentMethod">
            <option>Bank</option><option>Credit Card</option><option>Cash</option>
            <option>PayPal</option><option>Other</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Payment Status</label>
          <select id="status">
            <option>Paid</option><option>Pending</option><option>Overdue</option><option>Scheduled</option>
          </select>
        </div>
        <div>
          <label>Notes</label>
          <input id="notes" placeholder="Optional notes..."/>
        </div>
      </div>

      <div style="margin-top:15px;">
        <p>Subtotal: <span id="subtotalDisplay">â‚¬0.00</span></p>
        <p>VAT: <span id="vatDisplay">â‚¬0.00</span></p>
        <p><strong>Total: <span id="totalDisplay">â‚¬0.00</span></strong></p>
      </div>

      <div class="actions">
        <button id="saveBtn" class="btn-primary">ğŸ’¾ Save Expense</button>
        <button id="viewBtn" class="btn">ğŸ“‚ View Saved</button>
        <button id="smartSuggestBtn" class="btn">ğŸ¤– Smart Suggest</button>
      </div>
      <div id="smartHint" class="hint"></div>
    </section>
  </main>

  <!-- Smart Suggest Modal -->
  <div id="smartSuggestModal">
    <div class="modal-content">
      <h3>ğŸ¤– Smart Suggest Category</h3>
      <button class="suggest-btn" data-cat="Office & Supplies">ğŸ§¾ Office & Supplies</button>
      <button class="suggest-btn" data-cat="Travel & Transport">ğŸš— Travel & Transport</button>
      <button class="suggest-btn" data-cat="Meals & Entertainment">â˜• Meals & Entertainment</button>
      <button class="suggest-btn" data-cat="Software & Tools">ğŸ’» Software & Tools</button>
      <button class="suggest-btn" data-cat="Accounting & Legal">ğŸ§® Accounting & Legal</button>
      <button class="btn" id="closeSuggest">âœ– Close</button>
    </div>
  </div>

  <footer><p>Â© 2025 SmartWerk</p></footer>

 <script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, addDoc, collection, runTransaction, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1",
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = (id) => document.getElementById(id);

// ======== Read Profile ========
async function readProfile(uid) {
  const paths = [
    ["users", uid, "profile", "main"],
    ["users", uid, "profile", uid],
    ["users", uid, "settings", "profile"],
    ["users", uid],
  ];
  for (const p of paths) {
    try {
      const ref = doc(db, ...p);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        console.log(`âœ… Profile found: /${p.join("/")}`);
        return snap.data();
      }
    } catch (e) {
      console.warn(e.message);
    }
  }
  console.warn("âŒ No profile found");
  return null;
}

async function autofillProfile(uid) {
  const p = await readProfile(uid);
  if (!p) return;
  const set = (id, v) => {
    const el = $(id);
    if (el && !el.value) el.value = v || "";
  };
  set("businessName", p.businessName || p.fullName || "");
  set("email", p.email || p.businessEmail || "");
  set("businessAddress", p.businessAddress || p.address || "");
  console.log("âœ… Profile auto-filled");
}

// ======== Expense ID Generator ========
async function generateExpenseId(uid) {
  const ref = doc(db, "users", uid);
  const year = new Date().getFullYear();
  let out = "";
  await runTransaction(db, async (tx) => {
    const s = await tx.get(ref);
    const last = s.exists() ? s.data().lastExpenseNumber || 0 : 0;
    const next = last + 1;
    tx.set(ref, { lastExpenseNumber: next }, { merge: true });
    out = `EXP-${year}-${String(next).padStart(3, "0")}`;
  });
  return out;
}

// ======== Totals ========
function updateTotals() {
  const amt = parseFloat($("#amount")?.value || 0);
  const vat = parseFloat($("#vat")?.value || 0);
  const vatAmt = (amt * vat) / 100;
  const total = amt + vatAmt;

  if ($("#subtotalDisplay")) $("#subtotalDisplay").textContent = `â‚¬${amt.toFixed(2)}`;
  if ($("#vatDisplay")) $("#vatDisplay").textContent = `â‚¬${vatAmt.toFixed(2)}`;
  if ($("#totalDisplay")) $("#totalDisplay").textContent = `â‚¬${total.toFixed(2)}`;
}

// ======== Smart Suggest ========
function initSmartSuggest() {
  const modal = $("#smartSuggestModal");
  const openBtn = $("#smartSuggestBtn");
  const closeBtn = $("#closeSuggest");
  const cat = $("#category");
  const hint = $("#smartHint");

  openBtn?.addEventListener("click", () => {
    modal.classList.add("active");
    modal.style.pointerEvents = "auto";
  });
  closeBtn?.addEventListener("click", () => {
    modal.classList.remove("active");
    modal.style.pointerEvents = "none";
  });

  document.querySelectorAll(".suggest-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const val = btn.dataset.cat;
      if (cat) cat.value = val;
      modal.classList.remove("active");
      modal.style.pointerEvents = "none";

      hint.textContent = `âœ… Category set: ${val}`;
      hint.style.display = "block";
      hint.style.opacity = "1";
      setTimeout(() => (hint.style.opacity = "0"), 2000);
      setTimeout(() => (hint.style.display = "none"), 2500);
    });
  });
}

// ======== Save Expense ========
async function saveExpense(uid) {
  const get = (id) => $(id)?.value || "";
  const idField = $("#expenseId");
  const id = (idField && idField.value) ? idField.value : await generateExpenseId(uid);
  const amt = parseFloat(get("amount")) || 0;
  const vat = parseFloat(get("vat")) || 0;
  const vatAmt = amt * vat / 100;
  const total = amt + vatAmt;

  const data = {
    expenseId: id,
    date: get("date"),
    description: get("description"),
    type: get("type"),
    category: get("category"),
    country: get("country"),
    amount: amt,
    vatPercent: vat,
    vatAmount: vatAmt,
    total: total,
    invoiceAttached: get("invoiceAttached"),
    paymentMethod: get("paymentMethod"),
    status: get("status"),
    notes: get("notes"),
    businessName: get("businessName"),
    email: get("email"),
    businessAddress: get("businessAddress"),
    createdAt: serverTimestamp(),
  };

  await addDoc(collection(db, "users", uid, "expenses"), data);
  alert(`âœ… Expense saved successfully (${id})`);
}

// ======== INIT ========
document.addEventListener("DOMContentLoaded", () => {
  ["amount", "vat"].forEach((id) => $(id)?.addEventListener("input", updateTotals));
  initSmartSuggest();
  updateTotals();
});

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "login.html";
    return;
  }
  await autofillProfile(user.uid);
  const idEl = $("#expenseId");
  const newId = await generateExpenseId(user.uid);
  if (idEl) idEl.value = newId;
  updateTotals();

  $("#saveBtn")?.addEventListener("click", () => saveExpense(user.uid));
  $("#viewBtn")?.addEventListener("click", () => (location.href = "expense-csv-list.html"));
});
</script>
</body>
</html>
