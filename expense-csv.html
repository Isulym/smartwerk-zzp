<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ’° SmartWerk â€” Expense Tracker (PRO)</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:'Inter',sans-serif; }
    h1,h2{color:#fff;}
    section{background:#1e293b;padding:15px;border-radius:12px;margin-bottom:15px;}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:none;margin-top:4px;background:#334155;color:#fff;}
    label{font-size:14px;color:#94a3b8;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .btn-primary{background:#3b82f6;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;}
    .btn{background:#475569;color:#fff;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;}
    #smartSuggestModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);
      display:none;align-items:center;justify-content:center;z-index:1000;}
    .modal-content{background:#1e293b;padding:20px;border-radius:12px;width:90%;max-width:400px;text-align:center;}
    .suggest-btn{display:block;width:100%;padding:10px;margin:8px 0;border:none;border-radius:8px;
      background:#3b82f6;color:#fff;font-size:15px;cursor:pointer;}
    .hint{background:#10b981;color:#fff;padding:8px;border-radius:6px;text-align:center;margin-top:10px;display:none;}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ’° SmartWerk â€” Expense Tracker</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="expense-csv-list.html" class="btn">ğŸ“‚ Saved Expenses</a>
    </nav>
  </header>

  <main>
    <!-- BUSINESS INFO -->
    <section>
      <h2>ğŸ¢ Business Info</h2>
      <div class="grid-2">
        <div>
          <label>Business Name</label>
          <input id="businessName" placeholder="Your business or full name"/>
        </div>
        <div>
          <label>Email</label>
          <input id="email" placeholder="your@email.com"/>
        </div>
      </div>
      <label>Address</label>
      <input id="businessAddress" placeholder="Street, City"/>
    </section>

    <!-- EXPENSE DETAILS -->
    <section>
      <h2>ğŸ’¸ Expense Details</h2>
      <div class="grid-2">
        <div>
          <label>Expense ID</label>
          <input id="expenseId" readonly placeholder="EXP-2025-001"/>
        </div>
        <div>
          <label>Date</label>
          <input type="date" id="date"/>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Expense Name / Description</label>
          <input id="description" placeholder="e.g. Adobe subscription"/>
        </div>
        <div>
          <label>Expense Type</label>
          <select id="type">
            <option>One-time</option>
            <option>Monthly</option>
            <option>Annual</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Category</label>
          <input id="category" placeholder="Select or use Smart Suggest"/>
        </div>
        <div>
          <label>Country / Location</label>
          <select id="country">
            <option>Netherlands</option>
            <option>Belgium</option>
            <option>Germany</option>
            <option>France</option>
            <option>Spain</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Amount (excl. VAT)</label>
          <input id="amount" type="number" placeholder="0.00"/>
        </div>
        <div>
          <label>VAT %</label>
          <select id="vat">
            <option value="0">0%</option>
            <option value="9">9%</option>
            <option value="21" selected>21%</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Invoice Attached</label>
          <select id="invoiceAttached"><option>No</option><option>Yes</option></select>
        </div>
        <div>
          <label>Payment Method</label>
          <select id="paymentMethod">
            <option>Bank</option><option>Credit Card</option><option>Cash</option>
            <option>PayPal</option><option>Other</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Payment Status</label>
          <select id="status">
            <option>Paid</option><option>Pending</option><option>Overdue</option><option>Scheduled</option>
          </select>
        </div>
        <div>
          <label>Notes</label>
          <input id="notes" placeholder="Optional notes..."/>
        </div>
      </div>

      <div style="margin-top:15px;">
        <p>Subtotal: <span id="subtotalDisplay">â‚¬0.00</span></p>
        <p>VAT: <span id="vatDisplay">â‚¬0.00</span></p>
        <p><strong>Total: <span id="totalDisplay">â‚¬0.00</span></strong></p>
      </div>

      <div class="actions">
        <button id="saveBtn" class="btn-primary">ğŸ’¾ Save Expense</button>
        <button id="viewBtn" class="btn">ğŸ“‚ View Saved</button>
        <button id="smartSuggestBtn" class="btn">ğŸ¤– Smart Suggest</button>
      </div>
      <div id="smartHint" class="hint"></div>
    </section>
  </main>

  <!-- Smart Suggest Modal -->
  <div id="smartSuggestModal">
    <div class="modal-content">
      <h3>ğŸ¤– Smart Suggest Category</h3>
      <button class="suggest-btn" data-cat="Office & Supplies">ğŸ§¾ Office & Supplies</button>
      <button class="suggest-btn" data-cat="Travel & Transport">ğŸš— Travel & Transport</button>
      <button class="suggest-btn" data-cat="Meals & Entertainment">â˜• Meals & Entertainment</button>
      <button class="suggest-btn" data-cat="Software & Tools">ğŸ’» Software & Tools</button>
      <button class="suggest-btn" data-cat="Accounting & Legal">ğŸ§® Accounting & Legal</button>
      <button class="btn" id="closeSuggest">âœ– Close</button>
    </div>
  </div>

  <footer><p>Â© 2025 SmartWerk</p></footer>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, collection, runTransaction, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const setTextSafe = (id, val)=>{
      const el = $(id);
      if (el) el.innerText = val;
    };

    // === Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ ID (Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ğ¹Ğ½Ğ¾)
    async function generateExpenseId(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastExpenseNumber||0):0;
        const next = last+1;
        tx.set(ref,{lastExpenseNumber:next},{merge:true});
        out=`EXP-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    // === Ğ Ğ¾Ğ·Ñ€Ğ°Ñ…ÑƒĞ½Ğ¾Ğº Total (Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¸Ğ¹)
    function updateTotals(){
      const amountEl = $("#amount");
      const vatEl    = $("#vat");
      if(!amountEl || !vatEl) return; // ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¸ Ñ‰Ğµ Ğ½Ğµ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ñ–

      const amt = parseFloat(amountEl.value||0);
      const vat = parseFloat(vatEl.value||0);
      const vatAmt = (amt * vat / 100) || 0;
      const total  = amt + vatAmt;

      setTextSafe("subtotalDisplay", `â‚¬${amt.toFixed(2)}`);
      setTextSafe("vatDisplay",      `â‚¬${vatAmt.toFixed(2)}`);
      setTextSafe("totalDisplay",    `â‚¬${total.toFixed(2)}`);
    }

    // === Smart Suggest Modal
    function bindSmartSuggest(){
      const btn=$("#smartSuggestBtn");
      const modal=$("#smartSuggestModal");
      const hint=$("#smartHint");
      const cat=$("#category");
      const closeBtn=$("#closeSuggest");

      if(btn) btn.addEventListener("click",()=>{ if(modal) modal.style.display="flex"; });
      if(closeBtn) closeBtn.addEventListener("click",()=>{ if(modal) modal.style.display="none"; });

      document.querySelectorAll(".suggest-btn").forEach(el=>{
        el.addEventListener("click",()=>{
          if(cat) cat.value=el.dataset.cat||"";
          if(modal) modal.style.display="none";
          if(hint){
            hint.textContent=`âœ… Category set to: ${el.dataset.cat}`;
            hint.style.display="block";
            setTimeout(()=>hint.style.display="none",2500);
          }
        });
      });
    }

    // === ĞĞ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾Ñ„Ñ–Ğ»Ñ
    async function autofillProfile(uid){
      try{
        const snap=await getDoc(doc(db,"users",uid,"settings","profile"));
        if(snap.exists()){
          const p=snap.data();
          if($("#businessName")) $("#businessName").value=p.businessName||"";
          if($("#email")) $("#email").value=p.email||"";
          if($("#businessAddress")) $("#businessAddress").value=p.businessAddress||"";
        }
      }catch(e){console.warn("Profile autofill error:",e);}
    }

    // === Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ñƒ Firestore
    async function saveExpense(uid){
      const id = $("#expenseId")?.value || await generateExpenseId(uid);
      const amt = parseFloat($("#amount")?.value||0);
      const vat = parseFloat($("#vat")?.value||0);
      const vatAmt = amt*vat/100;
      const total  = amt+vatAmt;

      const data={
        expenseId:id,
        date:$("#date")?.value||"",
        description:$("#description")?.value||"",
        type:$("#type")?.value||"One-time",
        category:$("#category")?.value||"",
        country:$("#country")?.value||"Netherlands",
        amount:amt,
        vatPercent:vat,
        vatAmount:vatAmt,
        total:total,
        invoiceAttached:$("#invoiceAttached")?.value||"No",
        paymentMethod:$("#paymentMethod")?.value||"Bank",
        status:$("#status")?.value||"Paid",
        notes:$("#notes")?.value||"",
        businessName:$("#businessName")?.value||"",
        email:$("#email")?.value||"",
        businessAddress:$("#businessAddress")?.value||"",
        createdAt:serverTimestamp()
      };
      await addDoc(collection(db,"users",uid,"expenses"),data);
      await addDoc(collection(db,"users",uid,"events"),{type:"Expense Created",message:`${id} saved`,createdAt:serverTimestamp()});
      alert("âœ… Expense saved successfully!");
      if($("#expenseId")) $("#expenseId").value=id;
    }

    // === INIT (Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ñ–Ñ Ğ¿Ğ¾Ñ€ÑĞ´ĞºÑƒ Ñ–Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ—)
    function initDOMBindings(){
      // live totals
      ["amount","vat"].forEach(id=>{
        const el=$("#"+id);
        if(el) el.addEventListener("input",updateTotals);
      });
      bindSmartSuggest();
      updateTotals(); // Ğ¿ĞµÑ€ÑˆĞ¸Ğ¹ Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ…ÑƒĞ½Ğ¾Ğº Ğ¿Ñ–ÑĞ»Ñ Ğ¼Ğ¾Ğ½Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ DOM
    }

    // Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ñ‡ĞµĞºĞ°Ñ”Ğ¼Ğ¾ DOM, Ğ¿Ğ¾Ñ‚Ñ–Ğ¼ Ğ¿Ñ–Ğ´â€™Ñ”Ğ´Ğ½ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑĞµ Ñ–Ğ½ÑˆĞµ
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initDOMBindings);
    } else {
      initDOMBindings();
    }

    onAuthStateChanged(auth, async(user)=>{
      if(!user){ location.href="login.html"; return; }
      await autofillProfile(user.uid);

      // Ğ³ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ID Ğ»Ğ¸ÑˆĞµ ĞºĞ¾Ğ»Ğ¸ DOM Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¹ (Ñ‰Ğ¾Ğ± Ğ¿Ğ¾Ğ»Ğµ Ñ–ÑĞ½ÑƒĞ²Ğ°Ğ»Ğ¾)
      const ensureId = async ()=>{
        const id = await generateExpenseId(user.uid);
        const el = $("#expenseId");
        if (el) el.value = id;
      };
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", ensureId, { once:true });
      } else {
        await ensureId();
      }

      // ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ñ–Ğ¹
      const saveBtn = $("#saveBtn");
      if (saveBtn) saveBtn.addEventListener("click", ()=>saveExpense(user.uid));

      const viewBtn = $("#viewBtn");
      if (viewBtn) viewBtn.addEventListener("click", ()=>location.href="expense-csv-list.html");
    });
  </script>
</body>
</html>
