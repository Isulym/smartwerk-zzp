<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ’° SmartWerk â€” Expense Tracker (PRO)</title>
  <link rel="stylesheet" href="style-expense-csv.css"/>
  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:'Inter',sans-serif; }
    h1,h2{color:#fff;}
    section{background:#1e293b;padding:15px;border-radius:12px;margin-bottom:15px;}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:none;margin-top:4px;background:#334155;color:#fff;}
    label{font-size:14px;color:#94a3b8;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .btn-primary{background:#3b82f6;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;}
    .btn{background:#475569;color:#fff;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;}

    /* Smart Suggest modal */
    #smartSuggestModal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;}
    #smartSuggestModal.active{display:flex;}
    .modal-content{background:#1e293b;padding:20px;border-radius:12px;width:90%;max-width:420px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.4);}
    .suggest-btn{display:block;width:100%;padding:10px;margin:8px 0;border:none;border-radius:8px;background:#3b82f6;color:#fff;font-size:15px;cursor:pointer;}
    .hint{background:#10b981;color:#fff;padding:8px;border-radius:6px;text-align:center;margin-top:10px;display:none;transition:opacity .25s;}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ’° SmartWerk â€” Expense Tracker</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="expense-csv-list.html" class="btn">ğŸ“‚ Saved Expenses</a>
    </nav>
  </header>

  <main>
  <!-- BUSINESS INFO -->
<section>
  <h2>ğŸ¢ Business Info</h2>
  <div class="grid-2">
    <div>
      <label for="businessName">Business Name</label>
      <input id="businessName" name="businessName"type="text" placeholder="Your business or full name" autocomplete="organization" required/>
    </div>

    <div>
      <label for="email">Email</label>
      <input id="email" name="email" type="email" placeholder="your@email.com"autocomplete="email" required/>
    </div>
  </div>

  <div>
    <label for="businessAddress">Business Address</label>
    <input id="businessAddress" name="businessAddress"type="text" placeholder="Street, City"autocomplete="street-address"required/>
  </div>
</section>

    <!-- EXPENSE DETAILS -->
    <section>
  <h2>ğŸ’¸ Expense Details</h2>

  <div class="grid-2">
    <div>
      <label for="expenseId">Expense ID</label>
      <input id="expenseId" name="expenseId" readonly placeholder="EXP-2025-001" type="text" autocomplete="off" />
    </div>
    <div>
      <label for="date">Date</label>
      <input id="date" name="date" type="date" required autocomplete="off" />
    </div>
  </div>

  <div class="grid-2">
    <div>
      <label for="description">Expense Name / Description</label>
      <input id="description" name="description" placeholder="e.g. Adobe subscription" type="text" required autocomplete="off" />
    </div>
    <div>
      <label for="type">Expense Type</label>
      <select id="type" name="type" required>
        <option>One-time</option>
        <option>Monthly</option>
        <option>Annual</option>
      </select>
    </div>
  </div>

  <div class="grid-2">
    <div>
      <label for="category">Category</label>
      <input id="category" name="category" placeholder="Select or use Smart Suggest" type="text" autocomplete="off" />
    </div>
    <div>
      <label for="country">Country / Location</label>
      <select id="country" name="country" autocomplete="country">
        <option>Netherlands</option>
        <option>Belgium</option>
        <option>Germany</option>
        <option>France</option>
        <option>Spain</option>
      </select>
    </div>
  </div>

  <div class="grid-2">
    <div>
      <label for="amount">Amount (excl. VAT)</label>
      <input id="amount" name="amount" type="number" placeholder="0.00" step="0.01" min="0" required autocomplete="off" />
    </div>
    <div>
      <label for="vat">VAT %</label>
      <select id="vat" name="vat" required>
        <option value="0">0%</option>
        <option value="9">9%</option>
        <option value="21" selected>21%</option>
      </select>
    </div>
  </div>

  <div class="grid-2">
    <div>
      <label for="invoiceAttached">Invoice Attached</label>
      <select id="invoiceAttached" name="invoiceAttached">
        <option>No</option>
        <option>Yes</option>
      </select>
    </div>
    <div>
      <label for="paymentMethod">Payment Method</label>
      <select id="paymentMethod" name="paymentMethod" required>
        <option>Bank</option>
        <option>Credit Card</option>
        <option>Cash</option>
        <option>PayPal</option>
        <option>Other</option>
      </select>
    </div>
  </div>

  <div class="grid-2">
    <div>
      <label for="status">Payment Status</label>
      <select id="status" name="status" required>
        <option>Paid</option>
        <option>Pending</option>
        <option>Overdue</option>
        <option>Scheduled</option>
      </select>
    </div>
    <div>
      <label for="notes">Notes</label>
      <input id="notes" name="notes" placeholder="Optional notes..." type="text" autocomplete="off" />
    </div>
  </div>

  <div style="margin-top:15px;">
    <p>Subtotal: <span id="subtotalDisplay">â‚¬0.00</span></p>
    <p>VAT: <span id="vatDisplay">â‚¬0.00</span></p>
    <p><strong>Total: <span id="totalDisplay">â‚¬0.00</span></strong></p>
  </div>

  <div class="actions">
    <button id="saveBtn" name="saveBtn" class="btn-primary" type="submit">ğŸ’¾ Save Expense</button>
    <button id="viewBtn" name="viewBtn" class="btn" type="button">ğŸ“‚ View Saved</button>
    <button id="smartSuggestBtn" name="smartSuggestBtn" class="btn" type="button">ğŸ¤– Smart Suggest</button>
  </div>

  <div id="smartHint" class="hint" role="note" aria-live="polite"></div>
</section>
  </main>

 <!-- Smart Suggest Modal -->
<div id="smartSuggestModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="suggestTitle" aria-hidden="true">
  <div class="modal-content">
    <h3 id="suggestTitle">ğŸ¤– Smart Suggest Category</h3>
    
    <div role="group" aria-label="Suggested categories">
      <button class="suggest-btn" type="button" data-cat="Office & Supplies">ğŸ§¾ Office & Supplies</button>
      <button class="suggest-btn" type="button" data-cat="Travel & Transport">ğŸš— Travel & Transport</button>
      <button class="suggest-btn" type="button" data-cat="Meals & Entertainment">â˜• Meals & Entertainment</button>
      <button class="suggest-btn" type="button" data-cat="Software & Tools">ğŸ’» Software & Tools</button>
      <button class="suggest-btn" type="button" data-cat="Accounting & Legal">ğŸ§® Accounting & Legal</button>
    </div>

    <button id="closeSuggest" type="button" class="btn" aria-label="Close Smart Suggest Modal">âœ– Close</button>
  </div>
</div>

  <footer><p>Â© 2025 SmartWerk</p></footer>

  <!-- APP -->
  <script type="module">
    /* ================= FIREBASE ================= */
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, collection, runTransaction, serverTimestamp, setLogLevel } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    setLogLevel("error");
     // import { setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      // import { getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ================ HELPERS ================ */
    const $ = (id)=>document.getElementById(id);
    const safeVal = (id)=>$(id)?.value ?? "";
    const clampNum = (v)=>Number.isFinite(v)?v:0;

    function ensureEls(ids){
      for(const id of ids){
        if(!$(id)){ console.error("âŒ Missing element #"+id); }
      }
    }

    /* ================ PROFILE READ ================ */
    async function readProfile(uid){
      const paths = [
        ["users", uid, "settings", "profile"], // Ğ½Ğ°Ñˆ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¸Ğ¹ ÑˆĞ»ÑÑ…
        ["users", uid, "profile", "main"],
        ["users", uid],                         // fallback
      ];
      for(const p of paths){
        try{
          const snap = await getDoc(doc(db, ...p));
          if(snap.exists()){ 
            console.log("âœ… Profile found at /"+p.join("/"));
            return snap.data();
          }
        }catch(e){ console.warn("Profile read error at "+p.join("/"), e.message); }
      }
      console.warn("âš ï¸ No profile doc found"); 
      return null;
    }

    async function autofillFromProfile(uid){
      const p = await readProfile(uid);
      if(!p) return;
      if($("businessName") && !$("businessName").value) $("businessName").value = p.businessName || p.fullName || "";
      if($("email")        && !$("email").value)        $("email").value        = p.email || p.businessEmail || "";
      if($("businessAddress") && !$("businessAddress").value) $("businessAddress").value = p.businessAddress || p.address || "";
      console.log("âœ… Autofilled from profile");
    }

    /* ================ ID GENERATOR ================ */
    async function generateExpenseId(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastExpenseNumber||0) : 0;
        const next = last + 1;
        tx.set(ref,{ lastExpenseNumber: next },{ merge:true });
        out = `EXP-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    /* ================ TOTALS ================ */
    function computeTotals(){
      const amt = clampNum(parseFloat(safeVal("amount")));
      const vat = clampNum(parseFloat(safeVal("vat")));
      const vatAmt = clampNum(amt * vat / 100);
      const total = clampNum(amt + vatAmt);
      return { amt, vatAmt, total };
    }

    function renderTotals(){
      const { amt, vatAmt, total } = computeTotals();
      if($("subtotalDisplay")) $("subtotalDisplay").textContent = "â‚¬"+amt.toFixed(2);
      if($("vatDisplay"))      $("vatDisplay").textContent      = "â‚¬"+vatAmt.toFixed(2);
      if($("totalDisplay"))    $("totalDisplay").textContent    = "â‚¬"+total.toFixed(2);
    }

    /* ================ SMART SUGGEST ================ */
    function initSmartSuggest(){
      const modal = $("smartSuggestModal");
      const open  = $("smartSuggestBtn");
      const close = $("closeSuggest");
      const cat   = $("category");
      const hint  = $("smartHint");

     open?.addEventListener("click", () => {
  modal.classList.add("active");
  modal.removeAttribute("hidden");
  modal.setAttribute("aria-hidden", "false");
});

close?.addEventListener("click", () => {
  modal.classList.remove("active");
  modal.setAttribute("aria-hidden", "true");
  modal.setAttribute("hidden", "");
});

modal?.addEventListener("click", (e) => {
  if (e.target === modal) {
    modal.classList.remove("active");
    modal.setAttribute("aria-hidden", "true");
    modal.setAttribute("hidden", "");
  }
});
      document.querySelectorAll(".suggest-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const val = btn.dataset.cat;
          if(cat) cat.value = val;
          modal.classList.remove("active");
          if(hint){
            hint.textContent = `âœ… Category set: ${val}`;
            hint.style.display = "block";
            hint.style.opacity = "1";
            setTimeout(()=> hint.style.opacity = "0", 1800);
            setTimeout(()=> hint.style.display = "none", 2200);
          }
        });
      });
    }

    /* ================ SAVE EXPENSE ================ */
    async function logEvent(uid, type, message){
      try{
        await addDoc(collection(db,"users",uid,"events"),{
          type, message, createdAt: serverTimestamp()
        });
      }catch(e){ console.warn("Event log failed:", e.message); }
    }

  

async function saveExpense(uid, editId = null) {
  const get = (id) => $(id)?.value || "";
  const idField = $("#expenseId");
  const id = (idField && idField.value) ? idField.value : await generateExpenseId(uid);
  const amt = parseFloat(get("amount")) || 0;
  const vat = parseFloat(get("vat")) || 0;
  const vatAmt = amt * vat / 100;
  const total = amt + vatAmt;

  const data = {
    expenseId: id,
    date: get("date"),
    description: get("description"),
    type: get("type"),
    category: get("category"),
    country: get("country"),
    amount: amt,
    vatPercent: vat,
    vatAmount: vatAmt,
    total: total,
    invoiceAttached: get("invoiceAttached"),
    paymentMethod: get("paymentMethod"),
    status: get("status"),
    notes: get("notes"),
    businessName: get("businessName"),
    email: get("email"),
    businessAddress: get("businessAddress"),
    updatedAt: serverTimestamp(),
  };

  if (editId) {
    // âœï¸ update existing
    await setDoc(doc(db, "users", uid, "expenses", editId), data, { merge: true });
  } else {
    // ğŸ†• create new
    await addDoc(collection(db, "users", uid, "expenses"), { ...data, createdAt: serverTimestamp() });
  }

  alert(`âœ… Expense ${editId ? "updated" : "saved"} successfully (${id})`);
}

  

    /* ================ INIT ================ */
    document.addEventListener("DOMContentLoaded", ()=>{
      ensureEls([
        "businessName","email","businessAddress",
        "expenseId","date","description","type","category","country",
        "amount","vat","invoiceAttached","paymentMethod","status","notes",
        "subtotalDisplay","vatDisplay","totalDisplay",
        "saveBtn","viewBtn","smartSuggestBtn","smartSuggestModal","closeSuggest","smartHint"
      ]);

      // live totals
      ["amount","vat"].forEach(id=>{
        $(id)?.addEventListener("input", renderTotals);
        $(id)?.addEventListener("change", renderTotals);
      });

      // default date today
      if($("date") && !$("date").value){
        $("date").value = new Date().toISOString().slice(0,10);
      }

      initSmartSuggest();
      renderTotals();
    });

    // === LOAD EXPENSE FOR EDIT ===
async function loadExpenseForEdit(uid) {
  const editId = localStorage.getItem("editExpenseId");
  if (!editId) return;

  try {
    const snap = await getDoc(doc(db, "users", uid, "expenses", editId));
    if (!snap.exists()) {
      console.warn("âš ï¸ Expense not found for edit:", editId);
      localStorage.removeItem("editExpenseId");
      return;
    }
    const e = snap.data();

    // ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ¿Ğ¾Ğ»Ñ
    const fields = [
      "expenseId","date","description","type","category","country",
      "amount","vat","invoiceAttached","paymentMethod","status","notes",
      "businessName","email","businessAddress"
    ];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el && e[id] !== undefined) el.value = e[id];
    });

    console.log(`âœ… Expense ${editId} loaded for editing`);
  } catch (err) {
    console.error("âŒ Error loading expense:", err);
  }
}


onAuthStateChanged(auth, async (user) => {
  // Ğ¯ĞºÑ‰Ğ¾ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡ Ğ½Ğµ ÑƒĞ²Ñ–Ğ¹ÑˆĞ¾Ğ² â€” Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾
  if (!user) {
    console.warn("â›” No user â€” redirecting to login...");
    location.href = "login.html";
    return;
  }

  console.log("âœ… User authenticated:", user.uid);

  // ĞĞ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾Ñ„Ñ–Ğ»Ñ
  try {
    await autofillFromProfile(user.uid);
  } catch (err) {
    console.warn("âš ï¸ Could not autofill profile:", err.message);
  }

  // Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚ÑƒÑ”Ğ¼Ğ¾, Ñ‰Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ²Ğ¶Ğµ Ğ² DOM
  const saveBtn = document.getElementById("saveBtn");
  const viewBtn = document.getElementById("viewBtn");

  if (!saveBtn || !viewBtn) {
    console.error("âŒ Buttons not found in DOM!");
    return;
  }

  // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾, Ñ‡Ğ¸ Ñ” ID Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
  const editId = localStorage.getItem("editExpenseId");

  if (editId) {
    console.log("âœï¸ Edit mode for expense:", editId);
    try {
      const ref = doc(db, "users", user.uid, "expenses", editId);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const exp = snap.data();

        // Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
        Object.entries(exp).forEach(([key, val]) => {
          const el = document.getElementById(key);
          if (el && typeof val !== "object") el.value = val;
        });

        renderTotals();

        // Ğ·Ğ¼Ñ–Ğ½ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
        saveBtn.textContent = "ğŸ’¾ Save Expense";

        saveBtn.addEventListener("click", async () => {
          try {
            await saveExpense(user.uid, editId);
            localStorage.removeItem("editExpenseId");
            alert("âœ… Expense updated successfully!");
            setTimeout(() => (location.href = "expense-csv-list.html"), 700);
          } catch (e) {
            console.error("âŒ Error updating:", e.message);
          }
        });
      } else {
        console.warn("âš ï¸ Expense not found, switching to New mode");
        localStorage.removeItem("editExpenseId");
      }
    } catch (err) {
      console.error("âŒ Load error:", err);
    }
  } else {
    // ĞĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ¸Ñ
    const idEl = document.getElementById("expenseId");
    if (idEl) idEl.value = await generateExpenseId(user.uid);

    saveBtn.addEventListener("click", async () => {
      try {
        await saveExpense(user.uid);
        alert("âœ… Expense saved!");
        setTimeout(() => (location.href = "expense-csv-list.html"), 700);
      } catch (e) {
        console.error("âŒ Save error:", e.message);
      }
    });
  }

  // ĞšĞ½Ğ¾Ğ¿ĞºĞ° View Saved
  viewBtn.addEventListener("click", () => {
    console.log("ğŸ“‚ Opening Saved Expenses");
    location.href = "expense-csv-list.html";
  });
});

    
  </script>
</body>
</html>
