<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk AI Assistant</title>
  <style>
    :root { --bg:#0e0e0e; --panel:#111; --muted:#bbb; --btn:#2a2a2a; --white:#fff; }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; background:#000; color:var(--white); font-family:system-ui, Arial, sans-serif; }
    .container { height:100dvh; display:flex; flex-direction:column; }
    .header { background:#1e1e1e; padding:14px 16px; font-weight:700; text-align:center; }
    .ctx { background:#111; border-top:1px solid #222; border-bottom:1px solid #222; }
    .ctx-head { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; flex-wrap:wrap; }
    .ctx-head strong { font-size:14px; }
    .ctx-head .actions { display:flex; gap:8px; }
    button { background:var(--btn); color:var(--white); border:0; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button:hover { opacity:.9; }
    .muted { color:var(--muted); font-size:12px; }
    pre { margin:0 14px 12px; padding:10px; background:#0d0d0d; border:1px solid #222; border-radius:8px;
          white-space:pre-wrap; max-height:220px; overflow:auto; }
    iframe { flex:1; border:0; width:100%; min-height:480px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">ü§ñ SmartWerk AI Assistant</div>

    <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É -->
    <div id="ctx-wrap" class="ctx" style="display:none">
      <div class="ctx-head">
        <div>
          <strong>SmartWerk: loaded latest calculation context</strong>
          <div class="muted">–¶–µ–π —Ç–µ–∫—Å—Ç –±—É–¥–µ –∫–æ—Ä–∏—Å–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç–∏ —è–∫ –ø–µ—Ä—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É —á–∞—Ç.</div>
        </div>
        <div class="actions">
          <button id="copyCtx">Copy</button>
          <button id="clearCtx">Clear</button>
        </div>
      </div>
      <pre id="ctx-text"></pre>
    </div>

    <!-- –í–∞—à —á–∞—Ç (Chatbase iFrame) -->
    <iframe
      id="chatFrame"
      src="https://www.chatbase.co/chatbot-iframe/uy7T8ni8hKnK8A2Hb3on1s"
      allow="clipboard-read; clipboard-write">
    </iframe>
  </div>

  <script>
    // 1) –ó—á–∏—Ç—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç, —è–∫–∏–π –ø–æ–∫–ª–∞–ª–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    const ctxRaw = localStorage.getItem('smartwerk_chat_context');
    let ctx = null;
    try { ctx = ctxRaw ? JSON.parse(ctxRaw) : null; } catch { ctx = null; }

    // 2) –ì–æ—Ç—É—î–º–æ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∫–∞–∑—É/–∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è
    function makeSummaryText(c) {
      // –Ø–∫—â–æ —É payload –≤–∂–µ —î –≥–æ—Ç–æ–≤–∏–π —Ç–µ–∫—Å—Ç ‚Äî –≤—ñ–¥–¥–∞—î–º–æ –π–æ–≥–æ
      if (c && c.textSummary) return c.textSummary.trim();

      // –Ü–Ω–∞–∫—à–µ —Ä–æ–±–∏–º–æ –ø—Ä–æ—Å—Ç–µ —Ä–µ–∑—é–º–µ –∑ –∫–ª—é—á–æ–≤–∏—Ö –ø–æ–ª—ñ–≤ (–ø—ñ–¥–ª–∞—à—Ç–æ–≤—É–π –∑–∞ –ø–æ—Ç—Ä–µ–±–∏)
      if (!c) return '';
      const L = [];
      if (c.header) L.push(c.header);
      if (c.user) L.push(`User: ${c.user}`);
      if (c.companyName) L.push(`Company: ${c.companyName}`);
      if (c.period) L.push(`Period: ${c.period}`);
      if (c.hoursWorked!=null && c.hourlyRate!=null && c.income!=null)
        L.push(`Hours: ${c.hoursWorked}, Rate: ‚Ç¨${c.hourlyRate}, Income: ‚Ç¨${c.income}`);
      if (c.totals) {
        const t = c.totals;
        L.push(
          `Gross: ‚Ç¨${t.grossIncome}, Expenses: ‚Ç¨${t.totalExpenses}, ` +
          `Taxable: ‚Ç¨${t.taxableProfit}, ZZP: ‚Ç¨${t.zzpDeductions}, ` +
          `MKB: ‚Ç¨${t.mkbVrijstelling}, Final Taxable: ‚Ç¨${t.finalTaxable}, ` +
          `Income Tax: ‚Ç¨${t.incomeTax}, ZVW: ‚Ç¨${t.zvwAmount}, BTW: ‚Ç¨${t.btwAmount}, ` +
          `Total Tax: ‚Ç¨${t.totalTax}`
        );
      }
      if (c.notes) L.push(`Notes: ${c.notes}`);
      return L.join('\n');
    }

    // 3) –ü–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å —ñ–∑ —Ä–µ–∑—é–º–µ (–∞–±–æ —Ö–æ–≤–∞—î–º–æ, —è–∫—â–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –Ω–µ–º–∞—î)
    const wrap = document.getElementById('ctx-wrap');
    const pre  = document.getElementById('ctx-text');
    if (ctx) {
      pre.textContent = makeSummaryText(ctx);
      wrap.style.display = 'block';
    } else {
      wrap.style.display = 'none';
    }

    // 4) Copy
    document.getElementById('copyCtx').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(pre.textContent || '');
        alert('Summary copied ‚Äî paste it into the chat as first message.');
      } catch {
        alert('Could not copy. Select text and copy manually.');
      }
    });

    // 5) Clear
    document.getElementById('clearCtx').addEventListener('click', () => {
      localStorage.removeItem('smartwerk_chat_context');
      wrap.style.display = 'none';
      pre.textContent = '';
      alert('Context cleared.');
    });

    // 6) (–û–ø—Ü—ñ–π–Ω–æ) –ø–µ—Ä–µ–¥–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —É iFrame —á–µ—Ä–µ–∑ URL ‚Äî —è–∫—â–æ –≤–∞—à –±–æ—Ç —É–º—ñ—î —Ü–µ —á–∏—Ç–∞—Ç–∏
    try {
      if (ctx) {
        const frame = document.getElementById('chatFrame');
        const u = new URL(frame.src);
        // –ú–æ–∂–µ—à –∑–º—ñ–Ω–∏—Ç–∏ 'context' –Ω–∞ —Ç–µ, —â–æ —á–∏—Ç–∞—î —Ç–≤—ñ–π –±–µ–∫–µ–Ω–¥
        const payload = encodeURIComponent(JSON.stringify(ctx));
        u.searchParams.set('context', payload);
        // –ê–±–æ —É hash: u.hash = 'context=' + payload;
        frame.src = u.toString();
      }
    } catch { /* –±–µ–∑–ø–µ—á–Ω–æ —ñ–≥–Ω–æ—Ä—É—î–º–æ */ }
  </script>
</body>
</html>
