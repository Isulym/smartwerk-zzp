<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk AI Assistant</title>
  <style>
    :root { --bg:#0e0e0e; --panel:#111; --muted:#bbb; --btn:#2a2a2a; --white:#fff; }
    * { box-sizing: border-box; }
    html,body{height:100%;margin:0;background:#000;color:var(--white);font-family:system-ui,Arial,sans-serif;}
    .container{height:100vh;display:flex;flex-direction:column;}
    .header{background:#1e1e1e;padding:12px 16px;font-weight:700;text-align:center;}
    .ctx{background:#111;border-top:1px solid #222;border-bottom:1px solid #222;}
    .ctx-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 14px;flex-wrap:wrap;}
    .ctx-head strong{font-size:14px}
    .ctx-head .actions{display:flex;gap:8px;}
    button{background:var(--btn);color:var(--white);border:0;border-radius:8px;padding:8px 12px;cursor:pointer;}
    button:hover{opacity:.9;}
    pre{margin:12px;padding:10px;background:#0d0d0d;border:1px solid #222;border-radius:8px;white-space:pre-wrap;max-height:220px;overflow:auto;}
    .chatWrap{flex:1;position:relative}
    .chatWrap .cb-container{position:absolute;inset:0}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">üß† SmartWerk AI Assistant</div>

    <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É -->
    <div id="ctx-wrap" class="ctx" style="display:none">
      <div class="ctx-head">
        <strong>SmartWerk: loaded latest calculation context</strong>
        <div class="actions">
          <button id="copyCtx">Copy</button>
          <button id="clearCtx">Clear</button>
        </div>
      </div>
      <pre id="ctx-text"></pre>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—ñ–¥ —á–∞—Ç -->
    <div class="chatWrap">
      <div id="chatbase-container" class="cb-container"></div>
    </div>
  </div>

  <script>
    // 1) —á–∏—Ç–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    let ctx = null;
    try {
      const raw = localStorage.getItem('smartwerk_chat_context');
      ctx = raw ? JSON.parse(raw) : null;
    } catch (_) { ctx = null; }

    // 2) —Ä–æ–±–∏–º–æ –∫–æ—Ä–æ—Ç–∫–µ —Ä–µ–∑—é–º–µ
    function makeSummaryText(c){
      if (!c) return '';
      if (c.textSummary) return c.textSummary.trim();
      const R = c.results || {};
      const ‚Ç¨ = n => Number(n||0).toFixed(2);
      return [
        (c.period ? `Period: ${c.period}` : ''),
        (c.hoursWorked || c.hourlyRate || c.income)
          ? `Hours: ${c.hoursWorked || 0}, Rate: ‚Ç¨${c.hourlyRate || 0}, Income: ‚Ç¨${‚Ç¨(c.income)}`
          : '',
        (R.grossIncome||R.totalExpenses||R.taxableProfit||R.zzpDeductions||R.mkbVrijstelling||R.finalTaxable||R.incomeTax||R.zvwAmount||R.btwAmount||R.totalTax)
          ? `Gross: ‚Ç¨${‚Ç¨(R.grossIncome)}, Expenses: ‚Ç¨${‚Ç¨(R.totalExpenses)}, Taxable: ‚Ç¨${‚Ç¨(R.taxableProfit)}, ` +
            `ZZP: ‚Ç¨${‚Ç¨(R.zzpDeductions)}, MKB: ‚Ç¨${‚Ç¨(R.mkbVrijstelling)}, Final Taxable: ‚Ç¨${‚Ç¨(R.finalTaxable)}, ` +
            `Income Tax: ‚Ç¨${‚Ç¨(R.incomeTax)}, ZVW: ‚Ç¨${‚Ç¨(R.zvwAmount)}, BTW: ‚Ç¨${‚Ç¨(R.btwAmount)}, Total Tax: ‚Ç¨${‚Ç¨(R.totalTax)}`
          : ''
      ].filter(Boolean).join('\n');
    }

    // 3) –ø–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å
    (function showPanel(){
      const wrap = document.getElementById('ctx-wrap');
      const pre  = document.getElementById('ctx-text');
      if (ctx){
        pre.textContent = makeSummaryText(ctx);
        wrap.style.display = 'block';
      } else {
        wrap.style.display = 'none';
      }
    })();

    // 4) –∫–Ω–æ–ø–∫–∏ Copy / Clear
    document.getElementById('copyCtx')?.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(document.getElementById('ctx-text').textContent || '');
        alert('Summary copied ‚Äî paste it into the chat as first message.');
      } catch { alert('Could not copy. Select text and copy manually.'); }
    });
    document.getElementById('clearCtx')?.addEventListener('click', () => {
      localStorage.removeItem('smartwerk_chat_context');
      document.getElementById('ctx-wrap').style.display = 'none';
      document.getElementById('ctx-text').textContent = '';
      alert('Context cleared.');
    });

    // 5) –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–£–Ñ–ú–û CHATBASE (–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π —Å–∫—Ä–∏–ø—Ç)
    //    –í–ê–ñ–õ–ò–í–û: –ù–Ü–Ø–ö–ò–• ifr–∞me-URL —Ç–∏–ø—É /chatbot-iframe/... ‚Äî —Å–∞–º–µ embed.min.js, —ñ–Ω–∞–∫—à–µ 404.
    window.embeddedChatbotConfig = {
      chatbotId: "uy7T8ni8hKnK8A2Hb3on1s",
      domain: "www.chatbase.co",
      // –æ–ø—Ü—ñ–π–Ω–æ –º–æ–∂–Ω–∞ –∑–∞–¥–∞—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
      // container: document.getElementById('chatbase-container')
    };
  </script>
  <script src="https://www.chatbase.co/embed.min.js"
          chatbotId="uy7T8ni8hKnK8A2Hb3on1s"
          domain="www.chatbase.co"
          defer></script>
</body>
</html>
