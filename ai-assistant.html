<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SmartWerk AI Assistant</title>
  <style>
    :root{--bg:#0e0e0e;--panel:#111;--muted:#bbb;--btn:#2a2a2a;--white:#fff}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--white);
      font-family:system-ui,Arial,sans-serif}
    .container{height:100vh;display:flex;flex-direction:column}
    .header{background:#1e1e1e;padding:14px 16px;font-weight:700;text-align:center}
    .ctx{background:#111;border-top:1px solid #222;border-bottom:1px solid #222}
    .ctx-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 14px;flex-wrap:wrap}
    .ctx-head strong{font-size:14px}
    .actions{display:flex;gap:8px}
    button{background:var(--btn);color:var(--white);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    button:hover{opacity:.9}
    .muted{color:var(--muted);font-size:12px}
    pre{margin:10px 12px;padding:10px;background:#0d0d0d;border:1px solid #222;border-radius:8px;white-space:pre-wrap;max-height:220px;overflow:auto}
    iframe{flex:1;border:0;width:100%;min-height:480px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">üß† SmartWerk AI Assistant</div>

    <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É -->
    <div id="ctx-wrap" class="ctx" style="display:none">
      <div class="ctx-head">
        <div>
          <strong>SmartWerk: loaded latest calculation context</strong>
          <div class="muted">–¶–µ–π —Ç–µ–∫—Å—Ç –±—É–¥–µ –∫–æ—Ä–∏—Å–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç–∏ —è–∫ –ø–µ—Ä—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É —á–∞—Ç.</div>
        </div>
        <div class="actions">
          <button id="copyCtx">Copy</button>
          <button id="clearCtx">Clear</button>
        </div>
      </div>
      <pre id="ctx-text"></pre>
    </div>

    <!-- –í–ª–∞—Å–Ω–µ —á–∞—Ç (Chatbase iFrame) -->
    <iframe
      id="chatFrame"
      src="https://www.chatbase.co/chatbot-iframe/uy7T8ni8hKnK8A2Hb3on1s?embedded=true"
      allow="clipboard-read; clipboard-write">
    </iframe>
  </div>

  <script>
    // 1) –ó—á–∏—Ç—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç, —è–∫–∏–π –ø–æ–∫–ª–∞–ª–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    const raw = localStorage.getItem('smartwerk_chat_context');
    let ctx = null;
    try { ctx = raw ? JSON.parse(raw) : null; } catch { ctx = null; }

    // 2) –§–æ—Ä–º—É—î–º–æ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç
    function euro(n){ return Number(n || 0).toFixed(2); }

    function makeSummaryText(c){
      if (!c) return '';
      const r = c.results || {};
      const L = [];
      if (c.companyName) L.push(`Company: ${c.companyName}`);
      if (c.period)      L.push(`Period: ${c.period}`);
      L.push(
        `Gross: ‚Ç¨${euro(r.grossIncome)}, Expenses: ‚Ç¨${euro(r.totalExpenses)}, ` +
        `Taxable: ‚Ç¨${euro(r.taxableProfit)}, ZZP: ‚Ç¨${euro(r.zzpDeductions)}, MKB: ‚Ç¨${euro(r.mkbVrijstelling)}, ` +
        `Final Taxable: ‚Ç¨${euro(r.finalTaxable)}, Income Tax: ‚Ç¨${euro(r.incomeTax)}, ` +
        `ZVW: ‚Ç¨${euro(r.zvwAmount)}, BTW: ‚Ç¨${euro(r.btwAmount)}, Total Tax: ‚Ç¨${euro(r.totalTax)}`
      );
      if (c.reportingNotes) L.push(`Notes: ${c.reportingNotes}`);
      return L.join('\n');
    }

    // 3) –ü–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å, —è–∫—â–æ —î –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const wrap = document.getElementById('ctx-wrap');
    const pre  = document.getElementById('ctx-text');
    if (ctx){
      pre.textContent = makeSummaryText(ctx);
      wrap.style.display = 'block';
    } else {
      wrap.style.display = 'none';
    }

    // 4) Copy / Clear
    document.getElementById('copyCtx').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(pre.textContent || '');
        alert('Summary copied ‚Äî paste it into the chat as first message.');
      } catch {
        alert('Could not copy. Select text and copy manually.');
      }
    });

    document.getElementById('clearCtx').addEventListener('click', () => {
      localStorage.removeItem('smartwerk_chat_context');
      pre.textContent = '';
      wrap.style.display = 'none';
      alert('Context cleared.');
    });

    // 5) (–æ–ø—Ü—ñ–π–Ω–æ) –ø–µ—Ä–µ–¥–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —É iFrame —á–µ—Ä–µ–∑ hash ?context=
    try {
      if (ctx){
        const frame = document.getElementById('chatFrame');
        const u = new URL(frame.src);
        u.searchParams.set('context', encodeURIComponent(JSON.stringify(ctx)));
        frame.src = u.toString();
      }
    } catch {/* ignore */}
  </script>
</body>
</html>
