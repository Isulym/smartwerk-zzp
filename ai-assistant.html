<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk AI Assistant</title>
  <style>
    :root{ --bg:#0e0e0e; --panel:#111; --muted:#bbb; --btn:#2a2a2a; --white:#fff; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:#000; color:var(--white); font-family:system-ui, Arial, sans-serif; }
    .container{ height:100vh; display:flex; flex-direction:column; }
    .header{ background:#1e1e1e; padding:14px 16px; font-weight:700; text-align:center; }
    .ctx{ background:#111; border-top:1px solid #222; border-bottom:1px solid #222; }
    .ctx-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; flex-wrap:wrap; }
    .ctx-head strong{ font-size:14px; }
    .ctx-head .actions{ display:flex; gap:8px; }
    button{ background:var(--btn); color:var(--white); border:0; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button:hover{ opacity:.9; }
    .muted{ color:var(--muted); font-size:12px; }
    pre{ margin: 10px 12px; padding:10px; background:#0d0d0d; border:1px solid #222; border-radius:8px; white-space:pre-wrap; max-height:240px; overflow:auto; }
    .chat-embed{ flex:1; border:0; width:100%; min-height:480px; }
    .pad{ padding: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">üß† SmartWerk AI Assistant</div>

    <!-- Context panel -->
    <div id="ctx-wrap" class="ctx" style="display:none">
      <div class="ctx-head">
        <div>
          <strong>SmartWerk: loaded latest calculation context</strong>
          <div class="muted">–¶–µ–π —Ç–µ–∫—Å—Ç –±—É–¥–µ –∫–æ—Ä–∏—Å–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç–∏ —è–∫ –ø–µ—Ä—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É —á–∞—Ç.</div>
        </div>
        <div class="actions">
          <button id="copyCtx">Copy</button>
          <button id="clearCtx">Clear</button>
        </div>
      </div>
      <pre id="ctx-text"></pre>
    </div>

    <!-- Chatbase widget will appear below -->
    <div class="pad">
      <div id="chatbase-container"></div>
    </div>
  </div>

  <script>
    // 1) –ß–∏—Ç–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —ñ–∑ localStorage
    const raw = localStorage.getItem('smartwerk_chat_context');
    let ctx = null;
    try { ctx = raw ? JSON.parse(raw) : null; } catch(_) { ctx = null; }

    // 2) –ì–æ—Ç—É—î–º–æ —Ç–µ–∫—Å—Ç-—Ä–µ–∑—é–º–µ –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è/–≤—Å—Ç–∞–≤–∫–∏
    function makeSummaryText(c){
      if (!c) return '';
      if (c.textSummary && c.textSummary.trim()) return c.textSummary.trim();
      const L = [];
      if (c.companyName) L.push(`Company: ${c.companyName}`);
      if (c.period)      L.push(`Period: ${c.period}`);
      if (c.hoursWorked || c.hourlyRate || c.income) {
        L.push(`Hours: ${c.hoursWorked || '-'}, Rate: ‚Ç¨${c.hourlyRate || '-'}, Income: ‚Ç¨${c.income || '-'}`);
      }
      if (c.totals){
        const t = c.totals;
        L.push(
          `Gross: ‚Ç¨${t.grossIncome}, Expenses: ‚Ç¨${t.totalExpenses}, Taxable: ‚Ç¨${t.taxableProfit}, ` +
          `ZZP: ‚Ç¨${t.zzpDeductions}, MKB: ‚Ç¨${t.mkbVrijstelling}, Final: ‚Ç¨${t.finalTaxable}, ` +
          `IncomeTax: ‚Ç¨${t.incomeTax}, ZVW: ‚Ç¨${t.zvwAmount}, BTW: ‚Ç¨${t.btwAmount}, TotalTax: ‚Ç¨${t.totalTax}`
        );
      }
      if (c.reportingNotes) L.push(`Notes: ${c.reportingNotes}`);
      return L.join('\n');
    }

    // 3) –ü–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å (–∞–±–æ —Ö–æ–≤–∞—î–º–æ, —è–∫—â–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –Ω–µ–º–∞—î)
    (function showCtx(){
      const wrap = document.getElementById('ctx-wrap');
      const pre  = document.getElementById('ctx-text');
      if (ctx){
        pre.textContent = makeSummaryText(ctx);
        wrap.style.display = 'block';
      } else {
        wrap.style.display = 'none';
      }
    })();

    // 4) Copy
    document.getElementById('copyCtx').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(document.getElementById('ctx-text').textContent || '');
        alert('Summary copied ‚Äî paste it into the chat as the first message.');
      } catch {
        alert('Could not copy. Select text and copy manually.');
      }
    });

    // 5) Clear
    document.getElementById('clearCtx').addEventListener('click', () => {
      localStorage.removeItem('smartwerk_chat_context');
      document.getElementById('ctx-wrap').style.display = 'none';
      document.getElementById('ctx-text').textContent = '';
      alert('Context cleared.');
    });
  </script>

  <!-- 6) –û—Ñ—ñ—Ü—ñ–π–Ω–∏–π Chatbase embed (—Å—Ç–∞–±—ñ–ª—å–Ω–∏–π, –±–µ–∑ 404) -->
  <script>
    window.embeddedChatbotConfig = {
      chatbotId: "uy7T8ni8hKnK8A2Hb3on1s",   // —Ç–≤—ñ–π ID
      domain: "www.chatbase.co",
      // (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ) container ‚Äî —â–æ–± —Ä–µ–Ω–¥–µ—Ä–∏—Ç–∏ –≤ –Ω–∞—à <div id="chatbase-container">
      container: document.getElementById('chatbase-container')
    };
  </script>
  <script src="https://www.chatbase.co/embed.min.js"
          chatbotId="uy7T8ni8hKnK8A2Hb3on1s"
          domain="www.chatbase.co"
          defer></script>
</body>
</html>
