<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“§ Email to Gemeente â€” SmartWerk</title>
  <link rel="stylesheet" href="style-email.css"/>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="topbar">
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="templates.html" class="btn">â† Templates</a>
    </nav>
  </div>

  <main class="email-form">
    <h1>ğŸ“¬ Email to Gemeente</h1>

    <section>
      <label>ğŸ“ City:</label>
      <input id="city" placeholder="City name"/>
    </section>

    <section>
      <label>ğŸ“… Date:</label>
      <input id="todayDate" type="date"/>
    </section>

    <section>
      <label>ğŸ“¨ To Gemeente:</label>
      <input id="toGemeente" placeholder="Gemeente Name"/>
      <input id="toEmail" placeholder="info@gemeente.nl"/>
    </section>

    <section>
      <label>ğŸ“¤ Subject:</label>
      <input id="subject" placeholder="Subject..."/>
    </section>

    <section>
      <label>ğŸ“ Message:</label>
      <textarea id="messageBody" rows="8" placeholder="Write your message..."></textarea>
    </section>

    <section>
      <label>ğŸ‘¤ Your Details:</label>
      <input id="businessName" placeholder="Full Name / Business Name"/>
      <input id="email" placeholder="Your Email"/>
      <input id="businessAddress" placeholder="Business Address"/>
    </section>

    <section>
      <label>âœï¸ Signature:</label>
      <textarea id="signature" rows="3" placeholder="Kind regards,"></textarea>
    </section>

    <section class="actions">
      <button id="aiFillBtn" class="btn small">ğŸ¤– AI Fill</button>
      <button id="translateBtn" class="btn small">ğŸŒ Translate</button>
      <button id="loadExampleBtn" class="btn small">ğŸ“‚ Load Example</button>
    </section>

    <section class="buttons">
      <button id="sendEmailBtn" class="btn-primary">ğŸ“¤ Send Email</button>
      <button id="saveEmailBtn" class="btn">ğŸ’¾ Save</button>
      <button id="viewSavedBtn" class="btn">ğŸ“‚ View Saved</button>
      <button id="exportPDFBtn" class="btn">ğŸ“„ Export PDF</button>
    </section>

    <label class="pro-toggle">
      <input type="checkbox" id="proPdfCheckbox"/> Export without branding (PRO)
    </label>
  </main>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);
    const $ = (id) => document.getElementById(id);

    async function readProfile(uid){
      try{
        const r1 = await getDoc(doc(db,"users",uid,"settings","profile"));
        if(r1.exists()) return r1.data();
      }catch{}
      try{
        const r2 = await getDoc(doc(db,"users",uid));
        if(r2.exists()) return r2.data();
      }catch{}
      return {};
    }

    async function autofillFromProfile(uid){
      const p = await readProfile(uid);
      if(!p) return;
      if($("businessName")) $("businessName").value = p.businessName || "";
      if($("email")) $("email").value = p.email || "";
      if($("businessAddress")) $("businessAddress").value = p.businessAddress || "";
      console.log("âœ… Auto-filled from profile");
    }

    async function logActivity(uid, message){
      await addDoc(collection(db,"users",uid,"events"),{
        type:"Email Sent", message, createdAt:serverTimestamp()
      });
    }

    onAuthStateChanged(auth, async(user)=>{
      if(!user) return;
      await autofillFromProfile(user.uid);

      $("todayDate").value = new Date().toISOString().split("T")[0];

      $("aiFillBtn").addEventListener("click",()=>{
        $("toGemeente").value = "Gemeente Amsterdam";
        $("toEmail").value = "info@amsterdam.nl";
        $("subject").value = "Urgent Housing Request";
        $("messageBody").value = "Dear Gemeente,\n\nI kindly request your assistance regarding urgent housing availability.\n\nKind regards,\n" + $("businessName").value;
      });

      $("loadExampleBtn").addEventListener("click",()=>{
        $("subject").value = "Energy Subsidy Request";
        $("messageBody").value = "Dear Gemeente,\n\nI would like to request information regarding the energy subsidy program.\n\nSincerely,\n" + $("businessName").value;
      });

      $("translateBtn").addEventListener("click",()=>{
        const msg = $("messageBody").value;
        if(msg.startsWith("Dear")) $("messageBody").value = msg.replace("Dear","Beste").replace("Kind regards","Met vriendelijke groet");
        else $("messageBody").value = msg.replace("Beste","Dear").replace("Met vriendelijke groet","Kind regards");
      });

      $("saveEmailBtn").addEventListener("click",async()=>{
        await addDoc(collection(db,"users",user.uid,"emails"),{
          toGemeente:$("toGemeente").value,
          toEmail:$("toEmail").value,
          subject:$("subject").value,
          message:$("messageBody").value,
          date:new Date().toISOString(),
          city:$("city").value,
          fromEmail:$("email").value,
          fromName:$("businessName").value,
          createdAt:serverTimestamp()
        });
        alert("âœ… Email saved!");
      });

      $("sendEmailBtn").addEventListener("click",async()=>{
        const sendEmail = httpsCallable(functions,"sendGemeenteEmail");
        try{
          const res = await sendEmail({
            fromEmail:$("email").value,
            toEmail:$("toEmail").value,
            subject:$("subject").value,
            message:$("messageBody").value + "\n\n" + $("signature").value
          });
          if(res.data.success){
            alert("âœ… Email sent successfully!");
            await logActivity(user.uid, `Email sent to ${$("toGemeente").value}`);
          }else alert("âš ï¸ Sending failed.");
        }catch(e){
          alert("âŒ Error: " + e.message);
        }
      });

      $("exportPDFBtn").addEventListener("click",()=>{
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y=20;
        doc.setFontSize(18).text("Email to Gemeente",14,y); y+=10;
        const add=(title,val)=>{ doc.setFontSize(13).text(title,14,y); y+=6; doc.setFontSize(11); const lines=doc.splitTextToSize(val,180); doc.text(lines,14,y); y+=lines.length*6+4; };
        add("From",`${$("businessName").value}\n${$("email").value}\n${$("businessAddress").value}`);
        add("To",`${$("toGemeente").value}\n${$("toEmail").value}`);
        add("Subject",$("subject").value);
        add("Message",$("messageBody").value);
        add("Signature",$("signature").value);
        add("Date",$("todayDate").value+" â€” "+$("city").value);
        if(!$("proPdfCheckbox").checked){
          doc.setFontSize(10).setTextColor(150);
          doc.text("Generated with SmartWerk â€” smartwerk.nl",14,290);
        }
        doc.save("SmartWerk-Email.pdf");
      });
    });
  </script>
</body>
</html>
