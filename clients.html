<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="add_client_title">ğŸ‘¥ SmartWerk â€” Add Client</title>
  <link rel="stylesheet" href="style-clients.css" />
</head>
<body>
  <header>
    <h1 data-i18n="add_client_title">ğŸ‘¥ SmartWerk â€” Add Client</h1>
    <div class="header-actions">
      <a href="dashboard.html" class="btn" type="button" data-i18n="back_dashboard">ğŸ  Back to Dashboard</a>
      <a href="clients-list.html" class="btn" type="button" id="viewBtnTop" data-i18n="saved_clients">ğŸ“‚ Saved Clients</a>
    </div>
  </header>

  <main>
   <!-- CLIENT INFO -->
<section>
  <h2 data-i18n="client_info">ğŸ¢ Client Information</h2>

  <div class="grid-2">
        <div>
          <label for="clientId" data-i18n="client_id">Client ID</label>
          <input id="clientId" placeholder="CL-2025-001" readonly autocomplete="off" />
        </div>
        <div>
          <label for="status" data-i18n="status">Status</label>
          <select id="status" autocomplete="off">
            <option data-i18n="status_active">Active</option>
            <option data-i18n="status_prospect">Prospect</option>
            <option data-i18n="status_inactive">Inactive</option>
          </select>
        </div>
      </div>

  <div class="grid-2">
        <div>
          <label for="clientName" data-i18n="company_name">Company / Full Name</label>
          <input id="clientName" placeholder="Company or Full Name" autocomplete="organization" />
        </div>
        <div>
          <label for="contactPerson" data-i18n="contact_person">Contact Person</label>
          <input id="contactPerson" placeholder="e.g. John de Vries" autocomplete="name" />
        </div>
      </div>

  <div class="grid-2">
        <div>
          <label for="email" data-i18n="email">Email</label>
          <input id="email" type="email" placeholder="client@example.com" autocomplete="email" />
        </div>
        <div>
          <label for="phone" data-i18n="phone">Phone</label>
          <input id="phone" type="tel" placeholder="+31 6 12345678" autocomplete="tel" />
        </div>
      </div>

      <div>
        <label for="address" data-i18n="address">Address</label>
        <input id="address" placeholder="Street, City, ZIP" autocomplete="street-address" />
      </div>

  <div class="grid-2">
        <div>
          <label for="country" data-i18n="country">Country</label>
          <select id="country" autocomplete="country-name">
            <option value="" data-i18n="select_country">Select Country</option>
            <option data-i18n="netherlands">Netherlands</option>
            <option data-i18n="belgium">Belgium</option>
            <option data-i18n="Germany">Germany</option>
            <option data-i18n="spain">Spain</option>
            <option data-i18n="poland">Poland</option>
            <option data-i18n="france">France</option>
            <option data-i18n="uk">UK</option>
          </select>
        </div>
        <div>
          <label for="paymentTerm" data-i18n="payment_term">Payment Term</label>
          <select id="paymentTerm" autocomplete="off">
            <option data-i18n="term_14">14 days</option>
            <option selected data-i18n="term_30">30 days</option>
            <option data-i18n="term_60">60 days</option>
            <option data-i18n="term_receipt">On Receipt</option>
          </select>
        </div>
      </div>
    </section>

<!-- COMPANY DATA -->
<section>
      <h2 data-i18n="company_data">ğŸ’¼ Company Data</h2>

      <div class="grid-2">
        <div>
          <label for="kvk" data-i18n="kvk">KvK Number</label>
          <input id="kvk" placeholder="e.g. 12345678" autocomplete="off" />
        </div>
        <div>
          <label for="vatNumber" data-i18n="vat">VAT Number</label>
          <input id="vatNumber" placeholder="e.g. NL001234567B01" autocomplete="off" />
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="tags" data-i18n="tags">Tags</label>
          <input id="tags" placeholder="VIP, Long-term, etc." autocomplete="off" />
        </div>
        <div>
          <label for="currency" data-i18n="currency">Default Currency</label>
          <select id="currency" autocomplete="off">
            <option selected>EUR</option>
            <option>USD</option>
            <option>GBP</option>
            <option>PLN</option>
          </select>
        </div>
      </div>

      <div>
        <label for="notes" data-i18n="notes">Notes</label>
        <textarea id="notes" rows="3" placeholder="Additional comments or notes" autocomplete="off"></textarea>
      </div>
    </section>

    <div class="actions">
      <button id="saveBtn" class="btn" type="button" data-i18n="save_client">ğŸ’¾ Save Client</button>
      <button id="viewBtn" class="btn" type="button" data-i18n="saved_clients">ğŸ“‚ Saved Clients</button>
      <button id="smartSuggestBtn" class="btn" type="button" data-i18n="smart_suggest">ğŸ¤– Smart Suggest</button>
    </div>

<div id="smartHint" class="hint" role="status" aria-live="polite"></div>
  </main>

  <footer><p>Â© 2025 SmartWerk</p></footer>
<script src="lang.js"></script>
  <!-- APP -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, getDoc, runTransaction, serverTimestamp, setLogLevel } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      setLogLevel("error");


    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ---------- Helpers ---------- */
    const $   = (id)=>document.getElementById(id);
    const val = (id)=>$(id)?.value?.trim() || "";

    function logBind() {
      console.log("ğŸ”— Bind buttons:", {
        save: !!$("saveBtn"),
        view: !!$("viewBtn"),
        smart: !!$("smartSuggestBtn"),
        viewTop: !!$("viewBtnTop"),
        hint: !!$("smartHint"),
      });
    }

    /* ---------- Client ID generator ---------- */
    async function generateClientId(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastClientNumber||0) : 0;
        const next = last + 1;
        tx.set(ref,{ lastClientNumber: next },{ merge:true });
        out = `CL-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    /* ---------- Smart Suggest ---------- */
    function smartSuggest() {
      const hint = $("smartHint");
      if(!hint){ console.warn("âš ï¸ #smartHint missing"); return; }

      const email = val("email").toLowerCase();
      let messages = [];

      if (email.includes("@")) {
        const domain = email.split("@")[1] || "";
        const ends = (t) => domain.endsWith(t);

        const countryMap = {
          ".nl": "Netherlands", ".be": "Belgium", ".de": "Germany",
          ".fr": "France", ".es": "Spain", ".pl": "Poland",
          ".uk": "United Kingdom", ".co.uk": "United Kingdom"
        };
        for (const [suffix, country] of Object.entries(countryMap)) {
          if (ends(suffix) && $("country")) $("country").value = country;
        }

        const isFree = /(gmail|yahoo|outlook|hotmail|icloud)\./.test(domain);
        if (isFree) {
          if ($("status")) $("status").value = "Prospect";
          if ($("tags") && !val("tags")) $("tags").value = "Prospect";
          messages.push("Freemail detected â†’ Status: Prospect");
        } else {
          if ($("tags") && !val("tags")) $("tags").value = domain.split(".")[0];
          messages.push("Tags suggested from domain");
        }

        if (!val("phone") && $("phone")) {
          const prefixMap = {
            ".nl": "+31", ".be": "+32", ".de": "+49", ".fr": "+33",
            ".es": "+34", ".pl": "+48", ".uk": "+44", ".co.uk": "+44"
          };
          for (const [s, code] of Object.entries(prefixMap)) {
            if (ends(s)) $("phone").value = code + " ";
          }
        }
      } else {
        const lang = localStorage.getItem("language") || "en";
        const t = window.translations?.[lang] || {};
        messages.push(t.enter_email_suggestion || "Enter an email for better suggestions");
      }

      hint.textContent = "âœ… " + messages.join(" Â· ");
      hint.style.display = "block";
      hint.style.opacity = "1";
      setTimeout(()=>hint.style.opacity="0", 2000);
      setTimeout(()=>hint.style.display="none", 2500);
    }

    /* ---------- Validation ---------- */
    function validate() {
      if (!val("clientName")) { alert("â— Client Name is required."); return false; }
      const email = val("email");
      const phone = val("phone");
      if (email && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { alert("â— Invalid email address."); return false; }
      if (phone && !/^[0-9+\s\-()]{6,20}$/.test(phone)) { alert("â— Invalid phone number."); return false; }
      return true;
    }

    /* ---------- Save Client (create/update) ---------- */
    async function saveClient(uid, editId=null){
      if(!validate()) return;

      let id = val("clientId");
      if(!id){
        id = await generateClientId(uid);
        if($("clientId")) $("clientId").value = id;
      }

      const data = {
        clientId: id,
        clientName: val("clientName"),
        contactPerson: val("contactPerson"),
        email: val("email"),
        phone: val("phone"),
        address: val("address"),
        country: $("country")?.value || "",
        kvk: val("kvk"),
        vatNumber: val("vatNumber"),
        paymentTerm: $("paymentTerm")?.value || "30 days",
        status: $("status")?.value || "Active",
        currency: $("currency")?.value || "EUR",
        tags: val("tags") ? val("tags").split(",").map(t=>t.trim()).filter(Boolean) : [],
        notes: val("notes"),
        updatedAt: serverTimestamp(),
      };

      if(editId){
        await updateDoc(doc(db,"users",uid,"clients",editId), data);
        alert("âœ… Client updated successfully!");
      }else{
        await addDoc(collection(db,"users",uid,"clients"), { ...data, createdAt: serverTimestamp() });
        alert("âœ… Client saved successfully!");
      }

      // Ñ€ĞµĞ´Ñ–Ñ€ĞµĞºÑ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº
      location.href = "clients-list.html";
    }

    /* ---------- DOM Ready: bind buttons ---------- */
    document.addEventListener("DOMContentLoaded", () => {
      // Bind
      $("smartSuggestBtn")?.addEventListener("click", smartSuggest);
      $("email")?.addEventListener("blur", smartSuggest);
      $("viewBtn")?.addEventListener("click", ()=> location.href="clients-list.html");
      $("viewBtnTop")?.addEventListener("click", (e)=>{ e.preventDefault(); location.href="clients-list.html"; });

      // Save â€” Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ–Ğ·Ğ½Ñ–ÑˆĞµ Ğ· uid
      $("saveBtn")?.addEventListener("click", async ()=>{
        const u = auth.currentUser;
        if(!u){ alert("Please log in to save a client."); return; }
        const editId = localStorage.getItem("editClientId") || null;
        await saveClient(u.uid, editId);
        if(editId){ localStorage.removeItem("editClientId"); }
      });

      logBind();
    });

    /* ---------- Auth + Prefill (edit/new) ---------- */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }

      // Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°ÑĞ²Ğ½Ñ–ÑÑ‚ÑŒ DOM
      if(document.readyState==="loading"){
        await new Promise(res=>document.addEventListener("DOMContentLoaded", res, {once:true}));
      }

      const editId = localStorage.getItem("editClientId");

      if(editId){
        // Ğ ĞµĞ¶Ğ¸Ğ¼ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
        try{
          const snap = await getDoc(doc(db,"users",user.uid,"clients",editId));
          if(snap.exists()){
            const c = snap.data();
            // Ğ¿Ñ€Ğ¾ÑÑ‚Ñ– Ğ¿Ğ¾Ğ»Ñ
            ["clientId","clientName","contactPerson","email","phone","address","kvk","vatNumber","notes"].forEach(k=>{
              if($(k) && c[k]!==undefined) $(k).value = Array.isArray(c[k]) ? c[k].join(", ") : c[k];
            });
            if($("country")&&c.country) $("country").value = c.country;
            if($("paymentTerm")&&c.paymentTerm) $("paymentTerm").value = c.paymentTerm;
            if($("status")&&c.status) $("status").value = c.status;
            if($("currency")&&c.currency) $("currency").value = c.currency;
            if($("tags")&&Array.isArray(c.tags)) $("tags").value = c.tags.join(", ");

            const saveBtn = $("saveBtn");
            if(saveBtn) saveBtn.textContent = "ğŸ’¾ Update Client";
          }else{
            console.warn("âš ï¸ Client not found for edit:", editId);
            localStorage.removeItem("editClientId");
            // Ğ—Ğ³ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ID Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾
            if($("clientId") && !$("clientId").value){
              $("clientId").value = await generateClientId(user.uid);
            }
          }
        }catch(e){
          console.error("Load client error:", e);
        }
      }else{
        // ĞĞ¾Ğ²Ğ¸Ğ¹ â€” Ğ·Ğ³ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ID, ÑĞºÑ‰Ğ¾ Ñ‰Ğµ Ğ½ĞµĞ¼Ğ°
        try{
          if($("clientId") && !$("clientId").value){
            $("clientId").value = await generateClientId(user.uid);
          }
        }catch(e){ console.warn("ID gen error:", e); }
      }
    });
  </script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem('theme') || 'theme-dark';
    document.body.classList.remove('theme-light', 'theme-dark');
    document.body.classList.add(savedTheme);
  });
</script>
  <script>
    const selectedLang = localStorage.getItem("language") || "en";
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof applyTranslations === 'function') {
        applyTranslations(selectedLang);
      }
    });
  </script>
</body>
</html>
