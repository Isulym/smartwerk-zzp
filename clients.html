<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üë• SmartWerk ‚Äî Add Client</title>
  <link rel="stylesheet" href="style-invoices.css" />
  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:Inter,system-ui,sans-serif; padding:20px; }
    h1,h2{ color:#fff; }
    section{ background:#1e293b; padding:16px; border-radius:12px; margin-bottom:15px; }
    label{ color:#94a3b8; font-size:14px; }
    input,select,textarea{ width:100%; padding:8px; border-radius:6px; border:none; background:#334155; color:#fff; margin-top:4px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .btn{ background:#475569; color:#fff; border:none; border-radius:8px; padding:10px 16px; cursor:pointer; }
    .btn-primary{ background:#3b82f6; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:15px; }
    .hint{ background:#10b981; color:#fff; padding:8px; border-radius:6px; text-align:center; margin-top:10px; display:none; transition:opacity .3s; }
    footer{ text-align:center; margin-top:20px; font-size:13px; color:#64748b; }
  </style>
</head>
<body>
  <header>
    <h1>üë• SmartWerk ‚Äî Add Client</h1>
    <nav>
      <a href="dashboard.html" class="btn" type="button">‚Üê Dashboard</a>
      <a href="clients-list.html" class="btn" type="button" id="viewBtnTop">üìÇ Saved Clients</a>
    </nav>
  </header>

  <main>
    <!-- CLIENT INFO -->
    <section>
      <h2>üè¢ Client Information</h2>

      <div class="grid-2">
        <div>
          <label>Client ID</label>
          <input id="clientId" placeholder="CL-2025-001" readonly />
        </div>
        <div>
          <label>Status</label>
          <select id="status">
            <option>Active</option>
            <option>Prospect</option>
            <option>Inactive</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Company / Full Name</label>
          <input id="clientName" placeholder="Company or Full Name" />
        </div>
        <div>
          <label>Contact Person</label>
          <input id="contactPerson" placeholder="e.g. John de Vries" />
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="client@example.com" />
        </div>
        <div>
          <label>Phone</label>
          <input id="phone" placeholder="+31 6 12345678" />
        </div>
      </div>

      <label>Address</label>
      <input id="address" placeholder="Street, City, ZIP" />

      <div class="grid-2">
        <div>
          <label>Country</label>
          <select id="country">
            <option value="">Select Country</option>
            <option>Netherlands</option>
            <option>Belgium</option>
            <option>Germany</option>
            <option>France</option>
            <option>Spain</option>
            <option>Poland</option>
            <option>United Kingdom</option>
          </select>
        </div>
        <div>
          <label>Payment Term</label>
          <select id="paymentTerm">
            <option>14 days</option>
            <option selected>30 days</option>
            <option>60 days</option>
            <option>On Receipt</option>
          </select>
        </div>
      </div>
    </section>

    <!-- COMPANY DATA -->
    <section>
      <h2>üíº Company Data</h2>
      <div class="grid-2">
        <div>
          <label>KvK Number</label>
          <input id="kvk" placeholder="e.g. 12345678" />
        </div>
        <div>
          <label>VAT Number</label>
          <input id="vatNumber" placeholder="e.g. NL001234567B01" />
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Tags</label>
          <input id="tags" placeholder="VIP, Long-term, etc." />
        </div>
        <div>
          <label>Default Currency</label>
          <select id="currency">
            <option selected>EUR</option>
            <option>USD</option>
            <option>GBP</option>
            <option>PLN</option>
          </select>
        </div>
      </div>
      <label>Notes</label>
      <textarea id="notes" rows="3" placeholder="Additional comments or notes"></textarea>
    </section>

    <div class="actions">
      <button id="saveBtn" class="btn-primary" type="button">üíæ Save Client</button>
      <button id="viewBtn" class="btn" type="button">üìÇ View Saved Clients</button>
      <button id="smartSuggestBtn" class="btn" type="button">ü§ñ Smart Suggest</button>
    </div>
    <div id="smartHint" class="hint"></div>
  </main>

  <footer><p>¬© 2025 SmartWerk</p></footer>

  <!-- APP -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, getDoc, runTransaction, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ---------- Helpers ---------- */
    const $   = (id)=>document.getElementById(id);
    const val = (id)=>$(id)?.value?.trim() || "";

    function logBind() {
      console.log("üîó Bind buttons:", {
        save: !!$("saveBtn"),
        view: !!$("viewBtn"),
        smart: !!$("smartSuggestBtn"),
        viewTop: !!$("viewBtnTop"),
        hint: !!$("smartHint"),
      });
    }

    /* ---------- Client ID generator ---------- */
    async function generateClientId(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastClientNumber||0) : 0;
        const next = last + 1;
        tx.set(ref,{ lastClientNumber: next },{ merge:true });
        out = `CL-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    /* ---------- Smart Suggest ---------- */
    function smartSuggest() {
      const hint = $("smartHint");
      if(!hint){ console.warn("‚ö†Ô∏è #smartHint missing"); return; }

      const email = val("email").toLowerCase();
      let messages = [];

      if (email.includes("@")) {
        const domain = email.split("@")[1] || "";
        const ends = (t) => domain.endsWith(t);

        const countryMap = {
          ".nl": "Netherlands", ".be": "Belgium", ".de": "Germany",
          ".fr": "France", ".es": "Spain", ".pl": "Poland",
          ".uk": "United Kingdom", ".co.uk": "United Kingdom"
        };
        for (const [suffix, country] of Object.entries(countryMap)) {
          if (ends(suffix) && $("country")) $("country").value = country;
        }

        const isFree = /(gmail|yahoo|outlook|hotmail|icloud)\./.test(domain);
        if (isFree) {
          if ($("status")) $("status").value = "Prospect";
          if ($("tags") && !val("tags")) $("tags").value = "Prospect";
          messages.push("Freemail detected ‚Üí Status: Prospect");
        } else {
          if ($("tags") && !val("tags")) $("tags").value = domain.split(".")[0];
          messages.push("Tags suggested from domain");
        }

        if (!val("phone") && $("phone")) {
          const prefixMap = {
            ".nl": "+31", ".be": "+32", ".de": "+49", ".fr": "+33",
            ".es": "+34", ".pl": "+48", ".uk": "+44", ".co.uk": "+44"
          };
          for (const [s, code] of Object.entries(prefixMap)) {
            if (ends(s)) $("phone").value = code + " ";
          }
        }
      } else {
        messages.push("Enter an email for better suggestions");
      }

      hint.textContent = "‚úÖ " + messages.join(" ¬∑ ");
      hint.style.display = "block";
      hint.style.opacity = "1";
      setTimeout(()=>hint.style.opacity="0", 2000);
      setTimeout(()=>hint.style.display="none", 2500);
    }

    /* ---------- Validation ---------- */
    function validate() {
      if (!val("clientName")) { alert("‚ùó Client Name is required."); return false; }
      const email = val("email");
      const phone = val("phone");
      if (email && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { alert("‚ùó Invalid email address."); return false; }
      if (phone && !/^[0-9+\s\-()]{6,20}$/.test(phone)) { alert("‚ùó Invalid phone number."); return false; }
      return true;
    }

    /* ---------- Save Client (create/update) ---------- */
    async function saveClient(uid, editId=null){
      if(!validate()) return;

      let id = val("clientId");
      if(!id){
        id = await generateClientId(uid);
        if($("clientId")) $("clientId").value = id;
      }

      const data = {
        clientId: id,
        clientName: val("clientName"),
        contactPerson: val("contactPerson"),
        email: val("email"),
        phone: val("phone"),
        address: val("address"),
        country: $("country")?.value || "",
        kvk: val("kvk"),
        vatNumber: val("vatNumber"),
        paymentTerm: $("paymentTerm")?.value || "30 days",
        status: $("status")?.value || "Active",
        currency: $("currency")?.value || "EUR",
        tags: val("tags") ? val("tags").split(",").map(t=>t.trim()).filter(Boolean) : [],
        notes: val("notes"),
        updatedAt: serverTimestamp(),
      };

      if(editId){
        await updateDoc(doc(db,"users",uid,"clients",editId), data);
        alert("‚úÖ Client updated successfully!");
      }else{
        await addDoc(collection(db,"users",uid,"clients"), { ...data, createdAt: serverTimestamp() });
        alert("‚úÖ Client saved successfully!");
      }

      // —Ä–µ–¥—ñ—Ä–µ–∫—Ç —É —Å–ø–∏—Å–æ–∫
      location.href = "clients-list.html";
    }

    /* ---------- DOM Ready: bind buttons ---------- */
    document.addEventListener("DOMContentLoaded", () => {
      // Bind
      $("smartSuggestBtn")?.addEventListener("click", smartSuggest);
      $("email")?.addEventListener("blur", smartSuggest);
      $("viewBtn")?.addEventListener("click", ()=> location.href="clients-list.html");
      $("viewBtnTop")?.addEventListener("click", (e)=>{ e.preventDefault(); location.href="clients-list.html"; });

      // Save ‚Äî –≤–∏–∫–ª–∏–∫–∞—î–º–æ –ø—ñ–∑–Ω—ñ—à–µ –∑ uid
      $("saveBtn")?.addEventListener("click", async ()=>{
        const u = auth.currentUser;
        if(!u){ alert("Please log in to save a client."); return; }
        const editId = localStorage.getItem("editClientId") || null;
        await saveClient(u.uid, editId);
        if(editId){ localStorage.removeItem("editClientId"); }
      });

      logBind();
    });

    /* ---------- Auth + Prefill (edit/new) ---------- */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }

      // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å DOM
      if(document.readyState==="loading"){
        await new Promise(res=>document.addEventListener("DOMContentLoaded", res, {once:true}));
      }

      const editId = localStorage.getItem("editClientId");

      if(editId){
        // –†–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        try{
          const snap = await getDoc(doc(db,"users",user.uid,"clients",editId));
          if(snap.exists()){
            const c = snap.data();
            // –ø—Ä–æ—Å—Ç—ñ –ø–æ–ª—è
            ["clientId","clientName","contactPerson","email","phone","address","kvk","vatNumber","notes"].forEach(k=>{
              if($(k) && c[k]!==undefined) $(k).value = Array.isArray(c[k]) ? c[k].join(", ") : c[k];
            });
            if($("country")&&c.country) $("country").value = c.country;
            if($("paymentTerm")&&c.paymentTerm) $("paymentTerm").value = c.paymentTerm;
            if($("status")&&c.status) $("status").value = c.status;
            if($("currency")&&c.currency) $("currency").value = c.currency;
            if($("tags")&&Array.isArray(c.tags)) $("tags").value = c.tags.join(", ");

            const saveBtn = $("saveBtn");
            if(saveBtn) saveBtn.textContent = "üíæ Update Client";
          }else{
            console.warn("‚ö†Ô∏è Client not found for edit:", editId);
            localStorage.removeItem("editClientId");
            // –ó–≥–µ–Ω–µ—Ä—É—î–º–æ ID –¥–ª—è –Ω–æ–≤–æ–≥–æ
            if($("clientId") && !$("clientId").value){
              $("clientId").value = await generateClientId(user.uid);
            }
          }
        }catch(e){
          console.error("Load client error:", e);
        }
      }else{
        // –ù–æ–≤–∏–π ‚Äî –∑–≥–µ–Ω–µ—Ä—É—î–º–æ ID, —è–∫—â–æ —â–µ –Ω–µ–º–∞
        try{
          if($("clientId") && !$("clientId").value){
            $("clientId").value = await generateClientId(user.uid);
          }
        }catch(e){ console.warn("ID gen error:", e); }
      }
    });
  </script>
</body>
</html>
