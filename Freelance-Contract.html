<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“„ SmartWerk â€” Freelance Contract</title>
  <link rel="stylesheet" href="style-Freelance-Contract.css" />
</head>
<body>
  <header>
    <h1>ğŸ“„ Freelance Contract</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="contracts-list.html" class="btn btn-primary">ğŸ“‚ View Saved Contracts</a>
    </nav>
  </header>

  <main>
    <!-- Contract Overview -->
    <section class="block">
      <h2>ğŸ“‹ Contract Overview</h2>
      <div class="grid-3">
        <div>
          <label>Contract ID</label>
          <input id="contractId" readonly placeholder="CT-2025-001" />
        </div>
        <div>
          <label>Status</label>
          <select id="status">
            <option>Draft</option>
            <option>Sent</option>
            <option>Signed</option>
            <option>Completed</option>
          </select>
        </div>
        <div>
          <label>Date</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Select Client</label>
          <select id="clientSelect">
            <option value="">Select a client...</option>
          </select>
        </div>
        <div>
          <label>Project Title</label>
          <input id="projectTitle" placeholder="e.g. Website redesign project" />
        </div>
      </div>
    </section>

    <!-- Business Info -->
    <section class="block">
      <h2>ğŸ¢ Business Info</h2>
      <div class="grid-2">
        <div>
          <label>Business Name</label>
          <input id="businessName" readonly />
        </div>
        <div>
          <label>KVK Number</label>
          <input id="kvk" readonly />
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>VAT Number</label>
          <input id="vat" readonly />
        </div>
        <div>
          <label>IBAN</label>
          <input id="iban" readonly />
        </div>
      </div>
      <label>Address</label>
      <input id="businessAddress" readonly />
    </section>

    <!-- Client Info -->
    <section class="block">
      <h2>ğŸ‘¤ Client Info</h2>
      <div class="grid-2">
        <div>
          <label>Client Name</label>
          <input id="clientName" readonly />
        </div>
        <div>
          <label>Email</label>
          <input id="clientEmail" readonly />
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Phone</label>
          <input id="clientPhone" readonly />
        </div>
        <div>
          <label>Address</label>
          <input id="clientAddress" readonly />
        </div>
      </div>
    </section>

    <!-- Project Details -->
    <section class="block">
      <h2>ğŸ§© Project Details</h2>
      <label>Scope of Work</label>
      <textarea id="projectScope" rows="3" placeholder="Describe deliverables, features, and scope of the project"></textarea>

      <label>Timeline</label>
      <textarea id="timeline" rows="2" placeholder="Start date, milestones, and expected delivery"></textarea>

      <label>Payment Terms</label>
      <textarea id="paymentTerms" rows="2" placeholder="Amount, payment method, schedule, and due dates"></textarea>
    </section>

    <!-- Legal Terms -->
    <section class="block">
      <h2>âš–ï¸ Legal Terms</h2>
      <textarea id="legalTerms" rows="4">This contract is governed by the laws of the Netherlands. Intellectual property created during this project will remain with the freelancer until full payment is received. Both parties agree to confidentiality regarding shared business or technical information.</textarea>
    </section>

    <!-- Signatures -->
    <section class="block signatures">
      <h2>âœï¸ Signatures</h2>
      <div class="grid-2">
        <div>
          <h3>Freelancer</h3>
          <canvas id="freelancerSign" class="sign-canvas" width="300" height="100"></canvas>
          <p>Date: <span id="freelancerDate"></span></p>
        </div>
        <div>
          <h3>Client</h3>
          <canvas id="clientSign" class="sign-canvas" width="300" height="100"></canvas>
          <p>Date: <span id="clientDate"></span></p>
        </div>
      </div>
    </section>

    <div class="actions">
      <button id="saveBtn" class="btn btn-primary">ğŸ’¾ Save Contract</button>
    </div>
  </main>

  <footer><p>Â© 2025 SmartWerk</p></footer>

  <!-- SCRIPT -->
 <script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc, addDoc, runTransaction, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
    authDomain: "smartwerk8520.firebaseapp.com",
    projectId: "smartwerk8520",
    appId: "1:607670981972:web:c07103c981c86860d724c1"
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const $    = (id)=>document.getElementById(id);

  async function waitForEls(ids, timeoutMs=8000){
    return new Promise((res, rej)=>{
      const start=performance.now();
      (function tick(){
        const ok=ids.every(id=>document.getElementById(id));
        if(ok) return res();
        if(performance.now()-start>timeoutMs) return rej(new Error("Missing DOM elements"));
        setTimeout(tick,40);
      })();
    });
  }

  /* -------------------- SIGNATURES (Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ° Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºĞ° DPR + ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚) -------------------- */
  function resizeCanvasToDPR(canvas){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    // Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ñ–Ğ² width/height Ğ²Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°ÑÑ‚ÑŒ Ğ²Ğ½ÑƒÑ‚Ñ€Ñ–ÑˆĞ½Ñ Â«Ğ¿Ğ»Ğ¾Ñ‰Ğ¸Ğ½ÑƒÂ» Ğ¿Ñ–ĞºÑĞµĞ»Ñ–Ğ²
    canvas.width  = Math.round(rect.width  * dpr);
    canvas.height = Math.round(rect.height * dpr);
    const ctx = canvas.getContext("2d");
    ctx.scale(dpr, dpr);
    // Ğ·Ğ°Ğ»Ğ¸Ğ²Ğ°Ñ”Ğ¼Ğ¾ Ğ±Ñ–Ğ»Ğ¸Ğ¼ Ñ„Ğ¾Ğ½Ğ¾Ğ¼ (Ñ‰Ğ¾Ğ± Ğ¿Ñ–Ğ´Ğ¿Ğ¸Ñ Ğ±ÑƒĞ² Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¸Ğ¹ Ğ·Ğ°Ğ²Ğ¶Ğ´Ğ¸)
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,rect.width,rect.height);
    // Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ– ÑÑ‚Ğ¸Ğ»Ñ– Ğ´Ğ»Ñ Ğ¿ĞµÑ€Ğ°
    ctx.strokeStyle = "#000";
    ctx.lineWidth   = 2;
    ctx.lineCap     = "round";
    return ctx;
  }

  function initSignatures(){
    document.querySelectorAll(".sign-canvas").forEach((canvas)=>{
      // Ñ‰Ğ¾Ğ± inline width/height = Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ CSS Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€Ñƒ â€” Ñ–Ğ½Ğ°ĞºÑˆĞµ ÑˆĞºĞ°Ğ»ÑĞ²Ğ°Ğ½Ğ½Ñ Â«Ğ»Ğ°Ğ¼Ğ°Ñ”Â» ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¸
      const displayWidth  = canvas.getAttribute("width")  ? parseInt(canvas.getAttribute("width"))  : 300;
      const displayHeight = canvas.getAttribute("height") ? parseInt(canvas.getAttribute("height")) : 100;
      // ĞŸÑ€Ğ¸Ğ¼ÑƒÑĞ¾Ğ²Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ‚Ğ¾Ğ¹ ÑĞ°Ğ¼Ğ¸Ğ¹ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€ Ñ– Ñ‡ĞµÑ€ĞµĞ· CSS â€” Ñ‰Ğ¾Ğ± getBoundingClientRect() Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ğ²
      canvas.style.width  = displayWidth + "px";
      canvas.style.height = displayHeight + "px";

      let ctx = resizeCanvasToDPR(canvas);
      let drawing=false;

      function getPos(e){
        const rect=canvas.getBoundingClientRect();
        const x=(e.clientX - rect.left);
        const y=(e.clientY - rect.top);
        return {x,y};
      }

      const start = (x,y)=>{
        drawing=true;
        ctx.beginPath();
        ctx.moveTo(x,y);
        if(canvas.id==="freelancerSign") $("#freelancerDate").textContent=new Date().toLocaleDateString();
        if(canvas.id==="clientSign")     $("#clientDate").textContent    =new Date().toLocaleDateString();
      };
      const move  = (x,y)=>{ if(!drawing) return; ctx.lineTo(x,y); ctx.stroke(); };
      const stop  = ()=>{ drawing=false; };

      // Pointer Events (ÑƒĞ½Ñ–Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ğ¼Ğ¸ÑˆÑ–/Ñ‚Ğ°Ñ‡Ñƒ/ÑÑ‚Ğ¸Ğ»ÑƒÑĞ°)
      canvas.addEventListener("pointerdown",(e)=>{ canvas.setPointerCapture(e.pointerId); const {x,y}=getPos(e); start(x,y); });
      canvas.addEventListener("pointermove",(e)=>{ const {x,y}=getPos(e); move(x,y); });
      canvas.addEventListener("pointerup",(e)=>{ stop(); });
      canvas.addEventListener("pointercancel", stop);
      canvas.addEventListener("pointerleave",  stop);

      // ĞĞ° Ñ€ĞµÑĞ°Ğ¹Ğ· â€” Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¼Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ñ„Ğ¾Ğ½/ÑˆĞºĞ°Ğ»Ñƒ
      window.addEventListener("resize", ()=>{
        ctx = resizeCanvasToDPR(canvas);
      });
    });
  }

  /* -------------------- ĞŸĞ ĞĞ¤Ğ†Ğ›Ğ¬: Ñ€Ğ¾Ğ·ÑƒĞ¼Ğ½Ğ¸Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑĞ²Ğ°Ñ‡ Ğ· fallback-Ğ°Ğ¼Ğ¸ -------------------- */
  async function readProfileMulti(uid){
    const paths = [
      ["users",uid,"profile","main"],     // Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¸Ğ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚
      ["users",uid,"settings","profile"], // Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚
      ["users",uid]                       // ĞºĞ¾Ñ€ĞµĞ½ĞµĞ²Ğ¸Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° (Ñ–Ğ½Ğ¾Ğ´Ñ– Ñ‚Ñ€Ğ¸Ğ¼Ğ°ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ»Ñ Ñ‚ÑƒÑ‚)
    ];
    for(const p of paths){
      try{
        const snap = await getDoc(doc(db, ...p));
        if(snap.exists()) return snap.data();
      }catch(_){}
    }
    return null;
  }

  function mapProfileToUI(p){
    // ĞŸÑ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ÑĞ¸Ğ½Ğ¾Ğ½Ñ–Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»Ñ–Ğ²
    const get = (...keys)=> keys.reduce((acc,k)=> acc ?? p?.[k], null);

    const businessName = get("businessName","fullName","company","name") || "";
    const kvk          = get("kvk","kvkNumber","kvkNo") || "";
    const vat          = get("vat","vatNumber","btw","btwNumber") || "";
    const iban         = get("iban","bankIban") || "";
    const address      = get("businessAddress","address","companyAddress") || "";

    if($("#businessName"))     $("#businessName").value     = businessName;
    if($("#kvk"))              $("#kvk").value              = kvk;
    if($("#vat"))              $("#vat").value              = vat;
    if($("#iban"))             $("#iban").value             = iban;
    if($("#businessAddress"))  $("#businessAddress").value  = address;
  }

  async function loadBusinessInfo(uid){
    const p = await readProfileMulti(uid);
    if(p) mapProfileToUI(p);
  }

  /* -------------------- ĞšĞ›Ğ†Ğ„ĞĞ¢Ğ˜ -------------------- */
  async function loadClients(uid){
    const select = $("#clientSelect");
    if(!select) return;
    const snap = await getDocs(collection(db,"users",uid,"clients"));
    snap.forEach(d=>{
      const c=d.data();
      const opt=document.createElement("option");
      opt.value = d.id;
      opt.textContent = `${c.clientName || "Unnamed"}${c.country ? " ("+c.country+")" : ""}`;
      select.appendChild(opt);
    });

    select.addEventListener("change", async ()=>{
      const id=select.value;
      if(!id) return;
      const s = await getDoc(doc(db,"users",uid,"clients",id));
      if(s.exists()){
        const c = s.data();
        if($("#clientName"))    $("#clientName").value   = c.clientName || "";
        if($("#clientEmail"))   $("#clientEmail").value  = c.email      || "";
        if($("#clientPhone"))   $("#clientPhone").value  = c.phone      || "";
        if($("#clientAddress")) $("#clientAddress").value= c.address    || "";
      }
    });
  }

  /* -------------------- Contract ID -------------------- */
  async function generateContractId(uid){
    const ref = doc(db,"users",uid);
    const year= new Date().getFullYear();
    let out="";
    await runTransaction(db, async(tx)=>{
      const s = await tx.get(ref);
      const last = s.exists()? (s.data().lastContractNumber||0) : 0;
      const next = last + 1;
      tx.set(ref,{ lastContractNumber: next },{ merge:true });
      out = `CT-${year}-${String(next).padStart(3,"0")}`;
    });
    return out;
  }

  /* -------------------- SAVE -------------------- */
  async function saveContract(uid){
    const payload = {
      contractId:     $("#contractId")?.value || "",
      status:         $("#status")?.value     || "Draft",
      date:           $("#date")?.value       || new Date().toISOString().slice(0,10),
      projectTitle:   $("#projectTitle")?.value || "",

      businessName:   $("#businessName")?.value || "",
      kvk:            $("#kvk")?.value || "",
      vat:            $("#vat")?.value || "",
      iban:           $("#iban")?.value || "",
      businessAddress:$("#businessAddress")?.value || "",

      clientName:     $("#clientName")?.value || "",
      clientEmail:    $("#clientEmail")?.value || "",
      clientPhone:    $("#clientPhone")?.value || "",
      clientAddress:  $("#clientAddress")?.value || "",

      projectScope:   $("#projectScope")?.value || "",
      timeline:       $("#timeline")?.value || "",
      paymentTerms:   $("#paymentTerms")?.value || "",
      legalTerms:     $("#legalTerms")?.value || "",

      freelancerSignature: (()=>{
        const c=$("#freelancerSign");
        try{ return c ? c.toDataURL("image/png") : ""; }catch(_){ return ""; }
      })(),
      clientSignature: (()=>{
        const c=$("#clientSign");
        try{ return c ? c.toDataURL("image/png") : ""; }catch(_){ return ""; }
      })(),
      freelancerDate: $("#freelancerDate")?.textContent || "",
      clientDate:     $("#clientDate")?.textContent || "",

      createdAt: serverTimestamp()
    };

    await addDoc(collection(db,"users",uid,"contracts"), payload);
    alert("âœ… Contract saved successfully!");
    location.href="contracts-list.html";
  }

  /* -------------------- INIT -------------------- */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="login.html"; return; }

    // Ğ¿ĞµÑ€ĞµĞºĞ¾Ğ½ÑƒÑ”Ğ¼Ğ¾ÑÑŒ, Ñ‰Ğ¾ DOM Ñ”
    await waitForEls([
      "date","contractId","status","clientSelect",
      "businessName","kvk","vat","iban","businessAddress",
      "clientName","clientEmail","clientPhone","clientAddress",
      "freelancerSign","clientSign","freelancerDate","clientDate",
      "saveBtn"
    ]);

    // Ğ´Ğ°Ñ‚Ğ¸/ID
    if($("#date"))       $("#date").value       = new Date().toISOString().slice(0,10);
    if($("#contractId")) $("#contractId").value = await generateContractId(user.uid);

    // Ğ´Ğ°Ğ½Ñ–
    await loadBusinessInfo(user.uid);
    await loadClients(user.uid);

    // Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ¸
    initSignatures();

    // Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ
    $("#saveBtn")?.addEventListener("click", ()=>saveContract(user.uid));
  });
</script>
</body>
</html>
