<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Generate and manage freelance contracts with SmartWerk" />
  <meta name="author" content="SmartWerk Team" />
  <link rel="icon" href="/favicon.ico" />
  <title>ğŸ“„ SmartWerk â€” Freelance Contract</title>
  <link rel="stylesheet" href="style-Freelance-Contract.css" />
</head>
<body>
  <header>
    <h1>ğŸ“„ Freelance Contract</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="Freelance-Contract-list.html" class="btn btn-primary">ğŸ“‚ View Saved Contracts</a>
    </nav>
  </header>
  <div id="errorBox" style="display:none;color:red;text-align:center;margin-top:1rem;"></div>
<div id="loadingBox" style="display:none;text-align:center;margin-top:1rem;">Saving...</div>

  <main>
    <form id="contractForm" onsubmit="return false">

       <!-- Business Info -->
    <section class="collapsible">
  <button type="button" class="section-toggle">
  <span>ğŸ¢ Business Info</span>
  <span class="toggle-icon">â–¶ï¸</span>
</button>
  <div class="section-content">
    <div>
      <label for="businessName">Business Name</label>
      <input id="businessName" name="businessName" readonly />
    </div>
    <div>
      <label for="kvk">KVK Number</label>
      <input id="kvk" name="kvk" readonly />
    </div>
  

  <div class="grid-2">
    <div>
      <label for="btw">BTW Number</label>
      <input id="btw" name="btw" readonly />
    </div>
    <div>
      <label for="iban">IBAN</label>
      <input id="iban" name="iban" readonly />
    </div>
  </div>

  <div class="grid-2">
    <div>
      <label for="businessPhone">Phone</label>
      <input id="businessPhone" name="businessPhone" readonly />
    </div>
    <div>
      <label for="businessEmail">Email</label>
      <input id="businessEmail" name="businessEmail" readonly />
    </div>
  </div>

  <label for="businessAddress">Address</label>
  <input id="businessAddress" name="businessAddress" readonly />
    </div>
</section>
      <!-- Client Info -->
    <section class="collapsible">
  <button class="section-toggle">
    <span>ğŸ‘¤ Client Info</span>
    <span class="toggle-icon">â–¶ï¸</span>
  </button>
  <div class="section-content">
    <div>
      <label for="clientName">Client Name</label>
      <input id="clientName" name="clientName" readonly />
    </div>
    <div>
      <label for="clientEmail">Email</label>
      <input id="clientEmail" name="clientEmail" readonly />
    </div>

  <div class="grid-2">
    <div>
      <label for="clientPhone">Phone</label>
      <input id="clientPhone" name="clientPhone" readonly />
    </div>
    <div>
      <label for="clientAddress">Address</label>
      <input id="clientAddress" name="clientAddress" readonly />
    </div>
  </div>
    </div>
</section>

    <section class="block">
      <h2>ğŸ“‹ Contract Overview</h2>
      <div class="grid-3">
        <div>
          <label for="contractId">Contract ID</label>
          <input id="contractId" name="contractId" readonly autocomplete="off" />
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status" name="status" autocomplete="off">
            <option>Draft</option>
            <option>Sent</option>
            <option>Signed</option>
            <option>Completed</option>
          </select>
        </div>
        <div>
          <label for="date">Date</label>
          <input type="date" id="date" name="date" autocomplete="off">
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label for="clientSelect">Select Client</label>
          <select id="clientSelect" name="clientSelect" autocomplete="off">
            <option value="">Select a client...</option>
          </select>
        </div>
        <div>
          <label for="projectTitle">Project Title</label>
          <input id="projectTitle" name="projectTitle" placeholder="e.g. Website redesign project" autocomplete="off" />
        </div>
      </div>
    </section>

 

    <section class="block">
      <h2>ğŸ§© Project Details</h2>
      <label for="projectScope">Scope of Work</label>
      <textarea id="projectScope" name="projectScope" rows="3" autocomplete="off"></textarea>

      <label for="timeline">Timeline</label>
      <textarea id="timeline" name="timeline" rows="2" autocomplete="off"></textarea>

       <label for="paymentTerms">Payment Terms</label>
      <textarea id="paymentTerms" name="paymentTerms" rows="2" autocomplete="off"></textarea>
    </section>

    <section class="block">
      <h2>âš–ï¸ Legal Terms</h2>
      <textarea id="legalTerms" name="legalTerms" rows="4" autocomplete="off">This contract is governed by the laws of the Netherlands...</textarea>
    </section>

  <section class="signatures">
  <h2>âœï¸ Signatures</h2>
  <div class="signature-box">
    <h3>Freelancer</h3>
    <canvas id="signatureFreelancer" class="signature"></canvas>
    <button type="button" class="btn" onclick="clearSignature('signatureFreelancer')">ğŸ§¹ Clear</button>
    <p>Date: <span id="signatureFreelancerDate"></span></p>
  </div>
  <div class="signature-box">
    <h3>Client</h3>
    <canvas id="signatureClient" class="signature"></canvas>
    <button type="button" class="btn" onclick="clearSignature('signatureClient')">ğŸ§¹ Clear</button>
    <p>Date: <span id="signatureClientDate"></span></p>
  </div>
</section>

    <section class="block">
      <h2>ğŸ“ Stamp / Upload Logo</h2>
     <input type="file" id="uploadStamp" name="uploadStamp" accept="image/*" />
      <div style="margin-top:10px;">
        <img id="freelancerStampPreview" style="max-height:100px; display:none;" />
      </div>
    </section>

    <div style="text-align:center; margin-top:20px;">
      <button id="saveBtn" class="btn btn-primary">ğŸ’¾ Save Contract</button>
    </div>
      </form>
  </main>

  <footer><p>Â© 2025 SmartWerk</p></footer>

<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  getDoc,
  addDoc,
  setDoc,
  runTransaction,
  setLogLevel
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  setLogLevel("error");


const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1"
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const $ = id => document.getElementById(id);

let contractToEdit = null;
let loadedClients = {};
let freelancerStampBase64 = "";


function setupSignature(canvasId, dateId) {
  const c = document.getElementById(canvasId);
  const ctx = c.getContext("2d");

  function resizeCanvas() {
    const rect = c.getBoundingClientRect();
    const ratio = window.devicePixelRatio || 1;

    c.width = rect.width * ratio;
    c.height = rect.height * ratio;

    ctx.setTransform(1, 0, 0, 1, 0, 0); // Ğ¡ĞºĞ¸Ğ´Ğ°Ñ” Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½Ñ–Ğ¹ scale
    ctx.scale(ratio, ratio);
  }

  resizeCanvas();
  

  let drawing = false;

  const start = () => {
    drawing = true;
    ctx.beginPath();
  };

  const end = () => {
    if (!drawing) return;
    drawing = false;
    document.getElementById(dateId).innerText = new Date().toLocaleDateString("nl-NL");
  };

  const move = (e) => {
    if (!drawing) return;
    const r = c.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  };

  // Mouse
  c.addEventListener("mousedown", start);
  c.addEventListener("mouseup", end);
  c.addEventListener("mouseleave", () => (drawing = false));
  c.addEventListener("mousemove", move);

  // Touch
  c.addEventListener("touchstart", (e) => {
    e.preventDefault();
    start();
  });
  c.addEventListener("touchend", (e) => {
    e.preventDefault();
    end();
  });
  c.addEventListener("touchmove", (e) => {
    e.preventDefault();
    move(e);
  });
}

// âœ… ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ¿Ñ–Ğ´Ğ¿Ğ¸Ñ
window.clearSignature = (id) => {
  const c = document.getElementById(id);
  if (!c) return;
  const ctx = c.getContext("2d");
  ctx.clearRect(0, 0, c.width, c.height);

  if (id === "signatureBusiness") {
    document.getElementById("signatureBusinessDate").innerText = "";
  }
  if (id === "signatureClient") {
    document.getElementById("signatureClientDate").innerText = "";
  }
};

function setupImageUpload() {
  const input = $("uploadStamp");
  input.addEventListener("change", () => {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      freelancerStampBase64 = e.target.result;
      $("freelancerStampPreview").src = freelancerStampBase64;
      $("freelancerStampPreview").style.display = "block";
    };
    reader.readAsDataURL(file);
  });
}

async function loadBusinessInfo(uid) {
  const snap = await getDoc(doc(db, "users", uid));
  if (!snap.exists()) return;

  const d = snap.data();

  $("businessName").value = d.businessName || "";
  $("kvk").value = d.kvk || "";
  $("btw").value = d.btw || "";
  $("iban").value = d.iban || "";
  $("businessAddress").value = d.businessAddress || d.address || "";
  $("businessPhone").value = d.businessPhone || d.phone || "";
  $("businessEmail").value = d.businessEmail || d.email || "";
}

async function loadClients(uid) {
  const snap = await getDocs(collection(db, "users", uid, "clients"));
  const select = $("clientSelect");
  select.innerHTML = '<option value="">Select a client...</option>';
  snap.forEach(docSnap => {
    const c = docSnap.data();
    const opt = document.createElement("option");
    opt.value = docSnap.id;
    opt.textContent = `${c.clientName || "Unnamed"}`;
    select.appendChild(opt);
    loadedClients[docSnap.id] = c;
  });

  // âœ… prevent duplicate listeners
  if (!select.dataset.listener) {
  select.addEventListener("change", () => {
    const id = select.value;
    const c = loadedClients[id];
    if (c) {
      $("clientName").value = c.clientName || "";
      $("clientEmail").value = c.clientEmail || c.email || "";
      $("clientPhone").value = c.clientPhone || c.phone || "";
      $("clientAddress").value = c.clientAddress || c.address || "";

      // ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ¿Ñ–Ğ´Ğ¿Ğ¸Ñ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ° Ğ¿Ñ€Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ñ– ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°
      clearSignature('signatureClient');
    }
  });
  select.dataset.listener = "true";
}
  }

  function safeSet(id, value) {
  if ($(id).value.trim() === "" && value) {
    $(id).value = value;
  }
}
  
function fillForm(data) {
  $("contractId").value = data.contractId || "";
  $("status").value = data.status || "Draft";
  $("date").value = data.date || new Date().toISOString().split("T")[0];
  $("projectTitle").value = data.projectTitle || "";

  safeSet("businessName", data.businessName);
  safeSet("kvk", data.kvk);
  safeSet("btw", data.btw);
  safeSet("iban", data.iban);
  safeSet("businessAddress", data.businessAddress);
  safeSet("businessPhone", data.businessPhone);
  safeSet("businessEmail", data.businessEmail);

  $("clientName").value = data.clientName || "";
  $("clientEmail").value = data.clientEmail || "";
  $("clientPhone").value = data.clientPhone || "";
  $("clientAddress").value = data.clientAddress || "";
  $("projectScope").value = data.projectScope || "";
  $("timeline").value = data.timeline || "";
  $("paymentTerms").value = data.paymentTerms || "";
  $("legalTerms").value = data.legalTerms || "";
  $("signatureFreelancerDate").textContent = data.freelancerDate || "";
  $("signatureClientDate").textContent = data.clientDate || "";

  if (data.signatureFreelancer) {
  const img = new Image();
  img.onload = () => {
    const ctx = $("signatureFreelancer").getContext("2d");
    ctx.clearRect(0, 0, 300, 100);
    ctx.drawImage(img, 0, 0);
  };
  img.src = data.signatureFreelancer;
}

if (data.signatureClient) {
  const img = new Image();
  img.onload = () => {
    const ctx = $("signatureClient").getContext("2d");
    ctx.clearRect(0, 0, 300, 100);
    ctx.drawImage(img, 0, 0);
  };
  img.src = data.signatureClient;
}

  // Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ clientSelect, ÑĞºÑ‰Ğ¾ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾
  const select = $("clientSelect");
  for (const [id, c] of Object.entries(loadedClients)) {
    if (
      c.clientEmail === data.clientEmail ||
      c.clientName === data.clientName
    ) {
      select.value = id;
      select.dispatchEvent(new Event("change"));
      break;
    }
  }

  if (data.freelancerStamp) {
    freelancerStampBase64 = data.freelancerStamp;
    $("freelancerStampPreview").src = freelancerStampBase64;
    $("freelancerStampPreview").style.display = "block";
  }
}

async function generateContractId(uid) {
  const ref = doc(db, "users", uid);
  const year = new Date().getFullYear();
  let out = "";
  await runTransaction(db, async tx => {
    const snap = await tx.get(ref);
    const last = snap.exists() ? (snap.data().lastContractNumber || 0) : 0;
    const next = last + 1;
    tx.set(ref, { lastContractNumber: next }, { merge: true });
    out = `CT-${year}-${String(next).padStart(3, "0")}`;
  });
  return out;
}

  function validateForm() {
  const requiredFields = [
    { id: "clientSelect", name: "Client" },
    { id: "projectTitle", name: "Project Title" },
    { id: "projectScope", name: "Scope of Work" },
    { id: "timeline", name: "Timeline" },
    { id: "paymentTerms", name: "Payment Terms" }
  ];

  for (const field of requiredFields) {
    const el = $(field.id);
    if (!el.value || el.value.trim() === "") {
      alert(`â—ï¸ Please fill in: ${field.name}`);
      el.focus();
      return false;
    }
  }

  // Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑÑƒ Ñ„Ñ€Ğ¸Ğ»Ğ°Ğ½ÑĞµÑ€Ğ°
  const canvas = $("signatureFreelancer");
  const ctx = canvas.getContext("2d");
  const blank = document.createElement("canvas");
  blank.width = canvas.width;
  blank.height = canvas.height;
  if (ctx.getImageData(0, 0, canvas.width, canvas.height).data.every(v => v === 0)) {
    alert("â—ï¸ Please sign the contract as Freelancer.");
    return false;
  }

  return true;
}

async function saveContract(uid, id = null) {
  const selectedClientId = $("clientSelect").value;
  const clientData = loadedClients[selectedClientId] || {};

  const data = {
    contractId: $("contractId").value,
    status: $("status").value,
    date: $("date").value,
    projectTitle: $("projectTitle").value,
    businessName: $("businessName").value,
    kvk: $("kvk").value,
    btw: $("btw").value,
    iban: $("iban").value,
    businessAddress: $("businessAddress").value,
    businessPhone: $("businessPhone").value,
    businessEmail: $("businessEmail").value,
    clientName: clientData.clientName || $("clientName").value,
    clientEmail: clientData.clientEmail || $("clientEmail").value,
    clientPhone: clientData.clientPhone || $("clientPhone").value,
    clientAddress: clientData.clientAddress || $("clientAddress").value,
    projectScope: $("projectScope").value,
    timeline: $("timeline").value,
    paymentTerms: $("paymentTerms").value,
    legalTerms: $("legalTerms").value,
    freelancerStamp: freelancerStampBase64,
    freelancerDate: $("signatureFreelancerDate").textContent,
    clientDate: $("signatureClientDate").textContent,
    updatedAt: new Date().toISOString()
  };

  try {
    if (id) {
      data.signatureFreelancer = $("signatureFreelancer").toDataURL();
      data.signatureClient = $("signatureClient").toDataURL();
      await setDoc(doc(db, "users", uid, "contracts", id), data, { merge: true });
      localStorage.removeItem("editContractId");
    } else {
      data.createdAt = new Date().toISOString();
      await addDoc(collection(db, "users", uid, "contracts"), data);
    }

    alert("âœ… Contract saved");
    location.href = "Freelance-Contract-list.html";

  } catch (error) {
    console.error("âŒ Firebase Error:", error);
    $("errorBox").textContent = "Something went wrong. Please try again.";
    $("errorBox").style.display = "block";
    $("saveBtn").disabled = false;
    $("loadingBox").style.display = "none";
  }
}

  document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".section-toggle").forEach(button => {
    button.addEventListener("click", () => {
      const content = button.nextElementSibling;
      const icon = button.querySelector('.toggle-icon');

      if (content) {
        const isOpen = content.classList.toggle("open");
        icon.textContent = isOpen ? "ğŸ”½" : "â–¶ï¸";
      }
    });
  });
});

onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  const uid = user.uid;

  // ğŸ§¼ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğµ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ "Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ" Ğ¿Ñ€Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ
  const url = new URL(window.location.href);
  const isNew = url.searchParams.get("new") === "true";
  if (isNew) localStorage.removeItem("editContractId");

  const editId = localStorage.getItem("editContractId");

  setupSignature("signatureFreelancer", "signatureFreelancerDate");
  setupSignature("signatureClient", "signatureClientDate");
  setupImageUpload();
  await loadBusinessInfo(uid);
  await loadClients(uid);

  if (editId) {
  const snap = await getDoc(doc(db, "users", uid, "contracts", editId));
  if (snap.exists()) {
    contractToEdit = editId;
    fillForm(snap.data());
  }
} else {
  // ğŸ†• Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚
  $("contractId").value = await generateContractId(uid);
  $("date").value = new Date().toISOString().split("T")[0];
}
 $("saveBtn").onclick = () => {
  if (validateForm()) {
    $("saveBtn").disabled = true;
    $("errorBox").style.display = "none";
    $("loadingBox").style.display = "block";
    saveContract(uid, contractToEdit);
  }
};
  
});
</script>
</body>
</html>

