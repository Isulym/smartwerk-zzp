<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>📄 SmartWerk — Freelance Contract</title>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:'Inter',sans-serif;padding:20px;}
h1,h2{color:#fff;}
section{background:#1e293b;padding:16px;border-radius:12px;margin-bottom:15px;}
label{color:#94a3b8;font-size:14px;}
input,select,textarea{width:100%;padding:8px;border-radius:6px;border:none;background:#334155;color:#fff;margin-top:4px;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;}
.btn{background:#475569;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;}
.btn-primary{background:#3b82f6;}
header{margin-bottom:20px;}
canvas{background:#fff;border-radius:6px;width:100%;height:180px;cursor:crosshair;}
.info-box{background:#1e3a8a;padding:12px;border-radius:10px;color:#dbeafe;margin-bottom:15px;}
footer{text-align:center;margin-top:20px;font-size:13px;color:#64748b;}
</style>
</head>
<body>
<header>
  <h1>📄 Freelance Contract</h1>
  <nav>
    <a href="dashboard.html" class="btn">← Dashboard</a>
    <a href="contracts-list.html" class="btn">📂 View Saved Contracts</a>
  </nav>
</header>

<!-- INFO BOX -->
<div class="info-box">
  <p><strong>Contract ID:</strong> <span id="contractId">Generating...</span></p>
  <p><strong>Status:</strong> <span id="contractStatus">Draft</span></p>
  <p><strong>Created:</strong> <span id="createdDate"></span></p>
</div>

<main>
  <!-- BUSINESS INFO -->
  <section>
    <h2>🏢 Business Info</h2>
    <div class="grid-2">
      <div><label>Business Name</label><input id="businessName"></div>
      <div><label>Email</label><input id="businessEmail"></div>
    </div>
    <div class="grid-2">
      <div><label>Address</label><input id="businessAddress"></div>
      <div><label>KvK / VAT</label><input id="businessKvK"></div>
    </div>
    <div><label>IBAN</label><input id="businessIBAN"></div>
  </section>

  <!-- CLIENT INFO -->
  <section>
    <h2>👤 Client Info</h2>
    <div class="grid-2">
      <div><label>Select Client</label><select id="clientSelect"><option>Loading...</option></select></div>
      <div><label>Client Email</label><input id="clientEmail"></div>
    </div>
    <div class="grid-2">
      <div><label>Client Name</label><input id="clientName"></div>
      <div><label>Client Address</label><input id="clientAddress"></div>
    </div>
    <div class="grid-2">
      <div><label>Client Phone</label><input id="clientPhone"></div>
      <div><label>Client VAT / KvK</label><input id="clientKvK"></div>
    </div>
  </section>

  <!-- PROJECT -->
  <section>
    <h2>💼 Project Details</h2>
    <label>Project Title</label><input id="projectTitle">
    <label>Deliverables</label><textarea id="deliverables" rows="2" placeholder="List of deliverables..."></textarea>
    <label>Project Description</label><textarea id="projectDescription" rows="3"></textarea>
    <div class="grid-2">
      <div><label>Start Date</label><input type="date" id="startDate"></div>
      <div><label>End Date</label><input type="date" id="endDate"></div>
    </div>
  </section>

  <!-- PAYMENT -->
  <section>
    <h2>💰 Payment Terms</h2>
    <div class="grid-2">
      <div><label>Rate / Amount</label><input id="rate" placeholder="e.g. €1500 fixed or €50/hour"></div>
      <div><label>Payment Due</label>
        <select id="paymentDue">
          <option>Upon completion</option>
          <option>50% upfront, 50% on delivery</option>
          <option>Weekly</option>
          <option>Monthly</option>
        </select>
      </div>
    </div>
    <div class="grid-2">
      <div><label>Currency</label><select id="currency"><option>EUR</option><option>USD</option><option>GBP</option></select></div>
      <div><label>Late Payment Policy</label><input id="latePolicy" placeholder="e.g. +2% after 30 days"></div>
    </div>
  </section>

  <!-- LEGAL -->
  <section>
    <h2>⚖️ Legal Terms</h2>
    <textarea id="legal" rows="4" placeholder="All work remains property until full payment..."></textarea>
  </section>

  <!-- SIGNATURES -->
  <section>
    <h2>✍️ Signatures</h2>
    <div class="grid-2">
      <div>
        <label>Freelancer Signature</label>
        <canvas id="freelancerSign"></canvas>
        <p>Date: <span id="freelancerDate"></span></p>
      </div>
      <div>
        <label>Client Signature</label>
        <canvas id="clientSign"></canvas>
        <p>Date: <span id="clientDate"></span></p>
      </div>
    </div>
  </section>

  <div class="actions">
    <button id="saveBtn" class="btn-primary">💾 Save Contract</button>
    <button id="viewBtn" class="btn">📂 View Saved Contracts</button>
  </div>
</main>

<footer><p>© 2025 SmartWerk</p></footer>

<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, doc, getDoc, runTransaction, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",authDomain:"smartwerk8520.firebaseapp.com",projectId:"smartwerk8520",appId:"1:607670981972:web:c07103c981c86860d724c1"};
const app=getApps().length?getApp():initializeApp(firebaseConfig);
const auth=getAuth(app); const db=getFirestore(app);
const $=id=>document.getElementById(id); const val=id=>$(id)?.value?.trim()||"";

// Generate Contract ID
async function generateContractId(uid){
  const ref=doc(db,"users",uid);
  const year=new Date().getFullYear();
  let out="";
  await runTransaction(db,async(tx)=>{
    const snap=await tx.get(ref);
    const last=snap.exists()?(snap.data().lastContractNumber||0):0;
    const next=last+1;
    tx.set(ref,{lastContractNumber:next},{merge:true});
    out=`CTR-${year}-${String(next).padStart(3,"0")}`;
  });
  return out;
}

// Signatures
function initSignatures(){
  ["freelancerSign","clientSign"].forEach(id=>{
    const canvas=$(id);
    const ctx=canvas.getContext("2d");
    canvas.width=canvas.offsetWidth; canvas.height=canvas.offsetHeight;
    ctx.lineWidth=2; ctx.strokeStyle="#000";
    let drawing=false;
    const start=(x,y)=>{
      drawing=true;ctx.beginPath();ctx.moveTo(x,y);
      if(id==="freelancerSign") $("#freelancerDate").textContent=new Date().toLocaleDateString();
      if(id==="clientSign") $("#clientDate").textContent=new Date().toLocaleDateString();
    };
    const draw=(x,y)=>{if(!drawing)return;ctx.lineTo(x,y);ctx.stroke();}
    const end=()=>{drawing=false;ctx.beginPath();}
    canvas.addEventListener("mousedown",e=>start(e.offsetX,e.offsetY));
    canvas.addEventListener("mousemove",e=>draw(e.offsetX,e.offsetY));
    canvas.addEventListener("mouseup",end);
    canvas.addEventListener("mouseout",end);
    canvas.addEventListener("touchstart",e=>{
      e.preventDefault();const t=e.touches[0],r=canvas.getBoundingClientRect();
      start(t.clientX-r.left,t.clientY-r.top);
    });
    canvas.addEventListener("touchmove",e=>{
      e.preventDefault();const t=e.touches[0],r=canvas.getBoundingClientRect();
      draw(t.clientX-r.left,t.clientY-r.top);
    });
    canvas.addEventListener("touchend",end);
    canvas.addEventListener("dblclick",()=>ctx.clearRect(0,0,canvas.width,canvas.height));
  });
}

// Autofill Profile
async function autofillProfile(uid){
  const snap=await getDoc(doc(db,"users",uid,"profile","main"));
  if(snap.exists()){
    const d=snap.data();
    if(d.businessName)$("businessName").value=d.businessName;
    if(d.email)$("businessEmail").value=d.email;
    if(d.businessAddress)$("businessAddress").value=d.businessAddress;
    if(d.kvk)$("businessKvK").value=d.kvk;
    if(d.iban)$("businessIBAN").value=d.iban;
  }
}

// Load Clients
async function loadClients(uid){
  const sel=$("clientSelect");
  sel.innerHTML="<option value=''>Select client...</option>";
  const snap=await getDocs(collection(db,"users",uid,"clients"));
  if(snap.empty){sel.innerHTML="<option disabled>(No clients)</option>";return;}
  snap.forEach(d=>{
    const c=d.data();
    const o=document.createElement("option");
    o.value=JSON.stringify({name:c.clientName,email:c.email,address:c.address,phone:c.phone,kvk:c.kvk});
    o.textContent=c.clientName||"(Unnamed)";
    sel.appendChild(o);
  });
  sel.onchange=()=>{
    if(!sel.value)return;
    const d=JSON.parse(sel.value);
    $("clientName").value=d.name||""; $("clientEmail").value=d.email||"";
    $("clientAddress").value=d.address||""; $("clientPhone").value=d.phone||"";
    $("clientKvK").value=d.kvk||"";
  };
}

// Save Contract
async function saveContract(uid){
  const data={
    contractId:$("#contractId").textContent,
    status:$("#contractStatus").textContent,
    createdAt:serverTimestamp(),updatedAt:serverTimestamp(),
    businessName:val("businessName"),businessEmail:val("businessEmail"),
    businessAddress:val("businessAddress"),businessKvK:val("businessKvK"),businessIBAN:val("businessIBAN"),
    clientName:val("clientName"),clientEmail:val("clientEmail"),clientAddress:val("clientAddress"),
    clientPhone:val("clientPhone"),clientKvK:val("clientKvK"),
    projectTitle:val("projectTitle"),deliverables:val("deliverables"),projectDescription:val("projectDescription"),
    startDate:val("startDate"),endDate:val("endDate"),
    rate:val("rate"),paymentDue:val("paymentDue"),currency:val("currency"),latePolicy:val("latePolicy"),
    legal:val("legal")
  };
  await addDoc(collection(db,"users",uid,"contracts"),data);
  alert("✅ Contract saved successfully!");
  location.href="contracts-list.html";
}

// Auth
onAuthStateChanged(auth, async (user) => {
  if (!user) { location.href = "login.html"; return; }

  // 🔹 Гарантовано чекаємо DOM
  await new Promise((resolve) => {
    if (document.readyState === "complete" || document.readyState === "interactive") resolve();
    else document.addEventListener("DOMContentLoaded", resolve, { once: true });
  });

  // 🔹 Додаткова перевірка наявності #contractId (на випадок затримки рендеру)
  for (let i = 0; i < 10; i++) {
    if (document.getElementById("contractId")) break;
    await new Promise(r => setTimeout(r, 100)); // чекаємо 100мс
  }

  const uid = user.uid;
  const id = await generateContractId(uid);

  const idEl = document.getElementById("contractId");
  const dateEl = document.getElementById("createdDate");

  if (!idEl || !dateEl) {
    console.error("❌ Elements not found: #contractId or #createdDate");
    alert("Error: contract fields not found. Try refreshing the page.");
    return;
  }

  idEl.textContent = id;
  dateEl.textContent = new Date().toLocaleDateString();

  await autofillProfile(uid);
  await loadClients(uid);
  initSignatures();

  const saveBtn = document.getElementById("saveBtn");
  const viewBtn = document.getElementById("viewBtn");
  if (saveBtn) saveBtn.onclick = () => saveContract(uid);
  if (viewBtn) viewBtn.onclick = () => (location.href = "contracts-list.html");

  console.log("✅ Contract page fully initialized.");
});
</script>
</body>
</html>
