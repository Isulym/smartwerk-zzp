<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📄 SmartWerk — Freelance Contract</title>
  <link rel="stylesheet" href="style-Freelance-Contract.css" />
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: 'Inter', sans-serif;
      padding: 20px;
    }
    header, footer { text-align: center; margin-bottom: 20px; }
    .btn {
      background: #475569; color: #fff; border: none; padding: 8px 14px;
      border-radius: 8px; cursor: pointer; transition: 0.2s;
    }
    .btn:hover { opacity: .85; }
    .btn-primary { background: #3b82f6; }
    .block {
      background: #1e293b; border-radius: 10px; padding: 15px; margin-bottom: 15px;
    }
    h2 { color: #93c5fd; margin-bottom: 10px; }
    label { display: block; margin-top: 8px; font-size: 14px; }
    input, select, textarea {
      width: 100%; background: #334155; color: #fff; border: none;
      border-radius: 6px; padding: 8px; margin-top: 4px;
    }
    textarea { resize: vertical; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 12px; }
    .sign-canvas {
      background: #fff; border: 1px solid #cbd5e1; border-radius: 8px;
      width: 300px; height: 100px; display: block; margin-top: 5px; touch-action: none;
    }
    footer p { font-size: 13px; color: #94a3b8; }
  </style>
</head>

<body>
  <header>
    <h1>📄 Freelance Contract</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="contracts-list.html" class="btn btn-primary">📂 View Saved Contracts</a>
    </nav>
  </header>

  <main>
    <!-- Contract Overview -->
    <section class="block">
      <h2>📋 Contract Overview</h2>
      <div class="grid-3">
        <div>
          <label>Contract ID</label>
          <input id="contractId" readonly />
        </div>
        <div>
          <label>Status</label>
          <select id="status">
            <option>Draft</option>
            <option>Sent</option>
            <option>Signed</option>
            <option>Completed</option>
          </select>
        </div>
        <div>
          <label>Date</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Select Client</label>
          <select id="clientSelect">
            <option value="">Select a client...</option>
          </select>
        </div>
        <div>
          <label>Project Title</label>
          <input id="projectTitle" placeholder="e.g. Website redesign project" />
        </div>
      </div>
    </section>

    <!-- Business Info -->
    <section class="block">
      <h2>🏢 Business Info</h2>
      <div class="grid-2">
        <div>
          <label>Business Name</label>
          <input id="businessName" readonly />
        </div>
        <div>
          <label>KVK Number</label>
          <input id="kvk" readonly />
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>VAT Number</label>
          <input id="vat" readonly />
        </div>
        <div>
          <label>IBAN</label>
          <input id="iban" readonly />
        </div>
      </div>
      <label>Address</label>
      <input id="businessAddress" readonly />
    </section>

    <!-- Client Info -->
    <section class="block">
      <h2>👤 Client Info</h2>
      <div class="grid-2">
        <div>
          <label>Client Name</label>
          <input id="clientName" readonly />
        </div>
        <div>
          <label>Email</label>
          <input id="clientEmail" readonly />
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Phone</label>
          <input id="clientPhone" readonly />
        </div>
        <div>
          <label>Address</label>
          <input id="clientAddress" readonly />
        </div>
      </div>
    </section>

    <!-- Project Details -->
    <section class="block">
      <h2>🧩 Project Details</h2>
      <label>Scope of Work</label>
      <textarea id="projectScope" rows="3"></textarea>

      <label>Timeline</label>
      <textarea id="timeline" rows="2"></textarea>

      <label>Payment Terms</label>
      <textarea id="paymentTerms" rows="2"></textarea>
    </section>

    <!-- Legal Terms -->
    <section class="block">
      <h2>⚖️ Legal Terms</h2>
      <textarea id="legalTerms" rows="4">This contract is governed by the laws of the Netherlands. Intellectual property created during this project will remain with the freelancer until full payment is received. Both parties agree to confidentiality regarding shared business or technical information.</textarea>
    </section>

   <!-- ✍️ Signatures -->
<section class="block signatures">
  <h2>✍️ Signatures</h2>
  <div class="grid-2">
    <div>
      <h3>Freelancer</h3>
      <canvas id="signatureFreelancer" class="signature" width="300" height="100"></canvas>
      <button type="button" class="btn-clear" onclick="clearSignature('signatureFreelancer')">🧹 Clear</button>
      <p>Date: <span id="signatureFreelancerDate"></span></p>
    </div>
    <div>
      <h3>Client</h3>
      <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
      <button type="button" class="btn-clear" onclick="clearSignature('signatureClient')">🧹 Clear</button>
      <p>Date: <span id="signatureClientDate"></span></p>
    </div>
  </div>
</section>

    <div style="text-align:center;">
      <button id="saveBtn" class="btn btn-primary">💾 Save Contract</button>
    </div>
  </main>

  <footer><p>© 2025 SmartWerk</p></footer>

<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, addDoc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1"
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const $ = id => document.getElementById(id);

// ✍️ Smart Signature Canvas — професійна реалізація
/* ========== SIGNATURES ========== */
function setupSignature(canvasId, dateId) {
  const c = document.getElementById(canvasId);
  if (!c) return;
  const ctx = c.getContext("2d");
  let drawing = false;

  const start = () => {
    drawing = true;
    ctx.beginPath();
  };
  const end = () => {
    if (!drawing) return;
    drawing = false;
    const now = new Date().toLocaleDateString("nl-NL");
    document.getElementById(dateId).innerText = now;
  };
  const move = (e) => {
    if (!drawing) return;
    const r = c.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  };

  // Mouse events
  c.addEventListener("mousedown", start);
  c.addEventListener("mouseup", end);
  c.addEventListener("mouseleave", () => (drawing = false));
  c.addEventListener("mousemove", move);

  // Touch events
  c.addEventListener("touchstart", (e) => { e.preventDefault(); start(); });
  c.addEventListener("touchend", (e) => { e.preventDefault(); end(); });
  c.addEventListener("touchmove", (e) => { e.preventDefault(); move(e); });
}

/* Очистка підпису */
window.clearSignature = (id) => {
  const c = document.getElementById(id);
  if (!c) return;
  c.getContext("2d").clearRect(0, 0, c.width, c.height);
  if (id === "signatureFreelancer") document.getElementById("signatureFreelancerDate").innerText = "";
  if (id === "signatureClient") document.getElementById("signatureClientDate").innerText = "";
};

/* Ініціалізація підписів після завантаження сторінки */
document.addEventListener("DOMContentLoaded", () => {
  setupSignature("signatureFreelancer", "signatureFreelancerDate");
  setupSignature("signatureClient", "signatureClientDate");
});

// 🔹 Load Business Info
// 🔹 Load Business Info (smart fallback)
// ✅ Load Business Info directly from users/{uid}
async function loadBusinessInfo(uid) {
  try {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
      const d = snap.data();
      $("businessName").value = d.businessName || "";
      $("kvk").value = d.kvk || "";
      $("vat").value = d.btw || ""; // у profile.html поле називається btw
      $("iban").value = d.iban || "";
      $("businessAddress").value = d.businessAddress || "";
      console.log("✅ Business Info loaded directly from users/{uid}");
    } else {
      console.warn("⚠️ No business data found in users/{uid}");
    }
  } catch (e) {
    console.error("❌ Error loading business info:", e);
  }
}

// 🔹 Load Clients
async function loadClients(uid) {
  const snap = await getDocs(collection(db, "users", uid, "clients"));
  snap.forEach(docSnap => {
    const c = docSnap.data();
    const opt = document.createElement("option");
    opt.value = docSnap.id;
    opt.textContent = `${c.clientName || "Unnamed"} (${c.country || ""})`;
    $("clientSelect").appendChild(opt);
  });
}

// 🔹 Autofill client on select
$("clientSelect").addEventListener("change", async () => {
  const user = auth.currentUser;
  const id = $("clientSelect").value;
  if (!id) return;
  const snap = await getDoc(doc(db, "users", user.uid, "clients", id));
  if (snap.exists()) {
    const c = snap.data();
    $("clientName").value = c.clientName || "";
    $("clientEmail").value = c.email || "";
    $("clientPhone").value = c.phone || "";
    $("clientAddress").value = c.address || "";
  }
});

// 🔹 Generate Contract ID
async function generateContractId(uid) {
  const ref = doc(db, "users", uid);
  const year = new Date().getFullYear();
  let out = "";
  await runTransaction(db, async tx => {
    const snap = await tx.get(ref);
    const last = snap.exists() ? (snap.data().lastContractNumber || 0) : 0;
    const next = last + 1;
    tx.set(ref, { lastContractNumber: next }, { merge: true });
    out = `CT-${year}-${String(next).padStart(3, "0")}`;
  });
  return out;
}

// 🔹 Save Contract
async function saveContract(uid) {
  const data = {
    contractId: $("contractId").value,
    status: $("status").value,
    date: $("date").value,
    projectTitle: $("projectTitle").value,
    businessName: $("businessName").value,
    clientName: $("clientName").value,
    projectScope: $("projectScope").value,
    timeline: $("timeline").value,
    paymentTerms: $("paymentTerms").value,
    legalTerms: $("legalTerms").value,
    createdAt: serverTimestamp()
  };
  await addDoc(collection(db, "users", uid, "contracts"), data);
  alert("✅ Contract saved successfully!");
  location.href = "contracts-list.html";
}

// 🔹 Auth
onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  $("date").value = new Date().toISOString().split("T")[0];
  $("contractId").value = await generateContractId(user.uid);
  await loadBusinessInfo(user.uid);
  await loadClients(user.uid);
  $("saveBtn").onclick = () => saveContract(user.uid);
});
</script>
</body>
</html>
