<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Freelance Contract</title>
  <link rel="stylesheet" href="style-Freelance-Contract.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>📃 SmartWerk — Freelance Contract</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="Freelance-Contract-list.html" class="btn">📋 Saved Contracts</a>
    </nav>
  </header>

  <main>
    <!-- Business Info -->
    <section>
      <h2>🏢 Business Info</h2>
       <input id="businessName" placeholder="Full Name / Business Name"/>
      <input id="businessEmail" placeholder="Business Email"/>
      <input id="businessAddress" placeholder="Business Address"/>
      <input id="businessPhone" placeholder="Business Phone"/>
    </section>

    <!-- Client Info -->
    <section>
      <h2>👤 Client Info</h2>
      <input id="clientName" placeholder="Client Name"/>
      <input id="clientEmail" placeholder="Client Email"/>
      <input id="clientAddress" placeholder="Client Address"/>
    </section>

    <!-- Contract Details -->
    <section>
      <h2>📄 Contract Details</h2>
      <input id="contractId" placeholder="Contract ID (auto)" readonly/>
      <input id="contractDate" class="js-date" placeholder="Contract Date"/>
      <select id="status">
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Signed">Signed</option>
        <option value="Cancelled">Cancelled</option>
      </select>
      <textarea id="projectDescription" placeholder="Project Description..."></textarea>
      <textarea id="deliverables" placeholder="Deliverables..."></textarea>
      <textarea id="paymentTerms" placeholder="Payment Terms..."></textarea>
      <textarea id="legal" placeholder="Legal Notes..."></textarea>
    </section>

    <!-- Message / AI -->
    <section>
      <h2>🤖 Smart AI Assistance</h2>
      <div class="actions">
        <button type="button" onclick="aiFill()">🤖 AI Fill</button>
        <button type="button" onclick="aiDraft()">✍️ AI Draft</button>
        <button type="button" onclick="aiStrict()">💬 Strict</button>
        <button type="button" onclick="aiFriendly()">👍 Friendly</button>
        <button type="button" onclick="translateMsg('en')">🌐 EN</button>
        <button type="button" onclick="translateMsg('nl')">🌐 NL</button>
      </div>
    </section>

    <!-- Signatures -->
    <section>
      <h2>✍️ Signatures</h2>
      <div>
        <h3>Business</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>
        <h3>Client</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step actions">
      <button id="saveBtn" class="btn-primary">💾 Save Contract</button>
      <a href="Freelance-Contract-list.html" class="btn">📋 Saved Contracts</a>
    </section>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, addDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);

    // ====== AUTO-FILL BUSINESS INFO FROM PROFILE ======
onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  const profileRef = doc(db, "users", user.uid);
  const snap = await getDoc(profileRef);
  if (snap.exists()) {
    const p = snap.data();
     if(p.businessName) $("businessName").value = p.businessName;
    if (p.businessEmail) $("#businessEmail").value = p.businessEmail;
    if (p.businessAddress) $("#businessAddress").value = p.businessAddress;
    if (p.businessPhone) $("#businessPhone").value = p.businessPhone;
  }
});

// ====== RECENT ACTIVITY LOGGER ======
async function logActivity(uid, type, message) {
  try {
    await addDoc(collection(db, "users", uid, "events"), {
      type,
      message,
      createdAt: new Date(),
    });
  } catch (e) {
    console.warn("Activity log failed:", e);
  }
}

// логування після збереження контракту
async function saveContractWithLog() {
  const user = auth.currentUser;
  if (!user) { location.href = "login.html"; return; }

  await saveContract(); // звичайне збереження
  await logActivity(user.uid, "Contract", "Created or updated a contract");
}
    
    /* AUTO CONTRACT ID */
    async function generateContractId(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap=await tx.get(ref);
        const last=snap.exists()?(snap.data().lastContractNumber||0):0;
        const next=last+1;
        tx.set(ref,{lastContractNumber:next},{merge:true});
        out=`CTR-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    /* SIGNATURES */
    function setupSignature(canvasId,dateId){
      const c=$(canvasId);const ctx=c.getContext("2d");
      let drawing=false;
      const start=()=>{drawing=true;ctx.beginPath();};
      const end=()=>{if(!drawing)return;drawing=false;$(dateId).innerText=new Date().toLocaleDateString("nl-NL");};
      const move=(e)=>{if(!drawing)return;const r=c.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;ctx.lineWidth=2;ctx.lineCap="round";ctx.strokeStyle="#000";ctx.lineTo(x,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y);};
      c.addEventListener("mousedown",start);c.addEventListener("mouseup",end);c.addEventListener("mouseleave",()=>drawing=false);c.addEventListener("mousemove",move);
      c.addEventListener("touchstart",(e)=>{e.preventDefault();start();});
      c.addEventListener("touchend",(e)=>{e.preventDefault();end();});
      c.addEventListener("touchmove",(e)=>{e.preventDefault();move(e);});
    }
    window.clearSignature=(id)=>{const c=$(id);c.getContext("2d").clearRect(0,0,c.width,c.height);if(id==="signatureBusiness")$("signatureBusinessDate").innerText="";if(id==="signatureClient")$("signatureClientDate").innerText="";};

    /* SAVE */
    async function saveContract(){
      const user=auth.currentUser;if(!user){location.href="login.html";return;}
      const uid=user.uid;

      const editingId = localStorage.getItem("editContractId") || null;

      // Auto Contract ID
      let contractId = $("#contractId").value;
      if(!editingId && !contractId){
        contractId = await generateContractId(uid);
        $("#contractId").value = contractId;
      }

      const data={
        businessName: $("businessName").value,
        businessEmail:$("businessEmail").value,
        businessAddress:$("businessAddress").value,
        businessPhone:$("businessPhone").value,
        clientName:$("clientName").value,
        clientEmail:$("clientEmail").value,
        clientAddress:$("clientAddress").value,
        contractId,
        contractDate:$("contractDate").value,
        status:$("status").value,
        projectDescription:$("projectDescription").value,
        deliverables:$("deliverables").value,
        paymentTerms:$("paymentTerms").value,
        legal:$("legal").value,
        signatures:{
          business:$("signatureBusiness").toDataURL(),
          client:$("signatureClient").toDataURL(),
          businessDate:$("signatureBusinessDate").innerText||"",
          clientDate:$("signatureClientDate").innerText||""
        },
        userId:uid,
        updatedAt:new Date().toISOString(),
      };

      if(editingId){
        await setDoc(doc(db,"users",uid,"contracts",editingId), data, {merge:true});
        alert("✅ Contract updated");
      }else{
        await addDoc(collection(db,"users",uid,"contracts"), data);
        alert(`✅ Contract saved as ${contractId}`);
      }
      localStorage.removeItem("editContractId");
      location.href="contract-list.html";
    }
    window.saveContract=saveContract;

    /* LOAD FOR EDIT */
    async function loadContractForEdit(uid){
      const id=localStorage.getItem("editContractId");
      if(!id)return;
      const snap=await getDoc(doc(db,"users",uid,"contracts",id));
      if(!snap.exists()){localStorage.removeItem("editContractId");return;}
      const c=snap.data();

      $("businessName").value = inv.businessName||"";
      $("#businessEmail").value=c.businessEmail||"";
      $("#businessAddress").value=c.businessAddress||"";
      $("#businessPhone").value=c.businessPhone||"";
      $("#clientName").value=c.clientName||"";
      $("#clientEmail").value=c.clientEmail||"";
      $("#clientAddress").value=c.clientAddress||"";
      $("#contractId").value=c.contractId||"";
      $("#contractDate").value=c.contractDate||"";
      $("#status").value=c.status||"Draft";
      $("#projectDescription").value=c.projectDescription||"";
      $("#deliverables").value=c.deliverables||"";
      $("#paymentTerms").value=c.paymentTerms||"";
      $("#legal").value=c.legal||"";

      if(c.signatures?.business){
        const img=new Image();img.onload=()=>{const cnv=$("#signatureBusiness");const ctx=cnv.getContext("2d");ctx.clearRect(0,0,cnv.width,cnv.height);ctx.drawImage(img,0,0);};img.src=c.signatures.business;
        $("#signatureBusinessDate").innerText=c.signatures.businessDate||"";
      }
      if(c.signatures?.client){
        const img=new Image();img.onload=()=>{const cnv=$("#signatureClient");const ctx=cnv.getContext("2d");ctx.clearRect(0,0,cnv.width,cnv.height);ctx.drawImage(img,0,0);};img.src=c.signatures.client;
        $("#signatureClientDate").innerText=c.signatures.clientDate||"";
      }
    }

    /* AI Helpers */
    window.aiFill=()=>{$("projectDescription").value="This contract covers the agreed freelance project including scope, deliverables, and terms.";};
    window.aiDraft=()=>{$("paymentTerms").value="Payment will be made within 14 days of invoice date. Late fees may apply.";};
    window.aiStrict=()=>{$("legal").value="This agreement is legally binding. Failure to comply will result in legal action.";};
    window.aiFriendly=()=>{$("legal").value="This agreement is based on mutual trust and professionalism between both parties.";};
    window.translateMsg=(lang)=>{ 
      if(lang==="nl") $("projectDescription").value="Dit contract dekt het overeengekomen freelanceproject inclusief reikwijdte, deliverables en voorwaarden.";
      if(lang==="en") $("projectDescription").value="This contract covers the agreed freelance project including scope, deliverables, and terms.";
    };



   $("saveBtn").addEventListener("click",(e)=>{e.preventDefault();saveContractWithLog();});
    
  </script>
</body>
</html>
