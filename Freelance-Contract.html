<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📄 SmartWerk — Freelance Contract</title>
  <link rel="stylesheet" href="style-contract.css" />
  <style>
    body {
      background:#0f172a;
      color:#e5e7eb;
      font-family:'Inter',sans-serif;
      padding:20px;
    }
    h1,h2 { color:#fff; }
    section {
      background:#1e293b;
      padding:16px;
      border-radius:12px;
      margin-bottom:15px;
    }
    label { color:#94a3b8; font-size:14px; }
    input,textarea {
      width:100%;
      padding:8px;
      border-radius:6px;
      border:none;
      background:#334155;
      color:#fff;
      margin-top:4px;
    }
    .grid-2 {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .actions {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:15px;
    }
    .btn {
      background:#475569;
      color:#fff;
      border:none;
      border-radius:8px;
      padding:10px 16px;
      cursor:pointer;
    }
    .btn-primary { background:#3b82f6; }
    canvas {
      background:#fff;
      border-radius:6px;
      width:100%;
      height:180px;
    }
    footer {
      text-align:center;
      margin-top:20px;
      font-size:13px;
      color:#64748b;
    }
  </style>
</head>
<body>
  <header>
    <h1>📄 Freelance Contract</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="contracts-list.html" class="btn">📂 View Saved Contracts</a>
    </nav>
  </header>

  <main>
    <!-- BUSINESS INFO -->
    <section>
      <h2>🏢 Business Info</h2>
      <div class="grid-2">
        <div>
          <label>Business Name</label>
          <input id="businessName" placeholder="Your business name"/>
        </div>
        <div>
          <label>Email</label>
          <input id="businessEmail" placeholder="you@email.com"/>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Address</label>
          <input id="businessAddress" placeholder="Street, City"/>
        </div>
        <div>
          <label>KvK / VAT</label>
          <input id="businessKvK" placeholder="KvK or VAT number"/>
        </div>
      </div>
    </section>

    <!-- CLIENT INFO -->
    <section>
      <h2>👤 Client Info</h2>
      <div class="grid-2">
        <div>
          <label>Client Name</label>
          <input id="clientName" placeholder="Client or Company name"/>
        </div>
        <div>
          <label>Email</label>
          <input id="clientEmail" placeholder="client@email.com"/>
        </div>
      </div>
      <label>Address</label>
      <input id="clientAddress" placeholder="Street, City, Country"/>
    </section>

    <!-- PROJECT -->
    <section>
      <h2>💼 Project Details</h2>
      <label>Project Title</label>
      <input id="projectTitle" placeholder="e.g. Website redesign"/>
      <label>Project Description</label>
      <textarea id="projectDescription" rows="3" placeholder="Describe the project scope..."></textarea>
      <div class="grid-2">
        <div>
          <label>Start Date</label>
          <input type="date" id="startDate"/>
        </div>
        <div>
          <label>End Date</label>
          <input type="date" id="endDate"/>
        </div>
      </div>
    </section>

    <!-- PAYMENT -->
    <section>
      <h2>💰 Payment Terms</h2>
      <div class="grid-2">
        <div>
          <label>Rate / Amount</label>
          <input id="rate" placeholder="e.g. €1500 fixed or €50/hour"/>
        </div>
        <div>
          <label>Payment Due</label>
          <select id="paymentDue">
            <option>Upon completion</option>
            <option>50% upfront, 50% on delivery</option>
            <option>Weekly</option>
            <option>Monthly</option>
          </select>
        </div>
      </div>
      <label>Additional Terms</label>
      <textarea id="extraTerms" rows="3" placeholder="Include revision, delivery or bonus terms..."></textarea>
    </section>

    <!-- LEGAL -->
    <section>
      <h2>⚖️ Legal Terms</h2>
      <textarea id="legal" rows="4" placeholder="All work will remain property of the freelancer until full payment is received. The client agrees to..."></textarea>
    </section>

    <!-- SIGNATURE -->
    <section>
      <h2>✍️ Signatures</h2>
      <div class="grid-2">
        <div>
          <label>Freelancer Signature</label>
          <canvas id="freelancerSign"></canvas>
        </div>
        <div>
          <label>Client Signature</label>
          <canvas id="clientSign"></canvas>
        </div>
      </div>
    </section>

    <div class="actions">
      <button id="saveBtn" class="btn-primary">💾 Save Contract</button>
      <button id="viewBtn" class="btn">📂 View Saved Contracts</button>
    </div>
  </main>

  <footer><p>© 2025 SmartWerk</p></footer>

  <!-- SCRIPT -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, runTransaction, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const $ = id => document.getElementById(id);
    const val = id => $(id)?.value?.trim() || "";

    /* ✏️ Init Signature Canvases */
    function initSignatures() {
      ["freelancerSign","clientSign"].forEach(id=>{
        const canvas=$(id);
        if(!canvas) return;
        const ctx=canvas.getContext("2d");
        let drawing=false;
        ctx.lineWidth=1.8;
        ctx.strokeStyle="#000";
        canvas.addEventListener("mousedown",()=>drawing=true);
        canvas.addEventListener("mouseup",()=>drawing=false);
        canvas.addEventListener("mouseout",()=>drawing=false);
        canvas.addEventListener("mousemove",(e)=>{
          if(!drawing)return;
          const r=canvas.getBoundingClientRect();
          ctx.lineTo(e.clientX-r.left,e.clientY-r.top);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(e.clientX-r.left,e.clientY-r.top);
        });
      });
    }

    /* 🧾 Save contract */
    async function saveContract(uid){
      const data={
        businessName:val("businessName"),
        businessEmail:val("businessEmail"),
        businessAddress:val("businessAddress"),
        businessKvK:val("businessKvK"),
        clientName:val("clientName"),
        clientEmail:val("clientEmail"),
        clientAddress:val("clientAddress"),
        projectTitle:val("projectTitle"),
        projectDescription:val("projectDescription"),
        startDate:val("startDate"),
        endDate:val("endDate"),
        rate:val("rate"),
        paymentDue:val("paymentDue"),
        extraTerms:val("extraTerms"),
        legal:val("legal"),
        createdAt:serverTimestamp(),
        updatedAt:serverTimestamp()
      };
      await addDoc(collection(db,"users",uid,"contracts"),data);
      await addDoc(collection(db,"users",uid,"events"),{
        type:"Contract Saved",message:`${data.clientName||'Unnamed'} contract saved`,createdAt:serverTimestamp()
      });
      alert("✅ Contract saved successfully!");
    }

    /* 🔹 Autofill Business Info from profile */
    async function autofillProfile(uid){
      try{
        const paths=[
          ["users",uid,"settings","profile"],
          ["users",uid,"profile","main"],
          ["users",uid]
        ];
        for(const p of paths){
          const snap=await getDoc(doc(db,...p));
          if(snap.exists()){
            const d=snap.data();
            if($("businessName") && d.businessName) $("businessName").value=d.businessName;
            if($("businessEmail") && d.email) $("businessEmail").value=d.email;
            if($("businessAddress") && d.businessAddress) $("businessAddress").value=d.businessAddress;
            if($("businessKvK") && d.kvk) $("businessKvK").value=d.kvk;
            console.log("✅ Profile autofilled from:",p.join("/"));
            break;
          }
        }
      }catch(e){ console.warn("Profile autofill error:",e.message); }
    }

    /* 🔹 Auth state */
    onAuthStateChanged(auth,async(user)=>{
      if(!user){location.href="login.html";return;}
      await autofillProfile(user.uid);
      initSignatures();
      $("saveBtn").onclick=()=>saveContract(user.uid);
      $("viewBtn").onclick=()=>location.href="contracts-list.html";
    });
  </script>
</body>
</html>
