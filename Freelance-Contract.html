<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“„ SmartWerk â€” Freelance Contract</title>
  <link rel="stylesheet" href="style-Freelance-Contract.css" />
</head>
<body>
  <header>
    <h1>ğŸ“„ Freelance Contract</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="Freelance-Contract-list.html" class="btn btn-primary">ğŸ“‚ View Saved Contracts</a>
    </nav>
  </header>

  <main>
    <section class="block">
      <h2>ğŸ“‹ Contract Overview</h2>
      <div class="grid-3">
        <div>
          <label>Contract ID</label>
          <input id="contractId" readonly />
        </div>
        <div>
          <label>Status</label>
          <select id="status">
            <option>Draft</option>
            <option>Sent</option>
            <option>Signed</option>
            <option>Completed</option>
          </select>
        </div>
        <div>
          <label>Date</label>
          <input id="date" type="date" />
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Select Client</label>
          <select id="clientSelect">
            <option value="">Select a client...</option>
          </select>
        </div>
        <div>
          <label>Project Title</label>
          <input id="projectTitle" placeholder="e.g. Website redesign project" />
        </div>
      </div>
    </section>

    <section class="block">
      <h2>ğŸ¢ Business Info</h2>
      <div class="grid-2">
        <div>
          <label>Business Name</label>
          <input id="businessName" readonly />
        </div>
        <div>
          <label>KVK Number</label>
          <input id="kvk" readonly />
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>VAT Number</label>
          <input id="vat" readonly />
        </div>
        <div>
          <label>IBAN</label>
          <input id="iban" readonly />
        </div>
      </div>
      <label>Address</label>
      <input id="businessAddress" readonly />
    </section>
        <section class="block">
      <h2>ğŸ‘¤ Client Info</h2>
      <div class="grid-2">
        <div>
          <label>Client Name</label>
          <input id="clientName" readonly />
        </div>
        <div>
          <label>Email</label>
          <input id="clientEmail" readonly />
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Phone</label>
          <input id="clientPhone" readonly />
        </div>
        <div>
          <label>Address</label>
          <input id="clientAddress" readonly />
        </div>
      </div>
    </section>

    <section class="block">
      <h2>ğŸ§© Project Details</h2>
      <label>Scope of Work</label>
      <textarea id="projectScope" rows="3" placeholder="Define what tasks are included and excluded..."></textarea>

      <label>Timeline</label>
      <textarea id="timeline" rows="2" placeholder="Provide deadlines, milestones..."></textarea>

      <label>Payment Terms</label>
      <textarea id="paymentTerms" rows="2" placeholder="e.g. 50% upfront, 50% on completion within 14 days"></textarea>
    </section>

    <section class="block">
      <h2>âš–ï¸ Legal Terms</h2>
      <textarea id="legalTerms" rows="4">This contract is governed by the laws of the Netherlands. Intellectual property created during this project remains with the freelancer until full payment. Confidentiality applies to shared business or technical info. Disputes will be resolved in Dutch jurisdiction.</textarea>
    </section>

    <section class="block signatures">
      <h2>âœï¸ Signatures</h2>
      <div class="grid-2">
        <div>
          <h3>Freelancer</h3>
          <canvas id="signatureFreelancer" class="signature" width="300" height="100"></canvas>
          <button type="button" class="btn-clear" onclick="clearSignature('signatureFreelancer')">ğŸ§¹ Clear</button>
          <p>Date: <span id="signatureFreelancerDate"></span></p>
        </div>
        <div>
          <h3>Client</h3>
          <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
          <button type="button" class="btn-clear" onclick="clearSignature('signatureClient')">ğŸ§¹ Clear</button>
          <p>Date: <span id="signatureClientDate"></span></p>
        </div>
      </div>
    </section>

    <div style="text-align:center;">
      <button id="saveBtn" class="btn btn-primary">ğŸ’¾ Save Contract</button>
    </div>
  </main>

  <footer><p>Â© 2025 SmartWerk</p></footer>

 <!-- â¬†ï¸ Ğ’ĞµÑÑŒ HTML-ĞºĞ¾Ğ´ (Ğ· Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ‚ĞºĞ¾Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸) Ğ·Ğ°Ğ»Ğ¸ÑˆĞ°Ñ”Ñ‚ÑŒÑÑ Ğ½ĞµĞ·Ğ¼Ñ–Ğ½Ğ½Ğ¸Ğ¼ -->

<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  getDoc,
  addDoc,
  setDoc,
  runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1"
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const $ = id => document.getElementById(id);

let contractToEdit = null;
let loadedClients = {};

function fillForm(data) {
  $("contractId").value = data.contractId || "";
  $("status").value = data.status || "Draft";
  $("date").value = data.date || new Date().toISOString().split("T")[0];
  $("projectTitle").value = data.projectTitle || "";
  $("businessName").value = data.businessName || "";
  $("kvk").value = data.kvk || "";
  $("vat").value = data.vat || "";
  $("iban").value = data.iban || "";
  $("businessAddress").value = data.businessAddress || "";
  $("clientName").value = data.clientName || "";
  $("clientEmail").value = data.clientEmail || "";
  $("clientPhone").value = data.clientPhone || "";
  $("clientAddress").value = data.clientAddress || "";
  $("projectScope").value = data.projectScope || "";
  $("timeline").value = data.timeline || "";
  $("paymentTerms").value = data.paymentTerms || "";
  $("legalTerms").value = data.legalTerms || "";
  $("signatureFreelancerDate").textContent = data.freelancerDate || "";
  $("signatureClientDate").textContent = data.clientDate || "";

  // â¬‡ï¸ ĞĞ²Ñ‚Ğ¾Ğ²Ğ¸Ğ±Ñ–Ñ€ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ° Ñƒ select (Ğ·Ğ° email Ğ°Ğ±Ğ¾ name)
  const select = $("clientSelect");
  for (const [id, c] of Object.entries(loadedClients)) {
    if (c.clientEmail === data.clientEmail || c.clientName === data.clientName) {
      select.value = id;
      break;
    }
  }
}

async function loadClients(uid) {
  const snap = await getDocs(collection(db, "users", uid, "clients"));
  const select = $("clientSelect");
  select.innerHTML = '<option value="">Select a client...</option>';
  snap.forEach(docSnap => {
    const c = docSnap.data();
    const opt = document.createElement("option");
    opt.value = docSnap.id;
    opt.textContent = `${c.clientName || "Unnamed"} (${c.country || ""})`;
    select.appendChild(opt);
    loadedClients[docSnap.id] = c;
  });
}

async function generateContractId(uid) {
  const ref = doc(db, "users", uid);
  const year = new Date().getFullYear();
  let out = "";
  await runTransaction(db, async tx => {
    const snap = await tx.get(ref);
    const last = snap.exists() ? (snap.data().lastContractNumber || 0) : 0;
    const next = last + 1;
    tx.set(ref, { lastContractNumber: next }, { merge: true });
    out = `CT-${year}-${String(next).padStart(3, "0")}`;
  });
  return out;
}

async function saveContract(uid, id = null) {
  const selectedClientId = $("clientSelect").value;
  const clientData = loadedClients[selectedClientId] || {};

  const data = {
    contractId: $("contractId").value,
    status: $("status").value,
    date: $("date").value,
    projectTitle: $("projectTitle").value,
    businessName: $("businessName").value,
    kvk: $("kvk").value,
    vat: $("vat").value,
    iban: $("iban").value,
    businessAddress: $("businessAddress").value,
    clientName: clientData.clientName || "",
    clientEmail: clientData.clientEmail || "",
    clientPhone: clientData.clientPhone || "",
    clientAddress: clientData.clientAddress || "",
    projectScope: $("projectScope").value,
    timeline: $("timeline").value,
    paymentTerms: $("paymentTerms").value,
    legalTerms: $("legalTerms").value,
    freelancerDate: $("signatureFreelancerDate").textContent,
    clientDate: $("signatureClientDate").textContent,
    updatedAt: new Date().toISOString()
  };
  if (id) {
    await setDoc(doc(db, "users", uid, "contracts", id), data, { merge: true });
    localStorage.removeItem("editContractId");
  } else {
    data.createdAt = new Date().toISOString();
    await addDoc(collection(db, "users", uid, "contracts"), data);
  }
  alert("âœ… Contract saved");
  location.href = "Freelance-Contract-list.html";
}

onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  const uid = user.uid;
  const editId = localStorage.getItem("editContractId");
  await loadClients(uid);

  if (editId) {
    const snap = await getDoc(doc(db, "users", uid, "contracts", editId));
    if (snap.exists()) {
      contractToEdit = editId;
      fillForm(snap.data());
    }
  } else {
    $("contractId").value = await generateContractId(uid);
    $("date").value = new Date().toISOString().split("T")[0];
  }
  $("saveBtn").onclick = () => saveContract(uid, contractToEdit);
});
  
</script>
</body>
</html>



