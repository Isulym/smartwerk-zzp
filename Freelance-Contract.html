<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📄 SmartWerk — Freelance Contract</title>
  <link rel="stylesheet" href="style-contract.css" />
  <link rel="stylesheet" href="style-invoices.css" />
  <style>
    body{background:#0f172a;color:#e5e7eb;font-family:'Inter',sans-serif;padding:20px;}
    h1,h2{color:#fff;}
    section{background:#1e293b;padding:16px;border-radius:12px;margin-bottom:15px;}
    label{color:#94a3b8;font-size:14px;}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:none;background:#334155;color:#fff;margin-top:4px;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .btn{background:#475569;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;}
    .btn-primary{background:#3b82f6;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;}
    .hint{background:#10b981;color:#fff;padding:8px;border-radius:6px;text-align:center;margin-top:10px;display:none;transition:opacity .3s;}
    canvas{background:#fff;border:2px solid #94a3b8;border-radius:8px;width:100%;height:120px;cursor:crosshair;}
    .status-draft{color:#fbbf24;}
    .status-signed{color:#10b981;}
    .status-completed{color:#60a5fa;}
  </style>
</head>
<body>
  <header>
    <h1>📄 SmartWerk — Freelance Contract</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="contracts-list.html" class="btn">📂 View Saved Contracts</a>
    </nav>
  </header>

  <main>
    <!-- Contract Info -->
    <section>
      <h2>🧾 Contract Info</h2>
      <div class="grid-2">
        <div>
          <label>Contract ID</label>
          <input id="contractId" readonly placeholder="CON-2025-001" />
        </div>
        <div>
          <label>Status</label>
          <select id="status">
            <option selected>Draft</option>
            <option>Signed</option>
            <option>Completed</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Contract Title</label>
          <input id="title" placeholder="Website development contract" />
        </div>
        <div>
          <label>Client</label>
          <select id="clientSelect"><option value="">Select Client</option></select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Amount (€)</label>
          <input id="amount" type="number" placeholder="e.g. 1200" />
        </div>
        <div>
          <label>Due Date</label>
          <input id="dueDate" type="date" />
        </div>
      </div>
    </section>

    <!-- Business Info -->
    <section>
      <h2>🏢 Business Info</h2>
      <div class="grid-2">
        <div><label>Business Name</label><input id="businessName" readonly /></div>
        <div><label>Email</label><input id="businessEmail" readonly /></div>
      </div>
      <div class="grid-2">
        <div><label>KvK</label><input id="kvk" readonly /></div>
        <div><label>VAT</label><input id="vat" readonly /></div>
      </div>
      <label>Address</label><input id="businessAddress" readonly />
    </section>

    <!-- Project Details -->
    <section>
      <h2>💼 Project Details</h2>
      <label>Description</label>
      <textarea id="description" rows="3" placeholder="Describe the project scope..."></textarea>

      <label>Deliverables</label>
      <textarea id="deliverables" rows="3" placeholder="List of deliverables..."></textarea>

      <label>Payment Terms</label>
      <textarea id="paymentTerms" rows="3" placeholder="Payment schedule, invoices, etc."></textarea>
    </section>

    <!-- Legal Terms -->
    <section>
      <h2>⚖️ Legal Terms</h2>
      <textarea id="legal" rows="4" placeholder="This agreement is governed by the laws of the Netherlands..."></textarea>
    </section>

    <!-- Signatures -->
    <section>
      <h2>✍️ Signatures</h2>
      <div class="grid-2">
        <div>
          <label>Freelancer Signature</label>
          <canvas id="freelancerSign"></canvas>
          <p>Date: <span id="freelancerDate"></span></p>
        </div>
        <div>
          <label>Client Signature</label>
          <canvas id="clientSign"></canvas>
          <p>Date: <span id="clientDate"></span></p>
        </div>
      </div>
    </section>

    <div class="actions">
      <button id="saveBtn" class="btn-primary">💾 Save Contract</button>
      <button id="clearBtn" class="btn">🧹 Clear All</button>
    </div>
    <div id="msg" class="hint"></div>
  </main>

  <footer><p>© 2025 SmartWerk</p></footer>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, collection, addDoc, serverTimestamp, runTransaction } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig={apiKey:"AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",authDomain:"smartwerk8520.firebaseapp.com",projectId:"smartwerk8520",appId:"1:607670981972:web:c07103c981c86860d724c1"};
    const app=getApps().length?getApp():initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);
    const $=id=>document.getElementById(id);

    // 🔹 Toast message
    function showMsg(txt){const m=$("msg");m.textContent=txt;m.style.display="block";m.style.opacity="1";setTimeout(()=>{m.style.opacity="0";setTimeout(()=>m.style.display="none",400)},2000);}

    // 🔹 Generate Contract ID
    async function generateContractId(uid){
      const ref=doc(db,"users",uid);
      const year=new Date().getFullYear();
      let id="";
      await runTransaction(db,async(tx)=>{
        const snap=await tx.get(ref);
        const last=snap.exists()?(snap.data().lastContractNum||0):0;
        const next=last+1;
        tx.set(ref,{lastContractNum:next},{merge:true});
        id=`CON-${year}-${String(next).padStart(3,"0")}`;
      });
      return id;
    }

    // 🔹 Signatures
    function setupSignature(id,dateId){
      const canvas=$(id),ctx=canvas.getContext("2d");
      let drawing=false;
      const start=(x,y)=>{drawing=true;ctx.moveTo(x,y);ctx.beginPath();
        if(dateId)$(dateId).textContent=new Date().toLocaleDateString();
      };
      const draw=(x,y)=>{if(!drawing)return;ctx.lineTo(x,y);ctx.stroke();};
      canvas.addEventListener("mousedown",e=>start(e.offsetX,e.offsetY));
      canvas.addEventListener("mousemove",e=>draw(e.offsetX,e.offsetY));
      canvas.addEventListener("mouseup",()=>drawing=false);
      canvas.addEventListener("mouseleave",()=>drawing=false);
    }

    // 🔹 Load Clients for dropdown
    async function loadClients(uid){
      const snap=await getDocs(collection(db,"users",uid,"clients"));
      const sel=$("clientSelect");
      sel.innerHTML=`<option value="">Select Client</option>`;
      snap.forEach(d=>{
        const c=d.data();
        const opt=document.createElement("option");
        opt.value=d.id;
        opt.textContent=c.clientName||"Unnamed";
        sel.appendChild(opt);
      });
    }

    // 🔹 Auto-fill Client Info
    async function fillClient(uid,id){
      if(!id)return;
      const snap=await getDoc(doc(db,"users",uid,"clients",id));
      if(!snap.exists())return;
      const c=snap.data();
      $("description").value=`Project for ${c.clientName}, located in ${c.country||"N/A"}.`;
    }

    // 🔹 Auto-fill Business Info from Profile
    async function loadProfile(uid){
      const snap=await getDoc(doc(db,"users",uid,"profile","data"));
      if(!snap.exists())return;
      const p=snap.data();
      $("businessName").value=p.businessName||"";
      $("businessEmail").value=p.email||"";
      $("businessAddress").value=p.address||"";
      $("kvk").value=p.kvk||"";
      $("vat").value=p.vat||"";
    }

    // 🔹 Save Contract
    async function saveContract(uid){
      const idField=$("contractId");
      let cid=idField.value;
      if(!cid)cid=await generateContractId(uid);
      const data={
        contractId:cid,
        title:$("title").value,
        clientId:$("clientSelect").value,
        amount:$("amount").value,
        dueDate:$("dueDate").value,
        status:$("status").value,
        description:$("description").value,
        deliverables:$("deliverables").value,
        paymentTerms:$("paymentTerms").value,
        legal:$("legal").value,
        createdAt:serverTimestamp(),
        updatedAt:serverTimestamp()
      };
      await addDoc(collection(db,"users",uid,"contracts"),data);
      showMsg("✅ Contract saved!");
      setTimeout(()=>location.href="contracts-list.html",800);
    }

    // 🔹 Clear
    function clearAll(){document.querySelectorAll("input,textarea,select").forEach(e=>{if(e.id!=="status")e.value="";});}

    // 🔹 Auth
    onAuthStateChanged(auth,async(user)=>{
      if(!user){location.href="login.html";return;}
      await loadProfile(user.uid);
      await loadClients(user.uid);
      const id=await generateContractId(user.uid);
      $("contractId").value=id;
      setupSignature("freelancerSign","freelancerDate");
      setupSignature("clientSign","clientDate");
      $("clientSelect").onchange=()=>fillClient(user.uid,$("clientSelect").value);
      $("saveBtn").onclick=()=>saveContract(user.uid);
      $("clearBtn").onclick=clearAll;
    });
  </script>
</body>
</html>
