<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📄 SmartWerk — Freelance Contract (PRO)</title>

  <style>
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: 'Inter', sans-serif;
      padding: 20px;
    }
    h1, h2 { color: #fff; }
    section {
      background: #1e293b;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    input, select, textarea {
      width: 100%;
      background: #334155;
      border: none;
      border-radius: 6px;
      padding: 8px;
      color: #fff;
      margin-top: 4px;
    }
    label { color: #94a3b8; font-size: 14px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn {
      background: #475569;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-primary { background: #3b82f6; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }

    /* Signature areas */
    .signature-block {
      background: #f8fafc;
      color: #000;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
    }
    canvas {
      background: #fff;
      border: 1px solid #cbd5e1;
      width: 100%;
      height: 120px;
      border-radius: 6px;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <header>
    <h1>📄 Freelance Contract</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="contracts-list.html" class="btn">📂 View Saved Contracts</a>
    </nav>
  </header>

  <main>
    <!-- CONTRACT INFO -->
    <section>
      <h2>📑 Contract Info</h2>
      <div class="grid-2">
        <div>
          <label>Contract ID</label>
          <input id="contractId" readonly placeholder="CON-2025-001"/>
        </div>
        <div>
          <label>Status</label>
          <select id="status">
            <option>Draft</option>
            <option>Signed</option>
            <option>Cancelled</option>
            <option>Archived</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Start Date</label>
          <input type="date" id="startDate"/>
        </div>
        <div>
          <label>End Date</label>
          <input type="date" id="endDate"/>
        </div>
      </div>
    </section>

    <!-- BUSINESS INFO -->
    <section>
      <h2>🏢 Business Info</h2>
      <div class="grid-2">
        <div>
          <label>Business Name</label>
          <input id="businessName"/>
        </div>
        <div>
          <label>Email</label>
          <input id="businessEmail" type="email"/>
        </div>
      </div>
      <label>Address</label>
      <input id="businessAddress" placeholder="Street, City"/>
    </section>

    <!-- CLIENT INFO -->
    <section>
      <h2>👤 Client Info</h2>
      <label>Select Client</label>
      <select id="clientSelect"><option>Loading clients...</option></select>
      <div class="grid-2" style="margin-top:10px;">
        <div><label>Client Name</label><input id="clientName"/></div>
        <div><label>Client Email</label><input id="clientEmail"/></div>
      </div>
      <label>Client Address</label>
      <input id="clientAddress" placeholder="Street, City"/>
    </section>

    <!-- PROJECT DETAILS -->
    <section>
      <h2>💼 Project Details</h2>
      <label>Project Title</label>
      <input id="projectTitle" placeholder="e.g. Web Development Project"/>
      <label>Project Description</label>
      <textarea id="projectDesc" rows="4" placeholder="Brief description of the project..."></textarea>
    </section>

    <!-- PAYMENT TERMS -->
    <section>
      <h2>💳 Payment Terms</h2>
      <div class="grid-2">
        <div>
          <label>Rate (€)</label>
          <input id="rate" type="number" step="0.01" placeholder="e.g. 50"/>
        </div>
        <div>
          <label>Hours</label>
          <input id="hours" type="number" step="1" placeholder="e.g. 100"/>
        </div>
      </div>
      <label>Payment Terms</label>
      <select id="paymentTerms">
        <option>14 days</option>
        <option selected>30 days</option>
        <option>60 days</option>
        <option>On completion</option>
      </select>
      <p style="margin-top:10px;">Total: <span id="totalDisplay">€0.00</span></p>
    </section>

    <!-- LEGAL -->
    <section>
      <h2>⚖️ Legal Terms</h2>
      <p>This contract is governed by the laws of the Netherlands. Intellectual property created during this project will remain with the freelancer until full payment is received. Both parties agree to confidentiality regarding shared business or technical information.</p>
    </section>

    <!-- SIGNATURES -->
    <section>
      <h2>✍️ Signatures</h2>
      <div class="grid-2">
        <div class="signature-block">
          <strong>Freelancer Signature</strong>
          <canvas id="freelancerSign"></canvas>
          <p>Date: <span id="freelancerDate"></span></p>
        </div>
        <div class="signature-block">
          <strong>Client Signature</strong>
          <canvas id="clientSign"></canvas>
          <p>Date: <span id="clientDate"></span></p>
        </div>
      </div>
      <div class="actions">
        <button id="clearBtn" class="btn">🧹 Clear Signatures</button>
      </div>
    </section>

    <div class="actions">
      <button id="saveBtn" class="btn-primary">💾 Save Contract</button>
      <a href="contracts-list.html" class="btn">📂 View Saved Contracts</a>
    </div>
  </main>

  <div id="toast"></div>

  <!-- FIREBASE LOGIC -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, setDoc, addDoc, runTransaction, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = id => document.getElementById(id);
    const toast = msg => { const t=$("toast");t.textContent=msg;t.style.display="block";setTimeout(()=>t.style.display="none",2500); };

    async function generateContractId(uid){
      const ref = doc(db, "users", uid);
      const year = new Date().getFullYear();
      let id="";
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastContractNumber||0) : 0;
        const next = last + 1;
        tx.set(ref, { lastContractNumber: next }, { merge:true });
        id = `CON-${year}-${String(next).padStart(3,"0")}`;
      });
      return id;
    }

    function setupCanvas(canvasId, dateId){
      const c=$(canvasId);
      if(!c) return;
      const ctx=c.getContext("2d");
      let drawing=false;
      c.addEventListener("mousedown",e=>{drawing=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY); if($(dateId)) $(dateId).textContent=new Date().toLocaleDateString();});
      c.addEventListener("mousemove",e=>{if(drawing){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}});
      c.addEventListener("mouseup",()=>drawing=false);
      c.addEventListener("mouseleave",()=>drawing=false);
    }

    async function loadClients(uid){
      const sel=$("#clientSelect");
      const snap=await getDocs(collection(db,"users",uid,"clients"));
      sel.innerHTML=`<option value="">Select Client</option>`;
      snap.forEach(d=>{
        const c=d.data();
        const opt=document.createElement("option");
        opt.value=d.id;
        opt.textContent=c.clientName || c.email || "Unnamed";
        sel.appendChild(opt);
      });
      sel.onchange=async()=>{
        const id=sel.value;
        if(!id)return;
        const cSnap=await getDoc(doc(db,"users",uid,"clients",id));
        if(cSnap.exists()){
          const c=cSnap.data();
          $("#clientName").value=c.clientName||"";
          $("#clientEmail").value=c.email||"";
          $("#clientAddress").value=c.address||"";
        }
      };
    }

    async function autofillProfile(uid){
      const snap=await getDoc(doc(db,"users",uid,"profile","main"));
      if(!snap.exists()) return;
      const p=snap.data();
      $("#businessName").value=p.businessName||p.fullName||"";
      $("#businessEmail").value=p.email||p.businessEmail||"";
      $("#businessAddress").value=p.address||p.businessAddress||"";
    }

    async function saveContract(uid){
      const id=$("#contractId").value;
      const data={
        contractId:id,
        status:$("#status").value,
        startDate:$("#startDate").value,
        endDate:$("#endDate").value,
        businessName:$("#businessName").value,
        businessEmail:$("#businessEmail").value,
        businessAddress:$("#businessAddress").value,
        clientName:$("#clientName").value,
        clientEmail:$("#clientEmail").value,
        clientAddress:$("#clientAddress").value,
        projectTitle:$("#projectTitle").value,
        projectDesc:$("#projectDesc").value,
        rate:parseFloat($("#rate").value)||0,
        hours:parseFloat($("#hours").value)||0,
        total:(parseFloat($("#rate").value)||0)*(parseFloat($("#hours").value)||0),
        paymentTerms:$("#paymentTerms").value,
        createdAt:serverTimestamp(),
        updatedAt:serverTimestamp()
      };
      await addDoc(collection(db,"users",uid,"contracts"),data);
      toast("✅ Contract saved");
      setTimeout(()=>location.href="contracts-list.html",800);
    }

    onAuthStateChanged(auth, async user=>{
      if(!user){location.href="login.html";return;}
      const uid=user.uid;
      $("#contractId").value=await generateContractId(uid);
      setupCanvas("freelancerSign","freelancerDate");
      setupCanvas("clientSign","clientDate");
      $("#clearBtn").onclick=()=>{["freelancerSign","clientSign"].forEach(id=>{const c=$(id);c.getContext("2d").clearRect(0,0,c.width,c.height);});};
      await loadClients(uid);
      await autofillProfile(uid);
      $("#rate").oninput=$("#hours").oninput=()=>$("#totalDisplay").textContent="€"+(((parseFloat($("#rate").value)||0)*(parseFloat($("#hours").value)||0)).toFixed(2));
      $("#saveBtn").onclick=()=>saveContract(uid);
    });
  </script>
</body>
</html>
