<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk â€” Quote / Offer</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>ğŸ“„ SmartWerk Quote / Offer</h1>
    <nav>
      <a href="index.html" class="btn">â† Main Page</a>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="quote-offer-list.html" class="btn">ğŸ“‹ Saved Quotes</a>
    </nav>
  </header>

  <main>
      <form id="quoteForm" onsubmit="return false;">
    <!-- Business Info -->
     <section class="collapsible">
  <button type="button" class="section-toggle">
  <span>ğŸ¢ Business Info</span>
  <span class="toggle-icon">â–¶ï¸</span>
</button>
  <div class="section-content">
    
      <input id="businessName" name="businessName" placeholder="Business Name" autocomplete="organization"/>
      <input id="kvk" name="kvk" placeholder="KvK Number" autocomplete="off"/>
      <input id="iban" name="iban" placeholder="IBAN" autocomplete="iban"/>
      <input id="btw" name="btw" placeholder="BTW" autocomplete="off"/>
      <input id="email" name="email" placeholder="Business Email" autocomplete="email"/>
      <input id="businessAddress" name="businessAddress" placeholder="Business Address" autocomplete="street-address"/>
      <input id="businessPhone" name="businessPhone" placeholder="Business Phone" autocomplete="tel"/>
</div>
    </section>

    <!-- Client Info -->
     <section class="collapsible">
  <button type="button" class="section-toggle">
  <span>ğŸ‘¤ Client Info</span>
  <span class="toggle-icon">â–¶ï¸</span>
</button>
  <div class="section-content">
      <input id="clientName" name="clientName" placeholder="Client Name" autocomplete="name"/>
      <input id="clientEmail" name="clientEmail" placeholder="Client Email" autocomplete="email"/>
      <input id="clientPhone" name="clientPhone" placeholder="Client Phone" autocomplete="tel"/>
      <input id="clientAddress" name="clientAddress" placeholder="Client Address" autocomplete="street-address"/>

      <input id="quoteDate" name="quoteDate" class="js-date" placeholder="YYYY-MM-DD" autocomplete="off"/>
      <input id="validUntil" name="validUntil" class="js-date" placeholder="Valid Until" autocomplete="off"/>


      <input id="quoteNumber" name="quoteNumber" readonly placeholder="Quote Number" autocomplete="off"/>
        <select id="status" name="status" autocomplete="off">
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Accepted">Accepted</option>
        <option value="Rejected">Rejected</option>
      </select>
      </div>
    </section>

    <!-- Items -->
    <section>
      <h2>ğŸ“ Items</h2>
      <table>
        <thead>
          <tr><th>Description</th><th>Qty</th><th>Price</th><th>VAT %</th><th>Total</th><th></th></tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button type="button" onclick="addItem()">â• Add Item</button>
    </section>

    <!-- Summary -->
    <section>
      <h2>ğŸ“¦ Summary</h2>
      <p>Subtotal: <span id="subtotal">â‚¬0.00</span></p>
      <p>Total VAT: <span id="totalVat">â‚¬0.00</span></p>
      <p>Total: <span id="grandTotal">â‚¬0.00</span></p>
      <textarea id="note" name="note" placeholder="Notes..." autocomplete="off"></textarea>
    </section>

    <!-- Signatures -->
         <h2>âœï¸ Signatures</h2>
    <section class="signatures">
      <div>
        <h3>Business</h3>
        <canvas id="signatureBusiness" name="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>
        <h3>Client</h3>
        <canvas id="signatureClient" name="signatureClient" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step actions">
      <button id="saveBtn" class="btn-primary">ğŸ’¾ Save Quote</button>
      <a href="quote-offer-list.html" class="btn">ğŸ“‹ Saved Quotes</a>
    </section>
        
          </form>
  </main>

  <footer>
    <p>Â© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
   import {getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot, serverTimestamp, runTransaction, setLogLevel
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
setLogLevel("error");
    
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    /* ITEMS */
   function addItem(desc = "", qty = 1, price = 0, vat = 21) {
  const uid = Date.now(); // Ğ°Ğ±Ğ¾ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒĞ¹ random string
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input id="desc-${uid}" class="desc" name="itemDesc[]" value="${desc}" autocomplete="off" /></td>
    <td><input id="qty-${uid}" class="qty" name="itemQty[]" type="number" value="${qty}" autocomplete="off" /></td>
    <td><input id="price-${uid}" class="price" name="itemPrice[]" type="number" value="${price}" autocomplete="off" /></td>
    <td>
      <select id="vat-${uid}" class="vat" name="itemVat[]" autocomplete="off">
        <option value="0"${vat == 0 ? " selected" : ""}>0</option>
        <option value="9"${vat == 9 ? " selected" : ""}>9</option>
        <option value="21"${vat == 21 ? " selected" : ""}>21</option>
      </select>
    </td>
    <td class="item-total">â‚¬0.00</td>
    <td><button type="button" class="btn-del">âŒ</button></td>
  `;
  tr.querySelectorAll("input,select").forEach(el => el.addEventListener("input", updateTotals));
  tr.querySelector(".btn-del").addEventListener("click", () => {
    tr.remove();
    updateTotals();
  });
  $("itemsBody").appendChild(tr);
  updateTotals();
}
    window.addItem=addItem;

    function updateTotals(){
      let subtotal=0, totalVat=0;
      document.querySelectorAll("#itemsBody tr").forEach(tr=>{
        const qty=parseFloat(tr.querySelector(".qty").value)||0;
        const price=parseFloat(tr.querySelector(".price").value)||0;
        const vat=parseFloat(tr.querySelector(".vat").value)||0;
        const line=qty*price;
        const v=line*vat/100;
        subtotal+=line; totalVat+=v;
        tr.querySelector(".item-total").innerText="â‚¬"+(line+v).toFixed(2);
      });
      $("subtotal").innerText="â‚¬"+subtotal.toFixed(2);
      $("totalVat").innerText="â‚¬"+totalVat.toFixed(2);
      $("grandTotal").innerText="â‚¬"+(subtotal+totalVat).toFixed(2);
    }
    window.updateTotals=updateTotals;

    /* SIGNATURES */
    function setupSignature(canvasId,dateId){
      const c=$(canvasId); const ctx=c.getContext("2d");
      let drawing=false;
      const start=()=>{drawing=true;ctx.beginPath();};
      const end=()=>{if(!drawing)return;drawing=false;$(dateId).innerText=new Date().toLocaleDateString("nl-NL");};
      const move=(e)=>{if(!drawing)return;const r=c.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;ctx.lineWidth=2;ctx.lineCap="round";ctx.strokeStyle="#000";ctx.lineTo(x,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y);};
      c.addEventListener("mousedown",start);c.addEventListener("mouseup",end);c.addEventListener("mouseleave",()=>drawing=false);c.addEventListener("mousemove",move);
      c.addEventListener("touchstart",(e)=>{e.preventDefault();start();});
      c.addEventListener("touchend",(e)=>{e.preventDefault();end();});
      c.addEventListener("touchmove",(e)=>{e.preventDefault();move(e);});
    }
    window.clearSignature=(id)=>{const c=$(id);c.getContext("2d").clearRect(0,0,c.width,c.height);if(id==="signatureBusiness")$("signatureBusinessDate").innerText="";if(id==="signatureClient")$("signatureClientDate").innerText="";};

    /* NUMBER GENERATION */
    async function previewNextQuoteNumber(uid){
      try{
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        const last = snap.exists()? (snap.data().lastQuoteNumber||0) : 0;
        const next = last + 1;
        const p = `QUO-${new Date().getFullYear()}-${String(next).padStart(3,"0")}`;
        if(!$("quoteNumber").value) $("quoteNumber").placeholder = p;
      }catch{}
    }

    async function generateQuoteNumber(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out = "";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastQuoteNumber||0) : 0;
        const next = last + 1;
        tx.set(ref,{ lastQuoteNumber: next },{ merge:true });
        out = `QUO-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    /* SAVE */
    async function saveQuote(){
      const user=auth.currentUser;if(!user){location.href="login.html";return;}
      const uid=user.uid;

      const items=[];document.querySelectorAll("#itemsBody tr").forEach(tr=>{
        items.push({
          desc:tr.querySelector(".desc")?.value||"",
          qty:parseFloat(tr.querySelector(".qty")?.value)||0,
          price:parseFloat(tr.querySelector(".price")?.value)||0,
          vat:parseFloat(tr.querySelector(".vat")?.value)||0
        });
      });

      const subtotal=parseFloat($("subtotal").innerText.replace(/[^\d.-]/g,""))||0;
      const totalVat=parseFloat($("totalVat").innerText.replace(/[^\d.-]/g,""))||0;
      const grandTotal=subtotal+totalVat;

      let quoteNumber = $("quoteNumber").value.trim();
      const editingId = localStorage.getItem("editQuoteId") || null;
      if(!editingId && !quoteNumber){
        quoteNumber = await generateQuoteNumber(uid);
        $("quoteNumber").value = quoteNumber;
      }

      const businessSig=$("signatureBusiness").toDataURL();
      const clientSig=$("signatureClient").toDataURL();

      const data={
        businessName:$("businessName").value,
        kvk:$("kvk").value,
        iban:$("iban").value,
        btw:$("btw").value,
        email:$("email").value,
        businessAddress:$("businessAddress").value,
        businessPhone:$("businessPhone").value,

        clientName:$("clientName").value,
        clientEmail:$("clientEmail").value,
        clientPhone:$("clientPhone").value,
        clientAddress:$("clientAddress").value,

        quoteDate:$("quoteDate").value,
        validUntil:$("validUntil").value,
        quoteNumber,
        status:$("status").value,
        note:$("note").value,

        items, subtotal,totalVat,grandTotal,
        subtotalFormatted:"â‚¬"+subtotal.toFixed(2),
        totalVatFormatted:"â‚¬"+totalVat.toFixed(2),
        grandTotalFormatted:"â‚¬"+grandTotal.toFixed(2),

        signatures:{
          business: businessSig,
          client: clientSig,
          businessDate:$("signatureBusinessDate").innerText||"",
          clientDate:$("signatureClientDate").innerText||""
        },

        userId:uid,
        updatedAt:new Date().toISOString(),
      };
      await logEvent(uid,"Quote","Created or updated "+quoteNumber);

      if(editingId){
        await setDoc(doc(db,"users",uid,"quotes",editingId), data, { merge:true });
        alert("âœ… Quote updated");
      }else{
        await addDoc(collection(db,"users",uid,"quotes"), data);
        alert(`âœ… Quote saved as ${quoteNumber}`);
      }

      localStorage.removeItem("editQuoteId");
      location.href="quote-offer-list.html";
    }
    window.saveQuote=saveQuote;

    /* LOAD FOR EDIT */
    async function loadQuoteForEdit(uid){
      const id = localStorage.getItem("editQuoteId");
      if(!id) return;
      const snap = await getDoc(doc(db,"users",uid,"quotes",id));
      if(!snap.exists()){ localStorage.removeItem("editQuoteId"); return; }
      const q = snap.data();

      $("businessName").value = q.businessName||"";
      $("kvk").value = q.kvk||"";
      $("iban").value = q.iban||"";
      $("btw").value = q.btw||"";
      $("email").value = q.email||"";
      $("businessAddress").value = q.businessAddress||"";
      $("businessPhone").value = q.businessPhone||"";

      $("clientName").value = q.clientName||"";
      $("clientEmail").value = q.clientEmail||"";
      $("clientPhone").value = q.clientPhone||"";
      $("clientAddress").value = q.clientAddress||"";

      $("quoteDate").value = q.quoteDate||"";
      $("validUntil").value = q.validUntil||"";
      $("quoteNumber").value = q.quoteNumber||"";
      $("status").value = q.status||"Draft";
      $("note").value = q.note||"";

      $("itemsBody").innerHTML="";
      (q.items||[]).forEach(it=>addItem(it.desc,it.qty,it.price,it.vat));
      if(!(q.items||[]).length) addItem();

      if(q.signatures?.business){
        const img=new Image();
        img.onload=()=>{const c=$("signatureBusiness");const ctx=c.getContext("2d");ctx.clearRect(0,0,c.width,c.height);ctx.drawImage(img,0,0);};
        img.src=q.signatures.business;
        $("signatureBusinessDate").innerText=q.signatures.businessDate||"";
      }
      if(q.signatures?.client){
        const img=new Image();
        img.onload=()=>{const c=$("signatureClient");const ctx=c.getContext("2d");ctx.clearRect(0,0,c.width,c.height);ctx.drawImage(img,0,0);};
        img.src=q.signatures.client;
        $("signatureClientDate").innerText=q.signatures.clientDate||"";
      }

      updateTotals();
    }
    

    /* INIT */
async function loadBusinessInfo(uid){
  const snap = await getDoc(doc(db,"users",uid));
  if(!snap.exists()) return;
  const p = snap.data();
  $("businessName").value = p.businessName || "";
  $("email").value = p.email || "";
  $("iban").value = p.iban || "";
  $("btw").value = p.btw || "";
  $("kvk").value = p.kvk || "";
  $("businessAddress").value = p.businessAddress || "";
  $("businessPhone").value = p.businessPhone || "";
}
onAuthStateChanged(auth, async (user)=>{
  if(user){ await loadBusinessInfo(user.uid); }
});

async function logEvent(uid, type, message){
  try{
    await addDoc(collection(db,"users",uid,"events"),{
      type, message, createdAt: serverTimestamp()
    });
  }catch(e){ console.warn("Event log error:", e); }
}
    // ğŸŒ¿ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğµ Ğ¿Ñ–Ğ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°, ÑĞºÑ‰Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾ Ğ·Ñ– ÑĞ¿Ğ¸ÑĞºÑƒ
document.addEventListener("DOMContentLoaded", () => {
  const savedClient = localStorage.getItem("selectedClient");
  if (savedClient) {
    const c = JSON.parse(savedClient);
    if ($("clientName")) $("clientName").value = c.clientName || "";
    if ($("clientEmail")) $("clientEmail").value = c.email || "";
    if ($("clientPhone")) $("clientPhone").value = c.phone || "";
    if ($("clientAddress")) $("clientAddress").value = c.address || "";
    localStorage.removeItem("selectedClient");
    console.log("âœ… Client data autofilled into Quote / Offer");
  }
});

     document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".section-toggle").forEach(button => {
    button.addEventListener("click", () => {
      const content = button.nextElementSibling;
      const icon = button.querySelector('.toggle-icon');
      const isOpen = content.classList.toggle("open");
      icon.textContent = isOpen ? "ğŸ”½" : "â–¶ï¸";
    });
  });
});
    
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }

      flatpickr(".js-date",{dateFormat:"Y-m-d"});
      setupSignature("signatureBusiness","signatureBusinessDate");
      setupSignature("signatureClient","signatureClientDate");
      if(!document.querySelector("#itemsBody tr")) addItem();
      updateTotals();

      await previewNextQuoteNumber(user.uid);
      await loadQuoteForEdit(user.uid);
    });

    document.addEventListener("DOMContentLoaded", ()=>{
  $("saveBtn")?.addEventListener("click",(e)=>{e.preventDefault();saveQuote();});
});
  </script>
</body>
</html>
