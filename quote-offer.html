<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartWerk — Quote / Offer</title>
  <link rel="stylesheet" href="style-quote-offer.css" />
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <a class="brand" href="templates.html">📄 SmartWerk Quote / Offer</a>
      <nav class="right">
        <a href="dashboard.html" class="btn">← Back to Dashboard</a>
      </nav>
    </header>

    <section class="intro">
      <h1>📄 Create a Quote / Offer 
        <span class="info-icon" title="A quote is a professional offer sent before an invoice.">ℹ️</span>
      </h1>
      <p class="muted">Use this tool to create a professional offer for your client before sending an invoice.</p>
      <p class="quote-valid">🗓️ Valid until: <span id="validUntil"></span></p>
    </section>

    <form id="quoteForm">
      <div class="form-section">
        <h2>🧾 Business Info</h2>
        <input type="text" id="businessName" placeholder="Your Business Name" required />
        <input type="text" id="businessKvK" placeholder="KvK Number (optional)" />
        <input type="text" id="businessVAT" placeholder="VAT Number (optional)" />
        <input type="text" id="businessIBAN" placeholder="IBAN (optional)" />
        <input type="text" id="businessPhone" placeholder="Phone (optional)" />
        <input type="text" id="businessAddress" placeholder="Address (optional)" />
      </div>

      <div class="form-section">
        <h2>👤 Client Info</h2>
        <input type="text" id="clientName" placeholder="Client Name" required />
        <input type="text" id="clientEmail" placeholder="Client Email (optional)" />
        <input type="text" id="clientPhone" placeholder="Client Phone (optional)" />
        <input type="text" id="clientAddress" placeholder="Client Address (optional)" />
      </div>

      <div class="form-section">
        <h2>📋 Services</h2>
        <table id="servicesTable">
          <thead>
            <tr><th>Description</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr>
          </thead>
          <tbody id="itemsContainer">
            <!-- Items will be injected here -->
          </tbody>
        </table>
        <button type="button" id="addItemBtn" class="btn ghost">+ Add Item</button>
      </div>

      <div class="form-section">
        <h2>🧮 Summary</h2>
        <p>Subtotal: <strong><span id="subtotal">€0.00</span></strong></p>
        <p>VAT (21%): <strong><span id="vat">€0.00</span></strong></p>
        <p><strong>Total: <span id="total">€0.00</span></strong></p>
        <p>Currency: 
          <select id="currency">
            <option value="EUR">EUR (€)</option>
            <option value="USD">USD ($)</option>
            <option value="GBP">GBP (£)</option>
          </select>
        </p>
      </div>

      <div class="form-section">
        <h2>📝 Quote Settings</h2>
        <input type="text" id="quoteNumber" placeholder="Quote Number (e.g. QUOTE-2025-001)" />
        <select id="quoteStatus">
          <option value="draft">Draft</option>
          <option value="sent">Sent</option>
          <option value="accepted">Accepted</option>
        </select>
        <span id="statusBadge" class="status-badge draft">● Draft</span>
      </div>

      <div class="form-section">
        <h2>📝 Note to Client</h2>
        <textarea id="clientNote" placeholder="This quote is valid for 14 days... (optional)"></textarea>
      </div>

      <div class="form-section">
        <h2>✍️ Signatures</h2>
        <input type="text" id="signatureName" placeholder="Your Name / Signature" required />
        <input type="text" id="clientSignature" placeholder="Client Name / Signature (optional)" />
        <p>Signature Date: <span id="signatureDate"></span></p>
      </div>

      <div class="actions">
        <button type="submit" class="btn primary">💾 Save</button>
        <button type="button" class="btn" id="previewBtn">👁 Preview</button>
        <button type="button" class="btn" id="generatePDFBtn">📄 Export PDF</button>
        <button type="button" class="btn ghost" id="aiDraftBtn">⚡ AI Draft</button>
      </div>
    </form>

    <footer class="foot-note">
      <p class="muted">Generated with SmartWerk — smartwerk.nl</p>
    </footer>
  </div>

  <script>
    // Дата підпису
    document.getElementById("signatureDate").textContent = new Date().toLocaleDateString();

    // Статус-мітка
    const statusSelect = document.getElementById("quoteStatus");
    const statusBadge = document.getElementById("statusBadge");
    const updateStatusColor = () => {
      const val = statusSelect.value;
      statusBadge.textContent = `● ${val.charAt(0).toUpperCase() + val.slice(1)}`;
      statusBadge.className = "status-badge " + val;
    };
    statusSelect.addEventListener("change", updateStatusColor);
    updateStatusColor(); // on load

    // Валід до
    const validUntil = new Date();
    validUntil.setDate(validUntil.getDate() + 14);
    document.getElementById("validUntil").textContent = validUntil.toLocaleDateString();

// ========== DOM Elements ==========
const addItemBtn = document.getElementById("addItemBtn");
const itemsContainer = document.getElementById("itemsContainer");
const subtotalEl = document.getElementById("subtotal");
const vatEl = document.getElementById("vat");
const totalEl = document.getElementById("total");
const aiDraftBtn = document.getElementById("aiDraftBtn");
const generatePDFBtn = document.getElementById("generatePDFBtn");
const quoteForm = document.getElementById("quoteForm");
const signatureName = document.getElementById("signatureName");
const quoteStatus = document.getElementById("quoteStatus");

// ========== Utility Functions ==========
function createItemRow(desc = "", qty = 1, price = 0.00) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="text" class="desc" value="${desc}" /></td>
    <td><input type="number" class="qty" value="${qty}" min="1" /></td>
    <td><input type="number" class="price" value="${price}" step="0.01" /></td>
    <td class="rowTotal">0.00</td>
    <td><button type="button" class="remove-btn">×</button></td>
  `;

  // Events
  tr.querySelectorAll("input").forEach(input => {
    input.addEventListener("input", calculateTotals);
  });

  tr.querySelector(".remove-btn").addEventListener("click", () => {
    tr.remove();
    calculateTotals();
  });

  return tr;
}

function calculateTotals() {
  let subtotal = 0;
  document.querySelectorAll("#itemsContainer tr").forEach(row => {
    const qty = parseFloat(row.querySelector(".qty").value) || 0;
    const price = parseFloat(row.querySelector(".price").value) || 0;
    const total = qty * price;
    row.querySelector(".rowTotal").textContent = total.toFixed(2);
    subtotal += total;
  });
  const vat = subtotal * 0.21;
  const grandTotal = subtotal + vat;

  subtotalEl.textContent = subtotal.toFixed(2);
  vatEl.textContent = vat.toFixed(2);
  totalEl.textContent = grandTotal.toFixed(2);
}

// ========== Events ==========
addItemBtn.addEventListener("click", () => {
  const row = createItemRow();
  itemsContainer.appendChild(row);
  calculateTotals();
});

aiDraftBtn.addEventListener("click", () => {
  const examples = [
    ["Website Design", 1, 750],
    ["SEO Optimization", 1, 250],
    ["Content Setup", 1, 150]
  ];
  itemsContainer.innerHTML = "";
  examples.forEach(([desc, qty, price]) => {
    const row = createItemRow(desc, qty, price);
    itemsContainer.appendChild(row);
  });
  calculateTotals();
});

generatePDFBtn.addEventListener("click", () => {
  if (typeof exportQuotePDF === "function") {
    exportQuotePDF();
  } else {
    alert("PDF export not available.");
  }
});

// ========== Save to LocalStorage ==========
quoteForm.addEventListener("submit", (e) => {
  e.preventDefault();

  const quote = {
    businessName: document.getElementById("businessName").value,
    businessKvK: document.getElementById("businessKvK").value,
    businessVAT: document.getElementById("businessVAT").value,
    businessIBAN: document.getElementById("businessIBAN").value,
    clientName: document.getElementById("clientName").value,
    clientEmail: document.getElementById("clientEmail").value,
    services: [],
    note: document.getElementById("clientNote").value,
    signature: signatureName.value,
    status: quoteStatus.value,
    validUntil: document.getElementById("validUntil").textContent,
    total: totalEl.textContent
  };

  document.querySelectorAll("#itemsContainer tr").forEach(row => {
    quote.services.push({
      desc: row.querySelector(".desc").value,
      qty: row.querySelector(".qty").value,
      price: row.querySelector(".price").value
    });
  });

  const savedQuotes = JSON.parse(localStorage.getItem("savedQuotes") || "[]");
  savedQuotes.push(quote);
  localStorage.setItem("savedQuotes", JSON.stringify(savedQuotes));
  alert("✅ Quote saved successfully!");
});

// ========== Lock Signature if Sent or Accepted ==========
quoteStatus.addEventListener("change", () => {
  const locked = ["sent", "accepted"].includes(quoteStatus.value);
  signatureName.disabled = locked;
});

// ========== Init ==========
window.addEventListener("DOMContentLoaded", () => {
  const defaultRow = createItemRow();
  itemsContainer.appendChild(defaultRow);
  calculateTotals();

  // Set validUntil
  const validDate = new Date();
  validDate.setDate(validDate.getDate() + 14);
  document.getElementById("validUntil").textContent = validDate.toLocaleDateString();

  // Apply lock logic
  const locked = ["sent", "accepted"].includes(quoteStatus.value);
  signatureName.disabled = locked;
});

    import jsPDF from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js";
import autoTable from "https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js";

window.exportQuotePDF = function () {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // ==== Основна інформація ====
  const businessName = document.getElementById("businessName").value || "SmartWerk User";
  const clientName = document.getElementById("clientName").value || "Client";
  const clientEmail = document.getElementById("clientEmail").value || "";
  const note = document.getElementById("clientNote").value || "";
  const status = document.getElementById("quoteStatus").value || "Draft";
  const validUntil = document.getElementById("validUntil").textContent || "";

  const totalValue = document.getElementById("total").textContent || "0.00";

  // ==== Таблиця послуг ====
  const rows = [];
  document.querySelectorAll("#itemsContainer tr").forEach((row) => {
    const desc = row.querySelector(".desc").value;
    const qty = row.querySelector(".qty").value;
    const price = row.querySelector(".price").value;
    const total = (parseFloat(qty) * parseFloat(price)).toFixed(2);
    rows.push([desc, qty, `€ ${price}`, `€ ${total}`]);
  });

  // ==== Заголовок ====
  doc.setFontSize(18);
  doc.setTextColor(40);
  doc.text("📄 Quote / Offer", 14, 20);

  doc.setFontSize(11);
  doc.text(`Status: ${status}`, 14, 28);
  doc.text(`Valid until: ${validUntil}`, 14, 34);
  doc.text(`To: ${clientName}`, 14, 40);
  if (clientEmail) doc.text(`Email: ${clientEmail}`, 14, 46);

  // ==== Таблиця ====
  autoTable(doc, {
    head: [["Description", "Qty", "Price", "Total"]],
    body: rows,
    startY: 54,
    theme: "grid",
    styles: { fontSize: 10 },
  });

  // ==== Підсумок ====
  const endY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(12);
  doc.text(`Total: € ${totalValue}`, 14, endY);

  // ==== Нотатка ====
  if (note) {
    doc.setFontSize(11);
    doc.text("Note to client:", 14, endY + 10);
    doc.setFontSize(10);
    const splitNote = doc.splitTextToSize(note, 180);
    doc.text(splitNote, 14, endY + 16);
  }

  // ==== Футер ====
  doc.setFontSize(10);
  doc.setTextColor(150);
  doc.text("Generated by SmartWerk Quote Tool — smartwerk.nl", 14, 290);

  // ==== Збереження ====
  const fileName = `Quote-${clientName.replace(/\s+/g, "_")}.pdf`;
  doc.save(fileName);
};
    
  </script>

  <script type="module" src="quote-offer.js"></script>
  <script type="module" src="quote-offer-pdf.js"></script>
</body>
</html>
