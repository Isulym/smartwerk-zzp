<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Quote / Offer</title>
  <link rel="stylesheet" href="style-quote-offer.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>📑 SmartWerk Quote / Offer</h1>
    <nav>
      <a href="index.html" class="btn">← Main Page</a>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="quote-offer-list.html" class="btn">📋 Quotes List</a>
    </nav>
  </header>

  <main>
    <!-- Business Info -->
    <section>
      <h2>🏢 Business Info</h2>
      <input id="businessName" placeholder="Business Name"/>
      <input id="kvk" placeholder="KvK Number"/>
      <input id="iban" placeholder="IBAN"/>
      <input id="btw" placeholder="BTW"/>
      <input id="email" placeholder="Business Email"/>
      <input id="businessAddress" placeholder="Business Address"/>
      <input id="businessPhone" placeholder="Business Phone"/>
    </section>

    <!-- Client Info -->
    <section>
      <h2>👤 Client Info</h2>
      <input id="clientName" placeholder="Client Name"/>
      <input id="clientEmail" placeholder="Client Email"/>
      <input id="clientPhone" placeholder="Client Phone"/>
      <input id="clientAddress" placeholder="Client Address"/>
      <input id="quoteDate" class="js-date" placeholder="YYYY-MM-DD">
      <input id="dueDate" class="js-date" placeholder="YYYY-MM-DD">
      <input id="quoteNumber" readonly placeholder="Quote Number"/>
      <select id="status">
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Accepted">Accepted</option>
        <option value="Rejected">Rejected</option>
      </select>
    </section>

    <!-- Items -->
    <section>
      <h2>📝 Items</h2>
      <table>
        <thead>
          <tr><th>Description</th><th>Qty</th><th>Price</th><th>VAT %</th><th>Total</th><th></th></tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button type="button" onclick="addItem()">➕ Add Item</button>
    </section>

    <!-- Summary -->
    <section>
      <h2>📦 Summary</h2>
      <p>Subtotal: <span id="subtotal">€0.00</span></p>
      <p>Total VAT: <span id="totalVat">€0.00</span></p>
      <p>Total: <span id="grandTotal">€0.00</span></p>
      <textarea id="note" placeholder="Notes..."></textarea>
    </section>

    <!-- Signatures -->
    <section>
      <h2>✍️ Signatures</h2>
      <div>
        <h3>Business</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>
        <h3>Client</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step actions">
      <button id="saveBtn" class="btn-primary">💾 Save Quote</button>
      <a href="quote-offer-list.html" class="btn">📋 Quotes List</a>
      <button onclick="downloadPDF(true)" class="btn">📄 Export PDF</button>
      <button onclick="downloadPDF(false)" class="btn">PRO 📄 Export PDF without branding</button>
    </section>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- App -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, addDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    /* ==== Items ==== */
    function addItem(desc="", qty=1, price=0, vat=21){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><input class="desc" value="${desc}"/></td>
        <td><input class="qty" type="number" value="${qty}" min="1"/></td>
        <td><input class="price" type="number" value="${price}" step="0.01"/></td>
        <td>
          <select class="vat">
            <option value="0">0</option>
            <option value="9"${vat==9?" selected":""}>9</option>
            <option value="21"${vat==21?" selected":""}>21</option>
          </select>
        </td>
        <td class="item-total">€0.00</td>
        <td><button type="button" onclick="this.closest('tr').remove();updateTotals();">❌</button></td>
      `;
      tr.querySelectorAll("input,select").forEach(el=>el.oninput=updateTotals);
      $("itemsBody").appendChild(tr);
      updateTotals();
    }
    window.addItem=addItem;

    function updateTotals(){
      let subtotal=0,totalVat=0;
      document.querySelectorAll("#itemsBody tr").forEach(r=>{
        const qty=+r.querySelector(".qty").value||0;
        const price=+r.querySelector(".price").value||0;
        const vat=+r.querySelector(".vat").value||0;
        const line=qty*price;
        subtotal+=line; totalVat+=line*vat/100;
        r.querySelector(".item-total").innerText="€"+(line+line*vat/100).toFixed(2);
      });
      $("subtotal").innerText="€"+subtotal.toFixed(2);
      $("totalVat").innerText="€"+totalVat.toFixed(2);
      $("grandTotal").innerText="€"+(subtotal+totalVat).toFixed(2);
    }
    window.updateTotals=updateTotals;

    /* ==== Signatures ==== */
    function clearSignature(id){
      const c=$(id),ctx=c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);
      if(id==="signatureBusiness") $("signatureBusinessDate").innerText="";
      else $("signatureClientDate").innerText="";
    }
    window.clearSignature=clearSignature;

    ["signatureBusiness","signatureClient"].forEach(id=>{
      const c=$(id),ctx=c.getContext("2d");let draw=false;
      c.addEventListener("mousedown",()=>{draw=true;ctx.beginPath();});
      c.addEventListener("mouseup",()=>{draw=false;const now=new Date().toLocaleDateString();if(id==="signatureBusiness"){$("signatureBusinessDate").innerText=now;}else{$("signatureClientDate").innerText=now;}});
      c.addEventListener("mousemove",e=>{if(!draw)return;const r=c.getBoundingClientRect();ctx.lineWidth=2;ctx.lineCap="round";ctx.strokeStyle="#2563eb";ctx.lineTo(e.clientX-r.left,e.clientY-r.top);ctx.stroke();ctx.beginPath();ctx.moveTo(e.clientX-r.left,e.clientY-r.top);});
    });

    /* ==== Number generation ==== */
    async function generateQuoteNumber(uid){
      const ref=doc(db,"users",uid);
      const year=new Date().getFullYear();
      let num="";
      await runTransaction(db,async(tx)=>{
        const snap=await tx.get(ref);
        const last=snap.exists()?(snap.data().lastQuoteNumber||0):0;
        const next=last+1;
        num=`QUO-${year}-${String(next).padStart(3,"0")}`;
        tx.set(ref,{lastQuoteNumber:next},{merge:true});
      });
      return num;
    }

    /* ==== Save ==== */
    async function saveQuote(){
      const user=auth.currentUser;if(!user) return location.href="login.html";
      const uid=user.uid;

      const items=[];
      document.querySelectorAll("#itemsBody tr").forEach(r=>{
        items.push({
          desc:r.querySelector(".desc").value,
          qty:+r.querySelector(".qty").value||0,
          price:+r.querySelector(".price").value||0,
          vat:+r.querySelector(".vat").value||0
        });
      });

      const subtotal=parseFloat($("subtotal").innerText.replace(/[^\d.-]/g,""))||0;
      const totalVat=parseFloat($("totalVat").innerText.replace(/[^\d.-]/g,""))||0;
      const grandTotal=subtotal+totalVat;

      let quoteNumber=$("quoteNumber").value.trim();
      if(!quoteNumber){
        quoteNumber=await generateQuoteNumber(uid);
        $("quoteNumber").value=quoteNumber;
      }

      const data={
        businessName:$("businessName").value,
        clientName:$("clientName").value,
        quoteDate:$("quoteDate").value,
        dueDate:$("dueDate").value,
        quoteNumber,
        status:$("status").value,
        note:$("note").value,
        items,
        subtotal, totalVat, grandTotal,
        signatures:{
          business:$("signatureBusiness").toDataURL(),
          client:$("signatureClient").toDataURL(),
          businessDate:$("signatureBusinessDate").innerText||"",
          clientDate:$("signatureClientDate").innerText||"",
        },
        userId:uid,
        updatedAt:new Date().toISOString()
      };

      await addDoc(collection(db,"users",uid,"quotes"),data);
      alert("✅ Quote saved!");
      location.href="quote-offer-list.html";
    }
    window.saveQuote=saveQuote;

    /* ==== PDF ==== */
    window.downloadPDF=(withBranding=true)=>{
      const { jsPDF }=window.jspdf;
      const docPDF=new jsPDF();
      docPDF.setFontSize(18);
      docPDF.text("QUOTE / OFFER",105,15,{align:"center"});

      docPDF.autoTable({
        startY:30,
        head:[["Quote #","Date","Due","Status"]],
        body:[[
          $("quoteNumber").value,
          $("quoteDate").value,
          $("dueDate").value,
          $("status").value
        ]],
        styles:{fontSize:11,halign:"center"},
        headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"}
      });

      const items=[];
      document.querySelectorAll("#itemsBody tr").forEach(r=>{
        const desc=r.querySelector(".desc").value;
        const qty=+r.querySelector(".qty").value||0;
        const price=+r.querySelector(".price").value||0;
        const vat=+r.querySelector(".vat").value||0;
        const total=qty*price*(1+vat/100);
        items.push([desc,qty,"€"+price.toFixed(2),vat+"%","€"+total.toFixed(2)]);
      });

      docPDF.autoTable({
        startY:docPDF.lastAutoTable.finalY+10,
        head:[["Description","Qty","Unit Price","VAT","Total"]],
        body:items,
        styles:{fontSize:11,halign:"center"},
        headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"}
      });

      docPDF.text(`Subtotal: €${$("subtotal").innerText.replace(/[^\d.-]/g,"")}`,150,docPDF.lastAutoTable.finalY+10);
      docPDF.text(`VAT: €${$("totalVat").innerText.replace(/[^\d.-]/g,"")}`,150,docPDF.lastAutoTable.finalY+16);
      docPDF.text(`Total Due: €${$("grandTotal").innerText.replace(/[^\d.-]/g,"")}`,150,docPDF.lastAutoTable.finalY+22);

      if(withBranding){
        docPDF.setFontSize(10);
        docPDF.text("Generated with SmartWerk",105,290,{align:"center"});
      }

      docPDF.save(`${$("quoteNumber").value||"quote"}.pdf`);
    };

    /* ==== Init ==== */
    onAuthStateChanged(auth,(user)=>{
      if(!user) return location.href="login.html";
      flatpickr(".js-date",{dateFormat:"Y-m-d"});
      if(!document.querySelector("#itemsBody tr")) addItem();
      updateTotals();
    });
  </script>
</body>
</html>
