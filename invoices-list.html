<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“‹ SmartWerk â€” Invoices List</title>
  <link rel="stylesheet" href="style-invoices.css?v=5"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Ğ½ĞµĞ²ĞµĞ»Ğ¸Ñ‡ĞºÑ– Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ¸, ÑĞºÑ‰Ğ¾ Ğ² CSS Ğ½ĞµĞ¼Ğ°Ñ” */
    table { width:100%; border-collapse: collapse }
    th, td { padding:10px; border-bottom:1px solid rgba(255,255,255,.08) }
    th { cursor:pointer; user-select:none }
    .header-actions .btn { margin-right:8px }
    .filters label { margin-right:16px; display:inline-flex; align-items:center; gap:6px }
    .filters select, .filters input[type="month"] { padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.02); color:inherit }
    .filters button { padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03); color:inherit }
    .actions button { margin-right:6px }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“‹ Invoices List</h1>
    <div class="header-actions">
      <a href="invoices.html" class="btn">â• New Invoice</a>
      <a href="dashboard.html" class="btn">ğŸ  Back to Dashboard</a>
    </div>
  </header>

  <section class="filters">
    <h3>ğŸ” Filters</h3>
    <label>Status:
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
    </label>
    <label>Month:
      <input type="month" id="monthFilter"/>
    </label>
    <button id="resetBtn">â™»ï¸ Reset Filters</button>
  </section>

  <section>
    <table id="invoicesTable">
      <thead>
        <tr>
          <th data-sort="invoiceNumber">Invoice #</th>
          <th data-sort="clientName">Client</th>
          <th>Status</th>
          <th data-sort="invoiceDate">Date</th>
          <th data-sort="total">Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoicesBody"></tbody>
    </table>
  </section>

  <footer>
    <p>Â© 2025â€“2030 SmartWerk. All rights reserved.</p>
  </footer>

  <script type="module">
    // ==== Firebase ====
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc, setDoc } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    // ==== State ====
    let invoices = [];
    let currentSort = { field: "invoiceDate", asc: false }; // Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ â€” Ğ½Ğ¾Ğ²Ñ–ÑˆÑ– Ğ²Ğ¸Ñ‰Ğµ

    // ==== DOM ====
    const $ = s => document.querySelector(s);
    const bodyEl = $("#invoicesBody");
    const statusEl = $("#statusFilter");
    const monthEl  = $("#monthFilter");
    const resetBtn = $("#resetBtn");

    // ==== Helpers ====
    const money = v => `â‚¬${(Number(v) || 0).toFixed(2)}`;
    const ymd = s => String(s||"").slice(0,10); // Ğ¾Ñ‡Ñ–ĞºÑƒÑ”Ğ¼Ğ¾ YYYY-MM-DD

    function cmp(a,b) { return a < b ? -1 : a > b ? 1 : 0; }

    function applyFilters(list) {
      const st = statusEl.value;
      const m  = monthEl.value; // YYYY-MM

      return list.filter(inv => {
        if (st !== "all" && inv.status !== st) return false;
        if (m && !(String(inv.invoiceDate || "").startsWith(m))) return false;
        return true;
      });
    }

    function applySort(list) {
      const { field, asc } = currentSort;
      const dir = asc ? 1 : -1;
      return list.slice().sort((a,b) => {
        let A = a[field], B = b[field];
        if (field === "total") { A = Number(A)||0; B = Number(B)||0; }
        if (field === "invoiceNumber") {
          // ÑĞ¿Ñ€Ğ¾Ğ±ÑƒÑ”Ğ¼Ğ¾ Ğ°ĞºÑƒÑ€Ğ°Ñ‚Ğ½Ñ–ÑˆÑƒ ÑĞ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ´Ğ»Ñ INV-2025-001
          const pa = String(A||"").match(/(\d+)$/); 
          const pb = String(B||"").match(/(\d+)$/);
          if (pa && pb) return (Number(pa[1]) - Number(pb[1])) * dir;
        }
        return cmp(String(A||""), String(B||"")) * dir;
      });
    }

    function render() {
      bodyEl.innerHTML = "";
      const filtered = applyFilters(invoices);
      const sorted = applySort(filtered);

      sorted.forEach(inv => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${inv.invoiceNumber || "â€”"}</td>
          <td>${inv.clientName || "â€”"}</td>
          <td>${inv.status || "Draft"}</td>
          <td>${ymd(inv.invoiceDate) || "â€”"}</td>
          <td>${money(inv.total)}</td>
          <td class="actions">
            <button data-act="edit"    data-id="${inv.id}" data-num="${inv.invoiceNumber||""}">âœï¸ Edit</button>
            <button data-act="delete"  data-id="${inv.id}">ğŸ—‘ Delete</button>
            <button data-act="pdf"     data-id="${inv.id}">ğŸ“„ PDF</button>
            <button data-act="repeat"  data-id="${inv.id}" data-num="${inv.invoiceNumber||""}">ğŸ” Repeat Monthly</button>
          </td>
        `;
        bodyEl.appendChild(tr);
      });
    }

    // ==== Actions (event delegation) ====
    bodyEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-act]");
      if (!btn) return;

      const act = btn.dataset.act;
      const id  = btn.dataset.id;
      const inv = invoices.find(x => x.id === id);
      const user = auth.currentUser;
      if (!inv || !user) return;

      if (act === "edit") {
        // Ğ¢Ğ²Ñ–Ğ¹ Ñ–ÑĞ½ÑƒÑÑ‡Ğ¸Ğ¹ Ñ„Ğ»Ğ¾Ñƒ: Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ â€” Ñ‡ĞµÑ€ĞµĞ· invoiceNumber
        localStorage.setItem("editInvoiceNumber", btn.dataset.num || "");
        location.href = "invoices.html";
      }

      if (act === "delete") {
        if (!confirm("Delete this invoice?")) return;
        await deleteDoc(doc(db, "users", user.uid, "invoices", id));
      }

      if (act === "pdf") {
        // ĞŸÑ€Ğ¾ÑÑ‚Ğ¸Ğ¹ PDF (ÑĞº Ğ±ÑƒĞ»Ğ¾)
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();
        docPDF.text(`Invoice ${inv.invoiceNumber||""}`, 14, 16);
        docPDF.text(`Client: ${inv.clientName||"-"}`,   14, 24);
        docPDF.text(`Date: ${ymd(inv.invoiceDate)}`,     14, 32);
        docPDF.text(`Status: ${inv.status||"Draft"}`,   14, 40);
        docPDF.text(`Total: ${money(inv.total)}`,       14, 48);
        docPDF.save(`${inv.invoiceNumber||"invoice"}.pdf`);
      }

      if (act === "repeat") {
        // ĞšĞ¾Ğ¿Ñ–Ñ Ğ½Ğ° Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¸Ğ¹ Ğ¼Ñ–ÑÑÑ†ÑŒ Ğ· Ñ–Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ¼ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°, ÑÑ‚Ğ°Ñ‚ÑƒÑ Draft
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth()+1).padStart(2,"0");
        const d = String(today.getDate()).padStart(2,"0");

        const nextNumber = String(inv.invoiceNumber||"").replace(/\d+$/, n => String(Number(n||0)+1).padStart(3,"0"));
        const clone = {
          ...inv,
          invoiceDate: `${y}-${m}-${d}`,
          status: "Draft",
          invoiceNumber: nextNumber
        };
        delete clone.id;

        await setDoc(doc(collection(db, "users", user.uid, "invoices")), clone);
        alert("Invoice repeated for this month!");
      }
    });

    // ==== Table sorting by headers ====
    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.addEventListener("click", () => {
        const field = th.dataset.sort;
        if (currentSort.field === field) currentSort.asc = !currentSort.asc;
        else currentSort = { field, asc: true };
        render();
      });
    });

    // ==== Filters ====
    statusEl.addEventListener("change", render);
    monthEl.addEventListener("change", render);
    resetBtn.addEventListener("click", () => {
      statusEl.value = "all";
      monthEl.value = "";
      render();
    });

    // ==== Live data ====
    onAuthStateChanged(auth, (user) => {
      if (!user) { location.href = "login.html"; return; }
      const colRef = collection(db, "users", user.uid, "invoices");
      // Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: ÑĞ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñƒ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ– Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ñ– â€” Ñ‰Ğ¾Ğ±Ğ¸ Ğ½Ğ¾Ğ²Ñ– ÑˆĞ²Ğ¸Ğ´ÑˆĞµ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ğ»Ğ¸
      const q = query(colRef, orderBy("invoiceDate", "desc"));
      onSnapshot(q, (snap) => {
        invoices = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
      });
    });
  </script>
</body>
</html>
