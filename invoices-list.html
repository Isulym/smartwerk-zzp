<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“‹ SmartWerk â€” Invoices List</title>
  <link rel="stylesheet" href="style-invoices.css?v=7"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<header>
  <h1>ğŸ“‹ Invoices List</h1>
  <div class="header-actions">
    <a href="invoices.html" class="btn" onclick="localStorage.removeItem('editInvoiceId')">â• New Invoice</a>
    <a href="dashboard.html" class="btn">ğŸ  Back to Dashboard</a>
  </div>
</header>

<section class="filters">
  <h3>ğŸ“… Filters & Search</h3>
  From: <input type="date" id="fromDate">
  To: <input type="date" id="toDate">
  <label>Status:
    <select id="statusFilter">
      <option value="all">All</option>
      <option value="Draft">Draft</option>
      <option value="Sent">Sent</option>
      <option value="Paid">Paid</option>
      <option value="Reminder Sent">Reminder Sent</option>
    </select>
  </label>
  <label>Search: <input type="text" id="searchBox" placeholder="Client, number, amount"></label>
  <label>Sort by:
    <select id="sortBy">
      <option value="invoiceNumber_desc">Invoice # (new)</option>
      <option value="invoiceNumber_asc">Invoice # (old)</option>
      <option value="date_desc">Date (new)</option>
      <option value="date_asc">Date (old)</option>
      <option value="amount_desc">Amount (high â†’ low)</option>
      <option value="amount_asc">Amount (low â†’ high)</option>
    </select>
  </label>
  <button onclick="resetFilters()">â™»ï¸ Reset</button>
</section>

<section>
  <table id="invoicesTable">
    <thead>
    <tr>
      <th>Invoice #</th>
      <th>Client</th>
      <th>Status</th>
      <th>Date</th>
      <th>Total</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody id="invoicesBody"></tbody>
  </table>
</section>

<footer>
  <p>Â© 2025â€“2030 SmartWerk. All rights reserved.</p>
</footer>

<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  
  import {
    getFirestore, collection, doc, setDoc, deleteDoc,
    onSnapshot, query, orderBy, setLogLevel
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ğŸ”‡ Ğ’Ğ¸Ğ¼Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¹Ğ²Ñ– debug-Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ Firestore
  setLogLevel("error");

  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1",
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let invoices = [];
const $ = sel => document.querySelector(sel);

// ==== Render ====
function renderInvoices() {
  const body = $("#invoicesBody");
  body.innerHTML = "";

  const from = $("#fromDate").value;
  const to = $("#toDate").value;
  const status = $("#statusFilter").value;
  const search = $("#searchBox").value.toLowerCase();
  const sortBy = $("#sortBy").value;

  let filtered = invoices.filter(inv => {
    let ok = true;

    // Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ
    if (status !== "all") ok = ok && inv.status === status;

    // Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ñ–
    if (from) ok = ok && (inv.invoiceDate || "") >= from;
    if (to) ok = ok && (inv.invoiceDate || "") <= to;

    // ĞŸĞ¾ÑˆÑƒĞº (Ğ¿Ğ¾ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ñƒ, Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ Ñ– ÑÑƒĞ¼Ñ–)
    if (search) {
      const totalStr = String(inv.grandTotal || "").toLowerCase();
      ok = ok && (
        (inv.clientName || "").toLowerCase().includes(search) ||
        (inv.invoiceNumber || "").toLowerCase().includes(search) ||
        totalStr.includes(search)
      );
    }

    return ok;
  });

  // Ğ¡Ğ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
  filtered.sort((a, b) => {
    switch (sortBy) {
      case "invoiceNumber_desc": {
        const numA = parseInt((a.invoiceNumber || "").split("-").pop()) || 0;
        const numB = parseInt((b.invoiceNumber || "").split("-").pop()) || 0;
        return numB - numA;
      }
      case "invoiceNumber_asc": {
        const numA = parseInt((a.invoiceNumber || "").split("-").pop()) || 0;
        const numB = parseInt((b.invoiceNumber || "").split("-").pop()) || 0;
        return numA - numB;
      }
      case "date_desc": return new Date(b.invoiceDate).getTime() - new Date(a.invoiceDate).getTime();
      case "date_asc": return new Date(a.invoiceDate).getTime() - new Date(b.invoiceDate).getTime();
      case "amount_desc": return (parseFloat(b.grandTotal) || 0) - (parseFloat(a.grandTotal) || 0);
      case "amount_asc": return (parseFloat(a.grandTotal) || 0) - (parseFloat(b.grandTotal) || 0);
    }
    return 0;
  });

  // Ğ ĞµĞ½Ğ´ĞµÑ€
  filtered.forEach(inv => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${inv.invoiceNumber || "â€”"}</td>
      <td>${inv.clientName || "â€”"}</td>
      <td>${inv.status || "Draft"}</td>
      <td>${inv.invoiceDate || "â€”"}</td>
      <td>â‚¬${(parseFloat(inv.grandTotal) || 0).toFixed(2)}</td>
      <td>
        <button onclick="editInvoice('${inv.id}')">âœï¸ Edit</button>
        <button onclick="deleteInvoice('${inv.id}')">ğŸ—‘ Delete</button>
        <button onclick="downloadPDF('${inv.id}', true)">ğŸ“„ PDF</button>
        <button onclick="downloadPDF('${inv.id}', false)">PRO ğŸ“„ PDF without branding</button>
      </td>`;
    body.appendChild(tr);
  });
}

  // --- Live search & filters ---
document.addEventListener("DOMContentLoaded", () => {
  // Ğ¿Ğ¾ÑˆÑƒĞº Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ Ñ‡Ğ°ÑÑ–
  $("#searchBox")?.addEventListener("input", renderInvoices);

  // Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğ°Ñ…
  $("#fromDate")?.addEventListener("change", renderInvoices);
  $("#toDate")?.addEventListener("change", renderInvoices);

  // Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ
  $("#statusFilter")?.addEventListener("change", renderInvoices);

  // ÑĞ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
  $("#sortBy")?.addEventListener("change", renderInvoices);
});

// ==== Actions ====
window.editInvoice = id => {
  localStorage.setItem("editInvoiceId", id);
  window.location.href = "invoices.html";
};
window.deleteInvoice = async id => {
  if (!confirm("Delete this invoice?")) return;
  const user = auth.currentUser;
  if (!user) return;
  await deleteDoc(doc(db, "users", user.uid, "invoices", id));
};

// ==== PDF ====
window.downloadPDF = (id, withBranding = true) => {
  const inv = invoices.find(i => i.id === id);
  if (!inv) return;
  const { jsPDF } = window.jspdf;
  const docPDF = new jsPDF();

  docPDF.setFontSize(18);
  docPDF.text("INVOICE", 105, 15, { align: "center" });

  docPDF.setFontSize(12);
  docPDF.text("From:", 14, 30);
  docPDF.text([
    inv.businessName,
    `KvK: ${inv.kvk}`,
    `IBAN: ${inv.iban}`,
    `Email: ${inv.email}`,
    `BTW: ${inv.btw}`,
    `Address: ${inv.businessAddress}`,
    `Phone: ${inv.businessPhone}`
  ], 14, 36);

  docPDF.text("To:", 120, 30);
  docPDF.text([
    inv.clientName,
    inv.clientEmail,
    `Address: ${inv.clientAddress}`,
    `Phone: ${inv.clientPhone}`
  ], 120, 36);

  // --- Ñ‚ÑƒÑ‚ Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»ÑÑÑ‡Ñƒ Ğ»Ñ–Ğ½Ñ–Ñ ---
docPDF.setDrawColor(200);
docPDF.line(14, 70, 195, 70); // ÑÑ–Ñ€Ğ° Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ° Ğ»Ñ–Ğ½Ñ–Ñ

 // Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ Ğ· Ğ·Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ğ¾Ñ Ñ–Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ñ–Ñ”Ñ Ğ¿Ñ€Ğ¾ Ñ–Ğ½Ğ²Ğ¾Ğ¹Ñ
docPDF.autoTable({
  startY: 80,
  head: [["Invoice #", "Date Issued", "Due Date", "Status"]],
  body: [[inv.invoiceNumber, inv.invoiceDate, inv.dueDate, inv.status]],
  theme: "grid",
  styles: {
    fontSize: 11,
    cellPadding: 4,
    halign: "center",
    valign: "middle"
  },
  headStyles: {
    fillColor: [37, 99, 235], // Ğ¾Ñ„Ñ–Ñ†Ñ–Ğ¹Ğ½Ğ¸Ğ¹ ÑĞ¸Ğ½Ñ–Ğ¹
    textColor: 255,
    fontStyle: "bold"
  },
  bodyStyles: {
    textColor: 50
  }
});

// Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ Ğ· Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–ÑĞ¼Ğ¸ (items)
const items = inv.items?.map(it => [
  it.desc,
  it.qty,
  `â‚¬${parseFloat(it.price).toFixed(2)}`,
  `${it.vat}%`,
  `â‚¬${(it.qty * it.price * (1 + it.vat / 100)).toFixed(2)}`
]) || [];

docPDF.autoTable({
  startY: docPDF.lastAutoTable.finalY + 10, // Ğ©Ğ¾Ğ± Ğ¿Ğ¾Ñ‡Ğ°Ñ‚Ğ¸ Ğ¿Ñ–ÑĞ»Ñ Ğ¿ĞµÑ€ÑˆĞ¾Ñ— Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ–
  head: [["Description", "Qty", "Unit Price", "VAT", "Total"]],
  body: items,
  theme: "grid",
  styles: {
    fontSize: 11,
    cellPadding: 4,
    halign: "center",
    valign: "middle"
  },
  headStyles: {
    fillColor: [37, 99, 235], // Ğ¾Ñ„Ñ–Ñ†Ñ–Ğ¹Ğ½Ğ¸Ğ¹ ÑĞ¸Ğ½Ñ–Ğ¹
    textColor: 255,
    fontStyle: "bold"
  },
  bodyStyles: {
    textColor: 50
  }
});

 docPDF.text(`Subtotal: ${inv.subtotalFormatted}`, 150, docPDF.lastAutoTable.finalY + 10);
docPDF.text(`VAT: ${inv.totalVatFormatted}`, 150, docPDF.lastAutoTable.finalY + 16);
docPDF.text(`Total Due: ${inv.grandTotalFormatted}`, 150, docPDF.lastAutoTable.finalY + 22);


  if (inv.note) {
    docPDF.text("Note:", 14, docPDF.lastAutoTable.finalY + 10);
    docPDF.text(inv.note, 14, docPDF.lastAutoTable.finalY + 16);
  }

  if (inv.signatures?.business) {
  docPDF.addImage(inv.signatures.business, "PNG", 14, docPDF.lastAutoTable.finalY + 30, 60, 20);
    docPDF.text("Business Signature", 14, docPDF.lastAutoTable.finalY + 62);
  docPDF.text("_________________________", 14, docPDF.lastAutoTable.finalY + 55);
  if (inv.signatures.businessDate) docPDF.text(`Date: ${inv.signatures.businessDate}`, 14, docPDF.lastAutoTable.finalY + 69);
}
if (inv.signatures?.client) {
  docPDF.addImage(inv.signatures.client, "PNG", 120, docPDF.lastAutoTable.finalY + 30, 60, 20);
   docPDF.text("Client Signature", 120, docPDF.lastAutoTable.finalY + 62);
  docPDF.text("_________________________", 120, docPDF.lastAutoTable.finalY + 55);
  if (inv.signatures.clientDate) docPDF.text(`Date: ${inv.signatures.clientDate}`, 120, docPDF.lastAutoTable.finalY + 69);
}

  if (withBranding) {
    docPDF.setFontSize(10);
    docPDF.text("Generated with SmartWerk", 105, 290, { align: "center" });
  }

  docPDF.save(`${inv.invoiceNumber}.pdf`);
};

 

// ==== Filters ====
window.resetFilters = () => {
  $("#fromDate").value = "";
  $("#toDate").value = "";
  $("#statusFilter").value = "all";
  $("#searchBox").value = "";
  $("#sortBy").value = "invoiceNumber_desc";
  renderInvoices();
};

// ==== Realtime ====
onAuthStateChanged(auth, user => {
  if (!user) return location.href = "login.html";
  const colRef = collection(db, "users", user.uid, "invoices");
  const q = query(colRef, orderBy("invoiceDate", "desc"));
  onSnapshot(q, snap => {
    invoices = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderInvoices();
  });
});
</script>
</body>
</html>
