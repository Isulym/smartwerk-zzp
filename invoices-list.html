<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“‹ SmartWerk â€” Invoices List</title>
  <link rel="stylesheet" href="style-invoices.css?v=6"/>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <header>
    <h1>ğŸ“‹ Invoices List</h1>
    <div class="header-actions">
      <a href="invoices.html" class="btn">â• New Invoice</a>
      <a href="dashboard.html" class="btn">ğŸ  Back to Dashboard</a>
    </div>
  </header>

  <section class="filters">
    <h3>ğŸ“… Filters & Search</h3>

    <label>From:
      <input type="date" id="fromDate" placeholder="YYYY-MM-DD"/>
    </label>
    <label>To:
      <input type="date" id="toDate" placeholder="YYYY-MM-DD"/>
    </label>

    <label>Status:
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
    </label>

    <label>Search:
      <input type="text" id="searchInput" placeholder="Client / Invoice #"/>
    </label>

    <label>Sort by:
      <select id="sortBy">
        <option value="invoiceDate">date</option>
        <option value="invoiceNumber">invoice number</option>
        <option value="grandTotalNum">amount</option>
      </select>
    </label>
    <label>
      <select id="sortDir">
        <option value="desc">â†“ desc</option>
        <option value="asc">â†‘ asc</option>
      </select>
    </label>

    <button id="applyBtn">ğŸ” Filter</button>
    <button id="resetBtn">ğŸ”„ Reset</button>
  </section>

  <section>
    <table id="invoicesTable">
      <thead>
        <tr>
          <th data-col="invoiceNumber">Invoice #</th>
          <th data-col="clientName">Client</th>
          <th>Status</th>
          <th data-col="invoiceDate">Date</th>
          <th data-col="grandTotalNum">Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoicesBody"></tbody>
    </table>
  </section>

  <footer>
    <p>Â© 2025â€“2030 SmartWerk. All rights reserved.</p>
  </footer>

  <script type="module">
    // ===== Firebase =====
    import { initializeApp, getApps, getApp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ===== State / helpers =====
    let invoices = []; // ÑĞ¸Ñ€Ñ– Ğ· Firestore
    const $ = (s) => document.querySelector(s);

    const toEuro = (n) => `â‚¬${(Number(n||0)).toFixed(2)}`;
    const parseISO = (s) => (s ? new Date(s) : null);

    function computeTotals(inv){
      // Ğ¾Ğ±Ñ‡Ğ¸ÑĞ»ÑÑ”Ğ¼Ğ¾ subtotal / vat / grand, ÑĞºÑ‰Ğ¾ Ğ½Ğµ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾
      if (typeof inv.grandTotal === "number" && typeof inv.subtotal === "number" && typeof inv.totalVat === "number"){
        return {
          subtotal: inv.subtotal,
          totalVat: inv.totalVat,
          grandTotal: inv.grandTotal,
          grandTotalNum: Number(inv.grandTotal)
        };
      }
      let subtotal = 0, vatSum = 0;
      (inv.items||[]).forEach(it=>{
        const qty = Number(it.qty||0);
        const price = Number(it.price||0);
        const vat = Number(it.vat||0);
        const item = qty*price;
        const itemVat = item*vat/100;
        subtotal += item;
        vatSum += itemVat;
      });
      const grand = subtotal + vatSum;
      return { subtotal, totalVat: vatSum, grandTotal: grand, grandTotalNum: grand };
    }

    function normalize(inv){
      const totals = computeTotals(inv);
      return {
        id: inv.id,
        invoiceNumber: inv.invoiceNumber || "",
        clientName: inv.clientName || "",
        clientAddress: inv.clientAddress || "",
        businessName: inv.businessName || "",
        businessAddress: inv.businessAddress || "",
        invoiceDate: inv.invoiceDate || "",
        status: inv.status || "Draft",
        items: inv.items || [],
        subtotal: totals.subtotal,
        totalVat: totals.totalVat,
        grandTotal: totals.grandTotal,
        grandTotalNum: totals.grandTotalNum
      };
    }

    // ===== Rendering =====
    function applyFiltersAndRender(){
      const body = $("#invoicesBody");
      body.innerHTML = "";

      const from = $("#fromDate").value;
      const to = $("#toDate").value;
      const status = $("#statusFilter").value;
      const search = $("#searchInput").value.trim().toLowerCase();
      const sortBy = $("#sortBy").value;      // invoiceDate | invoiceNumber | grandTotalNum
      const sortDir = $("#sortDir").value;    // asc | desc

      let list = invoices.map(normalize);

      // Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ
      if (status !== "all"){
        list = list.filter(x => x.status === status);
      }

      // Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ñ–Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ñƒ Ğ´Ğ°Ñ‚ (Ñ–Ğ½Ğ²Ğ¾Ğ¹ÑDate â€” ÑÑ‚Ñ€Ğ¾ĞºĞ° YYYY-MM-DD)
      if (from){
        list = list.filter(x => (x.invoiceDate||"") >= from);
      }
      if (to){
        list = list.filter(x => (x.invoiceDate||"") <= to);
      }

      // Ğ¿Ğ¾ÑˆÑƒĞº Ğ¿Ğ¾ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ñƒ / Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ
      if (search){
        list = list.filter(x => 
          (x.clientName||"").toLowerCase().includes(search) ||
          (x.invoiceNumber||"").toLowerCase().includes(search)
        );
      }

      // ÑĞ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
      list.sort((a,b)=>{
        const dir = (sortDir === "asc") ? 1 : -1;
        const av = a[sortBy] ?? "";
        const bv = b[sortBy] ?? "";
        if (av < bv) return -1*dir;
        if (av > bv) return  1*dir;
        return 0;
      });

      // Ñ€ĞµĞ½Ğ´ĞµÑ€
      list.forEach(inv=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${inv.invoiceNumber || "â€”"}</td>
          <td>${inv.clientName || "â€”"}</td>
          <td>${inv.status}</td>
          <td>${inv.invoiceDate || "â€”"}</td>
          <td>${toEuro(inv.grandTotalNum)}</td>
          <td class="actions">
            <button onclick="editInvoice('${inv.id}')">âœï¸ Edit</button>
            <button onclick="deleteInvoice('${inv.id}')">ğŸ—‘ Delete</button>
            <button onclick="downloadPDF('${inv.id}')">ğŸ“„ PDF</button>
            <button onclick="repeatMonthly('${inv.id}')">ğŸ” Repeat</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    // ===== Actions (global) =====
    window.resetFilters = () => {
      $("#fromDate").value = "";
      $("#toDate").value = "";
      $("#statusFilter").value = "all";
      $("#searchInput").value = "";
      $("#sortBy").value = "invoiceDate";
      $("#sortDir").value = "desc";
      applyFiltersAndRender();
    };

    $("#applyBtn").addEventListener("click", applyFiltersAndRender);
    $("#resetBtn").addEventListener("click", window.resetFilters);
    ["fromDate","toDate","statusFilter","searchInput","sortBy","sortDir"].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener("change", applyFiltersAndRender);
      if (id==="searchInput") el.addEventListener("input", applyFiltersAndRender);
    });

    window.editInvoice = (id)=>{
      // Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ¼Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ñ– Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ¼Ğ¾ Ğ’Ğ¡Ğ• Ñƒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€, Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ·Ğ°Ğ»ĞµĞ¶Ğ°Ñ‚Ğ¸ Ğ²Ñ–Ğ´ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñƒ
      const inv = invoices.find(x => x.id === id);
      if (inv){
        localStorage.setItem("editInvoiceId", id);                    // Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ 1: Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Ğ·Ñ‡Ğ¸Ñ‚ÑƒÑ” ID Ñ– ÑĞ°Ğ¼ Ñ‚ÑĞ³Ğ½Ğµ Ğ· Firestore
        localStorage.setItem("editInvoiceNumber", inv.invoiceNumber||""); // Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ 2: Ñƒ Ñ‚ĞµĞ±Ğµ Ğ±ÑƒĞ»Ğ¾ Ğ¿Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ
        localStorage.setItem("editInvoiceData", JSON.stringify(inv)); // Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ 3: Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ñ–
      }
      window.location.href = "invoices.html#edit=1";
    };

    window.deleteInvoice = async (id)=>{
      if (!confirm("Delete this invoice?")) return;
      const user = auth.currentUser;
      if (!user) return;
      await deleteDoc(doc(db,"users",user.uid,"invoices",id));
      // onSnapshot ÑĞ°Ğ¼ Ğ¿Ñ–Ğ´Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ñ€ÑĞ´Ğ¾Ğº
    };

    function incrementInvoiceNumber(num){
      // Ğ¿Ñ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ° Ñ‚Ğ²Ğ¾Ñ”Ñ— ÑÑ…ĞµĞ¼Ğ¸ Ñ‚Ğ¸Ğ¿Ñƒ INV-2025-003 Ğ°Ğ±Ğ¾ Ğ±ÑƒĞ´ÑŒ-ÑĞºĞ¾Ğ³Ğ¾ Ğ·Ğ°ĞºÑ–Ğ½Ñ‡ĞµĞ½Ğ½Ñ Ñ†Ğ¸Ñ„Ñ€Ğ°Ğ¼Ğ¸
      if (!num) return "INV-2025-001";
      return num.replace(/(\d+)(?!.*\d)/, m => String(Number(m)+1).padStart(m.length,"0"));
    }

    window.repeatMonthly = async (id)=>{
      const user = auth.currentUser; if (!user) return;
      const src = invoices.find(x=>x.id===id); if (!src) return;

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm   = String(today.getMonth()+1).padStart(2,"0");
      const dd   = String(today.getDate()).padStart(2,"0");

      const copy = structuredClone(src);
      delete copy.id;
      copy.invoiceDate = `${yyyy}-${mm}-${dd}`;
      copy.status = "Draft";
      copy.invoiceNumber = incrementInvoiceNumber(src.invoiceNumber);
      // ÑĞºÑ‰Ğ¾ Ñƒ Ñ‚ĞµĞ±Ğµ totals Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ñ– ÑĞº Ñ‡Ğ¸ÑĞ»Ğ° â€” Ğ¾Ğ±Ğ½ÑƒĞ»ÑÑ‚Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¾, Ñ–Ğ½Ğ°ĞºÑˆĞµ Ğ¿Ğ¾Ñ€Ğ°Ñ…ÑƒÑ”Ñˆ Ñƒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€Ñ–
      await addDoc(collection(db,"users",user.uid,"invoices"), copy);
      alert("Invoice duplicated for this month.");
    };

    window.downloadPDF = (id)=>{
      const invRaw = invoices.find(x=>x.id===id);
      if (!invRaw) return;
      const inv = normalize(invRaw);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      // Header
      pdf.setFontSize(18);
      pdf.text(`Invoice ${inv.invoiceNumber || ""}`, 14, 18);
      pdf.setFontSize(11);
      pdf.text(`Date: ${inv.invoiceDate || ""}`, 14, 26);
      pdf.text(`Status: ${inv.status}`, 14, 32);

      // From / To
      pdf.setFontSize(12);
      pdf.text("From:", 14, 44);
      pdf.text(inv.businessName || "", 14, 50);
      pdf.text(inv.businessAddress || "", 14, 56);

      pdf.text("To:", 120, 44);
      pdf.text(inv.clientName || "", 120, 50);
      pdf.text(inv.clientAddress || "", 120, 56);

      // Items
      if (inv.items && inv.items.length){
        pdf.autoTable({
          startY: 70,
          head: [["Description","Qty","Price","VAT","Total"]],
          body: inv.items.map(it=>{
            const qty = Number(it.qty||0);
            const price = Number(it.price||0);
            const vat = Number(it.vat||0);
            const total = qty*price*(1+vat/100);
            return [it.desc||"", qty, toEuro(price), `${vat}%`, toEuro(total)];
          })
        });
      }

      const y = pdf.lastAutoTable ? pdf.lastAutoTable.finalY + 10 : 100;
      pdf.text(`Subtotal: ${toEuro(inv.subtotal)}`, 14, y);
      pdf.text(`VAT: ${toEuro(inv.totalVat)}`, 14, y+6);
      pdf.text(`Total: ${toEuro(inv.grandTotal)}`, 14, y+12);

      pdf.save(`${inv.invoiceNumber||'invoice'}.pdf`);
    };

    // ===== Live data =====
    onAuthStateChanged(auth,(user)=>{
      if (!user) { window.location.href = "login.html"; return; }
      const col = collection(db,"users",user.uid,"invoices");
      // Ñ€ÑĞ´Ğ¾Ğº Ğ´Ğ°Ñ‚Ğ¸ Ñƒ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ– YYYY-MM-DD ÑĞ¾Ñ€Ñ‚ÑƒÑ”Ñ‚ÑŒÑÑ ĞºĞ¾Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ»ĞµĞºÑĞ¸ĞºĞ¾Ğ³Ñ€Ğ°Ñ„Ñ–Ñ‡Ğ½Ğ¾
      const qy = query(col, orderBy("invoiceDate","desc"));
      onSnapshot(qy, (snap)=>{
        invoices = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        applyFiltersAndRender();
      });
    });
  </script>
</body>
</html>
