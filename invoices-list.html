<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📋 SmartWerk — Invoices List</title>
  <link rel="stylesheet" href="style-invoices.css?v=6"/>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <header>
    <h1>📋 Invoices List</h1>
    <div class="header-actions">
      <a href="invoices.html" class="btn">➕ New Invoice</a>
      <a href="dashboard.html" class="btn">🏠 Back to Dashboard</a>
    </div>
  </header>

  <section class="filters">
    <h3>📅 Filters & Search</h3>

    <label>From:
      <input type="date" id="fromDate" placeholder="YYYY-MM-DD"/>
    </label>
    <label>To:
      <input type="date" id="toDate" placeholder="YYYY-MM-DD"/>
    </label>

    <label>Status:
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
    </label>

    <label>Search:
      <input type="text" id="searchInput" placeholder="Client / Invoice #"/>
    </label>

    <label>Sort by:
      <select id="sortBy">
        <option value="invoiceDate">date</option>
        <option value="invoiceNumber">invoice number</option>
        <option value="grandTotalNum">amount</option>
      </select>
    </label>
    <label>
      <select id="sortDir">
        <option value="desc">↓ desc</option>
        <option value="asc">↑ asc</option>
      </select>
    </label>

    <button id="applyBtn">🔎 Filter</button>
    <button id="resetBtn">🔄 Reset</button>
  </section>

  <section>
    <table id="invoicesTable">
      <thead>
        <tr>
          <th data-col="invoiceNumber">Invoice #</th>
          <th data-col="clientName">Client</th>
          <th>Status</th>
          <th data-col="invoiceDate">Date</th>
          <th data-col="grandTotalNum">Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoicesBody"></tbody>
    </table>
  </section>

  <footer>
    <p>© 2025–2030 SmartWerk. All rights reserved.</p>
  </footer>

  <script type="module">
    // ===== Firebase =====
    import { initializeApp, getApps, getApp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ===== State / helpers =====
    let invoices = []; // сирі з Firestore
    const $ = (s) => document.querySelector(s);

    const toEuro = (n) => `€${(Number(n||0)).toFixed(2)}`;
    const parseISO = (s) => (s ? new Date(s) : null);

    function computeTotals(inv){
      // обчислюємо subtotal / vat / grand, якщо не збережено
      if (typeof inv.grandTotal === "number" && typeof inv.subtotal === "number" && typeof inv.totalVat === "number"){
        return {
          subtotal: inv.subtotal,
          totalVat: inv.totalVat,
          grandTotal: inv.grandTotal,
          grandTotalNum: Number(inv.grandTotal)
        };
      }
      let subtotal = 0, vatSum = 0;
      (inv.items||[]).forEach(it=>{
        const qty = Number(it.qty||0);
        const price = Number(it.price||0);
        const vat = Number(it.vat||0);
        const item = qty*price;
        const itemVat = item*vat/100;
        subtotal += item;
        vatSum += itemVat;
      });
      const grand = subtotal + vatSum;
      return { subtotal, totalVat: vatSum, grandTotal: grand, grandTotalNum: grand };
    }

    function normalize(inv){
      const totals = computeTotals(inv);
      return {
        id: inv.id,
        invoiceNumber: inv.invoiceNumber || "",
        clientName: inv.clientName || "",
        clientAddress: inv.clientAddress || "",
        businessName: inv.businessName || "",
        businessAddress: inv.businessAddress || "",
        invoiceDate: inv.invoiceDate || "",
        status: inv.status || "Draft",
        items: inv.items || [],
        subtotal: totals.subtotal,
        totalVat: totals.totalVat,
        grandTotal: totals.grandTotal,
        grandTotalNum: totals.grandTotalNum
      };
    }

    // ===== Rendering =====
    function applyFiltersAndRender(){
      const body = $("#invoicesBody");
      body.innerHTML = "";

      const from = $("#fromDate").value;
      const to = $("#toDate").value;
      const status = $("#statusFilter").value;
      const search = $("#searchInput").value.trim().toLowerCase();
      const sortBy = $("#sortBy").value;      // invoiceDate | invoiceNumber | grandTotalNum
      const sortDir = $("#sortDir").value;    // asc | desc

      let list = invoices.map(normalize);

      // фільтр статусу
      if (status !== "all"){
        list = list.filter(x => x.status === status);
      }

      // фільтр по діапазону дат (інвойсDate — строка YYYY-MM-DD)
      if (from){
        list = list.filter(x => (x.invoiceDate||"") >= from);
      }
      if (to){
        list = list.filter(x => (x.invoiceDate||"") <= to);
      }

      // пошук по клієнту / номеру
      if (search){
        list = list.filter(x => 
          (x.clientName||"").toLowerCase().includes(search) ||
          (x.invoiceNumber||"").toLowerCase().includes(search)
        );
      }

      // сортування
      list.sort((a,b)=>{
        const dir = (sortDir === "asc") ? 1 : -1;
        const av = a[sortBy] ?? "";
        const bv = b[sortBy] ?? "";
        if (av < bv) return -1*dir;
        if (av > bv) return  1*dir;
        return 0;
      });

      // рендер
      list.forEach(inv=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${inv.invoiceNumber || "—"}</td>
          <td>${inv.clientName || "—"}</td>
          <td>${inv.status}</td>
          <td>${inv.invoiceDate || "—"}</td>
          <td>${toEuro(inv.grandTotalNum)}</td>
          <td class="actions">
            <button onclick="editInvoice('${inv.id}')">✏️ Edit</button>
            <button onclick="deleteInvoice('${inv.id}')">🗑 Delete</button>
            <button onclick="downloadPDF('${inv.id}')">📄 PDF</button>
            <button onclick="repeatMonthly('${inv.id}')">🔁 Repeat</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    // ===== Actions (global) =====
    window.resetFilters = () => {
      $("#fromDate").value = "";
      $("#toDate").value = "";
      $("#statusFilter").value = "all";
      $("#searchInput").value = "";
      $("#sortBy").value = "invoiceDate";
      $("#sortDir").value = "desc";
      applyFiltersAndRender();
    };

    $("#applyBtn").addEventListener("click", applyFiltersAndRender);
    $("#resetBtn").addEventListener("click", window.resetFilters);
    ["fromDate","toDate","statusFilter","searchInput","sortBy","sortDir"].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener("change", applyFiltersAndRender);
      if (id==="searchInput") el.addEventListener("input", applyFiltersAndRender);
    });

    window.editInvoice = (id)=>{
      // знайдемо документ і передамо ВСЕ у редактор, щоб не залежати від формату
      const inv = invoices.find(x => x.id === id);
      if (inv){
        localStorage.setItem("editInvoiceId", id);                    // варіант 1: редактор зчитує ID і сам тягне з Firestore
        localStorage.setItem("editInvoiceNumber", inv.invoiceNumber||""); // варіант 2: у тебе було по номеру
        localStorage.setItem("editInvoiceData", JSON.stringify(inv)); // варіант 3: одразу дані
      }
      window.location.href = "invoices.html#edit=1";
    };

    window.deleteInvoice = async (id)=>{
      if (!confirm("Delete this invoice?")) return;
      const user = auth.currentUser;
      if (!user) return;
      await deleteDoc(doc(db,"users",user.uid,"invoices",id));
      // onSnapshot сам підчистить рядок
    };

    function incrementInvoiceNumber(num){
      // підтримка твоєї схеми типу INV-2025-003 або будь-якого закінчення цифрами
      if (!num) return "INV-2025-001";
      return num.replace(/(\d+)(?!.*\d)/, m => String(Number(m)+1).padStart(m.length,"0"));
    }

    window.repeatMonthly = async (id)=>{
      const user = auth.currentUser; if (!user) return;
      const src = invoices.find(x=>x.id===id); if (!src) return;

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm   = String(today.getMonth()+1).padStart(2,"0");
      const dd   = String(today.getDate()).padStart(2,"0");

      const copy = structuredClone(src);
      delete copy.id;
      copy.invoiceDate = `${yyyy}-${mm}-${dd}`;
      copy.status = "Draft";
      copy.invoiceNumber = incrementInvoiceNumber(src.invoiceNumber);
      // якщо у тебе totals збережені як числа — обнуляти не потрібно, інакше порахуєш у редакторі
      await addDoc(collection(db,"users",user.uid,"invoices"), copy);
      alert("Invoice duplicated for this month.");
    };

    window.downloadPDF = (id)=>{
      const invRaw = invoices.find(x=>x.id===id);
      if (!invRaw) return;
      const inv = normalize(invRaw);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      // Header
      pdf.setFontSize(18);
      pdf.text(`Invoice ${inv.invoiceNumber || ""}`, 14, 18);
      pdf.setFontSize(11);
      pdf.text(`Date: ${inv.invoiceDate || ""}`, 14, 26);
      pdf.text(`Status: ${inv.status}`, 14, 32);

      // From / To
      pdf.setFontSize(12);
      pdf.text("From:", 14, 44);
      pdf.text(inv.businessName || "", 14, 50);
      pdf.text(inv.businessAddress || "", 14, 56);

      pdf.text("To:", 120, 44);
      pdf.text(inv.clientName || "", 120, 50);
      pdf.text(inv.clientAddress || "", 120, 56);

      // Items
      if (inv.items && inv.items.length){
        pdf.autoTable({
          startY: 70,
          head: [["Description","Qty","Price","VAT","Total"]],
          body: inv.items.map(it=>{
            const qty = Number(it.qty||0);
            const price = Number(it.price||0);
            const vat = Number(it.vat||0);
            const total = qty*price*(1+vat/100);
            return [it.desc||"", qty, toEuro(price), `${vat}%`, toEuro(total)];
          })
        });
      }

      const y = pdf.lastAutoTable ? pdf.lastAutoTable.finalY + 10 : 100;
      pdf.text(`Subtotal: ${toEuro(inv.subtotal)}`, 14, y);
      pdf.text(`VAT: ${toEuro(inv.totalVat)}`, 14, y+6);
      pdf.text(`Total: ${toEuro(inv.grandTotal)}`, 14, y+12);

      pdf.save(`${inv.invoiceNumber||'invoice'}.pdf`);
    };

    // ===== Live data =====
    onAuthStateChanged(auth,(user)=>{
      if (!user) { window.location.href = "login.html"; return; }
      const col = collection(db,"users",user.uid,"invoices");
      // рядок дати у форматі YYYY-MM-DD сортується коректно лексикографічно
      const qy = query(col, orderBy("invoiceDate","desc"));
      onSnapshot(qy, (snap)=>{
        invoices = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        applyFiltersAndRender();
      });
    });
  </script>
</body>
</html>
