<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìã SmartWerk ‚Äî Invoices List</title>
  <link rel="stylesheet" href="style-invoices.css?v=5"/>
  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* –ª–µ–≥–∫—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ —É —Ç–≤–æ—î–º—É CSS —ó—Ö –Ω–µ–º–∞) */
    .filters, .search-row {display:grid; gap:.75rem; margin:1rem 0}
    .filters{grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); align-items:end}
    .search-row{grid-template-columns:1fr auto auto}
    .muted{opacity:.7}
    .count-pill{font-size:.9rem; padding:.2rem .6rem; border:1px solid var(--line,#2a2f3a); border-radius:999px}
    th.sortable{cursor:pointer}
    .header-actions .btn{margin-right:.5rem}
  </style>
</head>
<body>
  <header>
    <h1>üìã Invoices List</h1>
    <div class="header-actions">
      <a href="invoices.html" class="btn">‚ûï New Invoice</a>
      <a href="dashboard.html" class="btn">üè† Back to Dashboard</a>
    </div>
  </header>

  <!-- üìÖ Filters & Search -->
  <section class="filters">
    <div>
      <label class="muted">From:</label>
      <input type="date" id="fromDate" />
    </div>
    <div>
      <label class="muted">To:</label>
      <input type="date" id="toDate" />
    </div>
    <div>
      <label class="muted">Status:</label>
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
    </div>
    <div>
      <label class="muted">Sort by:</label>
      <div style="display:flex; gap:.5rem">
        <select id="sortBy">
          <option value="invoiceNumber">invoice number</option>
          <option value="invoiceDate">date</option>
          <option value="total">amount</option>
          <option value="clientName">client</option>
        </select>
        <button id="sortDirBtn" class="btn" type="button" title="Toggle sort direction">‚¨ÜÔ∏è</button>
      </div>
    </div>
  </section>

  <section class="search-row">
    <input type="search" id="searchInput" placeholder="Search..." />
    <button id="applyBtn" class="btn" type="button">üîé Filter</button>
    <button id="resetBtn" class="btn" type="button">üîÑ Reset</button>
  </section>

  <section>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
      <div class="muted">Showing <span id="countShown">0</span> / <span id="countTotal">0</span> invoices</div>
      <div id="liveBadge" class="count-pill muted">live</div>
    </div>
    <table id="invoicesTable">
      <thead>
        <tr>
          <th class="sortable" data-sort="invoiceNumber">Invoice #</th>
          <th class="sortable" data-sort="clientName">Client</th>
          <th>Status</th>
          <th class="sortable" data-sort="invoiceDate">Date</th>
          <th class="sortable" data-sort="total">Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoicesBody"></tbody>
    </table>
  </section>

  <footer>
    <p>¬© 2025‚Äì2030 SmartWerk. All rights reserved.</p>
  </footer>

  <script type="module">
    /* ===========================
       Firebase (App/Auth/DB)
    ============================ */
    import { initializeApp, getApps, getApp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===========================
       State / helpers
    ============================ */
    let allInvoices = [];     // –∑ Firestore (realtime)
    let currentSort = { field: "invoiceNumber", asc: true };

    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const elBody       = $("#invoicesBody");
    const elFrom       = $("#fromDate");
    const elTo         = $("#toDate");
    const elStatus     = $("#statusFilter");
    const elSearch     = $("#searchInput");
    const elSortBy     = $("#sortBy");
    const elSortDirBtn = $("#sortDirBtn");
    const elCountShown = $("#countShown");
    const elCountTotal = $("#countTotal");

    // —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç–∏ —è–∫—â–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è Timestamp
    function toYMD(anyDateLike) {
      if (!anyDateLike) return "";
      // string 'YYYY-MM-DD'
      if (typeof anyDateLike === "string") {
        // already 'YYYY-MM-DD' or 'YYYY-MM'
        if (/^\d{4}-\d{2}(-\d{2})?$/.test(anyDateLike)) return anyDateLike.length===7 ? anyDateLike+"-01" : anyDateLike;
        const d = new Date(anyDateLike);
        if (!isNaN(d)) return d.toISOString().slice(0,10);
        return "";
      }
      // Timestamp {seconds,nanos}
      if (anyDateLike.seconds) {
        const d = new Date(anyDateLike.seconds * 1000);
        return d.toISOString().slice(0,10);
      }
      // Date object
      if (anyDateLike instanceof Date) return anyDateLike.toISOString().slice(0,10);
      return "";
    }

    function money(n){ n = Number(n||0); return "‚Ç¨" + n.toFixed(2); }

    function matchesSearch(inv, q){
      if (!q) return true;
      q = q.toLowerCase();
      return [
        inv.invoiceNumber,
        inv.clientName,
        inv.status,
        inv.note
      ].some(v => (v||"").toString().toLowerCase().includes(q));
    }

    function withinRange(inv, from, to){
      if (!from && !to) return true;
      const ymd = toYMD(inv.invoiceDate);
      if (!ymd) return false;
      if (from && ymd < from) return false;
      if (to   && ymd > to)   return false;
      return true;
    }

    function sortArray(arr, field, asc){
      const dir = asc ? 1 : -1;
      return arr.sort((a,b)=>{
        const A = (a[field] ?? "");
        const B = (b[field] ?? "");
        // numeric for total
        if (field === "total") return (Number(A)-Number(B)) * dir;
        // date for invoiceDate
        if (field === "invoiceDate") {
          const dA = toYMD(A);
          const dB = toYMD(B);
          return (dA < dB ? -1 : dA > dB ? 1 : 0) * dir;
        }
        // string compare
        return (A < B ? -1 : A > B ? 1 : 0) * dir;
      });
    }

    /* ===========================
       Rendering
    ============================ */
    function applyAndRender(){
      elBody.innerHTML = "";
      const status = elStatus.value;            // 'all'|'Draft'|'Sent'|'Paid'
      const from   = elFrom.value || "";        // 'YYYY-MM-DD'
      const to     = elTo.value   || "";        // 'YYYY-MM-DD'
      const q      = elSearch.value.trim();

      // 1) —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è
      let rows = allInvoices.filter(inv=>{
        if (status !== "all" && inv.status !== status) return false;
        if (!matchesSearch(inv, q)) return false;
        if (!withinRange(inv, from, to)) return false;
        return true;
      });

      // 2) —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
      rows = sortArray(rows, currentSort.field, currentSort.asc);

      // 3) —Ä–µ–Ω–¥–µ—Ä
      rows.forEach(inv=>{
        const tr = document.createElement("tr");
        const ymd = toYMD(inv.invoiceDate) || "‚Äî";
        tr.innerHTML = `
          <td>${inv.invoiceNumber || "‚Äî"}</td>
          <td>${inv.clientName || "‚Äî"}</td>
          <td>${inv.status || "Draft"}</td>
          <td>${ymd}</td>
          <td>${money(inv.total)}</td>
          <td>
            <button type="button" data-action="edit"    data-id="${inv.id}">‚úèÔ∏è Edit</button>
            <button type="button" data-action="delete"  data-id="${inv.id}">üóë Delete</button>
            <button type="button" data-action="pdf"     data-id="${inv.id}">üìÑ PDF</button>
            <button type="button" data-action="repeat"  data-id="${inv.id}">üîÅ Repeat Monthly</button>
          </td>
        `;
        elBody.appendChild(tr);
      });

      // counters
      elCountShown.textContent = String(rows.length);
      elCountTotal.textContent = String(allInvoices.length);
    }

    /* ===========================
       Actions (delegation)
    ============================ */
    elBody.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.dataset.action;
      const id     = btn.dataset.id;
      const inv    = allInvoices.find(i=>i.id===id);
      if (!inv) return;

      const user = auth.currentUser;
      if (!user) return;

      if (action === "edit"){
        // —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑ —Ç–≤–æ—ó–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º (–ø–µ—Ä–µ–¥–∞—î–º–æ –Ω–æ–º–µ—Ä —ñ–Ω–≤–æ–π—Å—É)
        localStorage.setItem("editInvoiceNumber", inv.invoiceNumber || "");
        // –Ω–∞ –≤—Å—è–∫, –¥–æ–¥–∞—é id –æ–∫—Ä–µ–º–æ (–º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—è –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É)
        localStorage.setItem("editInvoiceId", id);
        window.location.href = "invoices.html";
      }
      if (action === "delete"){
        if (!confirm("Delete this invoice?")) return;
        await deleteDoc(doc(db, "users", user.uid, "invoices", id));
      }
      if (action === "repeat"){
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth()+1).padStart(2,"0");
        const d = String(now.getDate()).padStart(2,"0");
        const nextNumber = (inv.invoiceNumber||"")
          .replace(/\d+$/, n => String((+n||0)+1).padStart(3,"0")) || `${y}${m}${d}`;

        const clone = {
          ...inv,
          invoiceDate: `${y}-${m}-${d}`,
          invoiceNumber: nextNumber,
          status: "Draft"
        };
        delete clone.id;
        await addDoc(collection(db, "users", user.uid, "invoices"), clone);
        alert("Invoice repeated for this month!");
      }
      if (action === "pdf"){
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();
        docPDF.text(`Invoice ${inv.invoiceNumber||""}`, 10, 10);
        docPDF.text(`Client: ${inv.clientName||""}`, 10, 20);
        docPDF.text(`Date: ${toYMD(inv.invoiceDate)}`, 10, 30);
        docPDF.text(`Status: ${inv.status||"Draft"}`, 10, 40);
        docPDF.text(`Total: ${money(inv.total)}`, 10, 50);
        docPDF.save(`${inv.invoiceNumber||"invoice"}.pdf`);
      }
    });

    /* ===========================
       Sort controls (headers + select)
    ============================ */
    // –∫–ª—ñ–∫–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
    $$("#invoicesTable thead th.sortable").forEach(th=>{
      th.addEventListener("click", ()=>{
        const f = th.dataset.sort;
        if (currentSort.field === f) currentSort.asc = !currentSort.asc;
        else currentSort = { field: f, asc: true };
        elSortBy.value = f;
        elSortDirBtn.textContent = currentSort.asc ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è";
        applyAndRender();
      });
    });

    // select + –∫–Ω–æ–ø–∫–∞ –Ω–∞–ø—Ä—è–º–∫—É
    elSortBy.addEventListener("change", ()=>{
      currentSort.field = elSortBy.value;
      applyAndRender();
    });
    elSortDirBtn.addEventListener("click", ()=>{
      currentSort.asc = !currentSort.asc;
      elSortDirBtn.textContent = currentSort.asc ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è";
      applyAndRender();
    });

    /* ===========================
       Filter controls
    ============================ */
    $("#applyBtn").addEventListener("click", applyAndRender);
    $("#resetBtn").addEventListener("click", ()=>{
      elFrom.value = "";
      elTo.value = "";
      elStatus.value = "all";
      elSearch.value = "";
      currentSort = { field: "invoiceNumber", asc: true };
      elSortBy.value = "invoiceNumber";
      elSortDirBtn.textContent = "‚¨ÜÔ∏è";
      applyAndRender();
    });

    // –ª–∞–π–≤-–ø–æ—à—É–∫ —ñ –∂–∏–≤—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ (–ø—Ä–∏—î–º–Ω—ñ—à–µ)
    elSearch.addEventListener("input", applyAndRender);
    elFrom.addEventListener("change", applyAndRender);
    elTo.addEventListener("change", applyAndRender);
    elStatus.addEventListener("change", applyAndRender);

    /* ===========================
       Realtime subscription
    ============================ */
    onAuthStateChanged(auth, (user) => {
      if (!user) return (window.location.href = "login.html");
      const colRef = collection(db, "users", user.uid, "invoices");
      const q = query(colRef, orderBy("invoiceDate", "desc"));
      onSnapshot(q, (snap) => {
        allInvoices = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        applyAndRender();
        // –º–∏–≥–Ω—É—Ç–∏ –±–µ–π–¥–∂ "live"
        const badge = $("#liveBadge");
        badge.style.opacity = "1";
        setTimeout(()=> badge.style.opacity = "0.6", 350);
      });
    });
  </script>
</body>
</html>
