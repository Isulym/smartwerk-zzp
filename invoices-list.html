<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìã SmartWerk ‚Äî Invoices List</title>
  <link rel="stylesheet" href="style-invoices.css?v=5"/>
  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* –ª–µ–≥–∫—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ —É —Ç–≤–æ—î–º—É CSS —ó—Ö –Ω–µ–º–∞) */
    .filters, .search-row {display:grid; gap:.75rem; margin:1rem 0}
    .filters{grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); align-items:end}
    .search-row{grid-template-columns:1fr auto auto}
    .muted{opacity:.7}
    .count-pill{font-size:.9rem; padding:.2rem .6rem; border:1px solid var(--line,#2a2f3a); border-radius:999px}
    th.sortable{cursor:pointer}
    .header-actions .btn{margin-right:.5rem}
  </style>
</head>
<body>
  <header>
    <h1>üìã Invoices List</h1>
    <div class="header-actions">
      <a href="invoices.html" class="btn">‚ûï New Invoice</a>
      <a href="dashboard.html" class="btn">üè† Back to Dashboard</a>
    </div>
  </header>

  <!-- üìÖ Filters & Search -->
  <section class="filters">
    <div>
      <label class="muted">From:</label>
      <input type="date" id="fromDate" />
    </div>
    <div>
      <label class="muted">To:</label>
      <input type="date" id="toDate" />
    </div>
    <div>
      <label class="muted">Status:</label>
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
    </div>
    <div>
      <label class="muted">Sort by:</label>
      <div style="display:flex; gap:.5rem">
        <select id="sortBy">
          <option value="invoiceNumber">invoice number</option>
          <option value="invoiceDate">date</option>
          <option value="total">amount</option>
          <option value="clientName">client</option>
        </select>
        <button id="sortDirBtn" class="btn" type="button" title="Toggle sort direction">‚¨ÜÔ∏è</button>
      </div>
    </div>
  </section>

  <section class="search-row">
    <input type="search" id="searchInput" placeholder="Search..." />
    <button id="applyBtn" class="btn" type="button">üîé Filter</button>
    <button id="resetBtn" class="btn" type="button">üîÑ Reset</button>
  </section>

  <section>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
      <div class="muted">Showing <span id="countShown">0</span> / <span id="countTotal">0</span> invoices</div>
      <div id="liveBadge" class="count-pill muted">live</div>
    </div>
    <table id="invoicesTable">
      <thead>
        <tr>
          <th class="sortable" data-sort="invoiceNumber">Invoice #</th>
          <th class="sortable" data-sort="clientName">Client</th>
          <th>Status</th>
          <th class="sortable" data-sort="invoiceDate">Date</th>
          <th class="sortable" data-sort="total">Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoicesBody"></tbody>
    </table>
  </section>

  <footer>
    <p>¬© 2025‚Äì2030 SmartWerk. All rights reserved.</p>
  </footer>

 <script type="module">
  // === Firestore bridge: –±–µ–∑ –∑–º—ñ–Ω —Ç–≤–æ—ó—Ö —ñ—Å–Ω—É—é—á–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π UI ===
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, doc, getDoc, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // ‚öôÔ∏è —Ç–≤—ñ–π –∫–æ–Ω—Ñ—ñ–≥
  const firebaseConfig = {
    apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
    authDomain: "smartwerk8520.firebaseapp.com",
    projectId: "smartwerk8520",
    appId: "1:607670981972:web:c07103c981c86860d724c1",
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  const $ = (id) => document.getElementById(id);

  // üß≠ —á–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –Ω–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  const params = new URLSearchParams(location.search);
  let EDITING_ID = params.get("id") || null;

  // üß© –¥–æ–ø–æ–º—ñ–∂–Ω–µ: –∑—ñ–±—Ä–∞—Ç–∏ —ñ–Ω–≤–æ–π—Å —ñ–∑ DOM (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —è–∫ —É —Ç–µ–±–µ —Ä–∞–Ω—ñ—à–µ)
  function collectInvoiceFromDom() {
    const get = (id) => $(id)?.value?.trim() || "";

    const items = [];
    document.querySelectorAll("#itemsBody tr").forEach(row => {
      const desc = row.querySelector(".desc")?.value || "";
      const qty  = parseFloat(row.querySelector(".qty")?.value || 0);
      const price= parseFloat(row.querySelector(".price")?.value || 0);
      const vatEl= row.querySelector(".vat-select") || row.querySelector(".vat");
      const vat  = parseFloat(vatEl ? vatEl.value : 0) || 0;

      items.push({ desc, qty, price, vat });
    });

    // –ø—ñ–¥–ø–∏—Å–∏ -> base64 (—è–∫ —É —Ç–µ–±–µ)
    let signBiz = "", signClient = "";
    try { signBiz   = $("signatureBusiness")?.toDataURL() || ""; } catch {}
    try { signClient= $("signatureClient")?.toDataURL() || ""; } catch {}

    // –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ totals (—â–æ–± —É —Å–ø–∏—Å–∫—É –±—É–≤ inv.total)
    let subtotal = 0, totalVAT = 0;
    items.forEach(it => {
      const line = (it.qty || 0) * (it.price || 0);
      subtotal += line;
      totalVAT += line * (it.vat || 0) / 100;
    });
    const grand = subtotal + totalVAT;

    const number = get("invoiceNumber") || (window.generateNextInvoiceNumber ? window.generateNextInvoiceNumber() : `INV-${Date.now()}`);

    return {
      businessName: get("businessName"),
      kvk: get("kvk"),
      iban: get("iban"),
      btw: get("btw"),
      email: get("email"),
      businessAddress: get("businessAddress"),
      businessPhone: get("businessPhone"),

      clientName: get("clientName"),
      clientEmail: get("clientEmail"),
      clientPhone: get("clientPhone"),
      clientAddress: get("clientAddress"),

      invoiceNumber: number,
      invoiceDate: get("invoiceDate"),
      dueDate: get("dueDate"),
      note: get("note"),
      status: get("status") || "Draft",

      items,
      subtotal: Number(subtotal.toFixed(2)),
      vat: Number(totalVAT.toFixed(2)),
      total: Number(grand.toFixed(2)),

      signatures: {
        business: signBiz,
        client: signClient,
        businessDate: $("signatureBusinessDate")?.textContent || "",
        clientDate: $("signatureClientDate")?.textContent || "",
        date: new Date().toISOString()
      },

      updatedAt: new Date().toISOString()
    };
  }

  // üß© –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ñ–æ—Ä–º—É —ñ–∑ Firestore-–¥–æ–∫—É–º–µ–Ω—Ç–∞
  function fillInvoiceForm(data, id) {
    const set = (id, val) => { if ($(id)) $(id).value = val ?? ""; };

    set("businessName", data.businessName);
    set("kvk",          data.kvk);
    set("iban",         data.iban);
    set("btw",          data.btw);
    set("email",        data.email);
    set("businessAddress", data.businessAddress);
    set("businessPhone",   data.businessPhone);

    set("clientName", data.clientName);
    set("clientEmail", data.clientEmail);
    set("clientPhone", data.clientPhone);
    set("clientAddress", data.clientAddress);

    set("invoiceNumber", data.invoiceNumber);
    set("invoiceDate",   data.invoiceDate);
    set("dueDate",       data.dueDate);
    set("note",          data.note);
    if ($("status")) $("status").value = data.status || "Draft";

    // items (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–≤–æ—é addItem)
    const body = document.querySelector("#itemsBody");
    if (body) body.innerHTML = "";
    (data.items || []).forEach(it => {
      if (typeof window.addItem === "function") {
        window.addItem(it.desc, it.qty, it.price, it.vat);
      }
    });

    // signatures ‚Üí –∫–∞–Ω–≤–∞—Å–∏
    if (data.signatures?.business) {
      const img = new Image();
      img.onload = () => {
        const c = $("signatureBusiness"); if (!c) return;
        const ctx = c.getContext("2d");
        ctx.clearRect(0,0,c.width,c.height);
        ctx.drawImage(img, 0, 0);
        if ($("signatureBusinessDate")) $("signatureBusinessDate").textContent = data.signatures.businessDate || "";
      };
      img.src = data.signatures.business;
    }
    if (data.signatures?.client) {
      const img = new Image();
      img.onload = () => {
        const c = $("signatureClient"); if (!c) return;
        const ctx = c.getContext("2d");
        ctx.clearRect(0,0,c.width,c.height);
        ctx.drawImage(img, 0, 0);
        if ($("signatureClientDate")) $("signatureClientDate").textContent = data.signatures.clientDate || "";
      };
      img.src = data.signatures.client;
    }

    // –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ totals —Ç–≤–æ—î—é —Ñ—É–Ω–∫—Ü—ñ—î—é
    if (typeof window.updateTotals === "function") window.updateTotals();

    // –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    window.EDITING_ID = id;
  }

  // üîê –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è + –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–Ω–≤–æ–π—Å—É –Ω–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è (—è–∫—â–æ ?id=...)
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.replace("login.html");
      return;
    }
    if (!EDITING_ID) return;

    try {
      const ref  = doc(db, "users", user.uid, "invoices", EDITING_ID);
      const snap = await getDoc(ref);
      if (snap.exists()) fillInvoiceForm(snap.data(), EDITING_ID);
    } catch (e) {
      console.error("Load invoice error:", e);
      alert("Failed to load invoice.");
    }
  });

  // üíæ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ saveInvoice —Ç–∞–∫, —â–æ–± –ø–∏—Å–∞–ª–æ —É Firestore (–∞–ª–µ UI –ª–∏—à–∞—î—Ç—å—Å—è)
  const saveToFirestore = async (invoice) => {
    const user = auth.currentUser;
    if (!user) throw new Error("Not authenticated");

    // –∑–∞–≤–∂–¥–∏ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —É —Å–≤–æ—ó–π –≥—ñ–ª—Ü—ñ
    invoice.userId = user.uid;

    if (window.EDITING_ID) {
      // update
      await setDoc(doc(db, "users", user.uid, "invoices", window.EDITING_ID), invoice, { merge: true });
      return { updated: true, id: window.EDITING_ID };
    } else {
      // create
      const ref = await addDoc(collection(db, "users", user.uid, "invoices"), invoice);
      return { created: true, id: ref.id };
    }
  };

  // —Ä–æ–±–∏–º–æ –ø—É–±–ª—ñ—á–Ω–æ—é –Ω–æ–≤—É —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é
  window.saveInvoice = async function () {
    try {
      // –∑—ñ–±—Ä–∞—Ç–∏ DOM ‚Üí invoice
      const inv = collectInvoiceFromDom();
      // –ø—ñ–¥—Å—Ç—Ä–∞—Ö—É—î–º–æ—Å—å —â–æ–¥–æ –Ω–æ–º–µ—Ä–∞
      if (!inv.invoiceNumber && typeof window.generateNextInvoiceNumber === "function") {
        inv.invoiceNumber = window.generateNextInvoiceNumber();
      }

      const res = await saveToFirestore(inv);
      alert(res.updated ? "‚úÖ Invoice updated!" : "‚úÖ Invoice saved!");
      location.href = "invoices-list.html";
    } catch (e) {
      console.error(e);
      alert("‚ùå Failed to save invoice.");
    }
  };
</script>
</body>
</html>
