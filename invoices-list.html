<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìã SmartWerk ‚Äî Invoices List</title>
  <link rel="stylesheet" href="style-invoices.css?v=7"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<header>
  <h1>üìã Invoices List</h1>
  <div class="header-actions">
    <a href="invoices.html" class="btn" onclick="localStorage.removeItem('editInvoiceId')">‚ûï New Invoice</a>
    <a href="dashboard.html" class="btn">üè† Back to Dashboard</a>
  </div>
</header>

<section class="filters">
  <h3>üìÖ Filters & Search</h3>
  From: <input type="date" id="fromDate">
  To: <input type="date" id="toDate">
  <label>Status:
    <select id="statusFilter">
      <option value="all">All</option>
      <option value="Draft">Draft</option>
      <option value="Sent">Sent</option>
      <option value="Paid">Paid</option>
      <option value="Reminder Sent">Reminder Sent</option>
    </select>
  </label>
  <label>Search: <input type="text" id="searchBox" placeholder="Client, number, amount"></label>
  <label>Sort by:
    <select id="sortBy">
      <option value="invoiceNumber_desc">Invoice # (new)</option>
      <option value="invoiceNumber_asc">Invoice # (old)</option>
      <option value="date_desc">Date (new)</option>
      <option value="date_asc">Date (old)</option>
      <option value="amount_desc">Amount (high ‚Üí low)</option>
      <option value="amount_asc">Amount (low ‚Üí high)</option>
    </select>
  </label>
  <button onclick="resetFilters()">‚ôªÔ∏è Reset</button>
</section>

<section>
  <table id="invoicesTable">
    <thead>
    <tr>
      <th>Invoice #</th>
      <th>Client</th>
      <th>Status</th>
      <th>Date</th>
      <th>Total</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody id="invoicesBody"></tbody>
  </table>
</section>

<footer>
  <p>¬© 2025‚Äì2030 SmartWerk. All rights reserved.</p>
</footer>

<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  
  import {
    getFirestore, collection, doc, setDoc, deleteDoc,
    onSnapshot, query, orderBy, setLogLevel
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // üîá –í–∏–º–∏–∫–∞—î–º–æ –∑–∞–π–≤—ñ debug-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è Firestore
  setLogLevel("error");

  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1",
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let invoices = [];
const $ = sel => document.querySelector(sel);

// ==== Render ====
function renderInvoices() {
  const body = $("#invoicesBody");
  body.innerHTML = "";

  const from = $("#fromDate").value;
  const to = $("#toDate").value;
  const status = $("#statusFilter").value;
  const search = $("#searchBox").value.toLowerCase();
  const sortBy = $("#sortBy").value;

  let filtered = invoices.filter(inv => {
    let ok = true;

    // –§—ñ–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
    if (status !== "all") ok = ok && inv.status === status;

    // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ
    if (from) ok = ok && (inv.invoiceDate || "") >= from;
    if (to) ok = ok && (inv.invoiceDate || "") <= to;

    // –ü–æ—à—É–∫ (–ø–æ –∫–ª—ñ—î–Ω—Ç—É, –Ω–æ–º–µ—Ä—É —ñ —Å—É–º—ñ)
    if (search) {
      const totalStr = String(inv.grandTotal || "").toLowerCase();
      ok = ok && (
        (inv.clientName || "").toLowerCase().includes(search) ||
        (inv.invoiceNumber || "").toLowerCase().includes(search) ||
        totalStr.includes(search)
      );
    }

    return ok;
  });

  // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
  filtered.sort((a, b) => {
    switch (sortBy) {
      case "invoiceNumber_desc": {
        const numA = parseInt((a.invoiceNumber || "").split("-").pop()) || 0;
        const numB = parseInt((b.invoiceNumber || "").split("-").pop()) || 0;
        return numB - numA;
      }
      case "invoiceNumber_asc": {
        const numA = parseInt((a.invoiceNumber || "").split("-").pop()) || 0;
        const numB = parseInt((b.invoiceNumber || "").split("-").pop()) || 0;
        return numA - numB;
      }
      case "date_desc": return new Date(b.invoiceDate).getTime() - new Date(a.invoiceDate).getTime();
      case "date_asc": return new Date(a.invoiceDate).getTime() - new Date(b.invoiceDate).getTime();
      case "amount_desc": return (parseFloat(b.grandTotal) || 0) - (parseFloat(a.grandTotal) || 0);
      case "amount_asc": return (parseFloat(a.grandTotal) || 0) - (parseFloat(b.grandTotal) || 0);
    }
    return 0;
  });

  // –†–µ–Ω–¥–µ—Ä
  filtered.forEach(inv => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${inv.invoiceNumber || "‚Äî"}</td>
      <td>${inv.clientName || "‚Äî"}</td>
      <td>${inv.status || "Draft"}</td>
      <td>${inv.invoiceDate || "‚Äî"}</td>
      <td>‚Ç¨${(parseFloat(inv.grandTotal) || 0).toFixed(2)}</td>
      <td>
        <button onclick="editInvoice('${inv.id}')">‚úèÔ∏è Edit</button>
        <button onclick="deleteInvoice('${inv.id}')">üóë Delete</button>
        <button onclick="downloadPDF('${inv.id}', true)">üìÑ PDF</button>
        <button onclick="downloadPDF('${inv.id}', false)">PRO üìÑ PDF without branding</button>
      </td>`;
    body.appendChild(tr);
  });
}

  // --- Live search & filters ---
document.addEventListener("DOMContentLoaded", () => {
  // –ø–æ—à—É–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
  $("#searchBox")?.addEventListener("input", renderInvoices);

  // —Ñ—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞—Ö
  $("#fromDate")?.addEventListener("change", renderInvoices);
  $("#toDate")?.addEventListener("change", renderInvoices);

  // —Ñ—ñ–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
  $("#statusFilter")?.addEventListener("change", renderInvoices);

  // —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
  $("#sortBy")?.addEventListener("change", renderInvoices);
});

// ==== Actions ====
window.editInvoice = id => {
  localStorage.setItem("editInvoiceId", id);
  window.location.href = "invoices.html";
};
window.deleteInvoice = async id => {
  if (!confirm("Delete this invoice?")) return;
  const user = auth.currentUser;
  if (!user) return;
  await deleteDoc(doc(db, "users", user.uid, "invoices", id));
};

// ==== PDF ====
window.downloadPDF = (id, withBranding = true) => {
  const inv = invoices.find(i => i.id === id);
  if (!inv) return;
  const { jsPDF } = window.jspdf;
  const docPDF = new jsPDF();

  docPDF.setFontSize(18);
  docPDF.text("INVOICE", 105, 15, { align: "center" });

  docPDF.setFontSize(12);
  docPDF.text("From:", 14, 30);
  docPDF.text([
    inv.businessName,
    `KvK: ${inv.kvk}`,
    `IBAN: ${inv.iban}`,
    `Email: ${inv.email}`,
    `BTW: ${inv.btw}`,
    `Address: ${inv.businessAddress}`,
    `Phone: ${inv.businessPhone}`
  ], 14, 36);

  docPDF.text("To:", 120, 30);
  docPDF.text([
    inv.clientName,
    inv.clientEmail,
    `Address: ${inv.clientAddress}`,
    `Phone: ${inv.clientPhone}`
  ], 120, 36);

  // --- —Ç—É—Ç –¥–æ–¥–∞—î–º–æ —Ä–æ–∑–¥—ñ–ª—é—é—á—É –ª—ñ–Ω—ñ—é ---
docPDF.setDrawColor(200);
docPDF.line(14, 70, 195, 70); // —Å—ñ—Ä–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è

 // –¢–∞–±–ª–∏—Ü—è –∑ –∑–∞–≥–∞–ª—å–Ω–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ —ñ–Ω–≤–æ–π—Å
docPDF.autoTable({
  startY: 80,
  head: [["Invoice #", "Date Issued", "Due Date", "Status"]],
  body: [[inv.invoiceNumber, inv.invoiceDate, inv.dueDate, inv.status]],
  theme: "grid",
  styles: {
    fontSize: 11,
    cellPadding: 4,
    halign: "center",
    valign: "middle"
  },
  headStyles: {
    fillColor: [37, 99, 235], // –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π —Å–∏–Ω—ñ–π
    textColor: 255,
    fontStyle: "bold"
  },
  bodyStyles: {
    textColor: 50
  }
});

// –¢–∞–±–ª–∏—Ü—è –∑ –ø–æ–∑–∏—Ü—ñ—è–º–∏ (items)
const items = inv.items?.map(it => [
  it.desc,
  it.qty,
  `‚Ç¨${parseFloat(it.price).toFixed(2)}`,
  `${it.vat}%`,
  `‚Ç¨${(it.qty * it.price * (1 + it.vat / 100)).toFixed(2)}`
]) || [];

docPDF.autoTable({
  startY: docPDF.lastAutoTable.finalY + 10, // –©–æ–± –ø–æ—á–∞—Ç–∏ –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ—ó —Ç–∞–±–ª–∏—Ü—ñ
  head: [["Description", "Qty", "Unit Price", "VAT", "Total"]],
  body: items,
  theme: "grid",
  styles: {
    fontSize: 11,
    cellPadding: 4,
    halign: "center",
    valign: "middle"
  },
  headStyles: {
    fillColor: [37, 99, 235], // –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π —Å–∏–Ω—ñ–π
    textColor: 255,
    fontStyle: "bold"
  },
  bodyStyles: {
    textColor: 50
  }
});

 docPDF.text(`Subtotal: ${inv.subtotalFormatted}`, 150, docPDF.lastAutoTable.finalY + 10);
docPDF.text(`VAT: ${inv.totalVatFormatted}`, 150, docPDF.lastAutoTable.finalY + 16);
docPDF.text(`Total Due: ${inv.grandTotalFormatted}`, 150, docPDF.lastAutoTable.finalY + 22);


  if (inv.note) {
    docPDF.text("Note:", 14, docPDF.lastAutoTable.finalY + 10);
    docPDF.text(inv.note, 14, docPDF.lastAutoTable.finalY + 16);
  }

  if (inv.signatures?.business) {
  docPDF.addImage(inv.signatures.business, "PNG", 14, docPDF.lastAutoTable.finalY + 30, 60, 20);
    docPDF.text("Business Signature", 14, docPDF.lastAutoTable.finalY + 62);
  docPDF.text("_________________________", 14, docPDF.lastAutoTable.finalY + 55);
  if (inv.signatures.businessDate) docPDF.text(`Date: ${inv.signatures.businessDate}`, 14, docPDF.lastAutoTable.finalY + 69);
}
if (inv.signatures?.client) {
  docPDF.addImage(inv.signatures.client, "PNG", 120, docPDF.lastAutoTable.finalY + 30, 60, 20);
   docPDF.text("Client Signature", 120, docPDF.lastAutoTable.finalY + 62);
  docPDF.text("_________________________", 120, docPDF.lastAutoTable.finalY + 55);
  if (inv.signatures.clientDate) docPDF.text(`Date: ${inv.signatures.clientDate}`, 120, docPDF.lastAutoTable.finalY + 69);
}

  if (withBranding) {
    docPDF.setFontSize(10);
    docPDF.text("Generated with SmartWerk", 105, 290, { align: "center" });
  }

  docPDF.save(`${inv.invoiceNumber}.pdf`);
};

 

// ==== Filters ====
window.resetFilters = () => {
  $("#fromDate").value = "";
  $("#toDate").value = "";
  $("#statusFilter").value = "all";
  $("#searchBox").value = "";
  $("#sortBy").value = "invoiceNumber_desc";
  renderInvoices();
};

// ==== Realtime ====
onAuthStateChanged(auth, user => {
  if (!user) return location.href = "login.html";
  const colRef = collection(db, "users", user.uid, "invoices");
  const q = query(colRef, orderBy("invoiceDate", "desc"));
  onSnapshot(q, snap => {
    invoices = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderInvoices();
  });
});
</script>
</body>
</html>
