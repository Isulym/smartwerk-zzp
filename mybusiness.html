<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìä My Business</title>
  <link rel="stylesheet" href="style-mybusiness.css"/>
</head>
<body>

<nav class="nav-bar">
  <button onclick="location.href='tax-calculator.html'">‚Üê Tax Calculator</button>
  <button onclick="location.href='dashboard.html'">‚Üê Back to Dashboard</button>
</nav>

<main>

  <h1>üìä My Business Dashboard</h1>
<p class="intro">
  This dashboard shows a summary of all your tax reports generated using SmartWerk.
  You can see your gross income, expenses, taxes, savings, and net profit ‚Äî plus a quarterly breakdown.
</p>
  
  <section class="kpis">
    <div class="kpi"><h3>Total Income</h3><p id="kpi-income">‚Ç¨0.00</p><small>All gross income entries</small></div>
    <div class="kpi"><h3>Total Expenses</h3><p id="kpi-expenses">‚Ç¨0.00</p><small>Vehicle, Office, Internet, etc.</small></div>
    <div class="kpi"><h3>Total Tax</h3><p id="kpi-tax">‚Ç¨0.00</p><small>Income Tax + ZVW + BTW</small></div>
    <div class="kpi"><h3>Tax Savings</h3><p id="kpi-saved">‚Ç¨0.00</p><small>ZZP + MKB deductions</small></div>
    <div class="kpi"><h3>Net Income After Tax</h3><p id="kpi-net">‚Ç¨0.00</p><small>Final income after all tax deductions</small></div>
    <div class="kpi"><h3>Reports</h3><p id="kpi-count">0</p><small>Total saved calculations</small></div>
  </section>

   <section class="bar-chart">
  <h2>üìÖ Quarterly Net Income</h2>
    <div class="bar-wrapper"><div class="bar" id="q1"></div><span>Q1</span></div>
    <div class="bar-wrapper"><div class="bar" id="q2"></div><span>Q2</span></div>
    <div class="bar-wrapper"><div class="bar" id="q3"></div><span>Q3</span></div>
    <div class="bar-wrapper"><div class="bar" id="q4"></div><span>Q4</span></div>
   </section>
</main>

<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  onAuthStateChanged(auth, user => {
  if (!user) return location.href = "login.html";
  currentUser = user;
  document.addEventListener("DOMContentLoaded", () => {
    loadSummary(); // ‚úÖ DOM —Ç–æ—á–Ω–æ —î
  });
});

  async function loadSummary() {
    const q = query(collection(db, "users", currentUser.uid, "tax_calculations"), orderBy("date", "desc"));
    const snap = await getDocs(q);

    let totalIncome = 0, totalExpenses = 0, totalTax = 0, totalSaved = 0, netAfterTax = 0, count = 0;
    const quarterly = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };

    snap.forEach(doc => {
      const d = doc.data();
      totalIncome += d.income || 0;
      totalExpenses += d.totalExpenses || 0;
      totalTax += d.totalTax || 0;
      netAfterTax += d.netIncome || 0;
      totalSaved += (d.zzpDeductions || 0) + (d.mkbVrijstelling || 0);
      count++;

      const month = new Date(d.date).getMonth() + 1;
      const quarter = month <= 3 ? 'Q1' : month <= 6 ? 'Q2' : month <= 9 ? 'Q3' : 'Q4';
      quarterly[quarter] += d.netIncome || 0;
    });

    document.getElementById("kpi-income").textContent = "‚Ç¨" + totalIncome.toFixed(2);
    document.getElementById("kpi-expenses").textContent = "‚Ç¨" + totalExpenses.toFixed(2);
    document.getElementById("kpi-tax").textContent = "‚Ç¨" + totalTax.toFixed(2);
    document.getElementById("kpi-saved").textContent = "‚Ç¨" + totalSaved.toFixed(2);
    document.getElementById("kpi-net").textContent = "‚Ç¨" + netAfterTax.toFixed(2);
    document.getElementById("kpi-count").textContent = count;

    if (count === 0) {
  const msg = document.createElement("p");
  msg.className = "no-data";
  msg.textContent = "No reports found yet. Use the Tax Calculator to generate your first report.";
  document.querySelector("main").appendChild(msg);
}

    ["q1", "q2", "q3", "q4"].forEach(q => {
      const height = Math.min(quarterly[q.toUpperCase()] / 50, 200);
      const el = document.getElementById(q);
      el.style.height = height + "px";
      el.title = "‚Ç¨" + quarterly[q.toUpperCase()].toFixed(2);
    });
  }
</script>
</body>
</html>
