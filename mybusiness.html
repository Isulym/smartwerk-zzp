<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“Š My Business</title>
  <link rel="stylesheet" href="style-mybusiness.css"/>
</head>
<body>

<nav class="nav-bar">
  <button onclick="location.href='tax-calculator.html'">â† Tax Calculator</button>
  <button onclick="location.href='dashboard.html'">â† Back to Dashboard</button>
</nav>

<main>
  <h1>ğŸ“Š My Business Dashboard</h1>

  <section class="kpis">
    <div><h3>Total Income</h3><p id="kpi-income">â‚¬0.00</p></div>
    <div><h3>Total Expenses</h3><p id="kpi-expenses">â‚¬0.00</p></div>
    <div><h3>Total Tax</h3><p id="kpi-tax">â‚¬0.00</p></div>
    <div><h3>Tax Savings</h3><p id="kpi-saved">â‚¬0.00</p></div>
    <div><h3>Reports</h3><p id="kpi-count">0</p></div>
  </section>

  <h2>ğŸ“… Quarterly Net Income</h2>
  <div class="bar-chart">
    <div class="bar-wrapper"><div class="bar" id="q1"></div><span>Q1</span></div>
    <div class="bar-wrapper"><div class="bar" id="q2"></div><span>Q2</span></div>
    <div class="bar-wrapper"><div class="bar" id="q3"></div><span>Q3</span></div>
    <div class="bar-wrapper"><div class="bar" id="q4"></div><span>Q4</span></div>
  </div>
</main>

<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if (!user) {
      console.warn("Not logged in. Redirecting...");
      location.href = "login.html";
      return;
    }

    currentUser = user;
    loadSummary();
  });

  async function loadSummary() {
    const q = query(collection(db, "users", currentUser.uid, "tax_calculations"), orderBy("date", "desc"));
    const snap = await getDocs(q);

    let totalIncome = 0, totalExpenses = 0, totalTax = 0, totalSaved = 0, count = 0;
    const quarterly = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };

    snap.forEach(doc => {
      const d = doc.data();
      totalIncome += d.income || 0;
      totalExpenses += d.totalExpenses || 0;
      totalTax += d.totalTax || 0;
      totalSaved += (d.zzpDeductions || 0) + (d.mkbVrijstelling || 0);
      count++;

      const month = new Date(d.date).getMonth() + 1;
      const q = month <= 3 ? "Q1" : month <= 6 ? "Q2" : month <= 9 ? "Q3" : "Q4";
      quarterly[q] += d.netIncome || 0;
    });

    document.getElementById("kpi-income").textContent = "â‚¬" + totalIncome.toFixed(2);
    document.getElementById("kpi-expenses").textContent = "â‚¬" + totalExpenses.toFixed(2);
    document.getElementById("kpi-tax").textContent = "â‚¬" + totalTax.toFixed(2);
    document.getElementById("kpi-saved").textContent = "â‚¬" + totalSaved.toFixed(2);
    document.getElementById("kpi-count").textContent = count + " reports";

    ["q1", "q2", "q3", "q4"].forEach(q => {
      const value = quarterly[q.toUpperCase()];
      const height = Math.min(value / 50, 200); // max height = 200px
      document.getElementById(q).style.height = height + "px";
    });
  }
</script>

</body>
</html>
