<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk Tax Calculator</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 2rem; background: #f9f9f9; color:#222; }
    h2, h3 { color:#333; margin: 0 0 .75rem 0; }
    .section { background:#fff; padding:20px; margin-bottom:20px; border-radius:10px; box-shadow: 0 8px 18px rgba(0,0,0,.05); }
    label { display:block; margin-top:10px; font-weight:600; }
    input, select, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #ddd; border-radius:8px; font-size:15px; }
    textarea { resize: vertical; min-height: 70px; }
    .button-group{ display:flex; gap:12px; margin-top:16px; }
    .button-group button{ padding:10px 14px; border:0; border-radius:8px; cursor:pointer; font-weight:700; }
    .button-primary{ background:#0b5cff; color:#fff; }
    .button-secondary{ background:#eee; color:#111; }
    .summary p{ margin:.25rem 0; }
    .muted{ color:#666; font-weight:400; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>window.jsPDF = window.jspdf.jsPDF;</script>
</head>
<body>
  <h2>SmartWerk Tax Calculator</h2>

  <!-- Step 1 -->
  <div class="section">
    <h3>Step 1: Your Data</h3>

    <label>Company Name:<input type="text" id="companyName"/></label>
    <label>Email / Phone:<input type="text" id="email"/></label>

    <label for="period">Period</label>
    <select id="period">
      <option value="Q1">January ‚Äì March (Q1)</option>
      <option value="Q2">April ‚Äì June (Q2)</option>
      <option value="Q3">July ‚Äì September (Q3)</option>
      <option value="Q4">October ‚Äì December (Q4)</option>
    </select>

    <label>Hours Worked:<input type="number" id="hoursWorked"/></label>
    <label>Hourly Rate (EUR):<input type="number" id="hourlyRate"/></label>
    <label>Total Income (auto):<input type="number" id="income" readonly/></label>

    <label>KvK Number:<input type="text" id="kvkNumber"/></label>
    <label>VAT Number:<input type="text" id="vatNumber"/></label>
    <label>IBAN:<input type="text" id="iban"/></label>
    <label>Contact Person:<input type="text" id="contactPerson"/></label>

    <label for="reportingNotes">Reporting Notes (optional):</label>
    <textarea id="reportingNotes" rows="2" placeholder="E.g. one-time setup costs, pending invoices‚Ä¶"></textarea>
  </div>

  <!-- Step 2 -->
  <div class="section">
    <h3>Step 2: Business Expenses</h3>

    <label>Transport & Vehicle Costs:
      <span class="muted">(car, fuel, public transport, bike lease, etc.)</span>
      <input type="number" id="vehicle"/>
    </label>

    <label>Workspace & Rent Costs:
      <span class="muted">(home office, coworking, energy, heating, etc.)</span>
      <input type="number" id="office"/>
    </label>

    <label>Internet & Communication:
      <span class="muted">(mobile, Wi-Fi, VoIP, domain, calls, etc.)</span>
      <input type="number" id="internet"/>
    </label>

    <label>Marketing & Advertising:
      <span class="muted">(website, ads, design, campaigns, etc.)</span>
      <input type="number" id="marketing"/>
    </label>

    <label>Business Gifts & Representation:
      <span class="muted">(networking, client gifts, events, etc.)</span>
      <input type="number" id="other"/>
    </label>

    <label>Study, Insurance & Misc:
      <span class="muted">(courses, software, accountant, insurance, banking, etc.)</span>
      <input type="number" id="extraBenefits"/>
    </label>
  </div>

  <!-- Step 3 -->
  <div class="section">
    <h3>Step 3: Tax Options</h3>

    <label for="kvk">KvK Registered?
      <span class="muted">(required for most deductions)</span>
    </label>
    <select id="kvk">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label for="zzpHours">Worked ‚â•1,225 hours?
      <span class="muted">(required for ZZP deductions)</span>
    </label>
    <select id="zzpHours">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label for="btwRate">BTW Rate:
      <span class="muted">(21% standard, 9% reduced, 0% exempt)</span>
    </label>
    <select id="btwRate">
      <option value="21">21%</option>
      <option value="9">9%</option>
      <option value="0">0%</option>
    </select>

    <label for="kor">Use KOR?
      <span class="muted">(Small Business Scheme; exempts charging VAT)</span>
    </label>
    <select id="kor">
      <option value="no">No</option>
      <option value="yes">Yes</option>
    </select>
  </div>

  <!-- Step 4 -->
  <div class="section summary">
    <h3>Step 4: Result</h3>

    <div id="result">
      <!-- Deduction Breakdown (statuses) -->
      <div class="section" id="deduction-breakdown" style="padding:12px; margin:0 0 12px 0;">
        <h3 style="margin:0 0 .5rem 0;">Deduction Breakdown</h3>
        <p><strong>ZZP eligibility:</strong> <span id="zzp-status">‚Äî</span></p>
        <p><strong>KvK status:</strong> <span id="kvk-status">‚Äî</span></p>
        <p><strong>KOR usage:</strong> <span id="kor-status">‚Äî</span></p>
      </div>

      <p><strong>Gross Income:</strong> <span id="grossIncome"></span></p>
      <p><strong>Total Expenses:</strong> <span id="totalExpenses"></span></p>
      <p><strong>Taxable Profit:</strong> <span id="taxableProfit"></span></p>
      <p><strong>ZZP Deductions:</strong> <span id="zzpDeductions"></span></p>
      <p><strong>MKB Exemption (12.7%):</strong> <span id="mkbVrijstelling"></span></p>
      <p><strong>Final Taxable Income:</strong> <span id="finalTaxable"></span></p>
      <p><strong>Income Tax:</strong> <span id="incomeTax"></span></p>
      <p><strong>ZVW (5.32%):</strong> <span id="zvwAmount"></span></p>
      <p><strong>BTW Amount:</strong> <span id="btwAmount"></span></p>
      <p><strong>Total Estimated Tax:</strong> <span id="totalTax"></span></p>

      <div id="reportingNotesWrapper" style="display:none;">
        <p><strong>Reporting Notes:</strong> <span id="reportingNotesOutput"></span></p>
      </div>
    </div>

    <div class="button-group">
      <button id="btn-calc" class="button-primary">üîÅ Calculate Tax</button>
      <button id="btn-pdf" class="button-secondary">üßæ Export as PDF</button>
    </div>
  </div>

  <!-- ===== Utilities & Logic ===== -->
  <script>
    // ---------- Anti-null expected IDs ----------
    const REQUIRED_IDS = [
      "companyName","email","period","hoursWorked","hourlyRate","income",
      "kvkNumber","vatNumber","iban","contactPerson","reportingNotes",
      "vehicle","office","internet","marketing","other","extraBenefits",
      "kvk","zzpHours","btwRate","kor",
      "grossIncome","totalExpenses","taxableProfit","zzpDeductions",
      "mkbVrijstelling","finalTaxable","incomeTax","zvwAmount","btwAmount","totalTax",
      "reportingNotesWrapper","reportingNotesOutput",
      "zzp-status","kvk-status","kor-status"
    ];
    function $(id){ return document.getElementById(id); }
    const Safe = {
      text(id, v){ const el=$(id); if(el){ el.textContent=String(v); } else { console.warn(`‚õî Missing #${id}`);} },
      val(id){ const el=$(id); if(!el){ console.warn(`‚õî Missing #${id}`); return ""; } return el.value ?? ""; }
    };
    function num(id){ const s=(Safe.val(id)||"").toString().replace(",","."); const n=parseFloat(s); return Number.isFinite(n)?n:0; }
    function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
    function clamp0(x){ return x < 0 ? 0 : x; }

    // highlight missing IDs on load
    document.addEventListener("DOMContentLoaded", () => {
      const missing = REQUIRED_IDS.filter(id => !$(id));
      if (missing.length){
        console.table(missing.map(id => ({missing:id})));
        const b = document.createElement("div");
        b.style.cssText = "position:fixed;top:0;left:0;right:0;padding:10px;background:#d00;color:#fff;z-index:9999";
        b.textContent = "Missing IDs: " + missing.join(", ");
        document.body.appendChild(b);
        setTimeout(()=>b.remove(), 10000);
      }
    });

    // ---------- Auto income from hours * rate ----------
    function autoCalcIncome(){
      const h = num("hoursWorked");
      const r = num("hourlyRate");
      const val = round2(h * r);
      const incomeEl = $("income");
      if (incomeEl) incomeEl.value = val.toFixed(2);
    }

    // ---------- Main calculation ----------
    function calculateTax(){
      autoCalcIncome();

      const income        = num("income");
      const vehicle       = num("vehicle");
      const office        = num("office");
      const internet      = num("internet");
      const marketing     = num("marketing");
      const other         = num("other");
      const extraBenefits = num("extraBenefits");

      const kvk     = Safe.val("kvk") === "yes";
      const zzp     = Safe.val("zzpHours") === "yes";
      const kor     = Safe.val("kor") === "yes";
      const btwRate = parseFloat((Safe.val("btwRate")||"0").replace(",", ".")) || 0;

      const totalExpenses = vehicle + office + internet + marketing + other + extraBenefits;
      const profit = income - totalExpenses;

      // ZZP deductions (basic model)
      const zelfstandigenaftrek = 5030;
      const startersaftrek = (kvk && zzp) ? 2123 : 0;
      const zzpDeductions = (kvk && zzp) ? (zelfstandigenaftrek + startersaftrek) : 0;

      // MKB 12.7% after ZZP
      const taxableBeforeMKB = clamp0(profit - zzpDeductions);
      const mkbVrijstelling  = round2(taxableBeforeMKB * 0.127);

      // Tariff cap 37.48%
      const maxDeductibleValue = round2(profit * 0.3748);
      const cappedZZP = Math.min(zzpDeductions, maxDeductibleValue);
      const cappedMKB = Math.min(mkbVrijstelling, clamp0(maxDeductibleValue - cappedZZP));
      const totalSaved = cappedZZP + cappedMKB;

      const finalTaxable = clamp0(profit - totalSaved);

      // Income tax: 19% to 200k, then 25.8%
      let incomeTax = 0;
      if (finalTaxable > 200000){
        incomeTax = round2(200000 * 0.19 + (finalTaxable - 200000) * 0.258);
      } else {
        incomeTax = round2(finalTaxable * 0.19);
      }

      // ZVW 5.32%
      const zvwAmount = round2(finalTaxable * 0.0532);

      // BTW
      const btwAmount = kor ? 0 : round2(profit * (btwRate / 100));
      const totalTax  = round2(incomeTax + zvwAmount + btwAmount);

      // DOM output
      Safe.text("grossIncome", income.toFixed(2));
      Safe.text("totalExpenses", totalExpenses.toFixed(2));
      Safe.text("taxableProfit", profit.toFixed(2));
      Safe.text("zzpDeductions", zzpDeductions.toFixed(2));
      Safe.text("mkbVrijstelling", mkbVrijstelling.toFixed(2));
      Safe.text("finalTaxable", finalTaxable.toFixed(2));
      Safe.text("incomeTax", incomeTax.toFixed(2));
      Safe.text("zvwAmount", zvwAmount.toFixed(2));
      Safe.text("btwAmount", btwAmount.toFixed(2));
      Safe.text("totalTax", totalTax.toFixed(2));

      // Notes show/hide
      const notes = Safe.val("reportingNotes");
      const wrap = $("reportingNotesWrapper");
      const out  = $("reportingNotesOutput");
      if (wrap && out){
        if ((notes||"").trim()){
          out.textContent = notes;
          wrap.style.display = "block";
        } else {
          wrap.style.display = "none";
        }
      }

      // statuses
      Safe.text("zzp-status", (kvk && zzp) ? "eligible ‚úÖ" : "not eligible ‚ùå");
      Safe.text("kvk-status", kvk ? "eligible ‚úÖ" : "not eligible ‚ùå");
      Safe.text("kor-status", kor ? "applied ‚úÖ" : "not used ‚ùå");
    }

    // ---------- PDF export ----------
    function exportPDF(){
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("SmartWerk Tax Report", 15, 15);
      let y = 25;

      const T = id => ($(id)?.textContent ?? "");
      const V = id => Safe.val(id);

      // Contact block
      doc.setFontSize(11);
      [
        `Company: ${V("companyName")}`,
        `Email / Phone: ${V("email")}`,
        `Period: ${V("period")}`,
        `Hours worked: ${V("hoursWorked")}`,
        `Hourly Rate: ‚Ç¨${V("hourlyRate")}`,
        `Input 'Income': ‚Ç¨${V("income")}`,
        `KvK Number: ${V("kvkNumber")}`,
        `VAT Number: ${V("vatNumber")}`,
        `IBAN: ${V("iban")}`,
        `Contact Person: ${V("contactPerson")}`
      ].forEach(line => { doc.text(line, 15, y); y += 6; });
      y += 6;

      // Summary
      doc.setFontSize(12);
      doc.text("Calculation Summary:", 15, y); y += 8;
      doc.setFontSize(11);
      [
        `Gross Income: ‚Ç¨${T("grossIncome")}`,
        `Total Expenses: ‚Ç¨${T("totalExpenses")}`,
        `Taxable Profit: ‚Ç¨${T("taxableProfit")}`,
        `ZZP Deductions: ‚Ç¨${T("zzpDeductions")}`,
        `MKB Exemption (12.7%): ‚Ç¨${T("mkbVrijstelling")}`,
        `Final Taxable Income: ‚Ç¨${T("finalTaxable")}`,
        `Income Tax: ‚Ç¨${T("incomeTax")}`,
        `ZVW (5.32%): ‚Ç¨${T("zvwAmount")}`,
        `BTW: ‚Ç¨${T("btwAmount")}`,
        `Total Estimated Tax: ‚Ç¨${T("totalTax")}`
      ].forEach(line => { doc.text(line, 15, y); y += 6; });

      // Notes
      const notes = V("reportingNotes");
      if ((notes||"").trim()){
        y += 8;
        doc.setFontSize(12);
        doc.text("Reporting Notes:", 15, y); y += 7;
        doc.setFontSize(11);
        doc.splitTextToSize(notes, 180).forEach(row => { doc.text(row, 15, y); y += 6; });
      }

      doc.save("smartwerk-tax-report.pdf");
    }

    // ---------- Wiring ----------
    document.addEventListener("DOMContentLoaded", () => {
      // listeners
      document.querySelectorAll("input, select, textarea")
        .forEach(el => { el.addEventListener("input", calculateTax); el.addEventListener("change", calculateTax); });

      const btnCalc = $("btn-calc");
      const btnPdf  = $("btn-pdf");
      if (btnCalc) btnCalc.addEventListener("click", calculateTax);
      if (btnPdf)  btnPdf.addEventListener("click", exportPDF);

      // initial
      calculateTax();
    });
  </script>
</body>
</html>
