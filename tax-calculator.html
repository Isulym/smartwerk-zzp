<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk Tax Calculator</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 2rem; background: #f9f9f9; color:#222; }
    h2, h3 { color:#333; margin: 0 0 .75rem 0; }
    .section { background:#fff; padding:20px; margin-bottom:20px; border-radius:10px; box-shadow: 0 8px 18px rgba(0,0,0,.05); }
    label { display:block; margin-top:10px; font-weight:600; }
    input, select, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #ddd; border-radius:8px; font-size:15px; }
    textarea { resize: vertical; min-height: 70px; }
    .button-group{ display:flex; gap:12px; margin-top:16px; }
    .button-group button{ padding:10px 14px; border:0; border-radius:8px; cursor:pointer; font-weight:700; }
    .button-primary{ background:#0b5cff; color:#fff; }
    .button-secondary{ background:#eee; color:#111; }
    .summary p{ margin:.25rem 0; }
    .muted{ color:#666; font-weight:400; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>window.jsPDF = window.jspdf.jsPDF;</script>
</head>
<body>
  <h2>SmartWerk Tax Calculator</h2>

  <!-- Step 1 -->
  <div class="section">
    <h3>Step 1: Your Data</h3>

    <label>Company Name:<input type="text" id="companyName"/></label>
    <label>Email / Phone:<input type="text" id="email"/></label>

    <label for="period">Period</label>
    <select id="period">
      <option value="Q1">January ‚Äì March (Q1)</option>
      <option value="Q2">April ‚Äì June (Q2)</option>
      <option value="Q3">July ‚Äì September (Q3)</option>
      <option value="Q4">October ‚Äì December (Q4)</option>
    </select>

    <label>Hours Worked:<input type="number" id="hoursWorked"/></label>
    <label>Hourly Rate (EUR):<input type="number" id="hourlyRate"/></label>
    <label>Total Income (auto):<input type="number" id="income" readonly/></label>

    <label>KvK Number:<input type="text" id="kvkNumber"/></label>
    <label>VAT Number:<input type="text" id="vatNumber"/></label>
    <label>IBAN:<input type="text" id="iban"/></label>
    <label>Contact Person:<input type="text" id="contactPerson"/></label>

    <label for="reportingNotes">Reporting Notes (optional):</label>
    <textarea id="reportingNotes" rows="2" placeholder="E.g. one-time setup costs, pending invoices‚Ä¶"></textarea>
  </div>

  <!-- Step 2 -->
  <div class="section">
    <h3>Step 2: Business Expenses</h3>

    <label>Transport & Vehicle Costs:
      <span class="muted">(car, fuel, public transport, bike lease, etc.)</span>
      <input type="number" id="vehicle"/>
    </label>

    <label>Workspace & Rent Costs:
      <span class="muted">(home office, coworking, energy, heating, etc.)</span>
      <input type="number" id="office"/>
    </label>

    <label>Internet & Communication:
      <span class="muted">(mobile, Wi-Fi, VoIP, domain, calls, etc.)</span>
      <input type="number" id="internet"/>
    </label>

    <label>Marketing & Advertising:
      <span class="muted">(website, ads, design, campaigns, etc.)</span>
      <input type="number" id="marketing"/>
    </label>

    <label>Business Gifts & Representation:
      <span class="muted">(networking, client gifts, events, etc.)</span>
      <input type="number" id="other"/>
    </label>

    <label>Study, Insurance & Misc:
      <span class="muted">(courses, software, accountant, insurance, banking, etc.)</span>
      <input type="number" id="extraBenefits"/>
    </label>
  </div>

  <!-- Step 3 -->
  <div class="section">
    <h3>Step 3: Tax Options</h3>

    <label for="kvk">KvK Registered?
      <span class="muted">(required for most deductions)</span>
    </label>
    <select id="kvk">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label for="zzpHours">Worked ‚â•1,225 hours?
      <span class="muted">(required for ZZP deductions)</span>
    </label>
    <select id="zzpHours">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label for="btwRate">BTW Rate:
      <span class="muted">(21% standard, 9% reduced, 0% exempt)</span>
    </label>
    <select id="btwRate">
      <option value="21">21%</option>
      <option value="9">9%</option>
      <option value="0">0%</option>
    </select>

    <label for="kor">Use KOR?
      <span class="muted">(Small Business Scheme; exempts charging VAT)</span>
    </label>
    <select id="kor">
      <option value="no">No</option>
      <option value="yes">Yes</option>
    </select>
  </div>

  <!-- Step 4 -->
  <div class="section summary">
    <h3>Step 4: Result</h3>

    <div id="result">
      <!-- Deduction Breakdown (statuses) -->
      <div class="section" id="deduction-breakdown" style="padding:12px; margin:0 0 12px 0;">
        <h3 style="margin:0 0 .5rem 0;">Deduction Breakdown</h3>
        <p><strong>ZZP eligibility:</strong> <span id="zzp-status">‚Äî</span></p>
        <p><strong>KvK status:</strong> <span id="kvk-status">‚Äî</span></p>
        <p><strong>KOR usage:</strong> <span id="kor-status">‚Äî</span></p>
      </div>
      <div id="debugPanel" style="margin-top:12px; padding:10px; background:#f3f3f3; border-radius:8px;">
  <button id="btn-validate" type="button">üß™ Run validation</button>
  <span id="validateStatus" style="margin-left:10px; font-weight:600;">‚Äî</span>
  <pre id="debugOut" style="margin-top:8px; max-height:160px; overflow:auto; background:#fff; padding:8px; border:1px solid #ddd; border-radius:6px;"></pre>
</div>

      <p><strong>Gross Income:</strong> <span id="grossIncome"></span></p>
      <p><strong>Total Expenses:</strong> <span id="totalExpenses"></span></p>
      <p><strong>Taxable Profit:</strong> <span id="taxableProfit"></span></p>
      <p><strong>ZZP Deductions:</strong> <span id="zzpDeductions"></span></p>
      <p><strong>MKB Exemption (12.7%):</strong> <span id="mkbVrijstelling"></span></p>
      <p><strong>Final Taxable Income:</strong> <span id="finalTaxable"></span></p>
      <p><strong>Income Tax:</strong> <span id="incomeTax"></span></p>
      <p><strong>ZVW (5.32%):</strong> <span id="zvwAmount"></span></p>
      <p><strong>BTW Amount:</strong> <span id="btwAmount"></span></p>
      <p><strong>Total Estimated Tax:</strong> <span id="totalTax"></span></p>

      <p><strong>You saved (ZZP + MKB):</strong>
  <span id="totalSavings" class="mono" style="color:#0a0;"></span>
</p>
<p><strong>Net Income after Tax:</strong>
  <span id="netIncome" class="mono"></span>
</p>

      <div id="reportingNotesWrapper" style="display:none;">
        <p><strong>Reporting Notes:</strong> <span id="reportingNotesOutput"></span></p>
      </div>
    </div>

    <div class="button-group">
      <button id="btn-calc" class="button-primary">üîÅ Calculate Tax</button>
      <button id="btn-pdf" class="button-secondary">üßæ Export as PDF</button>
    </div>
  </div>

  <!-- ===== Utilities & Logic ===== -->
  <script>
    // ---------- Anti-null expected IDs ----------
    const REQUIRED_IDS = [
      "companyName","email","period","hoursWorked","hourlyRate","income",
      "kvkNumber","vatNumber","iban","contactPerson","reportingNotes",
      "vehicle","office","internet","marketing","other","extraBenefits",
      "kvk","zzpHours","btwRate","kor",
      "grossIncome","totalExpenses","taxableProfit","zzpDeductions",
      "mkbVrijstelling","finalTaxable","incomeTax","zvwAmount","btwAmount","totalTax",
      "reportingNotesWrapper","reportingNotesOutput","totalSavings","netIncome",
      "zzp-status","kvk-status","kor-status"
    ];
    function $(id){ return document.getElementById(id); }
    const Safe = {
      text(id, v){ const el=$(id); if(el){ el.textContent=String(v); } else { console.warn(`‚õî Missing #${id}`);} },
      val(id){ const el=$(id); if(!el){ console.warn(`‚õî Missing #${id}`); return ""; } return el.value ?? ""; }
    };
    function num(id){ const s=(Safe.val(id)||"").toString().replace(",","."); const n=parseFloat(s); return Number.isFinite(n)?n:0; }
    function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
    function clamp0(x){ return x < 0 ? 0 : x; }

    // highlight missing IDs on load
    document.addEventListener("DOMContentLoaded", () => {
      const missing = REQUIRED_IDS.filter(id => !$(id));
      if (missing.length){
        console.table(missing.map(id => ({missing:id})));
        const b = document.createElement("div");
        b.style.cssText = "position:fixed;top:0;left:0;right:0;padding:10px;background:#d00;color:#fff;z-index:9999";
        b.textContent = "Missing IDs: " + missing.join(", ");
        document.body.appendChild(b);
        setTimeout(()=>b.remove(), 10000);
      }
    });

    // ---------- Auto income from hours * rate ----------
    function autoCalcIncome(){
      const h = num("hoursWorked");
      const r = num("hourlyRate");
      const val = round2(h * r);
      const incomeEl = $("income");
      if (incomeEl) incomeEl.value = val.toFixed(2);
    }

    // ---------- Main calculation ----------
  function calculateTax(){
  // –∞–≤—Ç–æ-–ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ—Ö–æ–¥—É
  autoCalcIncome();

  // ----- –í—Ö—ñ–¥–Ω—ñ -----
  const income        = num("income");
  const vehicle       = num("vehicle");
  const office        = num("office");
  const internet      = num("internet");
  const marketing     = num("marketing");
  const other         = num("other");
  const extraBenefits = num("extraBenefits");

  const kvk     = Safe.val("kvk") === "yes";
  const zzp     = Safe.val("zzpHours") === "yes";
  const kor     = Safe.val("kor") === "yes";
  const btwRate = parseFloat((Safe.val("btwRate")||"0").replace(",", ".")) || 0;

  // ----- –ë–∞–∑–æ–≤–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ -----
  const totalExpenses = vehicle + office + internet + marketing + other + extraBenefits;
  const profit = income - totalExpenses;

  // ----- ZZP deductions (–º–æ–¥–µ–ª—å) -----
  const zelfstandigenaftrek = 5030;
  const startersaftrek      = (kvk && zzp) ? 2123 : 0;
  const zzpDeductionsRaw    = (kvk && zzp) ? (zelfstandigenaftrek + startersaftrek) : 0;

  // ----- MKB 12.7% –ø—ñ—Å–ª—è ZZP -----
 // ----- MKB 12.7% (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ ZZP eligible) -----
let taxableBeforeMKBRaw = 0;
let mkbVrijstellingRaw  = 0;
if (kvk && zzp) {
  taxableBeforeMKBRaw = clamp0(profit - zzpDeductionsRaw);
 const mkbVrijstellingRaw  = (kvk && zzp) ? round2(taxableBeforeMKBRaw * 0.127) : 0;
}
  // ----- Tariff cap 37.48% (–∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –º‚Äô—è–∫–æ) -----
  const maxDeductibleValue  = round2(Math.max(0, profit) * 0.3748);
  const cappedZZP           = Math.min(zzpDeductionsRaw, maxDeductibleValue);
  const cappedMKB           = Math.min(mkbVrijstellingRaw, clamp0(maxDeductibleValue - cappedZZP));

  // —Ç–µ–æ—Ä–µ—Ç–∏—á–Ω–æ-–∑–∞—è–≤–ª–µ–Ω—ñ (raw) vs –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ (capped)
  const theoreticalSaved    = zzpDeductionsRaw + mkbVrijstellingRaw;
  const appliedSaved        = round2(cappedZZP + cappedMKB);

  // –û—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–ø–æ–¥–∞—Ç–∫–æ–≤—É–≤–∞–Ω–∏–π –¥–æ—Ö—ñ–¥
  const finalTaxable = clamp0(profit - appliedSaved);

  // ----- –ü–æ–¥–∞—Ç–∫–∏ -----
  let incomeTax = 0;
  if (finalTaxable > 200000){
    incomeTax = round2(200000 * 0.19 + (finalTaxable - 200000) * 0.258);
  } else {
    incomeTax = round2(finalTaxable * 0.19);
  }
  const zvwAmount = round2(finalTaxable * 0.0532);
  const btwAmount = kor ? 0 : round2(profit * (btwRate / 100));
  const totalTax  = round2(incomeTax + zvwAmount + btwAmount);

  // ----- –í–∏–≤—ñ–¥ —É DOM (–ø–æ–∫–∞–∑—É—î–º–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ —Å—É–º–∏!) -----
  Safe.text("grossIncome",     income.toFixed(2));
  Safe.text("totalExpenses",   totalExpenses.toFixed(2));
  Safe.text("taxableProfit",   profit.toFixed(2));
  Safe.text("zzpDeductions",   cappedZZP.toFixed(2));      // applied
  Safe.text("mkbVrijstelling", cappedMKB.toFixed(2));      // applied
  Safe.text("finalTaxable",    finalTaxable.toFixed(2));
  Safe.text("incomeTax",       incomeTax.toFixed(2));
  Safe.text("zvwAmount",       zvwAmount.toFixed(2));
  Safe.text("btwAmount",       btwAmount.toFixed(2));
  Safe.text("totalTax",        totalTax.toFixed(2));
  Safe.text("totalSavings", appliedSaved.toFixed(2));
  Safe.text("netIncome",    round2(income - totalExpenses - totalTax).toFixed(2)); // "—á–∏—Å—Ç–∏–π" –ø—ñ—Å–ª—è –≤–∏—Ç—Ä–∞—Ç —ñ –ø–æ–¥–∞—Ç–∫—ñ–≤

  // ----- –î—Ä—É–∂–Ω—î –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –ª—ñ–º—ñ—Ç (–∂–æ–≤—Ç–µ), –±–µ–∑ –ø–∞–Ω—ñ–∫–∏ -----
  // –∞–≤—Ç–æ-—Å—Ç–≤–æ—Ä–∏–º–æ –±–ª–æ–∫, —è–∫—â–æ –π–æ–≥–æ —â–µ –Ω–µ–º–∞—î
  let capEl = $("capWarning");
  if (!capEl){
    capEl = document.createElement("div");
    capEl.id = "capWarning";
    capEl.style.cssText = "margin-top:8px;padding:8px;border-radius:6px;background:#fff3cd;color:#856404;display:none;";
    const result = $("result");
    // –≤—Å—Ç–∞–≤–ª—è—î–º–æ –ø–µ—Ä–µ–¥ –±–ª–æ–∫–æ–º –Ω–æ—Ç–∞—Ç–æ–∫, —è–∫—â–æ –≤—ñ–Ω —î
    const beforeNode = $("reportingNotesWrapper") || null;
    if (result) result.insertBefore(capEl, beforeNode);
  }
  // –ª–æ–≥—ñ–∫–∞ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: —è–∫—â–æ ‚Äú—Ç–µ–æ—Ä–µ—Ç–∏—á–Ω—ñ‚Äù –≤—ñ–¥—Ä–∞—Ö—É–≤–∞–Ω–Ω—è > –ª—ñ–º—ñ—Ç—É
  if (theoreticalSaved > maxDeductibleValue + 0.01) {
    capEl.textContent = `‚ö†Ô∏è ZZP + MKB exceed the legal cap (37.48% of profit). We automatically applied the maximum allowed: ‚Ç¨${maxDeductibleValue.toFixed(2)}.`;
    capEl.style.display = "block";
  } else {
    capEl.textContent = "";
    capEl.style.display = "none";
  }

  // ----- Notes show/hide -----
  const notes = Safe.val("reportingNotes");
  const wrap = $("reportingNotesWrapper");
  const out  = $("reportingNotesOutput");
  if (wrap && out){
    if ((notes||"").trim()){
      out.textContent = notes;
      wrap.style.display = "block";
    } else {
      wrap.style.display = "none";
    }
  }

  // ----- –°—Ç–∞—Ç—É—Å–∏ -----
  Safe.text("zzp-status", (kvk && zzp) ? "eligible ‚úÖ" : "not eligible ‚ùå");
  Safe.text("kvk-status", kvk ? "eligible ‚úÖ" : "not eligible ‚ùå");
  Safe.text("kor-status", kor ? "applied ‚úÖ" : "not used ‚ùå");
}

    // ---------- PDF export ----------
    function exportPDF(){
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("SmartWerk Tax Report", 15, 15);
      let y = 25;

      const T = id => ($(id)?.textContent ?? "");
      const V = id => Safe.val(id);

      // Contact block
      doc.setFontSize(11);
      [
        `Company: ${V("companyName")}`,
        `Email / Phone: ${V("email")}`,
        `Period: ${V("period")}`,
        `Hours worked: ${V("hoursWorked")}`,
        `Hourly Rate: ‚Ç¨${V("hourlyRate")}`,
        `Input 'Income': ‚Ç¨${V("income")}`,
        `KvK Number: ${V("kvkNumber")}`,
        `VAT Number: ${V("vatNumber")}`,
        `IBAN: ${V("iban")}`,
        `Contact Person: ${V("contactPerson")}`
      ].forEach(line => { doc.text(line, 15, y); y += 6; });
      y += 6;

      // Summary
      doc.setFontSize(12);
      doc.text("Calculation Summary:", 15, y); y += 8;
      doc.setFontSize(11);
      doc.text(`You saved (ZZP + MKB): ‚Ç¨${T("totalSavings")}`, 15, y); y += 6;
      doc.text(`Net Income after Tax: ‚Ç¨${T("netIncome")}`, 15, y); y += 6;
      [
        `Gross Income: ‚Ç¨${T("grossIncome")}`,
        `Total Expenses: ‚Ç¨${T("totalExpenses")}`,
        `Taxable Profit: ‚Ç¨${T("taxableProfit")}`,
        `ZZP Deductions: ‚Ç¨${T("zzpDeductions")}`,
        `MKB Exemption (12.7%): ‚Ç¨${T("mkbVrijstelling")}`,
        `Final Taxable Income: ‚Ç¨${T("finalTaxable")}`,
        `Income Tax: ‚Ç¨${T("incomeTax")}`,
        `ZVW (5.32%): ‚Ç¨${T("zvwAmount")}`,
        `BTW: ‚Ç¨${T("btwAmount")}`,
        `Total Estimated Tax: ‚Ç¨${T("totalTax")}`
      ].forEach(line => { doc.text(line, 15, y); y += 6; });

      // Notes
      const notes = V("reportingNotes");
      if ((notes||"").trim()){
        y += 8;
        doc.setFontSize(12);
        doc.text("Reporting Notes:", 15, y); y += 7;
        doc.setFontSize(11);
        doc.splitTextToSize(notes, 180).forEach(row => { doc.text(row, 15, y); y += 6; });
      }
// Cap warning —É PDF (—è–∫—â–æ —î)
const capNote = (document.getElementById("capWarning")?.textContent || "").trim();
if (capNote){
  y += 8;
  doc.setFontSize(12);
  doc.text("Notes:", 15, y); y += 7;
  doc.setFontSize(11);
  doc.splitTextToSize(capNote, 180).forEach(row => { doc.text(row, 15, y); y += 6; });
}
      
      doc.save("smartwerk-tax-report.pdf");
    }


  
/* === FINAL WIRING (safe) ===
   –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø–æ–¥—ñ—ó —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ DOM.
   –†–æ–±–∏–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó –≥–ª–æ–±–∞–ª—å–Ω–∏–º–∏, —è–∫—â–æ –≤–æ–Ω–∏ –æ–≥–æ–ª–æ—à–µ–Ω—ñ –≤–∏—â–µ.
   –ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫: –Ω–∞ –±—É–¥—å-—è–∫—É –∑–º—ñ–Ω—É –ø–æ–ª—ñ–≤.
   –ö–Ω–æ–ø–∫–∏: Calculate / Export / Run validation.
*/

(function wireEverything(){
  function exposeGlobals(){
    // —è–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—ó –æ–≥–æ–ª–æ—à–µ–Ω—ñ –≤–∏—â–µ ‚Äî –∑—Ä–æ–±–∏–º–æ –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ —è–∫ window.*
    if (typeof calculateTax === "function")  window.calculateTax = calculateTax;
    if (typeof exportPDF    === "function")  window.exportPDF    = exportPDF;
    if (typeof validateState=== "function")  window.validateState= validateState;
    if (typeof autoCalcIncome=== "function") window.autoCalcIncome= autoCalcIncome;
  }
function validateState() {
  const issues = [];

  // —Ö–µ–ª–ø–µ—Ä–∏
  const get = id => (document.getElementById(id)?.textContent || '').trim();
  const num = s => {
    const v = parseFloat(String(s).replace(',', '.'));
    return Number.isFinite(v) ? v : NaN;
  };

  const gross = num(get('grossIncome'));
  const exp   = num(get('totalExpenses'));
  const prof  = num(get('taxableProfit'));

// ---- Balanced-–ª–æ–≥—ñ–∫–∞ ----
const EPS = 0.5;

// –∑—á–∏—Ç—É–≤–∞—á –∑–Ω–∞—á–µ–Ω—å –∑—ñ span
const getNum = (id) => {
  const s = (document.getElementById(id)?.textContent || '').trim();
  const v = parseFloat(String(s).replace(',', '.'));
  return Number.isFinite(v) ? v : NaN;
};

// 1) Profit ‚âà Gross - Expenses
if (!isNaN(gross) && !isNaN(exp) && !isNaN(prof)) {
  const diff = Math.abs((gross - exp) - prof);
  if (diff > EPS) issues.push(`‚ùå Taxable Profit should equal Gross - Expenses (diff ‚Ç¨${diff.toFixed(2)})`);
}

// 2) TotalTax ‚âà IncomeTax + ZVW + BTW
const incomeTax = getNum('incomeTax');
const zvwAmount = getNum('zvwAmount');
const btwAmount = getNum('btwAmount');
const totalTax  = getNum('totalTax');

if ([incomeTax, zvwAmount, btwAmount, totalTax].every(v => !isNaN(v))) {
  const diff = Math.abs((incomeTax + zvwAmount + btwAmount) - totalTax);
  if (diff > EPS) issues.push(`‚ùå Total Tax should equal IncomeTax + ZVW + BTW (diff ‚Ç¨${diff.toFixed(2)})`);
}

// 3) ZZP/MKB –æ–±–º–µ–∂–µ–Ω–Ω—è —Ç–∞ —É–º–æ–≤–∏
const kvk      = (document.getElementById('kvk')?.value === 'yes');
const zzpHours = (document.getElementById('zzpHours')?.value === 'yes');
const kor      = (document.getElementById('kor')?.value === 'yes');
const btwRateV = (document.getElementById('btwRate')?.value || '21'); // '0','9','21'

const zzpDed = getNum('zzpDeductions');
const mkb    = getNum('mkbVrijstelling');

if (!isNaN(zzpDed)) {
  if (!(kvk && zzpHours) && zzpDed > 0) {
    issues.push('‚ùå ZZP deductions require KVK=Yes and ‚â•1225 hours.');
  }
// MKB –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ —è–∫—â–æ —î ZZP-–µ–ª—ñ–∂–∏–±—ñ–ª—ñ—Ç—ñ
if (!(kvk && zzpHours) && mkb > 0) {
  issues.push('‚ùå MKB requires ZZP eligibility (KVK=Yes and ‚â•1225 hours).');
}
  
  if (!isNaN(mkb) && !isNaN(prof) && prof > 0) {
    const cap = 0.3748 * prof;
    if (zzpDed + mkb > cap + 0.01) issues.push('‚ùå ZZP + MKB exceed 37.48% cap of profit.');
  }
}

// 4) KOR –ø—Ä–∞–≤–∏–ª–∞
if (kor) {
  if (btwAmount > EPS) issues.push('‚ùå KOR=Yes ‚Üí BTW must be 0.');
  if (!['0','9','21'].includes(btwRateV)) issues.push('‚ùå Invalid BTW rate (allowed: 0, 9, 21).');
}

// 5) –ú—ñ–Ω—É—Å–∏ / –≤–∏—Ç—Ä–∞—Ç–∏ > –¥–æ—Ö—ñ–¥
[['Gross income', gross], ['Total expenses', exp], ['Taxable profit', prof]].forEach(([name,val])=>{
  if (!isNaN(val) && val < 0) issues.push(`‚ùå ${name} cannot be negative.`);
});
if (!isNaN(exp) && !isNaN(gross) && exp > gross) {
  issues.push('‚ö†Ô∏è Expenses are higher than income.');
}
  return issues;
}

window.validateState = validateState; // –∑–∞–ª–∏—à–∞—î–º–æ —Ü–µ
  
  function runValidationUI(){
    // —è–∫—â–æ —î –ø–∞–Ω–µ–ª—å ‚Äî –æ–Ω–æ–≤–∏–º–æ —Å—Ç–∞—Ç—É—Å
    var s = document.getElementById("validateStatus");
    var o = document.getElementById("debugOut");
    if (!s || !o) return;                            // –ø–∞–Ω–µ–ª—ñ –º–æ–∂–µ –Ω–µ –±—É—Ç–∏ ‚Äî –æ–∫
    if (typeof window.validateState !== "function"){ // –Ω–µ–º–∞—î —Å–∞–º–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
      s.textContent = "‚ÑπÔ∏è Validation script not found";
      s.style.color = "#666";
      o.textContent = "";
      return;
    }
    var errs = window.validateState();
    if (errs.length){
      s.textContent = "‚ùå Issues found";
      s.style.color = "#c00";
      o.textContent = errs.map((e,i)=>`${i+1}. ${e}`).join("\n");
    } else {
      s.textContent = "‚úÖ No issues found";
      s.style.color = "#0a0";
      o.textContent = "All values look valid.";
    }
  }

  function attachHandlers(){
    // 1) Autocalc + –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ –Ω–∞ –±—É–¥—å-—è–∫–µ –≤–≤–µ–¥–µ–Ω–Ω—è
    document.querySelectorAll("input, select, textarea").forEach(function(el){
      el.addEventListener("input",  function(){
        if (typeof window.autoCalcIncome === "function") window.autoCalcIncome();
        if (typeof window.calculateTax   === "function") window.calculateTax();
        runValidationUI();
      });
      el.addEventListener("change", function(){
        if (typeof window.autoCalcIncome === "function") window.autoCalcIncome();
        if (typeof window.calculateTax   === "function") window.calculateTax();
        runValidationUI();
      });
    });

    // 2) –ö–Ω–æ–ø–∫–∞ Calculate
    var btnCalc = document.getElementById("btn-calc");
    if (btnCalc) btnCalc.addEventListener("click", function(){
      if (typeof window.calculateTax === "function") window.calculateTax();
      runValidationUI();
    });

    // 3) –ö–Ω–æ–ø–∫–∞ Export PDF
    var btnPdf = document.getElementById("btn-pdf");
    if (btnPdf) btnPdf.addEventListener("click", function(){
      if (typeof window.exportPDF === "function") window.exportPDF();
    });

    // 4) –ö–Ω–æ–ø–∫–∞ Run validation
    var btnVal = document.getElementById("btn-validate");
    if (btnVal) btnVal.addEventListener("click", runValidationUI);
  }

  // –ß–µ–∫–∞—î–º–æ DOM, —Ç–æ–¥—ñ –µ–∫—Å–ø–æ–Ω—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –ø–æ–¥—ñ—ó
  document.addEventListener("DOMContentLoaded", function(){
    exposeGlobals();
    attachHandlers();
    // –ø–µ—Ä–≤–∏–Ω–Ω–∏–π –ø—Ä–æ–≥—ñ–Ω
    if (typeof window.autoCalcIncome === "function") window.autoCalcIncome();
    if (typeof window.calculateTax   === "function") window.calculateTax();
    runValidationUI();
  });

  // –ù–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ —Å–∫—Ä–∏–ø—Ç–∏ –≤–∏—â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ ‚Äî –∑—Ä–æ–±–∏–º–æ –∫—ñ–ª—å–∫–∞ —Å–ø—Ä–æ–±
  var tries = 0;
  var t = setInterval(function(){
    tries++;
    exposeGlobals();
    if (window.calculateTax && (document.readyState === "complete" || document.readyState === "interactive")){
      try { attachHandlers(); if (window.autoCalcIncome) window.autoCalcIncome(); window.calculateTax && window.calculateTax(); runValidationUI(); } catch(e){}
      clearInterval(t);
    }
    if (tries > 20) clearInterval(t); // ~10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
  }, 500);
})();
</script>
</body>
</html>
