<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk Tax Calculator</title>
 <link rel="stylesheet" href="style-calculator.css" />
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>window.jsPDF = window.jspdf.jsPDF;</script>
 <!-- SheetJS (XLSX) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="topbar">
  <nav>
    <a href="index.html" class="btn">‚Üê Main Page</a>
    <a href="dashboard.html" class="btn">‚Üê Back to Dashboard</a>
    <p class="info">
  üìå After the calculation, you can export the report or submit the declaration manually via
  <a href="https://mijn.belastingdienst.nl" target="_blank">Belastingdienst</a>.
</p>
  </nav>
</div>
  
  <h2>Tax Calculator</h2>
  
     <section>
      <h2>üè¢ Business Info</h2>
      <input id="businessName" placeholder="Full Name / Business Name"/>
      <input id="kvk" placeholder="KvK Number"/>
      <input id="iban" placeholder="IBAN"/>
      <input id="btw" placeholder="BTW Number"/>
      <input id="email" placeholder="Business Email"/>
      <input id="businessPhone" placeholder="Business Phone"/>
       </section>

    <section>
    <label for="period">Period</label>
    <select id="period">
      <option value="Q1">January ‚Äì March (Q1)</option>
      <option value="Q2">April ‚Äì June (Q2)</option>
      <option value="Q3">July ‚Äì September (Q3)</option>
      <option value="Q4">October ‚Äì December (Q4)</option>
    </select>
       </section>

         
   
     <section>
    <label>Hours Worked:<input type="number" id="hoursWorked"/></label>
    <label>Hourly Rate (EUR):<input type="number" id="hourlyRate"/></label>
    <label>Total Income (auto):<input type="number" id="income" readonly/></label>

    <label for="reportingNotes">Reporting Notes (optional):</label>
    <textarea id="reportingNotes" rows="2" placeholder="E.g. one-time setup costs, pending invoices‚Ä¶"></textarea>
       </section>

  
      <section>
    <h3>Business Expenses</h3>

    <label>Transport & Vehicle Costs:
      <span class="muted">(car, fuel, public transport, bike lease, etc.)</span>
      <input type="number" id="vehicle"/>
    </label>

    <label>Workspace & Rent Costs:
      <span class="muted">(home office, coworking, energy, heating, etc.)</span>
      <input type="number" id="office"/>
    </label>

    <label>Internet & Communication:
      <span class="muted">(mobile, Wi-Fi, VoIP, domain, calls, etc.)</span>
      <input type="number" id="internet"/>
    </label>

    <label>Marketing & Advertising:
      <span class="muted">(website, ads, design, campaigns, etc.)</span>
      <input type="number" id="marketing"/>
    </label>

    <label>Business Gifts & Representation:
      <span class="muted">(networking, client gifts, events, etc.)</span>
      <input type="number" id="other"/>
    </label>

    <label>Study, Insurance & Misc:
      <span class="muted">(courses, software, accountant, insurance, banking, etc.)</span>
      <input type="number" id="extraBenefits"/>
    </label>
       </section>

 
 <section>
    <h3>Tax Options</h3>

    <label for="kvk">KvK Registered?
      <span class="muted">(required for most deductions)</span>
    </label>
    <select id="kvk">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label for="zzpHours">Worked ‚â•1,225 hours?
      <span class="muted">(required for ZZP deductions)</span>
    </label>
    <select id="zzpHours">
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label for="btwRate">BTW Rate:
      <span class="muted">(21% standard, 9% reduced, 0% exempt)</span>
    </label>
    <select id="btwRate">
      <option value="21">21%</option>
      <option value="9">9%</option>
      <option value="0">0%</option>
    </select>

    <label for="kor">Use KOR?
      <span class="muted">(Small Business Scheme; exempts charging VAT)</span>
    </label>
    <select id="kor">
      <option value="no">No</option>
      <option value="yes">Yes</option>
    </select>
       </section>

 
  <div class="section summary">
    <h3>Result</h3>

    <div id="result">
      <!-- Deduction Breakdown (statuses) -->
      <div class="section" id="deduction-breakdown" style="padding:12px; margin:0 0 12px 0;">
        <h3 style="margin:0 0 .5rem 0;">Deduction Breakdown</h3>
        <p><strong>ZZP eligibility:</strong> <span id="zzp-status">‚Äî</span></p>
        <p><strong>KvK status:</strong> <span id="kvk-status">‚Äî</span></p>
        <p><strong>KOR usage:</strong> <span id="kor-status">‚Äî</span></p>
      </div>
      <div id="debugPanel" style="margin-top:12px; padding:10px; background:#f3f3f3; border-radius:8px;">
  <button id="btn-validate" type="button">üß™ Run validation</button>
  <span id="validateStatus" style="margin-left:10px; font-weight:600;">‚Äî</span>
  <pre id="debugOut" style="margin-top:8px; max-height:160px; overflow:auto; background:#fff; padding:8px; border:1px solid #ddd; border-radius:6px;"></pre>
</div>

      <p><strong>Gross Income:</strong> <span id="grossIncome"></span></p>
      <p><strong>Total Expenses:</strong> <span id="totalExpenses"></span></p>
      <p><strong>Taxable Profit:</strong> <span id="taxableProfit"></span></p>
      <p><strong>ZZP Deductions:</strong> <span id="zzpDeductions"></span></p>
      <p><strong>MKB Exemption (12.7%):</strong> <span id="mkbVrijstelling"></span></p>
      <p><strong>Final Taxable Income:</strong> <span id="finalTaxable"></span></p>
      <p><strong>Income Tax:</strong> <span id="incomeTax"></span></p>
      <p><strong>ZVW (5.32%):</strong> <span id="zvwAmount"></span></p>
      <p><strong>BTW Amount:</strong> <span id="btwAmount"></span></p>
      <p><strong>Total Estimated Tax:</strong> <span id="totalTax"></span></p>

      <p><strong>You saved (ZZP + MKB):</strong>
  <span id="totalSavings" class="mono" style="color:#0a0;"></span>
</p>
<p><strong>Net Income after Tax:</strong>
  <span id="netIncome" class="mono"></span>
</p>

      <div id="reportingNotesWrapper" style="display:none;">
        <p><strong>Reporting Notes:</strong> <span id="reportingNotesOutput"></span></p>
      </div>
    </div>

    <div class="button-group">
      <button id="btn-calc" class="button-primary">üîÅ Calculate Tax</button>
      <button id="btn-pdf" class="button-secondary">üßæ Export as PDF</button>
      <button id="btn-xlsx" type="button">üìä Export as Excel</button>
      <button id="btn-load-history">üîÑ Update History</button>
      <div id="calcStatus" style="margin-top:10px;color:green;display:none;"></div>   
      <button id="btn-clear-history" class="btn ghost small">üßπ Clear History</button>
      <button type="button" id="btn-ai">üí¨ Open AI Assistant</button>
    </div>
  </div>
  <div class="section">
  <h3>üìÅ Calculation History</h3>
  <ul id="historyList" class="mono"></ul>
</div>
  

  <!-- ===== Utilities & Logic ===== -->
  <script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
  getFirestore,
  collection,
  addDoc,
  limit,
  getDocs,
  deleteDoc,
  query,         // ‚úÖ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –¥–æ–¥–∞–π —Ü–µ
  orderBy        // ‚úÖ —ñ —Ü–µ
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
    authDomain: "smartwerk8520.firebaseapp.com",
    projectId: "smartwerk8520",
    appId: "1:607670981972:web:c07103c981c86860d724c1"
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
 onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "login.html";
  currentUser = user;
  await loadUserProfile(); // ‚úÖ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
});

  window.smartwerkDb = db;
  window.smartwerkUser = () => currentUser;

    let lastSavedNetIncome = null;
let lastSaveTime = 0;
    
    // ---------- Anti-null expected IDs ----------
    const REQUIRED_IDS = [
      "businessName","email","period","hoursWorked","hourlyRate","income",
      "kvk","btw","iban","businessPhone","reportingNotes",
      "vehicle","office","internet","marketing","other","extraBenefits",
      "kvk","zzpHours","btwRate","kor",
      "grossIncome","totalExpenses","taxableProfit","zzpDeductions",
      "mkbVrijstelling","finalTaxable","incomeTax","zvwAmount","btwAmount","totalTax",
      "reportingNotesWrapper","reportingNotesOutput","totalSavings","netIncome",
      "zzp-status","kvk-status","kor-status"
    ];
    function $(id){ return document.getElementById(id); }
    const Safe = {
      text(id, v){ const el=$(id); if(el){ el.textContent=String(v); } else { console.warn(`‚õî Missing #${id}`);} },
      val(id){ const el=$(id); if(!el){ console.warn(`‚õî Missing #${id}`); return ""; } return el.value ?? ""; }
    };
    function num(id){ const s=(Safe.val(id)||"").toString().replace(",","."); const n=parseFloat(s); return Number.isFinite(n)?n:0; }
    function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
    function clamp0(x){ return x < 0 ? 0 : x; }

    // highlight missing IDs on load
    document.addEventListener("DOMContentLoaded", () => {
      const missing = REQUIRED_IDS.filter(id => !$(id));
      if (missing.length){
        console.table(missing.map(id => ({missing:id})));
        const b = document.createElement("div");
        b.style.cssText = "position:fixed;top:0;left:0;right:0;padding:10px;background:#d00;color:#fff;z-index:9999";
        b.textContent = "Missing IDs: " + missing.join(", ");
        document.body.appendChild(b);
        setTimeout(()=>b.remove(), 10000);
      }
    });

    async function loadUserProfile() {
  const db = window.smartwerkDb;
  const user = window.smartwerkUser && window.smartwerkUser();
  if (!db || !user) return;

  const userDoc = await getDoc(doc(db, "users", user.uid));
  const data = userDoc.data();
  if (!data) return;

  // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –ø–æ–ª—è
  const fields = {
    businessName: data.businessName,
    email: data.email,
    kvk: data.kvk,
    btw: data.btw,
    iban: data.iban,
    businessPhone: data.businessPhone
  };

  for (const [id, val] of Object.entries(fields)) {
    const el = document.getElementById(id);
    if (el) el.value = val ?? "";
  }
}

    // ---------- Auto income from hours * rate ----------
    function autoCalcIncome(){
      const h = num("hoursWorked");
      const r = num("hourlyRate");
      const val = round2(h * r);
      const incomeEl = $("income");
      if (incomeEl) incomeEl.value = val.toFixed(2);
    }


async function saveToFirestoreSummary(summary, doNotLog = false) {
  const db = window.smartwerkDb;
  const user = window.smartwerkUser && window.smartwerkUser();
  if (!db || !user) return;
  

  const now = Date.now();
  if (summary.netIncome === lastSavedNetIncome && (now - lastSaveTime) < 5000) {
    if (!doNotLog) console.log("‚õî Duplicate or too soon. Skipping save.");
    return;
  }
  if (!Number.isFinite(summary.netIncome) || summary.netIncome <= 0) {
  console.warn("‚õî Skipped saving: net income is zero or invalid");
  return;
}

  await addDoc(collection(db, "users", user.uid, "tax_calculations"), {
    ...summary,
    uid: user.uid,
    date: new Date().toISOString()
  });

  if (!doNotLog) console.log("‚úÖ Saved to Firestore");
  lastSavedNetIncome = summary.netIncome;
  lastSaveTime = now;

  // üü¢ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
  await loadHistory();
}
    async function loadHistory() {
  const db = window.smartwerkDb;
  const user = window.smartwerkUser && window.smartwerkUser();
  if (!db || !user) return;

  const q = query(collection(db, "users", user.uid, "tax_calculations"), orderBy("date", "desc"));
  const snap = await getDocs(q);
  const list = document.getElementById("historyList");
  list.innerHTML = "";
  snap.forEach(doc => {
    const d = doc.data();
    const li = document.createElement("li");
    li.textContent = `${new Date(d.date).toLocaleDateString()}: Net ‚Ç¨${d.netIncome?.toFixed(2) || "‚Äî"}`;
    list.appendChild(li);
  });
}

    // ---------- Main calculation ----------
async function calculateTax() {
  // 0) –∞–≤—Ç–æ-–ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ—Ö–æ–¥—É (–≥–æ–¥–∏–Ω–∏ √ó —Å—Ç–∞–≤–∫–∞)
  autoCalcIncome();

  // ----- –í—Ö—ñ–¥–Ω—ñ -----
  const income        = num("income");
  const vehicle       = num("vehicle");
  const office        = num("office");
  const internet      = num("internet");
  const marketing     = num("marketing");
  const other         = num("other");
  const extraBenefits = num("extraBenefits");

  const kvk     = Safe.val("kvk") === "yes";
  const zzp     = Safe.val("zzpHours") === "yes";
  const kor     = Safe.val("kor") === "yes";
  const btwRate = parseFloat((Safe.val("btwRate")||"0").replace(",", ".")) || 0;

  // ----- –ë–∞–∑–æ–≤–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ -----
  const totalExpenses = vehicle + office + internet + marketing + other + extraBenefits;
  const profit        = income - totalExpenses;                 // –ø—Ä–∏–±—É—Ç–æ–∫ –¥–æ –ø–æ–¥–∞—Ç–∫—ñ–≤

  // ----- ZZP deductions -----
  const ZELFSTANDIGEN = 5030;                                   // jouw –º–æ–¥–µ–ª—å
  const STARTERS      = (kvk && zzp) ? 2123 : 0;
  const zzpDeductionsRaw = (kvk && zzp) ? (ZELFSTANDIGEN + STARTERS) : 0;

  // ----- MKB 12.7% —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ ZZP eligible -----
  const taxableBeforeMKBRaw = clamp0(profit - zzpDeductionsRaw);
  const mkbVrijstellingRaw  = (kvk && zzp) ? round2(taxableBeforeMKBRaw * 0.127) : 0;

  // ----- –û–±–º–µ–∂–µ–Ω–Ω—è 37.48% –≤—ñ–¥ –ø—Ä–∏–±—É—Ç–∫—É -----
  const maxDeductibleValue  = round2(Math.max(0, profit) * 0.3748);
  const cappedZZP           = Math.min(zzpDeductionsRaw, maxDeductibleValue);
  const cappedMKB           = Math.min(mkbVrijstellingRaw, clamp0(maxDeductibleValue - cappedZZP));

  // –°–∫—ñ–ª—å–∫–∏ "–∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ" –ø—ñ–ª—å–≥ —Ç–∞ –æ—Å—Ç–∞—Ç–æ—á–Ω–∏–π –æ–ø–æ–¥–∞—Ç–∫–æ–≤—É–≤–∞–Ω–∏–π
  const appliedSaved  = round2(cappedZZP + cappedMKB);
  const finalTaxable  = clamp0(profit - appliedSaved);

  // ----- –ü–æ–¥–∞—Ç–∫–∏ (—Ç–≤–æ—è –º–æ–¥–µ–ª—å —Å—Ç–∞–≤–æ–∫) -----
  let incomeTax = 0;
  if (finalTaxable > 200000){
    incomeTax = round2(200000 * 0.19 + (finalTaxable - 200000) * 0.258);
  } else {
    incomeTax = round2(finalTaxable * 0.19);
  }
  const zvwAmount = round2(finalTaxable * 0.0532);
  const btwAmount = kor ? 0 : round2(income * (btwRate / 100));
  const totalTax  = round2(incomeTax + zvwAmount + btwAmount);

  // ----- –í–∏–≤—ñ–¥ —É DOM -----
  Safe.text("grossIncome",     income.toFixed(2));
  Safe.text("totalExpenses",   totalExpenses.toFixed(2));
  Safe.text("taxableProfit",   profit.toFixed(2));
  Safe.text("zzpDeductions",   cappedZZP.toFixed(2));      // applied
  Safe.text("mkbVrijstelling", cappedMKB.toFixed(2));      // applied
  Safe.text("finalTaxable",    finalTaxable.toFixed(2));
  Safe.text("incomeTax",       incomeTax.toFixed(2));
  Safe.text("zvwAmount",       zvwAmount.toFixed(2));
  Safe.text("btwAmount",       btwAmount.toFixed(2));
  Safe.text("totalTax",        totalTax.toFixed(2));

  // Saved (–¥–ª—è —Ä—è–¥–∫–∞ ‚ÄúYou saved‚Äù)
  Safe.text("totalSavings",    appliedSaved.toFixed(2));

  // Net after tax: –≤—ñ–¥–Ω—ñ–º–∞—î–º–æ BTW —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ KOR = No
  const netIncomeAfterTax = kor
    ? round2(income - totalExpenses - incomeTax - zvwAmount)          // KOR=Yes ‚Üí BTW –≤–∂–µ 0
    : round2(income - totalExpenses - incomeTax - zvwAmount - btwAmount);
  Safe.text("netIncome", netIncomeAfterTax.toFixed(2));

  // === Firebase: –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ Firestore (–æ–ø—Ü—ñ–π–Ω–æ) ===
try {
  const db = window.smartwerkDb;
  const user = window.smartwerkUser && window.smartwerkUser();
  if (!db || !user) return;

  const summary = {
    income,
    totalExpenses,
    profit,
    zzpDeductions: cappedZZP,
    mkbVrijstelling: cappedMKB,
    finalTaxable,
    incomeTax,
    zvwAmount,
    btwAmount,
    totalTax,
    netIncome: netIncomeAfterTax,
    korApplied: kor,
    kvkEligible: kvk,
    zzpEligible: zzp
  };

await saveToFirestoreSummary(summary, true);
} catch (e) {
  console.warn("‚ö†Ô∏è Firebase error", e);
}
  
  // ----- –ñ–æ–≤—Ç–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, —è–∫—â–æ —Ç–µ–æ—Ä–µ—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤–∏—â–∏–ª–∏ –ª—ñ–º—ñ—Ç -----
  let capEl = $("capWarning");
  if (!capEl){
    capEl = document.createElement("div");
    capEl.id = "capWarning";
    capEl.style.cssText = "margin-top:8px;padding:8px;border-radius:6px;background:#fff3cd;color:#856404;display:none;";
    const result = $("result");
    const beforeNode = $("reportingNotesWrapper") || null;
    if (result) result.insertBefore(capEl, beforeNode);
  }
  const theoreticalSaved = zzpDeductionsRaw + mkbVrijstellingRaw;
  if (theoreticalSaved > maxDeductibleValue + 0.01) {
    capEl.textContent = `‚ö†Ô∏è ZZP + MKB exceed the legal cap (37.48% of profit). We automatically applied the maximum allowed: ‚Ç¨${maxDeductibleValue.toFixed(2)}.`;
    capEl.style.display = "block";
  } else {
    capEl.textContent = "";
    capEl.style.display = "none";
  }

  // ----- Notes -----
  const notes = Safe.val("reportingNotes");
  const wrap  = $("reportingNotesWrapper");
  const out   = $("reportingNotesOutput");
  if (wrap && out){
    if ((notes||"").trim()){
      out.textContent = notes;
      wrap.style.display = "block";
    } else {
      wrap.style.display = "none";
    }
  }

  // ----- –°—Ç–∞—Ç—É—Å–∏ -----
  Safe.text("zzp-status", (kvk && zzp) ? "eligible ‚úÖ" : "not eligible ‚ùå");
  Safe.text("kvk-status", kvk ? "eligible ‚úÖ" : "not eligible ‚ùå");
  Safe.text("kor-status", kor ? "applied ‚úÖ" : "not used ‚ùå");
}

  

    // ---------- PDF export ----------
    function exportPDF(){
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("SmartWerk Tax Report", 15, 15);
      let y = 25;

      const T = id => ($(id)?.textContent ?? "");
      const V = id => Safe.val(id);

      // Contact block
      doc.setFontSize(11);
      [
        `Company: ${V("businessName")}`,
        `Email / Phone: ${V("email")}`,
        `Period: ${V("period")}`,
        `Hours worked: ${V("hoursWorked")}`,
        `Hourly Rate: ‚Ç¨${V("hourlyRate")}`,
        `Input 'Income': ‚Ç¨${V("income")}`,
        `KvK Number: ${V("kvk")}`,
        `VAT Number: ${V("btw")}`,
        `IBAN: ${V("iban")}`,
        `Contact Person: ${V("businessPhone")}`
      ].forEach(line => { doc.text(line, 15, y); y += 6; });
      y += 6;

      // Summary
      doc.setFontSize(12);
      doc.text("Calculation Summary:", 15, y); y += 8;
      doc.setFontSize(11);
      doc.text(`You saved (ZZP + MKB): ‚Ç¨${T("totalSavings")}`, 15, y); y += 6;
      doc.text(`Net Income after Tax: ‚Ç¨${T("netIncome")}`, 15, y); y += 6;
      [
        `Gross Income: ‚Ç¨${T("grossIncome")}`,
        `Total Expenses: ‚Ç¨${T("totalExpenses")}`,
        `Taxable Profit: ‚Ç¨${T("taxableProfit")}`,
        `ZZP Deductions: ‚Ç¨${T("zzpDeductions")}`,
        `MKB Exemption (12.7%): ‚Ç¨${T("mkbVrijstelling")}`,
        `Final Taxable Income: ‚Ç¨${T("finalTaxable")}`,
        `Income Tax: ‚Ç¨${T("incomeTax")}`,
        `ZVW (5.32%): ‚Ç¨${T("zvwAmount")}`,
        `BTW: ‚Ç¨${T("btwAmount")}`,
        `Total Estimated Tax: ‚Ç¨${T("totalTax")}`
      ].forEach(line => { doc.text(line, 15, y); y += 6; });

      // Notes
      const notes = V("reportingNotes");
      if ((notes||"").trim()){
        y += 8;
        doc.setFontSize(12);
        doc.text("Reporting Notes:", 15, y); y += 7;
        doc.setFontSize(11);
        doc.splitTextToSize(notes, 180).forEach(row => { doc.text(row, 15, y); y += 6; });
      }
// Cap warning —É PDF (—è–∫—â–æ —î)
const capNote = (document.getElementById("capWarning")?.textContent || "").trim();
if (capNote){
  y += 8;
  doc.setFontSize(12);
  doc.text("Notes:", 15, y); y += 7;
  doc.setFontSize(11);
  doc.splitTextToSize(capNote, 180).forEach(row => { doc.text(row, 15, y); y += 6; });
}
      
      doc.save("smartwerk-tax-report.pdf");
    }

// ---------- AI: –∑—ñ–±—Ä–∞—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —ñ –≤—ñ–¥–∫—Ä–∏—Ç–∏ —á–∞—Ç ----------
// ensure latest numbers are saved, then open new tab
  function openAIChat(){
    // 1) –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ –Ω–∞ –≤—Å—è–∫–∏–π –≤–∏–ø–∞–¥–æ–∫
    try { if (typeof calculateTax === 'function') calculateTax(); } catch(e){}

    // 2) –∑—Ä—É—á–Ω—ñ –≥–µ—Ç–µ—Ä–∏
    const v = id => (document.getElementById(id)?.value || '').trim();
    const t = id => (document.getElementById(id)?.textContent || '').trim();
    const euro = n => Number(n||0).toFixed(2);

    // 3) —Ñ–æ—Ä–º—É—î–º–æ payload
    const payload = {
      businessName:  v('businessName'),
      emailPhone:   v('email'),
      period:       v('period'),
      hoursWorked:  v('hoursWorked'),
      hourlyRate:   v('hourlyRate'),
      income:       v('income'),
      kvk:          v('kvk'),
      btw:          v('btw'),
      iban:         v('iban'),
      businessPhone:v('businessPhone'),
      reportingNotes: v('reportingNotes'),
      totals: {
        grossIncome:    euro(t('grossIncome')),
        totalExpenses:  euro(t('totalExpenses')),
        taxableProfit:  euro(t('taxableProfit')),
        zzpDeductions:  euro(t('zzpDeductions')),
        mkbVrijstelling:euro(t('mkbVrijstelling')),
        finalTaxable:   euro(t('finalTaxable')),
        incomeTax:      euro(t('incomeTax')),
        zvwAmount:      euro(t('zvwAmount')),
        btwAmount:      euro(t('btwAmount')),
        totalTax:       euro(t('totalTax')),
        totalSavings:   euro(t('totalSavings')),
        netIncome:      euro(t('netIncome')),
      }
    };

    // 4) –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä—à–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    payload.textSummary =
`SmartWerk Tax Calculation
Company: ${payload.businessName}
Period: ${payload.period}
Gross: ‚Ç¨${payload.totals.grossIncome}, Expenses: ‚Ç¨${payload.totals.totalExpenses}, Taxable: ‚Ç¨${payload.totals.taxableProfit}, ZZP: ‚Ç¨${payload.totals.zzpDeductions}, MKB: ‚Ç¨${payload.totals.mkbVrijstelling}, Final Taxable: ‚Ç¨${payload.totals.finalTaxable}, Income Tax: ‚Ç¨${payload.totals.incomeTax}, ZVW: ‚Ç¨${payload.totals.zvwAmount}, BTW: ‚Ç¨${payload.totals.btwAmount}, Total Tax: ‚Ç¨${payload.totals.totalTax}
Saved (ZZP+MKB): ‚Ç¨${payload.totals.totalSavings}, Net After Tax: ‚Ç¨${payload.totals.netIncome}
${payload.reportingNotes ? `Notes: ${payload.reportingNotes}` : ''}`;

    // 5) –∫–ª–∞–¥–µ–º–æ –≤ localStorage —ñ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —á–∞—Ç
    localStorage.setItem('smartwerk_chat_context', JSON.stringify(payload));
    window.open('./ai-assistant.html','_blank');
  }

  // –≤—ñ—à–∞—î–º–æ –Ω–∞ –∫–Ω–æ–ø–∫—É (id="btn-ai")
  document.getElementById('btn-ai')?.addEventListener('click', openAIChat);

    
  // ... —Ç–≤–æ—ó —ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó: autoCalcIncome(), calculateTax(), exportPDF() ...

// ---------- XLSX export ----------
function exportExcel() {
  // –Ω–∞ –≤—Å—è–∫–∏–π –≤–∏–ø–∞–¥–æ–∫ ‚Äî –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ –ø—ñ–¥—Å—É–º–∫–∏ –ø–µ—Ä–µ–¥ –µ–∫—Å–ø–æ—Ä—Ç–æ–º
  try { if (typeof calculateTax === 'function') calculateTax(); } catch(e){}

  const v = id => (document.getElementById(id)?.value ?? "").toString().trim();
  const t = id => (document.getElementById(id)?.textContent ?? "").toString().trim();

  // 1) –§–æ—Ä–º—É—î–º–æ –¥–∞–Ω—ñ –î–õ–Ø –ï–ö–°–ü–û–†–¢–£ (–¶–ï–ô –º–∞—Å–∏–≤ —ñ —î "data")
  const data = [
    ["SmartWerk Tax Report"], [],
    ["Company", v("businessName")],
    ["Email / Phone", v("email")],
    ["Period", v("period")],
    ["Hours Worked", v("hoursWorked")],
    ["Hourly Rate (‚Ç¨)", v("hourlyRate")],
    ["Total Income (‚Ç¨)", v("income")],
    ["KvK Number", v("kvk")],
    ["VAT Number", v("btw")],
    ["IBAN", v("iban")],
    ["Contact Person", v("businessPhone")],
    [],
    ["Gross Income (‚Ç¨)", t("grossIncome")],
    ["Total Expenses (‚Ç¨)", t("totalExpenses")],
    ["Taxable Profit (‚Ç¨)", t("taxableProfit")],
    ["ZZP Deductions (‚Ç¨)", t("zzpDeductions")],
    ["MKB Exemption (‚Ç¨)", t("mkbVrijstelling")],
    ["Final Taxable Income (‚Ç¨)", t("finalTaxable")],
    ["Income Tax (‚Ç¨)", t("incomeTax")],
    ["ZVW (5.32%) (‚Ç¨)", t("zvwAmount")],
    ["BTW Amount (‚Ç¨)", t("btwAmount")],
    ["Total Estimated Tax (‚Ç¨)", t("totalTax")],
    [],
    ["Reporting Notes", v("reportingNotes")]
  ];

  // 2) –ê—Ä–∫—É—à —ñ –∫–Ω–∏–≥–∞
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws["!cols"] = [{wch:26},{wch:28}];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Tax Report");

  // 3) –ó–±–µ—Ä–µ–≥—Ç–∏ —Ñ–∞–π–ª
  XLSX.writeFile(wb, "SmartWerk_Tax_Report.xlsx");
}
  


  
/* === FINAL WIRING (safe) ===
   –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø–æ–¥—ñ—ó —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ DOM.
   –†–æ–±–∏–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó –≥–ª–æ–±–∞–ª—å–Ω–∏–º–∏, —è–∫—â–æ –≤–æ–Ω–∏ –æ–≥–æ–ª–æ—à–µ–Ω—ñ –≤–∏—â–µ.
   –ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫: –Ω–∞ –±—É–¥—å-—è–∫—É –∑–º—ñ–Ω—É –ø–æ–ª—ñ–≤.
   –ö–Ω–æ–ø–∫–∏: Calculate / Export / Run validation.
*/

(function wireEverything(){
 function exposeGlobals(){
  if (typeof calculateTax === "function")  window.calculateTax = calculateTax;
  if (typeof exportPDF    === "function")  window.exportPDF    = exportPDF;
  if (typeof validateState=== "function")  window.validateState= validateState;
  if (typeof autoCalcIncome=== "function") window.autoCalcIncome= autoCalcIncome;
  if (typeof openAIChat   === "function")  window.openAIChat   = openAIChat;   // üëà –¥–æ–¥–∞–ª–∏
}
function validateState() {
  const issues = [];

  // —Ö–µ–ª–ø–µ—Ä–∏
  const get = id => (document.getElementById(id)?.textContent || '').trim();
  const num = s => {
    const v = parseFloat(String(s).replace(',', '.'));
    return Number.isFinite(v) ? v : NaN;
  };

  const gross = num(get('grossIncome'));
  const exp   = num(get('totalExpenses'));
  const prof  = num(get('taxableProfit'));

// ---- Balanced-–ª–æ–≥—ñ–∫–∞ ----
const EPS = 0.5;

// –∑—á–∏—Ç—É–≤–∞—á –∑–Ω–∞—á–µ–Ω—å –∑—ñ span
const getNum = (id) => {
  const s = (document.getElementById(id)?.textContent || '').trim();
  const v = parseFloat(String(s).replace(',', '.'));
  return Number.isFinite(v) ? v : NaN;
};

// 1) Profit ‚âà Gross - Expenses
if (!isNaN(gross) && !isNaN(exp) && !isNaN(prof)) {
  const diff = Math.abs((gross - exp) - prof);
  if (diff > EPS) issues.push(`‚ùå Taxable Profit should equal Gross - Expenses (diff ‚Ç¨${diff.toFixed(2)})`);
}

// 2) TotalTax ‚âà IncomeTax + ZVW + BTW
const incomeTax = getNum('incomeTax');
const zvwAmount = getNum('zvwAmount');
const btwAmount = getNum('btwAmount');
const totalTax  = getNum('totalTax');

if ([incomeTax, zvwAmount, btwAmount, totalTax].every(v => !isNaN(v))) {
  const diff = Math.abs((incomeTax + zvwAmount + btwAmount) - totalTax);
  if (diff > EPS) issues.push(`‚ùå Total Tax should equal IncomeTax + ZVW + BTW (diff ‚Ç¨${diff.toFixed(2)})`);
}

// 3) ZZP/MKB –æ–±–º–µ–∂–µ–Ω–Ω—è —Ç–∞ —É–º–æ–≤–∏
const kvk       = (document.getElementById('kvk')?.value === 'yes');
const zzpHours  = (document.getElementById('zzpHours')?.value === 'yes');
const kor       = (document.getElementById('kor')?.value === 'yes');
const btwRateV  = (document.getElementById('btwRate')?.value || '21'); // '0','9','21'

const zzpEligible = kvk && zzpHours;

const zzpDed = getNum('zzpDeductions');
const mkb    = getNum('mkbVrijstelling');

// ZZP –¥–æ—Å—Ç—É–ø–Ω—ñ –ª–∏—à–µ —è–∫—â–æ KvK=Yes —Ç–∞ ‚â•1225 –≥–æ–¥–∏–Ω
if (!isNaN(zzpDed) && zzpDed > 0 && !zzpEligible) {
  issues.push('‚ùå ZZP deductions require KvK=Yes and ‚â•1225 hours.');
}

// MKB –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ —è–∫—â–æ ZZP eligible
if (!isNaN(mkb) && mkb > 0 && !zzpEligible) {
  issues.push('‚ùå MKB exemption requires ZZP eligibility (KvK=Yes and ‚â•1225 hours).');
}

// –õ—ñ–º—ñ—Ç 37.48% –≤—ñ–¥ –ø—Ä–æ—Ñ—ñ—Ç—É (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≤—Å—ñ —á–∏—Å–ª–∞ –≤–∞–ª—ñ–¥–Ω—ñ —ñ –ø—Ä–æ—Ñ—ñ—Ç > 0)
if (!isNaN(zzpDed) && !isNaN(mkb) && !isNaN(prof) && prof > 0) {
  const cap = 0.3748 * prof;
  if (zzpDed + mkb > cap + 0.01) {
    issues.push('‚ùå ZZP + MKB exceed 37.48% cap of profit.');
  }
}

// 4) KOR –ø—Ä–∞–≤–∏–ª–∞
if (kor) {
  if (btwAmount > EPS) issues.push('‚ùå KOR=Yes ‚Üí BTW must be 0.');
  if (!['0','9','21'].includes(btwRateV)) issues.push('‚ùå Invalid BTW rate (allowed: 0, 9, 21).');
}

// 5) –ú—ñ–Ω—É—Å–∏ / –≤–∏—Ç—Ä–∞—Ç–∏ > –¥–æ—Ö—ñ–¥
[['Gross income', gross], ['Total expenses', exp], ['Taxable profit', prof]].forEach(([name,val])=>{
  if (!isNaN(val) && val < 0) issues.push(`‚ùå ${name} cannot be negative.`);
});
if (!isNaN(exp) && !isNaN(gross) && exp > gross) {
  issues.push('‚ö†Ô∏è Expenses are higher than income.');
}
  return issues;
}

window.validateState = validateState; // –∑–∞–ª–∏—à–∞—î–º–æ —Ü–µ
  
  function runValidationUI(){
    // —è–∫—â–æ —î –ø–∞–Ω–µ–ª—å ‚Äî –æ–Ω–æ–≤–∏–º–æ —Å—Ç–∞—Ç—É—Å
    var s = document.getElementById("validateStatus");
    var o = document.getElementById("debugOut");
    if (!s || !o) return;                            // –ø–∞–Ω–µ–ª—ñ –º–æ–∂–µ –Ω–µ –±—É—Ç–∏ ‚Äî –æ–∫
    if (typeof window.validateState !== "function"){ // –Ω–µ–º–∞—î —Å–∞–º–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
      s.textContent = "‚ÑπÔ∏è Validation script not found";
      s.style.color = "#666";
      o.textContent = "";
      return;
    }
    var errs = window.validateState();
    if (errs.length){
      s.textContent = "‚ùå Issues found";
      s.style.color = "#c00";
      o.textContent = errs.map((e,i)=>`${i+1}. ${e}`).join("\n");
    } else {
      s.textContent = "‚úÖ No issues found";
      s.style.color = "#0a0";
      o.textContent = "All values look valid.";
    }
  }

  function attachHandlers(){
    // 1) Autocalc + –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ –Ω–∞ –±—É–¥—å-—è–∫–µ –≤–≤–µ–¥–µ–Ω–Ω—è
  
  document.querySelectorAll("input, select, textarea").forEach(function(el){
  el.addEventListener("input",  function(){
    if (typeof window.autoCalcIncome === "function") window.autoCalcIncome();
    runValidationUI(); // ‚úÖ —Ç—ñ–ª—å–∫–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è
  });
  el.addEventListener("change", function(){
    if (typeof window.autoCalcIncome === "function") window.autoCalcIncome();
    runValidationUI();
  });
});
    


    // 3) –ö–Ω–æ–ø–∫–∞ Export PDF
    var btnPdf = document.getElementById("btn-pdf");
    if (btnPdf) btnPdf.addEventListener("click", function(){
      if (typeof window.exportPDF === "function") window.exportPDF();
    });
    // 3.1) –ö–Ω–æ–ø–∫–∞ Export Excel
    var btnXlsx = document.getElementById("btn-xlsx");
    if (btnXlsx) btnXlsx.addEventListener("click", function(){
    if (typeof window.exportExcel === "function") window.exportExcel();
    });

    // 3.2) –ö–Ω–æ–ø–∫–∞ AI Chat
    var btnAI = document.getElementById("btn-ai");
    if (btnAI) btnAI.addEventListener("click", function(){
    if (typeof window.openAIChat === "function") window.openAIChat();
    });
    

    // 4) –ö–Ω–æ–ø–∫–∞ Run validation
    var btnVal = document.getElementById("btn-validate");
    if (btnVal) btnVal.addEventListener("click", runValidationUI);
  }

  // –ß–µ–∫–∞—î–º–æ DOM, —Ç–æ–¥—ñ –µ–∫—Å–ø–æ–Ω—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –ø–æ–¥—ñ—ó
  // DOM –≥–æ—Ç–æ–≤–∏–π
document.addEventListener("DOMContentLoaded", function(){
  exposeGlobals();
  attachHandlers();
  if (typeof window.autoCalcIncome === "function") window.autoCalcIncome();
  runValidationUI(); // –±–µ–∑ auto-submit!
});
document.getElementById('btn-ai').addEventListener('click', function(){
    // —Ñ–æ—Ä–º—É—î–º–æ payload (—É —Ç–µ–±–µ –≤–∂–µ —î —Ñ—É–Ω–∫—Ü—ñ—è openAIChat ‚Äì –º–æ–∂–Ω–∞ —ó—ó –≤–∏–∫–ª–∏–∫–∞—Ç–∏)
    // –ê–±–æ –ø—Ä–æ—Å—Ç–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É, —è–∫—â–æ payload –≤–∂–µ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π:
    window.open('./ai-assistant.html','_blank');
  });
  

  // –ù–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ —Å–∫—Ä–∏–ø—Ç–∏ –≤–∏—â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ ‚Äî –∑—Ä–æ–±–∏–º–æ –∫—ñ–ª—å–∫–∞ —Å–ø—Ä–æ–±
  var tries = 0;
  var t = setInterval(function(){
    tries++;
    exposeGlobals();
    if (window.calculateTax && (document.readyState === "complete" || document.readyState === "interactive")){
      try { attachHandlers(); if (window.autoCalcIncome) window.autoCalcIncome();  runValidationUI(); } catch(e){}
      clearInterval(t);
    }
    if (tries > 20) clearInterval(t); // ~10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
  }, 500);


async function clearHistory() {
  const db = window.smartwerkDb;
  const user = window.smartwerkUser && window.smartwerkUser();
  if (!db || !user) return;

  const snap = await getDocs(collection(db, "users", user.uid, "tax_calculations"));
  const deletions = snap.docs.map(doc => deleteDoc(doc.ref));
  await Promise.all(deletions);
  console.log("üßπ History cleared");
  await loadHistory();
}



// ‚úÖ –ü—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –¥–æ –∫–Ω–æ–ø–∫–∏ –æ–±–∏–¥–≤—ñ –¥—ñ—ó
// ‚úÖ –í–∂–µ –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î–º–æ calculateTax() —Ç—É—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ!

document.getElementById("btn-clear-history")?.addEventListener("click", () => {
  if (confirm("Are you sure you want to delete all history?")) {
    clearHistory();
  }
});

// ‚úÖ –ù–û–í–ò–ô –ë–õ–û–ö ‚Äî —Ä—É—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
document.getElementById("btn-load-history")?.addEventListener("click", () => {
  loadHistory();
});


    // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
// ‚úÖ –ü—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –¥–æ –∫–Ω–æ–ø–∫–∏ –æ–±–∏–¥–≤—ñ –¥—ñ—ó
document.getElementById("btn-calc")?.addEventListener("click", async () => {
  if (typeof window.calculateTax === "function") await window.calculateTax();

  // ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è ‚Äî –æ–∫—Ä–µ–º–æ
  runValidationUI();

  // ‚úÖ –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  const el = document.getElementById("calcStatus");
  if (el) {
    el.textContent = "‚úÖ Calculated & saved. History updated.";
    el.style.display = "block";
    setTimeout(() => { el.style.display = "none"; }, 5000);
  }

  // ‚úÖ –û–Ω–æ–≤–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —Ç—ñ–ª—å–∫–∏ –∑–∞—Ä–∞–∑
  await loadHistory();
});


    
})();
</script>
</body>
</html>
