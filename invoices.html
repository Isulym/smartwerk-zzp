<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartWerk Invoice Manager</title>

  <link rel="stylesheet" href="style-invoices.css?v=4" />

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- OCR + PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <style>
    .signature { border:1px solid #444; background:#fff; cursor:crosshair; }
    .step { margin:20px 0; padding:15px; border:1px solid #333; border-radius:8px; }
  </style>
</head>
<body>
  <div class="topbar">
    <nav>
      <a href="index.html" class="btn">â† Main Page</a>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="invoices-list.html" class="btn">ğŸ“‹ Invoices List</a>
    </nav>
  </div>

  <main>
    <h1>SmartWerk Invoice Manager</h1>

    <!-- Business Info -->
    <section class="step">
      <h2>ğŸ¢ Business Info</h2>
      <input id="businessName" placeholder="Business Name" />
      <input id="kvk" placeholder="KvK Number" />
      <input id="iban" placeholder="IBAN" />
      <input id="btw" placeholder="BTW Number" />
      <input id="businessEmail" type="email" placeholder="Business Email" />
      <input id="businessPhone" type="tel" placeholder="Business Phone" />
      <input id="businessAddress" placeholder="Business Address" />
    </section>

    <!-- Client Info -->
    <section class="step">
      <h2>ğŸ‘¤ Client Info</h2>
      <input id="clientName" placeholder="Client Name" />
      <input id="clientEmail" type="email" placeholder="Client Email" />
      <input id="clientPhone" type="tel" placeholder="Client Phone" />
      <input id="clientAddress" placeholder="Client Address" />

      <input id="invoiceDate" class="js-date" placeholder="Invoice Date" />
      <input id="dueDate" class="js-date" placeholder="Due Date" />
      <input id="invoiceNumber" placeholder="Invoice Number" />

      <label>Status:
        <select id="status">
          <option>Draft</option>
          <option>Sent</option>
          <option>Paid</option>
        </select>
      </label>
    </section>

    <!-- Items -->
    <section class="step">
      <h2>ğŸ“ Items</h2>
      <table>
        <thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>VAT %</th><th>Total</th><th></th></tr></thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button onclick="addItem()">â• Add Item</button>
    </section>

    <!-- Summary -->
    <section class="step">
      <h2>ğŸ“¦ Summary</h2>
      <textarea id="note" placeholder="Notes..."></textarea>
      <p><strong>Subtotal:</strong> <span id="subtotal">â‚¬0.00</span></p>
      <p><strong>Total VAT:</strong> <span id="totalVat">â‚¬0.00</span></p>
      <p><strong>Total:</strong> <span id="grandTotal">â‚¬0.00</span></p>
    </section>

    <!-- OCR -->
    <section class="step">
      <h2>ğŸ“· Receipt OCR</h2>
      <input type="file" id="receiptInput" accept="image/*" />
      <button onclick="processReceipt()">Scan</button>
      <pre id="receiptText"></pre>
    </section>

    <!-- Signatures -->
    <section class="step">
      <h2>âœï¸ Signatures</h2>
      <div>
        <h3>Business Signature</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>
        <h3>Client Signature</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step">
      <h2>âš™ï¸ Actions</h2>
      <button onclick="saveInvoice()">ğŸ’¾ Save Invoice</button>
      <a href="invoices-list.html" class="btn">ğŸ“‹ Open Invoices List</a>
    </section>
  </main>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1",
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
onAuthStateChanged(auth, (user)=>{ if(user) currentUser=user; else window.location.href="login.html"; });

/* ================= HELPERS ================= */
function $(id){ return document.getElementById(id); }
function clearSignature(id){ const c=$(id),ctx=c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height); }
function addItem(desc="",qty=1,price=0,vat=21){
  const tr=document.createElement("tr");
  tr.innerHTML=`<td><input class="desc" value="${desc}"></td>
  <td><input type="number" class="qty" value="${qty}"></td>
  <td><input type="number" class="price" value="${price}"></td>
  <td><select class="vat"><option>0</option><option>9</option><option selected>21</option></select></td>
  <td class="item-total">â‚¬0.00</td>
  <td><button onclick="this.closest('tr').remove();updateTotals()">âŒ</button></td>`;
  $("itemsBody").appendChild(tr);
  updateTotals();
}
function updateTotals(){
  let sub=0,vatSum=0;
  $("itemsBody").querySelectorAll("tr").forEach(tr=>{
    const qty=+tr.querySelector(".qty").value||0;
    const price=+tr.querySelector(".price").value||0;
    const vat=+tr.querySelector(".vat").value||0;
    const tot=qty*price; const vatAmt=tot*vat/100;
    sub+=tot; vatSum+=vatAmt;
    tr.querySelector(".item-total").innerText="â‚¬"+(tot+vatAmt).toFixed(2);
  });
  $("subtotal").innerText="â‚¬"+sub.toFixed(2);
  $("totalVat").innerText="â‚¬"+vatSum.toFixed(2);
  $("grandTotal").innerText="â‚¬"+(sub+vatSum).toFixed(2);
}
function processReceipt(){
  const file=$("receiptInput").files[0]; if(!file) return;
  $("receiptText").innerText="â³ Processing...";
  const r=new FileReader();
  r.onload=()=>Tesseract.recognize(r.result,'eng').then(({data:{text}})=>$("receiptText").innerText=text);
  r.readAsDataURL(file);
}

/* ================= SAVE ================= */
window.saveInvoice=async function(){
  if(!currentUser) return alert("Not logged in");
  const invoice={
    userId:currentUser.uid,
    businessName:$("businessName").value,
    kvk:$("kvk").value,
    iban:$("iban").value,
    btw:$("btw").value,
    businessEmail:$("businessEmail").value,
    businessPhone:$("businessPhone").value,
    businessAddress:$("businessAddress").value,
    clientName:$("clientName").value,
    clientEmail:$("clientEmail").value,
    clientPhone:$("clientPhone").value,
    clientAddress:$("clientAddress").value,
    invoiceNumber:$("invoiceNumber").value||("INV-"+Date.now()),
    invoiceDate:$("invoiceDate").value,
    dueDate:$("dueDate").value,
    note:$("note").value,
    status:$("status").value,
    items:[],
    subtotal:$("subtotal").innerText,
    totalVat:$("totalVat").innerText,
    grandTotal:$("grandTotal").innerText,
    createdAt:new Date().toISOString()
  };
  $("itemsBody").querySelectorAll("tr").forEach(tr=>{
    invoice.items.push({
      desc:tr.querySelector(".desc").value,
      qty:+tr.querySelector(".qty").value,
      price:+tr.querySelector(".price").value,
      vat:+tr.querySelector(".vat").value
    });
  });
  await addDoc(collection(db,"users",currentUser.uid,"invoices"),invoice);
  alert("âœ… Invoice saved!");
}
</script>
</body>
</html>
