<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk ‚Äî Invoice</title>
  <link rel="stylesheet" href="style-invoices.css?v=6"/>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  
</head>
<body>
  <header>
    <h1>üßæ SmartWerk Invoice</h1>
    <nav>
      <a href="index.html" class="btn">‚Üê Main Page</a>
      <a href="dashboard.html" class="btn">‚Üê Dashboard</a>
    </nav>
  </header>

  <main>
    <!-- Business Info -->
    <section>
      <h2>üè¢ Business Info</h2>
      <input id="businessName" placeholder="Business Name"/>
      <input id="kvk" placeholder="KvK Number"/>
      <input id="iban" placeholder="IBAN"/>
      <input id="btw" placeholder="BTW"/>
      <input id="email" placeholder="Business Email"/>
      <input id="businessAddress" placeholder="Business Address"/>
      <input id="businessPhone" placeholder="Business Phone"/>
    </section>

    <!-- Client Info -->
    <section>
      <h2>üë§ Client Info</h2>
      <input id="clientName" placeholder="Client Name"/>
      <input id="clientEmail" placeholder="Client Email"/>
      <input id="clientPhone" placeholder="Client Phone"/>
      <input id="clientAddress" placeholder="Client Address"/>
      <input id="invoiceDate" class="js-date" placeholder="YYYY-MM-DD">
      <input id="dueDate"     class="js-date" placeholder="YYYY-MM-DD">
      <input id="invoiceNumber" readonly placeholder="Invoice Number"/>
      <select id="status">
        <option>Draft</option>
        <option>Sent</option>
        <option>Paid</option>
      </select>
    </section>

    <!-- Items -->
    <section>
      <h2>üìù Items</h2>
      <table>
        <thead>
          <tr><th>Description</th><th>Qty</th><th>Price</th><th>VAT %</th><th>Total</th><th></th></tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button type="button" onclick="addItem()">‚ûï Add Item</button>
    </section>

    <!-- Summary -->
    <section>
      <h2>üì¶ Summary</h2>
      <p>Subtotal: <span id="subtotal">‚Ç¨0.00</span></p>
      <p>Total VAT: <span id="totalVat">‚Ç¨0.00</span></p>
      <p>Total: <span id="grandTotal">‚Ç¨0.00</span></p>
      <textarea id="note" placeholder="Note..."></textarea>
    </section>

    <!-- OCR -->
    <section>
      <h2>üì∑ OCR</h2>
      <input type="file" id="receiptInput" accept="image/*"/>
      <button onclick="processReceipt()">Scan</button>
      <pre id="receiptText"></pre>
    </section>

    <!-- Signatures -->
    <section>
      <h2>‚úçÔ∏è Signatures</h2>
      <div>
        <h3>Business</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>
        <h3>Client</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section>
    <section class="step actions">
  <button id="saveBtn" class="btn-primary">üíæ Save Invoice</button>
  <a href="invoices-list.html" class="btn-primary">üìã Open Invoices List</a>
</section>
  </main>
 <footer>
    <p>¬© 2025 SmartWerk</p>
  </footer>

<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1",
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let signatureBusinessDate = "";
let signatureClientDate = "";

// ==== Items ====
function addItem(desc="", qty=1, price=0, vat=21){
  const row=document.createElement("tr");
  row.innerHTML=`
    <td><input class="desc" value="${desc}"/></td>
    <td><input class="qty" type="number" value="${qty}" min="1"/></td>
    <td><input class="price" type="number" value="${price}" step="0.01"/></td>
    <td><select class="vat"><option>0</option><option>9</option><option ${vat==21?"selected":""}>21</option></select></td>
    <td class="item-total">‚Ç¨0.00</td>
    <td><button type="button" onclick="this.closest('tr').remove();updateTotals();">‚ùå</button></td>
  `;
  row.querySelectorAll("input,select").forEach(el=>el.oninput=updateTotals);
  document.getElementById("itemsBody").appendChild(row);
  updateTotals();
}
window.addItem=addItem;

function updateTotals(){
  let subtotal=0,totalVat=0;
  document.querySelectorAll("#itemsBody tr").forEach(r=>{
    const qty=+r.querySelector(".qty").value||0;
    const price=+r.querySelector(".price").value||0;
    const vat=+r.querySelector(".vat").value||0;
    const t=qty*price;
    subtotal+=t;
    totalVat+=t*vat/100;
    r.querySelector(".item-total").innerText="‚Ç¨"+(t+t*vat/100).toFixed(2);
  });
  document.getElementById("subtotal").innerText="‚Ç¨"+subtotal.toFixed(2);
  document.getElementById("totalVat").innerText="‚Ç¨"+totalVat.toFixed(2);
  document.getElementById("grandTotal").innerText="‚Ç¨"+(subtotal+totalVat).toFixed(2);
}
window.updateTotals=updateTotals;

// ==== Signatures ====
function clearSignature(id){
  const c=document.getElementById(id),ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  if(id==="signatureBusiness"){signatureBusinessDate="";document.getElementById("signatureBusinessDate").innerText="";}
  else{signatureClientDate="";document.getElementById("signatureClientDate").innerText="";}
}
window.clearSignature=clearSignature;

["signatureBusiness","signatureClient"].forEach(id=>{
  const c=document.getElementById(id),ctx=c.getContext("2d");let draw=false;
  c.addEventListener("mousedown",()=>{draw=true;ctx.beginPath();});
  c.addEventListener("mouseup",()=>{draw=false;const now=new Date().toLocaleDateString();if(id==="signatureBusiness"){signatureBusinessDate=now;document.getElementById("signatureBusinessDate").innerText=now;}else{signatureClientDate=now;document.getElementById("signatureClientDate").innerText=now;}});
  c.addEventListener("mousemove",e=>{if(!draw)return;const r=c.getBoundingClientRect();ctx.lineWidth=2;ctx.lineCap="round";ctx.strokeStyle="#2563eb";ctx.lineTo(e.clientX-r.left,e.clientY-r.top);ctx.stroke();ctx.beginPath();ctx.moveTo(e.clientX-r.left,e.clientY-r.top);});
});

// ==== OCR ====
function processReceipt(){
  const f=document.getElementById("receiptInput").files[0];
  if(!f)return;
  const out=document.getElementById("receiptText");
  out.innerText="‚è≥ Scanning...";
  const reader=new FileReader();
  reader.onload=()=>Tesseract.recognize(reader.result,"eng").then(({data:{text}})=>out.innerText=text);
  reader.readAsDataURL(f);
}
window.processReceipt=processReceipt;

// ==== Firestore Save ====
async function generateInvoiceNumber(uid) {
  const ref = doc(db, "users", uid, "meta", "counters");
  const year = new Date().getFullYear();
  return await runTransaction(db, async (tx) => {
    const snap = await tx.get(ref);
    const last = snap.exists() ? (snap.data().lastInvoiceNumber || 0) : 0;
    const next = last + 1;
    tx.set(ref, { lastInvoiceNumber: next }, { merge: true });
    return `INV-${year}-${String(next).padStart(3, "0")}`;
  });
}

// ... —É—Å–µ—Ä–µ–¥–∏–Ω—ñ saveInvoice():
let invoiceNumber = document.getElementById("invoiceNumber").value.trim();
if (!invoiceNumber) {
  invoiceNumber = await generateInvoiceNumber(user.uid);
  document.getElementById("invoiceNumber").value = invoiceNumber;
}

async function saveInvoice(){
  const user=auth.currentUser;if(!user) return;
  const uid=user.uid;
  let invId=localStorage.getItem("editInvoiceId")||null;
  let invoiceNumber=document.getElementById("invoiceNumber").value;
  if(!invId && !invoiceNumber){
    invoiceNumber=await generateInvoiceNumber(uid);
    document.getElementById("invoiceNumber").value=invoiceNumber;
  }
  const items=[];
  document.querySelectorAll("#itemsBody tr").forEach(r=>{
    items.push({
      desc:r.querySelector(".desc").value,
      qty:+r.querySelector(".qty").value,
      price:+r.querySelector(".price").value,
      vat:+r.querySelector(".vat").value
    });
  });
  const data={
    businessName:document.getElementById("businessName").value,
    clientName:document.getElementById("clientName").value,
    invoiceDate:document.getElementById("invoiceDate").value,
    dueDate:document.getElementById("dueDate").value,
    invoiceNumber,
    status:document.getElementById("status").value,
    note:document.getElementById("note").value,
    items,
    subtotal:document.getElementById("subtotal").innerText,
    totalVat:document.getElementById("totalVat").innerText,
    grandTotal:document.getElementById("grandTotal").innerText,
    signatures:{
      business:document.getElementById("signatureBusiness").toDataURL(),
      client:document.getElementById("signatureClient").toDataURL(),
      businessDate:signatureBusinessDate,
      clientDate:signatureClientDate
    },
    userId:uid
  };
  if(invId){await setDoc(doc(db,"users",uid,"invoices",invId),data);localStorage.removeItem("editInvoiceId");}
  else{await addDoc(collection(db,"users",uid,"invoices"),data);}
  alert("‚úÖ Saved!");
}
document.getElementById("saveBtn").addEventListener("click", saveInvoice);

  
  // === Preview Invoice Number ===
  async function previewNextInvoiceNumber(uid) {
    try {
      const ref  = doc(db, "users", uid, "meta", "counters");
      const snap = await getDoc(ref);
      const last = snap.exists() ? (snap.data().lastInvoiceNumber || 0) : 0;
      const next = last + 1;
      const preview = `INV-${new Date().getFullYear()}-${String(next).padStart(3,"0")}`;
      const el = document.getElementById("invoiceNumber");
      if (el && !el.value) {
        el.placeholder = preview; // –ø–æ–∫–∞–∑—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
      }
    } catch (e) {
      console.error("Preview error:", e);
    }
  }

// ==== Init ====
onAuthStateChanged(auth,user=>{
  if(!user) return location.href="login.html";
  flatpickr(".js-date",{dateFormat:"Y-m-d"});
});
</script>
</body>
</html>
