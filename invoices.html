<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartWerk Invoice Manager</title>

  <link rel="stylesheet" href="style-invoices.css?v=3" />

  <!-- Flatpickr calendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* –õ–µ–≥–∫–∞ —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—è (—Ç–µ–º–Ω–∞ —Ç–µ–º–∞) */
    .flatpickr-calendar{background:#0f172a;color:#e5e7eb;border:1px solid #1f2937}
    .flatpickr-months{background:#111827;border-bottom:1px solid #1f2937}
    .flatpickr-months .flatpickr-month,
    .flatpickr-current-month .cur-month{color:#e5e7eb !important}
    .flatpickr-current-month .numInputWrapper input{color:#e5e7eb}
    span.flatpickr-weekday{color:#d1d5db}
    .flatpickr-day{color:#d1d5db}
    .flatpickr-day.today{border-color:#60a5fa}
    .flatpickr-day.selected,.flatpickr-day.startRange,.flatpickr-day.endRange{background:#2563eb;border-color:#2563eb;color:#fff}
    .flatpickr-next-month,.flatpickr-prev-month{color:#9ca3af}
  </style>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
</head>
<body>

<div class="topbar">
  <nav>
     <a class="btn" href="index.html" id="btnHome">Main Page</a>
    <a class="btn ghost" href="dashboard.html" id="btnToDashboard">Dashboard</a>
    <a class="btn" href="invoices-list.html" id="btnToList">üìã Invoices List</a>
  </nav>
</div>
  


  <main>
    <h1>SmartWerk Invoice Manager</h1>

    <!-- Step 1: Business Info -->
    <section class="step">
      <h2>üè¢ Business Info</h2>
      <label>Business Name <input id="businessName" type="text" placeholder="Business Name" /></label>
      <label>KvK Number <input id="kvk" type="text" placeholder="KvK Number" /></label>
      <label>IBAN <input id="iban" type="text" placeholder="IBAN" /></label>
      <label>Email <input id="email" type="email" placeholder="Email" /></label>
      <label>Business Address <input id="businessAddress" type="text" placeholder="Business Address" /></label>
      <label>Business Phone <input id="businessPhone" type="tel" placeholder="Business Phone" /></label>
      <label for="btw">BTW:</label>
      <input type="text" id="btw" />
    </section>

    <!-- Step 2: Client Info -->
    <section class="step">
      <h2>üë§ Client Info</h2>
      <label>Client Name <input id="clientName" type="text" placeholder="Client Name" /></label>
      <label>Client Email <input id="clientEmail" type="email" placeholder="Client Email" /></label>
      <label>Client Phone <input id="clientPhone" type="tel" placeholder="Client Phone" /></label>
      <label>Client Address <input id="clientAddress" type="text" placeholder="Client Address" /></label>

      <label>Invoice Date <input id="invoiceDate" type="text" class="js-date" placeholder="YYYY-MM-DD" /></label>
      <label>Due Date <input id="dueDate" type="text" class="js-date" placeholder="YYYY-MM-DD" /></label>
      <label>Invoice Number <input id="invoiceNumber" type="text" placeholder="Invoice Number" /></label>

      <label for="status">Status:</label>
      <select id="status">
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
    </section>

    <!-- Step 3: Items -->
    <section class="step">
      <h2>üìù Invoice Items</h2>
      <table>
        <thead>
          <tr>
            <th>Description</th>
            <th>Qty</th>
            <th>Price</th>
            <th>VAT (%)</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button onclick="addItem()">‚ûï Add Item</button>
    </section>

    <!-- Step 4: Summary -->
    <section class="step">
      <h2>üì¶ Summary</h2>
      <label>Note
        <textarea id="note" placeholder="Invoice note (optional)..."></textarea>
      </label>
      <p><strong>Subtotal:</strong> <span id="subtotal">‚Ç¨0.00</span></p>
      <p><strong>Total VAT:</strong> <span id="totalVat">‚Ç¨0.00</span></p>
      <p><strong>Total:</strong> <span id="grandTotal">‚Ç¨0.00</span></p>
    </section>

    <!-- OCR -->
    <section class="step ocr-section">
      <h2>üì∑ Receipt OCR</h2>
      <label>Upload Receipt: <input type="file" id="receiptInput" accept="image/*" /></label>
      <button onclick="processReceipt()">Scan</button>
      <pre id="receiptText"></pre>
    </section>

    <!-- Step 5: Signatures -->
    <section class="step">
      <h2>‚úçÔ∏è Signatures</h2>

      <div>
        <h3>Business Signature:</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas><br/>
        <button onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>

      <div>
        <h3>Client Signature:</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas><br/>
        <button onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Step 6: Actions -->
    <section class="step">
      <h2>‚öôÔ∏è Actions</h2>
      <button onclick="saveInvoice()">üíæ Save Invoice</button>
      <a class="btn" href="invoices-list.html">üìã Open Invoices List</a>
    </section>
  </main>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- ===== App logic (create/edit only) ===== -->
  <script>
/* ==== Calendar ==== */
function initDatepickers(root=document){
  const opts = {
    dateFormat: "Y-m-d",
    allowInput: true,
    onChange: (sel,str,inst)=>{
      const input = inst._input;
      input.value = str || "";
      input.dispatchEvent(new Event('input',{bubbles:true}));
      input.dispatchEvent(new Event('change',{bubbles:true}));
    }
  };
  const pickers = ['#invoiceDate','#dueDate','.js-date'];
  const nodes = new Set();
  pickers.forEach(sel => document.querySelectorAll(sel).forEach(el=>nodes.add(el)));
  nodes.forEach(el => { if (!el._fp) el._fp = flatpickr(el, opts); });
}
function suggestDueDate(){
  const inv = document.getElementById('invoiceDate');
  const due = document.getElementById('dueDate');
  if (!inv || !inv.value || !due) return;
  const d = new Date(inv.value); if (String(d)==='Invalid Date') return;
  d.setDate(d.getDate()+14);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  due.value = `${y}-${m}-${dd}`;
  due.dispatchEvent(new Event('input',{bubbles:true}));
  due.dispatchEvent(new Event('change',{bubbles:true}));
}

/* ==== Utils ==== */
function normStatus(s){ return (s||"").toString().trim().toLowerCase(); }
function toEnumStatus(s){ const t = normStatus(s); return t==="paid"?"Paid":t==="sent"?"Sent":"Draft"; }
function generateNextInvoiceNumber() {
  const arr = safeReadInvoices();
  const numbers = arr
    .map(inv => inv.invoiceNumber)
    .filter(num => /^INV-2025-\d{3}$/.test(num || ""))
    .map(num => parseInt(num.split("-")[2]))
    .sort((a, b) => b - a);
  const next = numbers.length ? numbers[0] + 1 : 1;
  const padded = String(next).padStart(3, "0");
  return `INV-2025-${padded}`;
}
function safeReadInvoices(){
  const raw = localStorage.getItem("invoices");
  if (!raw) return [];
  try {
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch(e){ return []; }
}
function safeWriteInvoices(arr){
  localStorage.setItem("invoices", JSON.stringify(arr || []));
  // "–ü—É–ª—å—Å", —â–æ–± —ñ–Ω—à—ñ –≤–∫–ª–∞–¥–∫–∏/—Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –ø–æ–±–∞—á–∏–ª–∏ –∑–º—ñ–Ω—É
  localStorage.setItem("invoices:pulse", String(Date.now()));
}

/* ==== Items & totals ==== */
function addItem(desc = "", qty = 1, price = 0, vat = 21) {
  const row = document.createElement("tr");

  const tdDesc = document.createElement("td");
  const inputDesc = document.createElement("input");
  inputDesc.className = "desc";
  inputDesc.placeholder = "Description";
  inputDesc.value = desc;
  inputDesc.oninput = updateTotals;
  tdDesc.appendChild(inputDesc);

  const tdQty = document.createElement("td");
  const inputQty = document.createElement("input");
  inputQty.className = "qty";
  inputQty.type = "number";
  inputQty.min = "1";
  inputQty.value = qty;
  inputQty.onchange = updateTotals;
  tdQty.appendChild(inputQty);

  const tdPrice = document.createElement("td");
  const inputPrice = document.createElement("input");
  inputPrice.className = "price";
  inputPrice.type = "number";
  inputPrice.step = "0.01";
  inputPrice.value = price;
  inputPrice.onchange = updateTotals;
  tdPrice.appendChild(inputPrice);

  const tdVAT = document.createElement("td");
  const selVAT = document.createElement("select");
  selVAT.className = "vat-select";
  [0,9,21].forEach(v=>{
    const opt = document.createElement("option");
    opt.value = String(v);
    opt.textContent = String(v);
    if (Number(v) === Number(vat)) opt.selected = true;
    selVAT.appendChild(opt);
  });
  selVAT.onchange = updateTotals;
  tdVAT.appendChild(selVAT);

  const tdTotal = document.createElement("td");
  tdTotal.className = "item-total";
  tdTotal.textContent = "‚Ç¨0.00";

  const tdDelete = document.createElement("td");
  const btnDel = document.createElement("button");
  btnDel.type = "button";
  btnDel.textContent = "‚ùå";
  btnDel.onclick = function () { this.closest("tr").remove(); updateTotals(); };
  tdDelete.appendChild(btnDel);

  row.append(tdDesc, tdQty, tdPrice, tdVAT, tdTotal, tdDelete);
  document.getElementById("itemsBody").appendChild(row);
  updateTotals();
}
function updateTotals() {
  let subtotal = 0, totalVAT = 0;
  const rows = document.querySelectorAll("#itemsBody tr");
  if (!rows.length) {
    document.getElementById("subtotal").innerText = "‚Ç¨0.00";
    document.getElementById("totalVat").innerText = "‚Ç¨0.00";
    document.getElementById("grandTotal").innerText = "‚Ç¨0.00";
    return;
  }
  rows.forEach(row => {
    const qty = parseFloat(row.querySelector(".qty")?.value) || 0;
    const price = parseFloat(row.querySelector(".price")?.value) || 0;
    const vatEl = row.querySelector(".vat-select") || row.querySelector(".vat");
    const vat = parseFloat(vatEl ? vatEl.value : 0) || 0;

    const itemTotal = qty * price;
    const itemVAT = itemTotal * vat / 100;
    const totalWithVAT = itemTotal + itemVAT;

    subtotal += itemTotal; totalVAT += itemVAT;
    const totalCell = row.querySelector(".item-total");
    if (totalCell) totalCell.innerText = `‚Ç¨${totalWithVAT.toFixed(2)}`;
  });
  document.getElementById("subtotal").innerText = `‚Ç¨${subtotal.toFixed(2)}`;
  document.getElementById("totalVat").innerText = `‚Ç¨${totalVAT.toFixed(2)}`;
  document.getElementById("grandTotal").innerText = `‚Ç¨${(subtotal + totalVAT).toFixed(2)}`;
}

/* ==== Reset & signatures ==== */
function resetFormFields() {
  ["businessName","kvk","iban","btw","email","businessAddress","businessPhone",
   "clientName","clientEmail","clientAddress","clientPhone","note"].forEach(id=>{
    const el = document.getElementById(id); if (el) el.value="";
  });
  document.getElementById("invoiceNumber").value = generateNextInvoiceNumber();
  document.getElementById("invoiceDate").value = "";
  document.getElementById("dueDate").value = "";
  document.getElementById("status").value = "Draft";
  document.getElementById("itemsBody").innerHTML="";
  document.getElementById("subtotal").innerText="‚Ç¨0.00";
  document.getElementById("totalVat").innerText="‚Ç¨0.00";
  document.getElementById("grandTotal").innerText="‚Ç¨0.00";
  ["signatureBusiness","signatureClient"].forEach(id=>{
    const canvas = document.getElementById(id); const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);
  });
  signatureBusinessDate = ""; signatureClientDate = "";
  document.getElementById("signatureBusinessDate").innerText = "";
  document.getElementById("signatureClientDate").innerText = "";
}

/* ==== Signatures ==== */
function clearSignature(canvasId) {
  const canvas = document.getElementById(canvasId); if (!canvas) return;
  const ctx = canvas.getContext("2d"); ctx.clearRect(0,0,canvas.width,canvas.height);
  if (canvasId === "signatureBusiness") {
    signatureBusinessDate = ""; document.getElementById("signatureBusinessDate").innerText = "";
  } else {
    signatureClientDate = ""; document.getElementById("signatureClientDate").innerText = "";
  }
}
let signatureBusinessDate = "";
let signatureClientDate = "";

/* ==== OCR ==== */
function processReceipt() {
  const input = document.getElementById("receiptInput");
  const output = document.getElementById("receiptText");
  if (!input || !output) return;
  const file = input.files?.[0];
  if (!file) { output.innerText = "‚ö†Ô∏è No file selected."; return; }
  const reader = new FileReader();
  reader.onload = async function () {
    const imageData = reader.result;
    output.innerText = "‚è≥ Processing OCR...";
    try {
      const { data: { text } } = await Tesseract.recognize(imageData, 'eng');
      output.innerText = `‚úÖ Extracted text:\n${text.trim()}`;
    } catch (err) { console.error("OCR error:", err); output.innerText = "‚ùå Failed to process receipt."; }
  };
  reader.onerror = function () { output.innerText = "‚ùå Error reading the file."; };
  reader.readAsDataURL(file);
}

/* ==== Save (with edit support) ==== */
function saveInvoice() {
  const invoice = {
    businessName: document.getElementById("businessName")?.value || "",
    kvk: document.getElementById("kvk")?.value || "",
    iban: document.getElementById("iban")?.value || "",
    btw: document.getElementById("btw")?.value || "",
    email: document.getElementById("email")?.value || "",
    businessAddress: document.getElementById("businessAddress")?.value || "",
    businessPhone: document.getElementById("businessPhone")?.value || "",
    clientName: document.getElementById("clientName")?.value || "",
    clientEmail: document.getElementById("clientEmail")?.value || "",
    clientAddress: document.getElementById("clientAddress")?.value || "",
    clientPhone: document.getElementById("clientPhone")?.value || "",
    invoiceNumber: (document.getElementById("invoiceNumber")?.value || "").trim() || generateNextInvoiceNumber(),
    invoiceDate: document.getElementById("invoiceDate")?.value || "",
    dueDate: document.getElementById("dueDate")?.value || "",
    note: document.getElementById("note")?.value || "",
    status: document.getElementById("status")?.value || "Draft",
    items: [],
    signatures: {
      business: "",
      client: "",
      businessDate: signatureBusinessDate || "",
      clientDate: signatureClientDate || "",
      date: new Date().toLocaleDateString("nl-NL")
    }
  };

  // –ó—ñ–±—Ä–∞—Ç–∏ —Ä—è–¥–∫–∏
  document.querySelectorAll("#itemsBody tr").forEach(row => {
    const vatEl = row.querySelector(".vat-select, .vat");
    invoice.items.push({
      desc: row.querySelector(".desc")?.value || "",
      qty: parseFloat(row.querySelector(".qty")?.value || 0),
      price: parseFloat(row.querySelector(".price")?.value || 0),
      vat: parseFloat(vatEl ? vatEl.value : 0)
    });
  });

  // –ü—ñ–¥–ø–∏—Å–∏ (—è–∫—â–æ —î)
  try {
    const sb = document.getElementById("signatureBusiness")?.toDataURL() || "";
    const sc = document.getElementById("signatureClient")?.toDataURL() || "";
    invoice.signatures.business = sb; invoice.signatures.client = sc;
  } catch(e) {}

  // –ë–µ–∑–ø–µ—á–Ω–µ —á–∏—Ç–∞–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ—ó
  let invoices = safeReadInvoices();

  // –†–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è (–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä)
  const originalNum = window.EDITING_ORIGINAL_NUMBER || localStorage.getItem("editingOriginalNumber") || null;
  const isEdit = !!originalNum;

  // –õ—ñ–º—ñ—Ç —Ç—ñ–ª—å–∫–∏ –¥–ª—è –Ω–æ–≤–∏—Ö
  if (!isEdit && typeof window.isBlockedByFreeLimit === "function" && window.isBlockedByFreeLimit(false)) {
    alert(`‚ùó You've reached the Free plan limit (3 invoices). Upgrade to PRO for unlimited invoices.`);
    return;
  }

  if (isEdit) {
    const idx = invoices.findIndex(i => String(i.invoiceNumber) === String(originalNum));
    if (idx >= 0) {
      // –Ø–∫—â–æ –∑–º—ñ–Ω–µ–Ω–æ –Ω–æ–º–µ—Ä ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥—É–±–ª—å
      const dupIdx = invoices.findIndex(i => String(i.invoiceNumber) === String(invoice.invoiceNumber));
      if (dupIdx >= 0 && dupIdx !== idx) { alert("Invoice with this number already exists."); return; }
      invoices[idx] = invoice;
    } else {
      // –û—Ä–∏–≥—ñ–Ω–∞–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ ‚Äî –∑–±–µ—Ä–µ–≥—Ç–∏ —è–∫ –Ω–æ–≤–∏–π, –ø–µ—Ä–µ–≤—ñ—Ä–∏–≤—à–∏ –¥—É–±–ª—å
      if (invoices.some(i => String(i.invoiceNumber) === String(invoice.invoiceNumber))) {
        alert("Invoice with this number already exists."); return;
      }
      invoices.push(invoice);
    }
    // –û—á–∏—Å—Ç–∏—Ç–∏ –ø—Ä–∞–ø–æ—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    localStorage.removeItem("editingOriginalNumber");
    window.EDITING_ORIGINAL_NUMBER = null;
  } else {
    // –ù–æ–≤–∏–π ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—è
    if (invoices.some(i => String(i.invoiceNumber) === String(invoice.invoiceNumber))) {
      alert("Invoice with this number already exists."); return;
    }
    invoices.push(invoice);
  }

  // –ó–∞–ø–∏—Å + ‚Äú–ø—É–ª—å—Å‚Äù
  safeWriteInvoices(invoices);

  // –£ —Ö–º–∞—Ä—É ‚Äî –ª–∏—à–µ –Ω–æ–≤—ñ
  if (!isEdit && window.saveInvoiceToCloud) {
    window.saveInvoiceToCloud(invoice).catch(console.error);
  }

  resetFormFields();
  alert("Invoice saved successfully!");
}

/* ==== Load for edit if requested from list page ==== */
function loadInvoiceForEditByNumber(num) {
  const invoices = safeReadInvoices();
  const idx = invoices.findIndex(i => String(i.invoiceNumber) === String(num));
  const inv = invoices[idx];
  if (!inv) { alert("Invoice not found."); return; }
  if (normStatus(inv.status) !== "draft") { alert("Editing is only allowed in 'Draft' status."); return; }

  ["businessName","kvk","iban","btw","email","businessAddress","businessPhone"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value = inv[id] || "";
  });
  document.getElementById("clientName").value = inv.clientName || "";
  document.getElementById("clientEmail").value = inv.clientEmail || "";
  document.getElementById("clientAddress").value = inv.clientAddress || "";
  document.getElementById("clientPhone").value = inv.clientPhone || "";
  document.getElementById("invoiceNumber").value = inv.invoiceNumber || "";
  document.getElementById("invoiceDate").value = inv.invoiceDate || "";
  document.getElementById("dueDate").value = inv.dueDate || "";
  document.getElementById("note").value = inv.note || "";
  document.getElementById("status").value = toEnumStatus(inv.status);

  const tbody = document.getElementById("itemsBody"); tbody.innerHTML="";
  (inv.items||[]).forEach(item => addItem(item.desc, item.qty, item.price, item.vat));

  if (inv.signatures) {
    const bImg = new Image();
    bImg.onload = () => {
      const c = document.getElementById("signatureBusiness"); const ctx=c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height); ctx.drawImage(bImg,0,0);
      document.getElementById("signatureBusinessDate").innerText = inv.signatures.businessDate || inv.signatures.date || "";
    };
    bImg.src = inv.signatures.business || "";
    const cImg = new Image();
    cImg.onload = () => {
      const c = document.getElementById("signatureClient"); const ctx=c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height); ctx.drawImage(cImg,0,0);
      document.getElementById("signatureClientDate").innerText = inv.signatures.clientDate || inv.signatures.date || "";
    };
    cImg.src = inv.signatures.client || "";
  }
  updateTotals();

  // –ø–æ–∑–Ω–∞—á–∏–º–æ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  window.EDITING_ORIGINAL_NUMBER = inv.invoiceNumber;
  localStorage.setItem("editingOriginalNumber", inv.invoiceNumber);
}

document.addEventListener("DOMContentLoaded", () => {
  ["signatureBusiness","signatureClient"].forEach((id) => {
    const canvas = document.getElementById(id); if (!canvas) return;
    const ctx = canvas.getContext("2d"); let isDrawing=false;
    canvas.addEventListener("mousedown", () => { isDrawing = true; ctx.beginPath(); });
    canvas.addEventListener("mouseup", () => {
      isDrawing = false;
      const now = new Date().toLocaleDateString("nl-NL");
      if (id==="signatureBusiness"){ signatureBusinessDate = now; document.getElementById("signatureBusinessDate").innerText = now; }
      else { signatureClientDate = now; document.getElementById("signatureClientDate").innerText = now; }
    });
    canvas.addEventListener("mouseout", () => isDrawing=false);
    canvas.addEventListener("mousemove", (e) => {
      if (!isDrawing) return;
      const r = canvas.getBoundingClientRect(); const x = e.clientX - r.left; const y = e.clientY - r.top;
      ctx.lineWidth=2; ctx.lineCap="round"; ctx.strokeStyle="black"; ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y);
    });
  });

  initDatepickers(document);
  const invNum = document.getElementById("invoiceNumber");
  if (invNum && !invNum.value) invNum.value = generateNextInvoiceNumber();
  if (!document.querySelector("#itemsBody tr")) addItem();
  updateTotals();
  const invDate = document.getElementById('invoiceDate');
  if (invDate) invDate.addEventListener('change', suggestDueDate);

  // —è–∫—â–æ –ø—Ä–∏–π—à–ª–∏ –∑—ñ —Å–ø–∏—Å–∫—É –Ω–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  const token = localStorage.getItem('editInvoiceNumber');
  if (token) {
    localStorage.removeItem('editInvoiceNumber');
    loadInvoiceForEditByNumber(token);
  }
});
  </script>

  <!-- ===== Firebase: profile autofill + limit check + cloud save + realtime merge ===== -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc, collection, addDoc, increment, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* –õ—ñ–º—ñ—Ç */
    const FREE_LIMIT = 3;
    window.SW_STATE = { isPro:false, invoiceCount:0 };
    window.isBlockedByFreeLimit = function isBlockedByFreeLimit(isEdit = false){
      const { isPro, invoiceCount } = window.SW_STATE || {};
      if (isPro) return false;
      return !isEdit && Number(invoiceCount || 0) >= FREE_LIMIT;
    };

    // Cloud save ‚Äî —Ç—ñ–ª—å–∫–∏ –¥–ª—è –Ω–æ–≤–∏—Ö
    window.saveInvoiceToCloud = async function(invoice){
      const user = auth.currentUser;
      if (!user) return;
      await addDoc(collection(db, 'users', user.uid, 'invoices'), invoice);
      await updateDoc(doc(db,'users',user.uid), { invoiceCount: increment(1) }).catch(()=>{});
      window.SW_STATE.invoiceCount = (window.SW_STATE.invoiceCount || 0) + 1;
    };

    // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª–µ–º
    const wantAutofill = location.hash.includes("autofill=1");
    function setIfAllowed(input, value) {
      if (!input) return;
      const isEmpty = !input.value || String(input.value).trim() === "";
      if (wantAutofill || isEmpty) {
        input.value = value ?? "";
        input.dispatchEvent(new Event("input", { bubbles: true }));
        input.dispatchEvent(new Event("change", { bubbles: true }));
      }
    }
    function pick(...ids) { for (const id of ids){ const el = document.getElementById(id); if (el) return el; } return null; }
    function prefillInvoiceForm(profile, userEmailFromAuth) {
      const elBusinessName   = pick("businessName","companyName","sellerName");
      const elBusinessEmail  = pick("businessEmail","email","sellerEmail");
      const elBusinessPhone  = pick("businessPhone","phone","sellerPhone");
      const elBusinessAddr   = pick("businessAddress","address","sellerAddress","addrLine");
      const elKvK            = pick("kvk","kvkNumber","sellerKvK");
      const elIBAN           = pick("iban","bankIban","sellerIban");
      const elVAT            = pick("vatNumber","vat","sellerVat");
      const fullName = profile.fullName || "";
      const address  = profile.address  || "";
      const phone    = profile.phone    || "";
      const kvk      = profile.kvk      || "";
      const iban     = profile.iban     || "";
      const vatNum   = profile.vatNumber || profile.vat || "";
      const email    = profile.email || userEmailFromAuth || "";
      setIfAllowed(elBusinessName, fullName);
      setIfAllowed(elBusinessEmail, email);
      setIfAllowed(elBusinessPhone, phone);
      setIfAllowed(elBusinessAddr, address);
      setIfAllowed(elKvK, kvk);
      setIfAllowed(elIBAN, iban);
      setIfAllowed(elVAT, vatNum);
    }

    /* Realtime merge Firestore ‚Üí localStorage */
    let unsubscribeInvoices = null;
    function subscribeInvoices(user){
      if (unsubscribeInvoices) { unsubscribeInvoices(); unsubscribeInvoices = null; }
      if (!user) return;
      const colRef = collection(db, 'users', user.uid, 'invoices');
      unsubscribeInvoices = onSnapshot(colRef, (snap)=>{
        const remote = [];
        snap.forEach(d => remote.push(d.data()));
        const local = JSON.parse(localStorage.getItem('invoices') || '[]') || [];
        const map = new Map(Array.isArray(local) ? local.map(inv => [inv?.invoiceNumber, inv]) : []);
        let changed = false;
        remote.forEach(r => {
          if (!r || !r.invoiceNumber) return;
          const prev = map.get(r.invoiceNumber);
          map.set(r.invoiceNumber, r);
          if (!prev || JSON.stringify(prev) !== JSON.stringify(r)) changed = true;
        });
        if (changed) {
          localStorage.setItem('invoices', JSON.stringify(Array.from(map.values())));
          localStorage.setItem('invoices:pulse', String(Date.now()));
        }
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const userRef = doc(db, "users", user.uid);
          const snap = await getDoc(userRef);
          const data = snap.exists() ? snap.data() : {};
          if (!data.email && user.email) data.email = user.email;

          window.SW_STATE.isPro        = !!data.pro;
          window.SW_STATE.invoiceCount = Number.isFinite(data.invoiceCount) ? data.invoiceCount : 0;

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => prefillInvoiceForm(data, user.email));
          } else {
            prefillInvoiceForm(data, user.email);
          }

          subscribeInvoices(user);
        } catch (err) {
          console.error("Autofill/Realtime error:", err);
        }
      }
    });
  </script>
</body>
</html>
