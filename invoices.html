<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartWerk Invoice Manager</title>

  <!-- –¢–µ–º–∞ –≤ —Å—Ç–∏–ª—ñ dashboard/login -->
  <link rel="stylesheet" href="style-invoices.css?v=3" />

  <!-- Flatpickr calendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
</head>
<body>
  <nav class="actions">
    <a class="btn" href="index.html" id="btnHome">Main Page</a>
    <a class="btn ghost" href="dashboard.html" id="btnToDashboard">Dashboard</a>
  </nav>

  <main>
    <h1>SmartWerk Invoice Manager</h1>

    <!-- Step 1: Business Info -->
    <section class="step">
      <h2>üè¢ Business Info</h2>
      <label>Business Name <input id="businessName" type="text" placeholder="Business Name" /></label>
      <label>KvK Number <input id="kvk" type="text" placeholder="KvK Number" /></label>
      <label>IBAN <input id="iban" type="text" placeholder="IBAN" /></label>
      <label>Email <input id="email" type="email" placeholder="Email" /></label>
      <label>Business Address <input id="businessAddress" type="text" placeholder="Business Address" /></label>
      <label>Business Phone <input id="businessPhone" type="tel" placeholder="Business Phone" /></label>
      <label for="btw">BTW:</label>
      <input type="text" id="btw" />
    </section>

    <!-- Step 2: Client Info -->
    <section class="step">
      <h2>üë§ Client Info</h2>
      <label>Client Name <input id="clientName" type="text" placeholder="Client Name" /></label>
      <label>Client Email <input id="clientEmail" type="email" placeholder="Client Email" /></label>
      <label>Client Phone <input id="clientPhone" type="tel" placeholder="Client Phone" /></label>
      <label>Client Address <input id="clientAddress" type="text" placeholder="Client Address" /></label>

      <label>Invoice Date <input id="invoiceDate" type="text" class="js-date" placeholder="YYYY-MM-DD" /></label>
      <label>Due Date <input id="dueDate" type="text" class="js-date" placeholder="YYYY-MM-DD" /></label>
      <label>Invoice Number <input id="invoiceNumber" type="text" placeholder="Invoice Number" /></label>

      <label for="status">Status:</label>
      <select id="status">
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
    </section>

    <!-- Step 3: Items -->
    <section class="step">
      <h2>üìù Invoice Items</h2>
      <table>
        <thead>
          <tr>
            <th>Description</th>
            <th>Qty</th>
            <th>Price</th>
            <th>VAT (%)</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button onclick="addItem()">‚ûï Add Item</button>
    </section>

    <!-- Step 4: Summary -->
    <section class="step">
      <h2>üì¶ Summary</h2>
      <label>Note
        <textarea id="note" placeholder="Invoice note (optional)..."></textarea>
      </label>
      <p><strong>Subtotal:</strong> <span id="subtotal">‚Ç¨0.00</span></p>
      <p><strong>Total VAT:</strong> <span id="totalVat">‚Ç¨0.00</span></p>
      <p><strong>Total:</strong> <span id="grandTotal">‚Ç¨0.00</span></p>
    </section>

    <!-- OCR -->
    <section class="step ocr-section">
      <h2>üì∑ Receipt OCR</h2>
      <label>Upload Receipt: <input type="file" id="receiptInput" accept="image/*" /></label>
      <button onclick="processReceipt()">Scan</button>
      <pre id="receiptText"></pre>
    </section>

    <!-- Step 5: Signatures -->
    <section class="step">
      <h2>‚úçÔ∏è Signatures</h2>

      <div>
        <h3>Business Signature:</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas><br/>
        <button onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>

      <div>
        <h3>Client Signature:</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas><br/>
        <button onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Step 6: Actions -->
    <section class="step">
      <h2>‚öôÔ∏è Actions</h2>
      <button onclick="saveInvoice()">üíæ Save Invoice</button>
      <button onclick="renderInvoices()">üìã Show All</button>
    </section>

    <!-- Filters & Search -->
    <section class="step">
      <h2>üìÖ Filters & Search</h2>
      <label for="dateFrom">From:</label>
      <input type="text" id="dateFrom" class="js-date" placeholder="YYYY-MM-DD">
      <label for="dateTo">To:</label>
      <input type="text" id="dateTo" class="js-date" placeholder="YYYY-MM-DD">
      <input type="text" id="searchNumber" placeholder="Search..." oninput="renderInvoices()" />
      <button onclick="renderInvoices()">üîé Filter</button>
      <button onclick="resetFilters()">üîÑ Reset</button>

      <label for="statusFilter">Status:</label>
      <select id="statusFilter" onchange="filterAndRenderInvoices()">
        <option value="all">All</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>

      <label for="sortBy">Sort by:</label>
      <select id="sortBy" onchange="renderInvoices()">
        <option value="dateDesc">Date (Newest First)</option>
        <option value="dateAsc">Date (Oldest First)</option>
        <option value="amountDesc">Amount (High to Low)</option>
        <option value="amountAsc">Amount (Low to High)</option>
      </select>
    </section>

    <!-- Saved Invoices -->
    <section class="step">
      <h2>üìÇ Saved Invoices</h2>
      <div id="savedInvoices"></div>
    </section>

    <section class="step">
      <h2>üìä Income & Expense Overview</h2>
      <canvas id="incomeChart" height="100"></canvas>
    </section>
  </main>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- ===== App logic ===== -->
  <script>
/* ==== Helpers & Calendars ==== */
function initDatepickers(root=document){
  const opts = {
    dateFormat: "Y-m-d",
    allowInput: true,
    onChange: (sel,str,inst)=>{
      const input = inst._input;
      input.value = str || "";
      input.dispatchEvent(new Event('input',{bubbles:true}));
      input.dispatchEvent(new Event('change',{bubbles:true}));
    }
  };
  const pickers = ['#invoiceDate','#dueDate','#dateFrom','#dateTo','.js-date'];
  const nodes = new Set();
  pickers.forEach(sel => document.querySelectorAll(sel).forEach(el=>nodes.add(el)));
  nodes.forEach(el => { if (!el._fp) el._fp = flatpickr(el, opts); });
}
function fpSet(el, dateStr){
  if (!el) return;
  if (el._fp) el._fp.setDate(dateStr || "", true); else el.value = dateStr || "";
}
function suggestDueDate(){
  const inv = document.getElementById('invoiceDate');
  const due = document.getElementById('dueDate');
  if (!inv || !inv.value || !due) return;
  const d = new Date(inv.value); if (String(d)==='Invalid Date') return;
  d.setDate(d.getDate()+14);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  const v = `${y}-${m}-${dd}`;
  fpSet(due, v);
}

/* ==== Invoice number ==== */
function generateNextInvoiceNumber() {
  const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
  const numbers = invoices
    .map(inv => inv.invoiceNumber)
    .filter(num => /^INV-2025-\d{3}$/.test(num || ""))
    .map(num => parseInt(num.split("-")[2]))
    .sort((a, b) => b - a);
  const next = numbers.length ? numbers[0] + 1 : 1;
  const padded = String(next).padStart(3, "0");
  return `INV-2025-${padded}`;
}

/* ==== Items & totals ==== */
function addItem(desc = "", qty = 1, price = 0, vat = 21) {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input class="desc" value="\${desc}" oninput="updateTotals()" placeholder="Description" /></td>
    <td><input class="qty" type="number" value="\${qty}" min="1" onchange="updateTotals()" /></td>
    <td><input class="price" type="number" value="\${price}" step="0.01" onchange="updateTotals()" /></td>
    <td><input class="vat" type="number" value="\${vat}" step="1" onchange="updateTotals()" /></td>
    <td class="item-total">‚Ç¨0.00</td>
    <td><button type="button" onclick="this.closest('tr').remove(); updateTotals();">‚ùå</button></td>
  `.replace(/\$\{([^}]+)\}/g, (_,x)=>eval(x));
  document.getElementById("itemsBody").appendChild(row);
  updateTotals();
}
function updateTotals() {
  let subtotal = 0, totalVAT = 0;
  const rows = document.querySelectorAll("#itemsBody tr");
  if (!rows.length) {
    document.getElementById("subtotal").innerText = "‚Ç¨0.00";
    document.getElementById("totalVat").innerText = "‚Ç¨0.00";
    document.getElementById("grandTotal").innerText = "‚Ç¨0.00";
    return;
  }
  rows.forEach(row => {
    const qty = parseFloat(row.querySelector(".qty")?.value) || 0;
    const price = parseFloat(row.querySelector(".price")?.value) || 0;
    const vat = parseFloat(row.querySelector(".vat")?.value) || 0;
    const itemTotal = qty * price;
    const itemVAT = itemTotal * vat / 100;
    const totalWithVAT = itemTotal + itemVAT;
    subtotal += itemTotal; totalVAT += itemVAT;
    const totalCell = row.querySelector(".item-total");
    if (totalCell) totalCell.innerText = `‚Ç¨${totalWithVAT.toFixed(2)}`;
  });
  document.getElementById("subtotal").innerText = `‚Ç¨${subtotal.toFixed(2)}`;
  document.getElementById("totalVat").innerText = `‚Ç¨${totalVAT.toFixed(2)}`;
  document.getElementById("grandTotal").innerText = `‚Ç¨${(subtotal + totalVAT).toFixed(2)}`;
}

/* ==== Reset & signatures ==== */
function resetFormFields() {
  ["businessName","kvk","iban","btw","email","businessAddress","businessPhone",
   "clientName","clientEmail","clientAddress","clientPhone","note"].forEach(id=>{
    const el = document.getElementById(id); if (el) el.value="";
  });
  document.getElementById("invoiceNumber").value = generateNextInvoiceNumber();
  fpSet(document.getElementById("invoiceDate"), "");
  fpSet(document.getElementById("dueDate"), "");
  document.getElementById("status").value = "Draft";
  document.getElementById("itemsBody").innerHTML="";
  document.getElementById("subtotal").innerText="‚Ç¨0.00";
  document.getElementById("totalVat").innerText="‚Ç¨0.00";
  document.getElementById("grandTotal").innerText="‚Ç¨0.00";
  ["signatureBusiness","signatureClient"].forEach(id=>{
    const canvas = document.getElementById(id); const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);
  });
  signatureBusinessDate = ""; signatureClientDate = "";
  document.getElementById("signatureBusinessDate").innerText = "";
  document.getElementById("signatureClientDate").innerText = "";
}
function clearSignature(canvasId) {
  const canvas = document.getElementById(canvasId); if (!canvas) return;
  const ctx = canvas.getContext("2d"); ctx.clearRect(0,0,canvas.width,canvas.height);
  if (canvasId === "signatureBusiness") {
    signatureBusinessDate = ""; document.getElementById("signatureBusinessDate").innerText = "";
  } else {
    signatureClientDate = ""; document.getElementById("signatureClientDate").innerText = "";
  }
}
document.addEventListener("DOMContentLoaded", () => {
  ["signatureBusiness","signatureClient"].forEach((id) => {
    const canvas = document.getElementById(id); if (!canvas) return;
    const ctx = canvas.getContext("2d"); let isDrawing=false;
    canvas.addEventListener("mousedown", () => { isDrawing = true; ctx.beginPath(); });
    canvas.addEventListener("mouseup", () => {
      isDrawing = false;
      const now = new Date().toLocaleDateString("nl-NL");
      if (id==="signatureBusiness"){ signatureBusinessDate = now; document.getElementById("signatureBusinessDate").innerText = now; }
      else { signatureClientDate = now; document.getElementById("signatureClientDate").innerText = now; }
    });
    canvas.addEventListener("mouseout", () => isDrawing=false);
    canvas.addEventListener("mousemove", (e) => {
      if (!isDrawing) return;
      const r = canvas.getBoundingClientRect(); const x = e.clientX - r.left; const y = e.clientY - r.top;
      ctx.lineWidth=2; ctx.lineCap="round"; ctx.strokeStyle="black"; ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y);
    });
  });

  initDatepickers(document);
  const invNum = document.getElementById("invoiceNumber");
  if (invNum && !invNum.value) invNum.value = generateNextInvoiceNumber();
  addItem();
  updateTotals();
  const invDate = document.getElementById('invoiceDate');
  if (invDate) invDate.addEventListener('change', suggestDueDate);
  renderInvoices();
});

/* ==== OCR ==== */
function processReceipt() {
  const input = document.getElementById("receiptInput");
  const output = document.getElementById("receiptText");
  if (!input || !output) return;
  const file = input.files?.[0];
  if (!file) { output.innerText = "‚ö†Ô∏è No file selected."; return; }
  const reader = new FileReader();
  reader.onload = async function () {
    const imageData = reader.result;
    output.innerText = "‚è≥ Processing OCR...";
    try {
      const { data: { text } } = await Tesseract.recognize(imageData, 'eng');
      output.innerText = `‚úÖ Extracted text:\n${text.trim()}`;
    } catch (err) { console.error("OCR error:", err); output.innerText = "‚ùå Failed to process receipt."; }
  };
  reader.onerror = function () { output.innerText = "‚ùå Error reading the file."; };
  reader.readAsDataURL(file);
}

/* ==== Save / Edit / Delete (local) ==== */
let signatureBusinessDate = "";
let signatureClientDate = "";
function saveInvoice() {
  const invoice = {
    businessName: document.getElementById("businessName")?.value || "",
    kvk: document.getElementById("kvk")?.value || "",
    iban: document.getElementById("iban")?.value || "",
    btw: document.getElementById("btw")?.value || "",
    email: document.getElementById("email")?.value || "",
    businessAddress: document.getElementById("businessAddress")?.value || "",
    businessPhone: document.getElementById("businessPhone")?.value || "",
    clientName: document.getElementById("clientName")?.value || "",
    clientEmail: document.getElementById("clientEmail")?.value || "",
    clientAddress: document.getElementById("clientAddress")?.value || "",
    clientPhone: document.getElementById("clientPhone")?.value || "",
    invoiceNumber: document.getElementById("invoiceNumber")?.value || generateNextInvoiceNumber(),
    invoiceDate: document.getElementById("invoiceDate")?.value || "",
    dueDate: document.getElementById("dueDate")?.value || "",
    note: document.getElementById("note")?.value || "",
    status: document.getElementById("status")?.value || "Draft",
    items: [],
    signatures: {
      business: "",
      client: "",
      businessDate: signatureBusinessDate || "",
      clientDate: signatureClientDate || "",
      date: new Date().toLocaleDateString("nl-NL")
    }
  };
  const rows = document.querySelectorAll("#itemsBody tr");
  rows.forEach(row => {
    invoice.items.push({
      desc: row.querySelector(".desc")?.value || "",
      qty: parseFloat(row.querySelector(".qty")?.value || 0),
      price: parseFloat(row.querySelector(".price")?.value || 0),
      vat: parseFloat(row.querySelector(".vat")?.value || 0)
    });
  });
  try {
    const sb = document.getElementById("signatureBusiness")?.toDataURL() || "";
    const sc = document.getElementById("signatureClient")?.toDataURL() || "";
    invoice.signatures.business = sb; invoice.signatures.client = sc;
  } catch(e) {}

  // –≤–∏–∑–Ω–∞—á–∞—î–º–æ: —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —á–∏ –Ω–æ–≤–∏–π —ñ–Ω–≤–æ–π—Å
  const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
  const currentIndex = localStorage.getItem("currentInvoiceIndex");
  const isEdit = currentIndex !== null && !isNaN(currentIndex) && invoices[+currentIndex];

  // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª—ñ–º—ñ—Ç—É –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –Ω–æ–≤–æ–≥–æ —ñ–Ω–≤–æ–π—Å—É
  if (!isEdit && typeof window.isBlockedByFreeLimit === "function" && window.isBlockedByFreeLimit(false)) {
    alert(`‚ùó You've reached the Free plan limit (3 invoices). Upgrade to PRO for unlimited invoices.`);
    return;
  }

  if (isEdit) {
    invoices[+currentIndex] = invoice;
    localStorage.removeItem("currentInvoiceIndex");
  } else {
    const exists = invoices.some(i => i.invoiceNumber === invoice.invoiceNumber);
    if (exists) { alert("Invoice with this number already exists."); return; }
    invoices.push(invoice);
  }
  localStorage.setItem("invoices", JSON.stringify(invoices));

  // —É —Ö–º–∞—Ä—É ‚Äî –ª–∏—à–µ –Ω–æ–≤—ñ
  if (!isEdit && window.saveInvoiceToCloud) {
    window.saveInvoiceToCloud(invoice).catch(console.error);
  }

  resetFormFields();
  alert("Invoice saved successfully!");
}

/* === –ü–æ—à—É–∫ —ñ–Ω–¥–µ–∫—Å—É –∑–∞ –Ω–æ–º–µ—Ä–æ–º (—â–æ–± –∫–Ω–æ–ø–∫–∏ –≤ —Å–ø–∏—Å–∫—É –±—É–ª–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ –ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤/—Å–æ—Ä—Ç—É) === */
function findInvoiceIndexByNumber(num){
  const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
  return invoices.findIndex(i => (i.invoiceNumber||"") === num);
}

/* === –û–±–≥–æ—Ä—Ç–∫–∏ –¥–ª—è –¥—ñ–π –∑–∞ –Ω–æ–º–µ—Ä–æ–º —ñ–Ω–≤–æ–π—Å—É === */
function editInvoiceByNumber(num){
  const idx = findInvoiceIndexByNumber(num);
  if (idx < 0) { alert("Invoice not found."); return; }
  editInvoice(idx);
}
function deleteInvoiceByNumber(num){
  const idx = findInvoiceIndexByNumber(num);
  if (idx < 0) { alert("Invoice not found."); return; }
  deleteInvoice(idx);
}
function downloadPDFByNumber(num){
  const idx = findInvoiceIndexByNumber(num);
  if (idx < 0) { alert("Invoice not found."); return; }
  downloadPDF(idx);
}
function repeatMonthlyByNumber(num){
  const idx = findInvoiceIndexByNumber(num);
  if (idx < 0) { alert("Invoice not found."); return; }
  repeatMonthly(idx);
}

function editInvoice(index) {
  const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
  const inv = invoices[index];

  /* üîí –î–æ–∑–≤–æ–ª—è—î–º–æ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ª–∏—à–µ Draft (–Ω–µ—á—É—Ç–ª–∏–≤–æ –¥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É) */
  if (!inv || (inv.status && String(inv.status).toLowerCase() !== "draft")) {
    alert("Editing is only allowed in 'Draft' status.");
    return;
  }

  // Step 1 ‚Äì Business info
  const map = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ""; };
  map("businessName",  inv.businessName);
  map("kvk",           inv.kvk);
  map("iban",          inv.iban);
  map("btw",           inv.btw);
  map("email",         inv.email);
  map("businessAddress", inv.businessAddress);
  map("businessPhone", inv.businessPhone);

  // Step 2 ‚Äì Client info
  map("clientName",    inv.clientName);
  map("clientEmail",   inv.clientEmail);
  map("clientAddress", inv.clientAddress);
  map("clientPhone",   inv.clientPhone);
  map("invoiceNumber", inv.invoiceNumber);

  // –î–∞—Ç–∏ —á–µ—Ä–µ–∑ Flatpickr, —â–æ–± UI –≤—ñ–¥–æ–±—Ä–∞–∑–∏–≤—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
  fpSet(document.getElementById("invoiceDate"), inv.invoiceDate || "");
  fpSet(document.getElementById("dueDate"),     inv.dueDate || "");

  map("note", inv.note);
  document.getElementById("status").value = inv.status || "Draft";

  // Step 3 ‚Äì Items
  const tbody = document.getElementById("itemsBody");
  tbody.innerHTML = "";
  (inv.items || []).forEach(item => addItem(item.desc, item.qty, item.price, item.vat));

  // Step 5 ‚Äî Signatures (—è–∫—â–æ –±—É–ª–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ)
  if (inv.signatures) {
    const bImg = new Image();
    bImg.onload = () => {
      const c = document.getElementById("signatureBusiness"); const ctx=c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height); ctx.drawImage(bImg,0,0);
      document.getElementById("signatureBusinessDate").innerText = inv.signatures.businessDate || inv.signatures.date || "";
    };
    bImg.src = inv.signatures.business || "";

    const cImg = new Image();
    cImg.onload = () => {
      const c = document.getElementById("signatureClient"); const ctx=c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height); ctx.drawImage(cImg,0,0);
      document.getElementById("signatureClientDate").innerText = inv.signatures.clientDate || inv.signatures.date || "";
    };
    cImg.src = inv.signatures.client || "";
  } else {
    // —è–∫—â–æ –ø—ñ–¥–ø–∏—Å—ñ–≤ –Ω–µ –±—É–ª–æ ‚Äî –æ—á–∏—â–∞—î–º–æ –∫–∞–Ω–≤–∞—Å–∏
    ["signatureBusiness","signatureClient"].forEach(id=>{
      const canvas = document.getElementById(id); const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
    });
    document.getElementById("signatureBusinessDate").innerText = "";
    document.getElementById("signatureClientDate").innerText = "";
  }

  updateTotals();

  // –ü–æ–∑–Ω–∞—á–∞—î–º–æ, —â–æ —Ä–µ–¥–∞–≥—É—î–º–æ —Å–∞–º–µ —Ü–µ–π —ñ–Ω–¥–µ–∫—Å (—â–æ–± saveInvoice –Ω–µ —Ä–∞—Ö—É–≤–∞–≤ —è–∫ –Ω–æ–≤–∏–π)
  localStorage.setItem("currentInvoiceIndex", index);

  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ —Ñ–æ—Ä–º–∏, —â–æ–± –±—É–ª–æ –≤–∏–¥–Ω–æ
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function deleteInvoice(index) {
  if (!confirm("Are you sure you want to delete this invoice?")) return;
  const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
  if (index>=0 && index<invoices.length) {
    invoices.splice(index,1);
    localStorage.setItem("invoices", JSON.stringify(invoices));
    localStorage.removeItem("currentInvoiceIndex");
    renderInvoices();
    alert("Invoice deleted.");
  }
}
function updateStatus(index, newStatus) {
  const valid = ["Draft","Sent","Paid"];
  if (!valid.includes(newStatus)) { alert("Invalid status"); return; }
  const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
  if (invoices[index]) {
    invoices[index].status = newStatus;
    localStorage.setItem("invoices", JSON.stringify(invoices));
    if (localStorage.getItem("currentInvoiceIndex") == index) localStorage.removeItem("currentInvoiceIndex");
    renderInvoices();
  }
}

/* ==== Listing / Charts (with status badges) ==== */
function getInvoiceTotal(inv) {
  if (!inv.items) return 0;
  return inv.items.reduce((sum, item) => {
    const qty = parseFloat(item.qty || 0);
    const price = parseFloat(item.price || 0);
    const vat = parseFloat(item.vat || 0);
    return sum + qty * price * (1 + vat / 100);
  }, 0);
}
let incomeChartInstance = null;
function renderChart(invoices) {
  const monthlyTotals = {};
  invoices.forEach(inv => {
    if (!inv.invoiceDate) return;
    const month = new Date(inv.invoiceDate).toLocaleString("en-US", { month: "short", year: "numeric" });
    const total = getInvoiceTotal(inv);
    monthlyTotals[month] = (monthlyTotals[month] || 0) + total;
  });
  const labels = Object.keys(monthlyTotals);
  const data = Object.values(monthlyTotals);
  const ctx = document.getElementById("incomeChart").getContext("2d");
  if (incomeChartInstance) incomeChartInstance.destroy();
  incomeChartInstance = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label: "Monthly Income (‚Ç¨)", data, backgroundColor: "rgba(75, 192, 192, 0.6)" }] },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c)=>`‚Ç¨${c.parsed.y.toFixed(2)}` } } },
      scales: { y: { beginAtZero: true, ticks: { callback: v => `‚Ç¨${v}` } } }
    }
  });
}
function statusBadgeHTML(statusRaw){
  const s = (statusRaw || "Draft").toLowerCase();
  const cls = s === "paid" ? "paid" : s === "sent" ? "sent" : "draft";
  const txt = s === "paid" ? "Paid" : s === "sent" ? "Sent" : "Draft";
  return `<span class="status-badge ${cls}">${txt}</span>`;
}
function renderInvoices() {
  const savedContainer = document.getElementById("savedInvoices"); if (!savedContainer) return;
  savedContainer.innerHTML = "";
  let invoices = JSON.parse(localStorage.getItem("invoices") || "[]");

  const status = document.getElementById("statusFilter")?.value || "all";
  const search = (document.getElementById("searchNumber")?.value || "").toLowerCase();
  const fromDate = document.getElementById("dateFrom")?.value || "";
  const toDate   = document.getElementById("dateTo")?.value || "";
  const sortBy   = document.getElementById("sortBy")?.value || "dateDesc";

  invoices = invoices.filter(inv => {
    const matchStatus = status === "all" || (inv.status || "").toLowerCase() === status.toLowerCase();
    const matchSearch = (inv.invoiceNumber || "").toLowerCase().includes(search) || (inv.clientName || "").toLowerCase().includes(search);
    const invDate = new Date(inv.invoiceDate || "1900-01-01");
    const matchFrom = !fromDate || new Date(fromDate) <= invDate;
    const matchTo   = !toDate   || new Date(toDate)   >= invDate;
    return matchStatus && matchSearch && matchFrom && matchTo;
  });

  invoices.sort((a,b)=>{
    const dateA = new Date(a.invoiceDate || "1900-01-01");
    const dateB = new Date(b.invoiceDate || "1900-01-01");
    const totA = getInvoiceTotal(a);
    const totB = getInvoiceTotal(b);
    switch (sortBy) {
      case "dateAsc": return dateA - dateB;
      case "dateDesc": return dateB - dateA;
      case "amountAsc": return totA - totB;
      case "amountDesc": return totB - totA;
      default: return 0;
    }
  });

  invoices.forEach((inv) => {
    const div = document.createElement("div");
    div.className = "invoice-block";
    const badge = statusBadgeHTML(inv.status);
    const num = (inv.invoiceNumber || "INV-2025-XXX");
    div.innerHTML = `
      <strong>${inv.businessName || "-"}</strong> ‚Äî ${num} ${badge}<br>
      <em>Date: ${inv.invoiceDate || "N/A"}</em><br>
      <em>Total: ‚Ç¨${getInvoiceTotal(inv).toFixed(2)}</em><br>
      <button onclick="downloadPDFByNumber('${num}')">üìÑ PDF</button>
      <button onclick="editInvoiceByNumber('${num}')">‚úèÔ∏è Edit</button>
      <button onclick="deleteInvoiceByNumber('${num}')">üóëÔ∏è Delete</button>
      <button onclick="repeatMonthlyByNumber('${num}')">üìÖ Repeat Monthly</button>
    `;
    savedContainer.appendChild(div);
  });

  renderChart(invoices);
}
function filterAndRenderInvoices(){ renderInvoices(); }
function resetFilters() {
  ["searchNumber"].forEach(id => { const el = document.getElementById(id); if (el) el.value=""; });
  ["statusFilter"].forEach(id => { const el = document.getElementById(id); if (el) el.value="all"; });
  const fd = document.getElementById("dateFrom"); if (fd) fd.value="";
  const td = document.getElementById("dateTo");   if (td) td.value="";
  renderInvoices();
}

/* ==== PDF ==== */
async function downloadPDF(index) {
  const { jsPDF } = window.jspdf; const doc = new jsPDF();
  const invoices = JSON.parse(localStorage.getItem("invoices")) || []; const inv = invoices[index]; if (!inv) return;
  const cleanText = (t) => (t || "").toString().replace(/[^\x00-\x7F]/g, "");
  const invoiceNumber = cleanText(inv.invoiceNumber || `INV-2025-${(index + 1).toString().padStart(3, "0")}`);
  doc.setFontSize(18); doc.text("INVOICE", 105, 20, null, null, "center");
  doc.setFontSize(12);
  doc.text("From:", 20, 35);
  doc.text(cleanText(inv.businessName), 20, 41);
  doc.text(`KvK: ${cleanText(inv.kvk)}`, 20, 47);
  doc.text(`IBAN: ${cleanText(inv.iban)}`, 20, 53);
  doc.text(`Email: ${cleanText(inv.email)}`, 20, 59);
  if (inv.btw) doc.text(`BTW: ${cleanText(inv.btw)}`, 20, 65);
  doc.text(`Address: ${cleanText(inv.businessAddress)}`, 20, 71);
  doc.text(`Phone: ${cleanText(inv.businessPhone)}`, 20, 77);
  doc.text("To:", 140, 35);
  doc.text(cleanText(inv.clientName), 140, 41);
  if (inv.clientEmail) doc.text(cleanText(inv.clientEmail), 140, 47);
  doc.text(`Address: ${cleanText(inv.clientAddress)}`, 140, 53);
  doc.text(`Phone: ${cleanText(inv.clientPhone)}`, 140, 59);
  let nextY = 90;
  doc.autoTable({ startY: nextY, head: [['Invoice Number','Date Issued','Due Date','Status']],
    body:[[ invoiceNumber, cleanText(inv.invoiceDate||""), cleanText(inv.dueDate||""), cleanText(inv.status||'Draft') ]],
    styles:{halign:'left'}, headStyles:{ fillColor:[240,240,240] } });
  nextY = doc.lastAutoTable.finalY + 10;
  const rows = (inv.items||[]).map(item=>[
    cleanText(item.desc), item.qty, `‚Ç¨${parseFloat(item.price).toFixed(2)}`, `${item.vat}%`,
    `‚Ç¨${(item.qty*item.price*(1+item.vat/100)).toFixed(2)}`
  ]);
  doc.autoTable({
    startY: nextY, head: [['Description','Qty','Unit Price','VAT','Total']], body: rows,
    styles:{halign:'left'}, columnStyles:{0:{cellWidth:60},1:{halign:'right'},2:{halign:'right'},3:{halign:'right'},4:{halign:'right'}},
    headStyles:{ fillColor:[240,240,240] }
  });
  nextY = doc.lastAutoTable.finalY + 10;
  const subtotal = (inv.items||[]).reduce((s,i)=>s+i.qty*i.price,0);
  const vatTotal = (inv.items||[]).reduce((s,i)=>s+i.qty*i.price*(i.vat/100),0);
  const total = subtotal + vatTotal;
  doc.autoTable({
    startY: nextY, body: [['Subtotal:',`‚Ç¨${subtotal.toFixed(2)}`],['VAT:',`‚Ç¨${vatTotal.toFixed(2)}`],['Total Due:',`‚Ç¨${total.toFixed(2)}`]],
    theme:'plain', styles:{fontStyle:'bold'}, columnStyles:{0:{halign:'right'},1:{halign:'right'}}
  });
  nextY = doc.lastAutoTable.finalY + 10;
  if ((inv.note||"").trim()){ doc.setFontSize(10); doc.text("Note:", 20, nextY); doc.text(cleanText(inv.note), 20, nextY+6); nextY += 20; }
  doc.setFontSize(12); doc.text("Business Signature:", 20, nextY); doc.text("Client Signature:", 130, nextY);
  doc.setLineWidth(0.1); doc.line(20,nextY+10,70,nextY+10); doc.line(130,nextY+10,180,nextY+10); nextY += 20;
  if (inv.signatures?.business) doc.addImage(inv.signatures.business,"PNG",20,nextY,60,30);
  if (inv.signatures?.client)   doc.addImage(inv.signatures.client,"PNG",130,nextY,60,30);
  nextY += 40;
  if (inv.signatures?.date){ doc.setFontSize(10); doc.text(`Signed on: ${cleanText(inv.signatures.date)}`, 20, nextY); }
  doc.save(`${invoiceNumber}.pdf`);
}
function repeatMonthly(index) {
  // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª—ñ–º—ñ—Ç—É (—Ü–µ –∑–∞–≤–∂–¥–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —ñ–Ω–≤–æ–π—Å—É)
  if (typeof window.isBlockedByFreeLimit === "function" && window.isBlockedByFreeLimit(false)) {
    alert(`‚ùó You've reached the Free plan limit (3 invoices). Upgrade to PRO for unlimited invoices.`);
    return;
  }

  const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
  const original = invoices[index]; if (!original) return;

  const newInvoice = JSON.parse(JSON.stringify(original));

  const today = new Date();
  const nextMonth = new Date(today.setMonth(today.getMonth()+1));
  const formattedDate = nextMonth.toISOString().split("T")[0];

  newInvoice.invoiceNumber = generateNextInvoiceNumber();
  newInvoice.invoiceDate = formattedDate;
  newInvoice.dueDate = "";
  newInvoice.status = "Draft";
  newInvoice.signatures = { business:"", client:"", date:new Date().toLocaleDateString("nl-NL") };

  invoices.push(newInvoice);
  localStorage.setItem("invoices", JSON.stringify(invoices));

  // —É —Ö–º–∞—Ä—É ‚Äî —è–∫ –Ω–æ–≤–∏–π (—ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞)
  if (window.saveInvoiceToCloud) {
    window.saveInvoiceToCloud(newInvoice).catch(console.error);
  }

  renderInvoices();
  alert("‚úÖ Monthly invoice created!");
}
  </script>

  <!-- ===== Firebase module: profile autofill + cloud save + increment + limit check ===== -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc, collection, addDoc, increment
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –¥–ª—è –ª—ñ–º—ñ—Ç—É */
    const FREE_LIMIT = 3;
    window.SW_STATE = { isPro:false, invoiceCount:0 };

    /* –Ñ–¥–∏–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª—ñ–º—ñ—Ç—É (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —ñ–Ω–≤–æ–π—Å—É) */
    window.isBlockedByFreeLimit = function isBlockedByFreeLimit(isEdit = false){
      const { isPro, invoiceCount } = window.SW_STATE || {};
      if (isPro) return false;
      return !isEdit && Number(invoiceCount || 0) >= FREE_LIMIT;
    };

    // Cloud save –¥–ª—è –ª—ñ–º—ñ—Ç—É ‚Äî –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –ª–∏—à–µ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–æ–≤–æ–≥–æ
    window.saveInvoiceToCloud = async function(invoice){
      const user = auth.currentUser;
      if (!user) return;
      await addDoc(collection(db, 'users', user.uid, 'invoices'), invoice);
      await updateDoc(doc(db,'users',user.uid), { invoiceCount: increment(1) }).catch(()=>{});
      // –ª–æ–∫–∞–ª—å–Ω–æ –æ–Ω–æ–≤–∏–º–æ —Å—Ç–∞–Ω (—â–æ–± –æ–¥—Ä–∞–∑—É –ø—Ä–∞—Ü—é–≤–∞–ª–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)
      window.SW_STATE.invoiceCount = (window.SW_STATE.invoiceCount || 0) + 1;
    };

    // Autofill from profile on #autofill=1
    const wantAutofill = location.hash.includes("autofill=1");
    function setIfAllowed(input, value) {
      if (!input) return;
      const isEmpty = !input.value || String(input.value).trim() === "";
      if (wantAutofill || isEmpty) {
        input.value = value ?? "";
        input.dispatchEvent(new Event("input", { bubbles: true }));
        input.dispatchEvent(new Event("change", { bubbles: true }));
      }
    }
    function pick(...ids) { for (const id of ids){ const el = document.getElementById(id); if (el) return el; } return null; }
    function prefillInvoiceForm(profile, userEmailFromAuth) {
      const elBusinessName   = pick("businessName","companyName","sellerName");
      const elBusinessEmail  = pick("businessEmail","email","sellerEmail");
      const elBusinessPhone  = pick("businessPhone","phone","sellerPhone");
      const elBusinessAddr   = pick("businessAddress","address","sellerAddress","addrLine");
      const elKvK            = pick("kvk","kvkNumber","sellerKvK");
      const elIBAN           = pick("iban","bankIban","sellerIban");
      const elVAT            = pick("vatNumber","vat","sellerVat");
      const fullName = profile.fullName || "";
      const address  = profile.address  || "";
      const phone    = profile.phone    || "";
      const kvk      = profile.kvk      || "";
      const iban     = profile.iban     || "";
      const vatNum   = profile.vatNumber || profile.vat || "";
      const email    = profile.email || userEmailFromAuth || "";
      setIfAllowed(elBusinessName, fullName);
      setIfAllowed(elBusinessEmail, email);
      setIfAllowed(elBusinessPhone, phone);
      setIfAllowed(elBusinessAddr, address);
      setIfAllowed(elKvK, kvk);
      setIfAllowed(elIBAN, iban);
      setIfAllowed(elVAT, vatNum);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return; // –≥–æ—Å—Ç—å–æ–≤–∏–π —Ä–µ–∂–∏–º: –±–µ–∑ –ª—ñ–º—ñ—Ç—ñ–≤
      try {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        const data = snap.exists() ? snap.data() : {};
        if (!data.email && user.email) data.email = user.email;

        // –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –¥–ª—è –ª—ñ–º—ñ—Ç—É
        window.SW_STATE.isPro        = !!data.pro;
        window.SW_STATE.invoiceCount = Number.isFinite(data.invoiceCount) ? data.invoiceCount : 0;

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => prefillInvoiceForm(data, user.email));
        } else {
          prefillInvoiceForm(data, user.email);
        }
      } catch (err) { console.error("Autofill profile ‚Üí invoices error:", err); }
    });
  </script>
</body>
</html>
