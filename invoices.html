<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartWerk Invoice Manager</title>

  <link rel="stylesheet" href="style-invoices.css?v=5" />

  <!-- Flatpickr (–∫–∞–ª–µ–Ω–¥–∞—Ä) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- OCR + PDF (–º–æ–∂–µ—à –ª–∏—à–∏—Ç–∏, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É—î—à—Å—è) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <style>
    .signature { border:1px solid #444; background:#fff; cursor:crosshair; display:block }
    .step { margin:20px 0; padding:16px; border:1px solid #2a2a2a; border-radius:12px }
    table { width:100%; border-collapse: collapse }
    th, td { padding:8px; border-bottom:1px solid #2a2a2a }
    .btn { display:inline-block; padding:8px 12px; border:1px solid #3b82f6; color:#fff; background:#2563eb; border-radius:8px; text-decoration:none }
    .btn:hover { filter:brightness(1.05) }
  </style>
</head>
<body>
  <div class="topbar">
    <nav>
      <a href="index.html" class="btn">‚Üê Main Page</a>
      <a href="dashboard.html" class="btn">‚Üê Dashboard</a>
      <a href="invoices-list.html" class="btn">üìã Invoices List</a>
    </nav>
  </div>

  <main>
    <h1>SmartWerk Invoice Manager</h1>

    <!-- Business Info -->
    <section class="step">
      <h2>üè¢ Business Info</h2>
      <input id="businessName" placeholder="Business Name" />
      <input id="kvk" placeholder="KvK Number" />
      <input id="iban" placeholder="IBAN" />
      <input id="btw" placeholder="BTW Number" />
      <input id="businessEmail" type="email" placeholder="Business Email" />
      <input id="businessPhone" type="tel" placeholder="Business Phone" />
      <input id="businessAddress" placeholder="Business Address" />
    </section>

    <!-- Client Info -->
    <section class="step">
      <h2>üë§ Client Info</h2>
      <input id="clientName" placeholder="Client Name" />
      <input id="clientEmail" type="email" placeholder="Client Email" />
      <input id="clientPhone" type="tel" placeholder="Client Phone" />
      <input id="clientAddress" placeholder="Client Address" />

      <input id="invoiceDate" class="js-date" placeholder="Invoice Date (YYYY-MM-DD)" />
      <input id="dueDate" class="js-date" placeholder="Due Date (YYYY-MM-DD)" />
      <input id="invoiceNumber" placeholder="Invoice Number (auto)" />

      <label>Status:
        <select id="status">
          <option>Draft</option>
          <option>Sent</option>
          <option>Paid</option>
        </select>
      </label>
    </section>

    <!-- Items -->
    <section class="step">
      <h2>üìù Items</h2>
      <table>
        <thead>
          <tr>
            <th>Description</th><th>Qty</th><th>Price</th><th>VAT %</th><th>Total</th><th></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button class="btn" onclick="addItem()">‚ûï Add Item</button>
    </section>

    <!-- Summary -->
    <section class="step">
      <h2>üì¶ Summary</h2>
      <textarea id="note" placeholder="Notes..."></textarea>
      <p><strong>Subtotal:</strong> <span id="subtotal">‚Ç¨0.00</span></p>
      <p><strong>Total VAT:</strong> <span id="totalVat">‚Ç¨0.00</span></p>
      <p><strong>Total:</strong> <span id="grandTotal">‚Ç¨0.00</span></p>
    </section>

    <!-- OCR -->
    <section class="step">
      <h2>üì∑ Receipt OCR</h2>
      <input type="file" id="receiptInput" accept="image/*" />
      <button class="btn" onclick="processReceipt()">Scan</button>
      <pre id="receiptText"></pre>
    </section>

    <!-- Signatures -->
    <section class="step">
      <h2>‚úçÔ∏è Signatures</h2>
      <div>
        <h3>Business Signature</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button class="btn" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div style="margin-top:12px">
        <h3>Client Signature</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button class="btn" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step">
      <h2>‚öôÔ∏è Actions</h2>
      <button class="btn" onclick="saveInvoice()">üíæ Save Invoice</button>
      <a href="invoices-list.html" class="btn">üìã Open Invoices List</a>
    </section>
  </main>

  <script type="module">
    /* ============== Firebase ============== */
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ============== Shortcuts ============== */
    const $ = (id) => document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0,10);

    /* ============== Date pickers ============== */
    function initDatepickers(){
      if (typeof flatpickr === "function") {
        const fmt = { dateFormat:"Y-m-d", allowInput:true };
        flatpickr("#invoiceDate", {
          ...fmt,
          onChange() { suggestDueDate(); }
        });
        flatpickr("#dueDate", fmt);
      }
      if (!$("invoiceDate").value) $("invoiceDate").value = todayISO();
      suggestDueDate();
    }
    function suggestDueDate(){
      const inv = $("invoiceDate"); const due = $("dueDate");
      if (!inv || !due || !inv.value) return;
      const d = new Date(inv.value);
      if (isNaN(d)) return;
      d.setDate(d.getDate()+14);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      due.value = `${y}-${m}-${dd}`;
    }

    /* ============== Items & totals ============== */
    function addItem(desc="", qty=1, price=0, vat=21){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="desc" placeholder="Description" value="${desc}"></td>
        <td><input type="number" class="qty" min="0" step="1" value="${qty}"></td>
        <td><input type="number" class="price" min="0" step="0.01" value="${price}"></td>
        <td>
          <select class="vat">
            <option value="0">0</option>
            <option value="9">9</option>
            <option value="21" selected>21</option>
          </select>
        </td>
        <td class="item-total">‚Ç¨0.00</td>
        <td><button type="button" onclick="this.closest('tr').remove(); updateTotals()">‚ùå</button></td>
      `;
      $("itemsBody").appendChild(tr);
      // –≤—ñ—à–∞—î–º–æ –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫
      tr.querySelectorAll("input, select").forEach(el=>{
        el.addEventListener("input", updateTotals);
        el.addEventListener("change", updateTotals);
      });
      updateTotals();
    }
    function updateTotals(){
      let sub=0, vatSum=0;
      $("itemsBody").querySelectorAll("tr").forEach(tr=>{
        const qty = parseFloat(tr.querySelector(".qty")?.value) || 0;
        const price = parseFloat(tr.querySelector(".price")?.value) || 0;
        const vat = parseFloat(tr.querySelector(".vat")?.value) || 0;
        const t = qty * price;
        const tVat = t * vat / 100;
        sub += t; vatSum += tVat;
        tr.querySelector(".item-total").innerText = "‚Ç¨" + (t + tVat).toFixed(2);
      });
      $("subtotal").innerText = "‚Ç¨" + sub.toFixed(2);
      $("totalVat").innerText = "‚Ç¨" + vatSum.toFixed(2);
      $("grandTotal").innerText = "‚Ç¨" + (sub + vatSum).toFixed(2);
    }

    /* ============== Signatures ============== */
    function initSignature(canvasId, dateSpanId){
      const canvas = $(canvasId);
      const dateSpan = $(dateSpanId);
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      let drawing = false;

      function start(e){
        drawing = true;
        ctx.beginPath();
        const pos = getPos(e);
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault();
      }
      function move(e){
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault();
      }
      function end(){
        if (!drawing) return;
        drawing = false;
        dateSpan.textContent = new Date().toLocaleDateString("nl-NL");
      }
      function getPos(e){
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      }

      // mouse
      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", move);
      window.addEventListener("mouseup", end);
      // touch
      canvas.addEventListener("touchstart", start, {passive:false});
      canvas.addEventListener("touchmove", move, {passive:false});
      window.addEventListener("touchend", end);
    }
    function clearSignature(id){
      const canvas = $(id);
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if (id === "signatureBusiness") $("signatureBusinessDate").textContent = "";
      if (id === "signatureClient") $("signatureClientDate").textContent = "";
    }

    /* ============== OCR ============== */
    function processReceipt(){
      const file = $("receiptInput").files?.[0];
      if (!file) { $("receiptText").textContent = "‚ö†Ô∏è No file selected"; return; }
      $("receiptText").textContent = "‚è≥ Processing...";
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const { data: { text } } = await Tesseract.recognize(reader.result, 'eng');
          $("receiptText").textContent = text.trim();
        } catch (e) {
          $("receiptText").textContent = "‚ùå OCR failed";
        }
      };
      reader.readAsDataURL(file);
    }

    /* ============== Invoice number (Firestore) ============== */
    async function getNextInvoiceNumber(uid){
      // —á–∏—Ç–∞—î–º–æ –≤—Å—ñ —ñ–Ω–≤–æ–π—Å–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–∑–∞ –±–∞–∂–∞–Ω–Ω—è–º ‚Äî –æ–±–º–µ–∂)
      const snap = await getDocs(collection(db, "users", uid, "invoices"));
      let maxSeq = 0;
      const year = new Date().getFullYear().toString();
      snap.forEach(doc=>{
        const num = (doc.data().invoiceNumber || "").toString();
        const m = /^INV-(\d{4})-(\d+)$/.exec(num);
        if (!m) return;
        if (m[1] !== year) return;
        const seq = parseInt(m[2], 10);
        if (seq > maxSeq) maxSeq = seq;
      });
      const next = (maxSeq + 1).toString().padStart(3, "0");
      return `INV-${year}-${next}`;
    }

    /* ============== Save to Firestore ============== */
    async function saveInvoice(){
      if (!auth.currentUser) return alert("Not logged in");
      updateTotals(); // –Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —â–æ—Å—å –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é

      const invoice = {
        userId: auth.currentUser.uid,
        businessName: $("businessName").value,
        kvk: $("kvk").value,
        iban: $("iban").value,
        btw: $("btw").value,
        businessEmail: $("businessEmail").value,
        businessPhone: $("businessPhone").value,
        businessAddress: $("businessAddress").value,
        clientName: $("clientName").value,
        clientEmail: $("clientEmail").value,
        clientPhone: $("clientPhone").value,
        clientAddress: $("clientAddress").value,
        invoiceNumber: $("invoiceNumber").value || ("INV-" + Date.now()),
        invoiceDate: $("invoiceDate").value,
        dueDate: $("dueDate").value,
        note: $("note").value,
        status: $("status").value,
        items: Array.from($("itemsBody").querySelectorAll("tr")).map(tr => ({
          desc: tr.querySelector(".desc").value,
          qty: +tr.querySelector(".qty").value || 0,
          price: +tr.querySelector(".price").value || 0,
          vat: +tr.querySelector(".vat").value || 0
        })),
        subtotal: $("subtotal").innerText,
        totalVat: $("totalVat").innerText,
        grandTotal: $("grandTotal").innerText,
        signatures: {
          business: $("signatureBusiness").toDataURL(),
          client: $("signatureClient").toDataURL(),
          businessDate: $("signatureBusinessDate").textContent || "",
          clientDate: $("signatureClientDate").textContent || ""
        },
        createdAt: new Date().toISOString()
      };

      await addDoc(collection(db, "users", auth.currentUser.uid, "invoices"), invoice);
      alert("‚úÖ Invoice saved!");
    }

    /* ============== Auth + init ============== */
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "login.html"; return; }

      // –∫–∞–ª–µ–Ω–¥–∞—Ä—ñ + –¥–µ—Ñ–æ–ª—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
      initDatepickers();

      // –∞–≤—Ç–æ-–Ω–æ–º–µ—Ä —ñ–Ω–≤–æ–π—Å—É –∑ Firestore
      try {
        $("invoiceNumber").value = await getNextInvoiceNumber(user.uid);
      } catch { /* fallback */ if (!$("invoiceNumber").value) $("invoiceNumber").value = "INV-" + Date.now(); }

      // –º—ñ–Ω—ñ–º—É–º 1 —Ä—è–¥–æ–∫
      if (!$("itemsBody").querySelector("tr")) addItem();

      // –ø—ñ–¥–ø–∏—Å–∏ (mouse + touch)
      initSignature("signatureBusiness", "signatureBusinessDate");
      initSignature("signatureClient", "signatureClientDate");
    });

    /* ============== –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –¥–æ window –¥–ª—è HTML-–æ–Ω–∫–ª—ñ–∫—ñ–≤ ============== */
    window.addItem = addItem;
    window.updateTotals = updateTotals;
    window.clearSignature = clearSignature;
    window.processReceipt = processReceipt;
    window.saveInvoice = saveInvoice;
  </script>
</body>
</html>
