<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartWerk Invoice Manager</title>

  <link rel="stylesheet" href="style-invoices.css?v=5" />

  <!-- Flatpickr (ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- OCR + PDF (Ğ¼Ğ¾Ğ¶ĞµÑˆ Ğ»Ğ¸ÑˆĞ¸Ñ‚Ğ¸, ÑĞºÑ‰Ğ¾ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒÑ”ÑˆÑÑ) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <style>
    .signature { border:1px solid #444; background:#fff; cursor:crosshair; display:block }
    .step { margin:20px 0; padding:16px; border:1px solid #2a2a2a; border-radius:12px }
    table { width:100%; border-collapse: collapse }
    th, td { padding:8px; border-bottom:1px solid #2a2a2a }
    .btn { display:inline-block; padding:8px 12px; border:1px solid #3b82f6; color:#fff; background:#2563eb; border-radius:8px; text-decoration:none }
    .btn:hover { filter:brightness(1.05) }
  </style>
</head>
<body>
  <div class="topbar">
    <nav>
      <a href="index.html" class="btn">â† Main Page</a>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="invoices-list.html" class="btn">ğŸ“‹ Invoices List</a>
    </nav>
  </div>

  <main>
    <h1>SmartWerk Invoice Manager</h1>

    <!-- Business Info -->
    <section class="step">
      <h2>ğŸ¢ Business Info</h2>
      <input id="businessName" placeholder="Business Name" />
      <input id="kvk" placeholder="KvK Number" />
      <input id="iban" placeholder="IBAN" />
      <input id="btw" placeholder="BTW Number" />
      <input id="businessEmail" type="email" placeholder="Business Email" />
      <input id="businessPhone" type="tel" placeholder="Business Phone" />
      <input id="businessAddress" placeholder="Business Address" />
    </section>

    <!-- Client Info -->
    <section class="step">
      <h2>ğŸ‘¤ Client Info</h2>
      <input id="clientName" placeholder="Client Name" />
      <input id="clientEmail" type="email" placeholder="Client Email" />
      <input id="clientPhone" type="tel" placeholder="Client Phone" />
      <input id="clientAddress" placeholder="Client Address" />

      <input id="invoiceDate" class="js-date" placeholder="Invoice Date (YYYY-MM-DD)" />
      <input id="dueDate" class="js-date" placeholder="Due Date (YYYY-MM-DD)" />
      <input id="invoiceNumber" placeholder="Invoice Number (auto)" />

      <label>Status:
        <select id="status">
          <option>Draft</option>
          <option>Sent</option>
          <option>Paid</option>
        </select>
      </label>
    </section>

    <!-- Items -->
    <section class="step">
      <h2>ğŸ“ Items</h2>
      <table>
        <thead>
          <tr>
            <th>Description</th><th>Qty</th><th>Price</th><th>VAT %</th><th>Total</th><th></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button class="btn" onclick="addItem()">â• Add Item</button>
    </section>

    <!-- Summary -->
    <section class="step">
      <h2>ğŸ“¦ Summary</h2>
      <textarea id="note" placeholder="Notes..."></textarea>
      <p><strong>Subtotal:</strong> <span id="subtotal">â‚¬0.00</span></p>
      <p><strong>Total VAT:</strong> <span id="totalVat">â‚¬0.00</span></p>
      <p><strong>Total:</strong> <span id="grandTotal">â‚¬0.00</span></p>
    </section>

    <!-- OCR -->
    <section class="step">
      <h2>ğŸ“· Receipt OCR</h2>
      <input type="file" id="receiptInput" accept="image/*" />
      <button class="btn" onclick="processReceipt()">Scan</button>
      <pre id="receiptText"></pre>
    </section>

    <!-- Signatures -->
    <section class="step">
      <h2>âœï¸ Signatures</h2>
      <div>
        <h3>Business Signature</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button class="btn" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div style="margin-top:12px">
        <h3>Client Signature</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button class="btn" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step">
      <h2>âš™ï¸ Actions</h2>
      <button class="btn" onclick="saveInvoice()">ğŸ’¾ Save Invoice</button>
      <a href="invoices-list.html" class="btn">ğŸ“‹ Open Invoices List</a>
    </section>
  </main>

 <script type="module">
  // âœ… Firestore sync â€” Ğ½Ğµ Ğ·Ğ¼Ñ–Ğ½ÑÑ” Ñ‚Ğ²Ğ¾Ñ Ñ–ÑĞ½ÑƒÑÑ‡Ñƒ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ, Ğ»Ğ¸ÑˆĞµ Ğ´Ğ¾Ğ¿Ğ¸ÑÑƒÑ” Ñƒ Ñ…Ğ¼Ğ°Ñ€Ñƒ
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
    authDomain: "smartwerk8520.firebaseapp.com",
    projectId: "smartwerk8520",
    appId: "1:607670981972:web:c07103c981c86860d724c1",
  };

  const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  // ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ñ–Ğ·ÑƒÑ” Ñ–Ğ½Ğ²Ğ¾Ğ¹Ñ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºÑƒ (Ğ¼Ñ–Ğ½Ñ–Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ½ĞµĞ¾Ğ±Ñ…Ñ–Ğ´Ğ½Ñ– Ğ¿Ğ¾Ğ»Ñ + Ğ²ÑĞµ Ñ–Ğ½ÑˆĞµ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµÑ‚ÑŒÑÑ ÑĞº Ñ”)
  function normalizeForFirestore(inv) {
    const parseMoney = v => Number(String(v).toString().replace("â‚¬","").trim()) || 0;

    // Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ¹Ğ´Ğµ Ğ· DOMâ€”Ğ´Ğ¾Ğ±ĞµÑ€ĞµĞ¼Ğ¾ Ğ¿Ñ–Ğ´ÑÑƒĞ¼ĞºĞ¸ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ:
    const subtotalEl = document.getElementById("subtotal");
    const totalVatEl = document.getElementById("totalVat");
    const grandEl    = document.getElementById("grandTotal");

    const subtotal = inv.subtotal ?? (subtotalEl ? parseMoney(subtotalEl.innerText) : 0);
    const vat      = inv.vat      ?? (totalVatEl ? parseMoney(totalVatEl.innerText) : 0);
    const total    = inv.total    ?? (grandEl ? parseMoney(grandEl.innerText) : 0);

    return {
      ...inv,
      // ĞšĞ»ÑÑ‡Ğ¾Ğ²Ñ– Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºÑƒ:
      invoiceNumber: String(inv.invoiceNumber || "").trim(),
      clientName:    String(inv.clientName || "").trim(),
      invoiceDate:   String(inv.invoiceDate || "").trim(), // Ğ¾Ñ‡Ñ–ĞºÑƒÑ”Ñ‚ÑŒÑÑ YYYY-MM-DD
      status:        String(inv.status || "Draft"),
      subtotal, vat, total,
      userId: auth.currentUser?.uid || inv.userId || "",
      createdAt: inv.createdAt || new Date().toISOString()
    };
  }

  // ĞĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ğ²Ğ¸ĞºĞ»Ğ¸Ğº, Ñ‰Ğ¾Ğ± Ñ‚Ğ¸ Ğ¼Ñ–Ğ³ Ğ´ĞµÑ€Ğ½ÑƒÑ‚Ğ¸ Ğ¹Ğ¾Ğ³Ğ¾ Ğ·Ñ– ÑĞ²Ğ¾Ğ³Ğ¾ saveInvoice (ÑĞºÑ‰Ğ¾ Ğ·Ğ°Ñ…Ğ¾Ñ‡ĞµÑˆ)
  window.saveInvoiceToCloud = async function (invoice) {
    const user = auth.currentUser;
    if (!user) return; // Ñ‚Ğ¸Ñ…Ğ¾ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾, ÑĞºÑ‰Ğ¾ Ğ½Ğµ Ğ·Ğ°Ğ»Ğ¾Ğ³Ñ–Ğ½ĞµĞ½Ğ¸Ğ¹
    const inv = normalizeForFirestore(invoice);
    const colRef = collection(db, "users", user.uid, "invoices");
    await setDoc(doc(colRef), inv);
  };

  // ğŸ§  ĞĞºÑƒÑ€Ğ°Ñ‚Ğ½Ğµ Â«Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ¿Ğ»ĞµĞ½Ğ½ÑÂ» Ñ–ÑĞ½ÑƒÑÑ‡Ğ¾Ğ³Ğ¾ saveInvoice Ğ±ĞµĞ· Ğ·Ğ¼Ñ–Ğ½ Ñ‚Ğ²Ğ¾Ñ”Ñ— Ğ»Ğ¾Ğ³Ñ–ĞºĞ¸
  // Ğ¯ĞºÑ‰Ğ¾ Ñƒ Ñ‚ĞµĞ±Ğµ Ğ²Ğ¶Ğµ Ñ” window.saveInvoice, Ğ¼Ğ¸ Ğ¹Ğ¾Ğ³Ğ¾ Ğ´ĞµĞ»Ñ–ĞºĞ°Ñ‚Ğ½Ğ¾ Ğ¾Ğ±Ğ³Ğ¾Ñ€Ğ½ĞµĞ¼Ğ¾,
  // Ñ‰Ğ¾Ğ± Ğ¿Ñ–ÑĞ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ñ‰Ğµ Ğ´Ğ¾Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ Ñƒ Firestore.
  const originalSave = window.saveInvoice;
  if (typeof originalSave === "function") {
    window.saveInvoice = async function (...args) {
      // Ğ·Ğ½Ñ–Ğ¼Ğ¾Ğº "Ğ´Ğ¾"
      let before = [];
      try { before = JSON.parse(localStorage.getItem("invoices") || "[]") || []; } catch {}

      // Ğ²Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ²Ñ–Ğ¹ Ğ¾Ñ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ saveInvoice (Ñ€Ğ°Ñ…ÑƒĞ½ĞºĞ¸, Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ¸, Ğ½ÑƒĞ¼ĞµÑ€Ğ°Ñ†Ñ–Ñ â€” Ğ²ÑĞµ ÑĞº Ğ±ÑƒĞ»Ğ¾)
      const res = await originalSave.apply(this, args);

      // ÑˆÑƒĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ–Ğ¹ Ñ–Ğ½Ğ²Ğ¾Ğ¹Ñ, Ñ‰Ğ¾Ğ¹Ğ½Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ğ½Ğ¸Ğ¹/Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹ Ñƒ localStorage
      let after = [];
      try { after = JSON.parse(localStorage.getItem("invoices") || "[]") || []; } catch {}

      // Ğ¿Ñ€Ñ–Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ â€” Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ–Ğ¹ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚, Ğ°Ğ±Ğ¾ Ñ‚Ğ¾Ğ¹, ÑĞºĞ¾Ğ³Ğ¾ Ğ½Ğµ Ğ±ÑƒĞ»Ğ¾ "Ğ´Ğ¾"
      let candidate = after[after.length - 1];
      for (const inv of after) {
        if (!before.some(b => b.invoiceNumber === inv.invoiceNumber)) {
          candidate = inv; break;
        }
      }

      // ÑˆÑ‚Ğ¾Ğ²Ñ…Ğ°Ñ”Ğ¼Ğ¾ Ñƒ Ñ…Ğ¼Ğ°Ñ€Ñƒ (Ğ½Ğµ Ğ»Ğ°Ğ¼Ğ°Ñ”Ğ¼Ğ¾ UX, Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸ Ñ‚Ğ¸Ñ…Ğ¾ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ)
      if (candidate) {
        try { await window.saveInvoiceToCloud(candidate); } 
        catch (e) { console.warn("Cloud sync skipped:", e); }
      }
      return res;
    };
  }
</script>
</body>
</html>
