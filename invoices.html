<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartWerk Invoice Manager</title>

  <link rel="stylesheet" href="style-invoices.css?v=5" />

  <!-- Flatpickr (календар) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- OCR + PDF (можеш лишити, якщо користуєшся) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <style>
    .signature { border:1px solid #444; background:#fff; cursor:crosshair; display:block }
    .step { margin:20px 0; padding:16px; border:1px solid #2a2a2a; border-radius:12px }
    table { width:100%; border-collapse: collapse }
    th, td { padding:8px; border-bottom:1px solid #2a2a2a }
    .btn { display:inline-block; padding:8px 12px; border:1px solid #3b82f6; color:#fff; background:#2563eb; border-radius:8px; text-decoration:none }
    .btn:hover { filter:brightness(1.05) }
  </style>
</head>
<body>
  <div class="topbar">
    <nav>
      <a href="index.html" class="btn">← Main Page</a>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="invoices-list.html" class="btn">📋 Invoices List</a>
    </nav>
  </div>

  <main>
    <h1>SmartWerk Invoice Manager</h1>

    <!-- Business Info -->
    <section class="step">
      <h2>🏢 Business Info</h2>
      <input id="businessName" placeholder="Business Name" />
      <input id="kvk" placeholder="KvK Number" />
      <input id="iban" placeholder="IBAN" />
      <input id="btw" placeholder="BTW Number" />
      <input id="businessEmail" type="email" placeholder="Business Email" />
      <input id="businessPhone" type="tel" placeholder="Business Phone" />
      <input id="businessAddress" placeholder="Business Address" />
    </section>

    <!-- Client Info -->
    <section class="step">
      <h2>👤 Client Info</h2>
      <input id="clientName" placeholder="Client Name" />
      <input id="clientEmail" type="email" placeholder="Client Email" />
      <input id="clientPhone" type="tel" placeholder="Client Phone" />
      <input id="clientAddress" placeholder="Client Address" />

      <input id="invoiceDate" class="js-date" placeholder="Invoice Date (YYYY-MM-DD)" />
      <input id="dueDate" class="js-date" placeholder="Due Date (YYYY-MM-DD)" />
      <input id="invoiceNumber" placeholder="Invoice Number (auto)" />

      <label>Status:
        <select id="status">
          <option>Draft</option>
          <option>Sent</option>
          <option>Paid</option>
        </select>
      </label>
    </section>

    <!-- Items -->
    <section class="step">
      <h2>📝 Items</h2>
      <table>
        <thead>
          <tr>
            <th>Description</th><th>Qty</th><th>Price</th><th>VAT %</th><th>Total</th><th></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button class="btn" onclick="addItem()">➕ Add Item</button>
    </section>

    <!-- Summary -->
    <section class="step">
      <h2>📦 Summary</h2>
      <textarea id="note" placeholder="Notes..."></textarea>
      <p><strong>Subtotal:</strong> <span id="subtotal">€0.00</span></p>
      <p><strong>Total VAT:</strong> <span id="totalVat">€0.00</span></p>
      <p><strong>Total:</strong> <span id="grandTotal">€0.00</span></p>
    </section>

    <!-- OCR -->
    <section class="step">
      <h2>📷 Receipt OCR</h2>
      <input type="file" id="receiptInput" accept="image/*" />
      <button class="btn" onclick="processReceipt()">Scan</button>
      <pre id="receiptText"></pre>
    </section>

    <!-- Signatures -->
    <section class="step">
      <h2>✍️ Signatures</h2>
      <div>
        <h3>Business Signature</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button class="btn" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div style="margin-top:12px">
        <h3>Client Signature</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button class="btn" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step">
      <h2>⚙️ Actions</h2>
      <button class="btn" onclick="saveInvoice()">💾 Save Invoice</button>
      <a href="invoices-list.html" class="btn">📋 Open Invoices List</a>
    </section>
  </main>

 <script type="module">
  // ✅ Firestore sync — не змінює твою існуючу логіку, лише дописує у хмару
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
    authDomain: "smartwerk8520.firebaseapp.com",
    projectId: "smartwerk8520",
    appId: "1:607670981972:web:c07103c981c86860d724c1",
  };

  const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  // Нормалізує інвойс для списку (мінімально необхідні поля + все інше збережеться як є)
  function normalizeForFirestore(inv) {
    const parseMoney = v => Number(String(v).toString().replace("€","").trim()) || 0;

    // Якщо збереження йде з DOM—доберемо підсумки напряму:
    const subtotalEl = document.getElementById("subtotal");
    const totalVatEl = document.getElementById("totalVat");
    const grandEl    = document.getElementById("grandTotal");

    const subtotal = inv.subtotal ?? (subtotalEl ? parseMoney(subtotalEl.innerText) : 0);
    const vat      = inv.vat      ?? (totalVatEl ? parseMoney(totalVatEl.innerText) : 0);
    const total    = inv.total    ?? (grandEl ? parseMoney(grandEl.innerText) : 0);

    return {
      ...inv,
      // Ключові поля для списку:
      invoiceNumber: String(inv.invoiceNumber || "").trim(),
      clientName:    String(inv.clientName || "").trim(),
      invoiceDate:   String(inv.invoiceDate || "").trim(), // очікується YYYY-MM-DD
      status:        String(inv.status || "Draft"),
      subtotal, vat, total,
      userId: auth.currentUser?.uid || inv.userId || "",
      createdAt: inv.createdAt || new Date().toISOString()
    };
  }

  // Окремий виклик, щоб ти міг дернути його зі свого saveInvoice (якщо захочеш)
  window.saveInvoiceToCloud = async function (invoice) {
    const user = auth.currentUser;
    if (!user) return; // тихо пропускаємо, якщо не залогінений
    const inv = normalizeForFirestore(invoice);
    const colRef = collection(db, "users", user.uid, "invoices");
    await setDoc(doc(colRef), inv);
  };

  // 🧠 Акуратне «перехоплення» існуючого saveInvoice без змін твоєї логіки
  // Якщо у тебе вже є window.saveInvoice, ми його делікатно обгорнемо,
  // щоб після локального збереження ще дописати у Firestore.
  const originalSave = window.saveInvoice;
  if (typeof originalSave === "function") {
    window.saveInvoice = async function (...args) {
      // знімок "до"
      let before = [];
      try { before = JSON.parse(localStorage.getItem("invoices") || "[]") || []; } catch {}

      // виконуємо твій оригінальний saveInvoice (рахунки, підписи, нумерація — все як було)
      const res = await originalSave.apply(this, args);

      // шукаємо останній інвойс, щойно доданий/оновлений у localStorage
      let after = [];
      try { after = JSON.parse(localStorage.getItem("invoices") || "[]") || []; } catch {}

      // пріоритет — останній елемент, або той, якого не було "до"
      let candidate = after[after.length - 1];
      for (const inv of after) {
        if (!before.some(b => b.invoiceNumber === inv.invoiceNumber)) {
          candidate = inv; break;
        }
      }

      // штовхаємо у хмару (не ламаємо UX, помилки тихо в консоль)
      if (candidate) {
        try { await window.saveInvoiceToCloud(candidate); } 
        catch (e) { console.warn("Cloud sync skipped:", e); }
      }
      return res;
    };
  }
</script>
</body>
</html>
