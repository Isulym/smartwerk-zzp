<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk â€” Saved Expenses</title>
  <link rel="stylesheet" href="style-expense-csv.css"/>
  
</head>
<body>
  <header>
    <h1>ğŸ“‹ SmartWerk â€” Saved Expenses</h1>
     <div class="header-actions">
      <a href="expense-csv.html" class="btn">â• New Expense</a>
      <a href="dashboard.html" class="btn">ğŸ  Back to Dashboard</a>
     </div>
  </header>

  <main>
    <form id="filtersForm" onsubmit="return false">

    <div class="toolbar">
      <input type="text" id="search" placeholder="ğŸ” Search by description or ID...">
      <select id="filterStatus">
        <option value="">All Statuses</option>
        <option>Paid</option><option>Pending</option><option>Overdue</option><option>Scheduled</option>
      </select>
      <select id="filterCountry">
        <option value="">All Countries</option>
        <option>Netherlands</option><option>Belgium</option><option>Germany</option><option>France</option><option>Spain</option>
      </select>
      <button class="btn" id="refreshBtn">ğŸ”„ Refresh</button>
     <!-- Ğ¿Ñ€Ğ¸ĞºĞ»Ğ°Ğ´ Ñƒ Ñ‚ÑƒĞ»Ğ±Ğ°Ñ€Ñ– -->
      <button id="exportAllPdfBtn"  class="btn">ğŸ“„ Export All PDF</button>
      <button id="exportAllPdfProBtn"  class="btn">ğŸ·ï¸ Export All PDF (PRO)</button>
      <button id="exportSelectedPdfBtn" class="btn">ğŸ“„ Export Selected PDF</button>
      <button id="exportSelectedCsvBtn" class="btn">ğŸ“Š Export Selected CSV</button>
    </div>

   <table id="expensesTable">
  <thead>
    <tr>
      <th><input type="checkbox" id="selectAll"></th>
      <th>ID</th><th>Date</th><th>Description</th><th>Category</th>
      <th>Type</th><th>Payment</th><th>Status</th>
      <th>Amount</th><th>VAT</th><th>Total</th><th>Actions</th>
    </tr>
  </thead>
  <tbody id="expensesBody"><tr><td colspan="12">Loading...</td></tr></tbody>
</table>

    <div class="summary">
      <h3>ğŸ“ˆ Summary</h3>
      <p>Subtotal: <span id="sumSubtotal">â‚¬0.00</span></p>
      <p>VAT: <span id="sumVat">â‚¬0.00</span></p>
      <p><strong>Total: <span id="sumTotal">â‚¬0.00</span></strong></p>
    </div>
      </form>
 
  <div class="details-modal" id="detailsModal">
    <div class="details-box">
      <h3>Expense Details</h3>
      <div id="detailsContent"></div>
      <button class="btn" id="closeDetails">âœ– Close</button>
    </div>
  </div>
    
  </main>
  
  <footer><p>Â© 2025 SmartWerk</p></footer>
  <!-- jsPDF (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<!-- AutoTable Ğ¿Ğ»Ğ°Ğ³Ñ–Ğ½ -->
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, setLogLevel } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    setLogLevel("error");
   
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const $ = (id)=>document.getElementById(id);

    let allExpenses=[];

   import { onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

function loadExpenses(uid){
  const body=$("expensesBody");
  body.innerHTML="<tr><td colspan='11'>Loading...</td></tr>";

  const q = collection(db, "users", uid, "expenses");
  onSnapshot(q, (snap) => {
    allExpenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    allExpenses.sort((a,b)=>new Date(b.date)-new Date(a.date));
    renderExpenses(allExpenses);
    document.title = `ğŸ“Š SmartWerk â€” ${allExpenses.length} expenses`;
    console.log("âœ… Loaded", allExpenses.length, "expenses");
  });
}

 function renderExpenses(list) {
  const body = $("expensesBody");
  body.innerHTML = "";

  if (list.length === 0) {
  body.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#94a3b8;">No reminders found</td></tr>`;
  return;
}

  let sub = 0, vat = 0, total = 0;

  list.forEach((exp) => {
    const amt = parseFloat(exp.amount) || 0;
    const vatAmt = parseFloat(exp.vatAmount) || 0;
    const totalAmt = parseFloat(exp.total) || (amt + vatAmt);

    sub += amt;
    vat += vatAmt;
    total += totalAmt;

    const tr = document.createElement("tr");
    tr.classList.add("expense-row");
    tr.innerHTML = `
      <td><input type="checkbox" class="rowSelect" data-id="${exp.id}"></td>
      <td>${exp.expenseId || ""}</td>
      <td>${exp.date || ""}</td>
      <td>${exp.description || ""}</td>
      <td>${exp.category || ""}</td>
      <td>${exp.type || ""}</td>
      <td>${exp.paymentMethod || ""}</td>
      <td>${exp.status || ""}</td>
      <td>â‚¬${amt.toFixed(2)}</td>
      <td>â‚¬${vatAmt.toFixed(2)}</td>
      <td><strong>â‚¬${totalAmt.toFixed(2)}</strong></td>
      <td>
        <button class="btn small" onclick="editExpense('${exp.id}')">âœï¸ Edit</button>
        <button class="btn small" onclick="showDetails('${exp.id}')">ğŸ” Review</button>
        <button class="btn small" onclick="deleteExpense('${exp.id}','${exp.expenseId || ""}')">ğŸ—‘ Delete</button>
        <button class="btn small" onclick="exportExpensePDF('${exp.id}',true)">ğŸ“„ PDF</button>
        <button class="btn small" onclick="exportExpensePDF('${exp.id}',false)">PRO ğŸ“„</button>
        <button class="btn small" onclick="exportExpenseCSV('${exp.id}')">ğŸ“Š CSV</button>
      </td>`;
    body.appendChild(tr);
  });

  $("sumSubtotal").textContent = `â‚¬${sub.toFixed(2)}`;
  $("sumVat").textContent = `â‚¬${vat.toFixed(2)}`;
  $("sumTotal").textContent = `â‚¬${total.toFixed(2)}`;

  // Select all toggle
  const selectAll = $("selectAll");
  selectAll?.addEventListener("change", (e) => {
    document.querySelectorAll(".rowSelect").forEach((cb) => (cb.checked = e.target.checked));
  });
}

    function showDetails(id){
      const exp=allExpenses.find(e=>e.id===id);
      if(!exp)return;
      const box=$("detailsContent");
      box.innerHTML=`
        <p><strong>ID:</strong> ${exp.expenseId}</p>
        <p><strong>Date:</strong> ${exp.date}</p>
        <p><strong>Description:</strong> ${exp.description}</p>
        <p><strong>Type:</strong> ${exp.type}</p>
        <p><strong>Category:</strong> ${exp.category}</p>
        <p><strong>Country:</strong> ${exp.country}</p>
        <p><strong>Payment Method:</strong> ${exp.paymentMethod}</p>
        <p><strong>Status:</strong> ${exp.status}</p>
        <p><strong>Amount:</strong> â‚¬${(exp.amount||0).toFixed(2)}</p>
        <p><strong>VAT:</strong> â‚¬${(exp.vatAmount||0).toFixed(2)}</p>
        <p><strong>Total:</strong> â‚¬${(exp.total||0).toFixed(2)}</p>
        <p><strong>Notes:</strong> ${exp.notes||"â€”"}</p>
        <p><strong>Invoice Attached:</strong> ${exp.invoiceAttached||"No"}</p>
        <p><strong>Business:</strong> ${exp.businessName||""}</p>
        <p><strong>Email:</strong> ${exp.email||""}</p>
        <p><strong>Address:</strong> ${exp.businessAddress||""}</p>`;
      $("detailsModal").classList.add("active");
    }

    $("closeDetails")?.addEventListener("click",()=>$("detailsModal").classList.remove("active"));

    async function deleteExpense(docId, displayId){
      if(!confirm(`Delete expense ${displayId}?`))return;
      const user=auth.currentUser;
      await deleteDoc(doc(db,"users",user.uid,"expenses",docId));
      alert("ğŸ—‘ Expense deleted");
      loadExpenses(user.uid);
    }

 // === EXPORT PDF (SmartWerk PRO DESIGN v2.0) ===
window.exportExpensePDF = function (id, withBranding = true) {
  const exp = allExpenses.find((e) => e.id === id);
  if (!exp) return alert("Expense not found.");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");
  const blue = [59, 130, 246];
  const gray = [245, 247, 250];
  let y = 20;

  // ğŸŸ¦ HEADER
  if (withBranding) {
    doc.setFillColor(...blue);
    doc.rect(0, 0, 210, 30, "F");
    doc.setTextColor(255, 255, 255);
    doc.setFont("helvetica", "bold").setFontSize(20);
    doc.text("SmartWerk Expense Report", 20, 20);

    // Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ SmartWerk (SVG Ñ‡ĞµÑ€ĞµĞ· path)
    doc.setDrawColor(255, 255, 255);
    doc.setLineWidth(1.2);
    doc.circle(190, 15, 5, "S");
    doc.setFontSize(8).setFont("helvetica", "bold");
    doc.text("SW", 187.8, 17.5);
  } else {
    doc.setFont("helvetica", "bold").setFontSize(18).setTextColor(0, 0, 0);
    doc.text("Expense Report", 20, 20);
  }

  y = 40;

  // ğŸ§¾ Header Info
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal").setFontSize(12);
  doc.text(`Expense ID: ${exp.expenseId || "â€”"}`, 20, y);
  y += 6;
  doc.text(`Date: ${exp.date || "â€”"}`, 20, y);
  y += 10;

  // ğŸ¢ BUSINESS INFO
  doc.setFillColor(...gray);
  doc.rect(14, y - 6, 182, 26, "F");
  doc.setFont("helvetica", "bold").setFontSize(13);
  doc.setTextColor(...blue);
  doc.text("Business Information", 20, y);
  y += 7;
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal").setFontSize(11);
  doc.text(`${exp.businessName || "-"}\n${exp.email || "-"}\n${exp.businessAddress || "-"}`, 20, y);
  y += 22;

  // ğŸ’¼ EXPENSE DETAILS
  doc.setFillColor(...gray);
  doc.rect(14, y - 6, 182, 70, "F");
  doc.setFont("helvetica", "bold").setFontSize(13).setTextColor(...blue);
  doc.text("Expense Details", 20, y);
  y += 8;
  doc.setFont("helvetica", "normal").setFontSize(11).setTextColor(0);

  const details = [
    ["Description", exp.description],
    ["Type", exp.type],
    ["Category", exp.category],
    ["Country", exp.country],
    ["Payment Method", exp.paymentMethod],
    ["Status", exp.status],
    ["Invoice Attached", exp.invoiceAttached],
    ["Notes", exp.notes || "â€”"],
  ];

  details.forEach(([k, v]) => {
    doc.setFont("helvetica", "bold");
    doc.text(`${k}:`, 20, y);
    doc.setFont("helvetica", "normal");
    doc.text(String(v || "â€”"), 80, y);
    y += 7;
  });

  y += 6;
  doc.setDrawColor(...blue);
  doc.line(14, y, 196, y);
  y += 10;

  // ğŸ’° TOTALS
  doc.setFont("helvetica", "bold").setFontSize(13).setTextColor(...blue);
  doc.text("Totals", 20, y);
  y += 8;
  doc.setFont("helvetica", "normal").setFontSize(11).setTextColor(0);
  doc.text(`Subtotal: â‚¬${(exp.amount || 0).toFixed(2)}`, 20, y);
  y += 6;
  doc.text(`VAT (${exp.vatPercent || 21}%): â‚¬${(exp.vatAmount || 0).toFixed(2)}`, 20, y);
  y += 6;
  doc.setFont("helvetica", "bold");
  doc.text(`Total: â‚¬${(exp.total || 0).toFixed(2)}`, 20, y);
  y += 20;

  // ğŸ§  BRAND FOOTER
  if (withBranding) {
    doc.setDrawColor(...blue);
    doc.setLineWidth(0.3);
    doc.line(14, 284, 196, 284);
    doc.setFont("helvetica", "normal").setFontSize(10).setTextColor(120);
    doc.text("Generated with SmartWerk â€” smartwerk.nl", 20, 290);
  }

  // ğŸ’¾ SAVE
  const fileName = withBranding
    ? `SmartWerk_Expense_${exp.expenseId || "Report"}.pdf`
    : `Expense_${exp.expenseId || "Report"}_PRO.pdf`;
  doc.save(fileName);
};

  // === EXPORT ALL TO CSV ===
window.exportExpenseCSV = function() {
  if (!allExpenses || !allExpenses.length) {
    alert("No data to export.");
    return;
  }

  const headers = [
    "Expense ID","Date","Description","Category","Type","Country",
    "Amount (â‚¬)","VAT (â‚¬)","Total (â‚¬)","Payment Method","Status"
  ];

  const rows = allExpenses.map(e => [
    e.expenseId || "",
    e.date || "",
    e.description || "",
    e.category || "",
    e.type || "",
    e.country || "",
    (e.amount || 0).toFixed(2),
    (e.vatAmount || 0).toFixed(2),
    (e.total || 0).toFixed(2),
    e.paymentMethod || "",
    e.status || ""
  ]);

  const csvContent =
    [headers.join(",")].concat(rows.map(r => r.join(","))).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "SmartWerk_Expenses.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

    function editExpense(docId){
      localStorage.setItem("editExpenseId",docId);
      location.href="expense-csv.html";
    }

    function filterAndSearch(){
      const q=$("search").value.toLowerCase();
      const status=$("filterStatus").value;
      const country=$("filterCountry").value;
      let list=allExpenses.filter(e=>{
        return (!q || e.description?.toLowerCase().includes(q) || e.expenseId?.toLowerCase().includes(q)) &&
               (!status || e.status===status) &&
               (!country || e.country===country);
      });
      renderExpenses(list);
    }

    document.addEventListener("DOMContentLoaded",()=>{
      ["search","filterStatus","filterCountry"].forEach(id=>$(id)?.addEventListener("input",filterAndSearch));
      $("refreshBtn")?.addEventListener("click",()=>{
        const user=auth.currentUser;
        if(user)loadExpenses(user.uid);
      });
    });

    // === EXPORT ALL EXPENSES (BATCH PDF) ===
window.exportAllExpensesPDF = async function(withBranding = true) {
  if (!allExpenses || allExpenses.length === 0) {
    alert("No expenses found to export.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");
  const blue = [59, 130, 246];
  const gray = [245, 247, 250];
  const pageHeight = 297;
  let y = 20;
  let page = 1;

  // ğŸ”¹ HEADER
  const drawHeader = () => {
    if (withBranding) {
      doc.setFillColor(...blue);
      doc.rect(0, 0, 210, 30, "F");
      doc.setTextColor(255, 255, 255);
      doc.setFont("helvetica", "bold").setFontSize(20);
      doc.text("SmartWerk Expense Summary", 20, 20);
      doc.setFontSize(10);
      doc.text(`Page ${page}`, 180, 20);
    } else {
      doc.setFont("helvetica", "bold").setFontSize(16);
      doc.text("Expense Summary Report", 20, 20);
      doc.setFontSize(10);
      doc.text(`Page ${page}`, 180, 20);
    }
    y = 40;
  };

  drawHeader();

  // ğŸ”¹ TABLE HEADER
  const drawTableHeader = () => {
    doc.setFont("helvetica", "bold").setFontSize(10).setTextColor(...blue);
    doc.text("ID", 14, y);
    doc.text("Date", 34, y);
    doc.text("Description", 64, y);
    doc.text("Category", 114, y);
    doc.text("Amount", 154, y);
    doc.text("Total", 184, y);
    y += 5;
    doc.setDrawColor(...blue);
    doc.line(14, y, 196, y);
    y += 4;
  };

  drawTableHeader();

  // ğŸ”¹ TABLE CONTENT
  doc.setFont("helvetica", "normal").setFontSize(10).setTextColor(0);

  let subtotal = 0, vatSum = 0, totalSum = 0;

  allExpenses.forEach((exp, i) => {
    if (y > pageHeight - 30) {
      page++;
      doc.addPage();
      drawHeader();
      drawTableHeader();
    }

    subtotal += exp.amount || 0;
    vatSum += exp.vatAmount || 0;
    totalSum += exp.total || 0;

    doc.text(exp.expenseId || "-", 14, y);
    doc.text(exp.date || "-", 34, y);
    doc.text((exp.description || "-").substring(0, 25), 64, y);
    doc.text(exp.category || "-", 114, y);
    doc.text(`â‚¬${(exp.amount || 0).toFixed(2)}`, 154, y, { align: "right" });
    doc.text(`â‚¬${(exp.total || 0).toFixed(2)}`, 196, y, { align: "right" });
    y += 6;
  });

  // ğŸ”¹ TOTALS
  if (y > pageHeight - 40) { doc.addPage(); drawHeader(); }

  y += 8;
  doc.setDrawColor(...blue);
  doc.line(14, y, 196, y);
  y += 10;

  doc.setFont("helvetica", "bold").setFontSize(12).setTextColor(...blue);
  doc.text("Summary Totals", 14, y);
  y += 7;
  doc.setFont("helvetica", "normal").setFontSize(11).setTextColor(0);
  doc.text(`Subtotal: â‚¬${subtotal.toFixed(2)}`, 14, y); y += 6;
  doc.text(`VAT: â‚¬${vatSum.toFixed(2)}`, 14, y); y += 6;
  doc.setFont("helvetica", "bold");
  doc.text(`Grand Total: â‚¬${totalSum.toFixed(2)}`, 14, y); y += 20;

  // ğŸ”¹ FOOTER
  if (withBranding) {
    doc.setDrawColor(...blue);
    doc.line(14, 284, 196, 284);
    doc.setFont("helvetica", "normal").setFontSize(9).setTextColor(120);
    doc.text("Generated with SmartWerk â€” smartwerk.nl", 20, 290);
  }

  const name = withBranding ? "SmartWerk_All_Expenses.pdf" : "All_Expenses_PRO.pdf";
  doc.save(name);
};
// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ¼Ğ°ÑĞ¸Ğ² Ğ· Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ¼Ğ°Ñ” Ğ±ÑƒÑ‚Ğ¸ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹ Ñƒ Ñ‚Ğ²Ğ¾Ñ”Ğ¼Ñƒ onSnapshot:
// let allExpenses = [];
// onSnapshot(...){ allExpenses = snap.docs.map(d => ({ id:d.id, ...d.data() })); renderTable(allExpenses); }

function euro(n) {
  const v = Number(n || 0);
  return "â‚¬ " + v.toFixed(2);
}

function addHeaderFooter(doc, { pro }) {
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    // Header
    doc.setFont("helvetica", "bold");
    doc.setFontSize(13);
    doc.text("SmartWerk â€” Expenses Report", 40, 30);

    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.text(new Date().toLocaleString(), 40, 44);

    // Footer
    const pageLabel = `Page ${i} / ${pageCount}`;
    doc.setFontSize(9);
    doc.text(pageLabel, 40, doc.internal.pageSize.getHeight() - 20);

    if (!pro) {
      const brand = "Generated with SmartWerk â€” smartwerk.nl";
      const w = doc.getTextWidth(brand);
      doc.text(
        brand,
        doc.internal.pageSize.getWidth() - 40 - w,
        doc.internal.pageSize.getHeight() - 20
      );
    }
  }
}

window.exportAllPDF = function ({ pro = false } = {}) {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert("jsPDF is not loaded");
    return;
  }
  if (!Array.isArray(window.allExpenses) || !window.allExpenses.length) {
    alert("No data to export.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  // Ğ”Ğ°Ğ½Ñ–
  const headers = [
    "Expense ID",
    "Date",
    "Description",
    "Category",
    "Type",
    "Country",
    "Amount",
    "VAT",
    "Total",
    "Method",
    "Status",
  ];

  const body = window.allExpenses.map(e => ([
    e.expenseId || "",
    e.date || "",
    e.description || "",
    e.category || "",
    e.type || "",
    e.country || "",
    euro(e.amount),
    euro(e.vatAmount),
    euro(e.total),
    e.paymentMethod || "",
    e.status || "",
  ]));

  // ĞŸÑ–Ğ´ÑÑƒĞ¼ĞºĞ¸
  const sum = (k) => window.allExpenses.reduce((a, b) => a + (Number(b[k]) || 0), 0);
  const totals = {
    amount: sum("amount"),
    vat: sum("vatAmount"),
    total: sum("total"),
  };

  // ĞÑĞ½Ğ¾Ğ²Ğ½Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ
  doc.autoTable({
    head: [headers],
    body,
    startY: 70,
    styles: { font: "helvetica", fontSize: 9, cellPadding: 6, overflow: "linebreak" },
    headStyles: { fillColor: [59, 130, 246], textColor: 255, fontStyle: "bold" },
    columnStyles: {
      6: { halign: "right" },
      7: { halign: "right" },
      8: { halign: "right" },
    },
    didDrawPage: () => { /* header/footer Ğ´Ğ¾Ğ´Ğ°Ğ¼Ğ¾ Ğ¿Ñ–ÑĞ»Ñ autoTable */ },
    margin: { left: 40, right: 40 },
  });

  // Ğ‘Ğ»Ğ¾Ğº Ğ· Ğ¿Ñ–Ğ´ÑÑƒĞ¼ĞºĞ°Ğ¼Ğ¸
  const endY = doc.lastAutoTable.finalY || 70;
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Totals", 40, endY + 24);

  doc.autoTable({
    startY: endY + 30,
    theme: "plain",
    styles: { fontSize: 11 },
    body: [
      ["Subtotal", euro(totals.amount)],
      ["VAT",      euro(totals.vat)],
      ["Total",    euro(totals.total)],
    ],
    columnStyles: {
      0: { fontStyle: "bold" },
      1: { halign: "right" },
    },
    margin: { left: 40, right: 40 },
  });

  // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ…ĞµĞ´ĞµÑ€/Ñ„ÑƒÑ‚ĞµÑ€ Ğ½Ğ° Ğ²ÑÑ– ÑÑ‚Ğ¾Ñ€Ñ–Ğ½ĞºĞ¸
  addHeaderFooter(doc, { pro });

  doc.save(pro ? "SmartWerk_Expenses_All_PRO.pdf" : "SmartWerk_Expenses_All.pdf");
};
    

// === Connect button ===
document.getElementById("exportAllPdfBtn")?.addEventListener("click", () => exportAllPDF({ pro:false }));
document.getElementById("exportAllPdfProBtn")?.addEventListener("click", () => exportAllPDF({ pro:true }));    

    function getSelectedExpenses() {
  const selectedIds = Array.from(document.querySelectorAll(".rowSelect:checked"))
    .map((cb) => cb.dataset.id);
  return allExpenses.filter((e) => selectedIds.includes(e.id));
}

function exportSelectedPDF({ pro = false } = {}) {
  const selected = getSelectedExpenses();
  if (!selected.length) {
    alert("Please select at least one expense to export.");
    return;
  }
  // Ñ‚Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ğ¾ ĞºĞ¾Ğ¿Ñ–ÑÑ”Ğ¼Ğ¾ Ğ¼Ğ°ÑĞ¸Ğ²
  window.selectedExpenses = selected;
  console.log(`ğŸ“„ Exporting ${selected.length} expenses`);
  // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ñ–ÑĞ½ÑƒÑÑ‡Ñƒ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ exportAllPDF, Ğ°Ğ»Ğµ Ğ· selected
  const original = window.allExpenses;
  window.allExpenses = selected;
  exportAllPDF({ pro });
  window.allExpenses = original;
}

function exportSelectedCSV() {
  const selected = getSelectedExpenses();
  if (!selected.length) {
    alert("Please select at least one expense to export.");
    return;
  }
  const headers = [
    "Expense ID","Date","Description","Category","Type","Country",
    "Amount (â‚¬)","VAT (â‚¬)","Total (â‚¬)","Payment Method","Status"
  ];
  const rows = selected.map(e => [
    e.expenseId || "",
    e.date || "",
    e.description || "",
    e.category || "",
    e.type || "",
    e.country || "",
    (e.amount || 0).toFixed(2),
    (e.vatAmount || 0).toFixed(2),
    (e.total || 0).toFixed(2),
    e.paymentMethod || "",
    e.status || ""
  ]);
  const csv = [headers.join(",")].concat(rows.map(r=>r.join(","))).join("\n");
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "SmartWerk_Selected_Expenses.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// ğŸ”— Buttons
$("exportSelectedPdfBtn")?.addEventListener("click",()=>exportSelectedPDF({pro:false}));
$("exportSelectedCsvBtn")?.addEventListener("click",()=>exportSelectedCSV());

    onAuthStateChanged(auth, user=>{
      if(!user){location.href="login.html";return;}
      loadExpenses(user.uid);
      window.deleteExpense=deleteExpense;
      window.editExpense=editExpense;
      window.showDetails=showDetails;
    });

    
  </script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem('theme') || 'theme-dark';
    document.body.classList.remove('theme-light', 'theme-dark');
    document.body.classList.add(savedTheme);
  });
</script>
</body>
</html>
