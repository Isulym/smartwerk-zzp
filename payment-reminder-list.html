<!DOCTYPE html>
<html lang="en">
<head>  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartWerk â€” Payment Reminders</title>
  <link rel="stylesheet" href="style-invoice-list.css"/>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
</head>
<body>
   <main class="wrap">
   <header class="topbar">
    <h1>ğŸ“‹ SmartWerk â€” Saved Payment Reminders</h1>
     <div class="header-actions">
      <a href="payment-reminder.html" class="btn" onclick="localStorage.removeItem('editReminderId')">â• New Reminder</a>
       <a href="dashboard.html" class="btn">ğŸ  Dashboard</a>
    </div>
  </header>


  <section class="filters">
   
 <label>From:<input type="text" id="fromDate" name="fromDate" class="js-date" placeholder="YYYY-MM-DD" autocomplete="off">
    </label>

  <label>To:<input type="text" id="toDate" name="toDate" class="js-date" placeholder="YYYY-MM-DD" autocomplete="off">
    </label>
    
    <label>Status:
      <select id="statusFilter" name="statusFilter">
        <option value="all">All</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
    </label>

    <label>Type:
      <select id="typeFilter" name="typeFilter">
        <option value="all">All</option>
        <option value="First Reminder">First Reminder</option>
        <option value="Second Reminder">Second Reminder</option>
        <option value="Final Reminder">Final Reminder</option>
      </select>
    </label>

  
    <label>Search:
      <input type="text" id="searchBox" name="searchBox" placeholder="Search client / Reminder # / Amount" autocomplete="off">
    </label>

    <label>Sort by:
      <select id="sortBy" name="sortBy">
        <option value="date_desc">Date (new)</option>
        <option value="date_asc">Date (old)</option>
        <option value="reminderNumber_desc">Reminder # (new)</option>
        <option value="reminderNumber_asc">Reminder # (old)</option>
        <option value="amount_desc">Amount â†“</option>
        <option value="amount_asc">Amount â†‘</option>
      </select>
    </label>
  </section>

  <section>
    <table role="table">
      <thead>
        <tr>
          <th>Reminder ID</th>
          <th>Invoice</th>
          <th>Client</th>
          <th>Status</th>
          <th>Type</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="remindersBody">
        <tr><td colspan="8" style="text-align:center;">ğŸ”„ Loading...</td></tr>
      </tbody>
    </table>
  </section>
</main>

<footer>
  <p>Â© 2025 SmartWerk</p>
</footer>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, deleteDoc, setDoc, onSnapshot, query, orderBy, setLogLevel
           } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    setLogLevel("error");

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);
    const asNumber = (v) => {
      if(typeof v === "number") return v;
      const s = String(v??"").replace(/[^\d,.\-]/g,"").replace(",",".");
      return parseFloat(s)||0;
    };
    const fmt = v => "â‚¬" + asNumber(v).toFixed(2);

    let reminders = [];

    function startRealtime(uid){
      const colRef = collection(db,"users",uid,"reminders");
      const q = query(colRef, orderBy("reminderDate","desc"));
      onSnapshot(q,(snap)=>{
        reminders = snap.docs.map(d=>({id:d.id, ...d.data()}));
        render();
      });
    }

    function render(){
      const body = $("remindersBody");
      body.innerHTML = "";

      const from = $("fromDate").value;
      const to   = $("toDate").value;
      const status = $("statusFilter").value;
      const type = $("typeFilter").value;
      const search = $("searchBox").value.toLowerCase();
      const sortBy = $("sortBy").value;

      let list = reminders.filter(r=>{
        let ok = true;
        if(status!=="all") ok = ok && r.status === status;
        if(type!=="all") ok = ok && r.type === type;
        if(from) ok = ok && (r.reminderDate||"") >= from;
        if(to)   ok = ok && (r.reminderDate||"") <= to;
        if(search){
          ok = ok && (
            (r.clientName||"").toLowerCase().includes(search) ||
            (r.reminderId||"").toLowerCase().includes(search) ||
            String(asNumber(r.amount)).includes(search)
          );
        }
        return ok;
      });

      list.sort((a,b)=>{
        switch (sortBy){
          case "reminderNumber_desc": return (b.reminderId||"").localeCompare(a.reminderId||"");
          case "reminderNumber_asc":  return (a.reminderId||"").localeCompare(b.reminderId||"");
          case "date_desc":           return (b.reminderDate||"").localeCompare(a.reminderDate||"");
          case "date_asc":            return (a.reminderDate||"").localeCompare(b.reminderDate||"");
          case "amount_desc":         return asNumber(b.amount) - asNumber(a.amount);
          case "amount_asc":          return asNumber(a.amount) - asNumber(b.amount);
          default: return 0;
        }
      });
      if (list.length === 0) {
  body.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#94a3b8;">No reminders found</td></tr>`;
  return;
}

      list.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.reminderId||"â€”"}</td>
          <td>${r.linkedInvoice||"â€”"}</td>
          <td>${r.clientName||"â€”"}</td>
          <td>
            <select name="status" onchange="updateReminderStatus('${r.id}', this.value)">
              <option value="Draft" ${r.status==="Draft"?"selected":""}>Draft</option>
              <option value="Sent" ${r.status==="Sent"?"selected":""}>Sent</option>
              <option value="Paid" ${r.status==="Paid"?"selected":""}>Paid</option>
            </select>
          </td>
          <td>${r.type||"â€”"}</td>
          <td>${r.reminderDate||"â€”"}</td>
          <td>${fmt(r.amount)}</td>
          <td>
         <div class="actions" role="group" aria-label="Reminder actions">
    <button type="button" onclick="editReminder('${r.id}')">âœï¸ Edit</button>
    <button type="button" onclick="deleteReminder('${r.id}')">ğŸ—‘ Delete</button>
    <button type="button" onclick="downloadPDF('${r.id}', true)">ğŸ“„ PDF</button>
    <button type="button" onclick="downloadPDF('${r.id}', false)">PRO ğŸ“„ PDF without branding</button>
    <button type="button" onclick="sendReminder('${r.id}')">ğŸ“§ Send</button>
         </div>
</td>
        `;
        body.appendChild(tr);
      });
    }

    function editReminder(id){
      localStorage.setItem("editReminderId", id);
      location.href = "payment-reminder.html";
    }
    window.editReminder = editReminder;

    window.deleteReminder = async (id)=>{
      if(!confirm("Delete this reminder?")) return;
      await deleteDoc(doc(db,"users",auth.currentUser.uid,"reminders",id));
    };

    window.updateReminderStatus = async (id,newStatus)=>{
      try{
        const uid = auth.currentUser.uid;
        await setDoc(doc(db,"users",uid,"reminders",id), {
          status: newStatus,
          updatedAt: new Date().toISOString()
        }, { merge:true });
      }catch(e){
        console.error(e);
        alert("âŒ Status update failed: " + e.message);
      }
    };

    window.downloadPDF = (id, withBranding=true)=>{
      const r = reminders.find(x=>x.id===id);
      if(!r) return;
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      pdf.setFontSize(18);
      pdf.text("PAYMENT REMINDER", 105, 15, {align:"center"});

      pdf.setFontSize(12);
      pdf.text("From:", 14, 28);
      pdf.text([r.businessName||"", r.email||"", r.businessAddress||"", r.businessPhone||""], 14, 34);
      pdf.text("To:", 120, 28);
      pdf.text([r.clientName||"", r.clientEmail||"", r.clientAddress||""], 120, 34);

      pdf.autoTable({
        startY: 70,
        head:[["Reminder ID","Linked Invoice","Type","Status","Date","Amount"]],
        body:[[r.reminderId||"â€”", r.linkedInvoice||"â€”", r.type||"â€”", r.status||"Draft", r.reminderDate||"â€”", "â‚¬"+asNumber(r.amount).toFixed(2)]],
        theme:"grid",
        styles:{ fontSize:11, cellPadding:4, halign:"center" },
        headStyles:{ fillColor:[37,99,235], textColor:255 }
      });

      const y = pdf.lastAutoTable.finalY + 10;
      if(r.message){
        pdf.text("Message:", 14, y);
        pdf.text(String(r.message), 14, y+6, {maxWidth:180});
      }

      let y2 = y + 30;
      if(r.signatures?.business){
        pdf.setDrawColor(0);
        pdf.line(14, y2+22, 74, y2+22);
        pdf.addImage(r.signatures.business, "PNG", 14, y2, 60, 20);
        pdf.text("Business Signature", 14, y2+30);
      }
      if(r.signatures?.client){
        pdf.setDrawColor(0);
        pdf.line(120, y2+22, 180, y2+22);
        pdf.addImage(r.signatures.client, "PNG", 120, y2, 60, 20);
        pdf.text("Client Signature", 120, y2+30);
      }

      if(withBranding){
        pdf.setFontSize(10);
        pdf.text("Generated with SmartWerk", 105, 290, {align:"center"});
      }

      pdf.save(`${r.reminderId||"Reminder"}.pdf`);
    };

    window.sendReminder = (id)=>{
      alert("ğŸ“§ Sending reminders via email will be part of SmartWerk PRO.");
    };

    onAuthStateChanged(auth,(user)=>{
      if(!user){ location.href="login.html"; return; }
      flatpickr(".js-date", {dateFormat: "Y-m-d"});
      startRealtime(user.uid);
      ["statusFilter","typeFilter","fromDate","toDate","searchBox","sortBy"].forEach(id=>{
        $(id).addEventListener("input", render);
      });
    });
  </script>
</body>
</html>
