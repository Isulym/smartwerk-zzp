<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk â€” Dashboard</title>
  <link rel="stylesheet" href="style-dashboard.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">âš¡ SmartWerk</div>
    <nav>
      <h3>ğŸ’° Invoices</h3>
      <a href="invoice.html">ğŸ“„ Create Invoice</a>
      <a href="invoices-list.html">ğŸ“‹ Saved Invoices</a>
      <h3>ğŸ“‘ Quotes</h3>
      <a href="quote-offer.html">ğŸ“„ Create Quote</a>
      <a href="quote-offer-list.html">ğŸ“‹ Saved Quotes</a>
      <h3>ğŸ“ƒ Contracts</h3>
      <a href="contract.html">ğŸ“„ Create Contract</a>
      <a href="contract-list.html">ğŸ“‹ Saved Contracts</a>
      <h3>ğŸ“¬ Reminders</h3>
      <a href="payment-reminder.html">ğŸ’¸ Create Reminder</a>
      <a href="payment-reminder-list.html">ğŸ“‹ Saved Reminders</a>
      <h3>ğŸ“‚ Templates</h3>
      <a href="email-gemeente.html">ğŸ“© Email to Gemeente</a>
      <a href="cv.html">ğŸ“„ CV / Portfolio</a>
      <h3>ğŸ“Š Analytics</h3>
      <a href="my-bookkeeper.html">ğŸ† My Bookkeeper</a>
      <a href="summary.html">ğŸ“Š Summary</a>
      <a href="roi-estimator.html">ğŸ§® ROI Estimator</a>
      <a href="tax-calculator.html">ğŸ§® Tax Calculator</a>
      <h3>âš™ï¸ Settings</h3>
      <a href="profile.html">ğŸ‘¤ Profile</a>
      <button id="logoutBtn" class="logout">ğŸšª Logout</button>
    </nav>
  </aside>

  <!-- Main content -->
  <main class="main">
    <header class="topbar">
      <h1 id="welcome">Welcome ğŸ‘‹</h1>
      <div class="plan-box" id="planBox">
        <span id="planName">FREE</span>
        <div class="progress">
          <div id="planProgress"></div>
        </div>
        <span id="planUsage">0 / 25</span>
      </div>
    </header>

    <!-- Quick actions -->
    <section class="quick-actions">
      <button onclick="location.href='invoice.html'">â• Invoice</button>
      <button onclick="location.href='quote-offer.html'">â• Quote</button>
      <button onclick="location.href='contract.html'">â• Contract</button>
      <button onclick="location.href='payment-reminder.html'">â• Reminder</button>
    </section>

    <!-- KPI cards -->
    <section class="kpis">
      <div class="kpi"><h3>ğŸ’° Revenue</h3><p id="kpiRevenue">â‚¬0</p></div>
      <div class="kpi"><h3>ğŸ“„ Invoices This Month</h3><p id="kpiInvoices">0</p></div>
      <div class="kpi"><h3>âš ï¸ Unpaid Invoices</h3><p id="kpiUnpaid">0</p></div>
      <div class="kpi"><h3>ğŸ“‘ Quotes Accepted</h3><p id="kpiQuotes">0%</p></div>
      <div class="kpi"><h3>ğŸ‘¥ New Clients</h3><p id="kpiClients">0</p></div>
      <div class="kpi"><h3>ğŸ”” Reminders Sent</h3><p id="kpiReminders">0</p></div>
    </section>

    <!-- Charts -->
    <section class="charts">
      <canvas id="revenueChart"></canvas>
      <canvas id="statusChart"></canvas>
    </section>

    <!-- Suggestions -->
    <section class="suggestions">
      <h2>ğŸ’¡ Smart Suggestions</h2>
      <ul id="suggestionsList"></ul>
    </section>

    <!-- Recent activity -->
    <section class="activity">
      <h2>ğŸ•’ Recent Activity</h2>
      <ul id="activityList"></ul>
    </section>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);

    onAuthStateChanged(auth, async(user)=>{
      if(!user){ location.href="login.html"; return; }
      const uid = user.uid;

      // Profile
      const snap = await getDoc(doc(db,"users",uid));
      if(snap.exists()){
        const p = snap.data();
        $("welcome").innerText = `Welcome, ${p.fullName||"User"} ğŸ‘‹`;
        const plan = p.plan || "FREE";
        const used = p.usage || 0;
        const limit = (plan==="FREE"?25:9999);
        $("planName").innerText = plan;
        $("planUsage").innerText = `${used} / ${limit}`;
        $("planProgress").style.width = `${Math.min((used/limit)*100,100)}%`;
      }

      // KPIs
      onSnapshot(collection(db,"users",uid,"invoices"), snap=>{
        let total=0, unpaid=0, count=0;
        snap.forEach(d=>{
          const inv = d.data();
          total += parseFloat(inv.grandTotal)||0;
          if(inv.status!=="Paid") unpaid++;
          count++;
        });
        $("kpiRevenue").innerText = "â‚¬"+total.toFixed(2);
        $("kpiInvoices").innerText = count;
        $("kpiUnpaid").innerText = unpaid;
      });

      onSnapshot(collection(db,"users",uid,"quotes"), snap=>{
        let acc=0, total=0;
        snap.forEach(d=>{
          const q = d.data();
          if(q.status==="Accepted") acc++;
          total++;
        });
        $("kpiQuotes").innerText = total?Math.round((acc/total)*100)+"%":"0%";
      });

      onSnapshot(collection(db,"users",uid,"reminders"), snap=>{
        $("kpiReminders").innerText = snap.size;
      });

      // Suggestions
      const sugg=[];
      if($("kpiUnpaid").innerText!=="0") sugg.push("âš ï¸ You have unpaid invoices â†’ Send reminders!");
      if(parseInt($("kpiQuotes").innerText)||0 < 30) sugg.push("ğŸ“‘ Low quote acceptance rate â†’ Refine your offers.");
      $("suggestionsList").innerHTML = sugg.map(s=>`<li>${s}</li>`).join("");

      // Charts
      const revChart = new Chart($("revenueChart"),{
        type:"line",
        data:{labels:["Jan","Feb","Mar","Apr"],datasets:[{label:"Revenue",data:[500,1200,900,1600]}]}
      });
      const statChart = new Chart($("statusChart"),{
        type:"doughnut",
        data:{labels:["Paid","Unpaid","Draft"],datasets:[{data:[10,4,6]}]}
      });

      // Logout
      $("logoutBtn").onclick=()=>signOut(auth);
    });
  </script>
</body>
</html>
