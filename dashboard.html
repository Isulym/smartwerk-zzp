<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Dashboard</title>
  <link rel="stylesheet" href="style-dashboard.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Підстраховка, якщо в CSS ще нема висоти для чарта */
    .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .chart-box { background: #0f172a; border: 1px solid #1f2937; border-radius: 12px; padding: 12px; height: 220px; }
    .chart-box canvas { width: 100% !important; height: 100% !important; }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">⚡ SmartWerk</div>
      <nav>
        <a href="dashboard.html" class="nav-root">🏠 Dashboard</a>

        <button class="accordion" data-key="invoices">💰 Invoices ▸</button>
        <div class="panel">
          <a href="invoice.html">📄 Create Invoice</a>
          <a href="invoices-list.html">📋 Saved Invoices</a>
        </div>

        <button class="accordion" data-key="quotes">📑 Quotes ▸</button>
        <div class="panel">
          <a href="quote-offer.html">📄 Create Quote</a>
          <a href="quote-offer-list.html">📋 Saved Quotes</a>
        </div>

        <button class="accordion" data-key="contracts">📃 Contracts ▸</button>
        <div class="panel">
          <a href="contract.html">📄 Create Contract</a>
          <a href="contract-list.html">📋 Saved Contracts</a>
        </div>

        <button class="accordion" data-key="reminders">📬 Reminders ▸</button>
        <div class="panel">
          <a href="payment-reminder.html">💸 Create Reminder</a>
          <a href="payment-reminder-list.html">📋 Saved Reminders</a>
        </div>

        <button class="accordion" data-key="templates">📂 Templates ▸</button>
        <div class="panel">
          <a href="email-gemeente.html">📩 Email to Gemeente</a>
          <a href="cv.html">📄 CV / Portfolio</a>
          <a href="expense.csv">🧮 Expense CSV</a>
          <a href="ai-assistant.html">🤖 AI Assistant (PRO)</a>
        </div>

        <button class="accordion" data-key="analytics">📊 Analytics ▸</button>
        <div class="panel">
          <a href="my-bookkeeper.html">🏆 My Bookkeeper</a>
          <a href="summary.html">📊 Summary</a>
          <a href="roi-estimator.html">📈 ROI Estimator</a>
          <a href="tax-calculator.html">🧮 Tax Calculator</a>
        </div>

        <button class="accordion" data-key="settings">⚙️ Settings ▸</button>
        <div class="panel">
          <a href="profile.html">👤 Profile</a>
        </div>

        <button class="accordion" data-key="clients">👥 Clients ▸</button>
        <div class="panel">
          <a href="#">➕ Add Client</a>
          <a href="#">📋 Saved Clients</a>
        </div>

        <button class="accordion" data-key="help">❓ Help ▸</button>
        <div class="panel">
          <a href="pricing.html">💳 Upgrade to PRO</a>
          <a href="mailto:smartwerk.team@gmail.com">📧 Contact Support</a>
        </div>

        <button id="logoutBtn" class="logout">🚪 Logout</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <h1 id="welcome">Welcome 👋</h1>
        <div class="plan-box">
          <span id="planName" class="badge">FREE</span>
          <div class="progress-bar"><div id="planProgress"></div></div>
          <small id="planUsage">0/25</small>
          <a href="pricing.html" class="upgrade-btn">Upgrade to PRO</a>
        </div>
      </header>

      <!-- Quick Actions -->
      <section class="quick-actions">
        <button onclick="createAction('invoice.html','Invoice')">➕ Invoice</button>
        <button onclick="createAction('quote-offer.html','Quote')">➕ Quote</button>
        <button onclick="createAction('contract.html','Contract')">➕ Contract</button>
        <button onclick="createAction('payment-reminder.html','Reminder')">➕ Reminder</button>
      </section>

      <!-- KPI Cards -->
      <section class="kpi-grid">
        <div class="kpi-card"><h3>💰 Revenue</h3><p id="kpiRevenue">€0</p></div>
        <div class="kpi-card"><h3>📄 Unpaid</h3><p id="kpiUnpaid">€0</p></div>
        <div class="kpi-card"><h3>📊 Quote Win-Rate</h3><p id="kpiQuoteRate">0%</p></div>
        <div class="kpi-card"><h3>💸 Reminders Sent</h3><p id="kpiReminders">0</p></div>
        <div class="kpi-card"><h3>📉 Expenses</h3><p id="kpiExpenses">€0</p></div>
        <div class="kpi-card"><h3>⏰ Overdue</h3><p id="kpiOverdue">0</p></div>
        <div class="kpi-card"><h3>👥 Top Client</h3><p id="kpiTopClient">—</p></div>
      </section>

      <!-- Charts -->
      <section class="charts">
        <div class="chart-box"><canvas id="revenueChart"></canvas></div>
        <div class="chart-box"><canvas id="invoiceStatusChart"></canvas></div>
      </section>

      <!-- Smart Suggestions -->
      <section class="suggestions">
        <h2>💡 Smart Suggestions</h2>
        <ul id="suggestionsList"></ul>
      </section>

      <!-- Recent Activity -->
      <section class="activity">
        <h2>🕒 Recent Activity</h2>
        <ul id="activityList"></ul>
      </section>
    </main>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot, query, orderBy,
      addDoc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const $ = (id)=>document.getElementById(id);

    /* ---------------- Sidebar Accordion (єдина логіка) ---------------- */
    function setArrow(btn, open){
      const base = btn.innerText.replace(/(▸|▾)\s*$/,'').trim();
      btn.innerText = base + (open ? ' ▾' : ' ▸');
    }
    function openPanel(btn){
      const panel = btn.nextElementSibling;
      if(!panel) return;
      btn.classList.add("open");
      panel.style.maxHeight = panel.scrollHeight + "px";
      setArrow(btn, true);
    }
    function closeAll(){
      document.querySelectorAll(".accordion.open").forEach(b=>{
        b.classList.remove("open");
        setArrow(b,false);
      });
      document.querySelectorAll(".panel").forEach(p=>p.style.maxHeight=null);
    }
    function toggleAccordion(btn){
      const panel = btn.nextElementSibling;
      if(!panel) return;
      if(btn.classList.contains("open")){
        btn.classList.remove("open");
        panel.style.maxHeight = null;
        setArrow(btn,false);
        localStorage.removeItem("sw_open_group");
      }else{
        closeAll();
        openPanel(btn);
        localStorage.setItem("sw_open_group", btn.dataset.key||"");
      }
    }
    document.querySelectorAll(".accordion").forEach(btn=>{
      btn.addEventListener("click",()=>toggleAccordion(btn));
    });
    const remembered = localStorage.getItem("sw_open_group");
    if(remembered){
      const btn = document.querySelector(`.accordion[data-key="${remembered}"]`);
      if(btn) openPanel(btn);
    }

    /* ---------------- Глобальні змінні для підказок ---------------- */
    let gInvoices=[], gQuotes=[], gReminders=0, gExpensesTotal=0;
    let gPlan='FREE', gUsageUsed=0, gUsageLimit=25;

    /* ---------------- Хелпери ---------------- */
    const parseMoney=(v)=>parseFloat(String(v??0).toString().replace(/[^\d.-]/g,""))||0;
    async function countDocs(uid, coll){
      const snap = await getDocs(collection(db,"users",uid,coll));
      return snap.size;
    }
    function formatEUR(n){ return "€"+(parseFloat(n||0)).toFixed(2); }

    /* ---------------- Charts ---------------- */
    let revenueChart, statusChart;
    function updateRevenueChart(dataMap){
      const labels = Object.keys(dataMap).filter(Boolean).sort();
      const values = labels.map(l=>dataMap[l]||0);
      const ctx = $("revenueChart").getContext("2d");
      if(revenueChart) revenueChart.destroy();
      revenueChart = new Chart(ctx,{
        type:"line",
        data:{ labels, datasets:[{ label:"Revenue", data:values, borderColor:"#3b82f6", tension:0.3 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{ grid:{display:false}}, y:{ ticks:{ callback:(v)=>"€"+v }}}}
      });
    }
    function updateStatusChart(counts){
      const labels = Object.keys(counts);
      const data = labels.map(k=>counts[k]||0);
      const ctx = $("invoiceStatusChart").getContext("2d");
      if(statusChart) statusChart.destroy();
      statusChart = new Chart(ctx,{
        type:"doughnut",
        data:{ labels, datasets:[{ data, backgroundColor:["#f59e0b","#3b82f6","#22c55e","#ef4444"]}]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}} }
      });
    }

    /* ---------------- Smart Suggestions ---------------- */
    function renderSuggestions(){
      const ul = $("suggestionsList"); ul.innerHTML="";
      const now = new Date();

      // 1) Overdue invoices
      const overdue = gInvoices.filter(i=>{
        if(i.status==="Paid") return false;
        const d = new Date(i.dueDate||"");
        return d.toString()!=="Invalid Date" && d < now;
      });
      if(overdue.length>0){
        ul.innerHTML += `<li>⏰ You have <b>${overdue.length}</b> overdue invoice(s). <a href="payment-reminder-list.html">Send reminders</a>.</li>`;
      }

      // 2) Low quote win-rate
      const acc = gQuotes.filter(q=>q.status==="Accepted").length;
      const rate = gQuotes.length ? Math.round(acc/gQuotes.length*100) : 0;
      if(gQuotes.length>=3 && rate<30){
        ul.innerHTML += `<li>📉 Quote win-rate is <b>${rate}%</b>. Try improving your quotes style or follow-up sooner.</li>`;
      }

      // 3) No expenses tracked yet
      if(gExpensesTotal===0){
        ul.innerHTML += `<li>💡 No expenses tracked yet. Use <a href="my-bookkeeper.html">My Bookkeeper</a> to manage costs.</li>`;
      }

      // 4) Old open quotes (age > 14 days)
      const oldOpen = gQuotes.filter(q=>{
        const d = new Date(q.quoteDate||"");
        if(d.toString()==="Invalid Date") return false;
        const age = (now - d)/(1000*3600*24);
        return (q.status==="Draft" || q.status==="Sent") && age>14;
      });
      if(oldOpen.length>0){
        ul.innerHTML += `<li>📬 You have <b>${oldOpen.length}</b> old open quote(s). Consider a friendly follow-up.</li>`;
      }

      // 5) Plan near limit
      if(gPlan==="FREE" && gUsageLimit && gUsageUsed>=Math.floor(gUsageLimit*0.8)){
        ul.innerHTML += `<li>🚀 You are close to Free plan limit (<b>${gUsageUsed}/${gUsageLimit}</b>). <a href="pricing.html">Upgrade to PRO</a>.</li>`;
      }

      if(!ul.innerHTML){
        ul.innerHTML = `<li>✅ All good! Keep it up 💙</li>`;
      }
    }

    /* ---------------- Events: Recent Activity ---------------- */
    function initRecentActivity(uid){
      try{
        const qy = query(collection(db,"users",uid,"events"), orderBy("createdAt","desc"));
        onSnapshot(qy,(snap)=>{
          const ul = $("activityList");
          ul.innerHTML="";
          if(snap.empty){ ul.innerHTML = "<li>— No recent activity yet —</li>"; return; }
          snap.docs.slice(0,5).forEach(d=>{
            const e = d.data();
            const when = e.createdAt?.toDate ? e.createdAt.toDate().toLocaleString() : "";
            const li = document.createElement("li");
            li.textContent = `${when} — ${e.type||"Event"} — ${e.message||""}`;
            ul.appendChild(li);
          });
        },(err)=>{
          console.warn("Events read error:", err);
          $("activityList").innerHTML = "<li>— Can't read events (check Firestore Rules). —</li>";
        });
      }catch(e){
        console.error("Events init failed:", e);
        $("activityList").innerHTML = "<li>— Recent Activity unavailable —</li>";
      }
    }

    /* ---------------- Plan usage & Create actions ---------------- */
    async function calcUsage(uid){
      const cols = ["invoices","quotes","reminders","contracts"];
      let total=0;
      for(const c of cols){ total += await countDocs(uid,c); }
      gUsageUsed = total;
      $("planUsage").innerText = gPlan==="PRO" ? "Unlimited" : `${gUsageUsed}/${gUsageLimit}`;
      $("planProgress").style.width = gPlan==="PRO" ? "100%" : `${Math.min(100, gUsageUsed/gUsageLimit*100)}%`;
    }

    async function createAction(url, type){
      const user = auth.currentUser;
      if(!user){ location.href="login.html"; return; }

      // оновити usage перед переходом
      await calcUsage(user.uid);
      if(gPlan==="FREE" && gUsageUsed>=gUsageLimit){
        alert("⚠️ Free plan limit reached (25 docs/month). Upgrade to PRO.");
        return;
      }

      // злогувати подію
      try{
        await addDoc(collection(db,"users",user.uid,"events"),{
          type: "Navigation",
          message: `Open ${type}`,
          createdAt: serverTimestamp()
        });
      }catch(e){
        console.warn("Event log failed:", e);
      }
      location.href = url;
    }
    window.createAction = createAction;

    /* ---------------- Logout ---------------- */
    $("logoutBtn").addEventListener("click", async()=>{
      await signOut(auth);
      location.href="login.html";
    });

    /* ---------------- MAIN INIT ---------------- */
    onAuthStateChanged(auth, async(user)=>{
      if(!user){ location.href="login.html"; return; }

      // Profile
      const psnap = await getDoc(doc(db,"users",user.uid));
      const profile = psnap.exists() ? psnap.data() : {};
      $("welcome").innerText = `Welcome, ${profile.fullName||"User"} 👋`;

      // Plan
      gPlan = (profile.plan||"FREE").toUpperCase();
      $("planName").innerText = gPlan;
      gUsageLimit = (gPlan==="PRO") ? Infinity : 25;
      await calcUsage(user.uid);

      // Invoices live
      onSnapshot(collection(db,"users",user.uid,"invoices"),(snap)=>{
        gInvoices = snap.docs.map(d=>d.data());
        const revenue = gInvoices.reduce((a,b)=>a+parseMoney(b.grandTotal),0);
        const unpaid  = gInvoices.filter(i=>i.status!=="Paid").reduce((a,b)=>a+parseMoney(b.grandTotal),0);
        const overdueCount = gInvoices.filter(i=>{
          if(i.status==="Paid") return false;
          const d = new Date(i.dueDate||"");
          return d.toString()!=="Invalid Date" && d < new Date();
        }).length;

        $("kpiRevenue").innerText = formatEUR(revenue);
        $("kpiUnpaid").innerText  = formatEUR(unpaid);
        $("kpiOverdue").innerText = overdueCount;

        // byMonth
        const byMonth = {};
        gInvoices.forEach(i=>{
          const key = (i.invoiceDate||"").substring(0,7);
          byMonth[key] = (byMonth[key]||0) + parseMoney(i.grandTotal);
        });
        updateRevenueChart(byMonth);

        // status
        const status = { Draft:0, Sent:0, Paid:0, Overdue:0 };
        gInvoices.forEach(i=>{
          if(i.status==="Paid") status.Paid++;
          else{
            const d = new Date(i.dueDate||"");
            if(d.toString()!=="Invalid Date" && d < new Date()) status.Overdue++;
            else status[i.status||"Draft"] = (status[i.status||"Draft"]||0)+1;
          }
        });
        updateStatusChart(status);

        // top client (по оплачених, якщо нема — по всіх)
        const byClientPaid={}, byClientAll={};
        gInvoices.forEach(i=>{
          const c = i.clientName||"—";
          byClientAll[c] = (byClientAll[c]||0) + parseMoney(i.grandTotal);
          if(i.status==="Paid"){ byClientPaid[c] = (byClientPaid[c]||0) + parseMoney(i.grandTotal); }
        });
        const pickTop = (map)=>Object.entries(map).sort((a,b)=>b[1]-a[1])[0]?.[0]||"—";
        $("kpiTopClient").innerText = pickTop(Object.keys(byClientPaid).length?byClientPaid:byClientAll);

        renderSuggestions();
      });

      // Quotes live
      onSnapshot(collection(db,"users",user.uid,"quotes"),(snap)=>{
        gQuotes = snap.docs.map(d=>d.data());
        const acc = gQuotes.filter(q=>q.status==="Accepted").length;
        const rate = gQuotes.length ? Math.round(acc/gQuotes.length*100) : 0;
        $("kpiQuoteRate").innerText = rate+"%";
        renderSuggestions();
      });

      // Reminders live
      onSnapshot(collection(db,"users",user.uid,"reminders"),(snap)=>{
        gReminders = snap.size;
        $("kpiReminders").innerText = gReminders;
      });

      // Expenses live
      onSnapshot(collection(db,"users",user.uid,"expenses"),(snap)=>{
        gExpensesTotal = snap.docs.reduce((a,d)=>a+(parseMoney(d.data().amount)),0);
        $("kpiExpenses").innerText = formatEUR(gExpensesTotal);
        renderSuggestions();
      });

      // Recent Activity
      initRecentActivity(user.uid);
    });
  </script>
</body>
</html>
