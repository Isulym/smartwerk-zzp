<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>SmartWerk ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0e1014; --card:#151823; --muted:#9aa3b2; --ok:#27c693; --warn:#ffb020; --err:#ff5470; --line:#22283a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:#e9edf5;background:radial-gradient(1200px 600px at 10% -10%,#1d2233 0%,#0e1014 40%),linear-gradient(#0e1014,#0e1014)}
    .wrap{max-width:1100px;margin:0 auto;padding:28px}
    .topbar{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{font-weight:700;font-size:20px;letter-spacing:.3px;text-decoration:none;color:inherit}
    .right{display:flex;gap:10px;align-items:center}
    .badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .badge.pro{background:linear-gradient(90deg,#ffdf6b,#ffb020);color:#1c1200}
    .badge.free{background:#2a3147;color:#c9d2e3;border:1px solid #3a425e}
    .btn{background:#2b3350;border:1px solid #3b4567;color:#e9edf5;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;font-weight:600;display:inline-block}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:#3b79ff;border-color:#4d86ff}
    .btn.danger{background:#4a2330;border-color:#6a2c40}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .card{background:linear-gradient(180deg,#161b28,#141827);border:1px solid #232a42;border-radius:16px;padding:18px}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-top:10px}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .warn{color:var(--warn)} .ok{color:var(--ok)} .err{color:var(--err)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a href="index.html" class="brand">üíº SmartWerk ‚Äî Dashboard</a>
      <div class="right">
        <a href="index.html" class="btn" id="btnHome">Main page</a>
        <span id="planBadge" class="badge free">FREE</span>
        <button id="btnLogout" class="btn danger">Logout</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>üë§ User Profile</h3>
        <div class="muted" id="userEmailTop">‚Äî</div>
        <div class="kv">
          <div class="muted">Name</div><div id="fullName">‚Äî</div>
          <div class="muted">Email</div><div id="emailKv">‚Äî</div>
          <div class="muted">Address</div><div id="address">‚Äî</div>
          <div class="muted">KvK</div><div id="kvk">‚Äî</div>
          <div class="muted">IBAN</div><div id="iban">‚Äî</div>
          <div class="muted">Phone</div><div id="phone">‚Äî</div>
          <div class="muted">Plan</div><div id="planText">Free</div>
        </div>
        <div class="sep"></div>
        <div class="row">
          <button id="btnProfile" class="btn">Edit profile</button>
          <button id="btnUpgrade" class="btn primary">Upgrade to PRO</button>
        </div>
      </div>

      <div class="card">
        <h3>‚öôÔ∏è Plan & Limits</h3>
        <div class="muted">Free plan: up to 3 invoices, no PDF/Excel export, no SmartWerk AI</div>
        <div class="sep"></div>
        <div class="kv">
          <div class="muted">Invoices created</div><div id="invCount">0</div>
          <div class="muted">Limit</div><div id="invLimit">3</div>
          <div class="muted">Status</div><div id="limitStatus" class="ok">OK</div>
        </div>
        <div class="sep"></div>
        <div class="row">
          <button id="btnOpenCalculator" class="btn">üßæ Tax Calculator</button>
          <button id="btnOpenInvoices" class="btn">üìÇ Invoice Manager</button>
          <button id="btnShowAI" class="btn">üîÆ Ask SmartWerk AI</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>üîî Notices</h3>
      <div id="noticeArea" class="muted">‚Äî</div>
    </div>
  </div>

  <section id="smartwerkAiSection" style="display:none; margin:20px 28px 40px;">
    <h2>üß† Ask SmartWerk AI ‚Äì Documents</h2>
    <p>You can ask your accountant assistant about uploaded invoices, KvK, taxes and more.</p>
    <iframe src="https://www.chatbase.co/chatbot-iframe/uy7T8ni8Hnk8A2Hb3onls" width="100%" height="500" frameborder="0" style="border:1px solid #ccc; border-radius: 8px;"></iframe>
  </section>

  <script type="module">
    // üîß Firebase config (—Ç–≤—ñ–π)
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== Helpers & refs
    const $ = (id)=>document.getElementById(id);
    const elEmailTop = $("userEmailTop");
    const elEmailKv  = $("emailKv");
    const elFullName = $("fullName");
    const elAddress  = $("address");
    const elKvk      = $("kvk");
    const elIban     = $("iban");
    const elPhone    = $("phone");
    const elPlanText = $("planText");
    const elPlanBadge= $("planBadge");
    const elInvCount = $("invCount");
    const elInvLimit = $("invLimit");
    const elLimitStatus = $("limitStatus");
    const elNotice   = $("noticeArea");
    const FREE_LIMIT = 3;

    let liveIsPro = false;
    let liveInvoiceCount = 0;

    function bindClickSafe(id, handler){
      const el = $(id);
      if (!el) return;
      if (el.dataset.bound === "1") return;
      el.dataset.bound = "1";
      el.addEventListener("click", (e)=>{ e.preventDefault(); handler(e, el); });
    }

    // üîí Logout ‚Äî –æ–¥—Ä–∞–∑—É, –ø–æ–∑–∞ onAuthStateChanged
    bindClickSafe('btnLogout', async (_e, btn) => {
      try {
        btn.disabled = true;
        const old = btn.textContent; btn.textContent = 'Logging out‚Ä¶';
        await signOut(auth);
      } catch(e){ console.error('[Logout]', e); }
      finally { window.location.replace('login.html'); }
    });

    function renderPlan(isPro){
      elPlanText.textContent = isPro ? "PRO" : "Free";
      elPlanBadge.textContent = isPro ? "PRO" : "FREE";
      elPlanBadge.classList.toggle("pro", isPro);
      elPlanBadge.classList.toggle("free", !isPro);
    }
    function renderLimits(isPro, invoiceCount){
      elInvCount.textContent = invoiceCount;
      elInvLimit.textContent = isPro ? "Unlimited" : FREE_LIMIT;
      if (isPro) { elLimitStatus.textContent = "Unlimited"; elLimitStatus.className = "ok"; }
      else {
        const left = Math.max(0, FREE_LIMIT - invoiceCount);
        elLimitStatus.textContent = left > 0 ? `OK ‚Äî ${left} left` : "Limit reached";
        elLimitStatus.className = left > 0 ? "ok" : "warn";
      }
    }

    // üîê Guard + –ø—Ä–æ—Ñ—ñ–ª—å
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.replace("login.html"); return; }
      if (elEmailTop) elEmailTop.textContent = user.email || "‚Äî";
      if (elEmailKv)  elEmailKv.textContent  = user.email || "‚Äî";

      try {
        const userRef = doc(db, "users", user.uid);
        // –Ø–∫—â–æ –¥–æ–∫—É–º–µ–Ω—Ç—É –Ω–µ–º–∞—î ‚Äî —Å—Ç–≤–æ—Ä–∏–º–æ –±–∞–∑–æ–≤–∏–π
        const firstSnap = await getDoc(userRef);
        if (!firstSnap.exists()) {
          await setDoc(userRef, { email:user.email||"", pro:false, fullName:"", address:"", kvk:"", iban:"", phone:"", invoiceCount:0 });
        }

        // LIVE-–ø—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ª—ñ–º—ñ—Ç–∏/–ø–ª–∞–Ω/–ø—Ä–æ—Ñ—ñ–ª—å
        onSnapshot(userRef, (snap) => {
          if (!snap.exists()) return;
          const data = snap.data() || {};
          liveIsPro = !!data.pro;
          liveInvoiceCount = Number.isFinite(data.invoiceCount) ? data.invoiceCount : 0;

          if (elFullName) elFullName.textContent = data.fullName || "‚Äî";
          if (elAddress)  elAddress.textContent  = data.address  || "‚Äî";
          if (elKvk)      elKvk.textContent      = data.kvk      || "‚Äî";
          if (elIban)     elIban.textContent     = data.iban     || "‚Äî";
          if (elPhone)    elPhone.textContent    = data.phone    || "‚Äî";

          renderPlan(liveIsPro);
          renderLimits(liveIsPro, liveInvoiceCount);
        });
      } catch (e) {
        console.error('[Profile] load error:', e);
        if (elNotice) elNotice.textContent = "Failed to load profile. Try reload.";
      }
    });

    // üîó –ù–∞–≤—ñ–≥–∞—Ü—ñ—è/–µ–∫—à–µ–Ω–∏
    bindClickSafe('btnProfile', () => location.href = "profile.html");
    bindClickSafe('btnUpgrade', async () => {
      if (liveIsPro) { if (elNotice) elNotice.textContent = "–£ –≤–∞—Å –≤–∂–µ PRO."; return; }
      const user = auth.currentUser; if (!user) return;
      await updateDoc(doc(db,"users",user.uid), { pro:true });
      if (elNotice) elNotice.textContent = "‚úÖ –ü–ª–∞–Ω –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–æ PRO. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é...";
      setTimeout(()=>location.reload(), 800);
    });
    bindClickSafe('btnOpenCalculator', () => location.href = "calculator.html");
    bindClickSafe('btnOpenInvoices', () => {
      if (!liveIsPro && liveInvoiceCount >= FREE_LIMIT) {
        if (elNotice) elNotice.innerHTML = "‚ùó Free-–ª—ñ–º—ñ—Ç –≤–∏—á–µ—Ä–ø–∞–Ω–æ. <b>Upgrade to PRO</b> –¥–ª—è –±–µ–∑–ª—ñ–º—ñ—Ç—É.";
        return;
      }
      location.href = "invoices.html#autofill=1";
    });
    bindClickSafe('btnShowAI', () => {
      const s = document.getElementById("smartwerkAiSection");
      if (!s) return;
      const show = s.style.display !== "block";
      s.style.display = show ? "block" : "none";
      if (show) window.scrollTo({ top: s.offsetTop, behavior: "smooth" });
    });
  </script>
</body>
</html>
