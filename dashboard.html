<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="page_title">SmartWerk â€” Dashboard</title>
  <link rel="stylesheet" href="style-dashboard.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<button id="toggleSidebar" class="toggle-button" data-i18n="toggle_menu">ğŸ“‚ Menu</button>
<div class="dashboard">
  <aside class="sidebar">
    <header>
      <img src="image.png" alt="SmartWerk Logo" width="240" height="130" />
    </header>
    <nav>
      <a href="index.html" class="btn-primary" data-i18n="home">â† Home</a>
      <a href="dashboard.html" class="btn btn-primary" id="backDashboardBtn" data-i18n="back_dashboard">ğŸ  Back to Dashboard</a>

      <button class="accordion" data-key="clients" data-i18n="clients">ğŸ‘¥ Clients â–¸</button>
      <div class="panel">
        <a href="clients.html" data-i18n="create_client">â• Create Client</a>
        <a href="clients-list.html" data-i18n="saved_clients">ğŸ“‹ Saved Clients</a>
      </div>

      <button class="accordion" data-key="invoices" data-i18n="invoices">ğŸ’° Invoices â–¸</button>
      <div class="panel">
        <a href="invoices.html" data-i18n="create_invoice">â• Create Invoice</a>
        <a href="invoices-list.html" data-i18n="saved_invoices">ğŸ“‹ Saved Invoices</a>
      </div>

      <button class="accordion" data-key="quotes" data-i18n="quotes">ğŸ“‘ Quotes â–¸</button>
      <div class="panel">
        <a href="quote-offer.html" data-i18n="create_quote">â• Create Quote</a>
        <a href="quote-offer-list.html" data-i18n="saved_quotes">ğŸ“‹ Saved Quotes</a>
      </div>

      <button class="accordion" data-key="contracts" data-i18n="contracts">ğŸ“ƒ Contracts â–¸</button>
      <div class="panel">
        <a href="Freelance-Contract.html" data-i18n="create_contract">â• Create Contract</a>
        <a href="Freelance-Contract-list.html" data-i18n="saved_contracts">ğŸ“‹ Saved Contracts</a>
      </div>

      <button class="accordion" data-key="reminders" data-i18n="reminders">ğŸ“¬ Reminders â–¸</button>
      <div class="panel">
        <a href="payment-reminder.html" data-i18n="create_reminder">â• Create Reminder</a>
        <a href="payment-reminder-list.html" data-i18n="saved_reminders">ğŸ“‹ Saved Reminders</a>
      </div>

      <button class="accordion" data-key="expense_csv" data-i18n="expense_csv">ğŸ§® Expense CSV â–¸</button>
      <div class="panel">
        <a href="expense-csv.html" data-i18n="create_expense">â• Create Expense</a>
        <a href="expense-csv-list.html" data-i18n="saved_expenses">ğŸ“‹ Saved Expenses</a>
      </div>

      <button class="accordion" data-key="analytics" data-i18n="analytics">ğŸ“Š Analytics â–¸</button>
      <div class="panel">
        <a href="my-bookkeeper.html" data-i18n="my_bookkeeper">ğŸ† My Bookkeeper</a>
        <a href="summary.html" data-i18n="summary">ğŸ“Š Summary</a>
        <a href="roi-estimator.html" data-i18n="roi_estimator">ğŸ“ˆ ROI Estimator</a>
      </div>

      <button class="accordion" data-key="tax_assistant" data-i18n="tax_assistant">ğŸ§® Tax Assistant â–¸</button>
      <div class="panel">
        <a href="tax-calculator.html" data-i18n="tax_calculator">ğŸ§® Tax Calculator</a>
        <a href="mybusiness.html" data-i18n="tax_analytics">ğŸ“Š Tax Analytics</a>
        <a href="tax-guide.html" data-i18n="tax_guide">ğŸ“‚ Tax Guide</a>
      </div>

      <button class="accordion" data-key="templates" data-i18n="templates">ğŸ“‚ Templates â–¸</button>
      <div class="panel">
        <a href="email-gemeente.html" data-i18n="email_gemeente">ğŸ“© Email to Gemeente</a>
        <a href="cv.html" data-i18n="cv_portfolio">ğŸ“„ CV / Portfolio</a>
        <a href="ai-assistant.html" data-i18n="ai_assistant">ğŸ¤– AI Assistant (PRO)</a>
      </div>

      <button class="accordion" data-key="settings" data-i18n="settings">âš™ï¸ Settings â–¸</button>
      <div class="panel">
        <a href="profile.html" data-i18n="profile">ğŸ‘¤ Profile</a>
       <button onclick="toggleTheme()" class="btn" data-i18n="toggle_theme">ğŸŒ“ Toggle Theme</button>
      </div>

      <button class="accordion" data-key="help" data-i18n="help">â“ Help â–¸</button>
      <div class="panel">
        <a href="pricing.html" data-i18n="upgrade_pro">ğŸ’³ Upgrade to PRO</a>
        <a href="mailto:smartwerk.team@gmail.com" data-i18n="contact_support">ğŸ“§ Contact Support</a>
      </div>

      <button id="logoutBtn" class="logout" data-i18n="logout">ğŸšª Logout</button>
    </nav>
  </aside>

  <main class="main">
    <header class="topbar">
      <h1 id="welcome" data-i18n="welcome">Welcome ğŸ‘‹</h1>
      <div class="plan-box">
        <span id="planName" class="badge" data-i18n="plan_free">FREE</span>
        <div class="progress-bar"><div id="planProgress"></div></div>
        <small id="planUsage">0/25</small>
        <a href="pricing.html" class="upgrade-btn" data-i18n="upgrade_pro">Upgrade to PRO</a>
      </div>
      <select id="languageSwitcher" class="btn">
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="pl">ğŸ‡µğŸ‡± Polski</option>
        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
      </select>
    </header>

    <section class="quick-actions">
      <button onclick="createAction('clients.html','clients')" data-i18n="quick_clients">â• Clients</button>
      <button onclick="createAction('invoices.html','Invoice')" data-i18n="quick_invoice">â• Invoice</button>
      <button onclick="createAction('quote-offer.html','Quote')" data-i18n="quick_quote">â• Quote</button>
      <button onclick="createAction('Freelance-Contract.html','Contract')" data-i18n="quick_contract">â• Contract</button>
      <button onclick="createAction('payment-reminder.html','Reminder')" data-i18n="quick_reminder">â• Reminder</button>
    </section>

    <section class="kpi-grid">
      <div class="kpi-card"><h3 data-i18n="revenue">ğŸ’° Revenue</h3><p id="kpiRevenue">â‚¬0</p></div>
      <div class="kpi-card"><h3 data-i18n="unpaid">ğŸ“„ Unpaid</h3><p id="kpiUnpaid">â‚¬0</p></div>
      <div class="kpi-card"><h3 data-i18n="quote_rate">ğŸ“Š Quote Win-Rate</h3><p id="kpiQuoteRate">0%</p></div>
      <div class="kpi-card"><h3 data-i18n="reminders_sent">ğŸ’¸ Reminders Sent</h3><p id="kpiReminders">0</p></div>
      <div class="kpi-card"><h3 data-i18n="expenses">ğŸ“‰ Expenses</h3><p id="kpiExpenses">â‚¬0</p></div>
      <div class="kpi-card"><h3 data-i18n="overdue">â° Overdue</h3><p id="kpiOverdue">0</p></div>
      <div class="kpi-card"><h3 data-i18n="top_client">ğŸ‘¥ Top Client</h3><p id="kpiTopClient">â€”</p></div>
    </section>

    <section class="charts">
      <div class="chart-box"><canvas id="revenueChart"></canvas></div>
      <div class="chart-box"><canvas id="invoiceStatusChart"></canvas></div>
    </section>

    <section class="suggestions">
      <h2 data-i18n="smart_suggestions">ğŸ’¡ Smart Suggestions</h2>
      <ul id="suggestionsList">
        <li data-i18n="suggestion_all_good">âœ… All good. Keep it up!</li>
      </ul>
    </section>

    <section class="activity">
      <h2 data-i18n="recent_activity">ğŸ•’ Recent Activity</h2>
      <ul id="activityList">
        <li data-i18n="loading">Loading...</li>
      </ul>
    </section>
  </main>
</div> <!-- End of .dashboard -->
  
  <!-- Firebase + Theme + Sidebar Logic -->
<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, collection, onSnapshot, query, orderBy,
    addDoc, serverTimestamp, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = getApps().length ? getApp() : initializeApp({
    apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
    authDomain: "smartwerk8520.firebaseapp.com",
    projectId: "smartwerk8520",
    appId: "1:607670981972:web:c07103c981c86860d724c1"
  });
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const $ = id => document.getElementById(id);

  let gInvoices = [], gQuotes = [], gReminders = 0, gExpensesTotal = 0, gRevenue = 0;
  let gPlan = "FREE", gUsageLimit = 25;

  function formatEUR(n) {
    return "â‚¬" + (parseFloat(n || 0)).toFixed(2);
  }

  async function countDocs(uid, coll) {
    const snap = await getDocs(collection(db, "users", uid, coll));
    return snap.size;
  }

  function updateChart(canvasId, labels, data, type = "line") {
  const lang = localStorage.getItem("language") || "en";
  const t = window.translations?.[lang] || {};
  // Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´ labels, ÑĞºÑ‰Ğ¾ Ñ–ÑĞ½ÑƒÑ” t.chart_labels
  const translatedLabels = labels.map(label =>
    t?.chart_labels?.[label.toLowerCase()] || label
  );

  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type,
    data: {
      labels: translatedLabels,
      datasets: [{
        data,
        backgroundColor: ["#3b82f6", "#10b981", "#f59e0b", "#ef4444"],
        borderColor: "#3b82f6",
        label: type === "doughnut" ? undefined : t?.chart_title || "Revenue",
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: type === "doughnut" } }
    }
  });
}

  function updateSuggestions() {
  const lang = localStorage.getItem("language") || "en";
  const t = window.translations?.[lang] || {};
  const ul = $("suggestionsList");
  ul.innerHTML = "";

  // Ğ Ğ¾Ğ·Ñ€Ğ°Ñ…ÑƒĞ½Ğ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ¾Ñ‡ĞµĞ½Ğ¸Ñ… Ñ–Ğ½Ğ²Ğ¾Ğ¹ÑÑ–Ğ²
  let overdue = gInvoices.filter(i => {
    const d = new Date(i.dueDate || "");
    return i.status !== "Paid" && d.toString() !== "Invalid Date" && d < new Date();
  }).length;

  // ğŸ“Œ 1. Overdue invoices
  if (overdue > 0 && t.suggestion_overdue_invoices) {
    ul.innerHTML += `<li>${t.suggestion_overdue_invoices.replace("{count}", overdue)}</li>`;
  }

  // âš ï¸ 2. No reminders sent
  if (gReminders === 0 && overdue > 0 && t.suggestion_no_reminders) {
    ul.innerHTML += `<li>${t.suggestion_no_reminders}</li>`;
  }

  // ğŸ“‰ 3. Low win rate
  const lowRate = gQuotes.length && gQuotes.filter(q => q.status === "Accepted").length / gQuotes.length < 0.3;
  if (lowRate && t.suggestion_low_winrate) {
    ul.innerHTML += `<li>${t.suggestion_low_winrate}</li>`;
  }

  // ğŸ“Š 4. Expenses > Revenue
  if (gExpensesTotal > gRevenue && t.suggestion_expenses_over) {
    ul.innerHTML += `<li>${t.suggestion_expenses_over}</li>`;
  }

  // âœ… 5. Ğ¯ĞºÑ‰Ğ¾ Ğ²ÑĞµ Ğ´Ğ¾Ğ±Ñ€Ğµ
  if (ul.innerHTML === "" && t.suggestion_all_good) {
    ul.innerHTML = `<li>${t.suggestion_all_good}</li>`;
  }
}

  async function createAction(url, type) {
    const user = auth.currentUser;
    if (!user) return location.href = "login.html";
    const total = await countDocs(user.uid, "invoices") +
                  await countDocs(user.uid, "quotes") +
                  await countDocs(user.uid, "contracts") +
                  await countDocs(user.uid, "reminders");
    if (gPlan === "FREE" && total >= gUsageLimit)
      return alert("âš ï¸ Free plan limit reached. Upgrade to PRO.");
    await addDoc(collection(db, "users", user.uid, "events"), {
      type: "Navigation", message: `Created ${type}`, createdAt: serverTimestamp()
    });
    location.href = url;
  }
  window.createAction = createAction;

  onAuthStateChanged(auth, async user => {
   const selectedLang = localStorage.getItem("language") || "en";
    const t = window.translations?.[selectedLang] || {};
    if (!user) return location.href = "login.html";
    const profileSnap = await getDoc(doc(db, "users", user.uid));
    const profile = profileSnap.exists() ? profileSnap.data() : {};
    $("welcome").textContent = `${t.welcome || "Welcome"}, ${profile.fullName || "User"} ğŸ‘‹`;
    gPlan = (profile.plan || "FREE").toUpperCase();
    $("planName").textContent = gPlan;
    gUsageLimit = gPlan === "PRO" ? Infinity : 25;

    $("planUsage").textContent = gPlan === "PRO" ? "Unlimited" : "0/" + gUsageLimit;

    onSnapshot(collection(db, "users", user.uid, "invoices"), snap => {
      gInvoices = snap.docs.map(d => d.data());
      gRevenue = gInvoices.reduce((a, b) => a + parseFloat(b.grandTotal || 0), 0);
      const unpaid = gInvoices.filter(i => i.status !== "Paid")
                               .reduce((a, b) => a + parseFloat(b.grandTotal || 0), 0);
      const overdue = gInvoices.filter(i => new Date(i.dueDate) < new Date() && i.status !== "Paid").length;
      const byMonth = {};
      gInvoices.forEach(i => {
        const m = (i.invoiceDate || "").slice(0, 7);
        byMonth[m] = (byMonth[m] || 0) + parseFloat(i.grandTotal || 0);
      });
      const byStatus = { Draft: 0, Sent: 0, Paid: 0, Overdue: 0 };
      gInvoices.forEach(i => {
        const due = new Date(i.dueDate);
        if (i.status === "Paid") byStatus.Paid++;
        else if (due.toString() !== "Invalid Date" && due < new Date()) byStatus.Overdue++;
        else byStatus[i.status || "Draft"]++;
      });

      $("kpiRevenue").textContent = formatEUR(gRevenue);
      $("kpiUnpaid").textContent = formatEUR(unpaid);
      $("kpiOverdue").textContent = overdue;
      $("kpiTopClient").textContent = gInvoices.reduce((top, curr) =>
        parseFloat(curr.grandTotal || 0) > parseFloat(top.amount || 0)
          ? { name: curr.clientName, amount: curr.grandTotal }
          : top, { name: "â€”", amount: 0 }).name;

      updateChart("revenueChart", Object.keys(byMonth), Object.values(byMonth));
      updateChart("invoiceStatusChart", Object.keys(byStatus), Object.values(byStatus), "doughnut");
      updateSuggestions();
    });

    onSnapshot(collection(db, "users", user.uid, "quotes"), snap => {
      gQuotes = snap.docs.map(d => d.data());
      const accepted = gQuotes.filter(q => q.status === "Accepted").length;
      const rate = gQuotes.length ? Math.round(accepted / gQuotes.length * 100) : 0;
      $("kpiQuoteRate").textContent = `${rate}%`;
      updateSuggestions();
    });

    onSnapshot(collection(db, "users", user.uid, "reminders"), snap => {
      gReminders = snap.size;
      $("kpiReminders").textContent = gReminders;
      updateSuggestions();
    });

    onSnapshot(collection(db, "users", user.uid, "expenses"), snap => {
      gExpensesTotal = snap.docs.reduce((sum, d) => sum + parseFloat(d.data().amount || 0), 0);
      $("kpiExpenses").textContent = formatEUR(gExpensesTotal);
      updateSuggestions();
    });

    onSnapshot(query(collection(db, "users", user.uid, "events"), orderBy("createdAt", "desc")), snap => {
  const lang = localStorage.getItem("language") || "en";
  const t = window.translations?.[lang] || {};

  const ul = $("activityList");
  ul.innerHTML = "";

  snap.docs.slice(0, 5).forEach(doc => {
    const e = doc.data();
    const date = e.createdAt?.toDate?.().toLocaleString?.() || "â€”";

    const typeTranslated = t.activity_types?.[e.type?.toLowerCase()] || e.type || "Event";
    const msgTranslated = t.activity_messages?.[e.message?.toLowerCase()] || e.message || "";

    const li = document.createElement("li");
    li.textContent = `${date} â€” ${typeTranslated} â€” ${msgTranslated}`;
    ul.appendChild(li);
  });
});
  });

  $("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    location.href = "login.html";
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===== Theme toggle =====
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('theme-dark');
  }

  // ===== Sidebar toggle =====
  const sidebar = document.querySelector(".sidebar");
  const dashboard = document.querySelector(".dashboard");
  const toggleBtn = document.getElementById("toggleSidebar");

  if (!sidebar || !dashboard || !toggleBtn) {
    console.error("âŒ ĞĞµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¸ Ğ´Ğ»Ñ sidebar toggle");
    return;
  }

  // Ğ’Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
  if (localStorage.getItem("sidebarCollapsed") === "true") {
    dashboard.classList.add("collapsed-sidebar");
  }

  toggleBtn.addEventListener("click", () => {
  sidebar.classList.toggle("collapsed");
  dashboard.classList.toggle("collapsed-sidebar");

  const isCollapsed = sidebar.classList.contains("collapsed");
  localStorage.setItem("sidebarCollapsed", isCollapsed);
});

  // ===== Accordion =====
  function setArrow(btn, open) {
    const base = btn.textContent.replace(/(â–¸|â–¾)$/, '').trim();
    btn.textContent = base + (open ? ' â–¾' : ' â–¸');
  }

  function toggleAccordion(btn) {
    const panel = btn.nextElementSibling;
    const alreadyOpen = btn.classList.contains("open");

    // Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ²ÑÑ–
    document.querySelectorAll(".accordion").forEach(b => {
      b.classList.remove("open");
      setArrow(b, false);
      const p = b.nextElementSibling;
      if (p) p.style.maxHeight = null;
    });

    // Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸, ÑĞºÑ‰Ğ¾ Ğ½Ğµ Ğ±ÑƒĞ»Ğ¾ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¾
    if (!alreadyOpen) {
      btn.classList.add("open");
      setArrow(btn, true);
      panel.style.maxHeight = panel.scrollHeight + "px";
      localStorage.setItem("sw_open_group", btn.dataset.key || "");
    } else {
      localStorage.removeItem("sw_open_group");
    }
  }

  // ĞŸÑ€Ğ¸Ğ²'ÑĞ·ĞºĞ°
  document.querySelectorAll(".accordion").forEach(btn => {
    btn.addEventListener("click", () => toggleAccordion(btn));
  });

  // Ğ’Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ–Ğ¹ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸Ğ¹
  const remembered = localStorage.getItem("sw_open_group");
  if (remembered) {
    const btn = document.querySelector(`.accordion[data-key="${remembered}"]`);
    if (btn && btn.nextElementSibling) {
      btn.classList.add("open");
      setArrow(btn, true);
      btn.nextElementSibling.style.maxHeight = btn.nextElementSibling.scrollHeight + "px";
    }
  }
});

// ===== Theme Toggle â€” Ğ¾ĞºÑ€ĞµĞ¼Ğ¾, Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° =====
 function applyTheme(theme) {
    document.body.classList.remove('theme-light', 'theme-dark');
    document.body.classList.add(theme);
  }

  function toggleTheme() {
    const currentTheme = document.body.classList.contains('theme-dark') ? 'theme-dark' : 'theme-light';
    const newTheme = currentTheme === 'theme-dark' ? 'theme-light' : 'theme-dark';
    applyTheme(newTheme);
    localStorage.setItem('theme', newTheme);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem('theme') || 'theme-dark';
    applyTheme(savedTheme);
  });
  
</script>
   <script src="lang.js"></script>
</body>
</html>
