<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartWerk Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ‚úÖ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —Å—É—á–∞—Å–Ω–∏–π —Å—Ç–∏–ª—å -->
  <style>
    :root { --bg:#0e1014; --card:#151823; --muted:#9aa3b2; --ok:#27c693; --warn:#ffb020; --err:#ff5470; --line:#22283a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:#e9edf5;background:radial-gradient(1200px 600px at 10% -10%,#1d2233 0%,#0e1014 40%),linear-gradient(#0e1014,#0e1014)}
    .wrap{max-width:1100px;margin:0 auto;padding:28px}
    .topbar{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{font-weight:700;font-size:20px;letter-spacing:.3px}
    .right{display:flex;gap:10px;align-items:center}
    .badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .badge.pro{background:linear-gradient(90deg,#ffdf6b,#ffb020);color:#1c1200}
    .badge.free{background:#2a3147;color:#c9d2e3;border:1px solid #3a425e}
    .btn{background:#2b3350;border:1px solid #3b4567;color:#e9edf5;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:#3b79ff;border-color:#4d86ff}
    .btn.danger{background:#4a2330;border-color:#6a2c40}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .card{background:linear-gradient(180deg,#161b28,#141827);border:1px solid #232a42;border-radius:16px;padding:18px}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-top:10px}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{border:1px solid #2b3350;background:#171b29;padding:8px 10px;border-radius:10px;font-size:13px}
    .warn{color:var(--warn)} .ok{color:var(--ok)} .err{color:var(--err)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">üíº SmartWerk ‚Äî Dashboard</div>
      <div class="right">
        <span id="planBadge" class="badge free">FREE</span>
        <button id="btnLogout" class="btn danger">Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- –ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ -->
      <div class="card">
        <h3>üë§ User Profile</h3>
        <div class="muted" id="userEmailTop">‚Äî</div>
        <div class="kv">
          <div class="muted">Name</div><div id="fullName">‚Äî</div>
          <div class="muted">Email</div><div id="emailKv">‚Äî</div>
          <div class="muted">Address</div><div id="address">‚Äî</div>
          <div class="muted">KvK</div><div id="kvk">‚Äî</div>
          <div class="muted">IBAN</div><div id="iban">‚Äî</div>
          <div class="muted">Phone</div><div id="phone">‚Äî</div>
          <div class="muted">Plan</div><div id="planText">Free</div>
        </div>
        <div class="sep"></div>
        <div class="row">
          <button id="btnProfile" class="btn">Edit profile</button>
          <button id="btnUpgrade" class="btn primary">Upgrade to PRO</button>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç—É—Å –ª—ñ–º—ñ—Ç—ñ–≤ / —à–≤–∏–¥–∫—ñ –¥—ñ—ó -->
      <div class="card">
        <h3>‚öôÔ∏è Plan & Limits</h3>
        <div class="muted">Free-–ø–ª–∞–Ω: –¥–æ 3 —ñ–Ω–≤–æ–π—Å—ñ–≤, –±–µ–∑ –µ–∫—Å–ø–æ—Ä—Ç—É PDF/Excel, –±–µ–∑ SmartWerk AI</div>
        <div class="sep"></div>
        <div class="kv">
          <div class="muted">Invoices created</div><div id="invCount">0</div>
          <div class="muted">Limit</div><div id="invLimit">3</div>
          <div class="muted">Status</div><div id="limitStatus" class="ok">OK</div>
        </div>
        <div class="sep"></div>
        <div class="row">
          <button id="btnOpenInvoices" class="btn">Open Invoices</button>
          <button id="btnOpenCalculator" class="btn">Open Tax Calculator</button>
          <button id="btnUseAI" class="btn">SmartWerk AI</button>
        </div>
      </div>
    </div>

    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ –ø–ª–∞—à–∫–∏ -->
    <div class="card" style="margin-top:16px">
      <h3>üîî Notices</h3>
      <div id="noticeArea" class="muted">‚Äî</div>
    </div>
  </div>

  <!-- Firebase SDK (module imports) -->
  <script type="module">
    // ‚ö†Ô∏è –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ —Å–≤–æ—ó –∑–Ω–∞—á–µ–Ω–Ω—è –∑ Firebase Console
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const $ = (id)=>document.getElementById(id);
    const elEmailTop = $("userEmailTop");
    const elEmailKv = $("emailKv");
    const elFullName = $("fullName");
    const elAddress = $("address");
    const elKvk = $("kvk");
    const elIban = $("iban");
    const elPhone = $("phone");
    const elPlanText = $("planText");
    const elPlanBadge = $("planBadge");
    const elInvCount = $("invCount");
    const elInvLimit = $("invLimit");
    const elLimitStatus = $("limitStatus");
    const elNotice = $("noticeArea");

    const FREE_LIMIT = 3;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "login.html";
        return;
      }

      // email –∑ Auth
      elEmailTop.textContent = user.email || "‚Äî";
      elEmailKv.textContent = user.email || "‚Äî";

      const userRef = doc(db, "users", user.uid);
      let snap = await getDoc(userRef);

      if (!snap.exists()) {
        // —Å—Ç–≤–æ—Ä—é—î–º–æ –±–∞–∑–æ–≤–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –∑ –Ω–æ–≤–∏–º–∏ –ø–æ–ª—è–º–∏
        await setDoc(userRef, {
          email: user.email || "",
          pro: false,
          fullName: "",
          address: "",
          kvk: "",
          iban: "",
          phone: "",
          invoiceCount: 0
        });
        snap = await getDoc(userRef);
      }

      const data = snap.data() || {};
      const isPro = !!data.pro;
      const invoiceCount = Number.isFinite(data.invoiceCount) ? data.invoiceCount : 0;

      // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Ñ—ñ–ª—é
      elFullName.textContent = data.fullName || "‚Äî";
      elAddress.textContent = data.address || "‚Äî";
      elKvk.textContent = data.kvk || "‚Äî";
      elIban.textContent = data.iban || "‚Äî";
      elPhone.textContent = data.phone || "‚Äî";

      // –†–µ–Ω–¥–µ—Ä –ø–ª–∞–Ω—É
      renderPlan(isPro);
      renderLimits(isPro, invoiceCount);

      // –î—ñ—ó
      $("btnLogout").onclick = () => signOut(auth).then(()=>location.href="login.html");
      $("btnProfile").onclick = () => location.href = "profile.html";
      $("btnOpenInvoices").onclick = () => {
        if (!canUseInvoices(isPro, invoiceCount)) {
          elNotice.innerHTML = "‚ùó –í–∏ –Ω–∞ Free-–ø–ª–∞–Ω—ñ —Ç–∞ –¥–æ—Å—è–≥–ª–∏ –ª—ñ–º—ñ—Ç—É —ñ–Ω–≤–æ–π—Å—ñ–≤. <b>Upgrade to PRO</b> –¥–ª—è –±–µ–∑–ª—ñ–º—ñ—Ç—É.";
          return;
        }
        location.href = "invoices.html";
      };
      $("btnOpenCalculator").onclick = () => { location.href = "calculator.html"; };
      $("btnUseAI").onclick = () => {
        if (!isPro) {
          elNotice.innerHTML = "ü§ñ SmartWerk AI –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –≤ PRO –ø–ª–∞–Ω—ñ.";
          return;
        }
        location.href = "ai-assistant.html";
      };

      $("btnUpgrade").onclick = async () => {
        if (isPro) { elNotice.textContent = "–£ –≤–∞—Å –≤–∂–µ PRO."; return; }
        await updateDoc(userRef, { pro: true });
        elNotice.textContent = "‚úÖ –ü–ª–∞–Ω –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–æ PRO. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é...";
        setTimeout(()=>location.reload(), 800);
      };
    });

    function renderPlan(isPro){
      elPlanText.textContent = isPro ? "PRO" : "Free";
      elPlanBadge.textContent = isPro ? "PRO" : "FREE";
      elPlanBadge.classList.toggle("pro", isPro);
      elPlanBadge.classList.toggle("free", !isPro);
      $("btnUseAI").disabled = !isPro;
    }

    function renderLimits(isPro, invoiceCount){
      elInvCount.textContent = invoiceCount;
      elInvLimit.textContent = isPro ? "Unlimited" : FREE_LIMIT;
      if (isPro) {
        elLimitStatus.textContent = "Unlimited";
        elLimitStatus.className = "ok";
      } else {
        const left = FREE_LIMIT - invoiceCount;
        if (left > 0) {
          elLimitStatus.textContent = `OK ‚Äî ${left} left`;
          elLimitStatus.className = "ok";
        } else {
          elLimitStatus.textContent = "Limit reached";
          elLimitStatus.className = "warn";
        }
      }
    }

    function canUseInvoices(isPro, invoiceCount){
      return isPro || invoiceCount < FREE_LIMIT;
    }
  </script>
</body>
</html>
