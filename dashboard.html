<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Dashboard</title>
  <link rel="stylesheet" href="style-dashboard.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">⚡ SmartWerk</div>
      <nav>
        <button class="accordion">💰 Invoices</button>
        <div class="panel">
          <a href="invoice.html">📄 Create Invoice</a>
          <a href="invoices-list.html">📋 Saved Invoices</a>
        </div>

        <button class="accordion">📑 Quotes</button>
        <div class="panel">
          <a href="quote-offer.html">📄 Create Quote</a>
          <a href="quote-offer-list.html">📋 Saved Quotes</a>
        </div>

        <button class="accordion">📃 Contracts</button>
        <div class="panel">
          <a href="contract.html">📄 Create Contract</a>
          <a href="contract-list.html">📋 Saved Contracts</a>
        </div>

        <button class="accordion">📬 Reminders</button>
        <div class="panel">
          <a href="payment-reminder.html">💸 Create Reminder</a>
          <a href="payment-reminder-list.html">📋 Saved Reminders</a>
        </div>

        <button class="accordion">📂 Templates</button>
        <div class="panel">
          <a href="email-gemeente.html">📩 Email to Gemeente</a>
          <a href="cv.html">📄 CV / Portfolio</a>
          <a href="expense.csv">🧮 Expense CSV</a>
        </div>

        <button class="accordion">📊 Analytics</button>
        <div class="panel">
          <a href="my-bookkeeper.html">🏆 My Bookkeeper</a>
          <a href="summary.html">📊 Summary</a>
          <a href="roi-estimator.html">📈 ROI Estimator</a>
          <a href="tax-calculator.html">🧮 Tax Calculator</a>
        </div>

        <button class="accordion">⚙️ Settings</button>
        <div class="panel">
          <a href="profile.html">👤 Profile</a>
        </div>

        <button class="accordion">❓ Help</button>
        <div class="panel">
          <a href="pricing.html">💳 Upgrade to PRO</a>
          <a href="mailto:smartwerk.team@gmail.com">📧 Contact Support</a>
        </div>

        <button id="logoutBtn" class="logout">🚪 Logout</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Header -->
      <header class="topbar">
        <h1 id="welcome">Welcome 👋</h1>
        <div class="plan-box">
          <span id="planName">FREE</span>
          <div class="progress-bar"><div id="planProgress"></div></div>
          <small id="planUsage">0/25</small>
          <a href="pricing.html" class="upgrade-btn">Upgrade to PRO</a>
        </div>
      </header>

      <!-- KPI Cards -->
      <section class="kpi-grid">
        <div class="kpi-card"><h3>💰 Revenue</h3><p id="kpiRevenue">€0</p></div>
        <div class="kpi-card"><h3>📄 Unpaid</h3><p id="kpiUnpaid">€0</p></div>
        <div class="kpi-card"><h3>📊 Quotes Rate</h3><p id="kpiQuoteRate">0%</p></div>
        <div class="kpi-card"><h3>💸 Reminders Sent</h3><p id="kpiReminders">0</p></div>
        <div class="kpi-card"><h3>📉 Expenses</h3><p id="kpiExpenses">€0</p></div>
        <div class="kpi-card"><h3>⏰ Overdue</h3><p id="kpiOverdue">0</p></div>
      </section>

      <!-- Charts -->
      <section class="charts">
        <canvas id="revenueChart"></canvas>
        <canvas id="invoiceStatusChart"></canvas>
      </section>

      <!-- Smart Suggestions -->
      <section class="suggestions">
        <h2>💡 Smart Suggestions</h2>
        <ul id="suggestionsList"></ul>
      </section>

      <!-- Recent Activity -->
      <section class="activity">
        <h2>🕒 Recent Activity</h2>
        <ul id="activityList"></ul>
      </section>
    </main>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);

    // Sidebar accordion
    document.querySelectorAll(".accordion").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        btn.classList.toggle("active");
        const panel = btn.nextElementSibling;
        panel.style.display = panel.style.display === "block" ? "none" : "block";
      });
    });

    // Logout
    $("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      location.href = "login.html";
    });

    // Charts
    let revenueChart, statusChart;
    function updateRevenueChart(data){
      const ctx = $("revenueChart").getContext("2d");
      if(revenueChart) revenueChart.destroy();
      revenueChart = new Chart(ctx,{
        type:"line",
        data:{
          labels:Object.keys(data),
          datasets:[{label:"Revenue", data:Object.values(data), borderColor:"#3b82f6", fill:false}]
        },
        options:{ responsive:true, plugins:{legend:{display:false}} }
      });
    }
    function updateStatusChart(data){
      const ctx = $("invoiceStatusChart").getContext("2d");
      if(statusChart) statusChart.destroy();
      statusChart = new Chart(ctx,{
        type:"doughnut",
        data:{
          labels:Object.keys(data),
          datasets:[{ data:Object.values(data), backgroundColor:["#f59e0b","#3b82f6","#22c55e"] }]
        },
        options:{ responsive:true }
      });
    }

    // Smart Suggestions (dynamic)
   // Smart Suggestions (dynamic with actions)
function updateSuggestions({invoices, quotes, reminders, contracts}){
  const ul = $("suggestionsList");
  ul.innerHTML="";

  const overdue = invoices.filter(i=>{
    const due = new Date(i.dueDate||null);
    return i.status!=="Paid" && due < new Date();
  });
  if(overdue.length>0){
    ul.innerHTML+=`<li>
      📌 You have ${overdue.length} overdue invoices 
      <button onclick="location.href='payment-reminder.html'">➔ Send Reminder</button>
    </li>`;
  }

  const drafts = invoices.filter(i=>i.status==="Draft");
  if(drafts.length>3){
    ul.innerHTML+=`<li>
      📝 You still have ${drafts.length} draft invoices. 
      <button onclick="location.href='invoices-list.html'">➔ Review</button>
    </li>`;
  }

  if(quotes.length){
    const accepted = quotes.filter(q=>q.status==="Accepted").length;
    const rate = Math.round(accepted/quotes.length*100);
    if(rate < 30){
      ul.innerHTML+=`<li>
        📊 Only ${rate}% of quotes accepted. 
        <button onclick="location.href='quote-offer-list.html'">➔ Improve Offers</button>
      </li>`;
    } else if(rate > 70){
      ul.innerHTML+=`<li>
        🚀 Great job! ${rate}% quotes accepted.
        <button onclick="location.href='quote-offer-list.html'">➔ View</button>
      </li>`;
    }
  }

  if(reminders.length>5){
    ul.innerHTML+=`<li>
      ⏰ You sent ${reminders.length} reminders. 
      <button onclick="location.href='payment-reminder-list.html'">➔ Check</button>
    </li>`;
  }

  const unsigned = contracts.filter(c=>c.status!=="Signed");
  if(unsigned.length){
    ul.innerHTML+=`<li>
      🖊 ${unsigned.length} contracts waiting for signature. 
      <button onclick="location.href='contract-list.html'">➔ View Contracts</button>
    </li>`;
  }

  if(!ul.innerHTML){
    ul.innerHTML="<li>✅ Everything looks good. Keep up the great work!</li>";
  }
}

    // Init
    onAuthStateChanged(auth, async(user)=>{
      if(!user){ location.href="login.html"; return; }

      // Profile
      const snap = await getDoc(doc(db,"users",user.uid));
      const profile = snap.exists() ? snap.data() : {};
      $("welcome").innerText = `Welcome, ${profile.fullName||"User"} 👋`;

      // Real-time Invoices
      let invoices=[],quotes=[],reminders=[],contracts=[];
      onSnapshot(collection(db,"users",user.uid,"invoices"),(snap)=>{
        invoices = snap.docs.map(d=>d.data());
        const revenue = invoices.reduce((a,b)=>a+(parseFloat(b.grandTotal)||0),0);
        const unpaid = invoices.filter(i=>i.status!=="Paid").reduce((a,b)=>a+(parseFloat(b.grandTotal)||0),0);
        const overdue = invoices.filter(i=>{
          const due = new Date(i.dueDate||null);
          return i.status!=="Paid" && due < new Date();
        }).length;

        $("kpiRevenue").innerText = "€"+revenue.toFixed(2);
        $("kpiUnpaid").innerText = "€"+unpaid.toFixed(2);
        $("kpiOverdue").innerText = overdue;

        const byMonth = {};
        invoices.forEach(i=>{
          const m = (i.invoiceDate||"").substring(0,7);
          if(!byMonth[m]) byMonth[m]=0;
          byMonth[m]+=parseFloat(i.grandTotal)||0;
        });
        updateRevenueChart(byMonth);

        const status = {Draft:0,Sent:0,Paid:0};
        invoices.forEach(i=>status[i.status] = (status[i.status]||0)+1);
        updateStatusChart(status);

        updateSuggestions({invoices,quotes,reminders,contracts});
      });

      // Quotes
      onSnapshot(collection(db,"users",user.uid,"quotes"),(snap)=>{
        quotes = snap.docs.map(d=>d.data());
        const accepted = quotes.filter(q=>q.status==="Accepted").length;
        $("kpiQuoteRate").innerText = quotes.length ? Math.round(accepted/quotes.length*100)+"%" : "0%";
        updateSuggestions({invoices,quotes,reminders,contracts});
      });

      // Reminders
      onSnapshot(collection(db,"users",user.uid,"reminders"),(snap)=>{
        reminders = snap.docs.map(d=>d.data());
        $("kpiReminders").innerText = snap.size;
        updateSuggestions({invoices,quotes,reminders,contracts});
      });

      // Contracts
      onSnapshot(collection(db,"users",user.uid,"contracts"),(snap)=>{
        contracts = snap.docs.map(d=>d.data());
        updateSuggestions({invoices,quotes,reminders,contracts});
      });

      // Expenses
      onSnapshot(collection(db,"users",user.uid,"expenses"),(snap)=>{
        const total = snap.docs.map(d=>parseFloat(d.data().amount)||0).reduce((a,b)=>a+b,0);
        $("kpiExpenses").innerText = "€"+total.toFixed(2);
      });

      // Recent Activity
      onSnapshot(query(collection(db,"users",user.uid,"events"), orderBy("createdAt","desc")),(snap)=>{
        const ul = $("activityList");
        ul.innerHTML="";
        snap.docs.slice(0,5).forEach(d=>{
          const e=d.data();
          const li=document.createElement("li");
          li.innerText = `${e.type||"Event"} — ${e.message||""}`;
          ul.appendChild(li);
        });
      });
    });
  </script>
</body>
</html>
