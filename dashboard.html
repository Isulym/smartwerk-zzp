<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Dashboard</title>
  <link rel="stylesheet" href="style-dashboard.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">⚡ SmartWerk</div>
      <nav>
        <a href="dashboard.html">🏠 Dashboard</a>
        <a href="invoice.html">💰 Invoices</a>
        <a href="quote-offer.html">📑 Quotes</a>
        <a href="contract.html">📃 Contracts</a>
        <a href="payment-reminder.html">📬 Reminders</a>
        <a href="templates.html">📂 Templates</a>
        <a href="my-bookkeeper.html">📊 Analytics</a>
        <a href="profile.html">⚙️ Settings</a>
        <a href="clients.html">👥 Clients</a>
        <a href="pricing.html">💳 Upgrade</a>
        <button id="logoutBtn" class="logout">🚪 Logout</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Header -->
      <header class="topbar">
        <h1 id="welcome">Welcome 👋</h1>
        <div class="plan-box">
          <span id="planName">FREE</span>
          <div class="progress-bar"><div id="planProgress"></div></div>
          <small id="planUsage">0/25</small>
          <a href="pricing.html" class="upgrade-btn">Upgrade to PRO</a>
        </div>
      </header>

      <!-- Quick Actions -->
      <section class="quick-actions">
        <button onclick="logAndGo('invoice.html','Created Invoice')">➕ Invoice</button>
        <button onclick="logAndGo('quote-offer.html','Created Quote')">➕ Quote</button>
        <button onclick="logAndGo('contract.html','Created Contract')">➕ Contract</button>
        <button onclick="logAndGo('payment-reminder.html','Created Reminder')">➕ Reminder</button>
      </section>

      <!-- KPI Cards -->
      <section class="kpi-grid">
        <div class="kpi-card"><h3>💰 Revenue</h3><p id="kpiRevenue">€0</p></div>
        <div class="kpi-card"><h3>📄 Unpaid</h3><p id="kpiUnpaid">€0</p></div>
        <div class="kpi-card"><h3>📊 Quotes Rate</h3><p id="kpiQuoteRate">0%</p></div>
        <div class="kpi-card"><h3>💸 Reminders Sent</h3><p id="kpiReminders">0</p></div>
        <div class="kpi-card"><h3>📉 Expenses</h3><p id="kpiExpenses">€0</p></div>
        <div class="kpi-card"><h3>⏰ Overdue</h3><p id="kpiOverdue">0</p></div>
      </section>

      <!-- Charts -->
      <section class="charts">
        <canvas id="revenueChart" height="120"></canvas>
        <canvas id="invoiceStatusChart" height="120"></canvas>
      </section>

      <!-- Smart Suggestions -->
      <section class="suggestions">
        <h2>💡 Smart Suggestions</h2>
        <ul id="suggestionsList"></ul>
      </section>

      <!-- Recent Activity -->
      <section class="activity">
        <h2>🕒 Recent Activity</h2>
        <ul id="activityList"></ul>
      </section>
    </main>
  </div>

  <!-- Firebase -->
  <script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1",
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const $ = id => document.getElementById(id);

// Logout
$("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  location.href = "login.html";
});

// Log and Go (щоб писати в Recent Activity)
async function logAndGo(page, message){
  const user = auth.currentUser;
  if(user){
    await addDoc(collection(db,"users",user.uid,"events"),{
      type:"Action",
      message:message,
      createdAt:new Date()
    });
  }
  location.href = page;
}

// Init
onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="login.html"; return; }

  // Load profile
  const snap = await getDoc(doc(db,"users",user.uid,"profile","main"));
  const profile = snap.exists() ? snap.data() : {};
  $("welcome").innerText = `Welcome, ${profile.fullName||"User"} 👋`;

  // Plan logic
  const plan = profile.plan || "FREE";
  $("planName").innerText = plan;
  let limit = plan==="PRO" ? Infinity : 25;

  // Track usage (invoices + quotes + reminders)
  let totalDocs = 0;
  const colls = ["invoices","quotes","reminders"];
  for(const c of colls){
    const snap2 = await new Promise(resolve=>{
      onSnapshot(collection(db,"users",user.uid,c),(snap)=>resolve(snap.size));
    });
    totalDocs += snap2;
  }
  $("planUsage").innerText = plan==="PRO" ? "Unlimited" : `${totalDocs}/${limit}`;
  $("planProgress").style.width = plan==="PRO" ? "100%" : `${Math.min(100,totalDocs/limit*100)}%`;

  // Real-time Invoices
  onSnapshot(collection(db,"users",user.uid,"invoices"),(snap)=>{
    const invoices = snap.docs.map(d=>d.data());
    const revenue = invoices.reduce((a,b)=>a+(parseFloat(b.grandTotal)||0),0);
    const unpaid = invoices.filter(i=>i.status!=="Paid").reduce((a,b)=>a+(parseFloat(b.grandTotal)||0),0);
    const overdue = invoices.filter(i=>{
      const due = new Date(i.dueDate||null);
      return i.status!=="Paid" && due < new Date();
    }).length;

    $("kpiRevenue").innerText = "€"+revenue.toFixed(2);
    $("kpiUnpaid").innerText = "€"+unpaid.toFixed(2);
    $("kpiOverdue").innerText = overdue;

    updateRevenueChart(invoices);
    updateStatusChart(invoices);

    updateSuggestions(unpaid,overdue);
  });

  // Reminders
  onSnapshot(collection(db,"users",user.uid,"reminders"),(snap)=>{
    $("kpiReminders").innerText = snap.size;
  });

  // Quotes
  onSnapshot(collection(db,"users",user.uid,"quotes"),(snap)=>{
    const quotes = snap.docs.map(d=>d.data());
    const accepted = quotes.filter(q=>q.status==="Accepted").length;
    $("kpiQuoteRate").innerText = quotes.length ? Math.round(accepted/quotes.length*100)+"%" : "0%";
  });

  // Expenses
  onSnapshot(collection(db,"users",user.uid,"expenses"),(snap)=>{
    const total = snap.docs.map(d=>parseFloat(d.data().amount)||0).reduce((a,b)=>a+b,0);
    $("kpiExpenses").innerText = "€"+total.toFixed(2);
  });

  // Recent Activity
  onSnapshot(query(collection(db,"users",user.uid,"events"), orderBy("createdAt","desc")),(snap)=>{
    const ul = $("activityList");
    ul.innerHTML="";
    if(snap.empty){ ul.innerHTML="<li>No recent activity</li>"; return; }
    snap.docs.slice(0,5).forEach(d=>{
      const e=d.data();
      const li=document.createElement("li");
      li.innerText = `${e.type||"Event"} — ${e.message||""}`;
      ul.appendChild(li);
    });
  });
});

// Charts
let revenueChart, statusChart;
function updateRevenueChart(invoices){
  const byMonth={};
  invoices.forEach(i=>{
    const m = (i.invoiceDate||"").substring(0,7);
    if(!byMonth[m]) byMonth[m]=0;
    byMonth[m]+=parseFloat(i.grandTotal)||0;
  });
  const ctx=$("revenueChart").getContext("2d");
  if(revenueChart) revenueChart.destroy();
  revenueChart=new Chart(ctx,{
    type:"line",
    data:{ labels:Object.keys(byMonth), datasets:[{label:"Revenue", data:Object.values(byMonth), borderColor:"#3b82f6", fill:false}] },
    options:{ responsive:true, plugins:{legend:{display:false}} }
  });
}
function updateStatusChart(invoices){
  const status={Draft:0,Sent:0,Paid:0};
  invoices.forEach(i=>status[i.status]=(status[i.status]||0)+1);
  const ctx=$("invoiceStatusChart").getContext("2d");
  if(statusChart) statusChart.destroy();
  statusChart=new Chart(ctx,{
    type:"doughnut",
    data:{ labels:Object.keys(status), datasets:[{data:Object.values(status), backgroundColor:["#f59e0b","#3b82f6","#22c55e"]}] },
    options:{ responsive:true }
  });
}

// Smart Suggestions
function updateSuggestions(unpaid,overdue){
  const ul=$("suggestionsList");
  ul.innerHTML="";
  if(unpaid>0) ul.innerHTML+=`<li>📌 Collect €${unpaid.toFixed(2)} in unpaid invoices.</li>`;
  if(overdue>0) ul.innerHTML+=`<li>⚠️ ${overdue} invoices are overdue — send reminders.</li>`;
  ul.innerHTML+=`<li>💡 Convert more quotes into contracts for steady income.</li>`;
  ul.innerHTML+=`<li>📊 Track your expenses in My Bookkeeper for better clarity.</li>`;
}
</script>
</body>
</html>
