<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartWerk ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e1014; --card:#151823; --muted:#9aa3b2; --ok:#27c693; --warn:#ffb020; --err:#ff5470; --line:#232a42;
      --panel:#151b28; --panel2:#141827; --accent:#3b79ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:#e9edf5;background:radial-gradient(1200px 600px at 10% -10%,#1d2233 0%,#0e1014 40%),linear-gradient(#0e1014,#0e1014)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px 22px}

    /* topbar */
    .topbar{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{font-weight:700;font-size:20px;letter-spacing:.3px}
    .right{display:flex;gap:10px;align-items:center}
    .btn{background:#2b3350;border:1px solid #3b4567;color:#e9edf5;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:#3b79ff;border-color:#4d86ff}
    .btn.danger{background:#4a2330;border-color:#6a2c40}
    .badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .badge.pro{background:linear-gradient(90deg,#ffdf6b,#ffb020);color:#1c1200}
    .badge.free{background:#2a3147;color:#c9d2e3;border:1px solid #3a425e}

    /* layout: sidebar + main */
    .layout{display:grid;grid-template-columns:240px 1fr;gap:16px}
    .sidebar{align-self:start;position:sticky;top:16px;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;padding:16px}
    .sidebar h2{margin:0 0 14px 0;font-size:18px;text-align:center}
    .nav-link{display:block;padding:10px 12px;margin:6px 0;border:1px solid #2b3350;border-radius:10px;text-decoration:none;color:#e9edf5;background:#121728}
    .nav-link:hover{filter:brightness(1.08)}
    .sidebar .back{display:block;margin-top:12px;text-decoration:none;color:#c9d2e3}

    /* cards + panels */
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .card{background:linear-gradient(180deg,#161b28,#141827);border:1px solid #232a42;border-radius:16px;padding:18px}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-top:10px}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}

    /* app tiles from your snippet */
    .apps{margin-top:16px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .card-link{display:block;text-decoration:none;color:inherit}
    .dashboard-card{border:1px solid var(--line);border-radius:16px;padding:16px;background:linear-gradient(180deg,var(--panel),var(--panel2));transition:.15s}
    .dashboard-card:hover{filter:brightness(1.06)}
    .dashboard-card h3{margin:0 0 8px 0}

    @media (max-width:1024px){.layout{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">üíº SmartWerk ‚Äî Dashboard</div>
      <div class="right">
        <a href="index.html" class="btn" id="btnHome">Main Page</a>
        <span id="planBadge" class="badge free">FREE</span>
        <button id="btnLogout" class="btn danger">Logout</button>
      </div>
    </div>

    <div class="layout">
      <!-- Sidebar from your snippet -->
      <aside class="sidebar">
        <h2>SmartWerk</h2>
        <a href="#" class="nav-link" id="linkSummary">üìä Summary</a>
        <a href="#" class="nav-link" id="linkInvoices">üßæ Invoices</a>
        <a href="#" class="nav-link" id="linkTax">üßÆ Tax Calculator</a>
        <a href="#" class="nav-link" id="linkTemplates">üìÅ Templates</a>
        <a href="#" class="nav-link" id="linkBookkeeper">üèÜ My Bookkeeper</a>
        <a href="#" class="nav-link" id="linkSettings">‚öôÔ∏è Settings</a>
        <a href="index.html" class="back">‚Üê Back to Home</a>
      </aside>

      <!-- Main column (our existing dashboard content) -->
      <main>
        <div class="grid">
          <!-- Profile -->
          <div class="card">
            <h3>üë§ Profile</h3>
            <div class="muted" id="userEmailTop">‚Äî</div>
            <div class="kv">
              <div class="muted">Name</div><div id="fullName">‚Äî</div>
              <div class="muted">Email</div><div id="emailKv">‚Äî</div>
              <div class="muted">Address</div><div id="address">‚Äî</div>
              <div class="muted">KvK</div><div id="kvk">‚Äî</div>
              <div class="muted">IBAN</div><div id="iban">‚Äî</div>
              <div class="muted">Phone</div><div id="phone">‚Äî</div>
              <div class="muted">Plan</div><div id="planText">Free</div>
            </div>
            <div class="sep"></div>
            <div class="row">
              <button id="btnProfile" class="btn">Edit profile</button>
              <button id="btnUpgrade" class="btn primary">Upgrade to PRO</button>
            </div>
          </div>

          <!-- Plan & Limits -->
          <div class="card">
            <h3>‚öôÔ∏è Plan & Limits</h3>
            <div class="muted">Free plan: up to 3 invoices, no export, no AI</div>
            <div class="sep"></div>
            <div class="kv">
              <div class="muted">Invoices created</div><div id="invCount">0</div>
              <div class="muted">Limit</div><div id="invLimit">3</div>
              <div class="muted">Status</div><div id="limitStatus" class="ok">OK</div>
            </div>
            <div class="sep"></div>
            <!-- Quick actions keep our previous IDs so JS –Ω–µ –ª–∞–º–∞—î—Ç—å—Å—è -->
            <div class="row">
              <button id="btnOpenCalculator" class="btn">üßæ Tax Calculator</button>
              <button id="btnOpenInvoices" class="btn">üìÇ Invoice Manager</button>
              <button id="btnUseAI" class="btn">üîÆ Ask SmartWerk AI</button>
            </div>
          </div>
        </div>

        <!-- Notices -->
        <div class="card" style="margin-top:16px">
          <h3>üîî Notices</h3>
          <div id="noticeArea" class="muted">‚Äî</div>
        </div>

        <!-- App tiles from your snippet -->
        <section class="apps">
          <div class="cards">
            <a href="#" class="card-link" id="cardSummary">
              <div class="dashboard-card">
                <h3>Smart Summary</h3>
                <p>Your income, expenses, tax overview and more.</p>
              </div>
            </a>

            <a href="#" class="card-link" id="cardInvoices">
              <div class="dashboard-card">
                <h3>Invoices & Documents</h3>
                <p>Manage invoices, KvK, IBAN and tax forms.</p>
              </div>
            </a>

            <a href="#" class="card-link" id="cardTax">
              <div class="dashboard-card">
                <h3>Tax Calculator</h3>
                <p>Real-time tax estimates with AI.</p>
              </div>
            </a>

            <a href="#" class="card-link" id="cardTemplates">
              <div class="dashboard-card">
                <h3>Smart Templates</h3>
                <p>Invoices, reports and benefit requests.</p>
              </div>
            </a>

            <a href="#" class="card-link" id="cardBookkeeper">
              <div class="dashboard-card">
                <h3>My Bookkeeper</h3>
                <p>Send documents to the accountant.</p>
              </div>
            </a>

            <a href="#" class="card-link" id="cardSettings">
              <div class="dashboard-card">
                <h3>Settings</h3>
                <p>Update name, KvK, IBAN, language & currency.</p>
              </div>
            </a>
          </div>
        </section>

        <!-- SmartWerk AI (toggle) -->
        <section id="smartwerkAiSection" style="display:none; margin-top:20px;">
          <h3>üß† Ask SmartWerk AI ‚Äì Documents</h3>
          <p>You can ask your accountant assistant about uploaded invoices, KvK, taxes and more.</p>
          <iframe
            src="https://www.chatbase.co/chatbot-iframe/uy7T8ni8Hnk8A2Hb3onls"
            width="100%" height="500" frameborder="0"
            style="border:1px solid #ccc; border-radius: 8px;">
          </iframe>
        </section>
      </main>
    </div>
  </div>

  <!-- Firebase SDK (module imports) -->
  <script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
    authDomain: "smartwerk8520.firebaseapp.com",
    projectId: "smartwerk8520",
    appId: "1:607670981972:web:c07103c981c86860d724c1",
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);
  const elEmailTop = $("userEmailTop");
  const elEmailKv = $("emailKv");
  const elFullName = $("fullName");
  const elAddress = $("address");
  const elKvk = $("kvk");
  const elIban = $("iban");
  const elPhone = $("phone");
  const elPlanText = $("planText");
  const elPlanBadge = $("planBadge");
  const elInvCount = $("invCount");
  const elInvLimit = $("invLimit");
  const elLimitStatus = $("limitStatus");
  const elNotice = $("noticeArea");

  const FREE_LIMIT = 3;
  let STATE = { isPro:false, invoiceCount:0 };

  onAuthStateChanged(auth, async (user) => {
    if (!user) { location.href = "login.html"; return; }

    // email –∑ Auth
    elEmailTop.textContent = user.email || "‚Äî";
    elEmailKv.textContent  = user.email || "‚Äî";

    const userRef = doc(db, "users", user.uid);
    let snap = await getDoc(userRef);

    if (!snap.exists()) {
      await setDoc(userRef, {
        email: user.email || "",
        pro: false,
        fullName: "",
        address: "",
        kvk: "",
        iban: "",
        phone: "",
        invoiceCount: 0
      });
      snap = await getDoc(userRef);
    }

    const data = snap.data() || {};
    STATE.isPro = !!data.pro;
    STATE.invoiceCount = Number.isFinite(data.invoiceCount) ? data.invoiceCount : 0;

    // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Ñ—ñ–ª—é
    elFullName.textContent = data.fullName || "‚Äî";
    elAddress.textContent  = data.address  || "‚Äî";
    elKvk.textContent      = data.kvk      || "‚Äî";
    elIban.textContent     = data.iban     || "‚Äî";
    elPhone.textContent    = data.phone    || "‚Äî";

    // –ü–ª–∞–Ω —Ç–∞ –ª—ñ–º—ñ—Ç–∏
    renderPlan(STATE.isPro);
    renderLimits(STATE.isPro, STATE.invoiceCount);

    // –ö–Ω–æ–ø–∫–∏ —à–∞–ø–∫–∏/–∫–∞—Ä—Ç–æ–∫/—Å–∞–π–¥–±–∞—Ä—É
    $("btnLogout").onclick = () => signOut(auth).then(()=>location.href="login.html");
    $("btnProfile").onclick = () => location.href = "profile.html";

    // QUICK ACTIONS
    $("btnOpenInvoices").onclick   = (e)=>{ e.preventDefault(); openInvoices(); };
    $("btnOpenCalculator").onclick = (e)=>{ e.preventDefault(); openTaxCalculator(); };
    $("btnUseAI").onclick          = (e)=>{ e.preventDefault(); openAskAI(); };

    // SIDEBAR
    bindNav("linkSummary",   ()=>location.href="summary.html");
    bindNav("linkInvoices",  openInvoices);
    bindNav("linkTax",       openTaxCalculator);
    bindNav("linkTemplates", ()=>location.href="templates.html");
    bindNav("linkBookkeeper",()=>location.href="my-bookkeeper.html");
    bindNav("linkSettings",  ()=>location.href="settings.html");

    // CARDS
    bindNav("cardSummary",   ()=>location.href="summary.html");
    bindNav("cardInvoices",  openInvoices);
    bindNav("cardTax",       openTaxCalculator);
    bindNav("cardTemplates", ()=>location.href="templates.html");
    bindNav("cardBookkeeper",()=>location.href="my-bookkeeper.html");
    bindNav("cardSettings",  ()=>location.href="settings.html");

    // Upgrade
    $("btnUpgrade").onclick = async () => {
      if (STATE.isPro) { elNotice.textContent = "–£ –≤–∞—Å –≤–∂–µ PRO."; return; }
      await updateDoc(userRef, { pro: true });
      elNotice.textContent = "‚úÖ –ü–ª–∞–Ω –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–æ PRO. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é...";
      setTimeout(()=>location.reload(), 800);
    };
  });

  function bindNav(id, fn){
    const el = $(id);
    if (el) el.addEventListener("click", (e)=>{ e.preventDefault(); fn(); });
  }

  // === –Ñ–¥–∏–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ free-–ª—ñ–º—ñ—Ç—É –¥–ª—è –≤—Å—ñ—Ö —Ñ—ñ—á ===
  function blockedByFreeLimit() {
    if (!STATE.isPro && STATE.invoiceCount >= FREE_LIMIT) {
      elNotice.innerHTML = `‚ùó –í–∏ –Ω–∞ Free-–ø–ª–∞–Ω—ñ —Ç–∞ –¥–æ—Å—è–≥–ª–∏ –ª—ñ–º—ñ—Ç—É —ñ–Ω–≤–æ–π—Å—ñ–≤ (${FREE_LIMIT}). <b>Upgrade to PRO</b> –¥–ª—è –±–µ–∑–ª—ñ–º—ñ—Ç—É.`;
      return true;
    }
    return false;
  }

  // === –ù–∞–≤—ñ–≥–∞—Ü—ñ—ó –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞–º–∏ ===
  function openInvoices(){
    if (blockedByFreeLimit()) return;
    location.href = "invoices.html#autofill=1";
  }
  function openTaxCalculator(){
    if (blockedByFreeLimit()) return;
    location.href = "tax-calculator.html";
  }
  function openAskAI(){
    if (blockedByFreeLimit()) return;          // —Ç–∞–∫–∞ –∂ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —è–∫ –¥–ª—è Invoices
    if (!STATE.isPro) {                         // –¥–æ–¥–∞—Ç–∫–æ–≤–æ: AI –ª–∏—à–µ –¥–ª—è PRO
      elNotice.innerHTML = "ü§ñ SmartWerk AI –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –≤ PRO –ø–ª–∞–Ω—ñ.";
      return;
    }
    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ/—Ö–æ–≤–∞—î–º–æ —Å–µ–∫—Ü—ñ—é AI
    toggleSmartWerkAI();
  }

  function renderPlan(isPro){
    elPlanText.textContent = isPro ? "PRO" : "Free";
    elPlanBadge.textContent = isPro ? "PRO" : "FREE";
    elPlanBadge.classList.toggle("pro", isPro);
    elPlanBadge.classList.toggle("free", !isPro);
    const askAI = $("btnUseAI"); if (askAI) askAI.disabled = !isPro;
  }

  function renderLimits(isPro, invoiceCount){
    elInvCount.textContent = invoiceCount;
    elInvLimit.textContent = isPro ? "Unlimited" : FREE_LIMIT;
    if (isPro) {
      elLimitStatus.textContent = "Unlimited";
      elLimitStatus.className = "ok";
    } else {
      const left = FREE_LIMIT - invoiceCount;
      if (left > 0) {
        elLimitStatus.textContent = `OK ‚Äî ${left} left`;
        elLimitStatus.className = "ok";
      } else {
        elLimitStatus.textContent = "Limit reached";
        elLimitStatus.className = "warn";
      }
    }
  }

  function toggleSmartWerkAI() {
    const section = document.getElementById("smartwerkAiSection");
    if (section.style.display === "none") {
      section.style.display = "block";
      window.scrollTo({ top: section.offsetTop, behavior: "smooth" });
    } else {
      section.style.display = "none";
    }
  }
</script>

</body>
</html>
