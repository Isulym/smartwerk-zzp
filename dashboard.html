<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk â€” Dashboard</title>
  <link rel="stylesheet" href="style-dashboard.css"/>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">âš¡ SmartWerk</div>

      <nav class="nav">
        <!-- Invoices -->
        <button class="acc-btn">ğŸ’° Invoices</button>
        <div class="acc-panel">
          <a href="invoices.html">ğŸ“„ Create Invoice</a>
          <a href="invoices-list.html">ğŸ“‹ Saved Invoices</a>
        </div>

        <!-- Quotes -->
        <button class="acc-btn">ğŸ“‘ Quotes</button>
        <div class="acc-panel">
          <a href="quote-offer.html">ğŸ“„ Create Quote</a>
          <a href="quote-offer-list.html">ğŸ“‹ Saved Quotes</a>
        </div>

        <!-- Contracts -->
        <button class="acc-btn">ğŸ“ƒ Contracts</button>
        <div class="acc-panel">
          <a href="contract.html">ğŸ“„ Create Contract</a>
          <a href="contract-list.html">ğŸ“‹ Saved Contracts</a>
        </div>

        <!-- Reminders -->
        <button class="acc-btn">ğŸ“¬ Reminders</button>
        <div class="acc-panel">
          <a href="payment-reminder.html">ğŸ’¸ Create Reminder</a>
          <a href="payment-reminder-list.html">ğŸ“‹ Saved Reminders</a>
        </div>

        <!-- Templates -->
        <button class="acc-btn">ğŸ“‚ Templates</button>
        <div class="acc-panel">
          <a href="email-gemeente.html">ğŸ“© Email to Gemeente</a>
          <a href="cv.html">ğŸ“„ CV / Portfolio</a>
          <a href="expense.csv">ğŸ§® Expense CSV</a>
        </div>

        <!-- Analytics -->
        <button class="acc-btn">ğŸ“Š Analytics</button>
        <div class="acc-panel">
          <a href="my-bookkeeper.html">ğŸ† My Bookkeeper</a>
          <a href="summary.html">ğŸ“Š Summary</a>
          <a href="roi-estimator.html">ğŸ§® ROI Estimator</a>
          <a href="tax-calculator.html">ğŸ§® Tax Calculator</a>
        </div>

        <!-- Settings -->
        <button class="acc-btn">âš™ï¸ Settings</button>
        <div class="acc-panel">
          <a href="profile.html">ğŸ‘¤ Profile</a>
        </div>
      </nav>

      <button id="logoutBtn" class="logout">ğŸšª Logout</button>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="top">
        <h1 id="welcome">Welcome ğŸ‘‹</h1>
        <div class="plan-badge" id="planBadge">
          <span id="planLabel">FREE</span>
          <span class="sep">â€¢</span>
          <span id="usageText">0/25</span>
          <div class="progress">
            <div id="progressBar" style="width:0%"></div>
          </div>
        </div>
      </header>

      <!-- Quick actions -->
      <section class="quick">
        <button onclick="location.href='invoice.html'">+ Invoice</button>
        <button onclick="location.href='quote-offer.html'">+ Quote</button>
        <button onclick="location.href='contract.html'">+ Contract</button>
        <button onclick="location.href='payment-reminder.html'">+ Reminder</button>
      </section>

      <!-- KPI -->
      <section class="kpis">
        <div class="kpi"><div>ğŸ’¶ Revenue</div><b id="kpiRevenue">â‚¬0</b></div>
        <div class="kpi"><div>âš ï¸ Unpaid</div><b id="kpiUnpaid">â‚¬0</b></div>
        <div class="kpi"><div>ğŸ§¾ Invoices (month)</div><b id="kpiInvoices">0</b></div>
        <div class="kpi"><div>ğŸ“ˆ Quotes accepted</div><b id="kpiQuotes">0%</b></div>
        <div class="kpi"><div>ğŸ‘¥ New clients</div><b id="kpiClients">0</b></div>
        <div class="kpi"><div>ğŸ”” Reminders</div><b id="kpiReminders">0</b></div>
      </section>

      <!-- Charts -->
      <section class="charts">
        <div class="card">
          <h3>Revenue (last 6 months)</h3>
          <canvas id="revenueChart" height="300"></canvas>
        </div>
        <div class="card">
          <h3>Invoice status</h3>
          <canvas id="statusChart" height="300"></canvas>
        </div>
      </section>

      <section class="split">
        <div class="card">
          <h3>ğŸ’¡ Smart Suggestions</h3>
          <ul id="suggestions"><li>â€”</li></ul>
        </div>
        <div class="card">
          <h3>ğŸ•‘ Recent Activity</h3>
          <ul id="activity"><li>â€”</li></ul>
        </div>
      </section>
    </main>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, orderBy, query, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = s => document.querySelector(s);

    /* Sidebar accordion */
    document.querySelectorAll(".acc-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        btn.classList.toggle("active");
        const p = btn.nextElementSibling;
        p.style.display = (p.style.display==="block") ? "none" : "block";
      });
    });

    /* Helpers */
    const euro = n => "â‚¬" + (Number(n||0).toFixed(2));
    const monthKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;

    /* Charts holders */
    let revenueChart, statusChart;

    onAuthStateChanged(auth, async user=>{
      if(!user){ location.href="login.html"; return; }

      // Profile + Plan
      const profSnap = await getDoc(doc(db,"users",user.uid));
      const prof = profSnap.exists() ? profSnap.data() : {};
      $("#welcome").textContent = `Welcome, ${prof.fullName || "User"} ğŸ‘‹`;

      const plan = (prof.plan || "FREE").toUpperCase();
      const used = Number(prof.usage || 0);
      const limitFree = 25;
      $("#planLabel").textContent = plan;
      $("#usageText").textContent = plan==="FREE" ? `${used}/${limitFree}` : "PRO";
      $("#progressBar").style.width = plan==="FREE" ? Math.min(100, used/limitFree*100) + "%" : "100%";

      // Load collections (simple, Ğ±ĞµĞ· Ñ–Ğ½Ğ´ĞµĞºÑÑ–Ğ²)
      const [invSnap, quoSnap, remSnap] = await Promise.all([
        getDocs(collection(db,"users",user.uid,"invoices")),
        getDocs(collection(db,"users",user.uid,"quotes")),
        getDocs(collection(db,"users",user.uid,"reminders")),
      ]);

      const invoices = invSnap.docs.map(d=>({id:d.id, ...d.data()}));
      const quotes   = quoSnap.docs.map(d=>({id:d.id, ...d.data()}));
      const reminders= remSnap.docs.map(d=>({id:d.id, ...d.data()}));

      // KPI: revenue, unpaid, invoices this month
      const now = new Date();
      const thisMonth = monthKey(now);

      const paid = invoices.filter(i => (i.status||"").toLowerCase()==="paid");
      const revenue = paid.reduce((s,i)=> s + Number(i.grandTotal || i.total || 0), 0);

      const unpaid = invoices.filter(i => (i.status||"").toLowerCase()!=="paid");
      const unpaidSum = unpaid.reduce((s,i)=> s + Number(i.grandTotal || i.total || 0), 0);

      const invThisMonth = invoices.filter(i => String(i.invoiceDate||"").startsWith(thisMonth)).length;

      const accepted = quotes.filter(q => (q.status||"").toLowerCase()==="accepted").length;
      const quotesPct = quotes.length ? Math.round(accepted/quotes.length*100) : 0;

      $("#kpiRevenue").textContent  = euro(revenue);
      $("#kpiUnpaid").textContent   = euro(unpaidSum);
      $("#kpiInvoices").textContent = invThisMonth;
      $("#kpiQuotes").textContent   = quotesPct + "%";
      $("#kpiClients").textContent  = new Set(invoices.map(i=>i.clientEmail || i.clientName)).size;
      $("#kpiReminders").textContent= reminders.length;

      // Charts
      // Revenue by month (last 6)
      const months = [...Array(6)].map((_,k)=>{
        const d = new Date(now.getFullYear(), now.getMonth()-5+k, 1);
        return monthKey(d);
      });
      const revenueByMonth = months.map(m=>{
        const monthPaid = invoices.filter(i => String(i.invoiceDate||"").startsWith(m) && (i.status||"").toLowerCase()==="paid");
        return monthPaid.reduce((s,i)=> s + Number(i.grandTotal || i.total || 0), 0);
      });

      const paidCount    = invoices.filter(i => (i.status||"").toLowerCase()==="paid").length;
      const unpaidCount  = invoices.filter(i => (i.status||"").toLowerCase()==="unpaid").length;
      const draftCount   = invoices.filter(i => (i.status||"").toLowerCase()==="draft").length;

      const ctx1 = document.getElementById("revenueChart").getContext("2d");
      const ctx2 = document.getElementById("statusChart").getContext("2d");
      revenueChart && revenueChart.destroy();
      statusChart  && statusChart.destroy();

      revenueChart = new Chart(ctx1,{
        type:"line",
        data:{ labels: months, datasets:[{ label:"Revenue", data: revenueByMonth, borderColor:"#3b82f6", tension:.3 }]},
        options:{
          plugins:{ legend:{ labels:{ color:"#e5e7eb" } } },
          scales:{
            x:{ ticks:{ color:"#9ca3af" }, grid:{ color:"rgba(148,163,184,.15)"}},
            y:{ ticks:{ color:"#9ca3af" }, grid:{ color:"rgba(148,163,184,.15)"}}
          }
        }
      });

      statusChart = new Chart(ctx2,{
        type:"doughnut",
        data:{
          labels:["Paid","Unpaid","Draft"],
          datasets:[{ data:[paidCount,unpaidCount,draftCount], backgroundColor:["#22c55e","#ef4444","#64748b"] }]
        },
        options:{
          plugins:{ legend:{ labels:{ color:"#e5e7eb" } } }
        }
      });

      // Smart Suggestions
      const suggestions = [];
      // 1) ĞŸÑ€Ğ¾ÑÑ‚Ñ€Ğ¾Ñ‡ĞµĞ½Ñ– Ñ–Ğ½Ğ²Ğ¾Ğ¹ÑĞ¸ (dueDate < today Ñ– Ğ½Ğµ Paid)
      const today = new Date().toISOString().slice(0,10);
      const overdue = invoices.filter(i => (i.dueDate||"") < today && (i.status||"").toLowerCase()!=="paid");
      if(overdue.length){
        const n = overdue.length;
        suggestions.push(`âš ï¸ ${n} invoice${n>1?"s":""} overdue â†’ <a href="payment-reminder-list.html">Send Reminders</a>`);
      }

      // 2) Ğ„ Ñ–Ğ½Ğ²Ğ¾Ğ¹ÑĞ¸ â€œSentâ€ Ğ±ĞµĞ· Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸ 14+ Ğ´Ğ½Ñ–Ğ²
      const oldSent = invoices.filter(i=>{
        const d = i.invoiceDate || i.updatedAt || "";
        if(!d) return false;
        const dt = new Date(d);
        const age = (Date.now() - dt.getTime())/(1000*60*60*24);
        return (i.status||"").toLowerCase()==="sent" && age>=14;
      });
      if(oldSent.length){
        suggestions.push(`â³ ${oldSent.length} sent â‰¥14 days â†’ consider Reminder`);
      }

      // 3) ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ Ğ½Ğµ Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ¸Ğ¹
      if(!prof.fullName || !prof.iban || !prof.kvk){
        suggestions.push(`ğŸªª Complete <a href="profile.html">Profile</a> to auto-fill all documents.`);
      }

      $("#suggestions").innerHTML = suggestions.length
        ? suggestions.map(s=>`<li>${s}</li>`).join("")
        : `<li>No suggestions â€” nice work! âœ…</li>`;

      // Recent Activity (Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ– 5 Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ)
      // Ğ±ĞµÑ€ĞµĞ¼Ğ¾ invoices ÑĞº Ğ½Ğ°Ğ¹Ñ‡Ğ°ÑÑ‚Ñ–ÑˆĞµ; Ğ·Ğ° Ğ±Ğ°Ğ¶Ğ°Ğ½Ğ½ÑĞ¼ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ quotes/reminders
      let recent = invoices
        .map(i=>({t:"Invoice", n:i.invoiceNumber || i.id, d:i.updatedAt || i.invoiceDate || ""}))
        .sort((a,b)=>String(b.d).localeCompare(String(a.d)))
        .slice(0,5);

      $("#activity").innerHTML = recent.length
        ? recent.map(r=>`<li>ğŸ§¾ ${r.t} ${r.n} â€” ${r.d||"â€”"}</li>`).join("")
        : `<li>No recent activity.</li>`;

      // Logout
      $("#logoutBtn").addEventListener("click",()=>signOut(auth));
    });
  </script>
</body>
</html>
