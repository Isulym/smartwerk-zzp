<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Dashboard</title>
  <link rel="stylesheet" href="style-dashboard.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">⚡ SmartWerk</div>
    <div class="plan-box" id="planBox">
      <span id="planName">FREE</span>
      <div class="progress">
        <div id="planProgress"></div>
      </div>
      <small id="planUsage">0 / 25</small>
    </div>
    <nav>
      <div class="accordion">
        <button class="accordion-btn">💰 Invoices</button>
        <div class="accordion-content">
          <a href="invoice.html">📄 Create Invoice</a>
          <a href="invoices-list.html">📋 Saved Invoices</a>
        </div>
        <button class="accordion-btn">📑 Quotes</button>
        <div class="accordion-content">
          <a href="quote-offer.html">📄 Create Quote</a>
          <a href="quote-offer-list.html">📋 Saved Quotes</a>
        </div>
        <button class="accordion-btn">📃 Contracts</button>
        <div class="accordion-content">
          <a href="contract.html">📄 Create Contract</a>
          <a href="contract-list.html">📋 Saved Contracts</a>
        </div>
        <button class="accordion-btn">📬 Reminders</button>
        <div class="accordion-content">
          <a href="payment-reminder.html">💸 Create Reminder</a>
          <a href="payment-reminder-list.html">📋 Saved Reminders</a>
        </div>
        <button class="accordion-btn">📂 Templates</button>
        <div class="accordion-content">
          <a href="email-gemeente.html">📩 Email to Gemeente</a>
          <a href="cv.html">📄 CV / Portfolio</a>
        </div>
        <button class="accordion-btn">📊 Analytics</button>
        <div class="accordion-content">
          <a href="my-bookkeeper.html">🏆 My Bookkeeper</a>
          <a href="summary.html">📊 Summary</a>
          <a href="roi-estimator.html">📈 ROI Estimator</a>
          <a href="tax-calculator.html">🧮 Tax Calculator</a>
        </div>
        <button class="accordion-btn">⚙️ Settings</button>
        <div class="accordion-content">
          <a href="profile.html">👤 Profile</a>
        </div>
      </div>
    </nav>
    <button id="logoutBtn" class="logout">🚪 Logout</button>
  </aside>

  <!-- Main -->
  <main class="main">
    <header class="topbar">
      <h1 id="welcomeMsg">Welcome 👋</h1>
      <div class="actions">
        <button onclick="location.href='invoice.html'">➕ Invoice</button>
        <button onclick="location.href='quote-offer.html'">➕ Quote</button>
        <button onclick="location.href='contract.html'">➕ Contract</button>
        <button onclick="location.href='payment-reminder.html'">➕ Reminder</button>
      </div>
    </header>

    <!-- KPI -->
    <section class="kpis">
      <div class="kpi"><h3 id="kpiRevenue">€0</h3><p>Revenue</p></div>
      <div class="kpi"><h3 id="kpiUnpaid">€0</h3><p>Unpaid</p></div>
      <div class="kpi"><h3 id="kpiInvoices">0</h3><p>Invoices this month</p></div>
      <div class="kpi"><h3 id="kpiQuotes">0%</h3><p>Quotes Accepted</p></div>
      <div class="kpi"><h3 id="kpiClients">0</h3><p>New Clients</p></div>
      <div class="kpi"><h3 id="kpiReminders">0</h3><p>Reminders Sent</p></div>
    </section>

    <!-- Charts -->
    <section class="charts">
      <canvas id="revenueChart"></canvas>
      <canvas id="statusChart"></canvas>
    </section>

    <!-- Suggestions + Activity -->
    <section class="suggestions">
      <h2>⚡ Smart Suggestions</h2>
      <ul id="suggestionsList"></ul>
    </section>
    <section class="activity">
      <h2>🕑 Recent Activity</h2>
      <ul id="activityList"></ul>
    </section>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = id => document.getElementById(id);

    // Sidebar accordion
    document.querySelectorAll(".accordion-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        btn.classList.toggle("active");
        const content = btn.nextElementSibling;
        content.style.display = content.style.display === "block" ? "none" : "block";
      });
    });

    // Charts
    const revenueChart = new Chart($("revenueChart"), {
      type:"line",
      data:{ labels:[], datasets:[{label:"Revenue",data:[],borderColor:"#3b82f6"}] }
    });
    const statusChart = new Chart($("statusChart"), {
      type:"doughnut",
      data:{ labels:["Draft","Sent","Paid"], datasets:[{data:[0,0,0],backgroundColor:["#64748b","#3b82f6","#16a34a"]}] }
    });

    // Load dashboard data
    onAuthStateChanged(auth, async(user)=>{
      if(!user){ location.href="login.html"; return; }
      const uid=user.uid;

      // Profile
      const profile=await getDoc(doc(db,"users",uid));
      if(profile.exists()){
        const p=profile.data();
        $("welcomeMsg").innerText=`Welcome, ${p.fullName||"User"} 👋`;
        const plan=p.plan||"FREE";
        $("planName").innerText=plan;
        if(plan==="FREE"){
          const used=p.usage||0;
          $("planUsage").innerText=`${used}/25`;
          $("planProgress").style.width=`${(used/25)*100}%`;
        }else{
          $("planUsage").innerText="Unlimited";
          $("planProgress").style.width="100%";
        }
      }

      // Invoices
      const invoices = await getDocs(collection(db,"users",uid,"invoices"));
      let totalRevenue=0, unpaid=0, invoicesThisMonth=0, paid=0, sent=0, draft=0;
      const now=new Date();
      invoices.forEach(d=>{
        const inv=d.data();
        const amount=parseFloat(inv.grandTotal||0);
        totalRevenue+=amount;
        if(inv.status==="Paid") paid++;
        if(inv.status==="Sent") { sent++; unpaid+=amount; }
        if(inv.status==="Draft") draft++;
        const invDate=new Date(inv.invoiceDate||now);
        if(invDate.getMonth()===now.getMonth() && invDate.getFullYear()===now.getFullYear()) invoicesThisMonth++;
      });
      $("kpiRevenue").innerText="€"+totalRevenue.toFixed(2);
      $("kpiUnpaid").innerText="€"+unpaid.toFixed(2);
      $("kpiInvoices").innerText=invoicesThisMonth;
      revenueChart.data.labels=["This Month"];
      revenueChart.data.datasets[0].data=[totalRevenue];
      revenueChart.update();
      statusChart.data.datasets[0].data=[draft,sent,paid];
      statusChart.update();

      // Quotes
      const quotes = await getDocs(collection(db,"users",uid,"quotes"));
      let totalQuotes=0, accepted=0;
      quotes.forEach(q=>{
        totalQuotes++;
        if(q.data().status==="Accepted") accepted++;
      });
      $("kpiQuotes").innerText=totalQuotes?Math.round((accepted/totalQuotes)*100)+"%":"0%";

      // Reminders
      const reminders = await getDocs(collection(db,"users",uid,"reminders"));
      $("kpiReminders").innerText=reminders.size;

      // Clients (count by unique client names from invoices)
      const clients=new Set();
      invoices.forEach(d=>{ if(d.data().clientName) clients.add(d.data().clientName); });
      $("kpiClients").innerText=clients.size;

      // Recent activity
      const acts=await getDocs(query(collection(db,"users",uid,"events"),orderBy("createdAt","desc"),limit(5)));
      $("activityList").innerHTML="";
      acts.forEach(a=>{
        const li=document.createElement("li");
        li.textContent=a.data().text||"Activity";
        $("activityList").appendChild(li);
      });

      // Smart suggestions
      const suggestions=[];
      if(unpaid>0) suggestions.push(`${invoices.size - paid} invoices unpaid → Send Reminder`);
      if(accepted>0) suggestions.push(`${accepted} quotes accepted → Convert to Invoice`);
      $("suggestionsList").innerHTML=suggestions.length? suggestions.map(s=>`<li>${s}</li>`).join("") : "<li>All good 👌</li>";
    });

    $("logoutBtn").onclick=()=>signOut(auth);
  </script>
</body>
</html>
