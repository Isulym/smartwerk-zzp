<script type="module">
  // 1) Firebase config (–∑–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ —Å–≤–æ—ó –∑–Ω–∞—á–µ–Ω–Ω—è)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    appId: "YOUR_APP_ID",
  };

  // 2) Modular SDK (—Ç—ñ–ª—å–∫–∏ module-—ñ–º–ø–æ—Ä—Ç–∏)
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // 3) –Ñ–¥–∏–Ω–∏–π —ñ–Ω—Å—Ç–∞–Ω—Å Firebase (–∞–Ω—Ç–∏-–∫–æ–Ω—Ñ–ª—ñ–∫—Ç)
  const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // 4) DOM refs
  const $ = (id)=>document.getElementById(id);
  const elEmailTop   = $("userEmailTop");
  const elEmailKv    = $("emailKv");
  const elFullName   = $("fullName");
  const elAddress    = $("address");
  const elKvk        = $("kvk");
  const elIban       = $("iban");
  const elPhone      = $("phone");
  const elPlanText   = $("planText");
  const elPlanBadge  = $("planBadge");
  const elInvCount   = $("invCount");
  const elInvLimit   = $("invLimit");
  const elLimitStatus= $("limitStatus");
  const elNotice     = $("noticeArea");

  const FREE_LIMIT = 3;

  // 5) –ù–∞–¥—ñ–π–Ω–∏–π Logout (–ø–æ–∑–∞ onAuthStateChanged)
  function bindLogout() {
    const btn = document.querySelector('#btnLogout,[data-logout]');
    if (!btn) { console.warn('[Logout] Button not found'); return; }
    if (btn.dataset.bound === "1") return;
    btn.dataset.bound = "1";

    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        btn.disabled = true;
        const old = btn.textContent;
        btn.textContent = 'Logging out‚Ä¶';
        await signOut(auth);
        window.location.replace('login.html');
      } catch (err) {
        console.error('[Logout] error:', err);
        window.location.replace('login.html');
      }
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindLogout);
  } else {
    bindLogout();
  }

  // 6) –†–µ–Ω–¥–µ—Ä –ø–ª–∞–Ω—É/–ª—ñ–º—ñ—Ç—ñ–≤
  function renderPlan(isPro){
    elPlanText.textContent = isPro ? "PRO" : "Free";
    elPlanBadge.textContent = isPro ? "PRO" : "FREE";
    elPlanBadge.classList.toggle("pro", isPro);
    elPlanBadge.classList.toggle("free", !isPro);
    const aiBtn = $("btnUseAI");
    if (aiBtn) aiBtn.disabled = !isPro;
  }
  function renderLimits(isPro, invoiceCount){
    elInvCount.textContent = invoiceCount;
    elInvLimit.textContent = isPro ? "Unlimited" : FREE_LIMIT;
    if (isPro) {
      elLimitStatus.textContent = "Unlimited";
      elLimitStatus.className = "ok";
    } else {
      const left = FREE_LIMIT - invoiceCount;
      if (left > 0) {
        elLimitStatus.textContent = `OK ‚Äî ${left} left`;
        elLimitStatus.className = "ok";
      } else {
        elLimitStatus.textContent = "Limit reached";
        elLimitStatus.className = "warn";
      }
    }
  }
  function canUseInvoices(isPro, invoiceCount){
    return isPro || invoiceCount < FREE_LIMIT;
  }

  // 7) –ó–∞—Ö–∏—Å—Ç —Å—Ç–æ—Ä—ñ–Ω–∫–∏ + –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é + –¥—ñ—ó
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.replace("login.html");
      return;
    }
    console.log('[Auth] Logged in as', user.email);

    // Email –∑ Auth
    elEmailTop.textContent = user.email || "‚Äî";
    elEmailKv.textContent  = user.email || "‚Äî";

    // User doc
    const userRef = doc(db, "users", user.uid);
    let snap = await getDoc(userRef);
    if (!snap.exists()) {
      await setDoc(userRef, {
        email: user.email || "",
        pro: false,
        fullName: "",
        address: "",
        kvk: "",
        iban: "",
        phone: "",
        invoiceCount: 0
      });
      snap = await getDoc(userRef);
    }
    const data = snap.data() || {};
    let isPro = !!data.pro;
    let invoiceCount = Number.isFinite(data.invoiceCount) ? data.invoiceCount : 0;

    // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Ñ—ñ–ª—é
    elFullName.textContent = data.fullName || "‚Äî";
    elAddress.textContent  = data.address  || "‚Äî";
    elKvk.textContent      = data.kvk      || "‚Äî";
    elIban.textContent     = data.iban     || "‚Äî";
    elPhone.textContent    = data.phone    || "‚Äî";

    // –ü–ª–∞–Ω/–ª—ñ–º—ñ—Ç–∏
    renderPlan(isPro);
    renderLimits(isPro, invoiceCount);

    // –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ –¥—ñ—ó
    const btnProfile = $("btnProfile");
    if (btnProfile) btnProfile.onclick = () => location.href = "profile.html";

    const btnOpenInv = $("btnOpenInvoices");
    if (btnOpenInv) btnOpenInv.onclick = () => {
      if (!canUseInvoices(isPro, invoiceCount)) {
        elNotice.innerHTML = "‚ùó –í–∏ –Ω–∞ Free-–ø–ª–∞–Ω—ñ —Ç–∞ –¥–æ—Å—è–≥–ª–∏ –ª—ñ–º—ñ—Ç—É —ñ–Ω–≤–æ–π—Å—ñ–≤. <b>Upgrade to PRO</b> –¥–ª—è –±–µ–∑–ª—ñ–º—ñ—Ç—É.";
        return;
      }
      // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª–µ–º –≤ invoices.html
      location.href = "invoices.html#autofill=1";
    };

    const btnCalc = $("btnOpenCalculator");
    if (btnCalc) btnCalc.onclick = () => { location.href = "calculator.html"; };

    const btnAI = $("btnUseAI");
    if (btnAI) btnAI.onclick = () => {
      if (!isPro) {
        elNotice.innerHTML = "ü§ñ SmartWerk AI –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –≤ PRO –ø–ª–∞–Ω—ñ.";
        return;
      }
      location.href = "ai-assistant.html";
    };

    const btnUpgrade = $("btnUpgrade");
    if (btnUpgrade) btnUpgrade.onclick = async () => {
      if (isPro) { elNotice.textContent = "–£ –≤–∞—Å –≤–∂–µ PRO."; return; }
      await updateDoc(userRef, { pro: true });
      elNotice.textContent = "‚úÖ –ü–ª–∞–Ω –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–æ PRO. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é...";
      setTimeout(()=>location.reload(), 800);
    };
  }, (err) => {
    console.error('[Auth] onAuthStateChanged error:', err);
  });
</script>
