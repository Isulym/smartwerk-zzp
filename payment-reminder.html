<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Payment Reminder</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>📬 SmartWerk — Payment Reminder</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="payment-reminder-list.html" class="btn">📋 Saved Reminders</a>
    </nav>
  </header>

  <main>
    <!-- Business Info -->
    <section>
      <h2>🏢 Business Info</h2>
      <input id="businessName" placeholder="Business Name"/>
      <input id="kvk" placeholder="KvK Number"/>
      <input id="iban" placeholder="IBAN"/>
      <input id="btw" placeholder="BTW"/>
      <input id="email" placeholder="Business Email"/>
      <input id="businessAddress" placeholder="Business Address"/>
      <input id="businessPhone" placeholder="Business Phone"/>
    </section>

    <!-- Client Info -->
    <section>
      <h2>👤 Client Info</h2>
      <input id="clientName" placeholder="Client Name"/>
      <input id="clientEmail" placeholder="Client Email"/>
      <input id="clientPhone" placeholder="Client Phone"/>
      <input id="clientAddress" placeholder="Client Address"/>
    </section>

    <!-- Reminder Info -->
    <section>
      <h2>📌 Reminder Details</h2>
      <input id="reminderId" readonly placeholder="REM-2025-001"/>
      <input id="reminderDate" class="js-date" placeholder="Reminder Date"/>

      <label>Linked Invoice:
        <select id="linkedInvoice">
          <option value="">— Select Invoice —</option>
        </select>
      </label>

      <select id="status">
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
      </select>
    </section>

    <!-- Message -->
    <section>
      <h2>💬 Message</h2>
      <textarea id="messageBody" rows="6" placeholder="Write your reminder message..."></textarea>
      <div>
        <button type="button" onclick="makeStrict()">💬 Make it more strict</button>
        <button type="button" onclick="makeFriendly()">👍 Make it more friendly</button>
      </div>
    </section>

    <!-- AI + Translate -->
    <section>
      <h2>🤖 AI Tools</h2>
      <button type="button" onclick="aiFill()">🤖 AI Fill</button>
      <button type="button" onclick="aiDraft()">✍️ AI Draft</button>
      <button type="button" onclick="translateText('en')">🌐 EN</button>
      <button type="button" onclick="translateText('nl')">🌐 NL</button>
    </section>

    <!-- Actions -->
    <section class="step actions">
      <button id="saveBtn" class="btn-primary">💾 Save Reminder</button>
      <a href="payment-reminder-list.html" class="btn">📋 Saved Reminders</a>
    </section>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);

    /* Generate Reminder ID */
    async function previewNextReminderId(uid){
      const ref = doc(db,"users",uid);
      const snap = await getDoc(ref);
      const last = snap.exists()? (snap.data().lastReminderNumber||0) : 0;
      const next = last + 1;
      $("reminderId").value = `REM-${new Date().getFullYear()}-${String(next).padStart(3,"0")}`;
    }
    async function generateReminderId(uid){
      const ref = doc(db,"users",uid);
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastReminderNumber||0) : 0;
        const next = last + 1;
        tx.set(ref,{ lastReminderNumber: next },{ merge:true });
        out=`REM-${new Date().getFullYear()}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    /* Load Invoices */
    async function loadInvoices(uid){
      const snap = await getDocs(collection(db,"users",uid,"invoices"));
      const sel = $("linkedInvoice");
      sel.innerHTML = `<option value="">— Select Invoice —</option>`;
      snap.forEach(d=>{
        const inv = d.data();
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = `${inv.invoiceNumber||d.id} — ${inv.clientName||"Client"} — €${inv.grandTotal||0}`;
        sel.appendChild(opt);
      });
    }

    /* Save Reminder */
    async function saveReminder(){
      const user = auth.currentUser;
      if(!user){ location.href="login.html"; return; }
      const uid=user.uid;

      let reminderId = $("reminderId").value.trim();
      const editingId = localStorage.getItem("editReminderId") || null;
      if(!editingId && !reminderId){
        reminderId = await generateReminderId(uid);
        $("reminderId").value = reminderId;
      }

      const data={
        businessName:$("businessName").value,
        kvk:$("kvk").value,
        iban:$("iban").value,
        btw:$("btw").value,
        email:$("email").value,
        businessAddress:$("businessAddress").value,
        businessPhone:$("businessPhone").value,

        clientName:$("clientName").value,
        clientEmail:$("clientEmail").value,
        clientPhone:$("clientPhone").value,
        clientAddress:$("clientAddress").value,

        reminderId,
        reminderDate:$("reminderDate").value,
        linkedInvoice:$("linkedInvoice").value,
        status:$("status").value,
        messageBody:$("messageBody").value,

        userId:uid,
        updatedAt:new Date().toISOString()
      };

      if(editingId){
        await setDoc(doc(db,"users",uid,"reminders",editingId), data, {merge:true});
        alert("✅ Reminder updated");
      }else{
        await addDoc(collection(db,"users",uid,"reminders"), data);
        alert(`✅ Reminder saved as ${reminderId}`);
      }

      localStorage.removeItem("editReminderId");
      location.href="payment-reminder-list.html";
    }
    window.saveReminder=saveReminder;

    /* AI & Helpers */
    window.makeStrict=()=>{
      $("messageBody").value += "\n\nThis is your final reminder. Immediate payment is required.";
    }
    window.makeFriendly=()=>{
      $("messageBody").value += "\n\nWe kindly ask you to settle the invoice at your earliest convenience.";
    }
    window.aiDraft=()=>{
      $("messageBody").value="Dear Client,\n\nThis is a friendly reminder regarding your outstanding invoice. Please make the payment within the next 7 days.\n\nBest regards,\nSmartWerk";
    }
    window.translateText=(lang)=>{
      if(lang==="nl"){
        $("messageBody").value=$("messageBody").value.replace("Dear Client","Beste Klant").replace("Best regards","Met vriendelijke groet");
      } else {
        $("messageBody").value=$("messageBody").value.replace("Beste Klant","Dear Client").replace("Met vriendelijke groet","Best regards");
      }
    }
    window.aiFill=()=>{
      $("businessName").value="SmartWerk BV";
      $("kvk").value="12345678";
      $("iban").value="NL00RABO0123456789";
      $("btw").value="NL123456789B01";
      $("email").value="info@smartwerk.nl";
      $("businessAddress").value="Amsterdam, NL";
      $("businessPhone").value="+31 612345678";

      $("clientName").value="John Doe";
      $("clientEmail").value="john@example.com";
      $("clientPhone").value="+31 612345999";
      $("clientAddress").value="Utrecht, NL";

      $("messageBody").value="Dear Client,\n\nThis is a payment reminder for your invoice. Kindly settle the amount within 7 days.\n\nBest regards,\nSmartWerk";
    }

    /* Init */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }

      flatpickr(".js-date",{dateFormat:"Y-m-d"});
      await previewNextReminderId(user.uid);
      await loadInvoices(user.uid);

      $("saveBtn")?.addEventListener("click",(e)=>{ e.preventDefault(); saveReminder(); });
    });
  </script>
</body>
</html>
