<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk â€” Payment Reminder</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>ğŸ“¬ SmartWerk â€” Payment Reminder</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="payment-reminder-list.html" class="btn">ğŸ“‹ Saved Reminders</a>
    </nav>
  </header>

  <main>
    <!-- Business Info -->
    <section>
      <h2>ğŸ¢ Business Info</h2>
      <input id="businessName" placeholder="Business Name"/>
      <input id="email" placeholder="Business Email"/>
      <input id="businessAddress" placeholder="Business Address"/>
      <input id="businessPhone" placeholder="Business Phone"/>
    </section>

    <!-- Client Info -->
    <section>
      <h2>ğŸ‘¤ Client Info</h2>
      <input id="clientName" placeholder="Client Name"/>
      <input id="clientEmail" placeholder="Client Email"/>
      <input id="clientAddress" placeholder="Client Address"/>
    </section>

    <!-- Linked Invoice -->
    <section>
      <h2>ğŸ“‘ Linked Invoice</h2>
      <select id="linkedInvoice"><option>â€” Select Invoice â€”</option></select>
      <p>Invoice Date: <span id="invoiceDate">â€”</span></p>
      <p>Due Date: <span id="dueDate">â€”</span></p>
      <p>Invoice Amount: <span id="invoiceAmount">â€”</span></p>
    </section>

    <!-- Reminder Details -->
    <section>
      <h2>â° Reminder Details</h2>
      <input id="reminderDate" class="js-date" placeholder="Reminder Date"/>
      <select id="status">
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
      <select id="type">
        <option value="First Reminder">First Reminder</option>
        <option value="Second Reminder">Second Reminder</option>
        <option value="Final Reminder">Final Reminder</option>
      </select>
      <input id="amount" placeholder="Amount (e.g. â‚¬500)"/>
    </section>

    <!-- Message -->
    <section>
      <h2>ğŸ’¬ Message</h2>
      <textarea id="message" placeholder="Message body..."></textarea>
      <div class="actions">
        <button type="button">ğŸ¤– AI Fill</button>
        <button type="button">âœï¸ AI Draft</button>
        <button type="button">ğŸ’¬ Strict</button>
        <button type="button">ğŸ‘ Friendly</button>
        <button type="button">ğŸŒ EN</button>
        <button type="button">ğŸŒ NL</button>
      </div>
    </section>

    <!-- Signatures -->
    <section>
      <h2>âœï¸ Signatures</h2>
      <div>
        <h3>Business</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>
        <h3>Client</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step actions">
      <button id="saveBtn" class="btn-primary">ğŸ’¾ Save Reminder</button>
      <a href="payment-reminder-list.html" class="btn">ğŸ“‹ Saved Reminders</a>
    </section>
  </main>

  <footer>
    <p>Â© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);

    /* Signatures */
    function setupSignature(canvasId,dateId){
      const c=$(canvasId);const ctx=c.getContext("2d");
      let drawing=false;
      const start=()=>{drawing=true;ctx.beginPath();};
      const end=()=>{if(!drawing)return;drawing=false;$(dateId).innerText=new Date().toLocaleDateString("nl-NL");};
      const move=(e)=>{if(!drawing)return;const r=c.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;ctx.lineWidth=2;ctx.lineCap="round";ctx.strokeStyle="#000";ctx.lineTo(x,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y);};
      c.addEventListener("mousedown",start);c.addEventListener("mouseup",end);c.addEventListener("mouseleave",()=>drawing=false);c.addEventListener("mousemove",move);
      c.addEventListener("touchstart",(e)=>{e.preventDefault();start();});
      c.addEventListener("touchend",(e)=>{e.preventDefault();end();});
      c.addEventListener("touchmove",(e)=>{e.preventDefault();move(e);});
    }
    window.clearSignature=(id)=>{const c=$(id);c.getContext("2d").clearRect(0,0,c.width,c.height);if(id==="signatureBusiness")$("signatureBusinessDate").innerText="";if(id==="signatureClient")$("signatureClientDate").innerText="";};

    /* Save */
    async function saveReminder(){
      const user=auth.currentUser;if(!user){location.href="login.html";return;}
      const uid=user.uid;

      const businessSig=$("signatureBusiness").toDataURL();
      const clientSig=$("signatureClient").toDataURL();

      const data={
        businessName:$("businessName").value,
        email:$("email").value,
        businessAddress:$("businessAddress").value,
        businessPhone:$("businessPhone").value,

        clientName:$("clientName").value,
        clientEmail:$("clientEmail").value,
        clientAddress:$("clientAddress").value,

        linkedInvoice:$("linkedInvoice").value,
        invoiceDate:$("invoiceDate").innerText,
        dueDate:$("dueDate").innerText,
        invoiceAmount:$("invoiceAmount").innerText,

        reminderDate:$("reminderDate").value,
        status:$("status").value,
        type:$("type").value,
        amount:$("amount").value,
        message:$("message").value,

        signatures:{
          business:businessSig,
          client:clientSig,
          businessDate:$("signatureBusinessDate").innerText||"",
          clientDate:$("signatureClientDate").innerText||""
        },

        userId:uid,
        updatedAt:new Date().toISOString(),
      };

      const editingId = localStorage.getItem("editReminderId") || null;
      if(editingId){
        await setDoc(doc(db,"users",uid,"reminders",editingId), data, {merge:true});
        alert("âœ… Reminder updated");
      }else{
        await addDoc(collection(db,"users",uid,"reminders"), data);
        alert("âœ… Reminder saved");
      }
      localStorage.removeItem("editReminderId");
      location.href="payment-reminder-list.html";
    }
    window.saveReminder=saveReminder;

    /* Load for edit */
    async function loadReminderForEdit(uid){
      const id=localStorage.getItem("editReminderId");
      if(!id)return;
      const snap=await getDoc(doc(db,"users",uid,"reminders",id));
      if(!snap.exists()){localStorage.removeItem("editReminderId");return;}
      const r=snap.data();

      $("#businessName").value=r.businessName||"";
      $("#email").value=r.email||"";
      $("#businessAddress").value=r.businessAddress||"";
      $("#businessPhone").value=r.businessPhone||"";

      $("#clientName").value=r.clientName||"";
      $("#clientEmail").value=r.clientEmail||"";
      $("#clientAddress").value=r.clientAddress||"";

      $("#linkedInvoice").value=r.linkedInvoice||"";
      $("#invoiceDate").innerText=r.invoiceDate||"";
      $("#dueDate").innerText=r.dueDate||"";
      $("#invoiceAmount").innerText=r.invoiceAmount||"";

      $("#reminderDate").value=r.reminderDate||"";
      $("#status").value=r.status||"Draft";
      $("#type").value=r.type||"First Reminder";
      $("#amount").value=r.amount||"";
      $("#message").value=r.message||"";

      if(r.signatures?.business){
        const img=new Image();img.onload=()=>{const c=$("#signatureBusiness");const ctx=c.getContext("2d");ctx.clearRect(0,0,c.width,c.height);ctx.drawImage(img,0,0);};img.src=r.signatures.business;
        $("#signatureBusinessDate").innerText=r.signatures.businessDate||"";
      }
      if(r.signatures?.client){
        const img=new Image();img.onload=()=>{const c=$("#signatureClient");const ctx=c.getContext("2d");ctx.clearRect(0,0,c.width,c.height);ctx.drawImage(img,0,0);};img.src=r.signatures.client;
        $("#signatureClientDate").innerText=r.signatures.clientDate||"";
      }
    }

    /* Init */
    onAuthStateChanged(auth, async(user)=>{
      if(!user){location.href="login.html";return;}
      flatpickr(".js-date",{dateFormat:"Y-m-d"});
      setupSignature("signatureBusiness","signatureBusinessDate");
      setupSignature("signatureClient","signatureClientDate");
      await loadReminderForEdit(user.uid);

      // Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ñ‚Ğ¸ Ñ–Ğ½Ğ²Ğ¾Ğ¹ÑĞ¸ Ñƒ select
      onSnapshot(collection(db,"users",user.uid,"invoices"),(snap)=>{
        const sel=$("linkedInvoice");
        sel.innerHTML="<option>â€” Select Invoice â€”</option>";
        snap.docs.forEach(d=>{
          const inv=d.data();
          const opt=document.createElement("option");
          opt.value=inv.invoiceNumber||d.id;
          opt.text=inv.invoiceNumber||d.id;
          opt.dataset.date=inv.invoiceDate||"";
          opt.dataset.due=inv.dueDate||"";
          opt.dataset.amount=inv.grandTotalFormatted||"";
          sel.appendChild(opt);
        });
      });

      $("linkedInvoice").addEventListener("change",(e)=>{
        const opt=e.target.selectedOptions[0];
        $("invoiceDate").innerText=opt.dataset.date||"";
        $("dueDate").innerText=opt.dataset.due||"";
        $("invoiceAmount").innerText=opt.dataset.amount||"";
      });

      $("saveBtn").addEventListener("click",(e)=>{e.preventDefault();saveReminder();});
    });
  </script>
</body>
</html>
