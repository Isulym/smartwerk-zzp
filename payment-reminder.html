<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Payment Reminder</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>📬 SmartWerk — Payment Reminder</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="payment-reminder-list.html" class="btn">📋 Saved Reminders</a>
    </nav>
  </header>

  <main>
    <!-- Business Info -->
    <section>
      <h2>🏢 Business Info</h2>
      <input id="businessName" placeholder="Business Name"/>
      <input id="email" placeholder="Business Email"/>
      <input id="businessAddress" placeholder="Business Address"/>
      <input id="businessPhone" placeholder="Business Phone"/>
    </section>

    <!-- Client Info -->
    <section>
      <h2>👤 Client Info</h2>
      <input id="clientName" placeholder="Client Name"/>
      <input id="clientEmail" placeholder="Client Email"/>
      <input id="clientAddress" placeholder="Client Address"/>
    </section>

    <!-- Linked Invoice -->
    <section>
      <h2>📑 Linked Invoice</h2>
      <select id="linkedInvoice"><option>— Select Invoice —</option></select>
      <p>Invoice Date: <span id="invoiceDate">—</span></p>
      <p>Due Date: <span id="dueDate">—</span></p>
      <p>Invoice Amount: <span id="invoiceAmount">—</span></p>
    </section>

    <!-- Reminder Details -->
    <section>
      <h2>⏰ Reminder Details</h2>
      <input id="reminderId" placeholder="Reminder ID (auto)" readonly/>
      <input id="reminderDate" class="js-date" placeholder="Reminder Date"/>
      <select id="status">
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Paid">Paid</option>
      </select>
      <select id="type">
        <option value="First Reminder">First Reminder</option>
        <option value="Second Reminder">Second Reminder</option>
        <option value="Final Reminder">Final Reminder</option>
      </select>
      <input id="amount" placeholder="Amount (e.g. €500)"/>
    </section>

    <!-- Message -->
    <section>
      <h2>💬 Message</h2>
      <textarea id="message" placeholder="Message body..."></textarea>
      <div class="actions">
        <button type="button" onclick="aiFill()">🤖 AI Fill</button>
        <button type="button" onclick="aiDraft()">✍️ AI Draft</button>
        <button type="button" onclick="aiStrict()">💬 Strict</button>
        <button type="button" onclick="aiFriendly()">👍 Friendly</button>
        <button type="button" onclick="translateMsg('en')">🌐 EN</button>
        <button type="button" onclick="translateMsg('nl')">🌐 NL</button>
      </div>
    </section>

    <!-- Signatures -->
    <section>
      <h2>✍️ Signatures</h2>
      <div>
        <h3>Business</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>
        <h3>Client</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step actions">
      <button id="saveBtn" class="btn-primary">💾 Save Reminder</button>
      <a href="payment-reminder-list.html" class="btn">📋 Saved Reminders</a>
    </section>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Firebase -->
  <script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
    authDomain: "smartwerk8520.firebaseapp.com",
    projectId: "smartwerk8520",
    appId: "1:607670981972:web:c07103c981c86860d724c1",
  };
  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  //const $ = id => document.getElementById(id);

  /* AUTO REMINDER ID */
  async function generateReminderId(uid){
    const ref = doc(db,"users",uid);
    const year = new Date().getFullYear();
    let out="";
    await runTransaction(db, async(tx)=>{
      const snap=await tx.get(ref);
      const last=snap.exists()?(snap.data().lastReminderNumber||0):0;
      const next=last+1;
      tx.set(ref,{lastReminderNumber:next},{merge:true});
      out=`REM-${year}-${String(next).padStart(3,"0")}`;
    });
    return out;
  }

  /* Signatures */
  function setupSignature(canvasId,dateId){
    const c=$(canvasId);const ctx=c.getContext("2d");
    let drawing=false;
    const start=()=>{drawing=true;ctx.beginPath();};
    const end=()=>{if(!drawing)return;drawing=false;$(dateId).innerText=new Date().toLocaleDateString("nl-NL");};
    const move=(e)=>{if(!drawing)return;const r=c.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;ctx.lineWidth=2;ctx.lineCap="round";ctx.strokeStyle="#000";ctx.lineTo(x,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y);};
    c.addEventListener("mousedown",start);c.addEventListener("mouseup",end);c.addEventListener("mouseleave",()=>drawing=false);c.addEventListener("mousemove",move);
    c.addEventListener("touchstart",(e)=>{e.preventDefault();start();});
    c.addEventListener("touchend",(e)=>{e.preventDefault();end();});
    c.addEventListener("touchmove",(e)=>{e.preventDefault();move(e);});
  }
  window.clearSignature=(id)=>{const c=$(id);c.getContext("2d").clearRect(0,0,c.width,c.height);if(id==="signatureBusiness")$("signatureBusinessDate").innerText="";if(id==="signatureClient")$("signatureClientDate").innerText="";};

  /* Save */
  async function saveReminder(){
  const user = auth.currentUser;
  if(!user){ location.href="login.html"; return; }
  const uid = user.uid;

  const editingId = localStorage.getItem("editReminderId") || null;

  // Генеруємо ID тільки для нового Reminder
  let reminderId = $("#reminderId")?.value || "";
  if(!editingId && !reminderId){
    reminderId = await generateReminderId(uid);
    if($("#reminderId")) $("#reminderId").value = reminderId;
  }

  const data = {
    businessName: $("#businessName")?.value || "",
    email: $("#email")?.value || "",
    businessAddress: $("#businessAddress")?.value || "",
    businessPhone: $("#businessPhone")?.value || "",

    clientName: $("#clientName")?.value || "",
    clientEmail: $("#clientEmail")?.value || "",
    clientAddress: $("#clientAddress")?.value || "",

    linkedInvoice: $("#linkedInvoice")?.value || "",
    invoiceDate: $("#invoiceDate")?.innerText || "",
    dueDate: $("#dueDate")?.innerText || "",
    invoiceAmount: $("#invoiceAmount")?.innerText || "",

    reminderId,
    reminderDate: $("#reminderDate")?.value || "",
    status: $("#status")?.value || "Draft",
    type: $("#type")?.value || "First Reminder",
    amount: $("#amount")?.value || "",
    message: $("#message")?.value || "",

    signatures:{
      business: $("#signatureBusiness")?.toDataURL() || "",
      client: $("#signatureClient")?.toDataURL() || "",
      businessDate: $("#signatureBusinessDate")?.innerText || "",
      clientDate: $("#signatureClientDate")?.innerText || ""
    },

    userId: uid,
    updatedAt: new Date().toISOString(),
  };

  if(editingId){
    await setDoc(doc(db,"users",uid,"reminders",editingId), data, {merge:true});
    alert("✅ Reminder updated");
  } else {
    await addDoc(collection(db,"users",uid,"reminders"), data);
    alert(`✅ Reminder saved as ${reminderId}`);
  }

  localStorage.removeItem("editReminderId");
  location.href = "payment-reminder-list.html";
}
window.saveReminder = saveReminder;

  /* Load for edit */
  /* Хелпери */
const $ = id => document.getElementById(id);
const setVal  = (id,val="") => { const el=$(id); if(el) el.value = val ?? ""; };
const setText = (id,val="") => { const el=$(id); if(el) el.innerText = val ?? ""; };

/* Load for edit */
async function loadReminderForEdit(uid){
  const id = localStorage.getItem("editReminderId");
  if(!id) return;

  const snap = await getDoc(doc(db,"users",uid,"reminders",id));
  if(!snap.exists()){
    localStorage.removeItem("editReminderId");
    return;
  }

  const r = snap.data();

  // Business Info
  setVal("businessName", r.businessName);
  setVal("email", r.email);
  setVal("businessAddress", r.businessAddress);
  setVal("businessPhone", r.businessPhone);

  // Client Info
  setVal("clientName", r.clientName);
  setVal("clientEmail", r.clientEmail);
  setVal("clientAddress", r.clientAddress);

  // Linked Invoice
  setVal("reminderId", r.reminderId);
  setVal("linkedInvoice", r.linkedInvoice);
  setText("invoiceDate", r.invoiceDate);
  setText("dueDate", r.dueDate);
  setText("invoiceAmount", r.invoiceAmount);

  // Reminder Details
  setVal("reminderDate", r.reminderDate);
  setVal("status", r.status || "Draft");
  setVal("type", r.type || "First Reminder");
  setVal("amount", r.amount);
  setVal("message", r.message);

  // Signatures
  if(r.signatures?.business){
    const img=new Image();
    img.onload=()=>{
      const c=$("signatureBusiness");
      if(c){
        const ctx=c.getContext("2d");
        ctx.clearRect(0,0,c.width,c.height);
        ctx.drawImage(img,0,0);
      }
    };
    img.src=r.signatures.business;
    setText("signatureBusinessDate", r.signatures.businessDate);
  }
  if(r.signatures?.client){
    const img=new Image();
    img.onload=()=>{
      const c=$("signatureClient");
      if(c){
        const ctx=c.getContext("2d");
        ctx.clearRect(0,0,c.width,c.height);
        ctx.drawImage(img,0,0);
      }
    };
    img.src=r.signatures.client;
    setText("signatureClientDate", r.signatures.clientDate);
  }
}

  /* AI Helpers (заглушки) */
  window.aiFill=()=>{$("message").value="Dear client,\n\nThis is a polite reminder that your invoice is overdue. Please arrange payment.\n\nBest regards,\nSmartWerk";};
  window.aiDraft=()=>{$("message").value="We kindly remind you of your pending invoice. Please pay before the due date.";};
  window.aiStrict=()=>{$("message").value="FINAL NOTICE: Your invoice is overdue. Please transfer the outstanding amount immediately.";};
  window.aiFriendly=()=>{$("message").value="Hey! Just a friendly reminder 🙂 Don’t forget to complete your payment.";};
  window.translateMsg=(lang)=>{ 
    if(lang==="nl") $("message").value="Beste klant,\n\nDit is een herinnering voor uw openstaande factuur. Gelieve zo snel mogelijk te betalen.\n\nMet vriendelijke groet,\nSmartWerk";
    if(lang==="en") $("message").value="Dear client,\n\nThis is a reminder for your outstanding invoice. Please make the payment soon.\n\nBest regards,\nSmartWerk";
  };

  /* Init */
  onAuthStateChanged(auth, async(user)=>{
    if(!user){location.href="login.html";return;}
    flatpickr(".js-date",{dateFormat:"Y-m-d"});
    setupSignature("signatureBusiness","signatureBusinessDate");
    setupSignature("signatureClient","signatureClientDate");
    await loadReminderForEdit(user.uid);

    // Заповнити інвойси у select
    onSnapshot(collection(db,"users",user.uid,"invoices"),(snap)=>{
      const sel=$("linkedInvoice");
      const saved = sel.value;
      sel.innerHTML="<option value=''>— Select Invoice —</option>";

      snap.docs.forEach(d=>{
        const inv=d.data();
        const val = inv.invoiceNumber || d.id;
        const opt=document.createElement("option");
        opt.value=val;
        opt.text=val;
        opt.dataset.date=inv.invoiceDate||"";
        opt.dataset.due=inv.dueDate||"";
        opt.dataset.amount=inv.grandTotalFormatted||"";
        if(val===saved) opt.selected=true;
        sel.appendChild(opt);
      });
    });

    $("linkedInvoice").addEventListener("change",(e)=>{
      const opt=e.target.selectedOptions[0];
      $("invoiceDate").innerText=opt.dataset.date||"";
      $("dueDate").innerText=opt.dataset.due||"";
      $("invoiceAmount").innerText=opt.dataset.amount||"";
      $("amount").value=opt.dataset.amount||"";
    });

    $("saveBtn").addEventListener("click",(e)=>{e.preventDefault();saveReminder();});
  });
</script>
</body>
</html>
