<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartWerk â€” Payment Reminder</title>
  <link rel="stylesheet" href="style-invoices.css"/>
</head>
<body>
  <header>
    <h1>ğŸ“¬ SmartWerk â€” Payment Reminder</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="payment-reminder-list.html" class="btn">ğŸ“‹ Saved Reminders</a>
    </nav>
  </header>

  <main>
    <!-- Business Info -->
    <section>
      <h2>ğŸ¢ Business Info</h2>
      <input id="businessName" placeholder="Business Name"/>
      <input id="email" placeholder="Business Email"/>
      <input id="businessAddress" placeholder="Business Address"/>
      <input id="businessPhone" placeholder="Business Phone"/>
    </section>

    <!-- Client Info -->
    <section>
      <h2>ğŸ‘¤ Client Info</h2>
      <input id="clientName" placeholder="Client Name"/>
      <input id="clientEmail" placeholder="Client Email"/>
      <input id="clientAddress" placeholder="Client Address"/>
      <input id="clientPhone" placeholder="Client Phone"/>
    </section>

    <!-- Reminder Details -->
    <section>
      <h2>ğŸ“‘ Reminder Details</h2>
      <input id="reminderId" readonly placeholder="REM-2025-001"/>
      <select id="linkedInvoice"></select>
      <input id="invoiceDate" type="date" placeholder="Invoice Date"/>
      <input id="dueDate" type="date" placeholder="Due Date"/>
      <input id="reminderDate" type="date" placeholder="Reminder Date"/>
      <select id="status">
        <option value="First Reminder">First Reminder</option>
        <option value="Second Reminder">Second Reminder</option>
        <option value="Final Notice">Final Notice</option>
      </select>
      <input id="amountDue" type="number" placeholder="Amount Due (â‚¬)"/>
    </section>

    <!-- Payment Info -->
    <section>
      <h2>ğŸ’³ Payment Info</h2>
      <input id="paymentMethod" placeholder="Payment Method (e.g. Bank Transfer)"/>
      <input id="paymentReference" placeholder="Payment Reference"/>
      <input id="paymentLink" placeholder="Payment Link (optional)"/>
    </section>

    <!-- Message -->
    <section>
      <h2>âœ‰ï¸ Message</h2>
      <textarea id="messageBody" rows="6" placeholder="Dear client, this is a reminder..."></textarea>
      <div>
        <button type="button" onclick="aiFill()">ğŸ¤– AI Fill</button>
        <button type="button" onclick="aiDraft()">âœï¸ AI Draft</button>
        <button type="button" onclick="aiStrict()">ğŸ’¬ Make it more strict</button>
        <button type="button" onclick="aiFriendly()">ğŸ‘ Make it more friendly</button>
        <button type="button" onclick="translateMsg('en')">ğŸŒ EN</button>
        <button type="button" onclick="translateMsg('nl')">ğŸŒ NL</button>
      </div>
    </section>

    <!-- Signatures -->
    <section>
      <h2>âœï¸ Signatures</h2>
      <div>
        <h3>Business</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>
        <h3>Client</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step actions">
      <button id="saveBtn" class="btn-primary">ğŸ’¾ Save Reminder</button>
      <a href="payment-reminder-list.html" class="btn">ğŸ“‹ Saved Reminders</a>
    </section>
  </main>

  <footer>
    <p>Â© 2025 SmartWerk</p>
  </footer>

  <!-- Firebase + JS -->
  <script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, addDoc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
  authDomain: "smartwerk8520.firebaseapp.com",
  projectId: "smartwerk8520",
  appId: "1:607670981972:web:c07103c981c86860d724c1",
};
const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const $ = id => document.getElementById(id);

/* SIGNATURES */
function setupSignature(canvasId,dateId){
  const c=$(canvasId); const ctx=c.getContext("2d");
  let drawing=false;
  const start=()=>{drawing=true;ctx.beginPath();};
  const end=()=>{if(!drawing)return;drawing=false;$(dateId).innerText=new Date().toLocaleDateString("nl-NL");};
  const move=(e)=>{if(!drawing)return;const r=c.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;ctx.lineWidth=2;ctx.lineCap="round";ctx.strokeStyle="#000";ctx.lineTo(x,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y);};
  c.addEventListener("mousedown",start);c.addEventListener("mouseup",end);c.addEventListener("mouseleave",()=>drawing=false);c.addEventListener("mousemove",move);
  c.addEventListener("touchstart",(e)=>{e.preventDefault();start();});
  c.addEventListener("touchend",(e)=>{e.preventDefault();end();});
  c.addEventListener("touchmove",(e)=>{e.preventDefault();move(e);});
}
window.clearSignature=(id)=>{const c=$(id);c.getContext("2d").clearRect(0,0,c.width,c.height);if(id==="signatureBusiness")$("signatureBusinessDate").innerText="";if(id==="signatureClient")$("signatureClientDate").innerText="";};

/* AUTO REMINDER ID */
async function generateReminderId(uid){
  const ref = doc(db,"users",uid);
  const year = new Date().getFullYear();
  let out="";
  await runTransaction(db, async(tx)=>{
    const snap=await tx.get(ref);
    const last = snap.exists()? (snap.data().lastReminderNumber||0):0;
    const next=last+1;
    tx.set(ref,{ lastReminderNumber: next },{merge:true});
    out=`REM-${year}-${String(next).padStart(3,"0")}`;
  });
  return out;
}

/* SAVE */
async function saveReminder(){
  const user=auth.currentUser;if(!user){location.href="login.html";return;}
  const uid=user.uid;

  let reminderId=$("reminderId").value.trim();
  if(!reminderId){ reminderId=await generateReminderId(uid); $("reminderId").value=reminderId; }

  const data={
    businessName:$("businessName").value,
    email:$("email").value,
    businessAddress:$("businessAddress").value,
    businessPhone:$("businessPhone").value,
    clientName:$("clientName").value,
    clientEmail:$("clientEmail").value,
    clientAddress:$("clientAddress").value,
    clientPhone:$("clientPhone").value,
    reminderId,
    linkedInvoice:$("linkedInvoice").value,
    invoiceDate:$("invoiceDate").value,
    dueDate:$("dueDate").value,
    reminderDate:$("reminderDate").value,
    status:$("status").value,
    amountDue:parseFloat($("amountDue").value)||0,
    paymentMethod:$("paymentMethod").value,
    paymentReference:$("paymentReference").value,
    paymentLink:$("paymentLink").value,
    messageBody:$("messageBody").value,
    signatures:{
      business:$("signatureBusiness").toDataURL(),
      client:$("signatureClient").toDataURL(),
      businessDate:$("signatureBusinessDate").innerText||"",
      clientDate:$("signatureClientDate").innerText||""
    },
    userId:uid,
    updatedAt:new Date().toISOString()
  };

  await addDoc(collection(db,"users",uid,"reminders"), data);
  alert(`âœ… Reminder saved as ${reminderId}`);
  location.href="payment-reminder-list.html";
}
window.saveReminder=saveReminder;

/* AI HELPERS (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ¸ â€” Ñ‚ÑƒÑ‚ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğ¸ OpenAI API) */
window.aiFill=()=>{ $("messageBody").value="Dear client,\n\nThis is a polite reminder regarding your unpaid invoice. Please arrange the payment at your earliest convenience.\n\nBest regards,\nSmartWerk"; };
window.aiDraft=()=>{ $("messageBody").value="We kindly remind you of the pending payment. Please pay before the due date."; };
window.aiStrict=()=>{ $("messageBody").value="FINAL NOTICE: Your invoice is overdue. Please transfer the outstanding amount immediately."; };
window.aiFriendly=()=>{ $("messageBody").value="Hey! Just a friendly nudge ğŸ™‚ Donâ€™t forget to complete your payment."; };
window.translateMsg=(lang)=>{ 
  if(lang==="nl") $("messageBody").value="Beste klant,\n\nDit is een herinnering voor uw openstaande factuur. Gelieve zo snel mogelijk te betalen.\n\nMet vriendelijke groet,\nSmartWerk";
  if(lang==="en") $("messageBody").value="Dear client,\n\nThis is a reminder for your outstanding invoice. Please make the payment soon.\n\nBest regards,\nSmartWerk";
};

/* INIT */
onAuthStateChanged(auth, async(user)=>{
  if(!user){location.href="login.html";return;}
  setupSignature("signatureBusiness","signatureBusinessDate");
  setupSignature("signatureClient","signatureClientDate");
  $("saveBtn").addEventListener("click",saveReminder);
});

    
  </script>
</body>
</html>
