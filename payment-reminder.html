<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk â€” Payment Reminder</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>ğŸ“¬ SmartWerk â€” Payment Reminder</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="payment-reminder-list.html" class="btn">ğŸ“‹ Saved Reminders</a>
    </nav>
  </header>

  <main>
      <form id="reminderForm" onsubmit="return false">
   
   <!-- Business Info -->
 <section class="collapsible">
  <button type="button" class="section-toggle">ğŸ¢ Business Info</button>
  <div class="section-content">
  <input id="businessName" name="businessName" placeholder="Full Name / Business Name" autocomplete="organization" />
  <input id="email" name="email" placeholder="Business Email" autocomplete="email" />
  <input id="businessAddress" name="businessAddress" placeholder="Business Address" autocomplete="street-address" />
  <input id="businessPhone" name="businessPhone" placeholder="Business Phone" autocomplete="tel" />
    </div>
</section>

<!-- Client Info -->
 <section class="collapsible">
  <button type="button" class="section-toggle">ğŸ‘¤ Client Info</button>
  <div class="section-content">
  <input id="clientName" name="clientName" placeholder="Client Name" autocomplete="name" />
  <input id="clientEmail" name="clientEmail" placeholder="Client Email" autocomplete="email" />
  <input id="clientAddress" name="clientAddress" placeholder="Client Address" autocomplete="street-address" />
      </div>
</section>

    <!-- Linked Invoice -->
    <section>
      <h2>ğŸ“‘ Linked Invoice</h2>
      <select id="linkedInvoice" name="linkedInvoice" autocomplete="off">
        <option value="">â€” Select Invoice â€”</option></select>
      <p>Invoice Date: <span id="invoiceDate">â€”</span></p>
      <p>Due Date: <span id="dueDate">â€”</span></p>
      <p>Invoice Amount: <span id="invoiceAmount">â€”</span></p>
    </section>

 <section>
  <h2>â° Reminder Details</h2>

  <label for="reminderId">Reminder ID(auto)</label>
  <input id="reminderId" name="reminderId" readonly />

  <label for="reminderDate">Reminder Date</label>
  <input id="reminderDate" name="reminderDate" class="js-date" autocomplete="off" />

  <label for="status">Status</label>
  <select id="status" name="status" autocomplete="off">
    <option value="Draft">Draft</option>
    <option value="Sent">Sent</option>
    <option value="Paid">Paid</option>
  </select>

  <label for="type">Type</label>
  <select id="type" name="type" autocomplete="off">
    <option value="First Reminder">First Reminder</option>
    <option value="Second Reminder">Second Reminder</option>
    <option value="Final Reminder">Final Reminder</option>
  </select>

  <label for="amount">Amount</label>
  <input id="amount" name="amount" autocomplete="off" />
</section>

    <!-- Message -->
    <section>
      <h2>ğŸ’¬ Message</h2>
      <textarea id="message" name="message" autocomplete="off" placeholder="Message body..."></textarea>
      <div class="actions">
        <button id="aiFillBtn" type="button" onclick="aiFill()">ğŸ¤– AI Fill</button>
        <button id="aiDraftBtn" type="button" onclick="aiDraft()">âœï¸ AI Draft</button>
        <button type="button" onclick="aiStrict()">ğŸ’¬ Strict</button>
        <button type="button" onclick="aiFriendly()">ğŸ‘ Friendly</button>
        <button type="button" onclick="translateMsg('en')">ğŸŒ EN</button>
        <button type="button" onclick="translateMsg('nl')">ğŸŒ NL</button>
      </div>
    </section>

    <!-- Signatures -->
    <section>
      <h2>âœï¸ Signatures</h2>
      <div>
        <h3>Business</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100" aria-hidden="true"></canvas>
        <button type="button" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>   
        <h3>Client</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100" aria-hidden="true"></canvas>
        <button type="button" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step actions">
      <button id="saveBtn" name="saveBtn" type="submit" class="btn-primary">ğŸ’¾ Save Reminder</button>
      <a href="payment-reminder-list.html" class="btn" role="button">ğŸ“‹ Saved Reminders</a>
    </section>

        </form>
  </main>

  <footer>
    <p>Â© 2025 SmartWerk</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot, runTransaction, serverTimestamp, setLogLevel
           } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
     setLogLevel("error");

    
    /* Firebase init */
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* Helpers (Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ñ–) */
    const $      = (id) => document.getElementById(id);
    const val    = (id) => (document.getElementById(id)?.value ?? "").trim();
    const text   = (id) => (document.getElementById(id)?.innerText ?? "").trim();
    const setVal = (id, v="") => { const el=$(id); if(el) el.value = v ?? ""; };
    const setText= (id, v="") => { const el=$(id); if(el) el.innerText = v ?? ""; };

    /* ID Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ */
    async function generateReminderId(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastReminderNumber||0) : 0;
        const next = last + 1;
        tx.set(ref,{ lastReminderNumber: next },{ merge:true });
        out = `REM-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    /* Signatures */
    function setupSignature(canvasId,dateId){
      const c=$(canvasId); if(!c) return;
      const ctx=c.getContext("2d");
      let drawing=false;
      const start=()=>{drawing=true;ctx.beginPath();};
      const end=()=>{if(!drawing)return;drawing=false;setText(dateId, new Date().toLocaleDateString("nl-NL"));};
      const move=(e)=>{ if(!drawing)return;
        const r=c.getBoundingClientRect();
        const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
        const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
        ctx.lineWidth=2; ctx.lineCap="round"; ctx.strokeStyle="#000";
        ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y);
      };
      c.addEventListener("mousedown",start);
      c.addEventListener("mouseup",end);
      c.addEventListener("mouseleave",()=>drawing=false);
      c.addEventListener("mousemove",move);
      c.addEventListener("touchstart",(e)=>{e.preventDefault();start();});
      c.addEventListener("touchend",(e)=>{e.preventDefault();end();});
      c.addEventListener("touchmove",(e)=>{e.preventDefault();move(e);});
    }
    window.clearSignature=(id)=>{
      const c=$(id); if(!c) return;
      c.getContext("2d").clearRect(0,0,c.width,c.height);
      if(id==="signatureBusiness") setText("signatureBusinessDate","");
      if(id==="signatureClient")   setText("signatureClientDate","");
    };

    /* Load for edit */
    async function loadReminderForEdit(uid){
      const editId = localStorage.getItem("editReminderId");
      if(!editId) return;

      const snap = await getDoc(doc(db,"users",uid,"reminders",editId));
      if(!snap.exists()){ localStorage.removeItem("editReminderId"); return; }
      const r = snap.data();

      // Business
      setVal("businessName", r.businessName);
      setVal("email", r.email);
      setVal("businessAddress", r.businessAddress);
      setVal("businessPhone", r.businessPhone);
      
    
      // Client
      setVal("clientName", r.clientName);
      setVal("clientEmail", r.clientEmail);
      setVal("clientAddress", r.clientAddress);

      // Linked invoice
      setVal("reminderId", r.reminderId);
      setVal("linkedInvoice", r.linkedInvoice);
      setText("invoiceDate", r.invoiceDate);
      setText("dueDate", r.dueDate);
      setText("invoiceAmount", r.invoiceAmount);

      // Details
      setVal("reminderDate", r.reminderDate);
      setVal("status", r.status || "Draft");
      setVal("type", r.type || "First Reminder");
      setVal("amount", typeof r.amount==="number" ? r.amount.toFixed(2) : (r.amount||""));
      setVal("message", r.message);

      // Signatures
      if(r.signatures?.business){
        const img=new Image();
        img.onload=()=>{ const c=$("signatureBusiness"); if(!c) return;
          const ctx=c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height); ctx.drawImage(img,0,0);
        };
        img.src = r.signatures.business;
        setText("signatureBusinessDate", r.signatures.businessDate);
      }
      if(r.signatures?.client){
        const img=new Image();
        img.onload=()=>{ const c=$("signatureClient"); if(!c) return;
          const ctx=c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height); ctx.drawImage(img,0,0);
        };
        img.src = r.signatures.client;
        setText("signatureClientDate", r.signatures.clientDate);
      }
    }
    async function logActivity(uid, type, message) {
  try {
    await addDoc(collection(db, "users", uid, "events"), {
      type, message, createdAt: serverTimestamp()
    });
  } catch (e) {
    console.warn("Activity log failed:", e);
  }
}

    /* Save */
    /* ========== SAVE REMINDER (Final Stable) ========== */
async function saveReminder() {
  const user = auth.currentUser;
  if (!user) {
    location.href = "login.html";
    return;
  }
  const uid = user.uid;
  const editingId = localStorage.getItem("editReminderId") || null;

  // reminderId Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾
  let reminderId = val("reminderId");
  if (!editingId && !reminderId) {
    reminderId = await generateReminderId(uid);
    setVal("reminderId", reminderId);
  }

  // Amount parsing
  const amountStr = (val("amount") || text("invoiceAmount") || "0")
    .replace(/[^\d,.\-]/g, "")
    .replace(",", ".");
  const amountNum = parseFloat(amountStr) || 0;

  // Data
  const data = {
    reminderId,
    linkedInvoice: val("linkedInvoice"),
    businessName: val("businessName"),
    email: val("email"),
    businessPhone: val("businessPhone"),
    businessAddress: val("businessAddress"),
    clientName: val("clientName"),
    clientEmail: val("clientEmail"),
    clientAddress: val("clientAddress"),
    invoiceDate: text("invoiceDate"),
    dueDate: text("dueDate"),
    invoiceAmount: text("invoiceAmount"),
    amount: amountNum,
    status: val("status") || "Draft",
    type: val("type") || "First Reminder",
    message: val("message"),
    reminderDate: val("reminderDate") || new Date().toISOString().split("T")[0],
    signatures: {
      business: $("signatureBusiness")?.toDataURL() || "",
      client: $("signatureClient")?.toDataURL() || "",
      businessDate: text("signatureBusinessDate"),
      clientDate: text("signatureClientDate"),
    },
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    userId: uid,
  };

  try {
    if (editingId) {
      await setDoc(doc(db, "users", uid, "reminders", editingId), data, { merge: true });
      await logActivity(uid, "Reminder Updated", `${data.reminderId || "(no ID)"} updated`);
      alert("âœ… Reminder updated");
    } else {
      await addDoc(collection(db, "users", uid, "reminders"), data);
      await logActivity(uid, "Reminder Created", `${data.reminderId || "(no ID)"} created`);
      alert(`âœ… Reminder saved${data.reminderId ? " as " + data.reminderId : ""}`);
    }
  } catch (e) {
    console.error("âŒ Error saving reminder:", e);
    alert("âš ï¸ Error saving reminder: " + e.message);
  }

  localStorage.removeItem("editReminderId");
  location.href = "payment-reminder-list.html";
}
window.saveReminder = saveReminder;

    /* AI (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ¸) */
    window.aiFill     = ()=> setVal("message","Dear client,\n\nThis is a polite reminder that your invoice is overdue. Please arrange payment.\n\nBest regards,\nSmartWerk");
    window.aiDraft    = ()=> setVal("message","We kindly remind you of your pending invoice. Please pay before the due date.");
    window.aiStrict   = ()=> setVal("message","FINAL NOTICE: Your invoice is overdue. Please transfer the outstanding amount immediately.");
    window.aiFriendly = ()=> setVal("message","Hey! Just a friendly reminder  Donâ€™t forget to complete your payment.");
    window.translateMsg=(lang)=>{
      if(lang==="nl") setVal("message","Beste klant,\n\nDit is een herinnering voor uw openstaande factuur. Gelieve zo snel mogelijk te betalen.\n\nMet vriendelijke groet,\nSmartWerk");
      if(lang==="en") setVal("message","Dear client,\n\nThis is a reminder for your outstanding invoice. Please make the payment soon.\n\nBest regards,\nSmartWerk");
    };
    // ğŸŒ¿ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğµ Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°, ÑĞºÑ‰Ğ¾ Ğ¿Ñ€Ğ¸Ğ¹ÑˆĞ»Ğ¸ Ğ· clients-list
document.addEventListener("DOMContentLoaded", () => {
  const savedClient = localStorage.getItem("selectedClient");
  if (savedClient) {
    const c = JSON.parse(savedClient);
    if ($("clientName")) $("clientName").value = c.clientName || "";
    if ($("clientEmail")) $("clientEmail").value = c.email || "";
    if ($("clientAddress")) $("clientAddress").value = c.address || "";
    localStorage.removeItem("selectedClient");
    console.log("âœ… Client data autofilled into Payment Reminder");
  }
});


  // === ğŸ”„ AUTO-FILL BUSINESS INFO from profile.html ===
async function loadProfileData(uid) {
  try {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) return;
    const p = snap.data();

    if (p.businessName) $("businessName").value = p.businessName;
    if (p.email) $("email").value = p.email;
    if (p.businessAddress) $("businessAddress").value = p.businessAddress;
    if (p.businessPhone) $("businessPhone").value = p.businessPhone;
   
    console.log("âœ… Business info auto-filled from profile");
  } catch (e) {
    console.error("Profile load error:", e);
  }
}
      flatpickr(".js-date",{ dateFormat:"Y-m-d" });
      setupSignature("signatureBusiness","signatureBusinessDate");
      setupSignature("signatureClient","signatureClientDate");

       document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".section-toggle").forEach(button => {
      button.addEventListener("click", () => {
        const content = button.nextElementSibling;
        content.classList.toggle("open");
      });
    });
  });

      // Ğ†Ğ½Ğ²Ğ¾Ğ¹ÑĞ¸ Ğ² ÑĞµĞ»ĞµĞºÑ‚Ñ–
   onAuthStateChanged(auth, async (user)=>{
  if (!user) {
    location.href = "login.html";
    return;
  }

      

  await loadProfileData(user.uid);
  await loadReminderForEdit(user.uid);


  // ğŸ”„ Ğ†Ğ½Ğ²Ğ¾Ğ¹ÑĞ¸ Ğ² ÑĞµĞ»ĞµĞºÑ‚Ñ– â€” ĞŸĞ•Ğ Ğ•ĞĞ•Ğ¡Ğ•ĞĞ Ğ¡Ğ®Ğ”Ğ˜
  onSnapshot(collection(db, "users", user.uid, "invoices"), (snap) => {
    const sel = $("linkedInvoice");
    if (!sel) return;
    const saved = sel.value;
    sel.innerHTML = "<option value=''>â€” Select Invoice â€”</option>";

    snap.docs.forEach((d) => {
    const inv = d.data();
    const val = inv.invoiceNumber || d.id;
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = val;

    // Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ğ´Ğ°Ğ½Ñ–
    opt.dataset.date = inv.invoiceDate || "";
    opt.dataset.due = inv.dueDate || "";
    opt.dataset.amount = inv.grandTotalFormatted || String(inv.grandTotal || "");

    // âœ… Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚ÑÑŒĞºÑ– Ğ´Ğ°Ğ½Ñ–
    opt.dataset.clientName = inv.clientName || "";
    opt.dataset.clientEmail = inv.clientEmail || "";
    opt.dataset.clientAddress = inv.clientAddress || "";

    if (val === saved) opt.selected = true;
    sel.appendChild(opt);
  });
});

     
  $("linkedInvoice")?.addEventListener("change", (e) => {
  const opt = e.target.selectedOptions?.[0];
  if (!opt) return;
  setText("invoiceDate", opt.dataset.date || "");
  setText("dueDate", opt.dataset.due || "");
  setText("invoiceAmount", opt.dataset.amount || "");

  // âœ… Ğ·Ğ°Ğ²Ğ¶Ğ´Ğ¸ Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ amount Ğ¿Ñ€Ğ¸ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñ– Ñ–Ğ½Ğ²Ğ¾Ğ¹ÑÑƒ
  setVal("amount", opt.dataset.amount || "");
  setVal("clientName", opt.dataset.clientName || "");
  setVal("clientEmail", opt.dataset.clientEmail || "");
  setVal("clientAddress", opt.dataset.clientAddress || "");
});

  $("saveBtn")?.addEventListener("click", (e) => {
    e.preventDefault();
    saveReminder();
  });
});
    
  </script>
</body>
</html>
