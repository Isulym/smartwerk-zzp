<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartWerk — Payment Reminder</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>📬 SmartWerk — Payment Reminder</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="payment-reminder-list.html" class="btn">📋 Saved Reminders</a>
    </nav>
  </header>

  <main>
    <!-- Business Info -->
    <section>
      <h2>🏢 Business Info</h2>
      <input id="businessName" placeholder="Business Name"/>
      <input id="businessEmail" placeholder="Business Email"/>
      <input id="businessAddress" placeholder="Business Address"/>
      <input id="businessPhone" placeholder="Business Phone"/>
      <input id="iban" placeholder="IBAN"/>
      <input id="bic" placeholder="BIC"/>
    </section>

    <!-- Client Info -->
    <section>
      <h2>👤 Client Info</h2>
      <input id="clientName" placeholder="Client Name"/>
      <input id="clientEmail" placeholder="Client Email"/>
      <input id="clientAddress" placeholder="Client Address"/>
      <input id="clientPhone" placeholder="Client Phone"/>
    </section>

    <!-- Reminder Details -->
    <section>
      <h2>📑 Reminder Details</h2>
      <input id="reminderId" readonly placeholder="REM-2025-001"/>
      <label>Linked Invoice:
        <select id="linkedInvoice"></select>
      </label>
      <input id="invoiceDate" class="js-date" placeholder="Invoice Date"/>
      <input id="dueDate" class="js-date" placeholder="Due Date"/>
      <input id="reminderDate" class="js-date" placeholder="Reminder Date"/>
      <select id="status">
        <option value="Draft">Draft</option>
        <option value="First Reminder">First Reminder</option>
        <option value="Second Reminder">Second Reminder</option>
        <option value="Final Reminder">Final Reminder</option>
        <option value="Paid">Paid</option>
      </select>
    </section>

    <!-- Amounts -->
    <section>
      <h2>💶 Amounts</h2>
      <p>Subtotal: <span id="subtotal">€0.00</span></p>
      <p>VAT: <span id="totalVat">€0.00</span></p>
      <p>Total: <span id="grandTotal">€0.00</span></p>
    </section>

    <!-- Message -->
    <section>
      <h2>💬 Message</h2>
      <textarea id="message" placeholder="Write your reminder message..."></textarea>
      <div class="ai-tools">
        <button type="button" onclick="aiFill()">🤖 AI Fill</button>
        <button type="button" onclick="aiDraft()">✍️ AI Draft</button>
        <button type="button" onclick="makeStrict()">💬 Make it more strict</button>
        <button type="button" onclick="makeFriendly()">👍 Make it more friendly</button>
        <button type="button" onclick="translateEN()">🌐 EN</button>
        <button type="button" onclick="translateNL()">🌐 NL</button>
      </div>
    </section>

    <!-- Payment Info -->
    <section>
      <h2>💳 Payment Info</h2>
      <input id="paymentLink" placeholder="Payment Link (optional)"/>
    </section>

    <!-- Signatures -->
    <section>
      <h2>✍️ Signatures</h2>
      <div>
        <h3>Business</h3>
        <canvas id="signatureBusiness" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureBusiness')">Clear</button>
        <p>Date: <span id="signatureBusinessDate"></span></p>
      </div>
      <div>
        <h3>Client</h3>
        <canvas id="signatureClient" class="signature" width="300" height="100"></canvas>
        <button type="button" onclick="clearSignature('signatureClient')">Clear</button>
        <p>Date: <span id="signatureClientDate"></span></p>
      </div>
    </section>

    <!-- Actions -->
    <section class="step actions">
      <button id="saveBtn" class="btn-primary">💾 Save Reminder</button>
      <a href="payment-reminder-list.html" class="btn">📋 Saved Reminders</a>
    </section>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, addDoc, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);

    /* Signature setup */
    function setupSignature(canvasId,dateId){
      const c=$(canvasId); const ctx=c.getContext("2d");
      let drawing=false;
      const start=()=>{drawing=true;ctx.beginPath();};
      const end=()=>{if(!drawing)return;drawing=false;$(dateId).innerText=new Date().toLocaleDateString("nl-NL");};
      const move=(e)=>{if(!drawing)return;const r=c.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;ctx.lineWidth=2;ctx.strokeStyle="#000";ctx.lineTo(x,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y);};
      c.addEventListener("mousedown",start);c.addEventListener("mouseup",end);c.addEventListener("mouseleave",()=>drawing=false);c.addEventListener("mousemove",move);
      c.addEventListener("touchstart",(e)=>{e.preventDefault();start();});
      c.addEventListener("touchend",(e)=>{e.preventDefault();end();});
      c.addEventListener("touchmove",(e)=>{e.preventDefault();move(e);});
    }
    window.clearSignature=(id)=>{const c=$(id);c.getContext("2d").clearRect(0,0,c.width,c.height);};

    /* Number generation */
    async function generateReminderNumber(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastReminderNumber||0) : 0;
        const next = last+1;
        tx.set(ref,{ lastReminderNumber: next },{ merge:true });
        out=`REM-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    /* Save */
    async function saveReminder(){
      const user=auth.currentUser; if(!user){location.href="login.html";return;}
      const uid=user.uid;

      let reminderId=$("reminderId").value.trim();
      if(!reminderId) reminderId=await generateReminderNumber(uid);

      const data={
        businessName:$("businessName").value,
        businessEmail:$("businessEmail").value,
        businessAddress:$("businessAddress").value,
        businessPhone:$("businessPhone").value,
        iban:$("iban").value,
        bic:$("bic").value,

        clientName:$("clientName").value,
        clientEmail:$("clientEmail").value,
        clientAddress:$("clientAddress").value,
        clientPhone:$("clientPhone").value,

        reminderId,
        linkedInvoice:$("linkedInvoice").value,
        invoiceDate:$("invoiceDate").value,
        dueDate:$("dueDate").value,
        reminderDate:$("reminderDate").value,
        status:$("status").value,

        subtotal:$("subtotal").innerText,
        totalVat:$("totalVat").innerText,
        grandTotal:$("grandTotal").innerText,

        message:$("message").value,
        paymentLink:$("paymentLink").value,

        signatures:{
          business:$("signatureBusiness").toDataURL(),
          client:$("signatureClient").toDataURL(),
          businessDate:$("signatureBusinessDate").innerText,
          clientDate:$("signatureClientDate").innerText
        },

        userId:uid,
        updatedAt:new Date().toISOString()
      };

      await addDoc(collection(db,"users",uid,"reminders"), data);
      alert(`✅ Reminder saved as ${reminderId}`);
      location.href="payment-reminder-list.html";
    }
    window.saveReminder=saveReminder;

    /* Linked Invoices */
    async function populateInvoices(uid){
      const sel=$("linkedInvoice");
      sel.innerHTML=`<option value="">— Select Invoice —</option>`;
      const snap=await getDocs(collection(db,"users",uid,"invoices"));
      snap.forEach(d=>{
        const inv=d.data();
        const opt=document.createElement("option");
        opt.value=inv.invoiceNumber;
        opt.textContent=`${inv.invoiceNumber} — ${inv.clientName||""} (${inv.grandTotalFormatted||""})`;
        sel.appendChild(opt);
      });
    }

    /* AI tools — поки що прості заглушки */
    window.aiFill=()=>{ $("message").value="This is a polite payment reminder. Please settle the outstanding invoice."; };
    window.aiDraft=()=>{ $("message").value="We kindly remind you that your payment is overdue. Please make the payment as soon as possible."; };
    window.makeStrict=()=>{ $("message").value="Your payment is overdue. Settle immediately to avoid legal actions."; };
    window.makeFriendly=()=>{ $("message").value="Just a friendly reminder 😊 Please don’t forget to pay your invoice."; };
    window.translateEN=()=>{ $("message").value="This is an English version of your reminder message."; };
    window.translateNL=()=>{ $("message").value="Dit is een Nederlandse versie van uw betalingsherinnering."; };

    /* INIT */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="login.html"; return; }
      flatpickr(".js-date",{dateFormat:"Y-m-d"});
      setupSignature("signatureBusiness","signatureBusinessDate");
      setupSignature("signatureClient","signatureClientDate");
      await populateInvoices(user.uid);
    });

    document.getElementById("saveBtn")?.addEventListener("click",(e)=>{
      e.preventDefault(); saveReminder();
    });
  </script>
</body>
</html>
