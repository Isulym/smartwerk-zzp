<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartWerk — Quotes List</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>📋 SmartWerk Quotes</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="quote-offer.html" class="btn">➕ New Quote</a>
    </nav>
  </header>

  <main>
    <!-- Фільтри -->
    <section>
      <h2>🔎 Filters</h2>
      <label>Status:
        <select id="statusFilter">
          <option value="all">All</option>
          <option value="Draft">Draft</option>
          <option value="Sent">Sent</option>
          <option value="Accepted">Accepted</option>
          <option value="Rejected">Rejected</option>
        </select>
      </label>
      <label>From: <input id="fromDate" class="js-date" placeholder="YYYY-MM-DD"></label>
      <label>To: <input id="toDate" class="js-date" placeholder="YYYY-MM-DD"></label>
      <label>Search: <input id="searchBox" placeholder="Client / Quote # / Amount"></label>
      <label>Sort by:
        <select id="sortBy">
          <option value="date_desc">Date ↓</option>
          <option value="date_asc">Date ↑</option>
          <option value="quoteNumber_desc">Quote # ↓</option>
          <option value="quoteNumber_asc">Quote # ↑</option>
          <option value="amount_desc">Amount ↓</option>
          <option value="amount_asc">Amount ↑</option>
        </select>
      </label>
    </section>

    <!-- Таблиця -->
    <section>
      <table>
        <thead>
          <tr>
            <th>Quote #</th>
            <th>Client</th>
            <th>Status</th>
            <th>Date</th>
            <th>Total</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="quotesBody"></tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, getDocs, deleteDoc, doc, setDoc, addDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);
    let quotes = [];

    /* Завантаження Quotes */
    async function loadQuotes(uid){
      quotes = [];
      const snap = await getDocs(collection(db,"users",uid,"quotes"));
      snap.forEach(docSnap=>{
        quotes.push({id:docSnap.id,...docSnap.data()});
      });
      renderQuotes();
    }

    /* Відображення Quotes */
    function renderQuotes(){
      const body = $("quotesBody");
      body.innerHTML = "";

      const from = $("fromDate").value;
      const to = $("toDate").value;
      const status = $("statusFilter").value;
      const search = $("searchBox").value.toLowerCase();
      const sortBy = $("sortBy").value;

      let filtered = quotes.filter(q=>{
        let ok = true;
        if(status!=="all") ok = ok && q.status===status;
        if(from) ok = ok && q.quoteDate >= from;
        if(to) ok = ok && q.quoteDate <= to;
        if(search){
          ok = ok && (
            (q.clientName||"").toLowerCase().includes(search) ||
            (q.quoteNumber||"").toLowerCase().includes(search) ||
            String(q.grandTotal||"").toLowerCase().includes(search)
          );
        }
        return ok;
      });

      filtered.sort((a,b)=>{
        switch(sortBy){
          case "quoteNumber_desc": return (b.quoteNumber||"").localeCompare(a.quoteNumber||"");
          case "quoteNumber_asc": return (a.quoteNumber||"").localeCompare(b.quoteNumber||"");
          case "date_desc": return (b.quoteDate||"").localeCompare(a.quoteDate||"");
          case "date_asc": return (a.quoteDate||"").localeCompare(b.quoteDate||"");
          case "amount_desc": return (parseFloat(b.grandTotal)||0) - (parseFloat(a.grandTotal)||0);
          case "amount_asc": return (parseFloat(a.grandTotal)||0) - (parseFloat(b.grandTotal)||0);
        }
        return 0;
      });

      filtered.forEach(q=>{
        const tr = document.createElement("tr");
        tr.innerHTML=`
          <td>${q.quoteNumber||"—"}</td>
          <td>${q.clientName||"—"}</td>
          <td>${q.status||"Draft"}</td>
          <td>${q.quoteDate||"—"}</td>
          <td>€${parseFloat(q.grandTotal||0).toFixed(2)}</td>
          <td>
            <button onclick="editQuote('${q.id}')">✏️ Edit</button>
            <button onclick="deleteQuote('${q.id}')">🗑 Delete</button>
            <button onclick="downloadPDF('${q.id}',true)">📄 PDF</button>
            <button onclick="downloadPDF('${q.id}',false)">PRO 📄 PDF</button>
            <button onclick="convertToInvoice('${q.id}')">🔄 Convert to Invoice</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    /* Edit */
    window.editQuote = function(id){
      localStorage.setItem("editQuoteId",id);
      location.href="quote-offer.html";
    };

    /* Delete */
    window.deleteQuote = async function(id){
      if(!confirm("❌ Delete this quote?")) return;
      await deleteDoc(doc(db,"users",auth.currentUser.uid,"quotes",id));
      quotes = quotes.filter(q=>q.id!==id);
      renderQuotes();
    };

    /* PDF */
    window.downloadPDF = function(id,withBranding=true){
      const q = quotes.find(x=>x.id===id);
      if(!q) return;
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF();

      docPDF.setFontSize(18);
      docPDF.text("Quote / Offer",14,20);

      if(withBranding){
        docPDF.setFontSize(10);
        docPDF.text("Generated with SmartWerk",14,28);
      }

      docPDF.autoTable({
        startY:40,
        head:[["Quote #","Client","Date","Status","Total"]],
        body:[[q.quoteNumber,q.clientName,q.quoteDate,q.status,"€"+parseFloat(q.grandTotal||0).toFixed(2)]]
      });

      docPDF.save(`${q.quoteNumber}.pdf`);
    };

    /* Convert to Invoice */
    window.convertToInvoice = async function(id){
      const q = quotes.find(x=>x.id===id);
      if(!q) return;
      const uid = auth.currentUser.uid;
      const data = {
        ...q,
        invoiceNumber: q.quoteNumber.replace("QUO","INV"),
        convertedFrom: q.quoteNumber,
        status:"Draft"
      };
      await addDoc(collection(db,"users",uid,"invoices"),data);
      alert("✅ Converted to Invoice!");
    };

    /* INIT */
    onAuthStateChanged(auth,async(user)=>{
      if(!user){ location.href="login.html"; return; }
      flatpickr(".js-date",{dateFormat:"Y-m-d"});
      await loadQuotes(user.uid);
    });

    ["statusFilter","fromDate","toDate","searchBox","sortBy"].forEach(id=>{
      $(id).addEventListener("input",renderQuotes);
    });
  </script>
</body>
</html>
