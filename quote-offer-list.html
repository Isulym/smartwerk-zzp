<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartWerk — Quote List</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <header>
    <h1>📑 SmartWerk Quotes</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="quote-offer-2.html" class="btn">➕ New Quote</a>
      <a href="invoices-list.html" class="btn">🧾 Invoices</a>
    </nav>
  </header>

  <main>
    <h2>📋 Saved Quotes</h2>
    <table>
      <thead>
        <tr>
          <th>Quote #</th>
          <th>Client</th>
          <th>Status</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="quotesBody"></tbody>
    </table>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, getDocs, deleteDoc, doc, getDoc, addDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
    authDomain: "smartwerk8520.firebaseapp.com",
    projectId: "smartwerk8520",
    appId: "1:607670981972:web:c07103c981c86860d724c1",
  };
  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const $ = id => document.getElementById(id);
  let quotes = [];

  async function loadQuotes(uid){
    const snap = await getDocs(collection(db,"users",uid,"quotes"));
    quotes = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderQuotes();
  }

  function renderQuotes(){
    const body = $("quotesBody");
    body.innerHTML="";
    quotes.forEach(inv=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${inv.quoteNumber||"—"}</td>
        <td>${inv.clientName||"—"}</td>
        <td>${inv.status||"Draft"}</td>
        <td>${inv.quoteDate||"—"}</td>
        <td>€${parseFloat(inv.grandTotal||0).toFixed(2)}</td>
        <td>
          <button onclick="editQuote('${inv.id}')">✏️ Edit</button>
          <button onclick="deleteQuote('${inv.id}')">🗑 Delete</button>
          <button onclick="downloadQuotePDF('${inv.id}', true)">📄 PDF</button>
          <button onclick="downloadQuotePDF('${inv.id}', false)">PRO 📄 PDF without branding</button>
          <button onclick="sendQuote('${inv.id}')">📧 Send Quote</button>
          <button onclick="convertToInvoice('${inv.id}')">➡️ Convert to Invoice</button>
        </td>`;
      body.appendChild(tr);
    });
  }

  // === ACTIONS ===
  window.editQuote = (id)=>{
    localStorage.setItem("editQuoteId",id);
    location.href="quote-offer-2.html";
  };

  window.deleteQuote = async(id)=>{
    if(!confirm("❌ Delete this quote?")) return;
    const user=auth.currentUser; if(!user) return;
    await deleteDoc(doc(db,"users",user.uid,"quotes",id));
    quotes=quotes.filter(q=>q.id!==id);
    renderQuotes();
  };

  window.downloadQuotePDF = (id,withBranding=true)=>{
    const inv = quotes.find(i=>i.id===id);
    if(!inv) return;
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF();

    docPDF.setFontSize(18);
    docPDF.text("QUOTE",105,15,{align:"center"});

    docPDF.setFontSize(12);
    docPDF.text("From:",14,30);
    docPDF.text([
      inv.businessName||"",
      `KvK: ${inv.kvk||""}`,
      `IBAN: ${inv.iban||""}`,
      `Email: ${inv.email||""}`,
      `BTW: ${inv.btw||""}`,
      `Address: ${inv.businessAddress||""}`,
      `Phone: ${inv.businessPhone||""}`
    ],14,36);

    docPDF.text("To:",120,30);
    docPDF.text([
      inv.clientName||"",
      inv.clientEmail||"",
      `Address: ${inv.clientAddress||""}`,
      `Phone: ${inv.clientPhone||""}`
    ],120,36);

    // Загальна інформація
    docPDF.autoTable({
      startY: 80,
      head: [["Quote #","Date","Status"]],
      body: [[inv.quoteNumber,inv.quoteDate,inv.status]],
      theme:"grid",
      styles:{fontSize:11,cellPadding:4,halign:"center",valign:"middle"},
      headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"}
    });

    // Items
    const items = inv.items?.map(it=>[
      it.desc,
      it.qty,
      `€${parseFloat(it.price).toFixed(2)}`,
      `${it.vat}%`,
      `€${(it.qty*it.price*(1+it.vat/100)).toFixed(2)}`
    ])||[];

    docPDF.autoTable({
      startY: docPDF.lastAutoTable.finalY+10,
      head:[["Description","Qty","Unit Price","VAT","Total"]],
      body: items,
      theme:"grid",
      styles:{fontSize:11,cellPadding:4,halign:"center",valign:"middle"},
      headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"}
    });

    docPDF.text(`Subtotal: €${parseFloat(inv.subtotal||0).toFixed(2)}`,150,docPDF.lastAutoTable.finalY+10);
    docPDF.text(`VAT: €${parseFloat(inv.totalVat||0).toFixed(2)}`,150,docPDF.lastAutoTable.finalY+16);
    docPDF.text(`Total: €${parseFloat(inv.grandTotal||0).toFixed(2)}`,150,docPDF.lastAutoTable.finalY+22);

    if(withBranding){
      docPDF.setFontSize(10);
      docPDF.text("Generated with SmartWerk",105,290,{align:"center"});
    }

    docPDF.save(`${inv.quoteNumber||"quote"}.pdf`);
  };

  // Send Quote
  window.sendQuote = async(id)=>{
    const inv = quotes.find(q=>q.id===id);
    if(!inv) return;
    const subject = encodeURIComponent(`Quote ${inv.quoteNumber} from ${inv.businessName}`);
    const body = encodeURIComponent(`Hello ${inv.clientName},\n\nPlease find attached your quote.\n\nRegards,\n${inv.businessName}`);
    window.location.href = `mailto:${inv.clientEmail}?subject=${subject}&body=${body}`;
  };

  // Convert to Invoice
  async function generateInvoiceNumber(uid){
    const ref = doc(db,"users",uid);
    const year = new Date().getFullYear();
    let final="";
    await runTransaction(db,async(tx)=>{
      const snap=await tx.get(ref);
      const last=snap.exists()?(snap.data().lastInvoiceNumber||0):0;
      const next=last+1;
      final=`INV-${year}-${String(next).padStart(3,"0")}`;
      tx.set(ref,{lastInvoiceNumber:next},{merge:true});
    });
    return final;
  }

  window.convertToInvoice = async(quoteId)=>{
    const user=auth.currentUser; if(!user) return;
    const ref=doc(db,"users",user.uid,"quotes",quoteId);
    const snap=await getDoc(ref);
    if(!snap.exists()) return alert("Quote not found");
    const quote=snap.data();
    const invoiceNumber=await generateInvoiceNumber(user.uid);

    const invoiceData={
      ...quote,
      invoiceNumber,
      status:"Draft",
      convertedFrom:quoteId,
      updatedAt:new Date().toISOString()
    };
    await addDoc(collection(db,"users",user.uid,"invoices"),invoiceData);
    alert(`✅ Converted to Invoice ${invoiceNumber}`);
    location.href="invoices-list.html";
  };

  // INIT
  onAuthStateChanged(auth,user=>{
    if(!user) return location.href="login.html";
    loadQuotes(user.uid);
  });
</script>
</body>
</html>
