<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk — Quotes List</title>
  <link rel="stylesheet" href="style-quote-offer.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>📋 Quotes Overview</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="quote-offer.html" class="btn">➕ New Quote</a>
    </nav>
  </header>

  <main>
    <!-- Filters -->
    <section class="filters">
      <input id="searchBox" placeholder="🔍 Search by client, number, amount">
      <select id="statusFilter">
        <option value="all">All statuses</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Accepted">Accepted</option>
        <option value="Rejected">Rejected</option>
      </select>
      <input id="fromDate" class="js-date" placeholder="From (YYYY-MM-DD)">
      <input id="toDate" class="js-date" placeholder="To (YYYY-MM-DD)">
      <select id="sortBy">
        <option value="date_desc">Newest</option>
        <option value="date_asc">Oldest</option>
        <option value="number_desc">Quote # ↓</option>
        <option value="number_asc">Quote # ↑</option>
        <option value="amount_desc">Amount ↓</option>
        <option value="amount_asc">Amount ↑</option>
      </select>
      <button onclick="renderQuotes()">Apply</button>
    </section>

    <!-- Table -->
    <table>
      <thead>
        <tr>
          <th>Quote #</th>
          <th>Client</th>
          <th>Status</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="quotesBody"></tbody>
    </table>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- App -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    let quotes=[];
    const $=id=>document.getElementById(id);

    /* ==== Load ==== */
    async function loadQuotes(uid){
      quotes=[];
      const snap=await getDocs(collection(db,"users",uid,"quotes"));
      snap.forEach(d=>quotes.push({...d.data(),id:d.id}));
      renderQuotes();
    }

    /* ==== Render ==== */
    window.renderQuotes=function(){
      const body=$("quotesBody"); body.innerHTML="";
      const status=$("statusFilter").value;
      const search=$("searchBox").value.toLowerCase();
      const from=$("fromDate").value; const to=$("toDate").value;
      const sortBy=$("sortBy").value;

      let filtered=quotes.filter(q=>{
        let ok=true;
        if(status!=="all") ok=ok&&q.status===status;
        if(from) ok=ok&&q.quoteDate>=from;
        if(to) ok=ok&&q.quoteDate<=to;
        if(search){
          ok=ok&&(
            (q.clientName||"").toLowerCase().includes(search)||
            (q.quoteNumber||"").toLowerCase().includes(search)||
            String(q.grandTotal||"").includes(search)
          );
        }
        return ok;
      });

      filtered.sort((a,b)=>{
        switch(sortBy){
          case "number_desc":return (b.quoteNumber||"").localeCompare(a.quoteNumber||"");
          case "number_asc": return (a.quoteNumber||"").localeCompare(b.quoteNumber||"");
          case "date_desc": return (b.quoteDate||"").localeCompare(a.quoteDate||"");
          case "date_asc":  return (a.quoteDate||"").localeCompare(b.quoteDate||"");
          case "amount_desc":return (b.grandTotal||0)-(a.grandTotal||0);
          case "amount_asc": return (a.grandTotal||0)-(b.grandTotal||0);
        }
        return 0;
      });

      filtered.forEach(q=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${q.quoteNumber||"—"}</td>
          <td>${q.clientName||"—"}</td>
          <td>${q.status||"Draft"}</td>
          <td>${q.quoteDate||"—"}</td>
          <td>€${(q.grandTotal||0).toFixed(2)}</td>
          <td>
            <button onclick="editQuote('${q.id}')">✏️ Edit</button>
            <button onclick="deleteQuote('${q.id}')">🗑 Delete</button>
            <button onclick="downloadQuotePDF('${q.id}',true)">📄 PDF</button>
            <button onclick="downloadQuotePDF('${q.id}',false)">PRO 📄 PDF</button>
          </td>
        `;
        body.appendChild(tr);
      });
    };

    /* ==== Edit ==== */
    window.editQuote=id=>{
      localStorage.setItem("editQuoteId",id);
      location.href="quote-offer.html";
    };

    /* ==== Delete ==== */
    window.deleteQuote=async(id)=>{
      if(!confirm("Delete this quote?"))return;
      const user=auth.currentUser;
      await deleteDoc(doc(db,"users",user.uid,"quotes",id));
      quotes=quotes.filter(q=>q.id!==id);
      renderQuotes();
    };

    /* ==== PDF ==== */
    window.downloadQuotePDF=(id,withBranding=true)=>{
      const q=quotes.find(x=>x.id===id); if(!q) return;
      const { jsPDF }=window.jspdf;
      const docPDF=new jsPDF();
      docPDF.setFontSize(18);
      docPDF.text("QUOTE / OFFER",105,15,{align:"center"});

      docPDF.autoTable({
        startY:30,
        head:[["Quote #","Date","Due","Status"]],
        body:[[q.quoteNumber,q.quoteDate,q.dueDate,q.status]],
        styles:{fontSize:11,halign:"center"},
        headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"}
      });

      const items=(q.items||[]).map(it=>[
        it.desc,it.qty,"€"+it.price.toFixed(2),it.vat+"%","€"+(it.qty*it.price*(1+it.vat/100)).toFixed(2)
      ]);

      docPDF.autoTable({
        startY:docPDF.lastAutoTable.finalY+10,
        head:[["Description","Qty","Unit Price","VAT","Total"]],
        body:items,
        styles:{fontSize:11,halign:"center"},
        headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"}
      });

      docPDF.text(`Subtotal: €${(q.subtotal||0).toFixed(2)}`,150,docPDF.lastAutoTable.finalY+10);
      docPDF.text(`VAT: €${(q.totalVat||0).toFixed(2)}`,150,docPDF.lastAutoTable.finalY+16);
      docPDF.text(`Total: €${(q.grandTotal||0).toFixed(2)}`,150,docPDF.lastAutoTable.finalY+22);

      if(withBranding){
        docPDF.setFontSize(10);
        docPDF.text("Generated with SmartWerk",105,290,{align:"center"});
      }

      docPDF.save(`${q.quoteNumber||"quote"}.pdf`);
    };

    /* ==== Init ==== */
    onAuthStateChanged(auth,(user)=>{
      if(!user) return location.href="login.html";
      flatpickr(".js-date",{dateFormat:"Y-m-d"});
      loadQuotes(user.uid);
    });
  </script>
</body>
</html>
