<!DOCTYPE html>
<html lang="en">
<head>  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartWerk — Quotes List</title>
  <link rel="stylesheet" href="style-invoices.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>📋 SmartWerk — Quotes</h1>
    <nav>
      <a href="dashboard.html" class="btn">← Dashboard</a>
      <a href="quote-offer.html" class="btn" onclick="localStorage.removeItem('editQuoteId')">➕ New Quote</a>
    </nav>
  </header>

  <main>
    <!-- Filters -->
    <section>
      <h2>🔎 Filters & Search</h2>
      <label>Status:
        <select id="statusFilter">
          <option value="all">All</option>
          <option value="Draft">Draft</option>
          <option value="Sent">Sent</option>
          <option value="Accepted">Accepted</option>
          <option value="Rejected">Rejected</option>
        </select>
      </label>
      <label>From: <input id="fromDate" class="js-date" placeholder="YYYY-MM-DD"></label>
      <label>To: <input id="toDate" class="js-date" placeholder="YYYY-MM-DD"></label>
      <label>Search: <input id="searchBox" placeholder="Client / Quote # / Amount"></label>
      <label>Sort by:
        <select id="sortBy">
          <option value="date_desc">Date ↓</option>
          <option value="date_asc">Date ↑</option>
          <option value="quoteNumber_desc">Quote # ↓</option>
          <option value="quoteNumber_asc">Quote # ↑</option>
          <option value="amount_desc">Amount ↓</option>
          <option value="amount_asc">Amount ↑</option>
        </select>
      </label>
    </section>

    <!-- Table -->
    <section>
      <table>
        <thead>
          <tr>
            <th>Quote #</th>
            <th>Client</th>
            <th>Status</th>
            <th>Date</th>
            <th>Total</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="quotesBody"></tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- App -->
 <script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged }   from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, doc, addDoc, deleteDoc, setDoc,
  onSnapshot, query, orderBy, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* Helpers */
    const $ = id => document.getElementById(id);
    const fmt = v => "€" + (parseFloat(v||0)).toFixed(2);

    let quotes = [];

    /* Real-time load */
    function startRealtime(uid){
      const colRef = collection(db,"users",uid,"quotes");
      const q = query(colRef, orderBy("quoteDate","desc"));
      onSnapshot(q,(snap)=>{
        quotes = snap.docs.map(d=>({id:d.id, ...d.data()}));
        render();
      });
    }

    /* Render */
    function render(){
      const body = $("quotesBody");
      body.innerHTML = "";

      const from = $("fromDate").value;
      const to   = $("toDate").value;
      const status = $("statusFilter").value;
      const search = $("searchBox").value.toLowerCase();
      const sortBy = $("sortBy").value;

      let list = quotes.filter(q=>{
        let ok = true;
        if(status!=="all") ok = ok && q.status === status;
        if(from) ok = ok && (q.quoteDate||"") >= from;
        if(to)   ok = ok && (q.quoteDate||"") <= to;
        if(search){
          ok = ok && (
            (q.clientName||"").toLowerCase().includes(search) ||
            (q.quoteNumber||"").toLowerCase().includes(search) ||
            String(q.grandTotal||"").toLowerCase().includes(search)
          );
        }
        return ok;
      });

      list.sort((a,b)=>{
        switch (sortBy){
          case "quoteNumber_desc": return (b.quoteNumber||"").localeCompare(a.quoteNumber||"");
          case "quoteNumber_asc":  return (a.quoteNumber||"").localeCompare(b.quoteNumber||"");
          case "date_desc":        return (b.quoteDate||"").localeCompare(a.quoteDate||"");
          case "date_asc":         return (a.quoteDate||"").localeCompare(b.quoteDate||"");
          case "amount_desc":      return (parseFloat(b.grandTotal)||0) - (parseFloat(a.grandTotal)||0);
          case "amount_asc":       return (parseFloat(a.grandTotal)||0) - (parseFloat(b.grandTotal)||0);
          default: return 0;
        }
      });

      list.forEach(q=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${q.quoteNumber||"—"}</td>
          <td>${q.clientName||"—"}</td>
          <td>
         <select onchange="updateQuoteStatus('${q.id}', this.value)">
         <option value="Draft" ${q.status==="Draft"?"selected":""}>Draft</option>
         <option value="Sent" ${q.status==="Sent"?"selected":""}>Sent</option>
         <option value="Accepted" ${q.status==="Accepted"?"selected":""}>Accepted</option>
         <option value="Rejected" ${q.status==="Rejected"?"selected":""}>Rejected</option>
        </select>
         </td>
          <td>${q.quoteDate||"—"}</td>
          <td>${fmt(q.grandTotal)}</td>
          <td>
            <button onclick="editQuote('${q.id}')">✏️ Edit</button>
            <button onclick="deleteQuote('${q.id}')">🗑 Delete</button>
            <button onclick="downloadPDF('${q.id}', true)">📄 PDF</button>
            <button onclick="downloadPDF('${q.id}', false)">PRO 📄</button>
            <button onclick="convertToInvoice('${q.id}')">🔄 Convert to Invoice</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    /* Actions */
    function editQuote(id){
      localStorage.setItem("editQuoteId", id);
      location.href = "quote-offer.html";
    }
    window.editQuote = editQuote;

    window.deleteQuote = async (id)=>{
      if(!confirm("Delete this quote?")) return;
      await deleteDoc(doc(db,"users",auth.currentUser.uid,"quotes",id));
    };

    // Full PDF (branding / PRO)
    window.downloadPDF = (id, withBranding=true)=>{
      const q = quotes.find(x=>x.id===id);
      if(!q) return;
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      pdf.setFontSize(18);
      pdf.text("QUOTE / OFFER", 105, 15, {align:"center"});

      // Business + Client
      pdf.setFontSize(12);
      pdf.text("From:", 14, 28);
      pdf.text([
        q.businessName||"",
        `KvK: ${q.kvk||""}`,
        `IBAN: ${q.iban||""}`,
        `BTW: ${q.btw||""}`,
        `Email: ${q.email||""}`,
        `Address: ${q.businessAddress||""}`,
        `Phone: ${q.businessPhone||""}`
      ], 14, 34);

      pdf.text("To:", 120, 28);
      pdf.text([
        q.clientName||"",
        q.clientEmail||"",
        `Address: ${q.clientAddress||""}`,
        `Phone: ${q.clientPhone||""}`
      ], 120, 34);

      // Info
      pdf.autoTable({
        startY: 70,
        head: [["Quote #","Date","Status","Total"]],
        body: [[q.quoteNumber||"—", q.quoteDate||"—", q.status||"Draft", fmt(q.grandTotal)]],
        theme:"grid",
        styles:{ fontSize:11, cellPadding:4, halign:"center" },
        headStyles:{ fillColor:[37,99,235], textColor:255 }
      });

      // Items
      const items = (q.items||[]).map(it=>[
        it.desc||"",
        it.qty||0,
        fmt(it.price||0),
        `${it.vat||0}%`,
        fmt((it.qty||0)*(it.price||0)*(1+(it.vat||0)/100))
      ]);
      pdf.autoTable({
        startY: pdf.lastAutoTable.finalY + 8,
        head:[["Description","Qty","Unit Price","VAT","Total"]],
        body: items,
        theme:"grid",
        styles:{ fontSize:11, cellPadding:4, halign:"center" },
        headStyles:{ fillColor:[37,99,235], textColor:255 }
      });

      // Totals
      const y = pdf.lastAutoTable.finalY + 8;
      pdf.text(`Subtotal: ${fmt(q.subtotal)}`, 150, y);
      pdf.text(`VAT: ${fmt(q.totalVat)}`,     150, y+6);
      pdf.text(`Total Due: ${fmt(q.grandTotal)}`, 150, y+12);

      if(q.note){
        pdf.text("Note:", 14, y);
        pdf.text(String(q.note), 14, y+6, {maxWidth:120});
      }

      // Signatures
// Signatures (if saved as dataURL)
let y2 = y + 28;

// Business signature
if(q.signatures?.business){
  pdf.setDrawColor(0);
  pdf.line(14, y2+22, 74, y2+22);
  pdf.addImage(q.signatures.business, "PNG", 14, y2, 60, 20);
  pdf.text("Business Signature", 14, y2+30);
  if(q.signatures.businessDate) pdf.text(`Signed: ${q.signatures.businessDate}`,14,y2+37);
}

// Client signature
if(q.signatures?.client){
  pdf.setDrawColor(0);
  pdf.line(120, y2+22, 180, y2+22);
  pdf.addImage(q.signatures.client, "PNG", 120, y2, 60, 20);
  pdf.text("Client Signature", 120, y2+30);
  if(q.signatures.clientDate) pdf.text(`Signed: ${q.signatures.clientDate}`,120,y2+37);
}
      if(withBranding){
  pdf.setFontSize(10);
  pdf.text("Generated with SmartWerk", 105, 290, {align:"center"});
}

pdf.save(`${q.quoteNumber||"Quote"}.pdf`);
};   // ← закриття window.downloadPDF

    // Reserve invoice #
    async function reserveInvoiceNumber(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastInvoiceNumber||0) : 0;
        const next = last+1;
        tx.set(ref,{ lastInvoiceNumber: next },{ merge:true });
        out=`INV-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

    // Convert to Invoice
    window.convertToInvoice = async (id)=>{
      try{
        const uid = auth.currentUser.uid;
        const q = quotes.find(x=>x.id===id);
        if(!q) return;

        const invNumber = await reserveInvoiceNumber(uid);
        const now = new Date();
        const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,"0"), d = String(now.getDate()).padStart(2,"0");
        const invoiceDate = `${y}-${m}-${d}`;
        const dueDateObj = new Date(now); dueDateObj.setDate(dueDateObj.getDate()+14);
        const due = `${dueDateObj.getFullYear()}-${String(dueDateObj.getMonth()+1).padStart(2,"0")}-${String(dueDateObj.getDate()).padStart(2,"0")}`;

        const data = {
          businessName:q.businessName||"", kvk:q.kvk||"", iban:q.iban||"", btw:q.btw||"",
          email:q.email||"", businessAddress:q.businessAddress||"", businessPhone:q.businessPhone||"",
          clientName:q.clientName||"", clientEmail:q.clientEmail||"", clientPhone:q.clientPhone||"", clientAddress:q.clientAddress||"",
          invoiceDate, dueDate: due, invoiceNumber: invNumber, status:"Draft",
          items:q.items||[], subtotal:parseFloat(q.subtotal||0), totalVat:parseFloat(q.totalVat||0), grandTotal:parseFloat(q.grandTotal||0),
          subtotalFormatted: fmt(q.subtotal), totalVatFormatted: fmt(q.totalVat), grandTotalFormatted: fmt(q.grandTotal),
          signatures:q.signatures||{},
          convertedFrom: q.quoteNumber||"",
          userId: uid,
          updatedAt: new Date().toISOString()
        };

        const ref = await addDoc(collection(db,"users",uid,"invoices"), data);
        localStorage.setItem("editInvoiceId", ref.id);
        alert("✅ Converted to Invoice!");
        location.href="invoices.html";
      }catch(e){
        console.error(e);
        alert("❌ Convert failed: "+e.message);
      }
    };

     window.updateQuoteStatus = async (id, newStatus) => {
  const user = auth.currentUser;
  if (!user) { alert("Please sign in again."); return; }

  const uid = user.uid;
  const ref = doc(db, "users", uid, "quotes", id);

  // знайдемо саме той select, що викликав зміну
  let sel = document.querySelector(`select[onchange*="'${id}'"]`);

  try {
    if (sel) sel.disabled = true;

    await setDoc(ref, {
      status: newStatus,
      updatedAt: new Date().toISOString()
    }, { merge: true });

    // onSnapshot сам перерендерить таблицю
    console.log(`✅ Status updated to ${newStatus}`);
  } catch (e) {
    console.error("❌ Status update failed", e);
    alert("Status update failed: " + e.message);
  } finally {
    if (sel) sel.disabled = false;
  }
};

    /* INIT */
   onAuthStateChanged(auth, (user)=>{
    if (!user) { location.href = "login.html"; return; }

    // Тільки дата-фільтри + список
    flatpickr(".js-date", { dateFormat: "Y-m-d" });

    // Підтягнути список в реальному часі
    startRealtime(user.uid);

    // Живі фільтри/пошук/сортування
    ["statusFilter","fromDate","toDate","searchBox","sortBy"]
      .forEach(id => document.getElementById(id)?.addEventListener("input", render));

    // Кнопка "New Quote" має СТВОРЮВАТИ новий документ, а не редагувати старий
    document.querySelector('a[href="quote-offer.html"]')
      ?.addEventListener("click", () => {
        localStorage.removeItem("editQuoteId");
      });
  });


  </script>
</body>
</html>
