<!DOCTYPE html>
<html lang="en">
<head>  
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartWerk ‚Äî Quotes List</title>
  <link rel="stylesheet" href="style-quote-offer.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header>
    <h1>üìã Quotes Overview</h1>
    <nav>
      <a href="dashboard.html" class="btn">‚Üê Dashboard</a>
      <a href="quote-offer.html" class="btn">‚ûï New Quote</a>
    </nav>
  </header>

  <main>
    <!-- Filters -->
    <section class="filters">
      <input id="searchBox" placeholder="üîç Search by client, number, amount">
      <select id="statusFilter">
        <option value="all">All statuses</option>
        <option value="Draft">Draft</option>
        <option value="Sent">Sent</option>
        <option value="Accepted">Accepted</option>
        <option value="Rejected">Rejected</option>
      </select>
      <input id="fromDate" class="js-date" placeholder="From (YYYY-MM-DD)">
      <input id="toDate" class="js-date" placeholder="To (YYYY-MM-DD)">
      <select id="sortBy">
        <option value="date_desc">Newest</option>
        <option value="date_asc">Oldest</option>
        <option value="number_desc">Quote # ‚Üì</option>
        <option value="number_asc">Quote # ‚Üë</option>
        <option value="amount_desc">Amount ‚Üì</option>
        <option value="amount_asc">Amount ‚Üë</option>
      </select>
      <button onclick="renderQuotes()">Apply</button>
    </section>

    <!-- Table -->
    <table>
      <thead>
        <tr>
          <th>Quote #</th>
          <th>Client</th>
          <th>Status</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="quotesBody"></tbody>
    </table>
  </main>

  <footer>
    <p>¬© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- App -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { setDoc, doc, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    let quotes=[];
    const $=id=>document.getElementById(id);

    /* ==== Load ==== */
    async function loadQuotes(uid){
      quotes=[];
      const snap=await getDocs(collection(db,"users",uid,"quotes"));
      snap.forEach(d=>quotes.push({...d.data(),id:d.id}));
      renderQuotes();
    }

    /* ==== Render ==== */
    window.renderQuotes=function(){
      const body=$("quotesBody"); body.innerHTML="";
      const status=$("statusFilter").value;
      const search=$("searchBox").value.toLowerCase();
      const from=$("fromDate").value; const to=$("toDate").value;
      const sortBy=$("sortBy").value;

      let filtered=quotes.filter(q=>{
        let ok=true;
        if(status!=="all") ok=ok&&q.status===status;
        if(from) ok=ok&&q.quoteDate>=from;
        if(to) ok=ok&&q.quoteDate<=to;
        if(search){
          ok=ok&&(
            (q.clientName||"").toLowerCase().includes(search)||
            (q.quoteNumber||"").toLowerCase().includes(search)||
            String(q.grandTotal||"").includes(search)
          );
        }
        return ok;
      });

      filtered.sort((a,b)=>{
        switch(sortBy){
          case "number_desc":return (b.quoteNumber||"").localeCompare(a.quoteNumber||"");
          case "number_asc": return (a.quoteNumber||"").localeCompare(b.quoteNumber||"");
          case "date_desc": return (b.quoteDate||"").localeCompare(a.quoteDate||"");
          case "date_asc":  return (a.quoteDate||"").localeCompare(b.quoteDate||"");
          case "amount_desc":return (b.grandTotal||0)-(a.grandTotal||0);
          case "amount_asc": return (a.grandTotal||0)-(b.grandTotal||0);
        }
        return 0;
      });

      filtered.forEach(q=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${q.quoteNumber||"‚Äî"}</td>
          <td>${q.clientName||"‚Äî"}</td>
          <td>${q.status||"Draft"}</td>
          <td>${q.quoteDate||"‚Äî"}</td>
          <td>‚Ç¨${(q.grandTotal||0).toFixed(2)}</td>
          <td>
            <button onclick="editQuote('${q.id}')">‚úèÔ∏è Edit</button>
            <button onclick="deleteQuote('${q.id}')">üóë Delete</button>
            <button onclick="downloadQuotePDF('${q.id}',true)">üìÑ PDF</button>
            <button onclick="downloadQuotePDF('${q.id}',false)">PRO üìÑ PDF</button>
            <button onclick="convertToInvoice('${q.id}')">‚ûî Convert to Invoice</button>
          </td>
        `;
        body.appendChild(tr);
      });
    };

    /* ==== Edit ==== */
    window.editQuote=id=>{
      localStorage.setItem("editQuoteId",id);
      location.href="quote-offer.html";
    };

    /* ==== Delete ==== */
    window.deleteQuote=async(id)=>{
      if(!confirm("Delete this quote?"))return;
      const user=auth.currentUser;
      await deleteDoc(doc(db,"users",user.uid,"quotes",id));
      quotes=quotes.filter(q=>q.id!==id);
      renderQuotes();
    };

    /* ==== PDF ==== */
    window.downloadQuotePDF=(id,withBranding=true)=>{
      const q=quotes.find(x=>x.id===id); if(!q) return;
      const { jsPDF }=window.jspdf;
      const docPDF=new jsPDF();
      docPDF.setFontSize(18);
      docPDF.text("QUOTE / OFFER",105,15,{align:"center"});

      docPDF.autoTable({
        startY:30,
        head:[["Quote #","Date","Due","Status"]],
        body:[[q.quoteNumber,q.quoteDate,q.dueDate,q.status]],
        styles:{fontSize:11,halign:"center"},
        headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"}
      });

      const items=(q.items||[]).map(it=>[
        it.desc,it.qty,"‚Ç¨"+it.price.toFixed(2),it.vat+"%","‚Ç¨"+(it.qty*it.price*(1+it.vat/100)).toFixed(2)
      ]);

      docPDF.autoTable({
        startY:docPDF.lastAutoTable.finalY+10,
        head:[["Description","Qty","Unit Price","VAT","Total"]],
        body:items,
        styles:{fontSize:11,halign:"center"},
        headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"}
      });

      docPDF.text(`Subtotal: ‚Ç¨${(q.subtotal||0).toFixed(2)}`,150,docPDF.lastAutoTable.finalY+10);
      docPDF.text(`VAT: ‚Ç¨${(q.totalVat||0).toFixed(2)}`,150,docPDF.lastAutoTable.finalY+16);
      docPDF.text(`Total: ‚Ç¨${(q.grandTotal||0).toFixed(2)}`,150,docPDF.lastAutoTable.finalY+22);

      if(withBranding){
        docPDF.setFontSize(10);
        docPDF.text("Generated with SmartWerk",105,290,{align:"center"});
      }

      docPDF.save(`${q.quoteNumber||"quote"}.pdf`);
    };

    /* ==== Init ==== */
    onAuthStateChanged(auth,(user)=>{
      if(!user) return location.href="login.html";
      flatpickr(".js-date",{dateFormat:"Y-m-d"});
      loadQuotes(user.uid);
    });

    import { setDoc, doc, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

window.convertToInvoice = async function(id){
  const user = auth.currentUser;
  if(!user) return location.href="login.html";

  const quote = quotes.find(q=>q.id===id);
  if(!quote) return;

  // —Ñ–æ—Ä–º—É—î–º–æ —ñ–Ω–≤–æ–π—Å –∑ –¥–∞–Ω–∏—Ö –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó
  const invoiceData = {
    businessName: quote.businessName,
    kvk: quote.kvk,
    iban: quote.iban,
    btw: quote.btw,
    email: quote.email,
    businessAddress: quote.businessAddress,
    businessPhone: quote.businessPhone,

    clientName: quote.clientName,
    clientEmail: quote.clientEmail,
    clientPhone: quote.clientPhone,
    clientAddress: quote.clientAddress,

    invoiceDate: new Date().toISOString().split("T")[0],
    dueDate: "",
    invoiceNumber: "", // –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –≤ invoices.html
    status: "Draft",
    note: quote.note || "",

    items: quote.items || [],
    subtotal: quote.subtotal || 0,
    totalVat: quote.totalVat || 0,
    grandTotal: quote.grandTotal || 0,

    fromQuote: quote.quoteNumber, // –∑–≤‚Äô—è–∑–æ–∫ –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é
    userId: user.uid,
    createdAt: new Date().toISOString(),
  };

  // —Å—Ç–≤–æ—Ä—é—î–º–æ —ñ–Ω–≤–æ–π—Å —É Firestore
  const ref = await addDoc(collection(db,"users",user.uid,"invoices"), invoiceData);

  // –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó
  await setDoc(doc(db,"users",user.uid,"quotes",id), { status: "Converted" }, { merge:true });

  // –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ invoices.html –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  localStorage.setItem("editInvoiceId", ref.id);
  location.href="invoices.html";
};
  </script>
</body>
</html>
