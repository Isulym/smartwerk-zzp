<!DOCTYPE html>
<html lang="en">
<head>  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartWerk â€” Quotes List</title>
  <link rel="stylesheet" href="style-invoice-list.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
</head>
<body>
  <header>
    <h1>ğŸ“‹ SmartWerk â€” Quotes</h1>
    <nav>
      <a href="dashboard.html" class="btn">â† Dashboard</a>
      <a href="quote-offer.html" class="btn" onclick="localStorage.removeItem('editQuoteId')">â• New Quote</a>
    </nav>
  </header>

  <main>
    <!-- Filters -->
    <section>
     <section class="filters">
  <h3>ğŸ” Filters & Search</h3>
      
  <label>From:
    <input id="fromDate" name="fromDate" class="js-date" placeholder="YYYY-MM-DD">
  </label>

  <label>To:
    <input id="toDate" name="toDate" class="js-date" placeholder="YYYY-MM-DD">
  </label>

  <label>Status:
    <select id="statusFilter" name="statusFilter">
      <option value="all">All</option>
      <option value="Draft">Draft</option>
      <option value="Sent">Sent</option>
      <option value="Accepted">Accepted</option>
      <option value="Rejected">Rejected</option>
    </select>
  </label>

  <label>Search:
    <input id="searchBox" name="searchQuery" placeholder="Client / Quote # / Amount">
  </label>

  <label>Sort by:
    <select id="sortBy" name="sortBy">
      <option value="date_desc">Date â†“</option>
      <option value="date_asc">Date â†‘</option>
      <option value="quoteNumber_desc">Quote # â†“</option>
      <option value="quoteNumber_asc">Quote # â†‘</option>
      <option value="amount_desc">Amount â†“</option>
      <option value="amount_asc">Amount â†‘</option>
    </select>
  </label>

  <button type="button" onclick="resetFilters()">â™»ï¸ Reset</button>
</section>
    <!-- Table -->
    <section>
      <table>
        <thead>
          <tr>
            <th>Quote #</th>
            <th>Client</th>
            <th>Status</th>
            <th>Date</th>
            <th>Total</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="quotesBody"></tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>Â© 2025 SmartWerk</p>
  </footer>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- App -->
 <script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged }   from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, doc, addDoc, deleteDoc, setDoc,
  onSnapshot, query, orderBy, runTransaction, setLogLevel
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
   setLogLevel("error");


    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyAp397Ax_jaMI85vOXicOi61g64HvvA_Kg",
      authDomain: "smartwerk8520.firebaseapp.com",
      projectId: "smartwerk8520",
      appId: "1:607670981972:web:c07103c981c86860d724c1",
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* Helpers */
    const $ = id => document.getElementById(id);
    const fmt = v => "â‚¬" + (parseFloat(v||0)).toFixed(2);

    let quotes = [];

    /* Real-time load */
    function startRealtime(uid){
      const colRef = collection(db,"users",uid,"quotes");
      const q = query(colRef, orderBy("quoteDate","desc"));
      onSnapshot(q,(snap)=>{
        quotes = snap.docs.map(d=>({id:d.id, ...d.data()}));
        render();
      });
    }

    /* Render */
    function render(){
      const body = $("quotesBody");
      body.innerHTML = "";

      const from = $("fromDate").value;
      const to   = $("toDate").value;
      const status = $("statusFilter").value;
      const search = $("searchBox").value.toLowerCase();
      const sortBy = $("sortBy").value;

      let list = quotes.filter(q=>{
        let ok = true;
        if(status!=="all") ok = ok && q.status === status;
        if(from) ok = ok && (q.quoteDate||"") >= from;
        if(to)   ok = ok && (q.quoteDate||"") <= to;
        if(search){
          ok = ok && (
            (q.clientName||"").toLowerCase().includes(search) ||
            (q.quoteNumber||"").toLowerCase().includes(search) ||
            String(q.grandTotal||"").toLowerCase().includes(search)
          );
        }
        return ok;
      });

      list.sort((a,b)=>{
        switch (sortBy){
          case "quoteNumber_desc": return (b.quoteNumber||"").localeCompare(a.quoteNumber||"");
          case "quoteNumber_asc":  return (a.quoteNumber||"").localeCompare(b.quoteNumber||"");
          case "date_desc":        return (b.quoteDate||"").localeCompare(a.quoteDate||"");
          case "date_asc":         return (a.quoteDate||"").localeCompare(b.quoteDate||"");
          case "amount_desc":      return (parseFloat(b.grandTotal)||0) - (parseFloat(a.grandTotal)||0);
          case "amount_asc":       return (parseFloat(a.grandTotal)||0) - (parseFloat(b.grandTotal)||0);
          default: return 0;
        }
      });

      list.forEach(q=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${q.quoteNumber||"â€”"}</td>
          <td>${q.clientName||"â€”"}</td>
         <td>
          <select id="status-${q.id}" name="status-${q.id}" onchange="updateQuoteStatus('${q.id}', this.value)">
         <option value="Draft" ${q.status==="Draft"?"selected":""}>Draft</option>
         <option value="Sent" ${q.status==="Sent"?"selected":""}>Sent</option>
         <option value="Accepted" ${q.status==="Accepted"?"selected":""}>Accepted</option>
         <option value="Rejected" ${q.status==="Rejected"?"selected":""}>Rejected</option>
        </select>
         </td>
          <td>${q.quoteDate||"â€”"}</td>
          <td>${fmt(q.grandTotal)}</td>
          <td>
            <button onclick="editQuote('${q.id}')">âœï¸ Edit</button>
            <button onclick="deleteQuote('${q.id}')">ğŸ—‘ Delete</button>
            <button onclick="downloadPDF('${q.id}', true)">ğŸ“„ PDF</button>
            <button onclick="downloadPDF('${q.id}', false)">PRO ğŸ“„ PDF without branding</button>
            <button onclick="convertToInvoice('${q.id}')">ğŸ”„ Convert to Invoice</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    /* Actions */
    function editQuote(id){
      localStorage.setItem("editQuoteId", id);
      location.href = "quote-offer.html";
    }
    window.editQuote = editQuote;

    window.deleteQuote = async (id)=>{
      if(!confirm("Delete this quote?")) return;
      await deleteDoc(doc(db,"users",auth.currentUser.uid,"quotes",id));
    };

    // Full PDF (branding / PRO)
    window.downloadPDF = (id, withBranding=true)=>{
      const q = quotes.find(x=>x.id===id);
      if(!q) return;
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      pdf.setFontSize(18);
      pdf.text("QUOTE / OFFER", 105, 15, {align:"center"});

      // Business + Client
      pdf.setFontSize(12);
      pdf.text("From:", 14, 28);
      pdf.text([
        q.businessName||"",
        `KvK: ${q.kvk||""}`,
        `IBAN: ${q.iban||""}`,
        `BTW: ${q.btw||""}`,
        `Email: ${q.email||""}`,
        `Address: ${q.businessAddress||""}`,
        `Phone: ${q.businessPhone||""}`
      ], 14, 34);

      pdf.text("To:", 120, 28);
      pdf.text([
        q.clientName||"",
        q.clientEmail||"",
        `Address: ${q.clientAddress||""}`,
        `Phone: ${q.clientPhone||""}`
      ], 120, 34);

      // Info
      pdf.autoTable({
        startY: 70,
        head: [["Quote #","Date","Status","Total"]],
        body: [[q.quoteNumber||"â€”", q.quoteDate||"â€”", q.status||"Draft", fmt(q.grandTotal)]],
        theme:"grid",
        styles:{ fontSize:11, cellPadding:4, halign:"center" },
        headStyles:{ fillColor:[37,99,235], textColor:255 }
      });

      // Items
      const items = (q.items||[]).map(it=>[
        it.desc||"",
        it.qty||0,
        fmt(it.price||0),
        `${it.vat||0}%`,
        fmt((it.qty||0)*(it.price||0)*(1+(it.vat||0)/100))
      ]);
      pdf.autoTable({
        startY: pdf.lastAutoTable.finalY + 8,
        head:[["Description","Qty","Unit Price","VAT","Total"]],
        body: items,
        theme:"grid",
        styles:{ fontSize:11, cellPadding:4, halign:"center" },
        headStyles:{ fillColor:[37,99,235], textColor:255 }
      });

      // Totals
      const y = pdf.lastAutoTable.finalY + 8;
      pdf.text(`Subtotal: ${fmt(q.subtotal)}`, 150, y);
      pdf.text(`VAT: ${fmt(q.totalVat)}`,     150, y+6);
      pdf.text(`Total Due: ${fmt(q.grandTotal)}`, 150, y+12);

      if(q.note){
        pdf.text("Note:", 14, y);
        pdf.text(String(q.note), 14, y+6, {maxWidth:120});
      }

      // Signatures
// Signatures (if saved as dataURL)
let y2 = y + 28;

// Business signature
if(q.signatures?.business){
  pdf.setDrawColor(0);
  pdf.line(14, y2+22, 74, y2+22);
  pdf.addImage(q.signatures.business, "PNG", 14, y2, 60, 20);
  pdf.text("Business Signature", 14, y2+30);
  if(q.signatures.businessDate) pdf.text(`Signed: ${q.signatures.businessDate}`,14,y2+37);
}

// Client signature
if(q.signatures?.client){
  pdf.setDrawColor(0);
  pdf.line(120, y2+22, 180, y2+22);
  pdf.addImage(q.signatures.client, "PNG", 120, y2, 60, 20);
  pdf.text("Client Signature", 120, y2+30);
  if(q.signatures.clientDate) pdf.text(`Signed: ${q.signatures.clientDate}`,120,y2+37);
}
      if(withBranding){
  pdf.setFontSize(10);
  pdf.text("Generated with SmartWerk", 105, 290, {align:"center"});
}

pdf.save(`${q.quoteNumber||"Quote"}.pdf`);
};   // â† Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ window.downloadPDF

    // Reserve invoice #
    async function reserveInvoiceNumber(uid){
      const ref = doc(db,"users",uid);
      const year = new Date().getFullYear();
      let out="";
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        const last = snap.exists()? (snap.data().lastInvoiceNumber||0) : 0;
        const next = last+1;
        tx.set(ref,{ lastInvoiceNumber: next },{ merge:true });
        out=`INV-${year}-${String(next).padStart(3,"0")}`;
      });
      return out;
    }

window.resetFilters = () => {
  $("statusFilter").value = "all";
  $("fromDate").value = "";
  $("toDate").value = "";
  $("searchBox").value = "";
  $("sortBy").value = "date_desc";
  render();
};
   
    // Convert to Invoice
    window.convertToInvoice = async (id)=>{
      try{
        const uid = auth.currentUser.uid;
        const q = quotes.find(x=>x.id===id);
        if(!q) return;

        const invNumber = await reserveInvoiceNumber(uid);
        const now = new Date();
        const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,"0"), d = String(now.getDate()).padStart(2,"0");
        const invoiceDate = `${y}-${m}-${d}`;
        const dueDateObj = new Date(now); dueDateObj.setDate(dueDateObj.getDate()+14);
        const due = `${dueDateObj.getFullYear()}-${String(dueDateObj.getMonth()+1).padStart(2,"0")}-${String(dueDateObj.getDate()).padStart(2,"0")}`;

        const data = {
          businessName:q.businessName||"", kvk:q.kvk||"", iban:q.iban||"", btw:q.btw||"",
          email:q.email||"", businessAddress:q.businessAddress||"", businessPhone:q.businessPhone||"",
          clientName:q.clientName||"", clientEmail:q.clientEmail||"", clientPhone:q.clientPhone||"", clientAddress:q.clientAddress||"",
          invoiceDate, dueDate: due, invoiceNumber: invNumber, status:"Draft",
          items:q.items||[], subtotal:parseFloat(q.subtotal||0), totalVat:parseFloat(q.totalVat||0), grandTotal:parseFloat(q.grandTotal||0),
          subtotalFormatted: fmt(q.subtotal), totalVatFormatted: fmt(q.totalVat), grandTotalFormatted: fmt(q.grandTotal),
          signatures:q.signatures||{},
          convertedFrom: q.quoteNumber||"",
          userId: uid,
          updatedAt: new Date().toISOString()
        };

        const ref = await addDoc(collection(db,"users",uid,"invoices"), data);
        localStorage.setItem("editInvoiceId", ref.id);
        alert("âœ… Converted to Invoice!");
        location.href="invoices.html";
      }catch(e){
        console.error(e);
        alert("âŒ Convert failed: "+e.message);
      }
    };

     window.updateQuoteStatus = async (id, newStatus) => {
  const user = auth.currentUser;
  if (!user) { alert("Please sign in again."); return; }

  const uid = user.uid;
  const ref = doc(db, "users", uid, "quotes", id);

  // Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ¼Ğ¾ ÑĞ°Ğ¼Ğµ Ñ‚Ğ¾Ğ¹ select, Ñ‰Ğ¾ Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ğ² Ğ·Ğ¼Ñ–Ğ½Ñƒ
  let sel = document.querySelector(`select[onchange*="'${id}'"]`);

  try {
    if (sel) sel.disabled = true;

    await setDoc(ref, {
      status: newStatus,
      updatedAt: new Date().toISOString()
    }, { merge: true });

    // onSnapshot ÑĞ°Ğ¼ Ğ¿ĞµÑ€ĞµÑ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ
    console.log(`âœ… Status updated to ${newStatus}`);
  } catch (e) {
    console.error("âŒ Status update failed", e);
    alert("Status update failed: " + e.message);
  } finally {
    if (sel) sel.disabled = false;
  }
};

    /* INIT */
   onAuthStateChanged(auth, (user)=>{
    if (!user) { location.href = "login.html"; return; }

    // Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ Ğ´Ğ°Ñ‚Ğ°-Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ¸ + ÑĞ¿Ğ¸ÑĞ¾Ğº
    flatpickr(".js-date", { dateFormat: "Y-m-d" });

    // ĞŸÑ–Ğ´Ñ‚ÑĞ³Ğ½ÑƒÑ‚Ğ¸ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ Ñ‡Ğ°ÑÑ–
    startRealtime(user.uid);

    // Ğ–Ğ¸Ğ²Ñ– Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ¸/Ğ¿Ğ¾ÑˆÑƒĞº/ÑĞ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
    ["statusFilter","fromDate","toDate","searchBox","sortBy"]
      .forEach(id => document.getElementById(id)?.addEventListener("input", render));

    // ĞšĞ½Ğ¾Ğ¿ĞºĞ° "New Quote" Ğ¼Ğ°Ñ” Ğ¡Ğ¢Ğ’ĞĞ Ğ®Ğ’ĞĞ¢Ğ˜ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚, Ğ° Ğ½Ğµ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹
    document.querySelector('a[href="quote-offer.html"]')
      ?.addEventListener("click", () => {
        localStorage.removeItem("editQuoteId");
      });
  });


  </script>
</body>
</html>
